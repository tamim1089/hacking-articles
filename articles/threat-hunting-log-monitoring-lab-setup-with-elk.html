<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/pentest-lab-setup/" rel="category tag">Pentest Lab Setup</a>, <a href="https://www.hackingarticles.in/category/threat-hunting/" rel="category tag">Threat Hunting</a></span>            </div>
            <h1 class="post-title entry-title">Threat Hunting: Log Monitoring Lab Setup with ELK</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/threat-hunting-log-monitoring-lab-setup-with-elk/" rel="bookmark"><time class="entry-date published" datetime="2020-08-13T18:35:42+00:00">August 13, 2020</time><time class="updated" datetime="2025-05-13T09:00:08+00:00">May 13, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><strong><span style="color: #000000;">Elastic Stack is formerly known as the ELK Stack.</span></strong></p>
<p><span style="color: #000000;">Elk Stack is a collection of free opensource software from Elastic Company which is specially designed for centralized logging. It allows the searching, analyzing, and visualization of logs from different sources.  in this guide, we will learn to install Elastic Stack on ubuntu.</span></p>
<p><span style="color: #000000;">To configure ELK Stack in your Ubuntu platform, there are some prerequisites required for installation.</span></p>
<ul>
<li><span style="color: #000000;">Ubuntu 20.04</span></li>
<li><span style="color: #000000;">Root Privileges</span></li>
</ul>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><strong><span style="color: #000000;">ELK Stack components</span></strong></li>
<li><strong><span style="color: #000000;">Install Java and All Dependencies</span></strong></li>
<li><strong><span style="color: #000000;">Install and configure Elasticsearch</span></strong></li>
<li><strong><span style="color: #000000;">Install and configure Logstash</span></strong></li>
<li><strong><span style="color: #000000;">Install and configure Kibana</span></strong></li>
<li><strong><span style="color: #000000;">Install and configure NGINX</span></strong></li>
<li><strong><span style="color: #000000;">Install and configure Filebeat</span></strong></li>
<li><strong><span style="color: #000000;">Routing Linux Logs to Elasticsearch</span></strong></li>
<li><strong><span style="color: #000000;">Create a Log Dashboard in Kibana</span></strong></li>
<li><strong><span style="color: #000000;">Monitoring SSH entries</span></strong></li>
</ul>
<h3><span style="color: #800000;">ELK Stack components</span></h3>
<ol>
<li><span style="color: #000000;"><strong>Elasticsearch: </strong>It is a restful search engine that stores or holds all of the collected Data.</span></li>
<li><span style="color: #000000;"><strong>Logstash: </strong>It is the Data processing component that sends incoming Data to Elasticsearch.</span></li>
<li><span style="color: #000000;"><strong>Kibana: </strong>A web interface for searching and visualizing logs.</span></li>
<li><span style="color: #000000;"><strong>Filebeat: </strong>A lightweight Single-purpose Data forwarder that can send data from thousands of machines to either Logstash or Elasticsearch.</span></li>
</ol>
<p><span style="color: #000000;"><strong> <img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-M2hb2HE6zJQ/XzV5zFw38LI/AAAAAAAAnFo/jn-z0KOBDg8XtSZ8nizhaKpPuReNUo5sACLcBGAsYHQ/s1600/0.1.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="1050" height="600"/></strong></span></p>
<h3><span style="color: #800000;">Install Java and All Dependencies</span></h3>
<p><span style="color: #000000;">Elasticsearch requires OpenJDK available in our machine. Install Java using the below command along with the HTTPS support and wget packages for APT.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">apt install -y openjdk-11-jdk wget apt-transport-https curl</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://1.bp.blogspot.com/-mzp6Kr_T1Ro/XzV6MlpqqcI/AAAAAAAAnFw/n2EPlciepekF_IxY05EL5GVDwZeDRNchgCLcBGAsYHQ/s1600/0.png"/></strong></span></p>
<p><span style="color: #000000;"><strong>Now</strong>, we are going to import Elasticsearch public key into APT. To import the GPG key enter the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add –</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-oWOZYGKboE0/XzV6X6nhJqI/AAAAAAAAnF0/9-2ALjk2IZggOegqFpAbMsnxEB_qJYC_ACLcBGAsYHQ/s1600/1.png"/></p>
<p><span style="color: #000000;">Add Elastic repository to the directory sources.list.d by using the following command :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-6mTqzJPnqmI/XzV6fxG2Z6I/AAAAAAAAnF8/YFzB9v_Y6fIQGrn3LvSDE82JkPPg96ukwCLcBGAsYHQ/s1600/2.png"/></p>
<h3><span style="color: #800000;">Install and configure Elasticsearch</span></h3>
<p><span style="color: #000000;">Update the system repository</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">apt update</pre>
<p><span style="color: #000000;">Install Elasticsearch by using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">apt install elasticsearch</pre>
<p><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-gatRPfvlxhE/XzV6tE6AosI/AAAAAAAAnGA/MVqbVCytn7Ueh7T7QoDrC64Zo6IdEtFMQCLcBGAsYHQ/s1600/3.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="537" height="375"/></p>
<p><span style="color: #000000;">Next, we configure Elasticsearch.</span></p>
<p><span style="color: #000000;">Elasticsearch listens for traffic on port 9200. We are going to restrict outside access to our Elasticsearch instance so that outside parties cannot access data or shut down the elastic cluster through the REST API. Now we’re going to do some modifications to the Elasticsearch configuration file – elasticsearch.yml.</span></p>
<p><span style="color: #000000;">Enter the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano /etc/elasticsearch/elasticsearch.yml</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-OCB5xuOEN90/XzV60dk22mI/AAAAAAAAnGI/t9lIaEcZ6JAB5SgaHuM4FSgKNrbyZUVSACLcBGAsYHQ/s1600/4.png"/></p>
<p><span style="color: #000000;">Find the line that specifies network.host attribute and uncomment it and add localhost as its value and also uncomment http.port attribute.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">network.host: localhost
http.port: 9200</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-8PIzDUSHBnM/XzV7BOQRQWI/AAAAAAAAnGM/MehcxpsRTYw94G3phdRFySFYaXext6mkwCLcBGAsYHQ/s1600/5.png"/></p>
<p><span style="color: #000000;"><strong>Now, </strong>start and enable Elasticsearch services.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systemctl start elasticsearch
systemctl enable elasticsearch</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-rwpZiobtzrg/XzV7JXU2ctI/AAAAAAAAnGU/0i1Q4Cr-WowRkDi7YP5rm7aoHl6fZifkwCLcBGAsYHQ/s1600/6.png"/></p>
<p><span style="color: #000000;">Let’s verify the status if Elasticsearch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systemctl status elasticsearch
curl -X GET "localhost:9200"</pre>
<p><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-8mM1RfcK42o/XzV7S_QYAWI/AAAAAAAAnGc/sFusVlTpRCMglwz34tc1p5NEQBQpKHhdQCLcBGAsYHQ/s1600/7.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="589" height="613"/></p>
<p><span style="color: #000000;">By default Elasticsearch is listening on the port 9200 you can also verify it on your web browser by pinging https://localhost:9200</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-Jay4l4KTsL0/XzV7d44EnoI/AAAAAAAAnGg/kp4FuwfBEHkDcK71Lzfy9_k5n5-YgbXdQCLcBGAsYHQ/s1600/8.png"/></p>
<p><span style="color: #000000;">Now Elasticsearch is up and running.</span></p>
<h3><span style="color: #800000;">Install and configure Logstash</span></h3>
<p><span style="color: #000000;">Logstash used to collect and centralizing logs from different servers using filebeat</span></p>
<p><span style="color: #000000;">First Let’s confirm OpenSSL is running and then install Logstash by running following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">openssl version -a
apt install logstash -y</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/--AY1kg9Y-jo/XzV7l32-j7I/AAAAAAAAnGo/mQ8IYd3_DxQYN79aMbY5vUgi7jPLH5nQQCLcBGAsYHQ/s1600/9.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="506" height="346"/></p>
<p><span style="color: #000000;">Edit the /etc/hosts file and add the following line</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano /etc/hosts</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-_4PkGLHn21Q/XzV7usQWWPI/AAAAAAAAnGw/S1F2wMM65oEsLL56UNJp3OsWpAClBhBagCLcBGAsYHQ/s1600/10.png"/></p>
<p><span style="color: #000000;">Where 18.224.44.11 is ip address of server elk-master.</span></p>
<p><span style="color: #000000;">Let’s generate an SSL certificate to secure the log data transfer from the client Rsyslog &amp; Filebeat to the Logstash server.</span></p>
<p><span style="color: #000000;">To do this create a new SSL directory under Logstash configuration directory and navigate into that directory generate an SSL certificate by running following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">mkdir -p /etc/logstash/ssl
cd /etc/logstash/
openssl req -subj '/CN=elk-master/' -x509 -days 3650 -batch -nodes -newkey rsa:2048 -keyout ssl/logstash-forwarder.key -out ssl/logstash-forwarder.crt</pre>
<pre class="lang:default decode:true"><img decoding="async" src="https://1.bp.blogspot.com/-SPpJqEf5XCc/XzV71VcNjGI/AAAAAAAAnG0/c1i5NckFvT8q6HPsEIoGjL4r4I-ghcJDwCLcBGAsYHQ/s1600/11.png"/></pre>
<p><span style="color: #000000;"><strong>Now, </strong>we are going to create new configuration files for Logstash named ‘filebeat-input.conf’ as input file from filebeat ‘syslog-filter.conf’ for system logs processing, and ‘output-elasicsearch.conf’ file to define Elasticsearch output.</span></p>
<p><span style="color: #000000;">Navigate to Logstash directory create a file ‘filebeat-input.conf’ in conf.d directory by running command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /etc/logstash/
nano conf.d/filebeat-input.conf</pre>
<p><span style="color: #000000;">and paste the following configuration</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">input {  
beats {
   port =&gt; 5443
    type =&gt; syslog
    ssl =&gt; true
    ssl_certificate =&gt; "/etc/logstash/ssl/logstash-forwarder.crt"
    ssl_key =&gt; "/etc/logstash/ssl/logstash-forwarder.key"
  }
}</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-Pb3ngZO6Oak/XzV782TomZI/AAAAAAAAnG8/IKCbbkskzNwIfyQrzfb027FbwE2YP6-2QCLcBGAsYHQ/s1600/12.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="620" height="182"/></p>
<p><span style="color: #000000;">For the system log data processing, we are going to use a filter plugin named ‘grok’. Create a new conf. file ‘syslog-filter.conf in the same directory</span></p>
<pre class="lang:default decode:true">nano conf.d/syslog-filter.conf</pre>
<p><span style="color: #000000;">and paste the following configuration lines</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">filter {
  if [type] == "syslog" {
    grok {
      match =&gt; { "message" =&gt; "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" }
      add_field =&gt; [ "received_at", "%{@timestamp}" ]
      add_field =&gt; [ "received_from", "%{host}" ]
    }
    date {
      match =&gt; [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
  }
}</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-Cghi_l-t2vA/XzV8EcyravI/AAAAAAAAnHE/XlbMPPfB4tUiH1fnJ3va9UOVWhNvOq5JwCLcBGAsYHQ/s1600/13.png"/></p>
<p><span style="color: #000000;">And at last create a configuration file ‘output-elasticsearch.conf’ for the output of elasticsearch.</span></p>
<p><span style="color: #000000;">nano conf.d/output-elasticsearch.conf</span></p>
<p><span style="color: #000000;">and paste the following configuration</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">output {
  elasticsearch { hosts =&gt; ["localhost:9200"]
    hosts =&gt; "localhost:9200"
    manage_template =&gt; false
    index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"
    document_type =&gt; "%{[@metadata][type]}"
  }
}</pre>
<pre class="lang:default decode:true"><img decoding="async" src="https://1.bp.blogspot.com/-9WFW0jGpUGo/XzV8Lxf_jkI/AAAAAAAAnHM/9OT46Xax0OsrAWHJ_RyuyRZo2ecc04A9gCLcBGAsYHQ/s1600/14.png"/></pre>
<p><span style="color: #000000;">And at last, save and exit.</span></p>
<p><span style="color: #000000;">Now start, enable &amp; verify the status of Logstash service.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systemctl start logstash
systemctl enable logstash
systemctl status logstash</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-wIfrAvIvnSg/XzV8UvYR5DI/AAAAAAAAnHU/oDhq3CJaghghp7NAoIQvKUPp0MIKH3o2ACLcBGAsYHQ/s1600/15.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="603" height="220"/></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Install and configure Kibana</span> </span></h3>
<p><span style="color: #000000;">Install Kibana by using the following command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">apt install kibana</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-5j9kn9E_qgE/XzV8bqhTyUI/AAAAAAAAnHY/2GQjEIH-Bw8PjBR7Y28kCZ9a_ao9JUoAQCLcBGAsYHQ/s1600/16.png"/><br/>
<span style="color: #000000;"> </span><span style="color: #000000;">We are going to do some modifications to the kibana configuration file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano /etc/kibana/kibana.yml</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-t206fXKXf0U/XzV8h6SseiI/AAAAAAAAnHg/ddY14jQiaFkSLrZmEbiDWI8qMaZ00-ajwCLcBGAsYHQ/s1600/17.png"/></p>
<p><span style="color: #000000;">Locate and uncomment the following Attributes</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-ep-UkcK8sEc/XzV8oaksSuI/AAAAAAAAnHo/sue1sNFtoxcPWidUB6DQcxdGxckexp9RQCLcBGAsYHQ/s1600/19.png"/></p>
<p><span style="color: #000000;">Now start &amp; enable the kibana service:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systemctl enable kibana
systemctl start kibana</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-YpaBJr0pe7Y/XzV8v9y8_TI/AAAAAAAAnHw/Wce321aKUU0QU8UJZ_md08XXdmjLd6q2gCLcBGAsYHQ/s1600/20.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="571" height="95"/></p>
<h3><span style="color: #800000;">Install and configure NGINX</span></h3>
<p><span style="color: #000000;">Install Nginx and ‘Apache2-utlis’</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">apt install nginx apache2-utils -y</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-IKgoqGvXE1A/XzV831iiqAI/AAAAAAAAnH0/iSZsATQQKUsnqyyFRbLJdQID7TsIAruDQCLcBGAsYHQ/s1600/50.png"/></p>
<p><span style="color: #000000;">Now, create a new virtual host file named Kibana.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano /etc/nginx/sites-available/kibana</pre>
<p><span style="color: #000000;">and paste the following configuration Into the file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">server {
    listen 80;
    server_name localhost;
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.kibana-user;
    location / {
        proxy_pass https://localhost:5601;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-OcfH2qy2iQM/XzV9BzJKfFI/AAAAAAAAnH8/iEjTlTAvB28yJ-F5UiA_YriYmrHyhz4IgCLcBGAsYHQ/s1600/51.png"/></p>
<p><span style="color: #000000;">Let’s create authentication for the Kibana Dashboard and activate the Kibana virtual host configuration and test Nginx configuration after that enable &amp; restart the Nginx service by using the following command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sudo htpasswd -c /etc/nginx/.kibana-user elastic
ln -s /etc/nginx/sites-available/kibana /etc/nginx/sites-enabled/
nginx -t
systemctl enable nginx
systemctl restart nginx</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-GHQds0_pb2c/XzV9KEpugcI/AAAAAAAAnIE/bBFxBWYhn0UZiLwb4cYCEoz4eLcRgVF-QCLcBGAsYHQ/s1600/52.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="768" height="200"/></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Install and configure Filebeat</span> </span></h3>
<p><span style="color: #000000;">We’re going to configure filebeat data shippers on our elk-master server. This will be used to collect data from various sources and transport them to Logstash and Elasticsearch.</span></p>
<p><span style="color: #000000;">Download &amp; Install filebeat by running the following command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.8.11-amd64.deb</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-VtzEWD2w9QQ/XzV9VcstrcI/AAAAAAAAnIM/VKP9lbzFPVUwdZ9SZYa96ffxyY14ENS-QCLcBGAsYHQ/s1600/53.png"/></p>
<p><span style="color: #000000;"> Let’s repackage the downloaded file by using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sudo dpkg -i filebeat-6.8.11-amd64.deb</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-Gj1KPjKmg0Q/XzV9cOgA28I/AAAAAAAAnIU/xEEWsoE7QScvtEu40gbngVXG97fbGeEPwCLcBGAsYHQ/s1600/54.png"/></p>
<p><span style="color: #000000;">Next, open the filebeat configuration file named ‘filebeat.yml’</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano /etc/filebeat/filebeat.yml</pre>
<p><span style="color: #000000;">Edit the configuration file:</span></p>
<p><span style="color: #000000;">we’re going to use Elasticsearch to perform additional processing on data collected by filebeat. Therefore, Enable the filebeat prospectors by changing the ‘enabled’ line value to ‘true’.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-0-3899D8nag/XzV9jHVeesI/AAAAAAAAnIY/Yv8ozcFABsgRh2Qnf7S94RD-mWOMKANPwCLcBGAsYHQ/s1600/55.png"/></p>
<p><span style="color: #000000;">Next head to the Elasticsearch output section and add the following lines</span></p>
<p><span style="color: #000000;">output.elasticsearch:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">hosts: ["192.168.0.156:9200"]
username: "elastic"
password: "123"
setup.kibana:
host: "192.168.0.156:5601"</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-RCPgLtXxRA8/XzV9vTMuX0I/AAAAAAAAnIg/tdTeO4ZEbnM-7NnZgp52jn8LnFtJEcTnQCLcBGAsYHQ/s1600/56.png"/></p>
<p><span style="color: #000000;">Enable and configure the Elasticsearch module by running following command</span></p>
<p><span style="color: #000000;">sudo filebeat modules enable elasticsearch</span></p>
<p><span style="color: #000000;">Let’s start filebeat</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sudo filebeat setup
sudo service filebeat start</pre>
<p><span style="color: #000000;">And at last copy the Logstash certificate file – logstash-forwarder.crt – to /etc/filebeat directory by running following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cp /etc/logstash/ssl/logstash-forwarder.crt /etc/filebeat/
sudo service filebeat restart</pre>
<p><span style="color: #000000;">To test ELK stack open your browser and browse your server ip address followed by port 5601</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">https://localhost:5601</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-_iHTo5Wom9o/XzV92Iv9DwI/AAAAAAAAnIo/7nBEracYKKUmjnIodol5WncWrBi8O0CHACLcBGAsYHQ/s1600/57.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="790" height="703"/></p>
<h3><span style="color: #800000;">Routing Linux Logs to Elasticsearch</span></h3>
<p><span style="color: #000000;">We’re routing logs from rsyslog to Logstash and these logs transferred to Elasticsearch automatically</span></p>
<h4><span style="color: #000000;">Routing From Logstash To Elasticsearch</span></h4>
<p><span style="color: #000000;">Before routing logs from rsyslog to Logstash firstly we need to set up log forwarding between Logstash and Elasticsearch.</span></p>
<p><span style="color: #000000;">To do this we’re going to create a configuration file for Logstash. To create configuration file head over towards the directory /etc/logstash/conf.d and create a logstash.conf file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /etc/logstash/conf.d
nano logstash.conf</pre>
<p><span style="color: #000000;">paste the following configuration into the logstash.conf file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">input {
  udp {
    host =&gt; "127.0.0.1"
    port =&gt; 10514
    codec =&gt; "json"
    type =&gt; "rsyslog"
  }
} 
# The Filter pipeline stays empty here, no formatting is done.
filter { } 

# Every single log will be forwarded to ElasticSearch. If you are using another port, you should specify it here.
output {
  if [type] == "rsyslog" {
    elasticsearch {
      hosts =&gt; [ "127.0.0.1:9200" ]
    }
  }
}</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-Te78_jLCDfc/XzV9_6TRswI/AAAAAAAAnIs/RNHalOBgIPog7t_Bvg2Cc4Gywlv7jOoJQCLcBGAsYHQ/s1600/58.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="649" height="471"/></span></p>
<p><span style="color: #000000;">Restart the Logstash service.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systemctl restart logstash</pre>
<p><span style="color: #000000;">Let’s check that everything is running correctly issue the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">netstat -na | grep 10514</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-ODIbpMw0QSE/XzV-IQQ1ugI/AAAAAAAAnIw/w0z7Zrse1bgmmuxXK-RIEYEIKiVOsZhkACLcBGAsYHQ/s1600/59.png"/></p>
<h3><span style="color: #800000;"><strong>Routing from rsyslog to Logstash</strong></span></h3>
<p><span style="color: #000000;">Rsyslog has the capacity to transform logs using templates in order to forward logs in rsylog, head over to the directory /etc/rsylog.d and create a new file named 70-output.conf</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /etc/rsyslog.d
nano 70-output.conf</pre>
<p><span style="color: #000000;">And paste the following configuration into the 70-output.conf file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic"># This line sends all lines to defined IP address at port 10514
# using the json-template format.
*.*                         @127.0.0.1:10514;json-template</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-j47-8EHzgE0/XzV-O5BznWI/AAAAAAAAnI0/L9jztOf-ZaY1r1B2kVTZueD_-Pr1QXJ2QCLcBGAsYHQ/s1600/60.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="607" height="189"/></p>
<p><span style="color: #000000;">Now we have log forwarding, create a 01-json-template.conf file in the same folder</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano 01-json-template.conf</pre>
<p><span style="color: #000000;">And paste the following configuration into the 01-json-template.conf file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">template(name="json-template"
  type="list") {
    constant(value="{")
      constant(value="\"@timestamp\":\"")     property(name="timereported" dateFormat="rfc3339")
      constant(value="\",\"@version\":\"1")
      constant(value="\",\"message\":\"")     property(name="msg" format="json")
      constant(value="\",\"sysloghost\":\"")  property(name="hostname")
      constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
      constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
      constant(value="\",\"programname\":\"") property(name="programname")
      constant(value="\",\"procid\":\"")      property(name="procid")
    constant(value="\"}\n")
}</pre>
<p><span style="color: #000000;">Restart rsyslog service and verify that logs are correctly forwarded into Elasticsearch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">systemctl restart rsyslog
curl -XGET 'http://localhost:9200/logstash-*/_search?q=*&amp;pretty'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-XEMHafv8nmU/XzV-aQkpAoI/AAAAAAAAnI8/BvbIISKvNNUxAt-81dZffo10GZ7WsUvAQCLcBGAsYHQ/s1600/62.png"/></p>
<p><span style="color: #000000;"><strong>Note:- </strong>Logs will be forwarded in an index named logstash-*.</span></p>
<h3><span style="color: #800000;">Create a Log Dashboard in Kibana</span></h3>
<p><span style="color: #000000;">Open your browser and head over to https://localhost:5601 and you should see the following screen.</span></p>
<p><span style="color: #000000;">Go to the management section and create an index pattern called logstash-* and proceed for the next step.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-tr8mTPycFKk/XzV-uMhlUVI/AAAAAAAAnJI/V5Dk1cf3UpIHR75a2gZ9MhmyxNBQ0xiywCLcBGAsYHQ/s1600/63.png"/></p>
<p><span style="color: #000000;">we’ve defined logstash-* as our index pattern. Now we can specify some settings before we create it. In the field of time filter field name choose @timestamp and create an index pattern</span></p>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-qGVZr3oiWPo/XzV-3L2tw7I/AAAAAAAAnJM/G5Bm2HMN3igPsozdo5z3GccZ2ODgvgbawCLcBGAsYHQ/s1600/64.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="925" height="443"/></p>
<h3><span style="color: #800000;"><strong>Monitoring SSH entries</strong></span></h3>
<p><span style="color: #000000;">This one is a little bit special, as we can go into the “Discover” tab in order to build our panel.</span></p>
<p><span style="color: #000000;">When entering the discover tab, select logstash-*</span></p>
<p><span style="color: #000000;">From there, in the fiterbar, put a query filter “programename:ssh*”.</span></p>
<p><span style="color: #000000;">Now we can see every log related to the SSHd service in our machine.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-K95qJqxApk4/XzV_DYS7gJI/AAAAAAAAnJU/kjInL-3ePlchh-QcCyi7fGHPP_5qTYEowCLcBGAsYHQ/s1600/66.png"/></p>
<p><span style="color: #000000;">As we can see, now we have direct access to every log related to the SSHd service. we can for example track illegal access attempts or wrong logins.</span></p>
<p><span style="color: #000000;">Similarly, we can monitor various illegal access attempts or wrong logins like ftp, telnet etc…</span></p>
<p><span style="color: #000000;">For example, I took Telnet access to my server from a different machine.</span></p>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-LUk6iD-LCjw/XzV_QC6MAZI/AAAAAAAAnJc/EfCCk8LDyO848FXEGPvYA78Ta2OZlQpnQCLcBGAsYHQ/s1600/67.png" alt="Threat Hunting with ELK Log Monitoring Lab Setup" width="622" height="691"/></p>
<p><span style="color: #000000;">Let’s check what happens on the Kibana dashboard.</span></p>
<p><span style="color: #000000;">Hold tight!</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-lvBMaZBBnIQ/XzV_ZdTObII/AAAAAAAAnJk/1HIBym7BvtMlqft4OerSGGaIIGAucVzcwCLcBGAsYHQ/s1600/68.png"/></p>
<p><span style="color: #000000;">Nice! Now your panel is included in your dashboard.</span></p>
<p>Learn more on Threat Hunting from this <strong><a href="https://www.hackingarticles.in/tag/threat-hunting/">Link.</a></strong></p>
<p><span style="color: #000000;"><strong>Author</strong> – Vijay is a Certified Ethical Hacker, Technical writer and Penetration Tester at Hacking Articles. Technology and Gadget freak. Contac</span>t <a href="https://www.linkedin.com/in/vijay-igcbr/"><strong>Here</strong></a></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-related-none yarpp-template-thumbnails">
