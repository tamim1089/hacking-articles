<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ctf-challenges/" rel="category tag">CTF Challenges</a>, <a href="https://www.hackingarticles.in/category/ctf-challenges/hackthebox/" rel="category tag">HackTheBox</a></span>            </div>
            <h1 class="post-title entry-title">Blackfield HacktheBox Walkthrough</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/blackfield-hackthebox-walkthrough/" rel="bookmark"><time class="entry-date published" datetime="2023-03-24T12:45:57+00:00">March 24, 2023</time><time class="updated" datetime="2025-06-19T13:49:26+00:00">June 19, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Blackfield is a windows Active Directory machine and is considered as hard box by the hack the box. This box has various interesting vulnerabilities, and security misconfigurations were placed. As usual, we began with a basic nmap scan as a part of enumeration and noticed smb null session was enabled. Then we discovered a pre-authentication disabled account and performed AS-Rep Roasting, and cracked the obtained hash. With the extracted password, we were able to enumerate the users available in the AD using RPC Client.</span></p>
<p><span style="color: #000000;">Moving laterally, we used bloodhound and noticed that a user could change another user’s password, which could be done using RPC Client. After changing the password of another user, we accessed the shared folder, where we found an interesting file as memory-dumped data. Using mimikatz, we extracted the NTLM hash of the backup user from the lsass memory. The further enumeration in order to find the privilege escalation vector, we discovered the current user belongs to the backup operator group, and the sebackup privilege was enabled. With the privileged assigned to the current user, we were able to copy ntds.dit file and system hive.</span></p>
<p><span style="color: #000000;"> Lastly, we used the impacket secretdump tool to extract the administrator hash from the ntds.dit file with the help of the system hive. After obtaining the administrator hash, we logged in as an administrator and collected the root flag. So, without spoiling it more, let’s exploit it step by step.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<p><span style="color: #000000;"><strong>Initial Access</strong></span></p>
<ul>
<li><span style="color: #000000;">Initial Nmap TCP Port Scan</span></li>
<li><span style="color: #000000;">SMB Share Enumeration</span></li>
<li><span style="color: #000000;">Searching for the No Pre Auth (NPU) configured users</span></li>
<li><span style="color: #000000;">Krb5asrep hash cracking with john</span></li>
<li><span style="color: #000000;">RPC Client Enumeration</span></li>
<li><span style="color: #000000;">Setting up Neo4j Console</span></li>
<li><span style="color: #000000;">Export JSON files in Ne04j Console for the analysis</span></li>
<li><span style="color: #000000;">Analysing AD Hidden Relationship with other users</span></li>
<li><span style="color: #000000;">Attempt to change user password using RPC Client</span></li>
<li><span style="color: #000000;">Workgroup enumeration of audit2020 user</span></li>
<li><span style="color: #000000;">Extract data from the lsass.DMP file</span></li>
<li><span style="color: #000000;">User Shell</span></li>
</ul>
<p><span style="color: #000000;"><strong>Privilege Escalation</strong></span></p>
<ul>
<li><span style="color: #000000;">Exploiting Enabled Dangerous Privileges</span></li>
<li><span style="color: #000000;">Transfer disk shadowing DOS file to the target system</span></li>
<li><span style="color: #000000;">Copy ntds.dit file using assigned privilege</span></li>
<li><span style="color: #000000;">Make a copy of the system hive</span></li>
<li><span style="color: #000000;">Dump password hash from ntds.dit file Root flag</span></li>
</ul>
<p><span style="color: #000000;">Let’s exploit it step by step.</span></p>
<h3><span style="color: #800000;">Initial Access</span></h3>
<p><span style="color: #000000;">We are going to start the assessment with the normal TCP/IP port scanning.</span></p>
<h3><span style="color: #000000;"><strong>Initial Nmap TCP Port Scan</strong></span></h3>
<p><span style="color: #000000;">We begin with the port scan, where we use nmap to find out which ports are open and what services are running in the target host. Nmap is a popular port scanning tool that comes with Kali Linux. To perform a port scan, we have used –<strong>sV</strong> flag against the target system, which scans the top 1000 ports with the service version.</span></p>
<p><span style="color: #000000;">Flags features:</span></p>
<p><span style="color: #000000;"><strong>-sV</strong>:  Attempts to determine the service version</span></p>
<p><span style="color: #000000;">From the nmap scan, we have found eight ports are open where most of the services belong to the Active Directory environment. Any of these services can lead us toward any protocol-based vulnerabilities or any security misconfiguration, which is common in an active directory environment. Also, it is showing the domain name as <strong>BLACKFIELD.local</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nmap -sV 10.129.45.226</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh8l95O-Hc7TNJ30UpPkk04ILBAp3nKuRkFthNRSYSCpiruFA6aFujz1rFDKj7uCHVMbdR2QTzFjMvzEXv7LU08LBdETFyeLQ5uR9a3XnyEqS6K81qnF1zpemV64Rp1w2zqqbdiaSnOPROgDcMJC-OKZK6-e3hdDA0nwWTq6AqDJoDLcLhSfBC3NXGk1g/s16000/1.png"/></strong></span></p>
<h3><span style="color: #800000;">SMB Share Enumeration</span></h3>
<p><span style="color: #000000;">The Server Message Block (SMB) protocol is a network file-sharing protocol that allows applications on a computer to read and write to files and request services from server programs in a computer network. It can be seen in the internal network that smb share is enabled for the null session, which means a user can access that shared folder without authentication or with no password. Firstly, we listed all available shares using smbclient tools, which come with kali Linux by default. From the output, we noticed that <strong>$profiles</strong> directory has no comment, and we attempted to log in without a password and successfully logged in. After logging into smb share, we found there are so many directories we can access where all directories look empty as the size is showing its bytes in <strong>0</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">smbclient -L 10.129.45.226</pre>
<h3><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgDvJIyoGgGfw7qevhbrVQwJh1Y_TYnrUyuC4FrrjUXeCqgHwJm_qO25TgM1r4IhLucIDTz7nZXJpswGBUxOY411sgZvQ7cxU_vD7qD7EV8OrIgvDfrxzpG_bacMCeMrI8opOHDEST1b8YfPXDpatvcJV8iL1vKFF3cwyW4Ze6HuYpSgyHP6OBLW_-uVQ/s16000/2.png"/></strong></span></h3>
<p><span style="color: #000000;"> We added the domain name <strong>BLACKFIELD.local</strong> in our /etc/host file before continuing further enumeration. To do that, we can use any text editor such as leafpad, nano, gedit.etc.</span></p>
<h3><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjVemtyy54uOd-YZ5OB7ekT3KPFz67qSFew2LGFSPbgpvZzimYIUUZeJnZmr45Cb6wtprw90f0dMj5BE0orOOcyDV2JmvN4kPXHWtPCDLI1QiVuDA83zkcDUhhAXz4R4S4nHrTnw2HgCzgbYeMcQ3e7HptNhwquw7dNlqZI4cLkCIqovzeQgS-fLAHw0g/s16000/3.png"/></strong></span></h3>
<h3><span style="color: #800000;">Searching for the No Pre Auth (NPU) configured users</span></h3>
<p><span style="color: #000000;">As a threat actor, we are going to test all potential vulnerabilities that exist in an Active Directory environment. Suppose an admin has configured an account with no pre-authentication required; then the user does not need to request KDC to access any service or resources where an attacker can take advantage of the configuration and try to steal password hashes of the user that have Kerberos pre-authentication disabled. Then the attacker can try extracting a plain text password from the obtained hash. This attack is also known as AS-REP Roasting. Similarly, we tried to obtain any user’s password hash using the impacket library <strong>GetNPUsers</strong> and stored the result in the result.txt file. As a result, we found that the <strong>support</strong> account has no pre-authentication set and extracted its password hash. After obtaining the hash, we can try to crack it using offline tools such as john and hashcat.</span></p>
<p><span style="color: #000000;">In the below command, we have used the –dc-ip flag for the domain IP address with the domain name and the <strong>-userfile</strong> flag to give a list of potential users. Then we used the grep utility to filter our results.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-GetNPUsers -dc-ip 10.129.45.226 blackfield.local/ -usersfile username.txt &gt; result.txt</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiOuIDUjOyrh9ci2AqZ9iBX0JlD5M_JTjCvkh3a1lKpxEUIy7HWqKfMPwcjioGP7iu3oRvQoQHoFrD7YkVnDOfIo3xDisLsPJaC4slYyFOw3Rk86i0rM3iIgKPuqa85pr9iIvPnjrG5uosfvQ8F6byeLFmZr2ZR1K4OBmRiHCxr4oIxqTJgwGT02VnonA/s16000/4.png"/></span></p>
<h3><span style="color: #800000;"> Krb5asrep hash cracking with john</span></h3>
<p><span style="color: #000000;">We stored the obtained hashes in a hash file. Then we used john to crack the hashes in a plain text format issuing breached password wordlists that come with Kali Linux. Rockyou.txt file contains a list of commonly used password words. This file contains over 14,341,564 passwords that were previously leaked in data breaches. The tool did its job very well and cracked the hashes into human-readable form.</span></p>
<p><span style="color: #000000;"><strong>Cracked password:</strong> #00^BlackKnight</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">john --wordlist=/usr/share/wordlists/rockyou.txt hash</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhmaJDk4wkh6PjbxED0_v0tND1jyt42tX72KNeqmGa8YPdSWyr2JYxb75gHZujLLd4dhB6RgBTrz20gzl7DnHm1U7tIKfHhhgDv9yg5am4AKmoByOni8sXV75dboixg-idtGieT99-xLfdKsfAfli26vVAnvYX-rC3c_wgBAA84HvkE4LGMMSD8r2WRTA/s16000/5.png"/></strong></span></p>
<h4><strong><span style="color: #000000;"><span style="color: #800000;"> RPC Client Enumeration</span> </span></strong></h4>
<p><span style="color: #000000;">Next, we attempted to log into RPC Client using obtained credentials and listed all AD users, where we noticed three default accounts and two non-default account users. Remote Procedure Call (RPC) protocol is generally used to communicate between processes on different workstations. However, RPC works just as well for communication between different processes on the same workstation.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rpcclient -U support%#00^BlackKnight 10.129.45.226</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCabd7vUEZ2EerXddcWGTEgBPWCd4NEzbOqFbUglo-wrNUPKPTvhYTyy0gXJ80RYOZwDdCTPgdVE9hWJD1wIOPSr-pwRuQwPDCcQDFArWoLui-1DroTXN3AezHHWlY5gOiMWjswLWRX2cZ7-fVKK4janI5uBBBYN5gaossySeAxyvLYolNloqbgLRs-g/s16000/6.png"/></span></p>
<h4><span style="color: #000000;">AD Reconnaissance with Blood Hound </span></h4>
<p><span style="color: #000000;">As we have valid user account credentials, we decided to map the relationship of support users with other users. For example, audit2020 or an administrator. To map the domain relationship, we are using a popular tool called bloodhound. Bloodhound also comes with Kali Linux and allows to map domains remotely if an attacker has valid credentials of an active directory user. In the below command, we are collecting all domain information where we have provided different flags, the username(-u), password(-p), the domain name(-d), the name server(-ns), and collection method(-c).</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodhound-python -u support -p '#00^BlackKnight' -d blackfield.local -ns 10.129.45.226 -c all</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjE2TVNxKs22ycQNFAxt1Zjw3RUOEAwerTu3fH5khn0mRi8kGYYOP_H9xI7xTmbm3q2a08NoFRVmlFCHk4VutK2YAO9fbrbfJT8dObHpnCkZwtkfOQE-7rgpXRv8F_bOGEuNg8-Zco3z641sdd6Se7ZbWhMexTai_y33lGNarYDqoXnA5s9Guxw6UhDCQ/s16000/7.png"/></span></p>
<h4><span style="color: #000000;">Setting up Neo4j Console</span></h4>
<p><span style="color: #000000;">Then, we started the Neo4j Console to analyze the collected files by a bloodhound. This tool gives an interactive console for graphs with integrated visualization. To start the Console, just issue the below command. Once it is ready, then we require to access our loopback interface on its default port, 7474.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhY_qWzuLldNEjbBt933hEjgsqG_ObXyy-c0Bd_pQzWfAbDbm0D-_lt8vy0FPx4Q1KNyTsclj-GgFLn6jWmuqdUMXV0o4Op33_cU9jINQJYv4lGxkp6l4Y2lmzLlL6PFSauWamXmdEddb1Yw3WI2NWVguI3gZBZYqUkffLSVq3YUtlBv0MIvfP2j2ndtQ/s16000/8.png"/></span></p>
<h4><span style="color: #000000;">Export JSON files in Ne04j Console for the analysis</span></h4>
<p><span style="color: #000000;">We need to import all the JSON files in the Console. To do that, we can simply drag all files in the Console or use the import feature available in the neo4j.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqs8unlCFJ3wDdMQv_awwLFHjNFGvXKl7pI5-yo5k0VLpOTbh4Exd2De1WOfk1HtMehpDtpeFRhXjLl-oc3SaZPvnxfDVWEbtyg5SbEDp3fj8jW5vZfqrkmNUFYtLu0HfVAfsuXM4pxahFdrn2C7dTO0xG6jQ_nYiWzw0AOufNbGOgHoI8Qy_IHPrVVQ/s16000/9.png"/></span></p>
<h3><span style="color: #800000;">Analysing AD Hidden Relationship with other users</span></h3>
<p><span style="color: #000000;">After importing files, we will be seeing user relationships with graph visualization. The Neo4j property graph database model consists of: <strong>Nodes that describe entities (discrete objects) of a domain</strong>. Nodes can have zero or more labels to define (classify) what kind of nodes they are. Relationships describe a connection between a source node and a target node. From the node info tab, we noticed the “First Degree Object control,” which shows the relationship of the support user with <strong>audit2020</strong>, where <strong>the support</strong> user has the right to change the audit2020 password.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjq15LrS2b4WUAyXFPJzk0Vkzlvyg888R2Slyxk1ObeoknwjgGaLq71HcJsF5rE5nT0RHDqu89WF1dQ4mUqAQpICXu65Tlngy-3HdcP9sXlgGyj9rzCFjZDdLsfBUpo6T0c6XxCFrPFg7ua3-_FVlHjSUCQ0TYmVsycbIM_CqDDzQQ4vCN282l5dDI8Yg/s16000/10.png"/></span></p>
<h3><span style="color: #800000;">Attempt to change user password using RPC Client</span></h3>
<p><span style="color: #000000;">As we know, the support user has the privilege to change the audit2020 user’s password. We searched for ways to utilize this privilege and found a blog. In the blog, it is suggested to use 23 as a level when an attempt to change any user’s password using an RPC client. And also mentioned that will not be able to change the password of anyone with AdminCount = 1 (aka Domain Admins and other high priv accounts). Following the blog, we attempted to change the password of user audit2020 after authenticating as a support user in RPC Client and successfully changed the password.</span></p>
<p><span style="color: #000000;">Reference: <span style="color: #0000ff;"><strong>https://www.hackingarticles.in/forcechangepassword-active-directory-abuse/</strong></span></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">setuserinfo2 audit2020 23 'Password@1'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjmF2YDmpxLhvcYC8cjAsphnooQCkiujieDul0lGdZw2TeU2DljG0grjIkiVdIGDaAkQuv8bGrTO1JVje-7K48vc7E0WEJe8EGLHw0JUmMnHROj-AEl2gdkg4quzUMwtll3IM-_J08L13IiFUK1C12ONLfEAjUl_mpMVdIZ8xlElPFbh1hw4WDngj8gtQ/s16000/11.png"/></span></p>
<h3><span style="color: #800000;">Workgroup enumeration of audit2020 user</span></h3>
<p><span style="color: #000000;">After changing the audit2020 password, we logged in to smb shared folder named forensic. In the forensic folder, we found an interesting folder named <strong>memory_analysis</strong>, where we discovered another file named <strong>lsass.zip</strong>. LSASS file can be interesting for a threat actor because lsass.exe stores authentication credentials like encrypted passwords, NT hashes, LM hashes, and Kerberos tickets in memory. Storing these credentials in memory lets users access and share files during active Windows sessions without re-entering the credentials every time they need to perform a task. We downloaded the lsass.zip file in our local system for further analysis by running the following command. Then we unzipped it and found <strong>lsass.DMP</strong> file, which looks like holding lsass dumped memory in it.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">smbclient -U 'audit2020'  //10.129.45.226/forensic
get lsass.zip</pre>
<h3><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhWInDrbF96wUnDPJzK3EFC3H9yB0FFzXD0A9eS0p0p7AdLDRFv1myseqKGBIO3BDIcXqtarctywEzaGzSB5ASoT0C60Df3ZXJWUwFdARUcNqmpZIEOq9yfjxLi4us_iel_PRmmbde5LoU5WpaFQYMId8gZawWCelS9L3W7_yw5SfwFb4MMWoyTh1NzOw/s16000/12.png"/></strong></span></h3>
<h3><span style="color: #800000;">Extract data from the lsass.DMP file</span></h3>
<p><span style="color: #000000;">In order to extract the data from the lsass.DMP file, we utilized a powerful tool called mimikatz. Mimikatz is a tool that is commonly used by hackers and security professionals to extract sensitive information, such as passwords and credentials, from a system’s memory. To do that, we can use mimikatz in a windows system with a system privileged shell, as mimikatz does not work in a low privileged shell. Follow the below command to extract the data from the lsass.DMP file. As expected, mimikatz dumped the NTLM hashes from the lsass.DMP file. Now we are in a position to try authenticating using pass the hash technique as <strong>svc_backup</strong> user. There is a nice article by the hacking articles that can be used to utilize pass the hash technique in multiple ways.</span></p>
<p><strong><span style="color: #0000ff;">URL: <a style="color: #0000ff;" href="https://www.hackingarticles.in/lateral-movement-pass-the-hash-attack/">https://www.hackingarticles.in/lateral-movement-pass-the-hash-attack/</a></span></strong></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege:debug
sekurlsa::minidump lsass.DMP</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhJPuR3TejuRepHPWCKgi0-0ZVECbCYBw2pDkxzdGQQoun2PfB_xXC8w9quoQL7TPtLK3ay1IPAQO3WNVAomU-3z0kAxv3ly2SFVJl0OLWVJP9db0p46HIbIrSHDuvmoxdEsg1-eVtgE8D9lRz-XBgii8Bns5WOOvnGr9MuikGIFLUBvanQyqck9hJTeg/s16000/13.png"/></span></p>
<h3><span style="color: #800000;"> User Flag</span></h3>
<p><span style="color: #000000;">With obtained credentials, we logged in as a <strong>svc_backup </strong>user using <strong>winrm</strong> service, which runs on port 5985 by default. In the nmap result, we did not see this port open because nmap only scans the top 1000 ports where PowerShell remoting port does not count in. We can grab user flag from the svc_backup desktop directory. Then we checked the privileges assigned to the current user and found that the sebackup privilege and serestore privilege is enabled.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">evil-winrm -i 10.129.45.226 -u svc_backup -H '9658d1d1dcd9250115e2205d9f48400d'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhKa658RIJKhPp0rn7WOUkKrXPSNDCTQXbWYMDHzFnvTIs7npheL6E7hX-N-ynV5vkI8rwP2sd-BUI5WjDT_ym3vApmZz8HaJgIbHA5A2g4SYDZHHzpb_vDXablCMaTXdgaAc1ByRlsK_-JUUairqtf-pWKG9s9CDgDMoAmy1wH4bdSvOkkevHstgimcw/s16000/14.png"/></span></p>
<h3><span style="color: #800000;">Privilege Escalation</span></h3>
<p><span style="color: #000000;">Attackers exploit a bug, design flaw, or configuration oversight in an operating system or software application in the process of privilege escalation to gain elevated access to resources that an application or user normally protects. They can use it to gain access to more system functions and data than the root user intended. In some cases, privilege escalation can allow attackers to gain complete control of the system.</span></p>
<h3><span style="color: #000000;">Exploiting Enabled Dangerous Privileges</span></h3>
<p><span style="color: #000000;">After enumerating further about the svc_backup user, we found that the user is also a member of the backup operators group. A backup operator group member has the privilege to make a disk shadow copy and access all files owned by the system. With a quick search, we got another article published by hacking articles backup privilege escalation techniques. Following the blog, we created a file instructing disk shadow to create a copy of C: Drive into Z: drive as alias raj and saved it as raj.dsh file. The DSH file extension indicates to your device which app can open the file. However, different programs may use the DSH file type for different types of data. Then we compiled it into DOS format to use in the windows host.</span></p>
<p><strong><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/</a></span></strong></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">leafpad raj.dsh
set context persistent nowriters
add volume c: alias raj
create
expose %raj% z:
unix2dos raj.dsh</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjmJKpgUG5xC9DexvQ2JbGtrYd-OnHQW0Q9A1fLPC966Y0Kxd-WduCPsmHxrRkv2f02_hvDiiSIfkH5VrblX2CSRsn21rJA8GLpIbY-1srXqlbgdRi83Eh-vRHNLvTIT0RFQq0-7BSKhTVoQXQJdlFF0mN7TWGyvZGYxoC5Esgoh1ZcrvsCi6G8RY31hA/s16000/15.png"/></span></p>
<h3><span style="color: #000000;">Transfer disk shadowing DOS file to the target system</span></h3>
<p><span style="color: #000000;">After compilation, we transferred raj.dsh file into the target temp directory that we created. Here evil-winrm made our job easy since it added an upload feature in it, which means we do not require transfer files in the traditional way here. We confirmed that raj.dsh file is uploaded successfully in the C:temp directory.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">mkdir temp
cd temp
upload raj.dsh</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj8X_MHJ79iWG-Nv7MWpwuns39Rt31XvTqO3P-0AahnuyVb_VcFrtGjDx7CM6HsBiCmGMzH27R869mK7TkhdTQNIX_jC6F2PlOmgl5Ef2AZ0VurLQ1tHgHCYo50xgigyICHicsQtU6pPoPsFJoARht0vwkBFUfPZlz7AspvzlSC5b9HTta0En_j-IG6xQ/s16000/16.png"/></span></p>
<h3><span style="color: #000000;">Copy ntds.dit file using assigned privilege</span></h3>
<p><span style="color: #000000;">Execution of the dsh file in the target system exposed a shadow copy of C: drive in the Z: drive. Now we are in the position to make a copy of ntds.dit file in an accessible directory. We used the robocopy utility to make a copy of ntds.dit file from Z:windows directory to the current present working directory. Steps to reproduce this proof of concept follow the below commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd C:Temp
upload raj.dsh
diskshadow /s raj.dsh
robocopy /b z:windowsntds . ntds.dit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhpXNbYawyBLFgxW13k8AT8EOqSCWfXYMQlbf-p0K6urHW6Z_d4SwKWlQd-zwInywT91TYn3eU16d86S0vd76bf_d7E_jDLYSXHIkzo5PQ52jQrqLvUE_8e1a09Pwiz0imDdPpqbA1KtLPVwXmsP34-GJGNen3-x6YeH1E4whux4VxXZOOczeN9Hew9tA/s16000/17.png"/></span></p>
<h3><span style="color: #000000;">Make a copy of the system hive</span></h3>
<p><span style="color: #000000;">To perform this attack successfully, we will also require having a system hive otherwise, we will not be able to extract the hashes from the ntds.dit file. A logical group of keys, subkeys, and values in the registry forms a hive that loads a set of supporting files into memory when the operating system starts or when a user logs in. Each time a new user logs on to a computer, the system creates a new hive for that user with a separate file for the user profile. So, we copied the system hive in the temp directory and transferred it into the attacking machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">reg save hklmsystem C:Tempsystem
cd C:Temp
download ntds.dit
download system</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiIRvkktSUjZrclRyNyfZId_r9J5etvd14j23VXzqLvK0pEyXDT6lA8y1bw6R7RCPPk66olhDDiq5-mBLXV4bPI9GJagpv1vzxaDE63_JN2ylB45f1Ej9XgI1fOmwmL6xrtI0uO7THhszFSNSq8jOYvqF38jyCxPkSAzItHEQEl37lDjSpStqLHv_J0SA/s16000/18.png"/></span></p>
<h3><span style="color: #000000;">Dump password hash from ntds.dit file </span></h3>
<p><span style="color: #000000;">Once we transfer the system hive and ntds.dit files to the attacking machine, then we attempt to extract the hashes from the ntds.dit file using <strong>impacket secretsdump</strong>. Secretdump extracted all user’s hashes along with the administrator.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-secretsdump -ntds ntds.dit -system system local</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg1MfiY0QkC2xtEZhQ9EdbP2e212wRDM0qd83AHvmTcxlsdApAzXYFf0z8PK4kfR1zML6FpBg6Wuym5-EBiDwoge1TYdS2quRgDAxI7jUnWJdaMh4kGr-EDQBDJLhCfX0DfHSt2ORBIslWog_26f4rn0Ed23MLjd8IqODxSbZkqj9W4axS61j7iSRM89Q/s16000/19.png"/></span></p>
<h3><span style="color: #000000;">Root Flag</span></h3>
<p><span style="color: #000000;">Again, we can utilize the pass-the-hash technique to gain an administrator shell with obtained hash. We authenticated as an administrator successfully and grabbed the root flag from the administrator desktop directory.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">evil-winrm -i 10.129.45.226 -u administrator -H '184fb5e5178480be64824d4cd53b99ee'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiixWnHu9ZeKpoNbPGdbtVK7obs-BtXlmjTZwLC6iZKkWTum608zIR0Bju2G0vetUAQ8DGlOO8Jk2E_L8Z2kb3MGOOVHZqbHQhCJBn95XBKNbKGEvFoHxaewtY4PK7CX4eIWc8VB76b6zBUUsJ_uQpMOJhE_w7oMzXeuIR0DfcQcZQl9RuSiQuuAGs6Kg/s16000/20.png"/></span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Conclusion</span></span></h3>
<p><span style="color: #000000;">This machine was fun and was a great source of learning, where we learned and explored so many things such as TCP port scan, service enumeration, AS-REP Roasting, RPC Client functionalities and role in AD Environment, Hash cracking, smb share enumeration, Bloodhound user hidden relationship mapping, examining dumped data, pass the hash, windows active directory dangerous privileges that can lead to privilege escalation.</span></p>
<p><span style="color: #000000;">Thank you for giving your precious time to read this walkthrough. I hope you have enjoyed and learned something new today. Happy Hacking!</span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Subhash Paudel is a Penetration Tester and a CTF player who has a keen interest in various technologies and loves to explore more and more. Additionally, he is a technical writer at Hacking articles. Contact here</span><strong><span style="color: #000000;">:</span> <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://au.linkedin.com/in/subhash-paudel-a021ab207">Linkedin</a> </span></strong>and <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://twitter.com/subhashpaudel94">Twitter</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
