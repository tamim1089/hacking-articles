<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/exfiltration/" rel="category tag">Exfiltration</a>, <a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Data Exfiltration using DNSSteal</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/data-exfiltration-using-dnssteal/" rel="bookmark"><time class="entry-date published" datetime="2020-04-28T11:18:16+00:00">April 28, 2020</time><time class="updated" datetime="2025-05-15T13:12:19+00:00">May 15, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will comprehend the working of DNSteal with a focus on data exfiltration. You can download this tool from <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/m57/dnsteal">here</a></strong></span>.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><strong><span style="color: #000000;">Introduction to Data Exfiltration</span></strong></li>
<li><strong><span style="color: #000000;">DNS Protocol and its working</span></strong></li>
<li><strong><span style="color: #000000;">DNS Data exfiltration and its working</span></strong></li>
<li><strong><span style="color: #000000;">Introduction to DNSteal</span></strong></li>
<li><strong><span style="color: #000000;">Proof of Concept</span></strong></li>
<li><strong><span style="color: #000000;">Detection</span></strong></li>
<li><strong><span style="color: #000000;">Mitigation</span></strong></li>
<li><strong><span style="color: #000000;">Conclusion</span></strong></li>
</ul>
<h3><span style="color: #800000;">Introduction to Data Exfiltration</span></h3>
<p><span style="color: #000000;">Data Exfiltration refers to the process where an attacker fetches sensitive data from the target’s system and stores it on their system. As data exfiltration is simply a transfer of data off the network, it becomes difficult to detect. Every organization deals with handling sensitive data, which makes data exfiltration attacks very real. Insider threats or outsider threats can cause data exfiltration. Employees sell secrets for profit or share data carelessly in insider threats, whereas cybercriminals exploit vulnerabilities to establish a foothold and then steal the data in outsider threats.</span></p>
<h3><span style="color: #800000;">DNS Protocol and its working</span></h3>
<p><span style="color: #000000;">The DNS protocol works on TCP/UPD port 53. It is a stateless protocol as it exchanges specific information. It allows a network to connect to the internet and without it, all the surfing on the internet would be impossible and far-fetched.  Its function is to translate IP addresses to hostnames (for the convenience of the user) and vice versa. Hence the utmost importance of DNS in a network.</span></p>
<h3><span style="color: #800000;">DNS Data Exfiltration and its working</span></h3>
<p><span style="color: #000000;">As we know, DNS operates as a stateless protocol, meaning it was never intended to send or receive data from a client to the server. Even so, authorized DNS servers treat all the queries they receive as legitimate. Attackers exploit this fact; if they make a request to a subdomain, the system treats that request as data only if they construct the query properly. For instance, the attacker sends a query to example.target.com and the DNS target.com receives ‘example’ as a string then it will consider the said string as data and this will let the attack access target.com. Now, this lets the attacker set up a covert channel mostly by using the C2 server between DNS and client and retrieves all the data through bidirectional communication. Manipulating DNS in such a way to retrieve sensitive data is known as DNS data Exfiltration.</span></p>
<p><span style="color: #000000;">When one system transfers data to another without any direct connection and uses the DNS protocol for this transfer, attackers exploit the DNS protocol to access sensitive data, known as DNS Data Exfiltration.</span></p>
<h3><span style="color: #800000;">Introduction to DNSteal</span></h3>
<p><span style="color: #000000;">DNSteal is a tool that sets up a fake DNS server and allows an attacker to sneak in a network. As the name suggests, it is based on the DNS protocol and works on port 53. It is used to extract data from the target after setting up the connection and is one of the best tools for DNS Data Exfiltration. Multiple files can be extracted using this tool. It also supports Gzip file compression. It all lets you manage the size of packets which carries your data over the network to reduce suspicions.</span></p>
<h3><span style="color: #800000;">Proof of Concept</span></h3>
<p><span style="color: #000000;">Download DNSteal using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/m57/dnsteal</pre>
<p><span style="color: #000000;">And to further initiate the tool and see all the parameters it provides, use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python dnsteal.py</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-aczbSoZheZM/XqgJULDxSSI/AAAAAAAAjyI/geuVxfOfl8sP30xYhhmG3PLz5haOVvFSwCLcBGAsYHQ/s1600/1.png"/></span></p>
<h4><span style="color: #000000;">Generating the Extraction Command</span></h4>
<p><span style="color: #000000;">Now we will generate a command using DNSteal; the said command will extract the desired data upon execution on the target system. To generate the command, give your local IP and use -z parameter. This -z parameter will unzip the files upon receiving, as they are zipped by default. Therefore, type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python dnsteal.py 192.168.1.112 -z</pre>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-5nkieiICDbQ/XqgJVjAJVbI/AAAAAAAAjyg/fwCJLR9BVSgFDfqTI2UTrqmEkETLmNfWwCLcBGAsYHQ/s1600/2.png" alt="Data Exfiltration using DNSSteal" width="799" height="400"/></span></p>
<p><span style="color: #000000;">From our target system, we will request the secret.txt file over the DNS connection that will establish when we will run the given command. The contents of secret.txt can be seen in the following image.</span></p>
<p><span style="color: #000000;"> Now as you can see in the image above, two commands are generated. Copy the first one (highlighted one).</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mbWyHzLQqYc/XqgJVaDAJdI/AAAAAAAAjyY/8jHtdmDwXrwQ5oDX1eUzKM-bBv6c68z6wCLcBGAsYHQ/s1600/3.png"/></span></p>
<p><span style="color: #000000;">And paste it in the destination folder. Before executing the command, ensure that you change the filename to the name of the file you desire, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-3M-yUQFMYDI/XqgJViy-glI/AAAAAAAAjyc/1fCByMxrEM0jqMKriAjyrMgst3zfBLr8gCLcBGAsYHQ/s1600/4.png"/></span></p>
<h5><strong><span style="color: #800000;">Note</span>: </strong></h5>
<p>If you received an error “<em>dig: ‘H4sICLttFF8AA3NlY3JldC50eHQAy8hUyFRIzFUoSsziAgC/9XeXDAAAA-.A==-.secret.txt’ is not a legal IDNA2008 name (string start/ends with forbidden hyphen)</em>,”  then just edit your above command (f=secret.txt) by adding  “<span style="color: #800000;">+noidnin +noidnout</span>” at end of the command you have pasted.</p>
<p><span style="color: #000000;">And when the command is executed, the requested file will be received on your terminal. The tool will also calculate the MD5 hash sum for you. Also, you can view the content of the file with the cat command as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-Glt1dcmN4mE/XqgJV-hUUMI/AAAAAAAAjyk/y0B_Pw7p6_4r4XX-FxvM4_jlDFqYJR5TQCLcBGAsYHQ/s1600/5.png" alt="Data Exfiltration using DNSSteal" width="662" height="250"/></span></p>
<h4><span style="color: #000000;">Extracting a Whole Folder</span></h4>
<p><span style="color: #000000;">Now we will try to extract a whole folder instead of a single file. Initiate the DNS server provided by DNSteal tool via typing the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python dnsteal.py 192.168.1.112 -z</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-PfPN_6tT38s/XqgJWgtpGhI/AAAAAAAAjyo/i2YcWoNwi5cM5aHA99ZgERfJYm9oA9LxACLcBGAsYHQ/s1600/6.png"/></span></p>
<p><span style="color: #000000;">The folder which we will try to retrieve is shown in the image below, inclusive of their contents. The folder contains all type of data including .pdf, .msi, .png, .dll.</span></p>
<p><span style="color: #000000;">Again, you will see that it generated two commands. However, this time we will copy the second one (highlighted on) and paste it in the destination folder as shown below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-D1fKcrDeXvI/XqgJXQ9USjI/AAAAAAAAjys/2GQKtUraLisEigCUbogbLoqQ9BIhyDdwgCLcBGAsYHQ/s1600/7.png"/></span></p>
<p><span style="color: #000000;">Upon executing the command, you can see that the system receives the folder accurately with the calculated MD5 hash sum for each file, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-1rAd0MF6Qjg/XqgJXdThjVI/AAAAAAAAjyw/fZJc3sttVIMxtujxfFHuMUEuV9zDfSLNgCLcBGAsYHQ/s1600/8.png" alt="Data Exfiltration using DNSSteal" width="748" height="492"/></span></p>
<p><span style="color: #000000;">To reduce the suspicion of the attack, an attacker can divide the file into multiple packets. These packets can be of fixed size in bytes. An attacker can even allocate some bytes to the file name. They do this to avoid triggering an alert in a network, which abusing the UDP packet’s size will do. They can customize this by using -s, -b, and -f parameters. The parameter -s is for defining the subdomain value, -b is for specifying the number of bytes per packet and -f is for defining the value of bytes for the filename. In the following command, which you can observe well from the image given below as well, we define 4 subdomains. We set the bytes per packet to 57 and the file name value to 17.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python dnsteal.py 192.168.1.112 -z -s 4 -b 57 -f 17</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-c6Hbnj0rpxo/XqgJXtGmHpI/AAAAAAAAjy0/u4-akNvI_4E7YRQGZHneVoUqrMVGBM8AgCLcBGAsYHQ/s1600/9.png"/></span></p>
<h4><span style="color: #000000;">Extracting Critical Files</span></h4>
<p><span style="color: #000000;">Now we will acquire the passwd file from the target. As you can see from the image below, the size of the file is 2511 bytes. Now, just copy the command and paste it in the /etc folder on the target system. Again, before executing the command, make sure to change the filename to passwd.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-Qd41t3I8fXE/XqgJUDldV_I/AAAAAAAAjyM/qXBK7a2GJuAwQ_zaQZEt4OswV4BpdXDSACLcBGAsYHQ/s1600/10.png" alt="Data Exfiltration using DNSSteal" width="912" height="209"/></span></p>
<p><span style="color: #000000;">Once you execute the command, you can see that the system receives the data in chunks of 243 bytes as shown in the image below. When the system completes the receiving, it will also provide you with the MD5 hash sum, and you can read the contents of the file with the simple cat command as the system receives the uncompressed file:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-9D6nK8LnB6c/XqgJUXj-96I/AAAAAAAAjyQ/r9qPYo8D4ekDsQeshusR8Wif7PX-zDUogCLcBGAsYHQ/s1600/11.png"/></span></p>
<p><span style="color: #000000;">And this way we have retrieved the password file. And while this transfer of data, Wireshark helped us validate the bytes per packet size. Also, we can confirm that the connection established as well as the transfer of data is being done on port 53.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-YZCrGYY1SPk/XqgJU3YGQ2I/AAAAAAAAjyU/GRd0JwTX-UQLJdpeBsOXY7cOnxXk6aoMACLcBGAsYHQ/s1600/12.png" alt="Data Exfiltration using DNSSteal" width="687" height="634"/></span></p>
<p><span style="color: #000000;">So, this way by abusing the port and service of DNS. DNS Data Exfiltration attack is done.</span></p>
<h3><span style="color: #800000;">Detection </span></h3>
<p><span style="color: #000000;">Data Exfiltration attacks through DNS are very sneaky, and attackers transfer data over the network, making it challenging to detect this attack. Therefore, to detect this attack, you must regularly analyze the network traffic. To detect such attacks, focus on the processes that exploit the network or the processes that are unexpected. Moreover, analyze the network packets in-depth and check for any anomaly behaviour. For instance, if a client is sending more data than it is receiving then it is suspicious. To detect such attacks, also look for the data packets of fixed size that’s are being over a long connection.</span></p>
<h3><span style="color: #800000;">Mitigation</span></h3>
<p><span style="color: #000000;">The following measures should be taken for mitigation against DNS Data Exfiltration:</span></p>
<ul>
<li><span style="color: #000000;">Implementation of Network Intrusion Prevention System. This implementation should be based on a network signature and anomaly of packets.</span></li>
<li><span style="color: #000000;">Filter network traffic by limiting the clients to converse with DNS.</span></li>
<li><span style="color: #000000;">Set up dedicated DNS servers.</span></li>
<li><span style="color: #000000;">Perform proper network segmentation.</span></li>
<li><span style="color: #000000;">The configuration of firewalls should be apt and only necessary ports should be active.</span></li>
<li><span style="color: #000000;">Network traffic flow should be on the bases of firewall rules.</span></li>
<li><span style="color: #000000;">Make all employees aware of the consequences.</span></li>
<li><span style="color: #000000;">Block all unauthorized channels.</span></li>
<li><span style="color: #000000;">Adapt Data Loss Prevention Policies.</span></li>
<li><span style="color: #000000;">Maintain and monitor network logs.</span></li>
</ul>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">Monitoring and limiting the access of other ports, such as FTP, SSH has led attackers to come up with new techniques such as exploiting DNS over the years. DNS is a foundation for every internet connection and as every client-to-server connection depends on DNS; restricting the DNS access is not possible. And this makes DNS a worthy protocol for an attacker to use as Data Exfiltration. DNS Data Exfiltration is a major and very real threat to all organizations. And so, companies must deal with both the detection and prevention of data breaches and losses. Attacks like Remsec and Helminith used DNS port for data exfiltration, and these attackers can easily mimic these attacks. Therefore, educating oneself on such attacks is a necessity to protect themselves as a recent survey shows that 46 percent of companies have been victims of this attack.</span></p>
<p><span style="color: #000000;">To learn more about Exfiltration Techniques. Follow this <strong><a href="https://www.hackingarticles.in/category/red-teaming/exfiltration/">Link.</a></strong></span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Shubham Sharma is a Pentester, Cybersecurity Researcher, Contact <strong><a style="color: #000000;" href="https://www.linkedin.com/in/shubham-sharma-626964153/">Linkedin</a> </strong>and <strong><a style="color: #000000;" href="https://twitter.com/Shubham_pen">twitter</a></strong>.</span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
