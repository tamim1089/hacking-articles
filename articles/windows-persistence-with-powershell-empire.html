<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/persistence/" rel="category tag">Persistence</a>, <a href="https://www.hackingarticles.in/category/red-teaming/powershell-empire/" rel="category tag">PowerShell Empire</a></span>            </div>
            <h1 class="post-title entry-title">Windows Persistence with PowerShell Empire</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-persistence-with-powershell-empire/" rel="bookmark"><time class="entry-date published" datetime="2019-03-03T15:40:21+00:00">March 3, 2019</time><time class="updated" datetime="2025-05-13T07:58:21+00:00">May 13, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <h3><span style="color: #800000;">Introduction to Elevated Persistence Methods in Empire</span></h3>
<p><span style="color: #000000;">We present the third article in our empire series, through which we will learn elevated persistence methods. It organises its trigger method with storage options contained within each module.</span></p>
<p><span style="color: #000000;">In Empire, the elevated persistence modules use the trigger method, and different modules require different storage options. All of these persistence modules rely on PowerSploit’s persistence. As these modules are elevated persistence, you must have admin access to work as intended. They include various setting options, such as cleanup; for instance, the CleanUp option will delete your backdoor and return the machine to its original state.</span></p>
<h3 class="" data-start="866" data-end="908"><span style="color: #800000;">Persistence Modules and Their Triggers</span></h3>
<p><span style="color: #000000;">The registry methods in </span>gaining<span style="color: #000000;"> persistence are one of the oldest methods which </span>use<span style="color: #000000;"> the HKLM version to trigger our payload into the system. Couple of persistence that we will show in our article will have schtasks as an option. This option makes the module a bit trickier as it sets the payload to be triggered on either </span>DailyTime<span style="color: #000000;"> i.e., any given time or using OnLogon option which triggers the payload user </span>is logged<span style="color: #000000;"> on. The </span>Onlogon<span style="color: #000000;"> option does not display a prompt and runs as SYSTEM.</span></p>
<p><span style="color: #000000;">The WMI module is mostly the </span>go-to<span style="color: #000000;"> persistence method. It lets you add a permanent WMI payload at either </span>DailyTime<span style="color: #000000;"> (i.e. at a certain time) or at startup. This module </span>to<span style="color: #000000;"> runs as SYSTEM and it doesn’t </span><span style="color: #000000;">depend on </span>the user<span style="color: #000000;"> being logged in.</span></p>
<h4><span style="color: #800000;">Using the Persistence Modules in Empire</span></h4>
<p><span style="color: #000000;">The modules of persistence that </span>we are<span style="color: #000000;"> going to show in our article are as follows :</span></p>
<ul>
<li><span style="color: #000000;">Persistence/elevated/registry</span></li>
<li><span style="color: #000000;">Persistence/elevated/</span>schtask</li>
<li><span style="color: #000000;">Persistence/elevated/</span>wmi</li>
</ul>
<p><span style="color: #000000;">Firstly, we have to have an elevated session (session with admin rights) through </span>the empire<span style="color: #000000;">. To know how to get the said session click <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.hackingarticles.in/hacking-with-empire-powershell-post-exploitation-agent/">here</a></span>. As you can see in the image, we set high integrity to 1, which means we have admin privileges. Now, we will use the first persistence module listed above, and for this, use the following commands :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usemodule persistence/elevated/registry*
set Listener http
execute</pre>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="//3.bp.blogspot.com/-1oZFTfvz4Ks/XHvy-QWPaSI/AAAAAAAAdN4/K88MgR-_I2oFqX3UJQA_-sOBEvtyJ2H4ACLcBGAs/s1600/1.png" alt="Windows Persistence with PowerShell Empire" width="850" height="510"/></span></p>
<p><span style="color: #000000;">Once the above module is executed and when the target machine is restarted, you will again automatically have your session. As shown in the image below :</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="//2.bp.blogspot.com/-7w3uCTYtfis/XHvy-VGmdcI/AAAAAAAAdOA/xpUBBqU7LJc5XNCao8K04gEsEsUYwm-IQCLcBGAs/s1600/2.png" alt="Windows Persistence with PowerShell Empire" width="1183" height="630"/></span></p>
<p><span style="color: #000000;">Our next module is persistence/elevated/schtasks, this is a bit different from the previous one as in this we can set a certain time on which we want to gain our session. Again after having a session with administrator privileges, we will use the following set of commands to activate the said persistence module :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usemodule persistence/elevated/schtasks*
set OnLogon True
set Listener http
execute</pre>
<p><span style="color: #000000;"><img decoding="async" src="//2.bp.blogspot.com/-UrTLa_qTix0/XHvy-eJ6i7I/AAAAAAAAdN8/WjR-UaYxOXEUyliJTEzXyLoFbpWUlG3JACLcBGAs/s1600/3.png"/></span></p>
<p><span style="color: #000000;">Due to OnLogon option, </span>your<span style="color: #000000;"> session will return to you once the user logs on to their system, refer the following image for the same :</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="//1.bp.blogspot.com/-kGz6IYqP-Yw/XHvy_B-4zPI/AAAAAAAAdOE/VB1zcJC35ecdFObojrmqJssDEzyf5FXbACLcBGAs/s1600/4.png" alt="Windows Persistence with PowerShell Empire" width="986" height="415"/></span></p>
<p><span style="color: #000000;">Lastly, we will use </span>the persistence<span style="color: #000000;">/elevated/</span>wmi<span style="color: #000000;"> module and to use it, type the following set of commands :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usemodule persistence/elevated/wmi*
set Listener http
set AtStartup True
execute</pre>
<p><span style="color: #000000;"><img decoding="async" src="//3.bp.blogspot.com/-WCR39LCaNmA/XHvy_TZeb5I/AAAAAAAAdOI/ysUQhuvE92gAzuWAYQbekI1H-5m_LQU4QCLcBGAs/s1600/5.png"/></span></p>
<p><span style="color: #000000;">As we have set the startup option true, you will have your session as soon as the target machine starts up just like its shown in the image below :</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="//1.bp.blogspot.com/-pgMUEv47tXc/XHvy_hRx6mI/AAAAAAAAdOM/J4R2g0SIlZcwGqSU_y4lthhdkGLiztTDwCLcBGAs/s1600/6.png" alt="Windows Persistence with PowerShell Empire" width="1146" height="578"/></span></p>
<h4><span style="color: #800000;">Conclusion</span></h4>
<p><span style="color: #000000;">To learn more about Windows Persistence. Follow this <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/tag/windows-persistence/">Link.</a></strong></span></span></p>
<p><span style="color: #000000;"><strong>Author</strong>: <strong>Yashika Dhir</strong> is a passionate Researcher and Technical Writer at Hacking Articles. She is a hacking enthusiast. contact <span style="color: #0000ff;"><strong><a class="broken_link" style="color: #0000ff;" href="https://www.linkedin.com/in/yashika-dhir/">here</a></strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
