<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/penetration-testing/" rel="category tag">Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">Metasploit for Pentester: Mimikatz</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/metasploit-for-pentester-mimikatz/" rel="bookmark"><time class="entry-date published" datetime="2021-04-08T11:50:39+00:00">April 8, 2021</time><time class="updated" datetime="2025-05-30T13:23:29+00:00">May 30, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">This article will showcase various attacks and tasks that an attacker can perform on a compromised Windows Machine that is part of a Domain Controller through Metasploit’s inbuilt Mimikatz Module, also known as kiwi. We covered various forms of <a style="color: #000000;" href="https://github.com/Ignitetechnologies/Credential-Dumping"><span style="color: #0000ff;"><strong>Credential Dumping with Mimikatz</strong></span></a> in our <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/Ignitetechnologies/Credential-Dumping">Series</a> </strong></span>but we didn’t present a consolidated guide to use Mimikatz with Metasploit. Also, after the response from the<span style="color: #0000ff;"><strong> <a style="color: #0000ff;" href="https://www.hackingarticles.in/powershell-empire-for-pentester-mimikatz-module/">PowerShell Empire for Pentester: Mimikatz Module</a></strong></span>, We were encouraged to create this resource.</span></p>
<h3 class="ai-optimize-7"><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li class="ai-optimize-8"><span style="color: #000000;"><strong>Introduction</strong></span></li>
<li class="ai-optimize-9"><span style="color: #000000;"><strong>SAM</strong></span></li>
<li class="ai-optimize-10"><span style="color: #000000;"><strong>LSA Secrets</strong></span></li>
<li class="ai-optimize-11"><span style="color: #000000;"><strong>Changing Password of a User</strong></span></li>
<li class="ai-optimize-12"><span style="color: #000000;"><strong>DC Sync Attack</strong></span></li>
<li class="ai-optimize-13"><span style="color: #000000;"><strong>Golden Tickets</strong></span></li>
<li class="ai-optimize-14"><span style="color: #000000;"><strong>Purging Tickets</strong></span></li>
<li class="ai-optimize-15"><span style="color: #000000;"><strong>Extract Credentials from Security Packages</strong></span>
<ul>
<li class="ai-optimize-16"><span style="color: #000000;">MSV</span></li>
<li class="ai-optimize-17"><span style="color: #000000;">Kerberos</span></li>
<li class="ai-optimize-18"><span style="color: #000000;">SSP</span></li>
<li class="ai-optimize-19"><span style="color: #000000;">WDigest</span></li>
<li class="ai-optimize-20"><span style="color: #000000;">All</span></li>
</ul>
</li>
<li class="ai-optimize-21"><span style="color: #000000;"><strong>Mimikatz Commands</strong></span></li>
<li class="ai-optimize-22"><span style="color: #000000;"><strong>Extract Wi-Fi Credentials</strong></span></li>
<li class="ai-optimize-23"><span style="color: #000000;"><strong>Conclusion</strong></span></li>
</ul>
<h3 class="ai-optimize-24"><span style="color: #800000;">Introduction</span></h3>
<p class="ai-optimize-25"><span style="color: #000000;">To begin with the demonstration, we first need to compromise a Windows machine that belongs to a Network governed by a Domain Controller. The choice of compromise is your own. After the initial compromise through Metasploit, we get a meterpreter shell. A bunch of inbuilt commands load inside the meterpreter shell; if some commands or a set of commands are not loaded, you can load them in the form of a module. You also need to load Mimikatz as a module inside the meterpreter shell. After you load the module, you can hit the help command to see a list of different options and attacks that you can perform on the target machine through this meterpreter shell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">load kiwi
help kiwi</pre>
<p class="ai-optimize-26"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Evjggspiecs/YG7pwFJLK5I/AAAAAAAAvSE/AHjae27b0V4X-38fekswKKE7_G6Q9a7iQCLcBGAsYHQ/s16000/1.png"/></span></p>
<h3 class="ai-optimize-27"><span style="color: #800000;">SAM</span></h3>
<p class="ai-optimize-28"><span style="color: #000000;">The lsa_dump_sam module gets the SysKey to decrypt SAM entries (from registry or hive). It connects to the local Security Account Manager (SAM) database and dumps credentials for local accounts. As we have known that LSA is a system process that authenticates and logs users on the system. LSA authenticates the Domain Credentials that are used by the Operating System. The user information is validated by LSA by accessing the SAM of each computer. If there is a code that is running inside the LSA process than that process is able to access the credentials. LSA is able to store Reversibly encrypted plaintext, Kerberos tickets (ticket-granting tickets (TGTs), service tickets), NT hash, LAN Manager (LM) has. Here we can see that NTLM hash is extracted of the raj user.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">lsa_dump_sam</pre>
<p class="ai-optimize-29"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-XTMeRfnd804/YG7p2jSHI2I/AAAAAAAAvSI/4kg57BqseVY3pYqq1rfKGaRSvKXyRkz5QCLcBGAsYHQ/s16000/2.png"/></span></p>
<p class="ai-optimize-30"><span style="color: #000000;"><strong>Learn More: <a style="color: #000000;" href="https://www.hackingarticles.in/credential-dumping-local-security-authority-lsalsass-exe/">Credential Dumping: Local Security Authority (LSA|LSASS.EXE)</a></strong></span></p>
<h3 class="ai-optimize-31"><span style="color: #800000;">LSA Secrets</span></h3>
<p class="ai-optimize-32"><span style="color: #000000;">LSA secrets, Let’s understand what is the secret behind this? Earlier it was designed to store the cached domain records. After a while, Microsoft expanded its usage to store passwords, IE passwords, SQL Passwords, RAS Passwords and CISCO passwords and much more. A slice of the secrets can be seen in the screenshot below. This is quite less information than it was promised as this is a Local Lab Environment. Real Working Domain Controllers have much more data.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">lsa_dump_secrets</pre>
<p class="ai-optimize-33"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-4AHI1Zy20ok/YG7p-nAJKcI/AAAAAAAAvSM/-NIr1rA6tWM2MGnHkLLjhM81JLHf0P2cgCLcBGAsYHQ/s16000/3.png"/></span></p>
<h3 class="ai-optimize-34"><span style="color: #800000;">Changing Password of a User</span></h3>
<p class="ai-optimize-35"><span style="color: #000000;">The ability to change the password for a user can be not only a high-risk situation but also can be a tad bit annoying. The password_change module can help you do just that. There is an option to change the password if the old password is known. It generates and stores an NTLM hash for the new user. The other option is if you are able to extract the NTLM hash of a user, say using the lsadump then you have the ability to change the password for that user.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">password_change -u raj -p 123 -P 9876
password_change -u raj -n &lt;NTLM-hash&gt; -P 1234</pre>
<p class="ai-optimize-36"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-3TcnZinkKzQ/YG7qTHG7L5I/AAAAAAAAvSc/pKYlPf7rXpY4cFeVCFMyXyYmOtyk3349gCLcBGAsYHQ/s16000/4.png"/></span></p>
<h3 class="ai-optimize-37"><span style="color: #800000;">DC Sync Attack</span></h3>
<p class="ai-optimize-38"><span style="color: #000000;">As discussed earlier, the DC Sync attack allows an attacker to replicate Domain Controller (DC) behaviour. In simple words, it impersonates as a domain controller and requests other DC’s for user credential data via GetNCChanges. The only barrier is that you need a compromised machine and its user who is a member of the privileged account (Administrators, Domain Admin or Enterprise Admin).</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">dcsync_ntlm krbtgt
dcsync krbtgt</pre>
<p class="ai-optimize-39"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EnqHepWQVDQ/YG7qYuMZvnI/AAAAAAAAvSg/2Po6-eWPgxw3_YgTPdA-rM68yDdnGDkHwCLcBGAsYHQ/s16000/5.png"/></span></p>
<p class="ai-optimize-40"><span style="color: #000000;"><strong>Learn More: <a style="color: #000000;" href="https://www.hackingarticles.in/credential-dumping-dcsync-attack/">C<span style="color: #0000ff;">redential Dumping: DCSync Attack</span></a></strong></span></p>
<h3 class="ai-optimize-41"><span style="color: #800000;">Golden Tickets</span></h3>
<p class="ai-optimize-42"><span style="color: #000000;">An attacker forges the Kerberos Ticket Granting Tickets (TGT) in the Golden Tickets attack, which in turn authenticates users with the help of Kerberos. The Ticket Granting Services (TGS) is dependent upon the TGTs to verify the authenticity of tickets. This means that the forged ticket can be used to directly authenticate the attacker. These tickets can have a life span of up to a decade. That makes them so valuable almost like gold.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">golden_ticket_create -d ignite.local -u pavan -s &lt;SID&gt; -k &lt;hash&gt; -t /root/ticket.kirbi
kerberos_ticket_use /root/ticket.kirbi
shell
dir\\DC1.ignite.local\c$</pre>
<p class="ai-optimize-43"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-wSIYUYnQsdI/YG7qlLR5PWI/AAAAAAAAvSo/FBumzpUTbt4QqRhFLPCZF4-SpsTzpOx3wCLcBGAsYHQ/s16000/6.png"/></span></p>
<p class="ai-optimize-44"><span style="color: #000000;"><strong>Learn More: <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.hackingarticles.in/domain-persistence-golden-ticket-attack/">Domain Persistence: Golden Ticket Attack</a></span></strong></span></p>
<h3 class="ai-optimize-45"><span style="color: #800000;">Purging Tickets</span></h3>
<p class="ai-optimize-46"><span style="color: #000000;">While working with the tokens and tickets, there will be a time where the number of tickets would be too large to work with. This scenario will arise sooner or later and that’s when the purge command will help you. It will purge all the tickets in the current session.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">kerberos _ticket_list
kerberos_ticket_purge
kerberos_ticket_list</pre>
<p class="ai-optimize-47"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/--vrrKtD5e8g/YG7qptawxFI/AAAAAAAAvSw/ERrKvAMVjsgJXTtD6noxDW12qX9-YZjOQCLcBGAsYHQ/s16000/7.png"/></span></p>
<h3 class="ai-optimize-48"><span style="color: #800000;">Extract Credentials from Security Packages</span></h3>
<h4 class="ai-optimize-49"><span style="color: #800000;">MSV</span></h4>
<p class="ai-optimize-50"><span style="color: #000000;">Microsoft provides the MSV1_0 authentication package for local machine logons that do not require custom authentication. The Local Security Authority (LSA) calls the MSV1_0 authentication package to process logon data collected by the GINA for the Winlogon logon process. The MSV1_0 package checks the local security accounts manager (SAM) database to determine whether the logon data belongs to a valid security principle and then returns the result of the logon attempt to the LSA. MSV1_0 also supports domain logons. MSV1_0 processes domain logons using pass-through authentication We can extract the hash using the creds_msv command on meterpreter as shown in the image.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">creds_msv</pre>
<p class="ai-optimize-51"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-rEC47ARxz6s/YG7qv3yEPcI/AAAAAAAAvS0/zJa4Fn0apdgYEwN58xt6x6z1DPlWkgOcQCLcBGAsYHQ/s16000/8.png"/></span></p>
<h4 class="ai-optimize-52"><span style="color: #800000;">Kerberos</span></h4>
<p class="ai-optimize-53"><span style="color: #000000;">Similarly, if we want to extract the credentials from the Kerberos Service, we can run the creds_kerberos to attack the Kerberos. This however have the ability to extract clear text passwords for the users.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">creds_kerberos</pre>
<p class="ai-optimize-54"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-d5hwj4Dmihs/YG7q3WyW5ZI/AAAAAAAAvS8/weBIQW1cbuctx3RsJH-zUCvnj2L01WRiQCLcBGAsYHQ/s16000/9.png"/></span></p>
<h4 class="ai-optimize-55"><span style="color: #800000;">SSP</span></h4>
<p class="ai-optimize-56"><span style="color: #000000;">SSP or Security Support Provider is a dynamic-link library (DLL) that implements the SSPI by making one or more security packages available to applications. Each security package provides mappings between an application’s SSPI function calls and an actual security model’s function. Security packages support security protocols such as Kerberos authentication and the Microsoft LAN Manager. Due to the connection of the SSP with the Kerberos, it can extract credentials in clear text as shown in the image below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">creds_ssp</pre>
<p class="ai-optimize-57"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-MP7vtKLmN7U/YG7rHH3FHqI/AAAAAAAAvTM/vUTf6abia4AlBEGHxtnFTsA2-rmNcFlLQCLcBGAsYHQ/s16000/10.png"/></span></p>
<h4 class="ai-optimize-58"><span style="color: #800000;">WDigest</span></h4>
<p class="ai-optimize-59"><span style="color: #000000;">Microsoft introduced WDigest.dll in the Windows XP operating system. The Digest Authentication protocol designers created it for use with Hypertext Transfer Protocol (HTTP) and Simple Authentication Security Layer (SASL) exchanges. These exchanges require parties seeking to authenticate to demonstrate their knowledge of secret keys. This process improves upon earlier versions of HTTP authentication, where users send unencrypted passwords to a server, which leaves them vulnerable to capture by attackers using creds_wdigest.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">creds_wdigest</pre>
<p class="ai-optimize-60"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mZrber0SfLU/YG7rLU18b5I/AAAAAAAAvTQ/PI6PK_WlQ5wVVN4buBYcCaIWQxOmE9PfQCLcBGAsYHQ/s16000/11.png"/></span></p>
<h4 class="ai-optimize-61"><span style="color: #800000;">All</span></h4>
<p class="ai-optimize-62"><span style="color: #000000;">In case, you want to extract all the possible hashes or credentials from all the security packages on the target machine, then use creds_all command on the meterpreter. It will show all the credentials from the packages that we just discussed in one go.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">creds_all</pre>
<p class="ai-optimize-63"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-usJEI-Ehgzs/YG7rPD5bnPI/AAAAAAAAvTU/Cqmzt03UIP4JsZIz_l5ljO8rolTq561KgCLcBGAsYHQ/s16000/12.png"/></span></p>
<p class="ai-optimize-64"><span style="color: #000000;"><strong>Learn More: <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.hackingarticles.in/credential-dumping-sam/">Credential Dumping: SAM</a></span></strong></span></p>
<h3 class="ai-optimize-65"><span style="color: #800000;">Mimikatz Commands</span></h3>
<p class="ai-optimize-66"><span style="color: #000000;">There are modules inside the Mimikatz that don’t have direct access in the form of commands in kiwi. This is where the ability to run the Mimikatz commands comes to the rescue. This acts as a normal shell with the ability to run the Mimikatz commands and perform almost all the attacks possible in the scenario.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">kiwi_cmd hostname</pre>
<p class="ai-optimize-67"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EKbPpYsjDKw/YG7rTrxEEEI/AAAAAAAAvTY/C-J6qq_fOEMCxCNFBEjiGmIgZWielSLTACLcBGAsYHQ/s16000/13.png"/></span></p>
<h3 class="ai-optimize-68"><span style="color: #800000;">Extract Wi-Fi Credentials</span></h3>
<p class="ai-optimize-69"><span style="color: #000000;">Among the attacks that duplicate that tickets to provide the ability to run the commands as a domain controller, the ability to read the Wi-Fi credentials seems a bit dim but this is not the case. The Wi-Fi passwords are not the most thought-out passwords. It usually the first things that come into the user’s mind. This provides insight as to how that particular user will create passwords. There is a good chance that the account of that user will have the same passwords. Even if it turned out to be that case, you get free Wi-Fi access and that’s not bad.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wifi_list</pre>
<p class="ai-optimize-70"><span style="color: #000000;"><strong><img decoding="async" src="https://1.bp.blogspot.com/-A1t5eeUHo0M/YG7raVH3k8I/AAAAAAAAvTg/QYuNW1xER-oUVW5rL1bwNHjDgQTQ7Wz_ACLcBGAsYHQ/s16000/14.png"/></strong></span></p>
<h3 class="ai-optimize-71"><span style="color: #800000;">Conclusion</span></h3>
<p class="ai-optimize-72"><span style="color: #000000;">After the Credential Dumping Series, different tools targeted a specific vulnerability, and PowerShell Empire for Pentester: Mimikatz Module offered insight into PowerShell Empire’s ability to attack the Windows Authentication Process. We felt the need for a guide that can help a person who is trying to get the reins of Metasploit. </span></p>
<p class="ai-optimize-73"><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher, and Penetration Tester. Contact on <span style="color: #0000ff;"><strong>Twitter</strong> </span>and <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/pavan2318/">LinkedIn</a></strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
