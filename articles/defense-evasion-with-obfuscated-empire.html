<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/defense-evasion/" rel="category tag">Defense Evasion</a>, <a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Defense Evasion with obfuscated Empire</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/defense-evasion-with-obfuscated-empire/" rel="bookmark"><time class="entry-date published" datetime="2020-10-09T18:46:25+00:00">October 9, 2020</time><time class="updated" datetime="2025-05-11T21:13:00+00:00">May 11, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will learn the technique of Defense Evasion using the PowerShell Empire. PowerShell Empire is one of my favourite Post Exploitation tools and it is an applaudable one at that.</span></p>
<h3><span style="color: #800000;">Table of Contents:</span></h3>
<ul>
<li><span style="color: #000000;">Installation</span></li>
<li><span style="color: #000000;">Getting a session with Empire</span></li>
<li><span style="color: #000000;">Obfuscating with Empire</span></li>
</ul>
<h3><span style="color: #000000;"><span style="color: #800000;">Installation</span> </span></h3>
<p><span style="color: #000000;">When evading all the target defense with Empire, it is important to focus on installation. There are two methods to install Empire, obfuscating scripts would not work if you install Empire using apt install command. But this problem wouldn’t occur if you use the git clone command as shown in the image below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/BC-SECURITY/Empire</pre>
<p><span style="color: #000000;">The above command will download Empire on your system and to install it, use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd Empire/ 
cd setup/ 
.install.sh</pre>
<p><span style="color: #000000;"><strong> <img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-BZGfRsNdemY/X4CuPlnvMWI/AAAAAAAApWM/t8J9RDl1_U8D58m_TSl769smaJQx2lEmgCLcBGAsYHQ/s16000/0.png" alt="Defense Evasion with obfuscated Empire" width="740" height="207"/></strong></span></p>
<h3><span style="color: #800000;">Getting a session with Empire</span></h3>
<p><span style="color: #000000;">With the above commands, your Empire is downloaded and installed. Let us now get the Empire up to and running and take a session of the target system. Once you start Empire, the first thing to do is to start a Listener. And to start a listener, use the set of following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">listeners 
uselistener http 
set Port 80 
execute</pre>
<p><span style="color: #000000;">The above commands will start a listener on port 80. Once the listener is active, we have to launch a stager. The stager that we are going to use in this article is of windows and is in batch language. To launch the stager, use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">back 
usestager windows/launcher_bat 
set Listener http 
execute</pre>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-mqzXMi839EQ/X4CuUb59XII/AAAAAAAApWQ/l5RhcVem9YcoszZTUVoEPMme04AJUpQhQCLcBGAsYHQ/s16000/1.png" alt="Defense Evasion with obfuscated Empire" width="686" height="691"/></span></p>
<p><span style="color: #000000;">Once your malware is ready, it will be stored in /tmp directory by default as you can see in the image above. To send this bat file to the target system, you can use python one-liner server or any other method you like. We used a python server for our this practical. To use the python server, type the following command in the directory where the file is saved like in our case it was /tmp directory:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python -m SimpleHTTPServer</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EnvMZEbHuh8/X4CuYoeO8LI/AAAAAAAApWU/5osOph6nwtsc-UBtauVFHLHobrOP3WDaQCLcBGAsYHQ/s16000/2.png"/></span></p>
<p><span style="color: #000000;">Once the file is executed in the target system. You will get your session as it is shown in the image below. To access the session or agent (as per the Empire terminology) use the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">agents 
interact &lt;agent name&gt;</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-illknauEjDQ/X4Cuc99r-GI/AAAAAAAApWY/au6rR2yczqs0lzT4uefNxg8AxBPAWt4SQCLcBGAsYHQ/s16000/3.png" alt="Defense Evasion with obfuscated Empire" width="706" height="246"/></strong></span></p>
<p><span style="color: #000000;">In the event viewer, you can go to the <strong>Applications and Services Logs &gt; Microsoft &gt; Windows &gt; PowerShell &gt; Operational </strong>and check the log made by the batch file from Empire as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-cwYXSNdeyN4/X4Cujcxb2bI/AAAAAAAApWc/FgGRMCC-h2w85_cte_Quo4TevhGgE4j8QCLcBGAsYHQ/s16000/4.png"/></span></p>
<h3><span style="color: #800000;">Obfuscating with Empire</span></h3>
<p class="" data-start="204" data-end="982"><span style="color: #000000;">Now, as you can see in the image above, the log of the file provides proper details of the malicious file. Specifically, these details include the code of the file, its storage location, and other important information. Consequently, when the system can read these details, it becomes easy to detect the file. Therefore, to successfully attack the target, we must evade all the defenses the target has set up. To achieve this, we will globally obfuscate the Empire and then create our malicious file. As a result, obfuscating the Empire ensures that all malicious files we generate from Empire will be obscure—making them hard to detect in the target system—and will help us bypass defense systems like antiviruses. To begin the obfuscation of Empire, use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">preobfuscate</pre>
<p><span style="color: #000000;">The above command will download all the scripts required for the obfuscation.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-b0Bhco5Xaj0/X4CunegjhTI/AAAAAAAApWk/KKdTdqx8UiAm6u6HvWJE-JTJpAxfl1bLwCLcBGAsYHQ/s16000/6.png"/></span></p>
<h4 data-start="1110" data-end="1143"><span style="color: #000000;">Setting Obfuscation in Empire</span></h4>
<p><span style="color: #000000;">The command executed above takes a bit of time but if it allows us to be successful in our attack then little time is no problem and most importantly it is worth it. Once all the obfuscating scripts are downloaded, execute the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">set Obfuscate true</pre>
<p class="" data-start="120" data-end="276"><span style="color: #000000;">Afterward, this command initiates the obfuscation process, and it obfuscates all the stagers you develop and agents you create, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-xSWVEUKygMs/X4Cus2dsCiI/AAAAAAAApWw/6KfnUeQzzI8ZdInq9nINasyIh6azU2ofwCLcBGAsYHQ/s16000/7.png" alt="Defense Evasion with obfuscated Empire" width="595" height="53"/></span></p>
<p><span style="color: #000000;">Now once the obfuscation is active, we will once again execute the listener as shown previously in this article and once the listener is up and running we will launch a stager with the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">usestager windows/launcher_bat 
set Listener http 
execute</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-jpZOTb7jEI8/X4CuwyAlvVI/AAAAAAAApW0/0BQgKeJxJpAv6tsJl_zU1zbAfbe3fv-KgCLcBGAsYHQ/s16000/9.png"/></span></p>
<h4 data-start="1838" data-end="1889"><span style="color: #000000;">Delivering and Verifying the Obfuscated Payload</span></h4>
<p><span style="color: #000000;">Similarly, like before, use the python server to deliver the malicious file to the target system.</span></p>
<p><span style="color: #000000;">Once the file is executed in the target system; you will get a new session as shown in the image below. To access the new agent, use the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">agents 
interact &lt;agent name&gt;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-jw540N-cTz4/X4Cu01FWX6I/AAAAAAAApW8/3Z1-8FqazA0GPf2FNZEV6ethV0qJxO-YACLcBGAsYHQ/s16000/10.png"/></span></p>
<p><span style="color: #000000;">Now the session we have received is through obfuscation and we will confirm this by using Event Viewer. Follow the same path as earlier (<strong>Applications and Services Logs &gt; Microsoft &gt; Windows &gt; PowerShell &gt; Operational)</strong> in the Event Viewer to see the log created by our malicious file.  AS you can see in the image below, the details that the log has now is vague and confusing. This makes the file unreadable by the system and is successful in dodging defenses such as anti-viruses.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-ldnuuXgS6OQ/X4Cu4wI2_RI/AAAAAAAApXE/sRnnQC8DCrgRC0Ito3M6mAs_zidnWuZcgCLcBGAsYHQ/s16000/11.png" alt="Defense Evasion with obfuscated Empire" width="893" height="644"/></span></p>
<p><span style="color: #000000;">This way the Obfuscated Empire can save you from getting caught in the target system. It is important to learn such techniques to glide by the defenses in the target system to test whether the defenses in the place are proper or not.</span></p>
<p><span style="color: #000000;"><strong>Author: Yashika Dhir</strong> is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a></strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
