<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/persistence/" rel="category tag">Persistence</a></span>            </div>
            <h1 class="post-title entry-title">Domain Persistence: Golden Certificate Attack</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/domain-persistence-golden-certificate-attack/" rel="bookmark"><time class="entry-date published" datetime="2022-01-27T17:44:01+00:00">January 27, 2022</time><time class="updated" datetime="2025-05-11T20:40:15+00:00">May 11, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Security analysts who have some knowledge about Active Directory and pentesting would know the concept of tickets. Kerberos, the default authentication mechanism in an AD, uses ticket-based authentication where a Key Distribution Center (KDC) grants a Ticket-Granting Ticket (TGT) to a user requesting access to a service or an account which can then be redeemed to generate a service ticket (ST) to access a particular service, like SQL account. Attacks such as <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/domain-persistence-golden-ticket-attack/">Golden Ticket</a> </strong></span>demonstrate how an attacker can persist its access to the domain admin by obtaining the “krbtgt” account’s NTLM hash. </span></p>
<p><span style="color: #000000;">Domain persistence is necessary for an analyst in the event the admin password gets changed. Persistence can also be achieved by using certificate-based authentication deployed in Active Directory Certificate Service. One such method is the Golden Certificate Attack. This technique leverages the certificate-based authentication in AD enabled by default with the installation of ADCS (Active Directory Certificate Services) by forging a new certificate using the private key of the CA certificate. The technique was implemented by <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://twitter.com/gentilkiwi">Benjamin Delpy</a></strong></span> in Mimikatz. Will Schroeder and Lee Christensen wrote a research paper on this technique which can be referred to <span style="color: #0000ff;"><strong>here</strong></span>.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;">ADCS and Certificate Basics</span></li>
<li><span style="color: #000000;">Installing ADCS in a local AD environment</span></li>
<li><span style="color: #000000;">Extracting CA certificate</span></li>
<li><span style="color: #000000;">Forging a new CA certificate</span></li>
<li><span style="color: #000000;">Obtaining domain admin’s TGT</span></li>
<li><span style="color: #000000;">Extracting admin NTLM hash</span></li>
<li><span style="color: #000000;">Performing PtH (Pass the Hash) attack</span></li>
</ul>
<h3><span style="color: #800000;">ADCS and Certificate Basics</span></h3>
<p><span style="color: #000000;">ADCS provides authentication in a forest. It enhances the overall security identity of a member (user or service account) by binding it to a corresponding private key. A certificate is an X.509-formatted digitally signed document used for encryption, message signing, and/or authentication. It contains the following details:</span></p>
<ul>
<li><span style="color: #000000;"><strong>Subject</strong> – The owner of the certificate.</span></li>
<li><span style="color: #000000;"><strong>Public Key</strong> – Associates the Subject with a private key stored separately.</span></li>
<li><span style="color: #000000;"><strong>NotBefore and NotAfter dates</strong> – Define the duration that the certificate is valid.</span></li>
<li><span style="color: #000000;"><strong>Serial Number</strong> – An identifier for the certificate assigned by the CA.</span></li>
<li><span style="color: #000000;"><strong>Issuer</strong> – Identifies who issued the certificate (commonly a CA).</span></li>
<li><span style="color: #000000;"><strong>SubjectAlternativeName</strong> – Defines one or more alternate names that the Subject may go by.</span></li>
<li><span style="color: #000000;"><strong>Basic Constraints</strong> – Identifies if the certificate is a CA or an end entity and if there are any constraints when using the certificate.</span></li>
<li><span style="color: #000000;"><strong>Extended Key Usages (EKUs)</strong> – Object identifiers (OIDs) that describe how the certificate will be used. Also known as Enhanced Key Usage in Microsoft parlance</span></li>
<li><span style="color: #000000;"><strong>Signature Algorithm </strong>– Specifies the algorithm used to sign the certificate.</span></li>
<li><span style="color: #000000;"><strong>Signature</strong> – The signature of the certificates body is made using the issuer’s (e.g., a CA’s) private key.</span></li>
</ul>
<p><span style="color: #000000;">Certificate Authorities (CAs) are responsible for issuing certificates. Upon ADCS installation, CA first creates its own public-private key pair and signs its own root CA using its private key. Hosts add this root CA in their systems to build a trust system.</span></p>
<h5><span style="color: #000000;"><strong>Certificate Enrollment</strong> </span></h5>
<p><span style="color: #000000;">The process of a client obtaining a certificate from AD CS is called certificate enrolment in which the following steps happen:</span></p>
<ul>
<li><span style="color: #000000;">Client generates public/private key pair</span></li>
<li><span style="color: #000000;">Client places a public key in a Certificate Signing Request which includes details like the subject of certificate and certificate template name.</span></li>
<li><span style="color: #000000;">Clients sign CSR using the private key and send CSR to the enterprise CA server.</span></li>
<li><span style="color: #000000;">CA server verifies the client’s requested certificate’s template</span></li>
<li><span style="color: #000000;">CA generates the certificate and signs it using its own private key</span></li>
</ul>
<h5><span style="color: #000000;">Types of extensions in certificates </span></h5>
<p><span style="color: #000000;">Following extensions can be found throughout this article:</span></p>
<ul>
<li><span style="color: #000000;">*.p12 – The PKCS#12 is a binary format for storing the server certificate, any intermediate certificates, and the private key into a single encryptable file. Whenever you export a certificate using <strong>msc</strong> it comes out in a p12 format.</span></li>
<li><span style="color: #000000;">*.pfx – It is the same as *.p12. *.pfx files are also PKCS#12 format binary certificates. The only difference is that *.pfx was developed by Microsoft and *.p12 by Netscape. So, for compatibility reasons you’ll see us converting *.p12 into *.pfx format.</span></li>
<li><span style="color: #000000;">*.pem – Contains Base64 encoded certificate+private key pair in this context. Otherwise, a pem file can have anything depending on the developer.</span></li>
</ul>
<h3><span style="color: #800000;">Installing ADCS in a local AD environment</span></h3>
<p><span style="color: #000000;">To configure ADCS in our test environment, we followed the following steps.</span></p>
<h4><span style="color: #000000;">STEPS</span></h4>
<p><span style="color: #000000;">1: Go to server manager and choose “<strong>add roles and features</strong>”</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjA-dYzVjhP9cXj8nWebXYNJwssCUXEi5pH_Lf_KSQHhjaJ5pSSqWoBsikkoG0duyzYGMnnJ5W1a7Bp6n2x3QIwAz9rEFOceWqSwzSmNGmUwSDIS8_MKRaXlr8SyVV1oOO4uwyqXEcvwIPhQOVYsT8DMjvwQd3zZw5qmRmSmjoATQ4URsGvBxP_KF05sA=s16000"/></span></p>
<p><span style="color: #000000;">2: Here, you could read about pre-requisites that windows recommend and click next</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgViusZHka1lGGAcHHE79rJ-MaM6smuPSccaDmwPhSnRPzx_kyGazpEQHN94hXxTB3VjtsEfthxobdvD-IbnyhMIk30ZYixVurz7PFn7vFHGQNwifVm7ZjG6OupBXHYt00XVTAT3vfqmar9vEdks0r03DThqEiUy9KVwhxTq3szAcxD1Zhcpl59SThq0A=s16000"/></span></p>
<p><span style="color: #000000;">3: Now, choose the server from the server pool. Your environment could have multiple pools, we’ll choose DC1.ignite.local</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg8hE3apCM6G0JQv11DgHXRtMg-NEDcBmMQdS_dmC245nvaIRZJFgWaRQsz_nzKSMLekKIQrkdXsElSdg2wL-P0eci_9f2NZBLp_PO6u80B8y_6snMSNhVNvp9GWiYTmvKXgkVhzw9U3Yb8dscC9Ybzd3y9kDwssNPrk3bN_2PlNxEXg0BDtSOwmXjVLg=s16000"/></span></p>
<p><span style="color: #000000;">4: Under server roles, choose Active Directory Certificate Services and click next</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjz4tQ2-k550CcP3gAAGjsEq1dqakfzZ6S3qAa3V4O8uZ-1tSvWtACc2b3DUrqWkTTaZleVo_bGgsWbMATJLtGZ-lWcADBj1SN6cSLAZrZtomFIzRRPLXPpFNsVOAWYtOT-PA0i7kCiedNCjoCpqtFDSeOGPnS8T-Vt6ORgPva6yDqpI8ywaYwzzdmx7A=s16000"/></span></p>
<p><span style="color: #000000;">5: Next, you can click next on this step or add some features. For this demo we don’t need anything extra so click next.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjvAUgCEuvxuF6Z2nd604xyletQPhzcEuc-Csk8UhIC6bAGdP-g02iBvYbjyD0qYp5aKFxMIB9eUOBeA6bvskQCtQ6L-Odo5GnI3E20zkAPwGYUT8jxV-7wt8yk4KwKMNkimgkYAA1qJ---A_jtiLY8zHLWF9E5QXsWRpgHDIFKQCGcr1y1mR5XxkPQ_w=s16000"/></span></p>
<p><span style="color: #000000;">6: Choose your role as the Certificate Authority. A CA is the primary signer of user certificates and allows them access to resources under certificate-based authentication schema.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh-vJOxCSRmlPOB4f2WdrGInD8SZ9RViF6BgiGGysgKddtR9fsbiKevKlmzdrmvc00N-MUuaWwmRwG9XghC0JYUa0b6i2B48_SE2JzYet_RBRnX9-Q0RYxZjHviFJIKPkSU8WOhKUNYLZW_zouEJpqdCMgN3oP634vE0DZS6IxpE89WxZ-VmGZT1kuXaA=s16000"/></span></p>
<p><span style="color: #000000;">7: Click install</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhda5FuIvGXHKWTL1TWZyQvA8rYhtd2OTmmGl3pK3jH481JuM1MqN9Y5j0XmHJ4AzofbZAtBMhfmXdoS7C0D03kWat6Ztj2EDQ5vTriKDw-A-g0kvHC8PkZ1Mp98KWnMOmMAL31tkI5ckmKqPWiSwUsRE2xLcqLJt_IMLNU2WN-MbRe-mtuDafdP8Vbag=s16000"/></span></p>
<p><span style="color: #000000;">8: Under the flags (notification) click configure Active Directory Certificate Services on the server</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhnz5KvCkEx8Q1bnMu70IzLBh6VQY6vLdNvfkkNmkWDCalBrG5M6f0eDJhNWSbBzXKpLfbMZY69XLVBSt8DMG6WVpmNXVgkOxtjvQdkHyneFFb5ctRVOtj1i_pM9PoQFr_uan4F85LizrfvBbwQ9HXZJBNIAQTIsdNxLzsx482HD_MFEnXQTOKFH-XusQ=s16000"/></span></p>
<p><span style="color: #000000;">9: Here, you can specify the Admin account you want to serve as your CA</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgXQGzs25Bf4u7_ngtqjwe4-EDapuH5CeALwOx23it8xt-YT82UBayVjzYIvNcbmDiEnFVCgMtpkH7HFNL0fAxqqRkgmeP6cAJWlx9jo_e03uSDxn-jTLPzAFIfjvN4bMmuD2OGtL5DB7meQT1OPdZc5VpWarkfjUvLMTfO0-HUS4TsKWQJ5SW-IuxEBQ=s16000"/></span></p>
<p><span style="color: #000000;">10: Choose CA (redundant step but click anyway)</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjFZUTdPwb6VUNel-FYWYAVWSQJUeqSy7YzmNIzSOZH8xemOqhHycXLO8ymfY1a_mL9rGpZPjRB4faz8jD0vmfHCGwHAU_woUvyQwx2k6-rbjuoFyDPXhNgg6iMTBPeIPolsIRgvK9sfs6Z_q00jkANeUTMljLST48vnlFJDzX5F8nhfWDCqu545nePYA=s16000"/></span></p>
<p><span style="color: #000000;">11: Choose enterprise CA</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEig8zG16NBCtNI09hv37JiOxYRarSK5_bGQDVKuFy6oiwgQKHB9YABlVk9Zyyq6Cq8qQaixqUMNjzekDAiZ4ZxTZq-xLsTzuIQDdEdcRDWOwrKNvigZtO3BN98aeG4l_7aaRrkugXGLOZjwAo4JY9KVWcaYX2r3L7LKxk81Pyat1KATvcHpXSGJKSD6Dg=s16000"/></span></p>
<p><span style="color: #000000;">12: Choose Root CA as domain admin is the one that is on the top of PKI structure</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg5fZPZoUYgpyjDSo4EC-rR3s-YKPYdN69BTjzxVFzyT21ZmnWdr_fDIXDlQE4UJ3tAmBk-4058N5_EcQxir_djIufrCGxKBYjcOBAVCqSD1P3L5DKqeFTREgHVux7sWvz35EQEPLecy-_SsnsFbLulZvbVrbHvnsO0xrW2Dy8sAZYKinFwZVM92Gov3Q=s16000"/></span></p>
<p><span style="color: #000000;">13: Create a new private key. As explained above, a private key is required to sign any user certificate including the root CA. This key can be used to forge a golden certificate as will be explained later.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhUbB-fgr3qkpNxwIFjVzxiL7fjmuUfqwzM2iaxNrzhRigj3yFbRS9oqjxG1vTMlQW8emjOrQ5DDzKiHmikq2nO13zh_rdnDDMChGwi9uo28_N8wj4Bg29rDSmBzI3U8vnAZmXvRTEhTf5qtxj7Oka6OqR8g20fVwnW9lShqVxU1Zn2GHULpEuu5azSZQ=s16000"/></span></p>
<p><span style="color: #000000;">14: You can modify as per your wish. We are leaving everything to the default settings.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhjLCfMkET8rcFMzTb12TzNX2-hP40F7TY3Xlsu34JIPf8VXGqEUijqmZd5TngEbAIILHxKnKq0_EaXRKg-hgBu4RVTjvS-IxeK5lHErMuT5HWaw0xhHA_JEvAQ4WRX8xcArQtV5q_0DN3rsZHghOjf790ghSPsL1Tl48TAF7SRwkkNVCnWR_pGw5r2ZQ=s16000"/></span></p>
<p><span style="color: #000000;">15: Here, you can add the common name for this CA certificate you installed</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg-zgiZj7TaKCwChdcR0EbeHiTiRKzAt59VbwBhNSykOF22mLMhb3EfOt6YfdIbyp45PQs0A9cRhw2v8EI6uXkI3JKMVLm4L7GV-xfkLmSMMIJikcusPK0zJynqN4PNDAmC-yKmE25OyrEqnNSLDMzfApdXl2uE0NH0V1JBr08CZqcdKha_-bpsjaJ_MA=s16000"/></span></p>
<p><span style="color: #000000;">16: Here, you specify the validity of the certificate. For demo purposes leaving them to the default</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjRx-uTi1lQxFPwU5nf-vMHulUTxzzcbDgu-82N3jwxVjIiJIjAJpjilLFlktG58JMi--78xqRiR0yK5YmQrZ2vqk9X9Gaf2GdWnsPgknw5cA4Syge1vVxUNOoICFR1hIxP3erJhY0XIHqoR3oQscZc1vPUe-ZVGGmTkGf5FWaQLt07MDViOLBsEV9ZSQ=s16000"/></span></p>
<p><span style="color: #000000;">17: Customise the locations for the cert and click next.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgd3mfgFSCIrVVE-Zrx5ZnWoscXTGGjcFAWTq32V1fp4uE1-yXa6t_pddeAhRA90vk-hafNqqWHLsLdrir6BBWNA0dlOCtzrB3iQH_hTflCVZkxOBPmLBpUqQlVPNLGMkgjS3G6xpCsIWFbVG5yZYoOhtbLEeM_Lx_HECp7ceiZTuu05X0BQ3cJ8Nf95A=s16000"/></span></p>
<p><span style="color: #000000;">18: Next, click on configure</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh87CnXfdjJpq0ATlHqfZsLX3ojzOOlIWGHKGHgS_qotm6OkS6KJvUjp0tJqDKPBGVgjrsLsl6Ulr7Ms2YmfnERaYzFfL-6Gk8oDjIlFvCEy2rNz0LZ-D-_Hp0mk-maYEg1D9HRxvRXDu9x2WYjdv6c-I5WRKAxDZik-cYvo6ywHzpllzzxlYfHaZ8RNg=s16000"/></span></p>
<p><span style="color: #000000;">19: As you can see, the certificate is now configured successfully</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhX-hCzhkmieiSSD6I86onZzSR6fvLlL1JV3Bdw2ePD-vSkcsWDK5UBEaujTVifof2pgmVmYr3Fo7hteR9TIyTtkgH94INKagKcpzv0izEFrgs0tgi88h8MQg2mXqZ9UEUS_DKapHAZyGwck61vdorMNTcCB0-XPR2EUw6lsBdAkjXRMWqE7vOkUIV2HA=s16000"/></span></p>
<h5><span style="color: #000000;"><strong data-start="189" data-end="257">Exploiting ADCS for Domain Persistence Using Golden Certificates</strong></span></h5>
<p><span style="color: #000000;">Now that we have set up ADCS and certificate-based authentication, we are good to go.</span></p>
<p><span style="color: #000000;">Here, we have the following architecture for testing:</span></p>
<p><span style="color: #000000;">Domain Controller- DC1@ignite.local – Admin</span></p>
<p><span style="color: #000000;">User (Client) – <a style="color: #000000;" href="mailto:harshit@ignite.local">harshit@ignite.local</a> – Windows 10 client connected</span></p>
<p><span style="color: #000000;">Attacker Machine – Kali Linux standalone</span></p>
<h3><span style="color: #800000;">Extracting CA certificate</span></h3>
<p><span style="color: #000000;">This article demonstrates domain persistence. Hence, we are assuming that the attacker has already compromised a user machine in the domain and escalated its privileges to the domain admin. Now, the attacker wants his connection to persist for a long period of time. That’s where the golden certificate comes into play. To forge a golden certificate, we will extract the CA certificate+private key combo first, using that file (private key), we will forge a new certificate for a particular user (here, DC) and then use that certificate to ask for tickets, dump hashes etc.</span></p>
<p><span style="color: #000000;">First step is to extract the CA. We can use <strong>certsrv.msc</strong> run command on the compromised domain admin system.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgXLdNBBFjv-8TTc6NgOgeEOHJsiSE0sQZTt5KKjPUCsPh1WH6IPlYM_35cU6jF52pVzPiNv0M8zDIlSN262YIoU0oMe2_jFQOxf6IJR5uibvtXzwruk2LbWzEWvpAySn3-Vi_In7nRzC6_R76Dw0rHNEKMGk2GxLz7NCAETMFLpBA6VwBgUrH7RLFb-w=s16000"/></span></p>
<p><span style="color: #000000;">It will open up a window listing all the CAs in server pool. We choose back up CA</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEj9nJaiAkLVGXZGr3U5_bZWeO5Yv7fLyM8xEBJd2RJLlseqk_vs8D08SUyOc-A6DKabBfYkLhcZ-Q5ts9-_BAzYK6Lmr7bhiaSJ76b7RWAnHN9HA9oE0znKw4Gu_m7eaFkrgAjKeMKwYT8VrDdNQQb9muOcibB5F7JZ3kFWezKGQcyIqamRKueM9jRKhw=s16000"/></span></p>
<p><span style="color: #000000;">Press next</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg3cQxgbdvzgPescT-6ELULy9iI2d2oNwpOmoGlyWjbkLHTKrNDqJULPRFdw_nqs_vJoD6jeZ5DgggxeLD6dZmGUBLWJv2PiFtSeKE5Hit2U1zf_XEjUW_TITzJSqpDoewZQ45rZQToaNtrrqOCdBAWQ12lPesFIaZunULXcluD_VixtMjTkltKUIwoxw=s16000"/></span></p>
<p><span style="color: #000000;">Here, click on Private Key and CA certificate and give the location of the directory where you want to back this certificate up. Our location is C:\cert</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjQBUJiAqwutC0joNtUfPCDTic-KDyLov3TB3OEm28PJTLGIEXSHf0PUHkmt4SdkdF-v3RUDvaGzsSPoFlmyn6ERHhTRgHgzK3HamCtsenHz9AhxkIaNfKorYcwezznyhmZ34TAMWWuNlMQgEo82hB_GMUNK_6oE8RFobFHUfiqUgTsm4iV_qLw-WMKYg=s16000"/></span></p>
<p><span style="color: #000000;">You can input the password to protect this backup file. This is optional but we can keep a simple password like 12345</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEj9JguUj1wGyDxv5eSVuD0p7JCE27-AKUvKbCwzSRtXAJShG9vAOpZw1VmXgaaKQROKoq25CDSe1lvnxWaCUlGvZ35geVvQVSRTjkIG7rJFDsIYheMQgH9nXc3kim5xjSTX5VmA73ngTMrHYarKusATkOfGfHKQRMIweLkUMwZkcWybOf3jA87KBURckQ=s16000"/></span></p>
<p><span style="color: #000000;">Now, the certificate has been extracted successfully. There are other methods to extract the CA certificate too. You can do this using mimikatz as well.</span></p>
<h3><span style="color: #800000;">Forging a new CA certificate</span></h3>
<p><span style="color: #000000;">As you would observe the extracted certificate has a p12 format. This is equivalent to pfx format and theoretically a simple extension change should have converted p12 into pfx but due to some errors, we used openssl to properly convert p12 into pfx using a 2-step process.</span></p>
<h5><strong><span style="color: #000000;">Converting .p12 to .pfx Using OpenSSL</span></strong></h5>
<p><span style="color: #000000;">First, you need to download Openssl from <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://slproweb.com/products/Win32OpenSSL.html">here</a></strong></span>. Once installed you can go to the C:\cert (folder where the certificate was backed up) and run the following command to convert this p12 certificate into a pem file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">"C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in ignite-DC1-CA.p12 -out newfile.pem</pre>
<p><span style="color: #000000;">Here, you need to enter the import password 12345. You can set a new password for this pem file. We kept it as 12345 only for simplicity. As you can see “newfile.pem” has been created.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEi0j0-m4qhz0F6FZLgnow5Hg-JJgNX7nPd3J-UXEggYpCKei73GwtP_0f_-zoPruvzIkihTngGZ5Jy7R4J87_aHTiF5uKyEqWg4HFU2vK6eYETEqT2fQZ6X09X8YP55NNi8IccycdxFcNbnEoPp9-RZMIAvgXptOUlnOncAo2iFZOxC-yR0M9Q4fSC3Ug=s16000"/></span></p>
<p><span style="color: #000000;">Now, you need to run another openssl command to convert this pem into pfx.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">"C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in newfile.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx</pre>
<p><span style="color: #000000;">Note, we have added two additional parameters here.</span></p>
<p><span style="color: #000000;">-keyex: Specifies that the private key is to be used for key exchange or just signing.</span></p>
<p><span style="color: #000000;">-CSP: Stands for a cryptographic service provider. This command specifies that the output file is in a standard format for Microsoft CSP. You can read more about it <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/microsoft-enhanced-cryptographic-provider">here</a></strong></span>.</span></p>
<p><span style="color: #000000;">Fianlly, you can see that cer.pfx has been exported to this directory now.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjE8DN1v06jnc16BQCNNW38Kssz-7hkJuk-1JfRbyTAK04nHd292lVtgHactdrXVG_oHux7OIcYLdOyQq_RJ7wZbuVoPxxNcADK1etoCXr_RneUjWr0FMQHBrJHLZS3oMJ-ecB3QPmKpRaPLDyMEGuZ99MrWdx5v6xryy2fCuenJJSkRDYBm4VChhtjMg=s16000"/></span></p>
<h5><span style="color: #000000;"><strong data-start="457" data-end="503">Forging the Certificate with ForgeCert</strong></span></h5>
<p><span style="color: #000000;">Using the private key available in this cert.pfx (combo of CA and private key) we will forge a certificate. The tool that we will be using is <strong><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://github.com/GhostPack/ForgeCert">ForgeCert</a></span></strong>. This program can be compiled in Visual Studio 2022 just by importing the *.sln file and building the exe. Note that along with the exe, we would need BouncyCastle.dll and some config files. These files will be output in Project folder/bin/debug. Copy these files as it is in the C:\cert folder.</span></p>
<p><span style="color: #000000;">Now, we will forge our new certificate with the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ForgeCert.exe --CaCertPath cert.pfx --CaCertPassword 12345 --Subject CN=User --SubjectAltName DC1@ignite.local --NewCertPath admincert.pfx --NewCertPassword ignite@123</pre>
<p><span style="color: #000000;">You can keep a complex password here but we are keeping a simple ignite@123</span></p>
<p><span style="color: #000000;">Now, the golden certificate with a validity of 1 year has been saved! This means I have had access to the domain for at least a year now!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiKQwZ0jo3_ZGdeD4cONugDpYfEjRMWk2Bf6jRwRbKQspMN0taoXtd0Yoh1vgi571lJiNmanPbYVSFBh9alRqaL5BKox2LgyhVP8A8Aep758oKzlg-1fOBN4mR3tVEHm-LHLA9TZqPsDmE41hZql9z2v0XF-RhDyGBAX0zqQwQe6YfLOUjKX4BS4_gdgQ=s16000"/></span></p>
<h3><span style="color: #800000;">Obtaining domain admin’s TGT</span></h3>
<p><span style="color: #000000;">Now that I have forged my golden certificate, I can perform a number of attacks. We are simulating a scenario where the admin password has changed now. Attacker no longer can access domain admin yet still has a user system with him (windows 10 client here). Also, the attacker still has a golden certificate with him! He can use <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/GhostPack/Rubeus">Rubeus</a> </strong></span>to ask for admin’s TGT like so:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Rubeus.exe asktgt /user:DC1 /certificate:admincert.pfx /password:ignite@123</pre>
<p><span style="color: #000000;">Then, it gives a *.kirbi ticket which is a base64 encoded format of a TGT.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhpGMQlU745xFsdlrPANs61xRgi7FPzK73CGKqJv4NIbJMknMjxnHVy2KL3nM__kum4-Gbee8YWQbsfF8z_35HSyvCN4XLIgWujY6U9g61LSxa6JH9zwbDfWG1yTXen37QfOZne13zsPa_AyKoSkFoS1iwQkZ_JuXm6iFPT0LdvPkbrLoRxVlmgzaQkwg=s16000"/></span></p>
<p><span style="color: #000000;">So, we can convert this TGT into a base64 decoded format using the kali command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">echo "&lt;ticket value&gt;" | base64 --decode &gt; ticket.kirb</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjKwI3tdnIKbXsrrCzDWk4UYYFFfasMyF-gpSIKKUjXUWW5_ZjUKGK7sIKDG9OFedZtXihJJ1-m_TrsKL6aLsGd1BZX-HdGkuxHQbgVp_BTjNLnK35UM8F7EViMuppBwI1vb3f8q3ba3AahsuYslkhfcKFUO2zAHFDiY-bsAGfhyU5egpStXLeGjtOAPw=s16000"/></span></p>
<h3><span style="color: #800000;">Extracting admin NTLM hash</span></h3>
<p><span style="color: #000000;">With this ticket.kirbi, we can do pass the ticket attacks, extract NTLM hashes among other things. Since we don’t know the admin’s new password now, let us try to extract his credentials.</span></p>
<p><span style="color: #000000;">For that we will run mimikatz on the user (windows 10 compromised non-admin system on the AD), import the ticket.kirbi using Kerberos::ptt module and then perform a <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/credential-dumping-dcsync-attack/">DCSync attack</a></strong></span>. Since the ticket is the domain admin’s ticket, we can perform functions that require elevated privileges.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">kerberos::ptt ticket.kirbi
lsadump::dcsync /domain:ignite.local /user:administrator</pre>
<p><span style="color: #000000;">Then, this gives us a fresh set of admin’s NTLM hash</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjVfxxGlYn0_Z3LrOcWyI33tfm1AGEeiUxI0ZuUCi8GOHw-wO3HHxKA3-bin5WG1ZY5nxUuCUTgnGdH7rGG8bXlS8aBOOnw2O55fsUYc3kH1bJ7NQesLJF9XYS1Dli-E0tsiHNQEKLK9CH5GYgMUOMm64G-i6_DtV559CIVZxla3exxaHcpkhMP3Gn86A=s16000"/></span></p>
<h3><span style="color: #800000;">Performing PtH (Pass the Hash) attack</span></h3>
<p><span style="color: #000000;">We can further perform Pass the hash attack using these credentials, or crack them using john/hashcat. We head over to our Kali terminal and use pth-winexe binary, which is a part of the pass the hash toolkit by <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/byt3bl33d3r/pth-toolkit">byt3bl33d3r</a></strong></span>. This comes built-in in new kali os.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">pth-winexe -U Administrator%00000000000000000000000000000000:32196B56FFE6F45E294117B91A83BF38 //192.168.1.188 cmd.exe</pre>
<p><span style="color: #000000;">As you can see, <strong data-start="205" data-end="217">we added</strong> 32 bits of 0s before the <strong data-start="243" data-end="256">NTLM hash</strong> we dumped. Since the release of <strong data-start="289" data-end="303">Windows 10</strong>, Microsoft introduced a change—<strong data-start="335" data-end="348">LM hashes</strong> are no longer used. However, the tools we’ll use in the practical have been around since the old <strong data-start="446" data-end="459">NT and LM</strong> times. Therefore, those tools require a string of 32 zeros instead of the LM hash.</span></p>
<p><span style="color: #000000;">Also, to be noted, when we say NTLM in modern times, we mean NTHash. NTLM is a common name that stuck around.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgZRtq1O93tTfC3pIC42mERPeAxmKA1MrGSPqhu81UF2OPaELM_JBkC8KgoZfRIz0_bgWLII9oARCnDxIVtYCo9dbsEv0VfahS9IMvAWd9wrHkK0EfyhtlRmsH5oZ3PrTsmBVwm6ZNATy7CzB7B3HdyyqZHRhvZFXV6pEl98EOqVIuhM_1pye5fqR-p9Q=s16000"/></span></p>
<p><span style="color: #000000;">So, as you can see using the golden certificate, we were able to extract admin tickets, dump hashes and perform Pass the hash or pass the ticket attacks.</span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">Interestingly, <strong data-start="564" data-end="604">95% of the Fortune 500 companies use</strong> <strong data-start="605" data-end="625">Active Directory</strong> in some form. Often, <strong data-start="647" data-end="689">attackers or analysts perform pentests</strong> on corporate AD environments. In particular, a <strong data-start="737" data-end="766">Golden Certificate attack</strong> serves as a <strong data-start="779" data-end="801">domain persistence</strong> technique that grants an attacker up to a year of access—even if the admin password changes or new admins are added. Overall, it is a valuable method with the potential for future <strong data-start="982" data-end="1003">ADCS exploitation</strong>. Hope you enjoyed the article. Thanks for reading.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contact</span><strong> <a class="broken_link" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
