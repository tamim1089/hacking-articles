<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Linux Privilege Escalation: PwnKit (CVE 2021-4034)</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/linux-privilege-escalation-pwnkit-cve-2021-4034/" rel="bookmark"><time class="entry-date published" datetime="2022-02-07T18:33:58+00:00">February 7, 2022</time><time class="updated" datetime="2025-05-19T14:54:27+00:00">May 19, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Team Qualys <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034">discovered</a> </strong></span>a local privilege escalation vulnerability in PolicyKit’s (polkit) setuid tool pkexec, known as <strong data-start="198" data-end="208">PwnKit</strong> (CVE 2021-4034), which allows low-level users to run commands as privileged users. According to Qualys, the vulnerability exists in the pkexec.c code that doesn’t handle the calling parameters count correctly and ends trying to execute environment variables as commands.  Thus, an attacker can craft environment variables in such a way that it will induce pkexec to execute arbitrary code. In this demonstration, we are using the older vulnerable Ubuntu 20.04, which you can download from Ubuntu’s old releases <a style="color: #000000;" href="https://old-releases.ubuntu.com/releases/">page</a>. Newer releases already come with a patched polkit framework. Mitre post can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034">here</a></strong></span>.</span></p>
<h3><span style="color: #800000;">Polkit and pkexec</span></h3>
<p><span style="color: #000000;"><strong>Polkit and pkexec: </strong>Linux systems also refer to PolicyKit as polkit. Programs use this authorization API to elevate their permissions to that of an elevated user and run processes as an elevated user (root, generally). If the user is not specified it tries to run that command as the root user. Sudo does the same thing in terms that it lets a user run commands as root, however, with pkexec, admins can finely control the execution of particular programs by defining policies for it. Sudo has no restriction and a user may run any command as an elevated user-given, he knows the password. Pkexec also takes some effort in setting up but Debian variants, including the popular Ubuntu, come with polkit and pkexec pre-installed. These .rules JavaScript files in the directory define the authorization rules for third party packages <strong>/usr/share/polkit-1/rules.d/</strong></span></p>
<p><span style="color: #000000;">You can read more about polkit and basics <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/linux-privilege-escalation-polkit-cve-2021-3560/">here</a></strong></span>.</span></p>
<h3><span style="color: #800000;">Details about PwnKit</span></h3>
<p><span style="color: #000000;">You can view Pkexec’s code on GitHub <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/wingo/polkit/blob/master/src/programs/pkexec.c">here</a></strong></span>. In the main function, you can see the program passing two parameters, argc and argv[].</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiMxuMhrb0a8HOcjHnHGn19MrravnwtQoooBMmgt1df7xvZVhR6UF29RwiqZDXU8eRR-hBdj9oBd4PMcd25QAFvrmb2tFsjOqwNuzIW3r5hBbcVyrmri5-dQa2CqssxvmiXUYz3E30ynQsA3cUNaWff6WSElYaYvuTjDrhPHUyuvh59V5XHrFtF2QKLBA=s16000"/></span></p>
<p><span style="color: #000000;">If we do not pass any argument to this function, argc =0 and argv = NULL. In the for loop, n is now set to 1 and the loop does not execute as the condition fails.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhUV33Eu8p1pq5A3ILVJNSOM99xJwEFvFXDnAr5dVt9oWtBOoud0UePHmSM7TFlIPR284RMSKxGTPn6qPVFPcs8MOi-dwoqptJPRxbfxrhVE1jIOjSLYlwTkcOZE4OcjZRNSgFCbdZG2wqEvxeilA9Jt4FSPFoCh7-Juc0zGsq1R1a-k_Fa_79euqlFPw=s16000"/></span></p>
<p><span style="color: #000000;">When a program executes, the system places arguments, environment variables, and pointers contiguously in the stack. The system sets the path variable to NULL. This makes argv[argc] equal to Null and finally, argv[n] becomes argv[1] (as n=11) which becomes the envp[] or the environment variable. Author calls it “value”. (You can refer to the original post to understand in-depth)</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEixZl5WWu0whwNa3AofY7t-4obfRrgocvFOV5bSi5I1a0_-nnzH-fXn4QCdiUPcZdwtLR--Nm5S13X_kTNM3IZskD9Im4gvmBFKkGQRU5VGxhNKiIn7JHKMCzv6MEOVI6MFzDSPqs5bVdrw30oOvrcWFrsj1O4spo8BJCZZ8x2IT7RgoMDEVSPYJfKeNg=s16000"/></span></p>
<p><span style="color: #000000;">Since the path is NULL, it doesn’t start with “/” (indicating absolute path) and hence, the function g_find_program_in_path searches for the value in the environment variables.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh7htq58DKdQf14Osf1Pb22iufUYywswdlQ9LXWFnPWgqpu5xmc5FHJUc1AmwiOZK0faPT8P4QW0ZJnvz_M4JGGMcyttGcvKdIk8nZI1wCuN_1PpnUJx-gPgtdyfjkZDQNbTi1-Jzq2FjsCQHa24FRq24cuY3A2ojkbjg75YS6siBmgekNkqKdGgzlI8g=s16000"/></span></p>
<p><span style="color: #000000;">Variable s is finally set to that environment variable “value”</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEgS2lox4qkF7oJp2CO8JIM35ubPjGeClNs7BjORsCIA4_Syaje6WttTSPgnYsRQJDIU6BD5Trp-PF1A2Z11jQWlgv79f-IQtmRp5CEDRjOAWkQiDsltX4KbojtchvgTUzgl-nTuBIoBqcXE85Vunir8QYAq8GFLONQI9AkDzvjfMtE0FMmCubXnA0o79A=s16000"/></span></p>
<p><span style="color: #000000;"><strong>Attack vector: </strong>An attacker can create an environment variable and use this memory corruption technique to run his own executable named “value.” Hence, an attacker can use pre-existing environment variable privilege escalation methods to exploit this.</span></p>
<h3><span style="color: #800000;">Demonstration</span></h3>
<p><span style="color: #000000;">A proof of concept for this vulnerability has been uploaded on github which can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/berdav/CVE-2021-4034">here</a></strong></span>. To run the attack, we simply need to clone the repository, make the executable and run it. The program will exploit this memory corruption weakness as explained above.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /tmp
git clone https://github.com/berdav/CVE-2021-4034 pwnkit
make
./cve-2021-4034
whoami
cat /etc/passwd</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjWQ7pM_Bqk5j2m3mkyLI1KKRdXiFPtQc7Hh42-G6wwxYtDHFHZSDwdi6KFtP62KDNZFn7BLGdwhwQRfObiMwYjEPrFjm_hX3d69SjHy1mcT1BmpAs4Yh6-yh5A05cTwxJSGSQU2LsYHApdtMpinLYwlBQUlaxj9DAaSO5CO0fc71W1kOT4QlKV6cH-qQ=s16000"/></span></p>
<p><span style="color: #000000;">And just with two commands, we have exploited pkexec’s vulnerability and escalated ourselves to root!</span></p>
<h3><span style="color: #800000;">Mitigation</span></h3>
<ul>
<li><span style="color: #000000;">The respective vendors have already patched the vulnerability. In Ubuntu 20.04 policykit-1 – 0.105-26ubuntu1.2 version mitigates this weakness.</span></li>
<li><span style="color: #000000;">If no patches are available for your operating system, you can remove the SUID-bit from pkexec as temporary mitigation.</span><br/>
<span style="color: #000000;">chmod 07555 /usr/bin/pkexec</span></li>
</ul>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">All of the unupdated older versions of Debian flavours and Red hat flavours are susceptible to this attack making it a severe risk for an organization. The ease of exploitation of this attack makes it even more dangerous. We highly recommend that sysadmins update their installed polkit packages today. Thanks for reading.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contact<strong> <span style="color: #0000ff;"><a class="broken_link" style="color: #0000ff;" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></span></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
