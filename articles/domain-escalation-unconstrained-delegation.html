<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/domain-escalation/" rel="category tag">Domain Escalation</a>, <a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a>, <a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Domain Escalation: Unconstrained Delegation</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/domain-escalation-unconstrained-delegation/" rel="bookmark"><time class="entry-date published" datetime="2022-05-28T19:41:16+00:00">May 28, 2022</time><time class="updated" datetime="2025-06-23T18:13:48+00:00">June 23, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Post-Windows 2000, Microsoft introduced an option where users could authenticate to one system via Kerberos and work with another system. The delegation option makes this possible. We achieve unconstrained delegation using the TGT forwarding technique, which we will discuss in this article.</span></p>
<h3><span style="color: #800000;">Kerberos Delegation</span></h3>
<p><span style="color: #000000;">Kerberos Delegation enables a service to impersonate a computer or user to engage with a second service using the user’s privileges and permissions.</span></p>
<p><span style="color: #000000;">The classic illustration of why delegating is necessary, for instance when a user authenticates to a web server using Kerberos or other protocols, and the server wishes to interact with a SQL backend or file server.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiT6dkXPLddG5IuKSagZR5txZ9p5bLDh32OrC3BxJJb_XiZCBEFRfPmvSA8dKfgAFqBzCztEpTUjjkJ3KH7MXd6MORZzXEqOBefk3gwqKjKioiB1vOA6dMsDEO5KgtRFo5IjLy24Ibus1hyhZXiBh5qaiJUhCOt7xlqhj4lhSHpfz7bq-NWB3OuFN1XGw/s16000/0.1.png"/></span></p>
<p><span style="color: #000000;">Type of Kerberos Delegation:</span></p>
<ul>
<li><span style="color: #000000;">Unconstrained delegation</span></li>
<li><span style="color: #000000;">Constrained delegation</span></li>
<li><span style="color: #000000;">RBCD (Resource-Based Constrained Delegation)</span></li>
</ul>
<h3><span style="color: #800000;">Service Principal Name</span></h3>
<p><span style="color: #000000;">A unique name (identifier) of a service instance. SPNs are used by Kerberos authentication to associate a service instance with a service logon account. This allows a client application to request that the service authenticate an account even if the client does not have an account name.</span></p>
<h3><span style="color: #800000;">Unconstrained Delegation</span></h3>
<p><span style="color: #000000;">The feature debuted initially in Windows Server 2000 but it is still there for backwards compatibility. Basically, if a user requests a service ticket for a service on a server set with unconstrained delegation, that server will extract the user’s TGT and cache it in its memory for later use. This means the server can pretend to be that user to any resource on the domain.</span></p>
<p><span style="color: #000000;">On a computer account, an admin can set the following property for unconstrained delegation.</span></p>
<ul>
<li><span style="color: #000000;">AD Users and Computers -&gt; Computers -&gt; Trust this computer for delegation to any service.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiXngS6FPbtTdwbHQ687LfOcd_uZABKNSedSHmsro5f3SgCVKyjgItHMwPAoP6HS-9E8_kycr7VmDrwh7FQ4ocyg-R5o46Lncuo3-cLi_J4URGZ5aklxjW8v6Zz2o5pRAI5SGptpRRD0wiqQe2cweaI1-fNhF9XUoKrjAZri2nnOdd9_sCwOT75_pvSWA/s16000/0.png"/></span></p>
<p><span style="color: #000000;">Key features of the unconstrained delegation are:</span></p>
<ul>
<li><span style="color: #000000;">Usually, the privilege is given to computers running services like IIS, and MSSQL because these computers usually require some back-end connectivity to other resources.</span></li>
<li><span style="color: #000000;">When given Delegation rights, these computers ask for a user’s TGT and store them in their cached memory.</span></li>
<li><span style="color: #000000;">With this TGT, they can access back-end resources on behalf of the authenticated user.</span></li>
<li><span style="color: #000000;">Catch is that these systems can also request access to any resource on the domain using this TGT!</span><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqFAGuNirtaPHgWk_LvIt9f-qm8EJwKOdqfzL_wzG-Qr_5En7FzemiCuQBNGXfWxOJ1Zse_1A2zduOZLsMb2NJrDINCVtSPmGfosm0icublTCa4ZJmngjYJzIOcu5txGUQl8Eo62XbMGlBlobsRR9gRUO9Un3Ih1YQVOeJoBHva3GDI6Bf3JQhn02UMg/s16000/0.2.png"/></span></li>
</ul>
<p><span style="color: #000000;">An attacker may Abuse Unconstrained Delegation by requesting TGS for any domain services (SPN) using user delegated TGT.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiiE4Wvh2cFkn0IbfCy2Gz9rPLB03qMnHJAW6q3pJ10ccC7Pu3TUvAT6JxiNfRCKMDcJUVJu_TDh2D2kHD00POOd28EGW9xaKPvxmm6SvKxyCqoWHQ7pIJvkKr0VnlRb8R6kkMB2Nsp93__hiCLnH-P-s1bRIVUEaTGsk4fJOQp5X0Ka3mEpHNTnt4qNA/s16000/0.3.png"/></span></p>
<h3><span style="color: #800000;">TGT extraction via Unconstrained Delegation</span></h3>
<p><span style="color: #000000;">It is obvious that we need to run our attack on the machine that has delegation enabled. So we are assuming the attacker has compromised one such machine. Assumption 1: Attacker compromised DC1$ system running IIS on Kerberos authentication.</span></p>
<ul>
<li><span style="color: #000000;">Assumption 2: Attacker has access to a domain-joined system (Here, powershell window running on that system)</span>
<ul>
<li><span style="color: #000000;">User: Administrator</span></li>
</ul>
</li>
</ul>
<p><span style="color: #000000;">Now, in real-life scenario, you might not have direct access to the DC system for simplicity we have installed IIS on DC and using that only so that you get the gist.</span></p>
<p><span style="color: #000000;">Moving on with our extraction, we need to learn the systems that have unconstrained delegation enabled. This can be done by using PowerShell and AD module.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-ADComputer -Filter {TrustedForDelegation -eq $true} -Properties trustedfordelegation,serviceprincipalname,description</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhVnK7rS34mzNVUEiA9a8iFu-AWGIa1769BQ5rhHzo4SP7EbvihjQp8w8dUSECl3vxQYp3YZxsWhPRRj9yQnycufs-Oz0puzoYimptCyRR-tvb4yd2v2vdA4vyK4GEZOTf5BNPMidKow9FWbIIoVooMsbXuYDHAr_psusYrohNuoHGHfzlimbxJvJXKBQ/s16000/1.png"/></span></p>
<div class="flex max-w-full flex-col grow">
<div class="min-h-8 text-message relative flex w-full flex-col items-end gap-2 text-start break-words whitespace-normal [.text-message+&amp;]:mt-5" dir="auto" data-message-author-role="assistant" data-message-id="d195b85a-e2df-4246-a70b-f79b3473546e" data-message-model-slug="gpt-4o">
<div class="flex w-full flex-col gap-1 empty:hidden first:pt-[3px]">
<div class="markdown prose dark:prose-invert w-full break-words dark">
<p data-start="0" data-end="200"><span style="color: #000000;">Additionally, the same result can be achieved by using the <strong data-start="59" data-end="72">PowerView</strong> script, which is part of the <strong data-start="102" data-end="117">PowerSploit</strong> framework created for offensive security using PowerShell. You can find it here.</span></p>
<p data-start="202" data-end="274"><span style="color: #000000;">Once you compromise an AD system, you can install and use <strong data-start="260" data-end="273">PowerView</strong>.</span></p>
</div>
</div>
</div>
</div>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Import-Module .\powerview.ps1
Get-NetComputer -Unconstrained</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj6OQ9WL5m9pj7MTD6OV-I3k1JRSPYRi_oNLBHHBTbDLlKs20gkF7ucGDcc2e_P6FlLq1wOxv15MgqpAhkFV5xxV-N0G749iWdV3Tr1Bj77-xfFSUqrb8MKnvOOgO5-4SaLmdAOqmRIHkfeVue6F4_0WKwn1qBFAOaCd-30xxHDJO13r3VepawQDneUAA/s16000/2.png"/></span></p>
<p><span style="color: #000000;">Now, on the target system we need to run Rubeus in monitor mode on the dc1 system. After that, whenever a user connects/authenticates to dc1$ Rubeus will dump TGT of the user.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rubeus.exe monitor /monitorinterval:10 /targetuser:dc1$ /nowrap</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiI9fqrYrtznEJtRXkIbdKMbwUatKKh_PeDTxcSpTgotlMeT4oj6ytWQOXV8nxKW9oJLHKNiEEnJML5en_gSdXMREzbULMa19Tz48ZUsq-dalm7uBdDWTX3tGG3iK7OL33qWxnKhcij6u9kUfFtZP6kPRQkrpY5bT6IPk-1UsnY6RtlE-O0C9f62i2AXg/s16000/3.png"/></span></p>
<p><span style="color: #000000;">Now, let’s wait for genuine users to connect to dc1$ running IIS service. For simplicity, let’s do that manually using the IWR module.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Invoke-WebRequest http://dc1.offense.local -UseDefaultCredentials -UseBasicParsing</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgp_YUQfI-8qvUbBWr9ife7GS2VzpcXEi97j6Xci64URJ1-nugreRG3ljY8DRP8kwxlCIYfdGz_CEuETmTQL6zqRHRH1LmvI8LpOz-o5gIADMM3VbC3DRD0Pzu6K0tTpgxApaPS_ZV2dsdnI0QoHgB7Oxesv9eMwLdttMpvhLqThgdY072ubnIcITj0Mg/s16000/4.png"/></span></p>
<p><span style="color: #000000;">As you can see, Rubeus has now captured a new ticket granting ticket (TGT) from the user IGNITE\Administrator.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj-nDccubWmWTErFBCqYxzNhZTWpDkhP-iTwG4ntW-SaJhyG9nmBcNOsMqk2wpD_YZZWqs3C-I10whKM6wgcqnyUAAxrwpT9HeMFbOP8UNr2NZmMSzxMQwO6AvC6D3KMaG5zHwAuYTJneVJcHmTVi_uuKzrYOZI02k0cNY-gj184-CfG6pAp4aTyMdu7w/s16000/5.png"/></span></p>
<p><span style="color: #000000;">Now, you can use this TGT to request access to any resource by requesting a TGS to that resource. You can use Rubeus asktgs for that purpose. Follow the detailed Rubeus guide <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/a-detailed-guide-on-rubeus/">here</a> </strong></span>for more.</span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">The article demonstrated a delegation technique called Unconstrained Delegation because as the name suggests, there are no restrictions upon how the system that has delegation rights use a user’s authentication information. The security loopholes made Microsoft introduce Constrained Delegation. You’ll read more about that in the next article. Hope you liked the article. Thanks for reading.</span></p>
<p><span style="color: #000000;">References: https://www.harmj0y.net/blog/activedirectory/</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and a left and right brain thinker. Contact<strong> <span style="color: #0000ff;"><a class="broken_link" style="color: #0000ff;" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></span></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
