<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/domain-escalation/" rel="category tag">Domain Escalation</a>, <a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Windows Privilege Escalation: DnsAdmins to DomainAdmin</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-privilege-escalation-dnsadmins-to-domainadmin/" rel="bookmark"><time class="entry-date published" datetime="2021-05-11T22:35:54+00:00">May 11, 2021</time><time class="updated" datetime="2025-05-16T20:32:26+00:00">May 16, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will show how attackers can escalate privileges from DNSAdmins to Domain Admin in Windows environments and gain unauthorized access. We will show you a method for escalating privileges on Windows-based Devices when they contain a compromised user of the DnsAdmins Group.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Introduction</strong></span></li>
<li><span style="color: #000000;"><strong>Setting Up </strong></span></li>
<li><span style="color: #000000;"><strong>Enumeration</strong></span></li>
<li><span style="color: #000000;"><strong>Exploitation</strong></span></li>
<li><span style="color: #000000;"><strong>Indicator of Compromise</strong></span></li>
<li><span style="color: #000000;"><strong>Conclusion</strong></span></li>
</ul>
<h3><span style="color: #800000;">Introduction</span></h3>
<p><span style="color: #000000;">In our long series in search for methods to elevate privileges on Windows Devices. Today, we look at DNSAdmins. To be able to understand this, you need to understand the implementation of DNS on Windows by Microsoft. The Microsoft Team designing DNS integration decided to make the Domain Controller a DNS server by default. To manage that DNS service, a group named DnsAdmins is used. Then came the ability for the users of DnsAdmins to run code with elevated privileges, which, in their eyes, was a feature. </span></p>
<p class="" data-start="116" data-end="340"><span style="color: #000000;">The DNS Management protocol operates on top of RPC. You can find an executable named <strong data-start="201" data-end="212">dns.exe</strong> under <strong data-start="219" data-end="244">C:\Windows\System32\</strong> on Domain Controllers. On the Domain Controller, the DNS server essentially runs as a server.</span></p>
<p class="" data-start="342" data-end="626"><span style="color: #000000;">Additionally, like every service, you can manage the DNS server using an interface available at <strong data-start="438" data-end="453">dnsmgmt.msc</strong>. If you search for all the operations that the server needs to support, you will come across <strong data-start="547" data-end="568">R_DnssrvOperation</strong>. This function contains the <strong data-start="597" data-end="613">pszOperation</strong> parameter.</span></p>
<p class="" data-start="628" data-end="876"><span style="color: #000000;">This parameter allows users who are part of the <strong data-start="676" data-end="689">DnsAdmins</strong> group to load a DLL without monitoring for content. As a result, <strong data-start="755" data-end="768">DnsAdmins</strong> users can execute this DLL with elevated privileges, which makes them vulnerable to Privilege Escalation.</span></p>
<h3><span style="color: #800000;">Setting Up</span></h3>
<p><span style="color: #000000;">To set up the conditions in our local environment for able to test the possibility of privilege escalation, we need to create a user. Then add that particular user to the DNSAdmins group. In the demonstration, we have a domain controller that is all set up with a bunch of devices and users connected to it. We take the Jeenali user and select the Add to a group option from the drop-down menu.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-y0yJLq8LSaI/YJsFMrbUI8I/AAAAAAAAv9E/b113UTKqF_kAbmPRZGqmMcrszwkYfYx5QCLcBGAsYHQ/s16000/1.png"/></span></p>
<p><span style="color: #000000;">Clicking on Add to a group will open a new window that can enable the user to select the group they want to add their user to. Type in DnsAdmins in the Enter the object names to select field and click on Check names option. When It gets underlined as demonstrated, click on the OK button to add the user to that group.</span></p>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-dbluIUWw5Yk/YJsFQldJ-LI/AAAAAAAAv9I/EdiXBjv-YIQaBCqamUJmiDOL4rbs6OscwCLcBGAsYHQ/s16000/2.png" alt="DNSAdmins to DomainAdmin" width="705" height="381"/></span></p>
<h3><span style="color: #800000;">Enumeration/Detection</span></h3>
<p><span style="color: #000000;">The setup is complete with the jeenali user being a member of the DnsAdmins group. To verify in this case or case we do this demonstration from an attacker perspective to understand what would be the indicators that will point towards and the process through which the attacker would figure out if the target is vulnerable to this kind of privilege escalation. We connect to the jeenali user. We assume that the attacker has control or credentials for this user. After establishing a connection through Evil-WinRM we use the whoami command with the group parameter to enumerate for the groups that the current user i.e., belong to. We see that the jeenali user is a part of the DnsAdmins group. This verifies the setup we did earlier.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-f62bg4F1WeE/YJsFUeSMRcI/AAAAAAAAv9M/BNKQzW-MXgU2J5-ka0LjMQQQGhW6YLMOQCLcBGAsYHQ/s16000/5.png"/></span></p>
<h3><span style="color: #800000;">Exploitation</span></h3>
<p><span style="color: #000000;">From the introduction, we know that the member of the DnsAdmins group can run the DLL file with elevated privileges. To exploit that privilege, we need to craft a malicious DLL file. We will be using msfvenom with the shell_reverse_tcp payload. We name the file raj.dll. The file we created is on our Kali machine. We use the smbserver.py python script from Impacket to host the /root directory as demonstrated below.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-aC3cFz_RbWs/YJsFY6EYY2I/AAAAAAAAv9Q/QadnXpN1Ra4633QDwbUepqEwDBwV-Ct-ACLcBGAsYHQ/s16000/6.png" alt="DNSAdmins to DomainAdmin" width="796" height="328"/></span></p>
<p><span style="color: #000000;">There are multiple ways to transfer the file to the target system. But there is always a chance that any Malware Scanner or Defender will detect the file and either quarantine it or remove it. Hence, we are hosting it on the smb server that makes it available for the Windows machine, and then we will directly interact with the DDL over the network. The executable we will use to pass the DLL code into the memory as SYSTEM is called dnscmd.exe. With the config and serverlevelplugindll parameters, we will pass the path of the DLL over the network as demonstrated below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-LK1MHPxyZf8/YJsFezMwcyI/AAAAAAAAv9Y/ZnIareX4w_wYOho6af7K34ia0ruZAk82QCLcBGAsYHQ/s16000/7.png"/></span></p>
<p><span style="color: #000000;">On the Kali machine on the SMB Server, it can be observed that a connection was made from the Domain Controller.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-FqUpks5og2M/YJsFiuuU5GI/AAAAAAAAv9c/jMAhLgD4pRICsYi9KoxeVi6OybpMjzlOwCLcBGAsYHQ/s16000/48.png" alt="DNSAdmins to DomainAdmin" width="757" height="336"/></span></p>
<h5><strong><span style="color: #000000;">Run netcat and transfer the DLL file</span></strong></h5>
<p><span style="color: #000000;">At this stage, the attacker needs to perform two specific tasks to get the shell. First, the attacker must run a netcat listener on a new terminal using the same port mentioned while crafting the payload. Secondly, the attacker transfers the DLL file but does not execute it immediately. To inject the DLL into memory, the attacker restarts the DNS Service.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-_GrbP4fmucg/YJsFmVTJDUI/AAAAAAAAv9g/8ymZdagC0gAE6eUoxGOLaPAXA_Cs8r0GQCLcBGAsYHQ/s16000/49.png"/></span></p>
<p><span style="color: #000000;">As soon as the attacker restarts the service, the netcat listener establishes a new connection. After the attacker runs the <strong data-start="597" data-end="607">whoami</strong> command, they can confirm that the session generated is as <strong data-start="667" data-end="684">Administrator</strong> and not as the <strong data-start="700" data-end="711">Jeenali</strong> user. This also confirms that the DLL executes as <strong data-start="762" data-end="772">SYSTEM</strong> when the user is a member of the <strong data-start="806" data-end="819">DnsAdmins</strong> group.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-dgEm0-PJPqM/YJsFp6uJvuI/AAAAAAAAv9o/6CMopy3doqg-Ahgtkh5mqk3lFiXYxHCRACLcBGAsYHQ/s16000/50.png"/></span></p>
<h3><span style="color: #800000;">Indicator of Compromise</span></h3>
<p><span style="color: #000000;">Additionally, when the attacker performs this method, there is an indicator that can help identify the incident. During the attack, if the attacker runs the <strong data-start="987" data-end="1001">dnscmd.exe</strong> command. It creates an entry in the registry of the target machine. The defender can then check this registry entry to obtain the IP address from which the attacker launched the attack and the DLL file used for the compromise.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll</pre>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-TMELLcQqAkI/YJsFvNnt-qI/AAAAAAAAv9s/QZtHAv0yAGYpgnY0pvnJzyPgTdfALj6FwCLcBGAsYHQ/s16000/51.png" alt="DNSAdmins to DomainAdmin" width="773" height="310"/></span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">This article/demonstration presents the attacker with an opportunity to escalate their access after the initial foothold. Being a member of a group can provide direct exploitation of the SYSTEM. Hence, from Blue Teamer’s perspective, it is advised to always authorize proper permissions and make sure the users are not assigned groups that they are not supposed to access. Also, treat the DnsAdmins group with the same attention as the Administrator group.<br/>
Learn more about Windows Privilege Escalation from this <strong><a href="https://www.hackingarticles.in/tag/windows-privilege-escalation/">Link.</a></strong></span></p>
<p><strong>Source</strong>: <a href="https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83"><strong><span style="color: #0000ff;">https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83</span></strong></a></p>
<p><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher, and Penetration Tester. Can be Contacted on <span style="color: #0000ff;"><strong>Twitter</strong> </span>and <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/pavan2318/">LinkedIn</a></strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
