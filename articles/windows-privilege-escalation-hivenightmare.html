<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Windows Privilege Escalation: HiveNightmare</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-privilege-escalation-hivenightmare/" rel="bookmark"><time class="entry-date published" datetime="2021-11-13T17:54:29+00:00">November 13, 2021</time><time class="updated" datetime="2025-05-10T20:28:03+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><a style="color: #000000;" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934"><span style="color: #0000ff;"><strong>CVE-2021-36934</strong></span></a> also known as SeriousSAM and HiveNightmare vulnerability was discovered by Jonas Lykkegaard in July 2021. Due to an ACL misconfiguration in Windows 10 post-build 1809 and Windows 11, non-admin users are granted read access to the holy trio of SAM, SYSTEM and SECURITY files under <strong>%windir%\system32\config</strong> directory. For this to be true, however, system protection has to be turned on and a volume shadow copy has to be created. The name ‘HiveNightmare’ is derived from a common name ‘hives’ which refers to the files that have registry data stored.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;">System protection and creating restore points</span></li>
<li><span style="color: #000000;">Exploitation Method 1: HiveNightmare.exe (C++ exploit)</span></li>
<li><span style="color: #000000;">Exploitation Method 2: serioussam.ps1 (Powershell exploit)</span></li>
<li><span style="color: #000000;">Exploitation Method 3: hive.exe (Go exploit)</span></li>
<li><span style="color: #000000;">Privilege Escalation</span></li>
<li><span style="color: #000000;">Conclusion and Mitigation</span></li>
</ul>
<h3><span style="color: #800000;">System protection and creating restore points</span></h3>
<p><span style="color: #000000;"><strong>System Protection in Windows: </strong>This feature is available post-Windows ME and XP, and allows a user to create backups, snapshots or restore points in their windows system. Should you feel the need to restore your windows to a previous point in time, you can do so. Microsoft mentions which files, settings and configurations are backed up <a style="color: #000000;" href="https://docs.microsoft.com/en-gb/windows/win32/sr/system-restore-portal">here</a>.</span></p>
<p><span style="color: #000000;"><strong>Volume Shadow Copy: </strong>Post-Windows 7 and Win Server 2003, a VSS (Volume Shadow Copy Service) accompanies users in their quest to properly create backups of their servers, shared folders, and restore points on local or remote systems is NTFS or ReFS is being used. In our case, volume shadow copy refers to a local restore point created by a user.</span></p>
<p><span style="color: #000000;">To demonstrate the exploitation of this vulnerability, we’ll be setting up our own lab first. After a clean installation of our own Windows 10, we activated the administrator account on the system and set up a simple 1234 as its password.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">net user administrator /active:yes
net user administrator 1234</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjz6Qpp4BI5jNOtp5T5KcocMo0jJVZkeKv8RcD-qrRbytUrNXpZ8fhvOlHSvT7Z52PvqRLn6u5A8Ik3z1ZJrWN3xZdHZEfYKcrDnVAJ79dJ0dVjFWHJ9L-zThRWlgmGvx36olPqpIZ-W5DsAFeuzf0sFFBoMFCDk5BrZOUsYqXUnKC2Wu_YhSTSKRDf2w=s16000"/></span></p>
<p><span style="color: #000000;">Further, we’ll have to turn on the system protection. For this traverse to control panel-&gt;system and security-&gt;system-&gt;system protection and configure</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEh1WtIhl9vhHDms1ZRBQeooN29n78hwbkSk7D6DCIH7yLckAFWju7tIB5YtUmEXBfV0NOeUjyhi8bRllVwYxUvBrd-hgkGID5dluQgpe0ffv3yfv5ND1dIGlz0_RlRU7UIAQyE9YtV4hoGRbaL4GkPxva2FTUNLo6Lmsxg18swugGFKgpcY4uc9qXMaVQ=s16000"/></span></p>
<p><span style="color: #000000;">Now, check “turn on system protection” click apply and ok</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhvgRY6nB6Mc8kkX3m7X9gX4cb9tikyAHrCJpDpbs2O_wA14zG2bOHn_5Mi2i4GzzBF416s-8naWnmWA7nprzzwTl6oXIiv35ZZy624YsspOq2a64HgfdPJAUBmOgjcFf4M4y_97dn6V1eGV0bDrHI-I1vKKKgtlbLd6DxZ4xydFtA0vyvVQ5x2xJcEcA=s16000"/></span></p>
<p><span style="color: #000000;">When you go back to the system protection menu now, you’ll observe that the previously grayed out “create” option in the restore point settings has now been activated. Click on create to create a restore point right now.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjvt8UUpWJrczA8bEEy5hLxh4hq9qvN8t1euRYV-nGoVkhGRhWLZEs7_FYNNvIEWP9DYrQcRj08Vk_R31NZvUwslx6mUvSCT7VzRdl9z0e9V42PgCDIal1FaUiTWOSukSLX54ILbjFHrry95OAtZ5tvxOA1h-__JcNzfp8vW6vOnm6jYfuwiz6rrxnCCg=s16000"/></span></p>
<p><span style="color: #000000;">Give it any name. I gave in a random date as its name.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiUOlh6lm7-O6s_wJz8aWABEbHXuOs3ZaYIdFlEzfd_0oRp-aB0pakr4iVzwQVQD-wzfQcZtySAgjYIN1Yc9Wi1cdLjQVXI_nQUsBi2JipjoiGP_kBGjJeLqdpjdFkBoD0BVVjbAL15fI5gXCxhAiPWGVdjeqlnbtz6EnQ7NgqLCfhOYwLY4AFLQA4LCw=s16000"/></span></p>
<p><span style="color: #000000;">We’re good to go now</span></p>
<h3><span style="color: #800000;">Exploitation Method 1: HiveNightmare.exe (C++ exploit)</span></h3>
<p><span style="color: #000000;">Now, to exploit the vulnerability, Kevin Beaumont created a zero-day (and PoC) for the same. This exploit looks for the shadow copy in the system and reads it for SAM, SYSTEM and SECURITY hives.</span></p>
<p><span style="color: #000000;">The exploit is written in C++ and created by GossiTheDog. It can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/GossiTheDog/HiveNightmare">here</a></strong></span>. Since the exploit is locally run, we’ll download this in the system where the system restore point has been created and run it using a simple non-admin user command prompt. As you can see, the prompt clearly told us that if the execution is completed successfully, three files would be dumped in the same folder. We check the same using the “dir” command and it follows!</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhyQaySblyskhrir5yuyWZ9DOvhBVERC4-h8T0kDhPV6M8ftVHY320eXKbj1_HXLb7gBv2DHB4MoJjzBZUM6hhh0gijeMgA4haput534DGm9p0tY2xJH7Wal7OoDZuN9BAw8atwPCH7pRDwg65owMiZKvSwuSaVx2kXAoLcRXjVaN5jVzi5asMYleGFcA=s16000"/></span></p>
<h3><span style="color: #800000;">Exploitation Method 2: serioussam.ps1 (Powershell exploit)</span></h3>
<p><span style="color: #000000;">The script created by romarroca can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/romarroca/SeriousSam">here</a></strong></span>. It is created in Powershell and is more portable than the exe variant created by Kevin Beaumont. This copies the SAM and SYSTEM hives from the restore point dump created. Execution is fairly simple, just run the script like so</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEhDIBh_NC1iK9dGiu4Se3DD1dbnc8HMLUpWyRFCz6HbGggcpWFbjKFgsj7PZFcgsRk8wQJXbQbYOJzgPFo-g2V9KdlTj6LyF5VB0TZYM2rbGpnDPETjsLxTlTdKRil7emDlxRQX7u64s2vk1rlcZl_U2TxdMcf6PyEapl0fmCMNip_JTGxGpsUiLdyZdA=s16000"/></span></p>
<h3><span style="color: #800000;">Exploitation Method 3: hive.exe (Go exploit)</span></h3>
<p><span style="color: #000000;">Christian Mehlmauer translated the same exploit in Go and created a ready to be executed exe file which can be found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/FireFart/hivenightmare">here</a></strong></span>. It dumps the holy trio in current directory simply by executing the exe file like so</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEjmssvI2AF6enR8z1vIa8PHD_rc5tjeQ1cQ4LKpZieBGf1OtDafJtn0ZA67riujgW7wdlWnpVSjJOtCL-hXJ1OkaSTGRcr4K3OhHQXUVUAZw6xPSWY198ekj6Mq4ls07UoBZT5wk3I6aGRVWcavmo4VjtZTgdYz3YaoEqT70p3glixWjQRfh3WjKTFPdg=s16000"/></span></p>
<h3><span style="color: #800000;">Privilege Escalation</span></h3>
<p><span style="color: #000000;">Till now, we have obtained the SAM, SECURITY and SYSTEM hive dumps and now we will use these files to extract the hashes and conduct a pass the hash attack. First, we are using impacket toolkit’s secretsdump.py script to dump the hashes. The scenario is that the attacker (us) has successfully obtained hives from the victim’s machine.</span></p>
<p><span style="color: #000000;">To do this, please download impacket toolkit <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/SecureAuthCorp/impacket">here</a></strong></span>.</span></p>
<p><span style="color: #000000;">Secretsdump is an agentless python script used to obtain various hashes from different file types including NTLM from the trio (default windows’ password hash format). It can be downloaded <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/SecureAuthCorp/impacket/blob/master/impacket/examples/secretsdump.py">here</a></strong></span>.</span></p>
<p><span style="color: #000000;">To do this, we’ll copy the three files in the present directory and input:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 secretsdump.py -sam /root/SAM -system /root/SYSTEM -security /root/SECURITY LOCAL</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEg6yNAp7IEy6IdySFU7qMk6WDwsOgJJ8I6uHbeLLLGqv062V1oxuMOJcwEEMVCHTKTNVp1PWEGKD3v7CcHqiQuSmd9mFdnF1jS_kmPHXww1tE341VWn4pcHK53tZUnYNEMavP1rura9VDZ87jU-sMdmg1lV8u5HtF-OnMO-M_fRfTR1Xbd-BwXgqD73tA=s16000"/></span></p>
<p><span style="color: #000000;">As you can see in the screenshot above, we have obtained the NTLM hash for the administrator’s account. Obviously, we knew the password in this case (1234) but ideally, the attacker now cracks this hash using John or other likes of hash cracking tools, or he conducts a “pass the hash” attack.</span></p>
<h5><span style="color: #000000;"><strong>PassTheHash (PtH)</strong></span></h5>
<p><span style="color: #000000;">In this type of attack, the attacker can bypass/flout with authentication mechanisms by providing the hash of a password rather than the password itself. This weakness is the most prevalent in Windows systems. At the time of login to network service in Windows, the backend ultimately convert a plain text string into a hash and compares it with the existing hash in the database (hives); similarly, in PtH attack, the backend code, due to an inherent weakness, gets fooled when a user enters the hash instead of the password string and allows authentication. Refer to the guide <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/lateral-movement-pass-the-hash-attack/">here</a> </strong></span>for an in-depth understanding of this attack.</span></p>
<p><span style="color: #000000;">Now then, from the hashes obtained in the above step, we’ll conduct a PtH attack using the Impacket toolkit’s psexec.py script (found <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py">here</a></strong></span>).</span></p>
<p><span style="color: #000000;">Please note that, after Windows 10, Microsoft has changed how NTLM hashing works. LM hashes are not used anymore but the tool being used is existing since the old NT and LM times. So, here, we will be using a string of 32 zeros instead of the LM hash.</span></p>
<h5><span style="color: #000000;"><strong><span style="color: #000000;">PsExec</span> </strong></span></h5>
<p><span style="color: #000000;">In Windows, PsTools are used for a number of different process-related functions like listing, logging, monitoring etc. PsExec is used to execute processes remotely. According to Sysinternals (<span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">here</a></strong></span>), “PsExec’s most powerful uses include launching interactive command-prompts on remote systems and remote-enabling tools like IpConfig that otherwise do not have the ability to show information about remote systems.”</span></p>
<p><span style="color: #000000;">Impacket has developed a Python-based PsExec which can be used to remotely pop up a CLI using credentials. However, here, we will be passing the hash instead by:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 psexec.py -hashes 00000000000000000000000000000000:7ce21f17c0aee7fb9ceba532d0546ad6 administrator@192.168.1.145</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/a/AVvXsEiFo_ZFCa4wPUJSRmoC88J5fnRrK1tjudybiM2ZfKBNg3QhT6GnPXyI_J1ClWma2vESKdUG7IEpzna-b60AvNNS9XedwH9j2YNF6Zb25AfWRArYABLajFQM4xty08uOTJlzgvGAQKyxzBxWrjXrKsqTvsOGX8ZQKlzlyXWW0EWmSJLE9gKow3Kk4AivAw=s16000"/></span></p>
<p><span style="color: #000000;">And it has worked its magic!</span></p>
<h3><span style="color: #800000;">Conclusion and Mitigation</span></h3>
<p><span style="color: #000000;">The ease of exploitation makes this vulnerability a critical threat to any organisation. Microsoft has released security patches for the same, however, one other workaround is to restrict access to the contents of <strong>%windir%\system32\config</strong> by typing the command in cmd prompt:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">icacls %windir%\system32\config\*.* /inheritance:e</pre>
<p><span style="color: #000000;">Thanks for reading.</span></p>
<p><span style="color: #000000;"><strong>Author: Harshit Rajpal </strong>is an InfoSec researcher and left and right brain thinker. Contact</span><strong> <a class="broken_link" href="https://in.linkedin.com/in/harshit-rajpal-79bb43103">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
