<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/penetration-testing/" rel="category tag">Penetration Testing</a></span>            </div>
            <h1 class="post-title entry-title">Wireshark for Pentester: Decrypting RDP Traffic</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/wireshark-for-pentester-decrypting-rdp-traffic/" rel="bookmark"><time class="entry-date published" datetime="2021-05-05T19:11:28+00:00">May 5, 2021</time><time class="updated" datetime="2025-05-30T09:01:55+00:00">May 30, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">Over the last few years, attackers used the Remote Desktop Protocol (RDP) for accessing unsecured servers and company networks. In ransomware malware attacks since 2017, RDP has become a major vector. Security professionals have focused their attention increasingly on this protocol by writing signatures to detect and prevent attacks of RDP vulnerabilities.</span></p>
<p class="ai-optimize-7"><span style="color: #000000;"><em>RDP supports several operating modes to encrypt network traffic, as a proprietary protocol from Microsoft. This encryption, unfortunately, makes it hard to write RDP signatures because the content of RDP is hidden</em>.</span></p>
<p class="ai-optimize-8"><span style="color: #000000;">We can, fortunately, develop a test environment that provides the key file to decrypt the packet capture (pcap) of Wireshark’s RDP traffic.</span></p>
<p class="ai-optimize-9"><span style="color: #000000;"><strong>This article shows how the environment is prepared, a decryption key is obtained, and how RDP traffic can be deciphered.</strong></span></p>
<h3 class="ai-optimize-10"><span style="color: #800000;">Table of Contents</span></h3>
<ul>
<li class="ai-optimize-11"><span style="color: #000000;">Prerequisites</span></li>
<li class="ai-optimize-12"><span style="color: #000000;">Trace File</span></li>
<li class="ai-optimize-13"><span style="color: #000000;">Virtual Environments Setup</span></li>
<li class="ai-optimize-14"><span style="color: #000000;">Remove Encrypted Ciphers from RDP Client</span></li>
<li class="ai-optimize-15"><span style="color: #000000;">Generate and Download RDP Server’s Private Key</span></li>
<li class="ai-optimize-16"><span style="color: #000000;">Capture RDP Traffic</span></li>
<li class="ai-optimize-17"><span style="color: #000000;">Analyzing and Decrypting Wireshark Traffic</span></li>
<li class="ai-optimize-18"><span style="color: #000000;">Forensics with Captured RDP Data</span></li>
<li class="ai-optimize-19"><span style="color: #000000;">The RDP Data Protocol</span></li>
<li class="ai-optimize-20"><span style="color: #000000;">Security Protocols Used by RDP Server</span></li>
<li class="ai-optimize-21"><span style="color: #000000;">Analyze Connectivity between Client &amp; Host</span></li>
<li class="ai-optimize-22"><span style="color: #000000;">Analyzing Credentials</span></li>
<li class="ai-optimize-23"><span style="color: #000000;">Conclusion</span></li>
</ul>
<h3 class="ai-optimize-24"><span style="color: #800000;">Prerequisites</span></h3>
<ul>
<li class="ai-optimize-25"><span style="color: #000000;">A good understanding of RDP Setup and Usage.</span></li>
<li class="ai-optimize-26"><span style="color: #000000;">A virtual environment to run Two Windows host.</span></li>
<li class="ai-optimize-27"><span style="color: #000000;">First windows host act as an RDP Client.</span></li>
<li class="ai-optimize-28"><span style="color: #000000;">Second windows host act as an RDP Server.</span></li>
<li class="ai-optimize-29"><span style="color: #000000;">A Linux OS for Decryption of pfx file</span></li>
<li class="ai-optimize-30"><span style="color: #000000;">Wireshark Running in another host</span></li>
</ul>
<h3 class="ai-optimize-31"><span style="color: #800000;">Trace file</span></h3>
<p class="ai-optimize-32"><span style="color: #000000;"><strong>You can download the trace file from <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://drive.google.com/drive/folders/1acUqGaQvvCiyzSi8Wnadi1uudGQYQ4BV?usp=sharing">here</a></span></strong></span></p>
<h3 class="ai-optimize-33"><span style="color: #800000;">Virtual Environments Setup</span></h3>
<p class="ai-optimize-34"><span style="color: #000000;">VirtualBox or VMware Workstation for Windows and Linux are the two most common virtual environments for this sort of testing. For macOS, VMWare Fusion is used. </span></p>
<p class="ai-optimize-35"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-PqUhvuhNuKE/YJKfoW2nI5I/AAAAAAAAvw8/TOriwpoetBA9GVfRC5xUPBStapsK-reOQCLcBGAsYHQ/s16000/0.png"/></span></p>
<p class="ai-optimize-36"><span style="color: #000000;">Two Windows 10 hosts were included in our test lab setup. One of the hosts was an RDP server, while the other was an RDP server. We have recorded RDP traffic with Wireshark as a man in the middle between these two hosts.</span></p>
<h3 class="ai-optimize-37"><span style="color: #800000;">Remove Encrypted Ciphers from RDP Client</span></h3>
<h4 class="ai-optimize-38"><span style="text-decoration: underline;"><span style="color: #000000;">Machine 1</span></span></h4>
<p class="ai-optimize-39"><span style="color: #000000;">In cryptography, forward secrecy (FS), also known as perfect forward secrecy (PFS), is a feature of specific key agreement protocols that gives assurances that session keys will not be compromised even if long-term secrets are used in the session key exchange are compromised. For HTTPS, the long-term secret is typically the Private signing key of the server. Forward secrecy protects past sessions against future compromises of keys or passwords. By generating a unique session key for every session a user initiates, the compromise of a single session key will not affect any data other than that exchanged in the specific session protected by that particular key.</span></p>
<p class="ai-optimize-40"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-pemxiLxcjjA/YJKfwFDohSI/AAAAAAAAvxA/kANE9c0w5DApgLMiH4nKTvN-V6hvPD3vwCLcBGAsYHQ/s16000/1.png"/></span></p>
<p class="ai-optimize-41"><span style="color: #000000;">The value of forwarding secrecy is limited not only by the assumption that an adversary will attack a server by only stealing keys and not modifying the random number generator used by the server but it is also limited by the assumption that the adversary will only passively collect traffic on the communications link and not be activated using a <a style="color: #000000;" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack"><strong><span style="color: #0000ff;">Man-in-the-Middle</span></strong></a> (MITM) attack. Forward secrecy typically uses an ephemeral Diffie-Hellman key exchange to prevent reading past traffic. The ephemeral Diffie-Hellman key exchange is often signed by the server using a static signing key.</span></p>
<p class="ai-optimize-42"><span style="color: #000000;">More can be ridden at – <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://en.wikipedia.org/wiki/Forward_secrecy">Wikipedia.org</a></strong></span></span></p>
<p class="ai-optimize-43"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-tRACZK1cq1A/YJKf05uxOAI/AAAAAAAAvxE/Bt_-b79uWS8z9LG2x2foRHrG9hNRi8vnQCLcBGAsYHQ/s16000/2.a.png"/></span></p>
<p class="ai-optimize-44"><span style="color: #000000;">This whole scenario looks like a Perfect Forward Secrecy. Isn’t it…?</span></p>
<p class="ai-optimize-45"><span style="color: #000000;">These types of ciphers create multiple SSL/TLS connection session keys. We can’t decrypt SSL/TLS traffic with the forward secrecy using RDP server private key. Therefore, we have to delete settings that support the Forward Secrecy on the RDP client.</span><span style="color: #000000;">                                    </span></p>
<h5 class="ai-optimize-46"><span style="color: #000000;">For this, we are using a Windows 10 host as an RDP Client. </span></h5>
<p class="ai-optimize-47"><span style="color: #000000;">To do this, open Group Policy Management console gpedit.msc as an administrator</span></p>
<p class="ai-optimize-48"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-PZXUtJwAHG0/YJKf6pB5kpI/AAAAAAAAvxI/af6L4QRP5JAU_x9gg0JIutHZe2uVPDnKQCLcBGAsYHQ/s16000/2.png"/></span></p>
<p class="ai-optimize-49"><span style="color: #000000;">After opening the console navigate to the following menu path:</span></p>
<p class="ai-optimize-50"><span style="color: #000000;"><strong>Administrative Templates &gt; Network &gt; SSL Configuration Settings</strong></span></p>
<p class="ai-optimize-51"><span style="color: #000000;">And then Double-click to the entry of the <strong>SSL Cipher Suite Order</strong></span></p>
<p class="ai-optimize-52"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-sJ8bueWDdqs/YJKgAATzytI/AAAAAAAAvxQ/-x9kAltM5ZoKmzjcS8AVQzw7nS0pxNxUACLcBGAsYHQ/s16000/3.png"/></span></p>
<p> </p>
<p class="ai-optimize-53"><span style="color: #000000;">After that select the “<strong>Enable”</strong> option to Enable the SSL Cipher Suite Order.</span></p>
<p class="ai-optimize-54"><span style="color: #000000;">Double-click the list of Ciphers and then select and copy the entire list.</span></p>
<p class="ai-optimize-55"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-_Cjpqwe06-I/YJKgFILuzVI/AAAAAAAAvxY/dAoSytbVha8io7johON6HuqDulgBGlkPACLcBGAsYHQ/s16000/4.png"/></span></p>
<p> </p>
<p class="ai-optimize-56"><span style="color: #000000;">Paste the copied ciphers into a notepad and remove all the ciphers that support Elliptic Curve Cryptography using Diffie-Hellman Ephemeral (ECDHE) or Digital Signature Algorithm (ECDSA) encryption. Remove all the ciphers that contain the word ECDSA and ECHDE. All of these ciphers are managed sequentially, so they were easy to delete from the text.</span></p>
<p class="ai-optimize-57"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-lkuf6S_b-Mo/YJKgJpPJy6I/AAAAAAAAvxc/ofxEqMcPcd8-tMZOm71XUgHIQAfkIpLMQCLcBGAsYHQ/s16000/5.png"/></span></p>
<p class="ai-optimize-58"><span style="color: #000000;">Now, an updated list of ciphers is shown below</span></p>
<p class="ai-optimize-59"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-5vzVvSpZ_CY/YJKgNuAFGUI/AAAAAAAAvxk/xoJrQobK4Poo2lk6aUi154w2koo_jjYFwCLcBGAsYHQ/s16000/6.png"/></span></p>
<p class="ai-optimize-60"><span style="color: #000000;">Copy the updated ciphers list and paste it back into the SSL Cipher Suites field but make sure you have overwritten the original list and then click on the <strong>Apply</strong> button to save the configuration and hit <strong>OK</strong> to close the window.</span></p>
<p class="ai-optimize-61"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-9WfopgNud9U/YJKgSAX7d3I/AAAAAAAAvxo/IS5yMlQbhSEhf_zVaIDJlUkc-YVWJ0onwCLcBGAsYHQ/s16000/7.png"/></span></p>
<p class="ai-optimize-62"><span style="color: #000000;">Generate and Download RDP Server’s Private Key</span></p>
<h4 class="ai-optimize-63"><span style="text-decoration: underline;"><span style="color: #000000;">Machine 2</span></span></h4>
<p class="ai-optimize-64"><span style="color: #000000;">We have used another Running Windows 10 Host as an RDP server.</span></p>
<p class="ai-optimize-65"><span style="color: #000000;">Then, our main task is to extract the private key from the host’s operating system. First of all, we have to be ensured that our host is acting like an RDP Server or not, if not go to the “<strong>Settings &gt; System &gt; Remote Desktop</strong>” and then “<strong>Enable Remote Desktop</strong>”.</span></p>
<p class="ai-optimize-66"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-MV5I3o1tuvE/YJKgXTWErwI/AAAAAAAAvxs/4wBGzg59VoQk9NPLGat9kHyshXZNNLZHACLcBGAsYHQ/s16000/8.png"/></span></p>
<p class="ai-optimize-67"><span style="color: #000000;">After that, we have to Extract Private Key from its Operating system. Windows don’t allow to export of any kind of certificate so we are going to use tools like Mimikatz or Jailbreak.</span></p>
<p class="ai-optimize-68"><span style="color: #000000;">Mimikatz or Jailbreak is a tool that can dump or export any kind of Certificate easily.</span></p>
<p class="ai-optimize-69"><span style="color: #000000;"><strong><em>So, I’m going to show you how this is done from both methods. You can stick with the method which feels you like easy.</em></strong></span></p>
<h4 class="ai-optimize-70"><span style="text-decoration: underline;"><span style="color: #000000;">Method 1: – Mimikatz</span></span></h4>
<p class="ai-optimize-71"><span style="color: #000000;">Mimikatz is a shell for various modules. Run the following commands to export RDP keys or Certificates with private Keys. Run Mimikatz as an administrator.</span></p>
<p class="ai-optimize-72"><span style="color: #000000;">Then, Enable “debug” privilege to be able to patch CNG service</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">privilege::debug</pre>
<p class="ai-optimize-73"><span style="color: #000000;">Patch CNG service lasts until the next reboot</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">crypto::cng</pre>
<p class="ai-optimize-74"><span style="color: #000000;">Patch CAPI library in memory of this process</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">crypto::capi</pre>
<p class="ai-optimize-75"><span style="color: #000000;">Export Remote Desktop certificate(s) with private keys, password is “mimikatz”</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">crypto::certificates -systemstore:CERT_SYSTEM_STORE_LOCAL_MACHINE -store:"Remote Desktop" /export</pre>
<p class="ai-optimize-76"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-Y4qUFhW9hUc/YJKgbJptYtI/AAAAAAAAvxw/Ag6ClWzpFt4Gi5xDBsy3B5voia-M4KfKQCLcBGAsYHQ/s16000/9.png"/></span></p>
<p class="ai-optimize-167"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-_7uL0fjvFAc/YJKggnNhuOI/AAAAAAAAvx4/X88NbqxxpskyztiqFhkmvDZgMcSuTFN9ACLcBGAsYHQ/s16000/10.a.png"/></span></p>
<p class="ai-optimize-77"><span style="color: #000000;">As you can see Mimikatz successfully dumped the certificate. You can find it in the Directory of Mimikatz.</span></p>
<h4 class="ai-optimize-78"><span style="text-decoration: underline;"><span style="color: #000000;">Method 2: – Jailbreak </span></span></h4>
<p class="ai-optimize-79"><span style="color: #000000;">A jailbreak is an iSECPartners tool that can export the RDP certificate of a server. We could extract the private key from the exported certificate. On our newly developed RDP server, we downloaded the following Jailbreak binaries from this GitHub repository to use <a style="color: #000000;" href="https://github.com/iSECPartners/jailbreak">Jailbreak</a>.</span></p>
<p class="ai-optimize-80"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-QvYBsaLqoR8/YJKgkwl7MKI/AAAAAAAAvyA/HJfcQ2VisZYGC0n4wZvk9C1jX3DHI8VJwCLcBGAsYHQ/s16000/10.png"/></span></p>
<p class="ai-optimize-81"><span style="color: #000000;">After downloading the Jailbreak utility navigate to the directory of <strong>Jailbreak-master &gt; binaries</strong> and copy the location of the binary folder</span></p>
<p class="ai-optimize-82"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-sDyIDk2PhkY/YJKgp__Q_SI/AAAAAAAAvyI/VO03TRXD3GAh2mp3uVPx_i9p0JFsOylFgCLcBGAsYHQ/s16000/11.png"/></span></p>
<p class="ai-optimize-83"><span style="color: #000000;">Then, open a Command prompt with administrator privileges and went to the directory of downloaded jailbreak binaries and execute the following command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">jailbreak64.exe %WINDIR%\system32\mmc.exe %WINDIR%\system32\certlm.msc -64</pre>
<p class="ai-optimize-84"><span style="color: #000000;">If you are running the 32-bit version of windows then execute the following command</span></p>
<p class="ai-optimize-85"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-VJG4-vyVLBo/YJKgx3NQofI/AAAAAAAAvyQ/XM5WzBjhfKU1WetsBCASc2oknMKDXXMoQCLcBGAsYHQ/s16000/12.png"/></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">jailbreak32.exe %WINDIR%\system32\mmc.exe %WINDIR%\system32\certlm.msc -32</pre>
<p class="ai-optimize-86"><span style="color: #000000;">These commands will open up a certificate manager for the local machine. From the left column expand the section of Remote Desktop and navigate to the certificate folder this will show you a certificate with the most expiration date. Do the right click on the certificate, <strong>select All Tasks,</strong> and then <strong>Export</strong>.<img decoding="async" src="https://1.bp.blogspot.com/-JxEvb2JxLdU/YJKg3gRpktI/AAAAAAAAvyY/3BZGGlbgnhkxaVd3yjDQf0DtBRw98p6RgCLcBGAsYHQ/s16000/13.png"/></span></p>
<p class="ai-optimize-87"><span style="color: #000000;">This will open up a Certificate Export Wizard… to export the Certificate just hit the “<strong>Next”</strong> button.</span></p>
<p class="ai-optimize-88"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-av9NoqwMooM/YJKg9vQKMrI/AAAAAAAAvyg/5JNre2SWzCI84AvZdC8UB5iCzFzXvSC1wCLcBGAsYHQ/s16000/14.png"/></span></p>
<p class="ai-optimize-89"><span style="color: #000000;">Make sure to select the option to export the private key when exporting the certificate.</span></p>
<p class="ai-optimize-90"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-tIF_F50sPkA/YJKhEUCjdXI/AAAAAAAAvyo/HvcpM4OzEMcbDf7TUUmimxAPnNU0Q0EbACLcBGAsYHQ/s16000/15.png"/></span></p>
<p class="ai-optimize-91"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-8uXvF4_qEcw/YJKhNWLmhXI/AAAAAAAAvy4/Kp4ZxGgVhbIDtcm7C75uMaUKRXpoeGJJgCLcBGAsYHQ/s16000/16.png"/></span></p>
<p class="ai-optimize-92"><span style="color: #000000;">We could only export the certificate as a PKCS #12 (.PFX) file for our host.</span></p>
<p class="ai-optimize-93"><span style="color: #000000;">The certificate needed to have a password in the next step. We didn’t have any difficulty criteria, so we went with a simple password.</span></p>
<p class="ai-optimize-94"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-f9q4sedskww/YJKhTLK2c_I/AAAAAAAAvy8/pKE1XCyhKfcBgGaxkh1L3LfyLfPsc4gjwCLcBGAsYHQ/s16000/17.png"/></span></p>
<p class="ai-optimize-95"><span style="color: #000000;">After that provide a directory where you want to save the certificate.</span></p>
<p class="ai-optimize-96"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-18bBb5QqHIs/YJKh7ozdtEI/AAAAAAAAvzQ/80XXKIE4ggQt8Q6LeqI_FbVmPcdn7NT6wCLcBGAsYHQ/s16000/18.png"/></span></p>
<p class="ai-optimize-97"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-EdSU6w396hs/YJKiEx-2vrI/AAAAAAAAvzU/b2C3qQ7KC106G1K6yQ4Y_sRtBVPDYiHFQCLcBGAsYHQ/s16000/19.png"/></span></p>
<p class="ai-optimize-98"><span style="color: #000000;">Finally, we have successfully Exported the Certificate with the Private key.</span></p>
<p class="ai-optimize-99"><span style="color: #000000;">Since our certificate was obtained through Mimikatz or Jailbreak, we transferred it to a <strong>Linux host</strong> and extracted the key using OpenSSL. To extract the key in PEM format, we first used the OpenSSL command</span></p>
<h5 class="ai-optimize-100"><span style="color: #000000;">You can download the certificate from <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://drive.google.com/file/d/15Fq86OeS9NM47e8iqQmRF1tQ8E-8rCGj/view?usp=sharing">here</a></span></span></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">openssl pkcs12 -in rdp.pfx -nocerts -out rdp_key.pem -nodes</pre>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Password: 123</pre>
<p class="ai-optimize-101"><span style="color: #000000;">Then after we have to remove the passphrase from the key, to do this run the following command</span></p>
<p class="ai-optimize-102"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-4IAQLKVWbTk/YJKiLJYOueI/AAAAAAAAvzc/FiwdrfChq74ZcXQt7huoLAKks-32nI9bACLcBGAsYHQ/s16000/20.png"/></span></p>
<p class="ai-optimize-103"><span style="color: #000000;">openssl rsa -in rdp_key.pem -out rdp.key</span></p>
<p class="ai-optimize-104"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-GyV3cN2hoJc/YJKiQO5vu7I/AAAAAAAAvzg/YWkifRUp6yAEegyR3Hg5aat0QKlfrjlcQCLcBGAsYHQ/s16000/21.png"/></span></p>
<p class="ai-optimize-105"><span style="color: #000000;">This will provide us with the RDP Server’s key</span></p>
<p class="ai-optimize-106"><span style="color: #000000;">As you can see, we have successfully extracted the RDP Server’s private key. Don’t forget to export this public key to the windows system for the use of later purposes.</span></p>
<p class="ai-optimize-107"><span style="color: #000000;">Reference: <a style="color: #000000;" href="https://unit42.paloaltonetworks.com/wireshark-tutorial-decrypting-rdp-traffic/">paloaltonetworks.com</a></span></p>
<h3 class="ai-optimize-108"><span style="color: #800000;">Capture RDP Traffic</span></h3>
<p class="ai-optimize-109"><span style="color: #000000;">We may use a tool like Wireshark to record network traffic in the VLAN using promiscuous mode with our two Windows hosts in the same virtual network. once the recording starts Our Windows</span></p>
<p class="ai-optimize-110"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-TKBltl-S3KY/YJKiVp22k4I/AAAAAAAAvzo/BdENdn-9ZJ0UP_7zVVZj1KxyM-XeLFr0wCLcBGAsYHQ/s16000/22.png"/> </span></p>
<p class="ai-optimize-111"><span style="color: #000000;">client uses RDP to log in to the other Windows host that was operating as an RDP server. The server’s host IP was 192.168.0.111.</span></p>
<p class="ai-optimize-112"><span style="color: #000000;">We logged into 192.168.0.111 and performed some simple tasks including web surfing and trying to connect to an FTP server while the pcap is recording the traffic.</span></p>
<p class="ai-optimize-113"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-SYFgZ9_CBXk/YJKicZKBCEI/AAAAAAAAvzw/3nTZEYJJLjIAVUwyeGGkxiOSJ0DyE9F8gCLcBGAsYHQ/s16000/23.png"/></span></p>
<p class="ai-optimize-114"><span style="color: #000000;">After of few minutes we logged out from the RDP Server and stopped recording Network traffic from Wireshark.</span></p>
<p class="ai-optimize-168"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-oHZ7_Kz1Cj0/YJKihdnaVxI/AAAAAAAAvz0/pXlGjhtan0Yb9fLWrTymc02t75dhMLBHwCLcBGAsYHQ/s16000/24.png"/></span></p>
<p class="ai-optimize-115"><span style="color: #000000;">Analyzing and Decrypting Wireshark Traffic.</span></p>
<p class="ai-optimize-116"><span style="color: #000000;">You can download the trace file from <span style="color: #0000ff;"><a style="color: #0000ff;" href="https://drive.google.com/drive/folders/1acUqGaQvvCiyzSi8Wnadi1uudGQYQ4BV?usp=sharing">here</a></span></span></p>
<p class="ai-optimize-117"><span style="color: #000000;">Open the pcap of RDP Session in Wireshark. We did not see any results when filtering RDP on our Wireshark display filter, as RDP traffic has been encrypted. We saw a blank column display during filtering the RDP in our pcap as shown below.</span></p>
<p class="ai-optimize-118"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-tLjPRzjq0Uw/YJKiokC7ROI/AAAAAAAAvz4/w54ItKgGE5QhNkc6qGFM_PRC1JVCSS4wwCLcBGAsYHQ/s16000/25.png"/></span></p>
<h4 class="ai-optimize-119"><span style="color: #000000;">Let’s Decrypt the Traffic</span></h4>
<p class="ai-optimize-120"><span style="color: #000000;">However, the results were quite different when we used our private server key for decrypting RDP Traffic in Wireshark.</span></p>
<p class="ai-optimize-121"><span style="color: #000000;">The RDP server <strong>DESKTOP-CDE7HJC</strong> was at IP address <strong>192.168.0.111</strong> in the pcaps we captured, and RDP traffic was carried out over TCP port <strong>3389</strong>. This information was required in order for Wireshark to properly decrypt RDP traffic.</span></p>
<p class="ai-optimize-122"><span style="color: #000000;">To do this navigate to <strong>Edit &gt; Preferences</strong>, Expand the Protocols section and select TLS</span></p>
<p class="ai-optimize-123"><span style="color: #000000;">After selecting TLS navigate to the Edit section and provide the following details such as IP address of the RDP server, port no., and the path of the private key</span></p>
<p class="ai-optimize-124"><span style="color: #000000;">Ip address: – 192.168.0.111</span></p>
<p class="ai-optimize-125"><span style="color: #000000;">Port no.: – 3389</span></p>
<p class="ai-optimize-126"><span style="color: #000000;">Protocol: – tpkt</span></p>
<p class="ai-optimize-127"><span style="color: #000000;">Rsa key:- the path of the saved public key.</span></p>
<p class="ai-optimize-128"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-91QYcvVcu5E/YJKit7iV1RI/AAAAAAAAvz8/3RwQuKx73Is8L495IyK5KSUKO9VeYUlwACLcBGAsYHQ/s16000/26.png"/></span></p>
<p class="ai-optimize-129"><span style="color: #000000;">We had much better results when reviewing the pcap after Wireshark was configured to decrypt RDP traffic.</span></p>
<h3 class="ai-optimize-130"><span style="color: #800000;">Forensics with RDP Data</span></h3>
<p class="ai-optimize-131"><span style="color: #000000;">When we loaded our key, our column display was no longer blank when we filtered for RDP. As shown in the image below, we had a variety of outcomes.</span></p>
<p class="ai-optimize-132"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-JUaFjnIfQpM/YJKizHfWx9I/AAAAAAAAv0E/kP4jG4eBoOcQYVNjZAPR5ted6HB9lBOOgCLcBGAsYHQ/s16000/27.png"/>Let’s do some Forensics with this data like what we can find with this data.</span></p>
<p class="ai-optimize-133"><span style="color: #000000;">Hmm!!! Exited….</span></p>
<p class="ai-optimize-134"><span style="color: #000000;">As we can see that we have now successfully decrypted the RDP data… but now have more question about what to do with this kind of data ….</span></p>
<p class="ai-optimize-135"><span style="color: #000000;">The answer is quite simple… we can gather some pieces of information like User ID, Password, Time of login, country of origin, etc… by arranging the binaries.</span></p>
<h3 class="ai-optimize-136"><span style="color: #800000;">The RDP Protocol</span></h3>
<p class="ai-optimize-137"><span style="color: #000000;">Understanding all of the underlying protocols used in RDP was one of the most difficult aspects of creating this library. It was difficult for some of them just to figure out what they were here for. The connection sequence alone employs four protocols: TPKT, X224, MCS (T.125), and GCC (T.124), as well as TLS at times and RC4 at others. This implies that we must be able to initiate TLS after the first few packets of the connection if necessary so we must keep an eye out for that.</span></p>
<p class="ai-optimize-138"><span style="color: #000000;">Are you confused? We were, too. As a result, we created this simple diagram to explain the connection sequence.</span></p>
<p class="ai-optimize-139"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-pXEL8AG4veo/YJKi3jRIQkI/AAAAAAAAv0I/z3uVemQYk-YgqcVvqbHMO4w31Cfp8DNLACLcBGAsYHQ/s16000/28.png"/></span></p>
<h3 class="ai-optimize-140"><span style="color: #800000;">Security Protocols used by RDP Server</span></h3>
<p class="ai-optimize-141"><span style="color: #000000;">Let’s first understand which type of Security used by the RDP server</span></p>
<p class="ai-optimize-142"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-D8j4zojjV8o/YJKi8TrWSaI/AAAAAAAAv0M/w0RkgEi1iOszdKS14_bWHFOi6y2Wg3HJACLcBGAsYHQ/s16000/29.png"/></span></p>
<p class="ai-optimize-143"><span style="color: #000000;">As shown in the figure of RDP protocol now we’re much clear that the RDP server uses this type of protocol to secure the connection.</span></p>
<h3 class="ai-optimize-144"><span style="color: #800000;">Analyze connectivity Duration between Client &amp; Host</span></h3>
<p class="ai-optimize-145"><span style="color: #000000;">Using the packet capture file, we were able to determine the time of the incident. We used a very cool Wireshark feature that’s hidden in <strong>Statistics -&gt; Conversations -&gt; TCP</strong>: Conversations between two endpoints.</span></p>
<p class="ai-optimize-146"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-nGBa_ofCeAg/YJKjMXptR1I/AAAAAAAAv0Y/uusRQ7rtvSU5v_Tqp6k-E_QI9Buu9I8FgCLcBGAsYHQ/s16000/30.png"/></span></p>
<p class="ai-optimize-147"><span style="color: #000000;">As we can see there is something that happened In the highlighted fields. I managed to understand they are using RDP protocol (port no.3389)  but won’t able to able find out the actual duration of the connectivity between the client and the host so, I applied <strong>“Limit to the Display filter”</strong></span></p>
<p class="ai-optimize-148"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-wPtB4n3c9k8/YJKjRlFsZ2I/AAAAAAAAv0g/OFMKVXnjgschXpMO0cH77mKawmSXU5fdACLcBGAsYHQ/s16000/31.png"/></span></p>
<p class="ai-optimize-149"><span style="color: #000000;">Then, the scenario is pretty much clear and we managed to see the actual duration of connectivity and we got two IP addresses of the client and host that is <strong>192.168.0.108 and 192.168.0.111. </strong>but still, we were not able to identify which one is the host and which one is the client.</span></p>
<h3 class="ai-optimize-150"><span style="color: #800000;">Analyzing Credentials</span></h3>
<p class="ai-optimize-151"><span style="color: #000000;">So, have got the two specific IP address and port number. Without wasting I applied a quick filter on behalf of this information</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Ip.addr == 192.168.0.111 &amp;&amp; tcp.port==3389</pre>
<p class="ai-optimize-152"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-jS1QhM2VrW8/YJKjWCkCv5I/AAAAAAAAv0k/7DSA6suY5QER1mzAf3ef8-OSnFwQ76YTgCLcBGAsYHQ/s16000/32.png"/></span></p>
<p class="ai-optimize-153"><span style="color: #000000;">And look what we have, a whole communication between the client and host. But I can’t able to understand which type of information has been shared. So, I managed to apply some more filters to make it more understandable. For example, now we have the client and host IP address so applied a display filter to find data shared by the client….</span></p>
<p class="ai-optimize-154"><span style="color: #000000;">Let’s see what happen</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rdp.client.address=192.168.0.108</pre>
<p class="ai-optimize-155"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-vMAAPhudlCc/YJKjcqxxquI/AAAAAAAAv0o/h3ybEAj_JTIrDqvXRGDc-JgIVNdjfVg2ACLcBGAsYHQ/s16000/33.png"/></span></p>
<p class="ai-optimize-156"><span style="color: #000000;">Wooh!!! As you can see we are managed to find user credentials used by clients on the RDP server just like user id, password, working directory, Time zone, weekday… etc…</span></p>
<p class="ai-optimize-157"><span style="color: #000000;">As an attacker, we can use these credentials to completely take over the system.</span></p>
<p class="ai-optimize-158"><span style="color: #000000;">But one more thing, still we don’t know the actual user name that the client used to log in to the RDP Server. Let’s find that</span></p>
<p class="ai-optimize-159"><span style="color: #000000;">Then, to find the client user name I quickly apply a display filter that shows us the client user name is entered by the client….</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">rdp.client.name</pre>
<p class="ai-optimize-160"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-dxtEXFCP2ag/YJKjhkbT_1I/AAAAAAAAv0w/363zIcT-TIMeYnsgiz2XHXi_JeeX97V8wCLcBGAsYHQ/s16000/34.png"/></span></p>
<p class="ai-optimize-161"><span style="color: #000000;">Whoa!!!… As you can see we have successfully got the client user name and the keyboard used by the RDP server.</span></p>
<p class="ai-optimize-162"><span style="color: #000000;">By applying these kinds of filters you can easily drill down the traffic to gather the information.</span></p>
<h3 class="ai-optimize-163"><span style="color: #800000;">Conclusion</span></h3>
<p class="ai-optimize-164"><span style="color: #000000;">This article discussed how to set up an environment for decrypting RDP traffic. This is best accomplished in a virtual environment with two hosts running Windows 10 Professional. We extracted the private key from our Windows host acting as the RDP server after ensuring the client did not use any forward secrecy ciphers. Then we quickly captured a pcap of network traffic. We were able to decrypt RDP traffic after the session ended by using the server’s private key.</span></p>
<p class="ai-optimize-165"><span style="color: #000000;">When creating signatures to detect RDP vulnerabilities and attacks, this type of environment can be useful to security professionals.</span></p>
<p class="ai-optimize-166"><span style="color: #000000;"><strong>Author – </strong>Vijay is a Certified Ethical Hacker, Technical writer and Penetration Tester at Hacking Articles. Technology and Gadget freak. Contact <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://www.linkedin.com/in/vijay-igcbr/">Here</a></strong></span></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-related-none yarpp-template-thumbnails">
